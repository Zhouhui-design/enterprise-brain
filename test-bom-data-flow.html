<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>ç”Ÿäº§BOMæ•°æ®æµæµ‹è¯•</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
    .success { background-color: #f0f9ff; border-color: #67C23A; }
    .error { background-color: #fef0f0; border-color: #F56C6C; }
    pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    h2 { margin-top: 0; }
  </style>
</head>
<body>
  <h1>ğŸ” ç”Ÿäº§BOMæ•°æ®æµè¯Šæ–­</h1>
  
  <div id="step1" class="section">
    <h2>æ­¥éª¤1: æµ‹è¯•åç«¯API</h2>
    <button onclick="testBackendAPI()">æµ‹è¯• /api/production-boms/list</button>
    <div id="step1-result"></div>
  </div>

  <div id="step2" class="section">
    <h2>æ­¥éª¤2: æµ‹è¯•å­—æ®µè½¬æ¢</h2>
    <button onclick="testFieldConversion()">æµ‹è¯•å­—æ®µæ˜ å°„è½¬æ¢</button>
    <div id="step2-result"></div>
  </div>

  <div id="step3" class="section">
    <h2>æ­¥éª¤3: æ¨¡æ‹Ÿå‰ç«¯åŠ è½½</h2>
    <button onclick="simulateFrontendLoad()">æ¨¡æ‹Ÿå®Œæ•´æ•°æ®åŠ è½½æµç¨‹</button>
    <div id="step3-result"></div>
  </div>

  <script>
    // å­—æ®µè½¬æ¢å‡½æ•°ï¼ˆä» bomApiService.js å¤åˆ¶ï¼‰
    function convertFromBackend(bomData) {
      return {
        id: bomData.id,
        bomCode: bomData.bom_code,
        bomName: bomData.bom_name,
        productCode: bomData.product_code,
        productName: bomData.product_name,
        version: bomData.version,
        status: bomData.status,
        designer: bomData.designer,
        itemCount: bomData.material_count,
        remark: bomData.remark,
        reviewer: bomData.auditor,
        effectiveDate: bomData.effective_date,
        totalLabor: bomData.total_labor,
        totalMaterial: bomData.total_material,
        productImage: bomData.product_image,
        isPushedToManual: bomData.is_pushed_to_manual,
        createTime: bomData.created_at,
        updateTime: bomData.updated_at
      }
    }

    async function testBackendAPI() {
      const result = document.getElementById('step1-result');
      result.innerHTML = '<p>â³ æ­£åœ¨è°ƒç”¨åç«¯API...</p>';
      
      try {
        const response = await fetch('http://localhost:3005/api/production-boms/list');
        const json = await response.json();
        
        if (json.code === 200) {
          const data = json.data;
          result.innerHTML = `
            <p>âœ… <strong>åç«¯APIè°ƒç”¨æˆåŠŸ</strong></p>
            <p>è¿”å›è®°å½•æ•°: ${data.length}</p>
            <p>ç¬¬ä¸€æ¡è®°å½•çš„å­—æ®µå:</p>
            <pre>${Object.keys(data[0] || {}).join('\n')}</pre>
            <p>å®Œæ•´æ•°æ®:</p>
            <pre>${JSON.stringify(data, null, 2)}</pre>
          `;
          document.getElementById('step1').className = 'section success';
          return data;
        } else {
          throw new Error(`APIè¿”å›é”™è¯¯: ${json.message}`);
        }
      } catch (error) {
        result.innerHTML = `<p>âŒ <strong>é”™è¯¯:</strong> ${error.message}</p>`;
        document.getElementById('step1').className = 'section error';
        throw error;
      }
    }

    async function testFieldConversion() {
      const result = document.getElementById('step2-result');
      result.innerHTML = '<p>â³ æ­£åœ¨æµ‹è¯•å­—æ®µè½¬æ¢...</p>';
      
      try {
        const backendData = await testBackendAPI();
        
        const convertedData = backendData.map(item => convertFromBackend(item));
        
        result.innerHTML = `
          <p>âœ… <strong>å­—æ®µè½¬æ¢æˆåŠŸ</strong></p>
          <p>è½¬æ¢åçš„å­—æ®µå:</p>
          <pre>${Object.keys(convertedData[0] || {}).join('\n')}</pre>
          <p>è½¬æ¢åçš„å®Œæ•´æ•°æ®:</p>
          <pre>${JSON.stringify(convertedData, null, 2)}</pre>
          <h3>å­—æ®µå¯¹æ¯”:</h3>
          <table border="1" cellpadding="5" style="border-collapse: collapse; width: 100%;">
            <tr>
              <th>åç«¯å­—æ®µï¼ˆè›‡å½¢ï¼‰</th>
              <th>å‰ç«¯å­—æ®µï¼ˆé©¼å³°ï¼‰</th>
              <th>å€¼</th>
            </tr>
            <tr>
              <td>bom_code</td>
              <td>bomCode</td>
              <td>${convertedData[0]?.bomCode || 'âŒ æœªè½¬æ¢'}</td>
            </tr>
            <tr>
              <td>bom_name</td>
              <td>bomName</td>
              <td>${convertedData[0]?.bomName || 'âŒ æœªè½¬æ¢'}</td>
            </tr>
            <tr>
              <td>product_code</td>
              <td>productCode</td>
              <td>${convertedData[0]?.productCode || 'âŒ æœªè½¬æ¢'}</td>
            </tr>
            <tr>
              <td>product_name</td>
              <td>productName</td>
              <td>${convertedData[0]?.productName || 'âŒ æœªè½¬æ¢'}</td>
            </tr>
            <tr>
              <td>material_count</td>
              <td>itemCount</td>
              <td>${convertedData[0]?.itemCount || 'âŒ æœªè½¬æ¢'}</td>
            </tr>
          </table>
        `;
        document.getElementById('step2').className = 'section success';
        return convertedData;
      } catch (error) {
        result.innerHTML = `<p>âŒ <strong>é”™è¯¯:</strong> ${error.message}</p>`;
        document.getElementById('step2').className = 'section error';
        throw error;
      }
    }

    async function simulateFrontendLoad() {
      const result = document.getElementById('step3-result');
      result.innerHTML = '<p>â³ æ­£åœ¨æ¨¡æ‹Ÿå‰ç«¯åŠ è½½...</p>';
      
      try {
        const convertedData = await testFieldConversion();
        
        // æ¨¡æ‹Ÿ Vue è¡¨æ ¼æ¸²æŸ“éœ€è¦çš„æ•°æ®æ ¼å¼
        const tableData = convertedData;
        
        result.innerHTML = `
          <p>âœ… <strong>æ¨¡æ‹ŸåŠ è½½æˆåŠŸ</strong></p>
          <p>å¯ç”¨äºè¡¨æ ¼æ¸²æŸ“çš„æ•°æ®:</p>
          <h3>è¡¨æ ¼é¢„è§ˆ (æ¨¡æ‹Ÿ el-table):</h3>
          <table border="1" cellpadding="8" style="border-collapse: collapse; width: 100%; background: white;">
            <thead style="background: #f5f7fa;">
              <tr>
                <th>BOMç¼–å·</th>
                <th>BOMåç§°</th>
                <th>äº§å“ç¼–å·</th>
                <th>äº§å“åç§°</th>
                <th>ç‰ˆæœ¬å·</th>
                <th>çŠ¶æ€</th>
                <th>ç‰©æ–™æ•°é‡</th>
              </tr>
            </thead>
            <tbody>
              ${tableData.map(row => `
                <tr>
                  <td>${row.bomCode || '<span style="color: red;">ç©ºå€¼</span>'}</td>
                  <td>${row.bomName || '<span style="color: red;">ç©ºå€¼</span>'}</td>
                  <td>${row.productCode || '<span style="color: red;">ç©ºå€¼</span>'}</td>
                  <td>${row.productName || '<span style="color: red;">ç©ºå€¼</span>'}</td>
                  <td>${row.version || '<span style="color: red;">ç©ºå€¼</span>'}</td>
                  <td>${row.status || '<span style="color: red;">ç©ºå€¼</span>'}</td>
                  <td>${row.itemCount !== undefined ? row.itemCount : '<span style="color: red;">ç©ºå€¼</span>'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          <h3>ğŸ¯ è¯Šæ–­ç»“è®º:</h3>
          <p>${tableData[0]?.bomCode ? 'âœ… æ•°æ®è½¬æ¢æ­£å¸¸ï¼Œå­—æ®µæ˜ å°„æ­£ç¡®' : 'âŒ æ•°æ®è½¬æ¢å¤±è´¥ï¼ŒbomCodeä¸ºç©º'}</p>
          <p>å¦‚æœè¿™é‡Œæ˜¾ç¤ºæ­£å¸¸ï¼Œä½†å‰ç«¯é¡µé¢æ˜¾ç¤ºç©ºç™½è¡Œï¼Œåˆ™é—®é¢˜åœ¨äº:</p>
          <ol>
            <li>Vite HMRçƒ­æ›´æ–°å¯¼è‡´çš„çŠ¶æ€ä¸¢å¤±</li>
            <li>Vueç»„ä»¶ç¼“å­˜é—®é¢˜</li>
            <li>å‰ç«¯ä»£ç ä¸­çš„å…¶ä»–é”™è¯¯æ‹¦æˆªäº†æ•°æ®</li>
          </ol>
          <p><strong>å»ºè®®:</strong> å®Œå…¨å…³é—­æµè§ˆå™¨ï¼Œé‡æ–°æ‰“å¼€ http://localhost:3003/bom/production</p>
        `;
        document.getElementById('step3').className = 'section success';
      } catch (error) {
        result.innerHTML = `<p>âŒ <strong>é”™è¯¯:</strong> ${error.message}</p>`;
        document.getElementById('step3').className = 'section error';
      }
    }

    // è‡ªåŠ¨æ‰§è¡Œæ‰€æœ‰æµ‹è¯•
    window.onload = async () => {
      console.log('ğŸš€ å¼€å§‹è‡ªåŠ¨è¯Šæ–­...');
      try {
        await simulateFrontendLoad();
        console.log('âœ… è¯Šæ–­å®Œæˆ');
      } catch (error) {
        console.error('âŒ è¯Šæ–­å¤±è´¥:', error);
      }
    };
  </script>
</body>
</html>
