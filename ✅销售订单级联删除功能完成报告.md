# âœ… é”€å”®è®¢å•çº§è”åˆ é™¤åŠŸèƒ½å®ŒæˆæŠ¥å‘Š

## ğŸ“‹ ä¿®å¤å†…å®¹

### ä¿®å¤çš„æ–‡ä»¶
`backend/routes/salesOrders.js`

### ä¿®å¤çš„åŠŸèƒ½
1. **å•ä¸ªé”€å”®è®¢å•åˆ é™¤** - `DELETE /api/sales-orders/:id`
2. **æ‰¹é‡é”€å”®è®¢å•åˆ é™¤** - `POST /api/sales-orders/batch-delete`

---

## ğŸ”„ çº§è”åˆ é™¤è§„åˆ™

å½“åˆ é™¤é”€å”®è®¢å•æ—¶ï¼Œ**è‡ªåŠ¨åŒæ­¥åˆ é™¤**ä»¥ä¸‹å…³è”æ•°æ®ï¼š

### åˆ é™¤æ¡ä»¶ï¼š
**æ‰€æœ‰ä¸‹çº§è¡¨çš„åŒ¹é…å­—æ®µ = é”€å”®è®¢å•çš„ `internal_order_no`ï¼ˆå†…éƒ¨é”€å”®è®¢å•ç¼–å·ï¼‰**

### çº§è”åˆ é™¤æ¸…å•ï¼š

#### 1ï¸âƒ£ ä¸»ç”Ÿäº§è®¡åˆ’
- **è¡¨å**: `master_production_plans`
- **åŒ¹é…å­—æ®µ**: `internal_order_no = é”€å”®è®¢å•çš„internal_order_no`
- **å‰ç«¯é¡µé¢**: http://localhost:3003/production-planning/plan-list

#### 2ï¸âƒ£ å¤‡æ–™è®¡åˆ’
- **è¡¨å**: `material_preparation_plans`
- **åŒ¹é…å­—æ®µ**: `sales_order_no = é”€å”®è®¢å•çš„internal_order_no`
- **å‰ç«¯é¡µé¢**: http://localhost:3003/production-planning/material-preparation-new

#### 3ï¸âƒ£ é‡‡è´­è®¡åˆ’
- **è¡¨å**: `procurement_plans`
- **åŒ¹é…å­—æ®µ**: `sales_order_no = é”€å”®è®¢å•çš„internal_order_no`
- **å‰ç«¯é¡µé¢**: http://localhost:3003/purchase/procurement-plan

#### 4ï¸âƒ£ æ‰€æœ‰å·¥åºè®¡åˆ’è¡¨ (15ä¸ªè¡¨)
**åŒ¹é…å­—æ®µ**: `sales_order_no = é”€å”®è®¢å•çš„internal_order_no`

| åºå· | è¡¨å | å‰ç«¯é¡µé¢ |
|------|------|----------|
| 1 | `packing_process_plans` | http://localhost:3003/production-planning/packing-process-plan |
| 2 | `spray_painting_process_plans` | http://localhost:3003/production-planning/spray-painting-process-plan |
| 3 | `assembly_process_plans` | http://localhost:3003/production-planning/assembly-process-plan |
| 4 | `sewing_process_plans` | http://localhost:3003/production-planning/sewing-process-plan |
| 5 | `shot_blasting_process_plans` | http://localhost:3003/production-planning/shot-blasting-process-plan |
| 6 | `manual_welding_process_plans` | http://localhost:3003/production-planning/manual-welding-process-plan |
| 7 | `tube_bending_process_plans` | http://localhost:3003/production-planning/tube-bending-process-plan |
| 8 | `laser_tube_cutting_process_plans` | http://localhost:3003/production-planning/laser-tube-cutting-process-plan |
| 9 | `laser_cutting_process_plans` | http://localhost:3003/production-planning/laser-cutting-process-plan |
| 10 | `bending_process_plans` | http://localhost:3003/production-planning/bending-process-plan |
| 11 | `drilling_process_plans` | http://localhost:3003/production-planning/drilling-process-plan |
| 12 | `punching_process_plans` | http://localhost:3003/production-planning/punching-process-plan |
| 13 | `manual_cutting_process_plans` | http://localhost:3003/production-planning/manual-cutting-process-plan |
| 14 | `machine_grinding_process_plans` | http://localhost:3003/production-planning/machine-grinding-process-plan |
| 15 | `cutting_process_plans` | http://localhost:3003/production-planning/cutting-process-plan |

---

## ğŸ”§ å®ç°ç»†èŠ‚

### å•ä¸ªåˆ é™¤åŠŸèƒ½
```javascript
// DELETE /api/sales-orders/:id

åˆ é™¤é¡ºåºï¼š
1. ä¸»ç”Ÿäº§è®¡åˆ’ (internal_order_noåŒ¹é…)
2. å¤‡æ–™è®¡åˆ’ (sales_order_noåŒ¹é…)
3. é‡‡è´­è®¡åˆ’ (sales_order_noåŒ¹é…)
4. æ‰€æœ‰å·¥åºè®¡åˆ’è¡¨ (sales_order_noåŒ¹é…)
5. è®¢å•äº§å“æ˜ç»†
6. å›æ¬¾è®¡åˆ’
7. ä¸»è®¢å•è®°å½•

è¿”å›ç¤ºä¾‹ï¼š
{
  "success": true,
  "message": "è®¢å•åˆ é™¤æˆåŠŸï¼Œçº§è”åˆ é™¤ X æ¡å…³è”æ•°æ®",
  "data": {
    "id": "...",
    "internalOrderNo": "SO2025000001",
    "cascadeDeleted": {
      "masterProductionPlans": 2,
      "materialPreparationPlans": 5,
      "procurementPlans": 1,
      "processPlans": 8
    }
  }
}
```

### æ‰¹é‡åˆ é™¤åŠŸèƒ½
```javascript
// POST /api/sales-orders/batch-delete
// Body: { "ids": ["id1", "id2", "id3"] }

åˆ é™¤é€»è¾‘ï¼š
- éå†æ¯ä¸ªID
- æ‰§è¡Œä¸å•ä¸ªåˆ é™¤ç›¸åŒçš„çº§è”åˆ é™¤é€»è¾‘
- ç´¯è®¡ç»Ÿè®¡åˆ é™¤æ•°é‡

è¿”å›ç¤ºä¾‹ï¼š
{
  "success": true,
  "message": "æˆåŠŸåˆ é™¤ 3 ä¸ªè®¢å•ï¼Œçº§è”åˆ é™¤ 25 æ¡å…³è”æ•°æ®",
  "data": {
    "deletedOrders": [...],
    "cascadeDeleted": {
      "masterProductionPlans": 6,
      "materialPreparationPlans": 10,
      "procurementPlans": 3,
      "processPlans": 6
    }
  }
}
```

---

## ğŸ¯ éªŒè¯æ–¹æ³•

### æ–¹æ³•1: åç«¯æµ‹è¯•è„šæœ¬
```bash
node test-cascade-delete.js
```

### æ–¹æ³•2: å‰ç«¯æ“ä½œ
1. æ‰“å¼€é”€å”®è®¢å•é¡µé¢ï¼šhttp://localhost:3003/sales/orders/list
2. é€‰æ‹©ä¸€ä¸ªè®¢å•
3. ç‚¹å‡»"åˆ é™¤"æŒ‰é’®
4. ç¡®è®¤åˆ é™¤
5. æŸ¥çœ‹åç«¯æ—¥å¿—ï¼Œåº”æ˜¾ç¤ºçº§è”åˆ é™¤ç»Ÿè®¡

### æ–¹æ³•3: ç›´æ¥APIè°ƒç”¨
```bash
# å•ä¸ªåˆ é™¤
curl -X DELETE http://localhost:3003/api/sales-orders/{è®¢å•ID}

# æ‰¹é‡åˆ é™¤
curl -X POST http://localhost:3003/api/sales-orders/batch-delete \
  -H "Content-Type: application/json" \
  -d '{"ids": ["id1", "id2"]}'
```

---

## ğŸ“Š åç«¯æ—¥å¿—ç¤ºä¾‹

```
ğŸ”„ å¼€å§‹åˆ é™¤é”€å”®è®¢å•: abc-123-def
ğŸ“‹ å†…éƒ¨è®¢å•ç¼–å·: SO2025000001
âœ… çº§è”åˆ é™¤ä¸»ç”Ÿäº§è®¡åˆ’: 2 æ¡
âœ… çº§è”åˆ é™¤å¤‡æ–™è®¡åˆ’: 5 æ¡
âœ… çº§è”åˆ é™¤é‡‡è´­è®¡åˆ’: 1 æ¡
âœ… çº§è”åˆ é™¤ packing_process_plans: 2 æ¡
âœ… çº§è”åˆ é™¤ assembly_process_plans: 3 æ¡
âœ… çº§è”åˆ é™¤ sewing_process_plans: 1 æ¡
âœ… åˆ é™¤è®¢å•äº§å“æ˜ç»†
âœ… åˆ é™¤å›æ¬¾è®¡åˆ’
âœ… åˆ é™¤ä¸»è®¢å•è®°å½•
ğŸ‰ è®¢å•çº§è”åˆ é™¤æˆåŠŸ: {
  internalOrderNo: 'SO2025000001',
  ä¸»ç”Ÿäº§è®¡åˆ’: 2,
  å¤‡æ–™è®¡åˆ’: 5,
  é‡‡è´­è®¡åˆ’: 1,
  å·¥åºè®¡åˆ’: 6,
  æ€»è®¡: 14
}
```

---

## âœ… åŠŸèƒ½ç‰¹æ€§

### 1. å®Œæ•´æ€§ä¿è¯
- âœ… åˆ é™¤é”€å”®è®¢å•æ—¶ï¼Œè‡ªåŠ¨åˆ é™¤æ‰€æœ‰ä¸‹çº§æ•°æ®
- âœ… é¿å…å­¤å„¿æ•°æ®æ®‹ç•™
- âœ… ä¿æŒæ•°æ®åº“ä¸€è‡´æ€§

### 2. å®‰å…¨æ€§ä¿è¯
- âœ… ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ï¼ˆTransactionï¼‰
- âœ… ä»»ä½•æ­¥éª¤å¤±è´¥éƒ½ä¼šå›æ»šï¼ˆRollbackï¼‰
- âœ… ä¸ä¼šå‡ºç°éƒ¨åˆ†åˆ é™¤çš„æƒ…å†µ

### 3. å®¹é”™æ€§
- âœ… è¡¨ä¸å­˜åœ¨æ—¶ä¸ä¼šæŠ¥é”™ï¼ˆç»§ç»­æ‰§è¡Œï¼‰
- âœ… è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
- âœ… ä¸å½±å“å…¶ä»–è¡¨çš„åˆ é™¤

### 4. å¯è¿½æº¯æ€§
- âœ… è¯¦ç»†çš„åˆ é™¤æ—¥å¿—
- âœ… è¿”å›åˆ é™¤ç»Ÿè®¡ä¿¡æ¯
- âœ… å¯å®¡è®¡åˆ é™¤æ“ä½œ

---

## ğŸ”’ æ³¨æ„äº‹é¡¹

1. **åˆ é™¤æ“ä½œä¸å¯é€†**
   - åˆ é™¤åæ•°æ®æ— æ³•æ¢å¤
   - å»ºè®®åœ¨åˆ é™¤å‰è¿›è¡ŒäºŒæ¬¡ç¡®è®¤

2. **åˆ é™¤æƒé™**
   - å»ºè®®æ·»åŠ æƒé™æ§åˆ¶
   - åªå…è®¸æˆæƒç”¨æˆ·æ‰§è¡Œåˆ é™¤

3. **æ•°æ®å¤‡ä»½**
   - é‡è¦æ•°æ®åˆ é™¤å‰å»ºè®®å¤‡ä»½
   - å¯ä½¿ç”¨ `./backup-all-data.sh` å¤‡ä»½æ•°æ®åº“

4. **çº§è”å½±å“**
   - åˆ é™¤é”€å”®è®¢å•ä¼šå½±å“å¤šä¸ªæ¨¡å—
   - ç¡®è®¤æ— ä¸šåŠ¡ä¾èµ–åå†åˆ é™¤

---

## ğŸ‰ å®ŒæˆçŠ¶æ€

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| å•ä¸ªåˆ é™¤ | âœ… å®Œæˆ | æ”¯æŒçº§è”åˆ é™¤æ‰€æœ‰å…³è”æ•°æ® |
| æ‰¹é‡åˆ é™¤ | âœ… å®Œæˆ | æ”¯æŒæ‰¹é‡çº§è”åˆ é™¤ |
| äº‹åŠ¡ä¿æŠ¤ | âœ… å®Œæˆ | å¤±è´¥è‡ªåŠ¨å›æ»š |
| æ—¥å¿—è®°å½• | âœ… å®Œæˆ | è¯¦ç»†çš„åˆ é™¤æ—¥å¿— |
| ç»Ÿè®¡ä¿¡æ¯ | âœ… å®Œæˆ | è¿”å›åˆ é™¤æ•°é‡ç»Ÿè®¡ |
| å®¹é”™å¤„ç† | âœ… å®Œæˆ | è¡¨ä¸å­˜åœ¨ä¸æŠ¥é”™ |

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

- âœ… **backend/routes/salesOrders.js** - é”€å”®è®¢å•è·¯ç”±ï¼ˆå·²ä¿®å¤ï¼‰
- ğŸ“„ **test-cascade-delete.js** - æµ‹è¯•è„šæœ¬
- ğŸ“„ **æœ¬æ–‡æ¡£** - åŠŸèƒ½è¯´æ˜æ–‡æ¡£

---

**æœ€åæ›´æ–°**: 2025-12-19  
**ä¿®å¤å®Œæˆ**: âœ… é”€å”®è®¢å•çº§è”åˆ é™¤åŠŸèƒ½å·²å®Œæ•´å®ç°
