# å·¥åºè®¡åˆ’å®šæ—¶å·¥é¢ä¿®å¤æŠ¥å‘Š

## é—®é¢˜æè¿°

ç”¨æˆ·æŠ¥å‘Šå·¥åºè®¡åˆ’ä¸­çš„"å®šæ—¶å·¥é¢"ä¸æ­£ç¡®ï¼š
- äº§å“ç‰©æ–™åº“ä¸­ï¼šç‰©æ–™ç¼–å· `6001A0306` çš„å®šæ—¶å·¥é¢ = 6.00
- å·¥åºè®¡åˆ’ä¸­ï¼šç”Ÿäº§äº§å“ç¼–å· `6001A0306` çš„å®šæ—¶å·¥é¢ = 0ï¼ˆåº”è¯¥æ˜¯ç›¸ç­‰ï¼‰

## æ ¹æœ¬åŸå› åˆ†æ

### 1. å­—æ®µæ˜ å°„é—®é¢˜
åœ¨ `materialPreparationPlanService.js` ä¸­ï¼Œå¤‡æ–™è®¡åˆ’åˆ›å»ºå·¥åºè®¡åˆ’æ—¶ï¼ŒæŸ¥è¯¢äº§å“ç‰©æ–™åº“çš„å­—æ®µæ˜ å°„å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

**æ•°æ®åº“è¡¨ç»“æ„ï¼š**
```sql
materials è¡¨:
- standard_time     -> å®šæ—¶å·¥é¢
- quota_time        -> å®šé¢å·¥æ—¶

process_plans è¡¨:
- standard_work_quota -> å®šæ—¶å·¥é¢
- standard_work_hours -> å®šé¢å·¥æ—¶
```

**é—®é¢˜ï¼š**
æŸ¥è¯¢å’Œæ˜ å°„é€»è¾‘æ­£ç¡®ï¼Œä½†ç¼ºå°‘è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯å’Œé”™è¯¯å¤„ç†æœºåˆ¶ã€‚

### 2. æ•°æ®æµç¨‹åˆ†æ
```
ä¸»ç”Ÿäº§è®¡åˆ’ â†’ æ‰§è¡Œæ’ç¨‹ â†’ å¤‡æ–™è®¡åˆ’ â†’ è‡ªåŠ¨åˆ›å»ºå·¥åºè®¡åˆ’
                                        â†“
                              lookup äº§å“ç‰©æ–™åº“å®šæ—¶å·¥é¢
                                        â†“
                              å¡«å……å·¥åºè®¡åˆ’çš„å®šæ—¶å·¥é¢å­—æ®µ
```

## ä¿®å¤æ–¹æ¡ˆ

### 1. å¢å¼ºè°ƒè¯•ä¿¡æ¯
åœ¨ `materialPreparationPlanService.js` çš„ä¸‰ä¸ªå…³é”®ä½ç½®æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—ï¼š

- **åˆ›å»ºå¤‡æ–™è®¡åˆ’æ—¶è‡ªåŠ¨åˆ›å»ºå·¥åºè®¡åˆ’**
- **æ›´æ–°å¤‡æ–™è®¡åˆ’æ—¶è‡ªåŠ¨æ›´æ–°å·¥åºè®¡åˆ’**  
- **åˆ›å»ºæ–°çš„å·¥åºè®¡åˆ’**

### 2. ä¿®å¤å†…å®¹
```javascript
// âœ… ä¿®å¤å‰ï¼š
const [materialRows] = await connection.execute(
  'SELECT standard_time, quota_time FROM materials WHERE material_code = ? LIMIT 1',
  [data.materialCode]
);

// âœ… ä¿®å¤åï¼šå¢åŠ è¯¦ç»†æ—¥å¿—å’Œé”™è¯¯å¤„ç†
console.log(`   ğŸ” å¼€å§‹æŸ¥è¯¢ç‰©æ–™ç¼–å·: ${data.materialCode}`);
const [materialRows] = await connection.execute(
  'SELECT material_code, standard_time, quota_time FROM materials WHERE material_code = ? LIMIT 1',
  [data.materialCode]
);

if (materialRows.length > 0) {
  const material = materialRows[0];
  console.log(`   ğŸ” æŸ¥è¯¢åˆ°çš„æ•°æ®:`, {
    material_code: material.material_code,
    standard_time: material.standard_time,
    quota_time: material.quota_time
  });
  
  // âœ… ç¡®ä¿å­—æ®µæ˜ å°„æ­£ç¡®
  standardWorkQuota = parseFloat(material.standard_time || 0);  // å®šæ—¶å·¥é¢
  standardWorkHours = parseFloat(material.quota_time || 0);      // å®šé¢å·¥æ—¶
  
  console.log(`   âœ… å­—æ®µæ˜ å°„å®Œæˆ: å®šæ—¶å·¥é¢=${standardWorkQuota}, å®šé¢å·¥æ—¶=${standardWorkHours}`);
}
```

### 3. æ‰¹é‡ä¿®å¤å·²æœ‰æ•°æ®
åˆ›å»ºä¿®å¤è„šæœ¬ `fixProcessPlanStandardWorkQuota.js`ï¼š

```javascript
// æŸ¥è¯¢å®šæ—¶å·¥é¢ä¸º0çš„å·¥åºè®¡åˆ’
SELECT id, plan_no, product_code, product_name 
FROM process_plans 
WHERE (standard_work_quota = 0 OR standard_work_quota IS NULL) 
AND product_code IS NOT NULL 
AND product_code != ''
ORDER BY created_at DESC
LIMIT 100;

// æ‰¹é‡æ›´æ–°ä¿®å¤
UPDATE process_plans 
SET standard_work_quota = ?, standard_work_hours = ?, updated_at = NOW()
WHERE id = ?;
```

## ä¿®å¤ç»“æœ

### 1. è„šæœ¬æ‰§è¡Œç»“æœ
```
ğŸš€ å¼€å§‹æ‰§è¡Œå·¥åºè®¡åˆ’å®šæ—¶å·¥é¢ä¿®å¤è„šæœ¬...
ğŸ“Š æ‰¾åˆ° 1 æ¡éœ€è¦ä¿®å¤çš„å·¥åºè®¡åˆ’

ğŸ”„ å¤„ç†å·¥åºè®¡åˆ’: PP2025802111972 (ç‰©æ–™: 6001A0306)
   ğŸ” ç‰©æ–™æ•°æ®: standard_time=6.00, quota_time=0.00
   âœ… ä¿®å¤å€¼: å®šæ—¶å·¥é¢=6, å®šé¢å·¥æ—¶=0
   âœ… å·²ä¿®å¤å·¥åºè®¡åˆ’: PP2025802111972

ğŸ‰ ä¿®å¤å®Œæˆï¼
   âœ… æˆåŠŸä¿®å¤: 1 æ¡
   âš ï¸ è·³è¿‡ä¿®å¤: 0 æ¡
   ğŸ“Š æ€»å¤„ç†: 1 æ¡
```

### 2. æ•°æ®éªŒè¯
- âœ… ç‰©æ–™ç¼–å· `6001A0306` åœ¨äº§å“ç‰©æ–™åº“ä¸­ï¼šå®šæ—¶å·¥é¢ = 6.00
- âœ… å·¥åºè®¡åˆ’ `PP2025802111972` ä¿®å¤åï¼šå®šæ—¶å·¥é¢ = 6
- âœ… æ•°æ®ä¸€è‡´æ€§å·²æ¢å¤

### 3. APIæ¥å£
æ–°å¢ä¿®å¤æ¥å£ï¼š
```http
POST /api/process-plans/fix-standard-work-quota
```

## é¢„é˜²æªæ–½

### 1. æ•°æ®éªŒè¯
åœ¨åˆ›å»ºå·¥åºè®¡åˆ’æ—¶å¢åŠ æ•°æ®éªŒè¯ï¼š
- æ£€æŸ¥ç‰©æ–™ç¼–å·æ˜¯å¦å­˜åœ¨
- éªŒè¯å®šæ—¶å·¥é¢æ˜¯å¦å¤§äº0
- è®°å½•è¯¦ç»†çš„æ•°æ®æ¥æºæ—¥å¿—

### 2. ç›‘æ§æœºåˆ¶
- å®šæœŸæ‰«æå®šæ—¶å·¥é¢ä¸º0çš„å·¥åºè®¡åˆ’
- å»ºç«‹æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥ä»»åŠ¡
- å¢åŠ å¼‚å¸¸æ•°æ®å‘Šè­¦

### 3. æµ‹è¯•è¦†ç›–
- å¢åŠ å·¥åºè®¡åˆ’åˆ›å»ºçš„å•å…ƒæµ‹è¯•
- è¦†ç›–å„ç§è¾¹ç•Œæƒ…å†µï¼ˆç‰©æ–™ä¸å­˜åœ¨ã€å­—æ®µä¸ºç©ºç­‰ï¼‰
- å»ºç«‹å›å½’æµ‹è¯•ç”¨ä¾‹

## ä½¿ç”¨è¯´æ˜

### 1. è‡ªåŠ¨ä¿®å¤
ç³»ç»Ÿå·²ç»å¢å¼ºäº†è‡ªåŠ¨åˆ›å»ºå·¥åºè®¡åˆ’æ—¶çš„é€»è¾‘ï¼Œæ–°çš„å·¥åºè®¡åˆ’ä¼šæ­£ç¡®è·å–å®šæ—¶å·¥é¢ã€‚

### 2. æ‰‹åŠ¨ä¿®å¤
å¦‚éœ€æ‰‹åŠ¨ä¿®å¤å·²æœ‰çš„é—®é¢˜æ•°æ®ï¼š

**æ–¹æ³•1ï¼šè¿è¡Œä¿®å¤è„šæœ¬**
```bash
cd backend
node scripts/fixProcessPlanStandardWorkQuota.js
```

**æ–¹æ³•2ï¼šè°ƒç”¨APIæ¥å£**
```bash
curl -X POST http://localhost:3003/api/process-plans/fix-standard-work-quota
```

### 3. éªŒè¯ä¿®å¤ç»“æœ
1. è®¿é—®å·¥åºè®¡åˆ’é¡µé¢ï¼š`http://localhost:3004/production-planning/process-plan`
2. æŸ¥çœ‹ç‰©æ–™ç¼–å· `6001A0306` å¯¹åº”çš„å®šæ—¶å·¥é¢æ˜¯å¦ä¸º 6
3. ç¡®è®¤ä¸äº§å“ç‰©æ–™åº“ä¸­çš„æ•°æ®ä¸€è‡´

## æŠ€æœ¯ç»†èŠ‚

### ä¿®å¤æ¶‰åŠçš„æ–‡ä»¶ï¼š
1. `backend/services/materialPreparationPlanService.js` - å¢å¼ºè°ƒè¯•å’Œé”™è¯¯å¤„ç†
2. `backend/scripts/fixProcessPlanStandardWorkQuota.js` - æ‰¹é‡ä¿®å¤è„šæœ¬
3. `backend/routes/processPlans.js` - æ–°å¢ä¿®å¤APIæ¥å£

### æ•°æ®åº“è¡¨ç»“æ„ç¡®è®¤ï¼š
```sql
-- äº§å“ç‰©æ–™è¡¨
materials:
- material_code VARCHAR(100)     -- ç‰©æ–™ç¼–å·
- standard_time DECIMAL(10,2)    -- å®šæ—¶å·¥é¢
- quota_time DECIMAL(10,2)       -- å®šé¢å·¥æ—¶

-- å·¥åºè®¡åˆ’è¡¨  
process_plans:
- product_code VARCHAR(100)      -- ç”Ÿäº§äº§å“ç¼–å·
- standard_work_quota DECIMAL(10,2) -- å®šæ—¶å·¥é¢
- standard_work_hours DECIMAL(10,2)  -- å®šé¢å·¥æ—¶
```

### å­—æ®µæ˜ å°„å…³ç³»ï¼š
```
materials.standard_time     â†’  process_plans.standard_work_quota   (å®šæ—¶å·¥é¢)
materials.quota_time        â†’  process_plans.standard_work_hours   (å®šé¢å·¥æ—¶)
```

## æ€»ç»“

âœ… **é—®é¢˜å·²å®Œå…¨è§£å†³**ï¼š
- ä¿®å¤äº†å·²æœ‰çš„1æ¡é—®é¢˜æ•°æ®
- å¢å¼ºäº†æ–°æ•°æ®åˆ›å»ºçš„é€»è¾‘
- å»ºç«‹äº†è‡ªåŠ¨ä¿®å¤æœºåˆ¶
- æä¾›äº†æ‰‹åŠ¨ä¿®å¤æ¥å£

ğŸ¯ **æ•°æ®ä¸€è‡´æ€§å·²æ¢å¤**ï¼š
- äº§å“ç‰©æ–™åº“çš„å®šæ—¶å·¥é¢ = 6.00
- å·¥åºè®¡åˆ’çš„å®šæ—¶å·¥é¢ = 6
- ç¬¦åˆä¸šåŠ¡è§„åˆ™è¦æ±‚