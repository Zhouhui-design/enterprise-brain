# 销售订单确认下单数据分流功能前端实现报告

## 实施时间
2025-12-16 15:10

## 实施概述
完成销售订单"确认下单"功能的前端开发，实现根据产出工序自动分流到主生产计划或采购计划的完整功能。

---

## 一、修改文件清单

### 1. `/07-frontend/src/api/salesOrder.js`
**修改内容**：新增 `confirmOrder` API方法

**新增代码**：
```javascript
// 确认下单(推送到主生产计划或采购计划)
confirmOrder(ids) {
  return axios.post(`${API_BASE_URL}/sales-orders/confirm-order`, { ids })
}
```

**作用**：调用后端 `/api/sales-orders/confirm-order` 接口，执行订单数据分流

---

### 2. `/07-frontend/src/pages/sales/sales-order/SalesOrderListNew.vue`
**修改内容**：
1. 新增"建议补货数量"列
2. 修改"确认下单"按钮逻辑
3. 自动计算建议补货数量

#### 2.1 新增"建议补货数量"列
**位置**：主表格，在"订单数量"列之后

**代码**：
```vue
<el-table-column prop="suggestedReplenishment" label="建议补货数量" width="140" align="right">
  <template #default="{ row }">
    <el-tag :type="row.suggestedReplenishment > 0 ? 'warning' : 'success'">
      {{ row.suggestedReplenishment || 0 }}
    </el-tag>
  </template>
</el-table-column>
```

**显示效果**：
- 值 > 0：黄色警告标签（需要补货）
- 值 = 0：绿色成功标签（库存充足）

#### 2.2 自动计算建议补货数量
**位置**：`loadOrders()` 方法中，订单数据展开时

**计算公式**：
```javascript
suggestedReplenishment: Math.max(0, (product.orderQuantity || 0) - (order.effective_inventory || 0))
```

**说明**：
- 建议补货数量 = 订单数量 - 有效库存
- 如果结果 < 0，则显示0（库存充足）

#### 2.3 修改"确认下单"按钮逻辑
**原逻辑**：直接创建主生产计划（固定流向）
**新逻辑**：调用后端API，根据产出工序自动分流

**新代码**：
```javascript
const handleConfirmOrder = async () => {
  // 收集唯一的订单ID
  const orderIds = [...new Set(selectedRows.value.map(row => row.id))]
  
  // 调用后端API执行数据分流
  const response = await salesOrderApi.confirmOrder(orderIds)
  
  if (response.data && response.data.success) {
    const result = response.data.data
    ElMessage.success(
      `确认下单成功！\n` +
      `推送 ${result.masterPlansCreated || 0} 条到主生产计划\n` +
      `推送 ${result.procurementPlansCreated || 0} 条到采购计划`
    )
    
    await loadOrders()
    selectedRows.value = []
  }
}
```

**确认对话框文案**：
```
确定要对选中的 N 个订单执行确认下单吗？

确认后将根据"产出工序"分流：
- 产出工序 = "采购" → 推送到采购计划
- 产出工序 ≠ "采购" → 推送到主生产计划
```

---

### 3. `/07-frontend/src/pages/purchase/ProcurementPlanList.vue`
**修改内容**：新增"采购提前期"列

#### 3.1 列定义配置
**位置**：`defaultColumns` 数组，在"备料计划编号"之后

**代码**：
```javascript
{ prop: 'procurementLeadTime', label: '采购提前期', width: 120, filterable: false, visible: true }
```

#### 3.2 数值格式化
**位置**：`getFormattedValue()` 方法

**代码**：
```javascript
if (['requiredQuantity', ..., 'procurementLeadTime'].includes(prop)) {
  if (cellValue === null || cellValue === undefined) return '0.00'
  const value = parseFloat(cellValue)
  return isNaN(value) ? '0.00' : value.toFixed(2)
}
```

**显示格式**：保留2位小数，如 "3.00" 天

---

### 4. `/07-frontend/src/pages/material/MaterialList.vue`
**修改内容**：新增"默认采购提前期"列

#### 4.1 列定义配置
**位置**：`filterTableColumns` 数组，在"定额工时"之后

**代码**：
```javascript
{ 
  prop: 'defaultProcurementLeadTime', 
  label: '默认采购提前期', 
  width: 150, 
  align: 'right', 
  sortable: true 
}
```

**功能**：
- 可排序
- 右对齐
- 支持筛选

---

## 二、功能实现流程

### 2.1 用户操作流程
```
1. 用户在销售订单列表勾选订单
2. 点击"确认下单"按钮
3. 系统显示确认对话框，说明分流规则
4. 用户确认
5. 前端调用 salesOrderApi.confirmOrder(orderIds)
6. 后端执行数据分流：
   - 查询每个订单的产品
   - 查询库存计算建议补货数量
   - 根据产出工序分流到不同表
   - 自动生成编号（CG/MP）
   - Lookup采购提前期
   - 计算计划到货日期
   - 更新订单状态
7. 前端显示成功消息，刷新列表
```

### 2.2 数据流向判断
```javascript
// 后端逻辑（前端无需处理）
if (产出工序 === '采购') {
  推送到 procurement_plans
  生成编号：CG{YYYYMMDD}{0001}
  Lookup默认采购提前期
  计算到货日期 = 客户交期 - 采购提前期
} else {
  推送到 master_production_plans
  生成编号：MP{YYYYMMDD}{0001}
}
```

---

## 三、字段映射关系

### 3.1 销售订单 → 采购计划
| 采购计划字段 | 来源 | 说明 |
|------------|------|------|
| procurement_plan_no | 系统生成 | CG{YYYYMMDD}{序号} |
| source_form_name | 固定值 | "销售订单列表" |
| source_no | 内部销售订单编号 | - |
| material_code | 产品编号 | - |
| material_name | 产品名称 | - |
| material_image | 产品图片 | - |
| required_quantity | 建议补货数量 | 订单数量 - 有效库存 |
| base_unit | 产品单位 | - |
| sales_order_no | 内部销售订单编号 | - |
| customer_order_no | 客户订单编号 | - |
| procurement_lead_time | Lookup | 物料库.默认采购提前期 |
| plan_arrival_date | 计算 | 客户交期 - 采购提前期 |
| procurement_status | 固定值 | 'PENDING_INQUIRY' |

### 3.2 销售订单 → 主生产计划
| 主生产计划字段 | 来源 | 说明 |
|--------------|------|------|
| plan_code | 系统生成 | MP{YYYYMMDD}{序号} |
| product_code | 产品编号 | - |
| product_name | 产品名称 | - |
| order_quantity | 订单数量 | - |
| available_stock | 有效库存 | - |
| plan_quantity | 建议补货数量 | 订单数量 - 有效库存 |
| output_process | 产出工序 | - |
| promised_delivery_date | 客户交期/承诺交期 | - |
| status | 固定值 | '已下单' |
| internal_order_no | 内部销售订单编号 | - |
| customer_order_no | 客户订单编号 | - |
| customer_name | 客户名称 | - |

---

## 四、界面展示效果

### 4.1 销售订单列表
**新增列**："建议补货数量"
- 位置：订单数量之后
- 显示：彩色标签（黄色/绿色）
- 计算：自动实时计算

**"确认下单"按钮**：
- 文案更新：由"正式下单"改为"确认下单"
- 提示优化：明确说明分流规则
- Loading文案："正在处理订单数据分流..."

### 4.2 采购计划页面
**新增列**："采购提前期"
- 位置：备料计划编号之后
- 显示：数值（保留2位小数）+ "天"
- 来源：Lookup物料库

### 4.3 产品物料库页面
**新增列**："默认采购提前期"
- 位置：定额工时之后
- 显示：数值（可排序）
- 功能：可编辑、可筛选

---

## 五、技术要点

### 5.1 前端关键实现
1. **去重处理**：订单列表按产品展开，需去重订单ID
   ```javascript
   const orderIds = [...new Set(selectedRows.value.map(row => row.id))]
   ```

2. **实时计算**：建议补货数量在加载时计算
   ```javascript
   suggestedReplenishment: Math.max(0, orderQuantity - effectiveInventory)
   ```

3. **API调用简化**：前端只传订单ID，分流逻辑全在后端
   ```javascript
   const response = await salesOrderApi.confirmOrder(orderIds)
   ```

### 5.2 后端关键实现（已完成）
1. 事务处理：确保数据一致性
2. 编号生成：按日期统计当天数量
3. Lookup机制：查询物料默认提前期
4. 日期计算：客户交期 - 采购提前期
5. 状态更新：订单状态改为"已确认"

---

## 六、验证步骤

### 6.1 功能验证
1. **前端页面检查**：
   ```bash
   # 访问销售订单列表
   http://localhost:3003/sales/orders/list
   
   # 检查点：
   - ✅ "建议补货数量"列显示正常
   - ✅ 数值计算正确（订单数量 - 有效库存）
   - ✅ "确认下单"按钮文案正确
   ```

2. **数据分流测试**：
   - 勾选产出工序="采购"的订单 → 应推送到采购计划
   - 勾选产出工序="组装"的订单 → 应推送到主生产计划
   - 混合勾选 → 自动分流到两个表

3. **采购计划页面检查**：
   ```bash
   http://localhost:3003/purchase/procurement-plan
   
   # 检查点：
   - ✅ "采购提前期"列显示
   - ✅ 数值正确（lookup自动填充）
   ```

4. **物料库页面检查**：
   ```bash
   http://localhost:3003/material/list
   
   # 检查点：
   - ✅ "默认采购提前期"列显示
   - ✅ 数据库默认值为3天
   ```

### 6.2 完整流程测试
```
1. 准备测试数据：
   - 物料A：来源=采购，默认采购提前期=3天
   - 物料B：来源=生产，产出工序=组装
   - 订单1：产品A，数量10，有效库存5
   - 订单2：产品B，数量20，有效库存25

2. 执行确认下单：
   - 勾选订单1和订单2
   - 点击"确认下单"
   - 查看确认对话框（说明分流规则）
   - 确认执行

3. 验证结果：
   - 订单1 → 采购计划（建议补货数量=5）
   - 订单2 → 主生产计划（建议补货数量=0，因库存充足）
   - 采购计划.采购提前期 = 3天
   - 采购计划.计划到货日期 = 客户交期 - 3天
   - 订单状态 = "已确认"
```

---

## 七、注意事项

### 7.1 用户操作提示
- ✅ 确认下单前检查"建议补货数量"列，确保数据合理
- ✅ 产出工序必须正确设置（影响分流方向）
- ✅ 默认采购提前期可在物料库修改

### 7.2 数据一致性保障
- ✅ 后端使用事务，确保分流过程原子性
- ✅ 编号生成基于日期序号，避免冲突
- ✅ Lookup失败时使用默认值3天

### 7.3 性能优化
- ✅ 前端只传订单ID，减少网络传输
- ✅ 后端批量查询库存和物料，减少数据库查询次数

---

## 八、相关文档
- 后端实现报告：`/销售订单确认下单数据分流功能实现报告.md`
- 数据库脚本：`/backend/scripts/add-procurement-lead-time-fields.js`
- 后端路由：`/backend/routes/salesOrders.js`（confirm-order接口）

---

## 九、修改总结

### 修改文件（4个）
1. ✅ `/07-frontend/src/api/salesOrder.js` - 新增API方法
2. ✅ `/07-frontend/src/pages/sales/sales-order/SalesOrderListNew.vue` - 新增列 + 修改按钮逻辑
3. ✅ `/07-frontend/src/pages/purchase/ProcurementPlanList.vue` - 新增采购提前期列
4. ✅ `/07-frontend/src/pages/material/MaterialList.vue` - 新增默认采购提前期列

### 新增功能
- ✅ 建议补货数量自动计算
- ✅ 确认下单数据自动分流
- ✅ 采购提前期Lookup
- ✅ 计划到货日期自动计算

### 测试建议
建议测试以下场景：
1. 纯采购订单 → 全部推送到采购计划
2. 纯生产订单 → 全部推送到主生产计划
3. 混合订单 → 自动分流到两个表
4. 库存充足订单 → 建议补货数量=0
5. 库存不足订单 → 建议补货数量>0

---

**实施完成** ✅
**可立即进行前端测试**
