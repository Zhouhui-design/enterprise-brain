# 材料单价历史数据更新说明

## 📅 更新时间
2025年12月2日

---

## ❓ 问题描述

### 发现的问题

**问题：** 更换材料单价来源后，已保存的旧BOM数据仍使用采购单价

**原因：**
- 之前材料单价 = 物料库的采购单价
- 现在材料单价 = 物料库的基础单价
- 已保存的BOM子件数据还是旧的采购单价，未更新

**影响：**
- 新添加的子件：使用基础单价 ✅
- 已保存的子件：仍是采购单价 ❌

---

## ✅ 解决方案

### 执行数据更新

**脚本：** `backend/scripts/update-material-price-to-base-price.js`

**功能：**
1. 从物料库加载所有物料的采购单价和基础单价
2. 检查所有BOM子件的材料单价
3. 识别使用采购单价的子件（需要更新）
4. 将采购单价更新为基础单价
5. 验证更新结果

---

## 📊 更新结果

### 统计数据

**总子件数：** 118条

**更新情况：**
- ✅ **需要更新：** 17条（采购单价 → 基础单价）
- ✅ **已经正确：** 100条（已是基础单价）
- ✅ **无物料数据：** 0条（全部能找到对应物料）

**执行结果：**
- ✅ **成功：** 17条
- ❌ **失败：** 0条

---

### 更新示例（前10条）

| BOM ID | 子件编码 | 子件名称 | 更新前(采购单价) | 更新后(基础单价) | 差异 |
|--------|---------|---------|-----------------|-----------------|------|
| 5 | 301002B | 胶水 | 123.89 | 10.18 | -113.71 |
| 5 | 110043B | 带钢1.0*150 | 4250.00 | 4.25 | -4245.75 |
| 5 | 100048B | 黑皮圆管22*1.5*6300mm | 4270.00 | 20.43 | -4249.57 |
| 5 | 261028B | 5CM黑色毛粘带 | 20.00 | 0.80 | -19.20 |
| 5 | 261029B | 5CM黑色刺粘带 | 20.00 | 0.80 | -19.20 |
| 5 | 526006B | 薄膜卷料 | 40.00 | 0.98 | -39.02 |
| 5 | 100002B | φ16*1.2*6150MM黑皮铁圆管 | 4200.00 | 11.32 | -4188.68 |
| 5 | 110050B | RECC钢板:1.8*1500*3000mm | 4650.00 | 4.65 | -4645.35 |
| 5 | 100002B | φ16*1.2*6150MM黑皮铁圆管 | 4200.00 | 11.32 | -4188.68 |
| 5 | 100007B | 钢管 | 3990.00 | 15.61 | -3974.39 |

---

### 验证结果（前5条）

| 子件编码 | 更新前 | 更新后 | 目标值 | 状态 |
|---------|--------|--------|--------|------|
| 301002B | 123.89 | 10.18 | 10.18 | ✅ |
| 110043B | 4250.00 | 4.25 | 4.25 | ✅ |
| 100048B | 4270.00 | 20.43 | 20.43 | ✅ |
| 261028B | 20.00 | 0.80 | 0.80 | ✅ |
| 261029B | 20.00 | 0.80 | 0.80 | ✅ |

**结论：** 所有更新都成功！✅

---

## 🔍 典型案例分析

### 案例1：胶水

**物料信息：**
```
物料编码：301002B
物料名称：胶水
采购单价：123.89元/桶
采购转化率：12.17（1桶=12.17个单位）
基础单价：123.89 ÷ 12.17 = 10.18元/单位
```

**更新过程：**
```
更新前：123.89元（采购单价，按桶计价）
更新后：10.18元（基础单价，按单位计价）
差异：-113.71元
```

**意义：** 统一单位后，可以和其他物料直接比较成本

---

### 案例2：带钢

**物料信息：**
```
物料编码：110043B
物料名称：带钢1.0*150
采购单价：4250.00元/吨
采购转化率：1000（1吨=1000kg）
基础单价：4250.00 ÷ 1000 = 4.25元/kg
```

**更新过程：**
```
更新前：4250.00元（采购单价，按吨计价）
更新后：4.25元（基础单价，按kg计价）
差异：-4245.75元
```

**意义：** 按kg计价更精确，便于成本核算

---

### 案例3：魔术贴

**物料信息：**
```
物料编码：261028B
物料名称：5CM黑色毛粘带
采购单价：20.00元/卷
采购转化率：25（1卷=25米）
基础单价：20.00 ÷ 25 = 0.80元/米
```

**更新过程：**
```
更新前：20.00元（采购单价，按卷计价）
更新后：0.80元（基础单价，按米计价）
差异：-19.20元
```

**意义：** 按米计价更直观，便于用量计算

---

## 🎯 更新逻辑

### 判断标准

**需要更新的条件：**
```javascript
// 当前价格等于采购单价 && 当前价格不等于基础单价
const isPurchasePrice = Math.abs(currentPrice - purchasePrice) < 0.01;
const isBasePrice = Math.abs(currentPrice - basePrice) < 0.01;

if (isPurchasePrice && !isBasePrice) {
  // 需要更新
  更新为基础单价
}
```

**不需要更新的情况：**
1. 当前价格已经是基础单价 ✅
2. 当前价格既不是采购单价也不是基础单价（可能是手动修改的）

---

## 📋 执行步骤

### 运行命令

```bash
cd /home/sardenesy/ai_workspaces/ai_desktop_3
node backend/scripts/update-material-price-to-base-price.js
```

### 执行流程

1. **加载物料库数据** - 读取所有物料的价格信息
2. **加载BOM子件数据** - 读取所有BOM子件的材料单价
3. **分析数据** - 识别需要更新的记录
4. **显示预览** - 展示将要更新的数据（前10条）
5. **执行更新** - 批量更新材料单价
6. **验证结果** - 检查更新是否成功

---

## ⚠️ 注意事项

### 1. 数据安全

**事务处理：**
```javascript
// 开始事务
db.exec('BEGIN TRANSACTION');

// 执行更新
...

// 成功提交
db.exec('COMMIT');

// 失败回滚
db.exec('ROLLBACK');
```

**作用：**
- ✅ 全部成功或全部失败
- ✅ 防止部分更新
- ✅ 保证数据一致性

---

### 2. 更新时机

**建议：**
- ✅ 在更换材料单价来源后立即执行
- ✅ 在系统维护时间执行
- ✅ 做好数据备份后执行

---

### 3. 验证检查

**更新后检查：**
1. 打开生产BOM页面
2. 查看已有BOM的子件材料单价
3. 确认显示的是基础单价
4. 计算材料费用是否正确

---

## 🎉 总结

### 完成情况

- ✅ **脚本创建完成** - `update-material-price-to-base-price.js`
- ✅ **数据更新完成** - 17条记录从采购单价更新为基础单价
- ✅ **验证通过** - 所有更新都成功
- ✅ **数据一致** - 新旧数据都使用基础单价

---

### 更新影响

**正面影响：**
1. ✅ **数据统一** - 所有BOM子件都使用基础单价
2. ✅ **成本准确** - 基于基础单位计算成本更精确
3. ✅ **便于对比** - 不同采购单位的物料可直接比较
4. ✅ **计算简化** - 无需考虑采购单位转换

**示例对比：**
```
更新前：
- 胶水：123.89元/桶
- 钢管：4200.00元/根
- 难以比较哪个更贵

更新后：
- 胶水：10.18元/单位
- 钢管：11.32元/米
- 可以根据使用量直接计算成本
```

---

### 后续建议

1. **定期检查** - 新增BOM后检查材料单价是否正确
2. **物料维护** - 确保物料库的基础单价准确
3. **成本核算** - 使用基础单价重新核算BOM成本

---

**材料单价历史数据已成功更新为基础单价！** 🎊

**执行文件：** `backend/scripts/update-material-price-to-base-price.js`  
**更新记录：** 17条 ✅  
**验证状态：** 全部成功 ✅
