# 客户管理功能修复说明

## 修复时间
2025年12月5日

## 问题描述

用户在新增销售订单页面时,提示"加载客户失败",控制台显示500错误。

### 错误信息
```
❌ 加载客户数据失败: 
Object { message: "Request failed with status code 500", name: "AxiosError", code: "ERR_BAD_RESPONSE", status: 500 }
```

### 请求详情
```
XHRGET http://192.168.2.229:3005/api/customers?page=1&pageSize=1000&status=active
[HTTP/1.1 500 Internal Server Error 2ms]
```

## 根本原因

客户管理功能还在使用**SQLite数据库API**,而项目已经迁移到**MySQL**,导致数据库操作失败。

### 具体问题

1. **后端路由使用SQLite API**
   - 文件: `backend/routes/customers.js`  
   - 使用了 `db.prepare().get()` 和 `db.prepare().all()` 等SQLite专用方法
   - MySQL需要使用异步的 `connection.execute()` 方法

2. **MySQL数据库缺少客户表**
   - `customers` (客户表)

## 修复方案

### 1. 在MySQL中创建客户表

**修改文件**: `/backend/config/database.js`

在 `initializeDatabase()` 函数中添加customers表:

```sql
CREATE TABLE IF NOT EXISTS customers (
  id INT AUTO_INCREMENT PRIMARY KEY,
  customer_code VARCHAR(100) UNIQUE NOT NULL COMMENT '客户编码',
  customer_name VARCHAR(200) NOT NULL COMMENT '客户名称',
  customer_type VARCHAR(50) DEFAULT 'regular' COMMENT '客户类型',
  status VARCHAR(50) DEFAULT 'active' COMMENT '状态',
  contact_person VARCHAR(100) COMMENT '联系人',
  contact_phone VARCHAR(50) COMMENT '联系电话',
  contact_email VARCHAR(100) COMMENT '联系邮箱',
  company VARCHAR(200) COMMENT '公司名称',
  industry VARCHAR(100) COMMENT '行业',
  region VARCHAR(100) COMMENT '地区',
  contact_address VARCHAR(500) COMMENT '联系地址',
  credit_limit DECIMAL(15,2) DEFAULT 0.00 COMMENT '信用额度',
  sales_person VARCHAR(100) COMMENT '销售人员',
  tax_number VARCHAR(100) COMMENT '税号',
  remark TEXT COMMENT '备注',
  created_by VARCHAR(100) DEFAULT 'admin' COMMENT '创建人',
  updated_by VARCHAR(100) COMMENT '更新人',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX idx_customer_code (customer_code),
  INDEX idx_customer_name (customer_name),
  INDEX idx_customer_type (customer_type),
  INDEX idx_status (status),
  INDEX idx_region (region),
  INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='客户表';
```

### 2. 重写客户管理路由(SQLite → MySQL)

**修改文件**: `/backend/routes/customers.js`

#### 主要改动

1. **引入MySQL连接池**
```javascript
// ❌ 旧代码 (SQLite)
const db = require('../config/database')

// ✅ 新代码 (MySQL)
const pool = require('../config/database')
```

2. **获取客户列表 (GET /api/customers)**
```javascript
// ❌ SQLite 同步API
const countResult = db.prepare(countSQL).get(...params)
const total = countResult.total
const customers = db.prepare(dataSQL).all(...params, parseInt(pageSize), offset)

// ✅ MySQL 异步API
connection = await pool.getConnection()
const [countResult] = await connection.execute(countSQL, params)
const total = countResult[0].total

const offset = (parseInt(page) - 1) * parseInt(pageSize)
const limitPageSize = parseInt(pageSize)
const dataSQL = `
  SELECT * FROM customers 
  ${whereSQL}
  ORDER BY created_at DESC 
  LIMIT ${limitPageSize} OFFSET ${offset}
`
const [customers] = await connection.execute(dataSQL, params)
connection.release()
```

3. **获取客户详情 (GET /api/customers/:id)**
```javascript
// ❌ SQLite
const customer = db.prepare('SELECT * FROM customers WHERE id = ?').get(id)

// ✅ MySQL
const [customers] = await connection.execute('SELECT * FROM customers WHERE id = ?', [id])
const customer = customers[0]
```

#### 重要修复: LIMIT/OFFSET参数问题

与销售订单修复相同,使用直接拼接而非占位符:

```javascript
// ✅ 直接拼接 (避免MySQL2兼容性问题)
const offset = (parseInt(page) - 1) * parseInt(pageSize)
const limitPageSize = parseInt(pageSize)
const dataSQL = `
  SELECT * FROM customers 
  ${whereSQL}
  ORDER BY created_at DESC 
  LIMIT ${limitPageSize} OFFSET ${offset}
`
const [customers] = await connection.execute(dataSQL, params)
```

## 验证结果

### 数据库表创建成功
```bash
mysql> SHOW TABLES LIKE 'customers';
+------------------------------+
| Tables_in_enterprise_brain (customers) |
+------------------------------+
| customers                    |
+------------------------------+
```

### API测试成功
```bash
$ curl 'http://localhost:3005/api/customers?page=1&pageSize=1000&status=active'
{
    "success": true,
    "data": {
        "list": [],
        "total": 0,
        "page": 1,
        "pageSize": 1000
    }
}
```

✅ 返回空列表是正常的,因为数据库是全新的,还没有客户数据。

## 影响范围

### 修改的文件
1. `/backend/config/database.js` - 添加customers表结构  
2. `/backend/routes/customers.js` - 部分重写为MySQL版本(GET路由)

### 涉及的API (已修复)
- `GET /api/customers` - 获取客户列表 ✅
- `GET /api/customers/:id` - 获取客户详情 ✅

### 待修复的API (如有需要)
- `POST /api/customers` - 创建客户
- `PUT /api/customers/:id` - 更新客户
- `DELETE /api/customers/:id` - 删除客户
- `POST /api/customers/batch-delete` - 批量删除客户
- `GET /api/customers/stats` - 客户统计

**注意**: 当前只修复了查询相关的路由,如果需要创建、更新、删除客户,需要继续迁移其他路由。

## 测试建议

1. **前端集成测试**
   - ✅ 打开新增销售订单页面,确认不再提示"加载客户失败"
   - ⚠️ 创建客户(需要先迁移POST路由)
   - ⚠️ 查看客户详情
   - ⚠️ 编辑客户
   - ⚠️ 删除客户

2. **功能测试**
   - 测试客户筛选(类型、状态、地区)
   - 测试客户搜索
   - 测试分页功能

## 与销售订单修复的关系

本次修复延续了销售订单的迁移模式:
- 相同的SQLite → MySQL迁移方案
- 相同的LIMIT/OFFSET处理方式
- 相同的连接池管理模式

## 总结

客户管理功能的查询API已从SQLite成功迁移到MySQL,解决了新增销售订单页面的500错误问题。现在用户可以正常打开新增销售订单页面,客户列表会正常加载(虽然目前是空的)。

如果需要完整的客户管理功能(增删改),需要继续迁移其他路由到MySQL。

---
**修复人员**: AI Assistant  
**审核人员**: 待审核  
**状态**: ✅ 查询功能修复完成,增删改功能待迁移
