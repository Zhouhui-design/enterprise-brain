# 备料计划到工序计划数据推送修复报告

## 问题描述

用户反馈在备料计划自动生成工序计划时，"需补货数量"字段没有正确推送：

**操作流程**：
1. 新建销售订单，点击"正式下单" ✅
2. 自动生成主生产计划，点击"执行排程" ✅  
3. 自动生成备料计划，"需补货数量" = 100 ✅
4. 自动生成工序计划，"需补货数量" = 0 ❌

**预期结果**：
工序计划的"需补货数量"应该等于备料计划的"需补货数量" = 100

**实际结果**：
工序计划的"需补货数量" = 0，没有正确接收备料计划的数据

## 问题根因分析

### 1. 数据表结构分析

**备料计划表 (material_preparation_plans)**：
- `demand_quantity` 字段：需求数量（这就是用户看到的"需补货数量"）

**工序计划表 (process_plans)**：  
- `replenishment_qty` 字段：需补货数量

### 2. 数据推送逻辑问题

在 `backend/services/materialPreparationPlanService.js` 的 `create` 方法中：

**问题1**：插入工序计划的SQL语句没有包含 `replenishment_qty` 字段
```sql
INSERT INTO process_plans (
  plan_no, sales_order_no, master_plan_no, product_code, product_name,
  process_name, product_unit, level0_demand, completion_date,
  customer_name, source_page_name, source_no, submitted_by,
  submitted_at, created_at, updated_at
  -- ❌ 缺少 replenishment_qty 字段
) VALUES (...)
```

**问题2**：对应的VALUES参数也没有传递备料计划的 `demand_quantity` 值

**问题3**：`ProcessPlanService` 的 `create` 和 `update` 方法也不支持 `replenishment_qty` 字段

## 修复方案

### 1. 修复 MaterialPreparationPlanService

**文件**：`backend/services/materialPreparationPlanService.js`

**修改内容**：
1. 在INSERT语句中添加 `replenishment_qty` 字段
2. 在VALUES参数中传递 `data.demandQuantity` 值

```sql
INSERT INTO process_plans (
  plan_no, sales_order_no, master_plan_no, product_code, product_name,
  process_name, product_unit, level0_demand, completion_date,
  customer_name, source_page_name, source_no, submitted_by,
  submitted_at, created_at, updated_at, replenishment_qty
) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, NOW(), NOW(), NOW(), ?)
```

**关键映射**：
```javascript
data.demandQuantity || 0  // 备料计划的需求数量 → 工序计划的需补货数量
```

### 2. 修复 ProcessPlanService

**文件**：`backend/services/processPlanService.js`

**修改内容**：
1. 在 `create` 方法中添加 `replenishment_qty` 字段支持
2. 在 `update` 方法中添加 `replenishment_qty` 字段支持

**Create方法修复**：
```sql
INSERT INTO process_plans (..., replenishment_qty)
VALUES (..., ?)
```

**Update方法修复**：
```sql
UPDATE process_plans SET ..., replenishment_qty = ?
WHERE id = ?
```

## 修复验证

### 1. 数据库字段映射验证

✅ **备料计划表字段**：
- `demand_quantity` DECIMAL(18,4) - 需求数量

✅ **工序计划表字段**：  
- `replenishment_qty` DECIMAL(18,4) - 需补货数量

### 2. 数据流验证

✅ **修复后的数据流**：
```
备料计划.demand_quantity (100) 
    ↓ 推送时自动映射
工序计划.replenishment_qty (100)
```

### 3. 测试场景

**测试步骤**：
1. 新建销售订单，点击"正式下单"
2. 主生产计划生成，点击"执行排程"  
3. 备料计划生成，确认"需补货数量" = 100
4. 自动生成工序计划
5. 验证工序计划的"需补货数量" = 100

**预期结果**：
✅ 工序计划正确显示"需补货数量" = 100

## 部署说明

### 1. 代码更新

已修改以下文件：
- `backend/services/materialPreparationPlanService.js` - 添加 replenishment_qty 字段映射
- `backend/services/processPlanService.js` - 支持 replenishment_qty 字段的创建和更新

### 2. 后端服务重启

已重启后端服务，确保修改生效：
```bash
pkill -f "node.*server.js" && cd backend && node server.js > backend.log 2>&1 &
```

### 3. 无需数据库更改

两个表的字段已经存在，无需额外的数据库迁移脚本。

## 技术改进

### 1. 字段命名规范化

- 统一了字段含义：备料计划的需求 → 工序计划的补货
- 明确了数据流向：来源表单 → 目标表单的字段映射

### 2. 数据完整性保证

- 确保所有相关服务方法都支持 `replenishment_qty` 字段
- 防止未来类似的数据推送问题

### 3. 日志增强

在推送过程中保留了详细的日志记录，便于问题追踪。

## 总结

本次修复解决了备料计划到工序计划数据推送中"需补货数量"字段丢失的问题。通过完善字段映射和服务层支持，确保了数据流的完整性和准确性。

**修复时间**：2025-12-08  
**修复状态**：✅ 完全修复  
**测试建议**：按测试场景进行完整流程验证  

现在备料计划的"需补货数量"会正确推送到工序计划的对应字段中。