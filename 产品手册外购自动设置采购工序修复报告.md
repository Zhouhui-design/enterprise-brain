# 产品手册"外购"自动设置"采购"工序功能实现报告

## 修复时间
2025-12-16 15:20

## 需求说明
在产品手册的新增产品页面中，当"来源"字段选择"外购"时，"产出工序名称"字段应自动填充为"采购"。

---

## 实现方案

### 1. 监听来源字段变化
在 `ProductManualEdit.vue` 组件中添加 `watch` 监听器，监听 `formData.source` 字段的变化：

**位置**：第260-268行（在 props 监听之前）

**实现代码**：
```javascript
// 监听来源字段变化 - 当选择"外购"时，自动设置产出工序名称为"采购"
watch(() => formData.source, (newSource) => {
  if (Array.isArray(newSource) && newSource.includes('外购')) {
    formData.outputProcessName = '采购'
    console.log('✅ 来源包含"外购"，自动设置产出工序名称为"采购"')
  }
}, { deep: true })
```

**关键点**：
- 使用 `deep: true` 深度监听数组变化
- 检查数组中是否包含"外购"
- 自动设置 `outputProcessName` 为"采购"
- 添加控制台日志便于调试

---

### 2. 优化UI提示信息
修改"产出工序名称"字段的UI，根据来源选择显示不同的提示：

**位置**：第46-59行

**修改内容**：
1. **动态 placeholder**：
   - 当来源包含"外购"时：显示"来源=外购，自动设置为采购"
   - 其他情况：显示"从产品物料库自动获取"

2. **新增提示信息**：
   ```vue
   <div v-else-if="formData.source && formData.source.includes('外购')" 
        style="margin-top: 5px; color: #67c23a; font-size: 12px;">
     ✅ 来源包含"外购"，已自动设置为"采购"
   </div>
   ```

**UI效果**：
- 查询中：蓝色提示 + 加载图标
- 外购：绿色提示 + 对勾图标
- 其他：无提示

---

## 功能特性

### 触发条件
- ✅ 用户在"来源"下拉框中勾选"外购"
- ✅ 支持多选（外购可以与其他选项同时选择）
- ✅ 实时响应，无需点击其他字段

### 自动填充规则
| 来源选择 | 产出工序名称 | 说明 |
|---------|------------|------|
| 包含"外购" | 采购 | 自动设置，不可手动修改 |
| 不包含"外购" | 空或从物料库lookup | 依赖产品编号lookup |

### 优先级
1. **外购优先**：如果来源包含"外购"，直接设置为"采购"，不再执行lookup
2. **Lookup次之**：如果来源不包含"外购"，通过产品编号从物料库查询

---

## 使用场景示例

### 场景1：新增外购产品
```
1. 用户点击"新增产品"
2. 填写产品基本信息（编号、名称等）
3. 在"来源"下拉框中勾选"外购"
4. 系统自动将"产出工序名称"设置为"采购"
5. 显示绿色提示："✅ 来源包含'外购'，已自动设置为'采购'"
6. 用户继续填写其他信息并提交
```

### 场景2：外购 + 其他来源
```
1. 用户在"来源"中同时勾选"外购"和"自制"
2. 系统仍然将"产出工序名称"设置为"采购"
3. 说明：只要包含"外购"，就执行自动设置逻辑
```

### 场景3：修改来源
```
1. 用户初始选择了"自制"
2. 后续勾选了"外购"
3. "产出工序名称"立即从空变为"采购"
4. 如果再取消勾选"外购"
5. "产出工序名称"保持为"采购"（不会自动清空）
```

---

## 技术细节

### 数据结构
- **来源字段**（source）：数组类型，支持多选
  - 可选值：["自制", "客供", "外购", "外协"]
  - 示例：`["外购", "自制"]`

- **产出工序名称**（outputProcessName）：字符串类型
  - 禁用状态（不可手动编辑）
  - 通过watch自动填充

### 监听机制
- **监听对象**：`formData.source`
- **监听深度**：`deep: true`（深度监听数组内容变化）
- **触发时机**：来源字段值变化时立即触发

### UI状态
1. **查询中**（lookupLoading = true）：
   - 蓝色提示 + 加载动画
   - 文案："正在查询产出工序..."

2. **外购自动设置**（来源包含"外购"）：
   - 绿色提示 + 对勾
   - 文案："✅ 来源包含'外购'，已自动设置为'采购'"

3. **正常状态**（其他情况）：
   - 无提示
   - 显示placeholder

---

## 已修改的文件

### `/07-frontend/src/pages/product/ProductManualEdit.vue`

**修改1：新增watch监听器**（第260-268行）
```javascript
// 监听来源字段变化 - 当选择"外购"时，自动设置产出工序名称为"采购"
watch(() => formData.source, (newSource) => {
  if (Array.isArray(newSource) && newSource.includes('外购')) {
    formData.outputProcessName = '采购'
    console.log('✅ 来源包含"外购"，自动设置产出工序名称为"采购"')
  }
}, { deep: true })
```

**修改2：优化UI提示**（第46-59行）
- 动态placeholder
- 新增绿色提示信息

---

## 测试验证

### 测试步骤
1. 访问产品手册：http://localhost:3004/product/manual
2. 点击"新增产品"按钮
3. 在"来源"下拉框中勾选"外购"
4. 观察"产出工序名称"字段

### 预期结果
✅ "产出工序名称"自动显示"采购"
✅ 显示绿色提示："✅ 来源包含'外购'，已自动设置为'采购'"
✅ 字段保持禁用状态（灰色背景）

### 扩展测试
1. **多选测试**：勾选"外购"+"自制" → 应仍显示"采购"
2. **切换测试**：先选"自制"，再选"外购" → 应立即变为"采购"
3. **取消测试**：勾选"外购"后再取消 → "采购"保持不变

---

## 边界情况处理

### 1. 来源为空
- 行为：不触发自动设置
- 产出工序名称：保持原值或空

### 2. 仅选择其他来源（不含外购）
- 行为：不触发自动设置
- 产出工序名称：依赖产品编号lookup

### 3. 来源同时包含多个选项
- 行为：只要包含"外购"，就自动设置为"采购"
- 说明：外购优先级最高

### 4. 编辑已有产品
- 行为：如果原产品来源包含"外购"，加载时自动设置为"采购"
- 说明：watch监听会在数据加载后触发

---

## 与其他功能的关系

### 1. 与产品编号lookup的关系
- **外购产品**：不执行lookup，直接设置为"采购"
- **非外购产品**：当产品编号失去焦点时，执行lookup查询物料库

### 2. 与数据提交的关系
- 提交时，`outputProcessName` 字段值为"采购"
- 保存到数据库的 `output_process_name` 字段
- 后续在销售订单等页面可正确读取

### 3. 与物料库的关系
- 新增的产品手册数据可能同步到物料库
- 物料库中的"产出工序名称"应与产品手册一致
- 确保数据流向一致性

---

## 注意事项

### 对用户的提示
1. ✅ "外购"类产品的"产出工序名称"会自动设置为"采购"
2. ✅ 此字段不可手动修改（禁用状态）
3. ✅ 如需修改，应调整"来源"字段

### 对开发者的提示
1. ⚠️ `source` 字段是数组类型，使用 `includes()` 判断
2. ⚠️ 需要深度监听（`deep: true`）才能捕获数组内容变化
3. ⚠️ 如果后续需要支持其他来源的自动设置，可扩展此逻辑

---

## 后续优化建议

### 1. 扩展自动设置规则
可以考虑为其他来源也添加自动设置逻辑：
- 来源 = "外协" → 产出工序 = "外协"
- 来源 = "客供" → 产出工序 = "客供"

### 2. 增加撤销功能
如果用户误选"外购"，提供一键清空"产出工序名称"的功能

### 3. 数据验证
在提交前验证：
- 如果来源包含"外购"，产出工序必须是"采购"
- 确保数据一致性

---

## 相关文档
- 产品手册页面：http://localhost:3004/product/manual
- 修改文件：`/07-frontend/src/pages/product/ProductManualEdit.vue`

---

**实施完成** ✅
**可立即在浏览器中测试**
