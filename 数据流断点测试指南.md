# 数据流断点测试指南

## 测试目标
验证：销售订单 → 主生产计划 → 备料计划 → 工序计划 的完整数据流

## 第1步：查看数据库的3种方法

### 方法1：直接命令行查询（最快）

```bash
# 在任意目录下执行，不需要先输入mysql
# 查看销售订单
mysql -u root -pNopqrst_123 enterprise_brain -e "SELECT id, internal_order_no, customer_name, created_at FROM sales_orders ORDER BY id DESC LIMIT 5;"

# 查看主生产计划
mysql -u root -pNopqrst_123 enterprise_brain -e "SELECT id, plan_code, product_code, plan_quantity, created_at FROM master_production_plans ORDER BY id DESC LIMIT 5;"

# 查看备料计划
mysql -u root -pNopqrst_123 enterprise_brain -e "SELECT id, plan_no, material_code, demand_quantity, replenishment_quantity, created_at FROM material_preparation_plans ORDER BY id DESC LIMIT 5;"

# 查看打包工序计划
mysql -u root -pNopqrst_123 enterprise_brain -e "SELECT id, plan_no, product_code, replenishment_qty, created_at FROM real_process_plans ORDER BY id DESC LIMIT 5;"
```

### 方法2：进入MySQL交互模式

```bash
# 1. 进入MySQL（会提示输入密码，密码是：Nopqrst_123）
mysql -u root -p

# 2. 选择数据库
use enterprise_brain;

# 3. 执行查询
SELECT * FROM sales_orders ORDER BY id DESC LIMIT 5;
SELECT * FROM master_production_plans ORDER BY id DESC LIMIT 5;
SELECT * FROM material_preparation_plans ORDER BY id DESC LIMIT 5;
SELECT * FROM real_process_plans ORDER BY id DESC LIMIT 5;

# 4. 退出
exit;
```

### 方法3：使用Node.js脚本（推荐）

```bash
# 进入backend目录
cd /home/sardenesy/ai_workspaces/ai_desktop_3/backend

# 查看销售订单
node -e "
const { pool } = require('./config/database');
pool.execute('SELECT id, internal_order_no, customer_name FROM sales_orders ORDER BY id DESC LIMIT 5')
  .then(([rows]) => { console.table(rows); process.exit(0); });
"

# 查看主生产计划
node -e "
const { pool } = require('./config/database');
pool.execute('SELECT id, plan_code, product_code, plan_quantity FROM master_production_plans ORDER BY id DESC LIMIT 5')
  .then(([rows]) => { console.table(rows); process.exit(0); });
"

# 查看备料计划
node -e "
const { pool } = require('./config/database');
pool.execute('SELECT id, plan_no, material_code, demand_quantity FROM material_preparation_plans ORDER BY id DESC LIMIT 5')
  .then(([rows]) => { console.table(rows); process.exit(0); });
"
```

## 第2步：清理之前的测试数据

```bash
cd /home/sardenesy/ai_workspaces/ai_desktop_3/backend

node -e "
const { pool } = require('./config/database');
(async () => {
  // 删除产品6001A0306相关的所有数据
  await pool.execute('DELETE FROM real_process_plans WHERE main_plan_product_code = ?', ['6001A0306']);
  await pool.execute('DELETE FROM assembly_process_plans WHERE master_plan_product_code = ?', ['6001A0306']);
  await pool.execute('DELETE FROM material_preparation_plans WHERE main_plan_product_code = ?', ['6001A0306']);
  
  const [plans] = await pool.execute('SELECT id FROM master_production_plans WHERE product_code = ?', ['6001A0306']);
  for (const plan of plans) {
    await pool.execute('DELETE FROM master_production_plans WHERE id = ?', [plan.id]);
  }
  
  console.log('✅ 清理完成');
  process.exit(0);
})();
"
```

## 第3步：在浏览器中创建销售订单

1. **打开浏览器**，访问：http://localhost:5173

2. **进入销售订单页面**

3. **点击"新增"按钮**

4. **填写销售订单信息**：
   - 客户名称：测试客户
   - 产品编号：6001A0306
   - 订单数量：100
   - 产品单位：PCS
   - 客户交期：2026-01-10
   - 销售员：admin

5. **点击"确认下单"**

## 第4步：断点1 - 检查销售订单是否创建成功

```bash
# 查看最新创建的销售订单
mysql -u root -pNopqrst_123 enterprise_brain -e "
SELECT id, internal_order_no, customer_name, 
       JSON_EXTRACT(product_list, '$[0].productCode') as product_code,
       JSON_EXTRACT(product_list, '$[0].orderQuantity') as quantity,
       created_at 
FROM sales_orders 
ORDER BY id DESC LIMIT 1;
"
```

**预期结果**：
- ✅ 应该看到1条记录
- ✅ internal_order_no 不为空（如：SO202512150001）
- ✅ product_code = 6001A0306
- ✅ quantity = 100

**如果没有数据**：说明销售订单创建失败，需要检查前端或后端错误。

## 第5步：断点2 - 检查主生产计划是否自动生成

```bash
# 查看最新的主生产计划
mysql -u root -pNopqrst_123 enterprise_brain -e "
SELECT id, plan_code, product_code, plan_quantity, 
       internal_order_no, created_at 
FROM master_production_plans 
WHERE product_code = '6001A0306'
ORDER BY id DESC LIMIT 1;
"
```

**预期结果**：
- ✅ 应该看到1条记录
- ✅ plan_code 不为空（如：MCP202512150001）
- ✅ product_code = 6001A0306
- ✅ plan_quantity = 100

**如果没有数据**：说明销售订单→主生产计划的自动生成失败。

## 第6步：在浏览器中执行排程

1. **进入主生产计划页面**

2. **找到刚才生成的主生产计划**（产品编号=6001A0306）

3. **点击"执行排程"按钮**

4. **等待提示成功**

## 第7步：断点3 - 检查备料计划是否生成

```bash
# 查看备料计划
mysql -u root -pNopqrst_123 enterprise_brain -e "
SELECT id, plan_no, material_code, material_name,
       material_source, source_process, demand_quantity,
       available_stock, replenishment_quantity,
       push_to_process, created_at
FROM material_preparation_plans 
WHERE main_plan_product_code = '6001A0306'
ORDER BY id ASC;
"
```

**预期结果**：
- ✅ 应该看到至少1条记录
- ✅ plan_no 不为空
- ✅ material_code = 6001A0306
- ✅ material_source = '自制'
- ✅ source_process = '打包' 或 '组装'
- ✅ replenishment_quantity > 0

**如果没有数据**：
- ❌ **这就是当前的问题点**！
- 原因：备料计划create方法有SQL错误
- 错误信息：Column count doesn't match value count at row 1

## 第8步：断点4 - 检查打包工序计划是否生成

```bash
# 查看打包工序计划
mysql -u root -pNopqrst_123 enterprise_brain -e "
SELECT id, plan_no, product_code, product_name,
       process_name, source_no, replenishment_qty,
       created_at
FROM real_process_plans 
WHERE main_plan_product_code = '6001A0306'
ORDER BY id ASC;
"
```

**预期结果**：
- ✅ 应该看到1条记录（如果备料计划正常生成的话）
- ✅ plan_no 不为空（如：RPP202512150001）
- ✅ product_code = 6001A0306
- ✅ process_name = '打包'
- ✅ source_no = 备料计划的plan_no

**如果没有数据**：说明备料计划→打包工序计划的推送失败。

## 第9步：断点5 - 检查BOM子件备料计划是否生成

```bash
# 查看第二轮备料计划（BOM子件）
mysql -u root -pNopqrst_123 enterprise_brain -e "
SELECT id, plan_no, material_code, material_name,
       parent_code, source_process, replenishment_quantity,
       created_at
FROM material_preparation_plans 
WHERE parent_code = '6001A0306'
ORDER BY id ASC;
"
```

**预期结果**：
- ✅ 应该看到3条记录（470001A, 470002A, 511442B）
- ✅ parent_code = 6001A0306
- ✅ 其中2条source_process = '组装'
- ✅ 其中1条source_process = '采购'

## 第10步：断点6 - 检查组装工序计划是否生成

```bash
# 查看组装工序计划
mysql -u root -pNopqrst_123 enterprise_brain -e "
SELECT id, plan_no, product_code, product_name,
       process_name, source_no, replenishment_qty,
       created_at
FROM assembly_process_plans 
WHERE master_plan_product_code = '6001A0306'
ORDER BY id ASC;
"
```

**预期结果**：
- ✅ 应该看到2条记录（470001A, 470002A）
- ✅ process_name = '组装'

## 当前问题总结

根据服务器日志，**当前卡在断点3**：

**问题**：备料计划无法创建
**错误**：Column count doesn't match value count at row 1
**原因**：materialPreparationPlanService.js的create方法中，INSERT语句的字段数量与VALUES的值数量不匹配

**SQL字段**：40个
**实际传值**：42-44个（推测有重复或多余的参数）

## 下一步行动

我需要修复备料计划create方法的SQL错误，然后您再重新测试。

修复后，整个数据流应该能够正常运转！
