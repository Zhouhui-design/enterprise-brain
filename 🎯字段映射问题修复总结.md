# 🎯 销售订单字段映射问题修复总结

## 📋 修复概览

本次修复解决了销售订单在两个场景下的字段映射缺失问题：

### 问题1：产品来源字段在订单列表不显示
- **影响范围**：销售订单新增 → 保存 → 列表显示
- **状态**：✅ 已修复

### 问题2：确认下单推送主生产计划字段缺失
- **影响范围**：销售订单 → 确认下单 → 主生产计划
- **状态**：✅ 已修复

---

## 🔧 修复详情

### 修复1：产品来源字段映射（SalesOrderCreate.vue + SalesOrderListNew.vue）

#### 修复内容
1. **前端保存映射**（SalesOrderCreate.vue 第1331行）
   ```javascript
   productSource: p.productSource || ''  // 🆕 添加产品来源字段
   ```

2. **列表加载映射**（SalesOrderListNew.vue 3处）
   - 第846行：JSON格式产品列表
   - 第864行：数组格式产品列表
   - 第881行：单个产品信息
   ```javascript
   productSource: p.product_source || p.productSource || ''
   ```

#### 数据流
```
产品手册 → Lookup → 前端显示 → 保存到数据库 → 列表加载显示 ✅
```

#### 详细报告
📄 `✅产品来源字段映射修复完成报告.md`

---

### 修复2：主生产计划字段映射（salesOrders.js）

#### 修复内容
**位置**：`backend/routes/salesOrders.js` 第687-713行

**新增字段映射**：
1. ✅ `salesperson` ← `order.salesperson`（销售员）
2. ✅ `sales_unit` ← `product.product_unit`（销售单位）
3. ✅ `product_source` ← `product.product_source`（产品来源）
4. ✅ `submitter` ← `order.salesperson`（提交人，改为使用销售员）

#### 修复前后对比

**修复前**：
```javascript
INSERT INTO master_production_plans (
  plan_code, product_code, product_name, order_quantity,
  output_process, promised_delivery_date,
  internal_order_no, customer_order_no, customer_name,
  status, submitter
) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
// ❌ 缺少 salesperson, sales_unit, product_source
// ❌ submitter 固定为 'admin'
```

**修复后**：
```javascript
INSERT INTO master_production_plans (
  plan_code, product_code, product_name, order_quantity,
  salesperson, sales_unit, product_source,        // ✅ 新增
  output_process, promised_delivery_date,
  internal_order_no, customer_order_no, customer_name,
  status, submitter, created_at, updated_at       // ✅ 修改
) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, NOW(), NOW())
// ✅ 完整映射所有关键字段
// ✅ submitter 使用 order.salesperson
```

#### 数据流
```
销售订单主表 (sales_orders)
  └─ salesperson 字段
      ↓
销售订单产品明细 (sales_order_products)
  └─ product_unit 字段
  └─ product_source 字段
      ↓
确认下单 API (POST /confirm-order)
  └─ 推送到主生产计划
      ↓
主生产计划 (master_production_plans)
  ├─ salesperson ✅
  ├─ sales_unit ✅
  ├─ product_source ✅
  └─ submitter ✅
```

#### 详细报告
📄 `✅销售订单推送主生产计划字段映射修复完成报告.md`

---

## 🧪 完整测试流程

### 步骤1：测试产品来源字段显示

1. **创建销售订单**
   ```
   访问：http://localhost:3003/sales/orders/list
   点击："新增"按钮
   ```

2. **选择产品**
   ```
   在产品信息子表格中选择产品
   验证："产品来源"列自动填充（"自制"或"外购"）✅
   ```

3. **提交订单**
   ```
   点击："提交"按钮
   等待：保存成功提示
   ```

4. **验证列表显示**
   ```
   返回：销售订单列表
   查看："产品来源"列应显示正确的值 ✅
   预期：不再为空！
   ```

---

### 步骤2：测试主生产计划字段映射

1. **准备销售订单**
   ```
   确保订单包含：
   - 销售员：张三 ✅
   - 产品单位：个 ✅
   - 产品来源：自制 ✅
   ```

2. **确认下单**
   ```
   在销售订单列表中勾选订单
   点击："确认下单"按钮
   确认：推送提示对话框
   等待：推送完成
   ```

3. **验证主生产计划**
   ```
   访问：http://localhost:3003/production-planning/plan-list
   找到：最新的主生产计划记录
   验证字段：
     ✅ 销售员 = "张三"（非空）
     ✅ 销售单位 = "个"（非空）
     ✅ 产品来源 = "自制"（非空）
     ✅ 提交人 = "张三"（非"admin"）
   ```

---

## 📊 修复影响范围

### 影响模块

| 模块 | 文件 | 修改类型 | 影响 |
|-----|------|---------|------|
| 销售订单新增 | `SalesOrderCreate.vue` | 🔧 字段映射 | 保存时添加productSource |
| 销售订单列表 | `SalesOrderListNew.vue` | 🔧 字段映射 | 加载时映射productSource（3处）|
| 确认下单API | `salesOrders.js` | 🔧 字段映射 | 推送时添加4个字段 |

### 数据库表

| 表名 | 字段 | 说明 |
|-----|------|------|
| `sales_order_products` | `product_source` | 已存在，修复映射 |
| `master_production_plans` | `salesperson` | 已存在，新增映射 |
| `master_production_plans` | `sales_unit` | 已存在，新增映射 |
| `master_production_plans` | `product_source` | 已存在，新增映射 |
| `master_production_plans` | `submitter` | 已存在，修改逻辑 |

### 向后兼容性

- ✅ **完全兼容**：所有修改都是添加缺失的映射，不破坏现有逻辑
- ✅ **数据安全**：使用 `|| ''` 或 `|| 'admin'` 提供默认值
- ✅ **不影响历史数据**：只影响新创建的记录

---

## 📝 技术要点总结

### 1. 字段命名规范
- **前端（Vue）**：驼峰命名（camelCase）
  - `productSource`, `productUnit`, `salesperson`
- **后端（数据库）**：下划线命名（snake_case）
  - `product_source`, `product_unit`, `salesperson`

### 2. 映射兼容性处理
```javascript
// 兼容多种命名格式和空值
productSource: p.product_source || p.productSource || ''
```

### 3. Lookup机制
```javascript
// 从产品手册lookup产品来源
const lookupProductSource = async (row) => {
  const matchedProduct = productList.find(p => p.product_code === row.productCode)
  if (matchedProduct) {
    let source = matchedProduct.source || ''
    // 解析JSON: ["自制"] → "自制"
    if (source.startsWith('[')) {
      source = JSON.parse(source)[0]
    }
    row.productSource = source
  }
}
```

### 4. SQL参数化查询
```javascript
// 使用参数化查询防止SQL注入
await connection.execute(`
  INSERT INTO master_production_plans (
    plan_code, salesperson, sales_unit, product_source
  ) VALUES (?, ?, ?, ?)
`, [
  planCode,
  order.salesperson || '',
  product.product_unit || '',
  product.product_source || ''
])
```

---

## ✅ 修复完成检查清单

### 产品来源字段映射
- [x] 前端保存时映射产品来源（SalesOrderCreate.vue）
- [x] 列表加载JSON格式时映射（SalesOrderListNew.vue）
- [x] 列表加载数组格式时映射（SalesOrderListNew.vue）
- [x] 列表加载单个产品时映射（SalesOrderListNew.vue）
- [x] 后端数据库插入包含字段（salesOrders.js）
- [x] 后端查询返回包含字段（salesOrders.js）

### 主生产计划字段映射
- [x] 添加 salesperson 字段映射
- [x] 添加 sales_unit 字段映射
- [x] 添加 product_source 字段映射
- [x] 修改 submitter 字段逻辑（使用销售员）
- [x] 增强返回数据（包含新字段）
- [x] 验证数据库表结构支持

### 文档与测试
- [x] 创建产品来源修复报告
- [x] 创建主生产计划修复报告
- [x] 创建总结报告（本文档）
- [x] 编写详细测试步骤
- [ ] 用户验证测试（待执行）

---

## 🎉 预期效果

### 修复前 ❌

**销售订单列表**：
- 产品来源列：（空）

**主生产计划**：
- 销售员：（空）
- 销售单位：（空）
- 产品来源：（空）
- 提交人：admin

### 修复后 ✅

**销售订单列表**：
- 产品来源列：自制 / 外购

**主生产计划**：
- 销售员：张三
- 销售单位：个
- 产品来源：自制
- 提交人：张三

---

## 📚 相关文档

1. **产品来源字段修复详细报告**
   - 📄 `✅产品来源字段映射修复完成报告.md`
   - 包含：Lookup逻辑、数据流、测试步骤

2. **主生产计划字段修复详细报告**
   - 📄 `✅销售订单推送主生产计划字段映射修复完成报告.md`
   - 包含：字段对照表、代码对比、完整测试流程

3. **本总结报告**
   - 📄 `🎯字段映射问题修复总结.md`
   - 包含：修复概览、影响范围、检查清单

---

**修复时间**：2025-12-19  
**修复内容**：销售订单字段映射（产品来源 + 主生产计划推送）  
**修复文件**：3个文件（2个前端 + 1个后端）  
**影响模块**：销售订单、主生产计划  
**测试状态**：✅ 代码修复完成，⏳ 待用户验证  
**兼容性**：✅ 向后兼容，不影响历史数据
