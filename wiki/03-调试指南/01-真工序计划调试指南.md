# 真工序计划调试指南

## 🎯 适用场景

当出现以下问题时使用本指南：
- ✅ 计划开始日期未按规则生成
- ✅ 计划结束日期为null
- ✅ 需求工时计算错误
- ✅ 日期字段不更新

## 📋 问题：计划开始日期未按规则生成

### 问题特征

**预期结果**：计划开始日期 = 2025-12-31  
**实际结果**：计划开始日期为null或其他日期

### 完整排查流程

#### 第一步：确认业务规则

1. **打开Wiki文档**，确认规则定义：
   - 文档路径：`wiki/01-数据流规则/03-真工序计划计算规则.md`
   - 阅读"计划开始日期"章节
   - 确认计算逻辑：从计划结束日期向前累加剩余工时

2. **确认输入参数**：
   - 工序名称：是什么？
   - 计划结束日期：是多少？
   - 需求工时：是多少？
   - 剩余工时门槛值：默认0.5

#### 第二步：使用浏览器开发者工具

1. **打开浏览器控制台**：
   - 按 `F12` 或 `Ctrl+Shift+I`（Windows/Linux）
   - 按 `Cmd+Option+I`（Mac）

2. **查看Console输出**：
   ```javascript
   // 应该能看到以下日志：
   🔍 查询计划结束日期: {requiredWorkHours, processName, completionDate, minRemainingHours}
   ✅ 计划结束日期查询成功: 2026-01-06, 剩余工时: 8.0
   🔍 查询计划开始日期: {requiredWorkHours, processName, planEndDate, minRemainingHours}
   ```

3. **检查关键日志**：
   - ✅ 如果看到 "✅ 计划开始日期查询成功" → 前端调用成功
   - ⚠️ 如果看到 "⚠️ 未找到符合条件的计划开始日期" → 后端查询无结果
   - ❗ 如果看到 "❗ 查询计划开始日期失败" → API调用失败

#### 第三步：使用浏览器断点调试（重要）

1. **在浏览器中打开Sources面板**：
   - 找到文件：`src/pages/production-planning/RealProcessPlanList.vue`
   - 搜索函数：`queryPlanStartDate`

2. **设置断点**：
   - 在第509行（API调用前）设置断点
   - 在第516行（响应处理）设置断点

3. **触发断点**：
   - 在页面中编辑一条记录
   - 修改需求工时或计划完工日期
   - 程序会在断点处暂停

4. **检查变量值**：
   ```javascript
   // 在断点处查看：
   processName         // 应该是字符串，如"焊接"
   formatDateYMD(planEndDate)  // 应该是"2026-01-06"格式
   requiredWorkHours   // 应该是数字，如10.5
   minRemainingHours   // 应该是0.5
   ```

5. **单步执行**：
   - 按 `F10` 单步执行
   - 查看 `response` 对象的值
   - 确认 `response.planStartDate` 是否存在

#### 第四步：检查后端日志

1. **查看后端日志文件**：
   ```bash
   tail -f ~/ai_workspaces/ai_desktop_3/backend.log
   ```

2. **触发API调用**：
   - 在前端页面操作
   - 观察后端日志输出

3. **关键日志**：
   ```
   📡 接收到计划开始日期POST请求
   🔍 查询计划开始日期参数: {processName, planEndDate, requiredWorkHours, minRemainingHours}
   📊 日期范围: 2025-12-11 到 2026-01-06
   🔍 SQL: SELECT date, remaining_hours FROM process_capacity_load WHERE...
   📊 查询结果: 找到X条符合条件的记录
   🔍 开始累加计算，需求工时: 10.5
     日期: 2026-01-06, 剩余工时: 8.0, 累计: 8.00
     日期: 2026-01-05, 剩余工时: 7.5, 累计: 15.50
   ✅ 找到开始日期: 2026-01-05, 累计工时: 15.50
   ```

4. **诊断信息**（如果找不到记录）：
   ```
   🔍 诊断信息: 工序能力负荷表中工序"焊接"共有X条记录
      日期范围: 2025-12-01 至 2026-01-31
      其中剩余工时>=0.5的记录: X条
      最近的符合条件的日期: 2026-01-06 (剩余工时=8.0)
   ```

#### 第五步：检查工序能力负荷表数据

1. **使用Quest功能**（推荐）：
   - 在QODER IDE左侧点击"Quest"图标
   - 创建查询任务："查询工序能力负荷表，工序名称=焊接，日期范围2025-12-01到2026-01-06"

2. **直接查询数据库**：
   ```sql
   SELECT 
     process_name,
     date,
     remaining_hours,
     occupied_hours,
     work_shift,
     available_workstations
   FROM process_capacity_load
   WHERE process_name = '焊接'
     AND date BETWEEN '2025-12-01' AND '2026-01-06'
   ORDER BY date DESC;
   ```

3. **检查数据完整性**：
   - ✅ 确认工序名称完全匹配（注意空格）
   - ✅ 确认日期范围覆盖预期日期
   - ✅ 确认剩余工时 >= 0.5
   - ✅ 计算累加工时是否满足需求工时

4. **手动验证计算逻辑**：
   ```
   假设需求工时 = 10.5
   
   2026-01-06: 剩余工时 8.0   → 累计 = 8.0   (< 10.5，继续)
   2026-01-05: 剩余工时 7.5   → 累计 = 15.5  (>= 10.5，停止)
   
   预期计划开始日期 = 2026-01-05
   ```

#### 第六步：检查业务变量配置

1. **查看页面设置**：
   - 打开真工序计划页面
   - 点击页面右上角"设置"图标
   - 查看"业务变量" → "剩余工时小于"

2. **确认配置值**：
   - 默认值应为 `0.5`
   - 如果值过大，可能导致找不到符合条件的记录

3. **调整配置**（如需要）：
   - 修改为合适的值
   - 保存配置
   - 重新触发计算

#### 第七步：常见问题排查

##### 问题1：计划结束日期为null

**症状**：
```javascript
formData.value.planEndDate = null
```

**排查**：
1. 检查需求工时是否 > 0
2. 检查工序名称是否存在
3. 检查计划完工日期是否有效
4. 检查工序能力负荷表是否有该工序的数据

**解决方案**：
- 确保工序能力负荷表已加载该工序
- 确保日期范围内有剩余工时 >= 0.5 的记录

##### 问题2：API响应为null但数据库有数据

**症状**：
```javascript
console.log(response.planStartDate)  // null
```

**排查**：
1. 检查后端SQL查询日期范围是否正确
2. 检查日期格式是否一致（YYYY-MM-DD）
3. 检查剩余工时条件（`remaining_hours > ?`）

**常见原因**：
- 日期格式不匹配（ISO格式 vs 本地格式）
- 剩余工时比较使用了错误的运算符（`>` vs `>=`）

**解决方案**：
```javascript
// 检查日期格式化函数
const formatDateYMD = (date) => {
  if (!date) return ''
  if (typeof date === 'string') return date
  const d = new Date(date)
  const year = d.getFullYear()
  const month = String(d.getMonth() + 1).padStart(2, '0')
  const day = String(d.getDate()).padStart(2, '0')
  return `${year}-${month}-${day}`
}
```

##### 问题3：累加工时不足

**症状**：
```
⚠️ 累计工时不足，无法确定开始日期
accumulatedHours: 8.5 (需求工时: 10.5)
```

**原因**：
- 工序能力负荷表中剩余工时总和 < 需求工时

**解决方案**：
1. 检查工序能力负荷表数据是否完整
2. 确认是否需要扩大日期范围
3. 考虑是否需要增加工位数量
4. 检查已占用工时是否正确

#### 第八步：使用Quest创建调试任务

1. **打开Quest面板**：
   - 在QODER IDE左侧点击"Quest"图标

2. **创建调试任务**：
   ```
   任务：调试真工序计划开始日期计算问题
   
   步骤：
   1. 查询工序能力负荷表，工序="焊接"
   2. 检查剩余工时数据
   3. 验证累加计算逻辑
   4. 对比预期结果
   ```

3. **记录调试结果**：
   - 在Quest任务中记录每一步的发现
   - 标记问题根源
   - 记录解决方案

### 完整诊断脚本

将以下脚本粘贴到浏览器Console中运行：

```javascript
// ============ 真工序计划诊断脚本 ============
(async function diagnose() {
  console.log('🔍 开始诊断真工序计划问题...\n')
  
  // 1. 检查当前表单数据
  console.log('📋 第一步：检查表单数据')
  console.log('formData:', {
    processName: formData.value?.processName,
    completionDate: formData.value?.completionDate,
    requiredWorkHours: formData.value?.requiredWorkHours,
    planEndDate: formData.value?.planEndDate,
    planStartDate: formData.value?.planStartDate
  })
  console.log('')
  
  // 2. 手动调用计划结束日期查询
  console.log('📋 第二步：手动查询计划结束日期')
  try {
    const endDateResponse = await capacityLoadApi.queryPlanEndDate(
      formData.value.processName,
      formatDateYMD(formData.value.completionDate),
      0.5
    )
    console.log('✅ 计划结束日期查询成功:', endDateResponse.data)
  } catch (error) {
    console.error('❌ 计划结束日期查询失败:', error)
  }
  console.log('')
  
  // 3. 手动调用计划开始日期查询
  console.log('📋 第三步：手动查询计划开始日期')
  if (formData.value.planEndDate) {
    try {
      const startDateResponse = await capacityLoadApi.queryPlanStartDate(
        formData.value.processName,
        formatDateYMD(formData.value.planEndDate),
        formData.value.requiredWorkHours,
        0.5
      )
      console.log('✅ 计划开始日期查询成功:', startDateResponse)
    } catch (error) {
      console.error('❌ 计划开始日期查询失败:', error)
    }
  } else {
    console.warn('⚠️ 计划结束日期为null，无法查询计划开始日期')
  }
  console.log('')
  
  console.log('🎉 诊断完成！请查看上述输出结果。')
})()
```

### 预期日志输出示例

```
🔍 开始诊断真工序计划问题...

📋 第一步：检查表单数据
formData: {
  processName: "焊接",
  completionDate: "2026-01-06",
  requiredWorkHours: 10.5,
  planEndDate: "2026-01-06",
  planStartDate: null
}

📋 第二步：手动查询计划结束日期
✅ 计划结束日期查询成功: {
  planEndDate: "2026-01-06",
  remainingHours: 8.0
}

📋 第三步：手动查询计划开始日期
✅ 计划开始日期查询成功: {
  planStartDate: "2025-12-31",
  accumulatedHours: 12.5
}

🎉 诊断完成！请查看上述输出结果。
```

## 🚀 快速检查清单

在开始详细排查前，先完成这个快速检查清单：

- [ ] 打开浏览器开发者工具（F12）
- [ ] 查看Console是否有错误日志
- [ ] 检查需求工时 > 0
- [ ] 检查工序名称不为空
- [ ] 检查计划完工日期有效
- [ ] 检查计划结束日期是否已生成
- [ ] 查看后端日志（`tail -f backend.log`）
- [ ] 确认工序能力负荷表有数据
- [ ] 确认剩余工时 >= 0.5

## 📝 调试结果记录模板

```markdown
## 调试记录

**问题描述**：计划开始日期未按规则生成

**输入参数**：
- 工序名称：焊接
- 计划完工日期：2026-01-06
- 需求工时：10.5
- 计划结束日期：2026-01-06

**预期结果**：2025-12-31

**实际结果**：null

**排查步骤**：
1. [x] 检查前端日志 - 发现...
2. [x] 检查后端日志 - 发现...
3. [x] 检查数据库数据 - 发现...

**问题根源**：
（记录问题的根本原因）

**解决方案**：
（记录采取的解决措施）

**验证结果**：
（记录修复后的测试结果）
```

---

**最后更新**：2025-12-11  
**维护者**：开发团队  
**关联文档**：
- [真工序计划计算规则](../01-数据流规则/03-真工序计划计算规则.md)
- [真工序计划字段映射](../02-字段映射关系/01-真工序计划字段映射.md)
- [使用浏览器断点调试](./02-使用浏览器断点调试.md)
