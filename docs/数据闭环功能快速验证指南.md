# 数据闭环功能快速验证指南

## 🎯 功能说明

**实现需求**：当真工序计划推送到备料计划成功时，立即触发"备料计划推送到真工序计划的规则"。

**数据流向**：
```
真工序计划 → 备料计划 → 真工序计划（闭环）
```

---

## ⚡ 快速验证（3步）

### 步骤1：运行测试脚本

```bash
cd /home/sardenesy/ai_workspaces/ai_desktop_3/backend
node test-data-loop-trigger.js
```

### 步骤2：检查输出日志

**成功标志**：
```
🎉 测试成功！数据闭环功能正常工作！
   ✅ 真工序计划 → 备料计划 → 真工序计划 数据流完整
   ✅ 防重复推送机制正常工作
```

### 步骤3：验证数据库

```sql
-- 查询测试生成的真工序计划
SELECT id, plan_no, product_code, schedule_quantity, source_no
FROM real_process_plans
WHERE plan_no LIKE 'TEST-LOOP-RPP-%'
ORDER BY created_at DESC;

-- 查询推送到的备料计划
SELECT id, plan_no, material_code, material_source, replenishment_quantity, source_process_plan_no
FROM material_preparation_plans
WHERE source_process_plan_no LIKE 'TEST-LOOP-RPP-%'
ORDER BY created_at DESC;

-- 查询闭环生成的真工序计划（通过备料计划来源）
SELECT rpp.id, rpp.plan_no, rpp.source_no, rpp.product_code, rpp.schedule_quantity
FROM real_process_plans rpp
INNER JOIN material_preparation_plans mpp ON rpp.source_no = mpp.plan_no
WHERE mpp.source_process_plan_no LIKE 'TEST-LOOP-RPP-%'
ORDER BY rpp.created_at DESC;
```

---

## 🔍 日志关键标识

### ✅ 推送成功
```
✅ 自动推送到备料计划成功
🔄 [数据闭环] 触发备料计划推送到真工序计划规则...
✅ 备料计划 MPP... 推送到真工序计划成功
✅ [数据闭环] 备料计划推送规则触发完成
```

### ⏭️ 防重复跳过
```
⏭️ 检测到重复推送，跳过: MPP... → RPP... (已存在)
```

### ⏭️ 不满足条件
```
⏭️ 物料来源非"自制"(采购)，跳过推送
⏭️ 需补货数量≤0(0)，跳过推送
```

---

## 📊 预期结果

**假设场景**：
- 真工序计划产品：`6001A0306`
- BOM包含5个子件：3个自制 + 2个采购
- 3个自制子件需补货数量都>0

**预期数据流**：
```
步骤1: 创建1条真工序计划 (TEST-LOOP-RPP-xxx)
  ↓
步骤2: 推送生成5条备料计划 (MPP-xxx-001 ~ MPP-xxx-005)
  ↓
步骤3: 闭环生成3条真工序计划 (RPP-xxx-001 ~ RPP-xxx-003)
       (仅自制且需补货数量>0的3个子件)
```

**数据验证**：
- 真工序计划总数：1 + 3 = 4条
- 备料计划总数：5条
- 闭环生成：3条（物料来源=自制 && 需补货数量>0）

---

## 🧹 清理测试数据

```sql
-- 删除测试生成的真工序计划
DELETE FROM real_process_plans 
WHERE plan_no LIKE 'TEST-LOOP-RPP-%' 
   OR source_no IN (
     SELECT plan_no FROM material_preparation_plans 
     WHERE source_process_plan_no LIKE 'TEST-LOOP-RPP-%'
   );

-- 删除测试生成的备料计划
DELETE FROM material_preparation_plans 
WHERE source_process_plan_no LIKE 'TEST-LOOP-RPP-%';
```

---

## ⚠️ 常见问题

### Q1: 测试脚本显示"未找到任何备料计划记录"

**原因**：真工序计划的BOM编号不存在或没有子件

**解决方案**：
1. 检查测试数据中的`bomNo: 'BOM-6001A0306'`
2. 确认数据库中存在对应的BOM记录：
   ```sql
   SELECT * FROM list_style_production_boms WHERE bom_code = 'BOM-6001A0306';
   SELECT * FROM list_style_bom_children WHERE parent_id = (
     SELECT id FROM list_style_production_boms WHERE bom_code = 'BOM-6001A0306' LIMIT 1
   );
   ```

### Q2: 测试脚本显示"未生成真工序计划"

**原因**：备料计划不满足推送条件

**检查条件**：
- 物料来源 = '自制' ✅
- 需补货数量 > 0 ✅

**解决方案**：
1. 检查BOM子件的`component_source`字段（应该有部分为"自制"）
2. 检查备料计划的`replenishment_quantity`字段（应该>0）

### Q3: 第二次运行测试全部跳过

**这是正常的**！

- 第一次运行：成功生成数据
- 第二次运行：防重复推送机制生效，全部跳过

**验证防重复**：
```sql
SELECT id, plan_no, source_no, product_code 
FROM real_process_plans 
WHERE source_no LIKE 'MPP%';
-- 应该只有一条记录（source_no + product_code唯一）
```

---

## 📝 手动验证步骤

### 1. 通过前端页面验证

**步骤**：
1. 访问真工序计划页面：`http://localhost:3003/process-planning/real-process-plan`
2. 创建一条真工序计划（计划排程数量>0）
3. 等待2-3秒
4. 访问备料计划页面：`http://localhost:3003/production-planning/material-preparation-new`
5. 查看是否生成了新的备料计划
6. 返回真工序计划页面
7. 查看是否生成了新的真工序计划（来源编号=备料计划编号）

### 2. 通过浏览器控制台验证

**打开控制台（F12）→ Console**

**检查日志输出**：
```
✅ 自动推送到备料计划成功
🔄 [数据闭环] 触发备料计划推送到真工序计划规则...
✅ 备料计划 MPP... 推送到真工序计划成功
✅ [数据闭环] 备料计划推送规则触发完成
```

---

## ✅ 验证清单

- [ ] 测试脚本运行成功
- [ ] 日志显示"数据闭环功能正常工作"
- [ ] 数据库查询验证数据完整性
- [ ] 防重复推送机制正常工作
- [ ] 不满足条件的记录被正确跳过
- [ ] 前端页面数据显示正确
- [ ] 浏览器控制台日志正常

---

**验证完成时间**：____________  
**验证人员**：____________  
**验证结果**：□ 通过  □ 失败（原因：_____________）
