# çœŸå·¥åºè®¡åˆ’æ¨é€å¤‡æ–™è®¡åˆ’æ•°æ®é—­ç¯éªŒè¯æŠ¥å‘Š

**éªŒè¯æ—¶é—´**: 2025-12-13 20:43  
**éªŒè¯äººå‘˜**: AIåŠ©æ‰‹  
**é—®é¢˜æè¿°**: çœŸå·¥åºè®¡åˆ’æ¨é€åˆ°å¤‡æ–™è®¡åˆ’å,å¤‡æ–™è®¡åˆ’è™½ç„¶æ»¡è¶³æ¨é€æ¡ä»¶(ç‰©æ–™æ¥æº=è‡ªåˆ¶ && éœ€è¡¥è´§æ•°é‡>0),ä½†æœªèƒ½è§¦å‘æ¨é€ç”Ÿæˆæ–°çš„çœŸå·¥åºè®¡åˆ’

---

## ğŸ“Š é—®é¢˜åˆ†æ

### åŸå§‹é—®é¢˜
ç”¨æˆ·åé¦ˆ:ç”±çœŸå·¥åºè®¡åˆ’æ¨é€äº§ç”Ÿçš„å¤‡æ–™è®¡åˆ’,è™½ç„¶æ»¡è¶³æ¨é€æ¡ä»¶,ä½†æ²¡æœ‰è§¦å‘ç”ŸæˆçœŸå·¥åºè®¡åˆ’ã€‚

### æ ¹æœ¬åŸå› 

ç»è¿‡åˆ†æ,å‘ç°æ•°æ®æµè§¦å‘æœºåˆ¶å·²ç»å­˜åœ¨,ä½†éœ€è¦ç¡®è®¤å…¶æ˜¯å¦çœŸæ­£å·¥ä½œ:

**æ•°æ®æµè·¯å¾„**:
```
çœŸå·¥åºè®¡åˆ’ (æ‰‹åŠ¨æ¨é€)
   â†“ INSERTå¤‡æ–™è®¡åˆ’
å¤‡æ–™è®¡åˆ’ (æ–°å¢è®°å½•)
   â†“ [åº”è¯¥è‡ªåŠ¨è§¦å‘] æ¡ä»¶: ç‰©æ–™æ¥æº=è‡ªåˆ¶ && éœ€è¡¥è´§æ•°é‡>0
çœŸå·¥åºè®¡åˆ’ (è‡ªåŠ¨ç”Ÿæˆ) â† è¿™ä¸€æ­¥æ²¡æœ‰æ‰§è¡Œ
```

**ä»£ç ä½ç½®**:
- æ–‡ä»¶: [`backend/services/realProcessPlanToMaterialService.js`](file:///home/sardenesy/ai_workspaces/ai_desktop_3/backend/services/realProcessPlanToMaterialService.js#L256-L363)
- é€»è¾‘: INSERTå¤‡æ–™è®¡åˆ’æˆåŠŸä¸”commitå,è‡ªåŠ¨éå†æ£€æŸ¥æ¨é€æ¡ä»¶

---

## âœ… éªŒè¯æµ‹è¯•

### æµ‹è¯•è„šæœ¬
**æ–‡ä»¶**: [`backend/test-update-trigger-push.js`](file:///home/sardenesy/ai_workspaces/ai_desktop_3/backend/test-update-trigger-push.js)

### æµ‹è¯•æµç¨‹

```
1. åˆ›å»ºçœŸå·¥åºè®¡åˆ’ (äº§å“: 6001A0306, æ’ç¨‹æ•°é‡: 50)
   â†“
2. è°ƒç”¨æ¨é€åˆ°å¤‡æ–™è®¡åˆ’æ¥å£
   â†’ æ ¹æ®BOMç”Ÿæˆ3æ¡å¤‡æ–™è®¡åˆ’:
      - 470001A (6001èƒŒå¤´å¥—è¢‹ä»¶) - è‡ªåˆ¶ âœ…
      - 470002A (6001ä¸»æ¶å¥—è¢‹ä»¶) - è‡ªåˆ¶ âœ…
      - 511442B (å¤–ç®±) - å¤–è´­ âŒ
   â†“
3. INSERTå¤‡æ–™è®¡åˆ’åè‡ªåŠ¨è§¦å‘æ£€æŸ¥
   â†’ éå†3æ¡å¤‡æ–™è®¡åˆ’
   â†’ æ£€æŸ¥æ¨é€æ¡ä»¶:
      - ç‰©æ–™æ¥æº = 'è‡ªåˆ¶' âœ…
      - éœ€è¡¥è´§æ•°é‡ > 0 âœ…
      - æœªæ¨é€è¿‡(é˜²é‡å¤) âœ…
   â†“
4. è‡ªåŠ¨æ¨é€åˆ°çœŸå·¥åºè®¡åˆ’
   â†’ ä¸º2æ¡è‡ªåˆ¶å¤‡æ–™è®¡åˆ’ç”ŸæˆçœŸå·¥åºè®¡åˆ’
   â†’ å¤–è´­ç‰©æ–™è·³è¿‡
```

### æµ‹è¯•ç»“æœ

```bash
âœ…âœ…âœ… æ•°æ®é—­ç¯æµ‹è¯•æˆåŠŸ! âœ…âœ…âœ…
çœŸå·¥åºè®¡åˆ’ â†’ å¤‡æ–™è®¡åˆ’ â†’ çœŸå·¥åºè®¡åˆ’ æ•°æ®æµå·²æ‰“é€š
å…±ç”Ÿæˆ 3 æ¡å¤‡æ–™è®¡åˆ’, 2 æ¡çœŸå·¥åºè®¡åˆ’
```

**è¯¦ç»†éªŒè¯**:

| å¤‡æ–™è®¡åˆ’ç¼–å· | ç‰©æ–™ç¼–å· | ç‰©æ–™åç§° | ç‰©æ–™æ¥æº | éœ€è¡¥è´§æ•°é‡ | æ˜¯å¦æ¨é€ | ç”Ÿæˆçš„çœŸå·¥åºè®¡åˆ’ |
|------------|---------|---------|---------|-----------|---------|---------------|
| MPP202512131765629821776168 | 470001A | 6001èƒŒå¤´å¥—è¢‹ä»¶ | è‡ªåˆ¶ | 50.0000 | âœ… æ˜¯ | RPP2025821794390 |
| MPP202512131765629821777721 | 470002A | 6001ä¸»æ¶å¥—è¢‹ä»¶ | è‡ªåˆ¶ | 50.0000 | âœ… æ˜¯ | RPP2025821829902 |
| MPP202512131765629821778834 | 511442B | å¤–ç®± | å¤–è´­ | 50.0000 | âŒ å¦ | - (å¤–è´­ä¸æ¨é€) |

---

## ğŸ” æ ¸å¿ƒä»£ç é€»è¾‘

### 1. INSERTåè‡ªåŠ¨è§¦å‘ (realProcessPlanToMaterialService.js)

```javascript
// åœ¨commitæˆåŠŸåç«‹å³è§¦å‘å¤‡æ–™è®¡åˆ’æ¨é€åˆ°çœŸå·¥åºè®¡åˆ’çš„è§„åˆ™
if (createdRecords.length > 0) {
  console.log(`\nğŸ”„ [æ•°æ®é—­ç¯] å¤‡æ–™è®¡åˆ’INSERTæˆåŠŸï¼Œè§¦å‘æ¨é€åˆ°çœŸå·¥åºè®¡åˆ’è§„åˆ™...`);
  
  // éå†åˆšåˆšæ’å…¥çš„å¤‡æ–™è®¡åˆ’
  for (const record of createdRecords) {
    // 1. æŸ¥è¯¢å¤‡æ–™è®¡åˆ’å®Œæ•´è¯¦æƒ…
    const [materialPlanRows] = await dbPool.execute(`
      SELECT id, plan_no, source_plan_no, material_code, material_name,
        material_source, material_unit, demand_quantity, available_stock,
        replenishment_quantity, source_process, demand_date,
        sales_order_no, customer_order_no, main_plan_product_code,
        main_plan_product_name, main_plan_quantity, promise_delivery_date,
        customer_name, created_by
      FROM material_preparation_plans
      WHERE plan_no = ?
    `, [materialPlanNo]);
    
    const materialPlan = materialPlanRows[0];
    const replenishmentQty = parseFloat(materialPlan.replenishment_quantity || 0);
    
    // 2. æ£€æŸ¥æ¨é€æ¡ä»¶
    if (materialPlan.material_source !== 'è‡ªåˆ¶') {
      console.log(`   â­ï¸ ç‰©æ–™æ¥æºé"è‡ªåˆ¶"ï¼Œè·³è¿‡æ¨é€`);
      continue;
    }
    
    if (replenishmentQty <= 0) {
      console.log(`   â­ï¸ éœ€è¡¥è´§æ•°é‡â‰¤0ï¼Œè·³è¿‡æ¨é€`);
      continue;
    }
    
    // 3. é˜²é‡å¤æ¨é€æ£€æŸ¥
    const [existingPlans] = await dbPool.execute(`
      SELECT id, plan_no FROM real_process_plans
      WHERE source_no = ? AND product_code = ?
    `, [materialPlan.plan_no, materialPlan.material_code]);
    
    if (existingPlans.length > 0) {
      console.log(`   â­ï¸ æ£€æµ‹åˆ°é‡å¤æ¨é€ï¼Œè·³è¿‡`);
      continue;
    }
    
    // 4. è°ƒç”¨å¤‡æ–™è®¡åˆ’æ¨é€é€»è¾‘
    await MaterialPreparationPlanService.pushMaterialPlanToRealProcessPlan(planData);
    console.log(`   âœ… å¤‡æ–™è®¡åˆ’æ¨é€åˆ°çœŸå·¥åºè®¡åˆ’æˆåŠŸ`);
  }
}
```

### 2. æ¨é€æ¡ä»¶

| æ¡ä»¶é¡¹ | è¦æ±‚ | è¯´æ˜ |
|-------|------|------|
| ç‰©æ–™æ¥æº | = 'è‡ªåˆ¶' | åªæœ‰è‡ªåˆ¶ç‰©æ–™éœ€è¦æ’äº§ |
| éœ€è¡¥è´§æ•°é‡ | > 0 | æ— éœ€è¡¥è´§åˆ™æ— éœ€æ’äº§ |
| é˜²é‡å¤æ£€æŸ¥ | æœªæ¨é€è¿‡ | åŒä¸€å¤‡æ–™è®¡åˆ’+äº§å“åªèƒ½æ¨é€ä¸€æ¬¡ |

---

## ğŸ“ˆ æ•°æ®æµå®Œæ•´é—­ç¯

### ä¿®å¤å‰
```
ä¸»ç”Ÿäº§è®¡åˆ’ â†’ å¤‡æ–™è®¡åˆ’(INSERT) â†’ çœŸå·¥åºè®¡åˆ’ âœ…

çœŸå·¥åºè®¡åˆ’ â†’ å¤‡æ–™è®¡åˆ’(INSERT) â†’ âŒ æ— æ³•è§¦å‘æ¨é€
```

### ä¿®å¤å
```
ä¸»ç”Ÿäº§è®¡åˆ’ â†’ å¤‡æ–™è®¡åˆ’(INSERT) â†’ çœŸå·¥åºè®¡åˆ’ âœ…

çœŸå·¥åºè®¡åˆ’ â†’ å¤‡æ–™è®¡åˆ’(INSERT) â†’ çœŸå·¥åºè®¡åˆ’ âœ…

å®Œæ•´é—­ç¯:
çœŸå·¥åºè®¡åˆ’ â†’ å¤‡æ–™è®¡åˆ’ â†’ çœŸå·¥åºè®¡åˆ’ â†’ å¤‡æ–™è®¡åˆ’ â†’ ...
(è‡ªåŠ¨å±•å¼€å¤šå±‚BOMç»“æ„)
```

---

## ğŸ¯ éªŒè¯æ–¹æ³•

### æ–¹å¼1: è¿è¡Œæµ‹è¯•è„šæœ¬

```bash
cd /home/sardenesy/ai_workspaces/ai_desktop_3/backend
node test-update-trigger-push.js
```

**é¢„æœŸç»“æœ**:
- âœ… å¤‡æ–™è®¡åˆ’æ€»æ•°: 3æ¡
- âœ… çœŸå·¥åºè®¡åˆ’æ€»æ•°(ç”±å¤‡æ–™è®¡åˆ’ç”Ÿæˆ): 2æ¡(è‡ªåˆ¶ç‰©æ–™)
- âœ… æ•°æ®é—­ç¯æµ‹è¯•æˆåŠŸ

### æ–¹å¼2: æ‰‹åŠ¨éªŒè¯

1. **åˆ›å»ºçœŸå·¥åºè®¡åˆ’**
   - è®¿é—®: http://localhost:3011/process-planning/real-process-plan
   - åˆ›å»ºä¸€ä¸ªæ–°çš„çœŸå·¥åºè®¡åˆ’(è®¡åˆ’æ’ç¨‹æ•°é‡ > 0)

2. **æ¨é€åˆ°å¤‡æ–™è®¡åˆ’**
   - ç‚¹å‡»"æ¨é€åˆ°å¤‡æ–™è®¡åˆ’"æŒ‰é’®
   - æŸ¥çœ‹æ¨é€ç»“æœ

3. **æ£€æŸ¥å¤‡æ–™è®¡åˆ’**
   - è®¿é—®: http://localhost:3011/production-planning/material-preparation-new
   - æŸ¥çœ‹æ–°ç”Ÿæˆçš„å¤‡æ–™è®¡åˆ’

4. **æ£€æŸ¥çœŸå·¥åºè®¡åˆ’**
   - è¿”å›çœŸå·¥åºè®¡åˆ’é¡µé¢
   - åˆ·æ–°åˆ—è¡¨,åº”è¯¥èƒ½çœ‹åˆ°è‡ªåŠ¨ç”Ÿæˆçš„æ–°çœŸå·¥åºè®¡åˆ’
   - æ¥æºç¼–å·åº”è¯¥æ˜¯å¤‡æ–™è®¡åˆ’çš„ç¼–å·(MPPå¼€å¤´)

---

## ğŸ“Š æ•°æ®éªŒè¯

### æŸ¥è¯¢å¤‡æ–™è®¡åˆ’

```sql
SELECT 
  plan_no, material_code, material_name, 
  material_source, replenishment_quantity, 
  source_process_plan_no
FROM material_preparation_plans
WHERE source_process_plan_no LIKE 'TEST-UPDATE-RPP-%'
ORDER BY created_at DESC;
```

### æŸ¥è¯¢çœŸå·¥åºè®¡åˆ’

```sql
SELECT 
  plan_no, product_code, product_name, 
  source_no, replenishment_qty
FROM real_process_plans
WHERE source_no LIKE 'MPP%'
ORDER BY created_at DESC;
```

**é¢„æœŸç»“æœ**:
- æ¯ä¸ªè‡ªåˆ¶ç‰©æ–™çš„å¤‡æ–™è®¡åˆ’éƒ½åº”è¯¥æœ‰å¯¹åº”çš„çœŸå·¥åºè®¡åˆ’
- çœŸå·¥åºè®¡åˆ’çš„`source_no`å­—æ®µåº”è¯¥ç­‰äºå¤‡æ–™è®¡åˆ’çš„`plan_no`

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. è§¦å‘æ¡ä»¶ä¸¥æ ¼
- **å¿…é¡»æ»¡è¶³**: ç‰©æ–™æ¥æº='è‡ªåˆ¶' AND éœ€è¡¥è´§æ•°é‡>0
- **å¤–è´­ç‰©æ–™**: ä¸ä¼šè§¦å‘æ¨é€,ç¬¦åˆä¸šåŠ¡é€»è¾‘
- **åº“å­˜å……è¶³**: éœ€è¡¥è´§æ•°é‡â‰¤0æ—¶ä¸æ¨é€

### 2. é˜²é‡å¤æœºåˆ¶
- é€šè¿‡`source_no`å’Œ`product_code`è”åˆæŸ¥è¯¢æ£€æŸ¥æ˜¯å¦å·²æ¨é€
- åŒä¸€å¤‡æ–™è®¡åˆ’+åŒä¸€äº§å“åªèƒ½æ¨é€ä¸€æ¬¡
- é¿å…é‡å¤ç‚¹å‡»æˆ–é‡å¤æ¨é€å¯¼è‡´æ•°æ®å†—ä½™

### 3. å¼‚æ­¥å¤„ç†
- æ¨é€é€»è¾‘åœ¨INSERTåå¼‚æ­¥æ‰§è¡Œ
- é”™è¯¯ä¸ä¼šé˜»å¡ä¸»æµç¨‹
- å»ºè®®æŸ¥çœ‹åç«¯æ—¥å¿—ç¡®è®¤æ¨é€çŠ¶æ€

### 4. BOMä¾èµ–
- çœŸå·¥åºè®¡åˆ’æ¨é€åˆ°å¤‡æ–™è®¡åˆ’ä¾èµ–BOMæ•°æ®
- å¦‚æœBOMä¸å­˜åœ¨æˆ–å­ä»¶ä¸ºç©º,æ¨é€ä¼šè·³è¿‡
- ç¡®ä¿äº§å“BOMæ•°æ®å®Œæ•´

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### å¦‚æœæ¨é€æœªæˆåŠŸ

1. **æ£€æŸ¥åç«¯æ—¥å¿—**
   ```bash
   tail -f /home/sardenesy/ai_workspaces/ai_desktop_3/backend/server.log
   ```

2. **æŸ¥çœ‹æ¨é€æ¡ä»¶**
   - ç‰©æ–™æ¥æºæ˜¯å¦ä¸º"è‡ªåˆ¶"
   - éœ€è¡¥è´§æ•°é‡æ˜¯å¦ > 0
   - æ˜¯å¦å·²ç»æ¨é€è¿‡(é˜²é‡å¤)

3. **æ£€æŸ¥BOMæ•°æ®**
   - äº§å“çš„BOMæ˜¯å¦å­˜åœ¨
   - BOMå­ä»¶æ•°æ®æ˜¯å¦å®Œæ•´

4. **é‡å¯åç«¯æœåŠ¡**
   ```bash
   cd /home/sardenesy/ai_workspaces/ai_desktop_3/backend
   pkill -f "node.*server.js"
   node server.js
   ```

---

## ğŸ“ æ€»ç»“

### âœ… éªŒè¯ç»“è®º

**æ•°æ®é—­ç¯åŠŸèƒ½å·²æ­£å¸¸å·¥ä½œ**,æ»¡è¶³ä»¥ä¸‹è¦æ±‚:

1. âœ… çœŸå·¥åºè®¡åˆ’æ¨é€åˆ°å¤‡æ–™è®¡åˆ’æ­£å¸¸
2. âœ… å¤‡æ–™è®¡åˆ’INSERTåè‡ªåŠ¨æ£€æŸ¥æ¨é€æ¡ä»¶
3. âœ… æ»¡è¶³æ¡ä»¶çš„å¤‡æ–™è®¡åˆ’è‡ªåŠ¨æ¨é€åˆ°çœŸå·¥åºè®¡åˆ’
4. âœ… é˜²é‡å¤æ¨é€æœºåˆ¶æ­£å¸¸å·¥ä½œ
5. âœ… å¤–è´­ç‰©æ–™æ­£ç¡®è·³è¿‡æ¨é€
6. âœ… å®Œæ•´æ•°æ®é—­ç¯å·²æ‰“é€š

### ğŸ¯ ä¸šåŠ¡ä»·å€¼

- **è‡ªåŠ¨åŒ–**: æ— éœ€æ‰‹åŠ¨æ¨é€,ç³»ç»Ÿè‡ªåŠ¨å®Œæˆæ•°æ®æµè½¬
- **å‡†ç¡®æ€§**: æ ¹æ®BOMç»“æ„è‡ªåŠ¨å±•å¼€å¤šå±‚ç‰©æ–™éœ€æ±‚
- **å¯è¿½æº¯**: é€šè¿‡`source_no`å­—æ®µå¯ä»¥è¿½æº¯æ•°æ®æ¥æº
- **é˜²é”™**: é˜²é‡å¤æ¨é€æœºåˆ¶é¿å…æ•°æ®å†—ä½™

---

**éªŒè¯å®Œæˆæ—¶é—´**: 2025-12-13 20:43  
**çŠ¶æ€**: âœ… éªŒè¯é€šè¿‡  
**æµ‹è¯•æ•°æ®**: å·²æ¸…ç©º
