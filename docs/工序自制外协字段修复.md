# 工序"自制/外协"字段显示和保存修复

## 修复时间
2025-12-08 16:50 - 17:00

## 问题描述

### 问题1: 查看页面看不到"自制/外协"字段
在工序查看详情对话框中，缺少"自制/外协"字段的显示。

### 问题2: 编辑页面保存后值未映射到主表格
在编辑页面的下拉框中选择"自制"或"外协"后，点击保存，值没有保存到数据库和主表格中。

---

## 根本原因

### 原因1: 查看对话框缺少字段
**文件**: `/07-frontend/src/pages/manufacturing/ProcessList.vue`
**位置**: 第243-259行（查看详情对话框）

查看对话框的 `<el-descriptions>` 组件中没有包含"自制/外协"字段。

### 原因2: 保存时缺少字段映射
**前端问题**: 保存函数 `handleSave` 中的 `requestData` 对象缺少 `self_or_outsource` 字段
**后端问题**: UPDATE接口的SQL语句和参数中缺少 `self_or_outsource` 字段

---

## 修复方案

### 修复1: 查看对话框添加字段显示

**文件**: `/07-frontend/src/pages/manufacturing/ProcessList.vue`
**位置**: 第247-254行

**添加内容**:
```vue
<el-descriptions-item label="自制/外协">
  <el-tag v-if="currentProcess.selfOrOutsource === '自制'" type="primary">自制</el-tag>
  <el-tag v-else-if="currentProcess.selfOrOutsource === '外协'" type="warning">外协</el-tag>
  <el-tag v-else type="info">未设置</el-tag>
</el-descriptions-item>
```

**显示效果**:
- 自制：蓝色"自制"标签
- 外协：黄色"外协"标签  
- 未设置：灰色"未设置"标签

---

### 修复2: 保存逻辑添加字段映射

#### 2.1 前端保存函数修复

**文件**: `/07-frontend/src/pages/manufacturing/ProcessList.vue`
**位置**: handleSave函数中的requestData对象

**修改前**:
```javascript
const requestData = {
  process_code: formData.value.processCode,
  process_name: formData.value.processName,
  responsible_person: formData.value.processPrincipal,
  dispatch_method: formData.value.dispatchMethod,
  is_warehousing: formData.value.isStorage ? 1 : 0,
  completion_warehouse: formData.value.completionWarehouse || '',
  workshop_name: formData.value.workshopName,
  process_wage: formData.value.processWage || 0
}
```

**修改后**:
```javascript
const requestData = {
  process_code: formData.value.processCode,
  process_name: formData.value.processName,
  responsible_person: formData.value.processPrincipal,
  dispatch_method: formData.value.dispatchMethod,
  self_or_outsource: formData.value.selfOrOutsource || null,  // ✅ 新增
  is_warehousing: formData.value.isStorage ? 1 : 0,
  completion_warehouse: formData.value.completionWarehouse || '',
  workshop_name: formData.value.workshopName,
  process_wage: formData.value.processWage || 0
}
```

---

#### 2.2 后端UPDATE接口修复

**文件**: `/backend/routes/processes.js`
**位置**: PUT /update/:id 接口（第166-183行）

**修改前**:
```javascript
const sql = `
  UPDATE processes SET
    process_code = ?, process_name = ?, responsible_person = ?, dispatch_method = ?,
    is_warehousing = ?, completion_warehouse = ?, workshop_name = ?, process_wage = ?
  WHERE id = ?
`;

const [result] = await pool.execute(sql, [
  processData.process_code || processData.processCode,
  processData.process_name || processData.processName,
  processData.responsible_person || processData.responsiblePerson,
  processData.dispatch_method || processData.dispatchMethod,
  processData.is_warehousing || processData.isWarehousing || 0,
  processData.completion_warehouse || processData.completionWarehouse || '',
  processData.workshop_name || processData.workshopName,
  processData.process_wage || processData.processWage || 0,
  id
]);
```

**修改后**:
```javascript
const sql = `
  UPDATE processes SET
    process_code = ?, process_name = ?, responsible_person = ?, dispatch_method = ?,
    self_or_outsource = ?, is_warehousing = ?, completion_warehouse = ?, workshop_name = ?, process_wage = ?
  WHERE id = ?
`;

const [result] = await pool.execute(sql, [
  processData.process_code || processData.processCode,
  processData.process_name || processData.processName,
  processData.responsible_person || processData.responsiblePerson,
  processData.dispatch_method || processData.dispatchMethod,
  processData.self_or_outsource || processData.selfOrOutsource || null,  // ✅ 新增
  processData.is_warehousing || processData.isWarehousing || 0,
  processData.completion_warehouse || processData.completionWarehouse || '',
  processData.workshop_name || processData.workshopName,
  processData.process_wage || processData.processWage || 0,
  id
]);
```

---

## 测试验证

### 测试场景1: 查看工序详情
1. 打开工序页面：`http://localhost:3002/manufacturing/process`
2. 点击任意工序的"查看"按钮
3. ✅ 验证：查看对话框中应该显示"自制/外协"字段及其值

### 测试场景2: 新增工序并选择"自制/外协"
1. 点击"新增工序"按钮
2. 填写工序信息，在"自制/外协"下拉框选择"自制"
3. 点击"保存"
4. ✅ 验证1：成功提示"工序创建成功"
5. ✅ 验证2：表格中新增的工序显示蓝色"自制"标签

### 测试场景3: 编辑工序修改"自制/外协"
1. 点击已有工序的"编辑"按钮
2. 将"自制/外协"从"自制"改为"外协"（或反向）
3. 点击"保存"
4. ✅ 验证1：成功提示"工序更新成功"
5. ✅ 验证2：表格中该工序的标签已更新为黄色"外协"

### 测试场景4: 查看修改后的工序
1. 点击刚才修改的工序的"查看"按钮
2. ✅ 验证：查看对话框中显示更新后的"自制/外协"值

---

## 修改文件清单

### 前端文件
- `/07-frontend/src/pages/manufacturing/ProcessList.vue`
  - 添加查看对话框中的"自制/外协"显示项
  - 在handleSave函数中添加 `self_or_outsource` 字段映射

### 后端文件
- `/backend/routes/processes.js`
  - 在UPDATE接口的SQL语句和参数中添加 `self_or_outsource` 字段

---

## 完成状态

✅ 查看对话框显示"自制/外协"字段
✅ 前端保存函数添加字段映射
✅ 后端UPDATE接口添加字段支持
✅ 后端服务已重启
✅ 全流程测试通过

---

## 数据流完整性验证

### 新增工序
1. 前端表单：`formData.selfOrOutsource` = "自制"
2. 保存请求：`requestData.self_or_outsource` = "自制"
3. 后端接收：`processData.self_or_outsource` = "自制"
4. 数据库写入：`self_or_outsource` = "自制"
5. 前端加载：`item.self_or_outsource` → `selfOrOutsource` = "自制"
6. 表格显示：蓝色"自制"标签 ✅
7. 查看对话框：蓝色"自制"标签 ✅

### 编辑工序
1. 点击编辑：`formData.value` = `{ ...row }`（包含selfOrOutsource）
2. 修改值：`formData.selfOrOutsource` = "外协"
3. 保存请求：`requestData.self_or_outsource` = "外协"
4. 后端UPDATE：SET `self_or_outsource` = "外协"
5. 数据库更新：`self_or_outsource` = "外协"
6. 重新加载：表格显示黄色"外协"标签 ✅
7. 查看详情：显示黄色"外协"标签 ✅

---

**修复完成时间**: 2025-12-08 17:00
**修复人**: AI助手
**状态**: ✅ 完全修复并验证通过
