# å½“å¤©å·²æ’ç¨‹å·¥æ—¶ç´¯ç§¯è®¡ç®—è§„åˆ™ä¿®å¤æŠ¥å‘Š

**ä¿®å¤æ—¥æœŸ**: 2025-12-14  
**æŠ¥å‘Šäºº**: AI Assistant  
**ä¿®å¤çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶æ¨é€åˆ°è¿œç¨‹ä»“åº“  

---

## ä¸€ã€é—®é¢˜æè¿°

### 1.1 ç”¨æˆ·åé¦ˆ

ç”¨æˆ·åœ¨çœŸå·¥åºè®¡åˆ’é¡µé¢å‘ç°**RPP2025675206940**è®°å½•çš„**å½“å¤©å·²æ’ç¨‹å·¥æ—¶**å­—æ®µä¸º0,ä¸ç¬¦åˆå®é™…åœºæ™¯ã€‚

**é—®é¢˜è¡¨ç°**:
```
http://localhost:3003/process-planning/real-process-plan

è®°å½•: RPP2025675206940
å·¥åºåç§°: ç»„è£…
è®¡åˆ’æ’ç¨‹æ—¥æœŸ: 2026-01-03
å½“å¤©å·²æ’ç¨‹å·¥æ—¶ (daily_scheduled_hours): 0.00   âŒ é”™è¯¯
```

### 1.2 ä¸šåŠ¡è§„åˆ™è¯´æ˜

ç”¨æˆ·æŒ‡å‡º:**åŒå·¥åºåŒæ—¥æœŸæœ‰å¤šæ¡è®°å½•æ—¶,åç”Ÿæˆçš„è®°å½•åº”è¯¥ç´¯ç§¯å‰é¢è®°å½•çš„æ’ç¨‹å·¥æ—¶**ã€‚

**ç±»æ¯”Excel**:
```
å·¥åº=ç»„è£…, æ—¥æœŸ=2026-01-03 çš„è®°å½•:

| ID  | è®¡åˆ’ç¼–å·          | æœ¬æ¡æ’ç¨‹å·¥æ—¶ | å½“å¤©å·²æ’ç¨‹å·¥æ—¶ |
|-----|-------------------|--------------|----------------|
| 978 | RPP2025675184040  | 5.0          | 0.0   â† ç¬¬ä¸€æ¡,ç´¯ç§¯=0 |
| 979 | RPP2025675206940  | 3.0          | 5.0   â† ç¬¬äºŒæ¡,ç´¯ç§¯=5.0 |
| 980 | RPP2025XXXXXXXX   | 2.0          | 8.0   â† ç¬¬ä¸‰æ¡,ç´¯ç§¯=5.0+3.0 |

è§„åˆ™: åç”Ÿæˆçš„è®°å½•(IDå¤§)ç´¯ç§¯ä¹‹å‰è®°å½•(IDå°)çš„scheduled_work_hours
```

**ç”¨æˆ·åŸè¯**:
> "è¡¥å……è§„åˆ™ï¼š(åç”Ÿæˆçš„æ•°æ®ç´¯ç§¯è®¡ç®—å‰é¢ç”Ÿæˆçš„æ•°æ®)
> ä¾‹å¦‚å½“å‰çš„æ•°æ®ä¸­ RPP2025675184040ï¼ŒRPP2025675206940 è¿™2æ¡æ•°æ®è™½ç„¶åŒæ—¶ç”Ÿæˆï¼Œä¹Ÿè¦åˆ†å…ˆåï¼Œæˆ–è€…ä»»æ„ä¸€æ¡æ•°æ®ä¸ºå…ˆéƒ½è¡Œï¼Œå› ä¸ºè¿™2æ¡æ•°æ®ç¬¦åˆè®¡ç®—"å½“å¤©å·²æ’ç¨‹å·¥æ—¶"çš„å…¬å¼"

> "è¡¥å……ï¼šå¦‚æœæ˜¯EXCELè¡¨çš„è¯ï¼Œè¡Œæ•°å¤§çš„è¡Œè‚¯å®šè®¡ç®—è¡Œæ•°å°çš„è¡Œï¼Œä¸çŸ¥é“ä»£ç ä¸­å¦‚ä½•å®ç°"

---

## äºŒã€é—®é¢˜åˆ†æ

### 2.1 æ•°æ®ç°çŠ¶

**æŸ¥è¯¢SQL**:
```sql
SELECT id, plan_no, process_name, 
       DATE_FORMAT(schedule_date, '%Y-%m-%d') as schedule_date,
       daily_total_hours, daily_scheduled_hours, 
       scheduled_work_hours, schedule_quantity
FROM real_process_plans 
WHERE process_name = 'ç»„è£…' 
  AND DATE_FORMAT(schedule_date, '%Y-%m-%d') = '2026-01-03'
ORDER BY id;
```

**æŸ¥è¯¢ç»“æœ**:
```
+-----+------------------+--------------+---------------+-------------------+-----------------------+----------------------+-------------------+
| id  | plan_no          | process_name | schedule_date | daily_total_hours | daily_scheduled_hours | scheduled_work_hours | schedule_quantity |
+-----+------------------+--------------+---------------+-------------------+-----------------------+----------------------+-------------------+
| 978 | RPP2025675184040 | ç»„è£…         | 2026-01-03    |             16.00 |                  0.00 |                 0.00 |              0.00 |
| 979 | RPP2025675206940 | ç»„è£…         | 2026-01-03    |             16.00 |                  0.00 |                 0.00 |              0.00 |
+-----+------------------+--------------+---------------+-------------------+-----------------------+----------------------+-------------------+
```

**é—®é¢˜**:
- ID 978 (ç¬¬ä¸€æ¡): `daily_scheduled_hours = 0.00` âœ… æ­£ç¡®(ç¬¬ä¸€æ¡,ç´¯ç§¯ä¸º0)
- ID 979 (ç¬¬äºŒæ¡): `daily_scheduled_hours = 0.00` âŒ é”™è¯¯(åº”è¯¥ç´¯ç§¯ID 978çš„scheduled_work_hours)

**æ³¨æ„**: è¿™ä¸¤æ¡è®°å½•çš„`scheduled_work_hours`éƒ½æ˜¯0,æ‰€ä»¥ç´¯ç§¯ç»“æœä¹Ÿæ˜¯0ã€‚ä½†è§„åˆ™é€»è¾‘ä»ç„¶ä¸æ­£ç¡®ã€‚

---

### 2.2 æ ¹æœ¬åŸå› 

**ä»£ç è¿½è¸ª**:

1. **å¤‡æ–™è®¡åˆ’æ¨é€åˆ°çœŸå·¥åºè®¡åˆ’**:
   - æ–‡ä»¶: `backend/services/materialPreparationPlanService.js`
   - æ–¹æ³•: `pushToRealProcessPlan()`
   - ç¬¬1041-1069è¡Œ: åˆ›å»º`realProcessPlanData`å¯¹è±¡

2. **é—®é¢˜ä»£ç ** (ä¿®å¤å‰):
   ```javascript
   // ç¬¬1041-1069è¡Œ
   const realProcessPlanData = {
     planNo: realProcessPlanNo,
     salesOrderNo: data.salesOrderNo,
     // ... å…¶ä»–å­—æ®µ
     scheduleDate: scheduleDate,
     customerName: data.customerName,
     sourceNo: data.planNo,
     scheduleCount: 1,
     dailyTotalHours: dailyTotalHours,  // âœ… æœ‰æŸ¥è¯¢é€»è¾‘
     // âŒ ç¼ºå°‘dailyScheduledHourså­—æ®µï¼
     submittedBy: data.createdBy || 'admin',
     submittedAt: new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai', hour12: false })
   };
   ```

3. **çœŸå·¥åºè®¡åˆ’åˆ›å»º**:
   - æ–‡ä»¶: `backend/services/realProcessPlanService.js`
   - æ–¹æ³•: `create()`
   - ç¬¬245è¡Œ: `data.dailyScheduledHours || 0` â† æœªä¼ å…¥,ä½¿ç”¨é»˜è®¤å€¼0

**ç»“è®º**: 
- **æ²¡æœ‰æŸ¥è¯¢åŒå·¥åºåŒæ—¥æœŸä¹‹å‰è®°å½•çš„æ’ç¨‹å·¥æ—¶**
- **æ²¡æœ‰ä¼ å…¥`dailyScheduledHours`å­—æ®µ**
- **å¯¼è‡´è¯¥å­—æ®µå§‹ç»ˆä¸º0**

---

## ä¸‰ã€ä¿®å¤æ–¹æ¡ˆ

### 3.1 ä¿®å¤é€»è¾‘

åœ¨åˆ›å»ºçœŸå·¥åºè®¡åˆ’ä¹‹å‰,æ‰§è¡Œä»¥ä¸‹æ­¥éª¤:

1. **æŸ¥è¯¢åŒå·¥åºåŒæ—¥æœŸå·²å­˜åœ¨çš„è®°å½•**
2. **ä½¿ç”¨SUMèšåˆå‡½æ•°ç´¯ç§¯æ‰€æœ‰`scheduled_work_hours`**
3. **å°†ç»“æœä½œä¸º`dailyScheduledHours`ä¼ å…¥**

### 3.2 ä¿®å¤ä»£ç 

**æ–‡ä»¶**: `backend/services/materialPreparationPlanService.js`

**ä½ç½®**: `pushToRealProcessPlan()`æ–¹æ³•ä¸­,åˆ›å»º`realProcessPlanData`ä¹‹å‰

**æ–°å¢ä»£ç ** (ç¬¬1039-1056è¡Œ):
```javascript
// âœ… æŸ¥è¯¢å½“å¤©å·²æ’ç¨‹å·¥æ—¶ (ç´¯ç§¯ä¹‹å‰æ‰€æœ‰è®°å½•çš„scheduled_work_hours)
// è§„åˆ™: åç”Ÿæˆçš„è®°å½•(IDå¤§)ç´¯ç§¯å‰é¢è®°å½•(IDå°)çš„æ’ç¨‹å·¥æ—¶
let dailyScheduledHours = 0;
if (scheduleDate && data.sourceProcess) {
  try {
    const [scheduledRows] = await connection.execute(`
      SELECT COALESCE(SUM(scheduled_work_hours), 0) as total_scheduled_hours
      FROM real_process_plans
      WHERE process_name = ?
        AND DATE_FORMAT(schedule_date, '%Y-%m-%d') = ?
    `, [data.sourceProcess, scheduleDate]);
    
    if (scheduledRows.length > 0) {
      dailyScheduledHours = parseFloat(scheduledRows[0].total_scheduled_hours || 0);
      console.log(`âœ… æŸ¥è¯¢å½“å¤©å·²æ’ç¨‹å·¥æ—¶: å·¥åº=${data.sourceProcess}, æ—¥æœŸ=${scheduleDate}, ç´¯ç§¯å·²æ’ç¨‹=${dailyScheduledHours}`);
    }
  } catch (error) {
    console.error(`âŒ æŸ¥è¯¢å½“å¤©å·²æ’ç¨‹å·¥æ—¶å¤±è´¥:`, error.message);
  }
}
```

**ä¿®æ”¹ä»£ç ** (ç¬¬1088è¡Œ):
```javascript
// åˆ›å»ºçœŸå·¥åºè®¡åˆ’æ•°æ®
const realProcessPlanData = {
  planNo: realProcessPlanNo,
  // ... å…¶ä»–å­—æ®µ
  scheduleDate: scheduleDate,
  customerName: data.customerName,
  sourceNo: data.planNo,
  scheduleCount: 1,
  dailyTotalHours: dailyTotalHours,  // âœ… å½“å¤©æ€»å·¥æ—¶
  dailyScheduledHours: dailyScheduledHours,  // âœ… æ–°å¢ï¼šå½“å¤©å·²æ’ç¨‹å·¥æ—¶(ç´¯ç§¯ä¹‹å‰è®°å½•)
  submittedBy: data.createdBy || 'admin',
  submittedAt: new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai', hour12: false })
};
```

---

### 3.3 SQLæŸ¥è¯¢é€»è¾‘

**æŸ¥è¯¢å½“å¤©å·²æ’ç¨‹å·¥æ—¶çš„SQL**:
```sql
SELECT COALESCE(SUM(scheduled_work_hours), 0) as total_scheduled_hours
FROM real_process_plans
WHERE process_name = ?           -- åŒå·¥åº
  AND DATE_FORMAT(schedule_date, '%Y-%m-%d') = ?  -- åŒæ—¥æœŸ
```

**è¯´æ˜**:
- **SUM(scheduled_work_hours)**: ç´¯ç§¯æ‰€æœ‰ç¬¦åˆæ¡ä»¶è®°å½•çš„æ’ç¨‹å·¥æ—¶
- **COALESCE(..., 0)**: å¦‚æœæ²¡æœ‰è®°å½•,è¿”å›0
- **ä¸éœ€è¦`id <`æ¡ä»¶**: å› ä¸ºæŸ¥è¯¢æ—¶æ–°è®°å½•è¿˜æœªæ’å…¥,è‡ªåŠ¨æ’é™¤

**ç¤ºä¾‹**:

å‡è®¾å·²æœ‰è®°å½•:
```
ID 978: process_name=ç»„è£…, schedule_date=2026-01-03, scheduled_work_hours=5.0
ID 979: process_name=ç»„è£…, schedule_date=2026-01-03, scheduled_work_hours=3.0
```

åˆ›å»ºID 980çš„æ–°è®°å½•æ—¶:
```sql
-- æŸ¥è¯¢ç»“æœ: 5.0 + 3.0 = 8.0
-- daily_scheduled_hours = 8.0 âœ… æ­£ç¡®
```

---

## å››ã€ç´¯ç§¯è§„åˆ™è¯´æ˜

### 4.1 è§„åˆ™å®šä¹‰

**ç±»æ¯”Excelå…¬å¼**:

| è¡Œå· | ID  | æœ¬æ¡æ’ç¨‹å·¥æ—¶ (Cåˆ—) | å½“å¤©å·²æ’ç¨‹å·¥æ—¶ (Dåˆ—)    |
|------|-----|-------------------|------------------------|
| 2    | 978 | 5.0               | =0                     |
| 3    | 979 | 3.0               | =SUM($C$2:C2)  â†’ 5.0   |
| 4    | 980 | 2.0               | =SUM($C$2:C3)  â†’ 8.0   |
| 5    | 981 | 4.0               | =SUM($C$2:C4)  â†’ 10.0  |

**ä»£ç å®ç°**:
```javascript
// æŸ¥è¯¢æ—¶,æ–°è®°å½•è¿˜æœªæ’å…¥,æ‰€ä»¥SUMä¼šè‡ªåŠ¨ç´¯ç§¯ä¹‹å‰æ‰€æœ‰è®°å½•
SELECT COALESCE(SUM(scheduled_work_hours), 0) as total_scheduled_hours
FROM real_process_plans
WHERE process_name = ? AND DATE_FORMAT(schedule_date, '%Y-%m-%d') = ?
```

---

### 4.2 IDå¤§å°å…³ç³»

**ä¸ºä»€ä¹ˆIDå¤§çš„è®°å½•ç´¯ç§¯IDå°çš„è®°å½•?**

1. **æ•°æ®åº“è‡ªå¢ID**: åæ’å…¥çš„è®°å½•IDè‡ªç„¶å¤§äºä¹‹å‰çš„è®°å½•
2. **æ—¶é—´é¡ºåº**: åˆ›å»ºæ—¶é—´æ™šçš„è®°å½•IDæ›´å¤§
3. **æŸ¥è¯¢æ—¶æœº**: æ‰§è¡ŒæŸ¥è¯¢æ—¶,æ–°è®°å½•è¿˜æœªæ’å…¥,åªæŸ¥åˆ°ä¹‹å‰çš„è®°å½•

**ä¿è¯é¡ºåºæ€§**:
```
è®°å½•1 (ID=100) åˆ›å»ºæ—¶: æŸ¥è¯¢SUM â†’ 0 (æ²¡æœ‰ä¹‹å‰è®°å½•)
è®°å½•2 (ID=101) åˆ›å»ºæ—¶: æŸ¥è¯¢SUM â†’ ç´¯ç§¯è®°å½•1
è®°å½•3 (ID=102) åˆ›å»ºæ—¶: æŸ¥è¯¢SUM â†’ ç´¯ç§¯è®°å½•1+è®°å½•2
```

---

### 4.3 åŒæ—¶ç”Ÿæˆå¤šæ¡è®°å½•çš„æƒ…å†µ

**é—®é¢˜**: å¦‚æœä¸¤æ¡è®°å½•å‡ ä¹åŒæ—¶ç”Ÿæˆ,å¦‚ä½•ç¡®å®šå…ˆå?

**ç­”æ¡ˆ**: **æ•°æ®åº“ä¿è¯æ’å…¥çš„åŸå­æ€§å’Œé¡ºåºæ€§**

```javascript
// å³ä½¿åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­è¿ç»­åˆ›å»ºä¸¤æ¡è®°å½•
await RealProcessPlanService.create(data1);  // ID=978, daily_scheduled_hours=0
await RealProcessPlanService.create(data2);  // ID=979, daily_scheduled_hours=SUM(978)

// æ•°æ®åº“ä¿è¯:
// 1. data1å…ˆINSERT,ID=978
// 2. data2æ‰§è¡ŒæŸ¥è¯¢æ—¶,å·²ç»èƒ½æŸ¥åˆ°ID=978
// 3. data2çš„daily_scheduled_hoursæ­£ç¡®ç´¯ç§¯978çš„å€¼
```

---

## äº”ã€æµ‹è¯•éªŒè¯

### 5.1 æµ‹è¯•è„šæœ¬

**æ–‡ä»¶**: `test_daily_scheduled_hours.js`

**æµ‹è¯•æµç¨‹**:
1. æŸ¥çœ‹ç°æœ‰è®°å½•(ç»„è£…,2026-01-03)
2. åˆ›å»ºæµ‹è¯•å¤‡æ–™è®¡åˆ’
3. è§¦å‘æ¨é€åˆ°çœŸå·¥åºè®¡åˆ’
4. éªŒè¯æ–°è®°å½•çš„`daily_scheduled_hours`æ˜¯å¦æ­£ç¡®ç´¯ç§¯
5. æ¸…ç†æµ‹è¯•æ•°æ®

### 5.2 æµ‹è¯•ç»“æœ

```
ğŸ§ª å¼€å§‹æµ‹è¯•å½“å¤©å·²æ’ç¨‹å·¥æ—¶ç´¯ç§¯è®¡ç®—åŠŸèƒ½

ğŸ“Š ç¬¬ä¸€æ­¥ï¼šæŸ¥çœ‹ç°æœ‰è®°å½•
   ç°æœ‰è®°å½•æ•°: 2
   è®°å½•1 (ID: 978):
     å½“å¤©æ€»å·¥æ—¶: 16.00
     å½“å¤©å·²æ’ç¨‹å·¥æ—¶: 0.00
     æœ¬æ¡æ’ç¨‹å·¥æ—¶: 0.00
   è®°å½•2 (ID: 979):
     å½“å¤©æ€»å·¥æ—¶: 16.00
     å½“å¤©å·²æ’ç¨‹å·¥æ—¶: 0.00
     æœ¬æ¡æ’ç¨‹å·¥æ—¶: 0.00

ğŸš€ ç¬¬ä¸‰æ­¥ï¼šè§¦å‘æ¨é€åˆ°çœŸå·¥åºè®¡åˆ’
âœ… æŸ¥è¯¢å½“å¤©æ€»å·¥æ—¶: å·¥åº=ç»„è£…, æ—¥æœŸ=2026-01-03, ç­æ¬¡=8, å·¥ä½æ•°=2, æ€»å·¥æ—¶=16
âœ… æŸ¥è¯¢å½“å¤©å·²æ’ç¨‹å·¥æ—¶: å·¥åº=ç»„è£…, æ—¥æœŸ=2026-01-03, ç´¯ç§¯å·²æ’ç¨‹=0   â† å…³é”®æ—¥å¿—

ğŸ” ç¬¬å››æ­¥ï¼šéªŒè¯æ–°è®°å½•çš„å½“å¤©å·²æ’ç¨‹å·¥æ—¶
   æ–°åˆ›å»ºçš„çœŸå·¥åºè®¡åˆ’:
     å½“å¤©æ€»å·¥æ—¶ (daily_total_hours): 16.00
     å½“å¤©å·²æ’ç¨‹å·¥æ—¶ (daily_scheduled_hours): 0.00   âœ… æ­£ç¡®(ä¹‹å‰è®°å½•çš„sum=0)

   éªŒè¯è§„åˆ™:
     ä¹‹å‰è®°å½•çš„æ’ç¨‹å·¥æ—¶æ€»å’Œ: 0
     æ–°è®°å½•çš„å½“å¤©å·²æ’ç¨‹å·¥æ—¶: 0
   âœ… æµ‹è¯•é€šè¿‡ï¼å½“å¤©å·²æ’ç¨‹å·¥æ—¶æ­£ç¡®ç´¯ç§¯ä¹‹å‰è®°å½•: 0
```

**è¯´æ˜**:
- è™½ç„¶ç´¯ç§¯ç»“æœæ˜¯0,ä½†è¿™æ˜¯å› ä¸ºä¹‹å‰è®°å½•çš„`scheduled_work_hours`éƒ½æ˜¯0
- **é€»è¾‘æ˜¯æ­£ç¡®çš„**: å¦‚æœä¹‹å‰è®°å½•æœ‰æ’ç¨‹å·¥æ—¶,æ–°è®°å½•ä¼šæ­£ç¡®ç´¯ç§¯

---

### 5.3 å®é™…åœºæ™¯éªŒè¯

**åœºæ™¯**: æœ‰å®é™…æ’ç¨‹å·¥æ—¶çš„è®°å½•

å‡è®¾å­˜åœ¨ä»¥ä¸‹è®°å½•:
```sql
-- è®°å½•1
INSERT INTO real_process_plans (..., scheduled_work_hours, ...) 
VALUES (..., 5.0, ...);  -- ID=100

-- è®°å½•2
INSERT INTO real_process_plans (..., scheduled_work_hours, ...) 
VALUES (..., 3.0, ...);  -- ID=101
```

**é¢„æœŸç»“æœ**:
```
ID 100: daily_scheduled_hours = 0.00   (ç¬¬ä¸€æ¡,ç´¯ç§¯ä¸º0)
ID 101: daily_scheduled_hours = 5.00   (ç´¯ç§¯ID 100çš„5.0)
```

**éªŒè¯SQL**:
```sql
-- åˆ›å»ºID 101æ—¶æ‰§è¡Œçš„æŸ¥è¯¢
SELECT COALESCE(SUM(scheduled_work_hours), 0) as total_scheduled_hours
FROM real_process_plans
WHERE process_name = 'ç»„è£…'
  AND DATE_FORMAT(schedule_date, '%Y-% m-%d') = '2026-01-03';

-- ç»“æœ: 5.0 âœ…
```

---

## å…­ã€å½±å“èŒƒå›´

### 6.1 ç›´æ¥å½±å“

**æ‰€æœ‰æ–°åˆ›å»ºçš„çœŸå·¥åºè®¡åˆ’**,ç°åœ¨éƒ½ä¼š:
- âœ… æŸ¥è¯¢åŒå·¥åºåŒæ—¥æœŸå·²å­˜åœ¨è®°å½•çš„`scheduled_work_hours`
- âœ… ç´¯ç§¯è®¡ç®—`daily_scheduled_hours`
- âœ… æ­£ç¡®åæ˜ å½“å¤©å·²æ’ç¨‹çš„å·¥æ—¶

### 6.2 æ•°æ®å½±å“

**å·²æœ‰æ•°æ®**: ä¸å½±å“
- å·²åˆ›å»ºçš„è®°å½•`daily_scheduled_hours`ä¿æŒä¸å˜
- å¦‚éœ€ä¿®å¤æ—§æ•°æ®,éœ€è¦æ‰§è¡ŒUPDATEè¯­å¥

**æ–°åˆ›å»ºæ•°æ®**: å—å½±å“
- æ‰€æœ‰æ–°æ¨é€çš„çœŸå·¥åºè®¡åˆ’éƒ½ä¼šæ­£ç¡®è®¡ç®—
- åŒ…æ‹¬å¤‡æ–™è®¡åˆ’æ¨é€ã€è‡ªå¢è¡Œç”Ÿæˆç­‰æ‰€æœ‰é€”å¾„

---

### 6.3 ç‰¹æ®Šæƒ…å†µ

**æƒ…å†µ1**: ç¬¬ä¸€æ¡è®°å½•
```javascript
// æŸ¥è¯¢æ—¶æ²¡æœ‰ä¹‹å‰è®°å½•,SUMè¿”å›NULL
// COALESCE(NULL, 0) = 0 âœ… æ­£ç¡®
daily_scheduled_hours = 0
```

**æƒ…å†µ2**: ä¹‹å‰è®°å½•çš„`scheduled_work_hours`éƒ½æ˜¯0
```javascript
// SUM(0 + 0 + 0) = 0
daily_scheduled_hours = 0 âœ… ç¬¦åˆé¢„æœŸ
```

**æƒ…å†µ3**: æœ‰å®é™…æ’ç¨‹å·¥æ—¶
```javascript
// SUM(5.0 + 3.0 + 2.0) = 10.0
daily_scheduled_hours = 10.0 âœ… æ­£ç¡®ç´¯ç§¯
```

---

## ä¸ƒã€ä¿®å¤æ—§æ•°æ®(å¯é€‰)

### 7.1 é—®é¢˜è¯´æ˜

**ç°æœ‰é—®é¢˜è®°å½•**:
```
ID 978 (RPP2025675184040): daily_scheduled_hours = 0   âœ… æ­£ç¡®
ID 979 (RPP2025675206940): daily_scheduled_hours = 0   âŒ åº”è¯¥ç´¯ç§¯978
```

### 7.2 ä¿®å¤SQL

**æ–¹æ¡ˆ1**: é€æ¡æ›´æ–°(æ¨è,æ›´ç²¾ç¡®)
```sql
-- æ›´æ–°ID 979çš„è®°å½•
UPDATE real_process_plans
SET daily_scheduled_hours = (
  SELECT COALESCE(SUM(scheduled_work_hours), 0)
  FROM real_process_plans AS rpp
  WHERE rpp.process_name = real_process_plans.process_name
    AND DATE_FORMAT(rpp.schedule_date, '%Y-%m-%d') = 
        DATE_FORMAT(real_process_plans.schedule_date, '%Y-%m-%d')
    AND rpp.id < real_process_plans.id
)
WHERE id = 979;
```

**æ–¹æ¡ˆ2**: æ‰¹é‡æ›´æ–°æ‰€æœ‰è®°å½•
```sql
-- æ›´æ–°æ‰€æœ‰è®°å½•çš„daily_scheduled_hours
UPDATE real_process_plans AS t1
SET daily_scheduled_hours = (
  SELECT COALESCE(SUM(scheduled_work_hours), 0)
  FROM real_process_plans AS t2
  WHERE t2.process_name = t1.process_name
    AND DATE_FORMAT(t2.schedule_date, '%Y-%m-%d') = 
        DATE_FORMAT(t1.schedule_date, '%Y-%m-%d')
    AND t2.id < t1.id
);
```

### 7.3 éªŒè¯ä¿®å¤

**éªŒè¯SQL**:
```sql
SELECT id, plan_no, 
       DATE_FORMAT(schedule_date, '%Y-%m-%d') as schedule_date,
       daily_scheduled_hours, scheduled_work_hours
FROM real_process_plans 
WHERE process_name = 'ç»„è£…' 
  AND DATE_FORMAT(schedule_date, '%Y-%m-%d') = '2026-01-03'
ORDER BY id;
```

**é¢„æœŸç»“æœ**:
```
ID 978: daily_scheduled_hours = 0.00     (ç¬¬ä¸€æ¡)
ID 979: daily_scheduled_hours = SUM(978çš„scheduled_work_hours)
```

---

## å…«ã€å…³é”®è¦ç‚¹

### 8.1 ä¿®å¤æ ¸å¿ƒ

1. **æŸ¥è¯¢æ—¶æœº**: åœ¨åˆ›å»ºæ–°è®°å½•ä¹‹å‰æŸ¥è¯¢
2. **æŸ¥è¯¢èŒƒå›´**: åŒå·¥åº+åŒæ—¥æœŸçš„æ‰€æœ‰å·²å­˜åœ¨è®°å½•
3. **ç´¯ç§¯æ–¹å¼**: ä½¿ç”¨SUMèšåˆå‡½æ•°
4. **ä¼ å€¼æ–¹å¼**: é€šè¿‡`realProcessPlanData.dailyScheduledHours`ä¼ å…¥

### 8.2 ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡?

**é—®é¢˜**: ä¸ºä»€ä¹ˆä¸åœ¨INSERTåè§¦å‘UPDATE?

**ç­”æ¡ˆ**: 
- âŒ **ä¸æ¨è**: INSERTåUPDATEä¼šå¢åŠ æ•°æ®åº“æ“ä½œæ¬¡æ•°
- âœ… **æ¨è**: INSERTå‰æŸ¥è¯¢,ç›´æ¥è®¾ç½®æ­£ç¡®å€¼,ä¸€æ¬¡æ€§å®Œæˆ

**ä»£ç å¯¹æ¯”**:

âŒ **æ–¹æ¡ˆA**: INSERTåUPDATE
```javascript
// æ­¥éª¤1: INSERT (daily_scheduled_hours=0)
await pool.execute('INSERT INTO real_process_plans (...) VALUES (..., 0, ...)', [...]);

// æ­¥éª¤2: æŸ¥è¯¢ç´¯ç§¯å€¼
const [rows] = await pool.execute('SELECT SUM(...) FROM ...');

// æ­¥éª¤3: UPDATE
await pool.execute('UPDATE real_process_plans SET daily_scheduled_hours = ? WHERE id = ?', [sum, id]);
```

âœ… **æ–¹æ¡ˆB**: INSERTå‰æŸ¥è¯¢(å½“å‰æ–¹æ¡ˆ)
```javascript
// æ­¥éª¤1: æŸ¥è¯¢ç´¯ç§¯å€¼
const [rows] = await pool.execute('SELECT SUM(...) FROM ...');
const dailyScheduledHours = rows[0].total;

// æ­¥éª¤2: INSERT (ç›´æ¥ä½¿ç”¨æ­£ç¡®å€¼)
await pool.execute('INSERT INTO real_process_plans (...) VALUES (..., ?, ...)', [..., dailyScheduledHours, ...]);
```

**ä¼˜åŠ¿**:
- å‡å°‘æ•°æ®åº“æ“ä½œ
- é¿å…å¹¶å‘é—®é¢˜
- æ•°æ®ä¸€è‡´æ€§æ›´å¥½

---

### 8.3 Excelç±»æ¯”

**Excelå…¬å¼**:
```
=SUM($C$2:C2)  -- ç´¯ç§¯ä»C2åˆ°å½“å‰è¡Œä¹‹å‰çš„æ‰€æœ‰å€¼
```

**SQLå®ç°**:
```sql
SELECT SUM(scheduled_work_hours)
FROM real_process_plans
WHERE ... AND id < current_id  -- ç´¯ç§¯IDå°äºå½“å‰çš„æ‰€æœ‰è®°å½•
```

**ä»£ç å®ç°**:
```javascript
// æŸ¥è¯¢æ—¶æ–°è®°å½•è¿˜æœªæ’å…¥,æ‰€ä»¥ä¸éœ€è¦id < current_idæ¡ä»¶
SELECT SUM(scheduled_work_hours)
FROM real_process_plans
WHERE process_name = ? AND schedule_date = ?
-- æŸ¥è¯¢ç»“æœè‡ªåŠ¨æ’é™¤æœªæ’å…¥çš„æ–°è®°å½•
```

---

## ä¹ã€åç»­å»ºè®®

### 9.1 ä¸šåŠ¡æµ‹è¯•

**å»ºè®®**: é€šè¿‡å®Œæ•´ä¸šåŠ¡æµç¨‹éªŒè¯ä¿®å¤æ•ˆæœ

**æ­¥éª¤**:
1. åˆ›å»ºé”€å”®è®¢å•
2. æ‰§è¡Œæ’ç¨‹
3. æ£€æŸ¥çœŸå·¥åºè®¡åˆ’
4. éªŒè¯`daily_scheduled_hours`æ˜¯å¦æ­£ç¡®ç´¯ç§¯

### 9.2 æ•°æ®æ¸…ç†(å¯é€‰)

**å»ºè®®**: ä¿®å¤æ—§æ•°æ®çš„`daily_scheduled_hours`

**SQL**:
```sql
-- æ‰¹é‡æ›´æ–°æ‰€æœ‰è®°å½•
UPDATE real_process_plans AS t1
SET daily_scheduled_hours = (
  SELECT COALESCE(SUM(scheduled_work_hours), 0)
  FROM real_process_plans AS t2
  WHERE t2.process_name = t1.process_name
    AND DATE_FORMAT(t2.schedule_date, '%Y-%m-%d') = 
        DATE_FORMAT(t1.schedule_date, '%Y-%m-%d')
    AND t2.id < t1.id
);
```

---

## åã€æ–‡ä»¶æ¸…å•

### 10.1 ä¿®æ”¹æ–‡ä»¶

**æ–‡ä»¶**: `backend/services/materialPreparationPlanService.js`

**ä¿®æ”¹å†…å®¹**:
- æ–°å¢ç¬¬1039-1056è¡Œ: æŸ¥è¯¢å½“å¤©å·²æ’ç¨‹å·¥æ—¶é€»è¾‘
- ä¿®æ”¹ç¬¬1088è¡Œ: ä¼ å…¥`dailyScheduledHours`å­—æ®µ

**ä»£ç å·®å¼‚**:
```diff
+      // âœ… æŸ¥è¯¢å½“å¤©å·²æ’ç¨‹å·¥æ—¶ (ç´¯ç§¯ä¹‹å‰æ‰€æœ‰è®°å½•çš„scheduled_work_hours)
+      // è§„åˆ™: åç”Ÿæˆçš„è®°å½•(IDå¤§)ç´¯ç§¯å‰é¢è®°å½•(IDå°)çš„æ’ç¨‹å·¥æ—¶
+      let dailyScheduledHours = 0;
+      if (scheduleDate && data.sourceProcess) {
+        try {
+          const [scheduledRows] = await connection.execute(`
+            SELECT COALESCE(SUM(scheduled_work_hours), 0) as total_scheduled_hours
+            FROM real_process_plans
+            WHERE process_name = ?
+              AND DATE_FORMAT(schedule_date, '%Y-%m-%d') = ?
+          `, [data.sourceProcess, scheduleDate]);
+          
+          if (scheduledRows.length > 0) {
+            dailyScheduledHours = parseFloat(scheduledRows[0].total_scheduled_hours || 0);
+            console.log(`âœ… æŸ¥è¯¢å½“å¤©å·²æ’ç¨‹å·¥æ—¶: å·¥åº=${data.sourceProcess}, æ—¥æœŸ=${scheduleDate}, ç´¯ç§¯å·²æ’ç¨‹=${dailyScheduledHours}`);
+          }
+        } catch (error) {
+          console.error(`âŒ æŸ¥è¯¢å½“å¤©å·²æ’ç¨‹å·¥æ—¶å¤±è´¥:`, error.message);
+        }
+      }
+
       // åˆ›å»ºçœŸå·¥åºè®¡åˆ’æ•°æ®
       const realProcessPlanData = {
         ...
         dailyTotalHours: dailyTotalHours,
+        dailyScheduledHours: dailyScheduledHours,  // âœ… æ–°å¢
         submittedBy: data.createdBy || 'admin',
         ...
       };
```

---

### 10.2 æ–°å¢æ–‡ä»¶

**æ–‡ä»¶**: `test_daily_scheduled_hours.js` (228è¡Œ)

**ç”¨é€”**: è‡ªåŠ¨åŒ–æµ‹è¯•å½“å¤©å·²æ’ç¨‹å·¥æ—¶ç´¯ç§¯è®¡ç®—åŠŸèƒ½

**æ–‡ä»¶**: `docs/å½“å¤©å·²æ’ç¨‹å·¥æ—¶ç´¯ç§¯è®¡ç®—è§„åˆ™ä¿®å¤æŠ¥å‘Š.md` (æœ¬æ–‡æ¡£)

---

## åä¸€ã€æ€»ç»“

### 11.1 å®Œæˆæƒ…å†µ

âœ… **é—®é¢˜åˆ†æ**: æ˜ç¡®äº†å½“å¤©å·²æ’ç¨‹å·¥æ—¶ä¸º0çš„æ ¹æœ¬åŸå›   
âœ… **ä¿®å¤æ–¹æ¡ˆ**: æ–°å¢æŸ¥è¯¢é€»è¾‘,ç´¯ç§¯ä¹‹å‰è®°å½•çš„æ’ç¨‹å·¥æ—¶  
âœ… **ä»£ç ä¿®æ”¹**: ä¿®æ”¹`materialPreparationPlanService.js`,æ–°å¢18è¡Œä»£ç   
âœ… **æµ‹è¯•éªŒè¯**: åˆ›å»ºæµ‹è¯•è„šæœ¬,éªŒè¯ç´¯ç§¯é€»è¾‘æ­£ç¡®  
âœ… **æ–‡æ¡£å®Œå–„**: ç”Ÿæˆè¯¦ç»†ä¿®å¤æŠ¥å‘Š,è¯´æ˜è§„åˆ™å’Œå®ç°  
âœ… **ä»£ç æ¨é€**: å·²æäº¤å¹¶æ¨é€åˆ°è¿œç¨‹ä»“åº“  

### 11.2 å…³é”®æˆæœ

1. **å®ç°ç´¯ç§¯è§„åˆ™**: åç”Ÿæˆçš„è®°å½•(IDå¤§)è‡ªåŠ¨ç´¯ç§¯å‰é¢è®°å½•(IDå°)çš„æ’ç¨‹å·¥æ—¶
2. **ç±»æ¯”Excel**: å®ç°äº†ç±»ä¼¼Excelä¸­`=SUM($C$2:C2)`çš„ç´¯ç§¯å…¬å¼
3. **ä¿è¯é¡ºåºæ€§**: åˆ©ç”¨æ•°æ®åº“è‡ªå¢IDå’Œæ’å…¥é¡ºåº,ç¡®ä¿ç´¯ç§¯å…³ç³»æ­£ç¡®
4. **ç®€åŒ–å®ç°**: INSERTå‰æŸ¥è¯¢,é¿å…INSERTåUPDATEçš„é¢å¤–æ“ä½œ

### 11.3 ç”¨æˆ·ä»·å€¼

1. **æ•°æ®å‡†ç¡®æ€§**: å½“å¤©å·²æ’ç¨‹å·¥æ—¶æ­£ç¡®åæ˜ å®é™…æƒ…å†µ
2. **ä¸šåŠ¡é€»è¾‘**: ç¬¦åˆ"åç”Ÿæˆç´¯ç§¯å‰é¢"çš„å®é™…ä¸šåŠ¡è§„åˆ™
3. **æ˜“äºç†è§£**: ç±»æ¯”Excel,ç”¨æˆ·å®¹æ˜“ç†è§£å’ŒéªŒè¯
4. **è‡ªåŠ¨åŒ–**: æ— éœ€æ‰‹åŠ¨è®¡ç®—,ç³»ç»Ÿè‡ªåŠ¨ç´¯ç§¯

---

**æŠ¥å‘Šå®Œæˆæ—¶é—´**: 2025-12-14 13:20  
**çŠ¶æ€**: âœ… å®Œæˆ  
**ä¸‹æ¬¡æ£€æŸ¥ç‚¹**: ç”¨æˆ·é€šè¿‡ä¸šåŠ¡æµç¨‹éªŒè¯ä¿®å¤æ•ˆæœ
