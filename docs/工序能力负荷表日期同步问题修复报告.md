# 工序能力负荷表日期同步问题修复报告

## 📋 问题描述

**问题页面**: 
- 工序能力负荷表: http://localhost:3003/mrp/capacity-load
- 企业日历: http://localhost:3003/human-resources/company-calendar

**问题现象**:
在企业日历中,2026-01-03设置为:
- 日期: 2026-01-03
- 星期: 星期一
- 休息/上班: 上班
- 标准上班时长: 8.00小时

但在工序能力负荷表中,所有日期为2026-01-03的记录,上班时段显示为"-"(空值),未能正确同步企业日历的标准上班时长。

---

## 🔍 问题分析

### 根本原因

在`backend/routes/capacityLoad.js`的**重置上班时段**功能中,日期格式化存在时区转换问题:

```javascript
// ❌ 问题代码(行516)
const dateStr = calendar.calendar_date.toISOString().split('T')[0];
```

**问题详解**:
1. `calendar.calendar_date` 是MySQL返回的Date对象(本地时间)
2. `.toISOString()` 方法会将Date对象转换为**UTC时区**的ISO格式字符串
3. 中国时区是UTC+8,当日期为`2026-01-03 00:00:00`时:
   - UTC时间为 `2026-01-02 16:00:00`
   - `toISOString()` 返回 `2026-01-02T16:00:00.000Z`
   - `split('T')[0]` 得到 `2026-01-02` ❌ 日期错位!

4. 使用错误的日期字符串去UPDATE,导致匹配不到工序能力负荷表中的2026-01-03记录

---

## ✅ 修复方案

### 修改文件
`/home/sardenesy/ai_workspaces/ai_desktop_3/backend/routes/capacityLoad.js`

### 修改内容

**修改前** (行516-517):
```javascript
const dateStr = calendar.calendar_date.toISOString().split('T')[0];
const hours = calendar.standard_work_hours;
```

**修改后** (行516-521):
```javascript
// ✅ 修复日期格式化问题:使用本地时区格式化,避免UTC转换导致日期错位
const date = new Date(calendar.calendar_date);
const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
const hours = calendar.standard_work_hours;

console.log(`  处理日期: ${dateStr}, 标准工时: ${hours}`);
```

**新增调试日志** (行536):
```javascript
console.log(`  更新 ${updateResult.affectedRows} 条记录`);
```

### 技术要点

1. **使用本地时区方法**:
   - `date.getFullYear()` - 获取本地年份
   - `date.getMonth() + 1` - 获取本地月份(0-11需要+1)
   - `date.getDate()` - 获取本地日期

2. **字符串格式化**:
   - 使用`padStart(2, '0')`确保月份和日期为两位数
   - 格式: `YYYY-MM-DD`

3. **增强调试能力**:
   - 输出每个日期的处理情况
   - 输出每个日期更新的记录数

---

## 🧪 测试步骤

### 测试准备

1. **确认企业日历数据**:
   - 访问: http://localhost:3003/human-resources/company-calendar
   - 检查2026-01-03日期:
     - ✅ 星期: 星期一
     - ✅ 休息/上班: 上班
     - ✅ 标准上班时长: 8.00小时

2. **查看工序能力负荷表当前状态**:
   - 访问: http://localhost:3003/mrp/capacity-load
   - 筛选日期: 2026-01-03
   - 检查"上班时段"列: 当前应为"-"或空值

### 执行测试

**步骤1**: 点击工序能力负荷表的"重置上班时段"按钮

**步骤2**: 确认操作 → 等待执行完成

**步骤3**: 查看成功提示消息(例如: "重置成功,共更新XX条记录")

**步骤4**: 刷新页面,检查2026-01-03的记录

### 预期结果

✅ **正确结果**:
- 日期为2026-01-03的所有记录
- "上班时段"列显示: `8.00` (或8.00小时)
- 而不是"-"或空值

❌ **错误结果**:
- 如果仍显示"-",说明日期匹配仍有问题

### 后端日志验证

查看后端日志确认执行情况:
```bash
cat /tmp/backend.log | grep "处理日期: 2026-01-03"
```

**预期日志输出**:
```
  处理日期: 2026-01-03, 标准工时: 8
  更新 XX 条记录
```

---

## 🔧 相关问题排查

### 如果问题仍存在

**检查1: 数据库中的日期格式**
```sql
SELECT date, work_shift FROM process_capacity_load WHERE date = '2026-01-03';
```

**检查2: 企业日历中的日期**
```sql
SELECT calendar_date, standard_work_hours FROM company_calendar WHERE calendar_date = '2026-01-03';
```

**检查3: 后端日志**
```bash
tail -100 /tmp/backend.log | grep "2026-01-03"
```

### 其他潜在时区问题位置

在同一文件中,还有一个可能存在时区问题的地方:

**行579** (`cleanup` 删除过期数据接口):
```javascript
const todayStr = today.toISOString().split('T')[0];  // ⚠️ 可能也需要修复
```

不过这个场景影响较小,因为是删除"早于今天"的数据,即使日期差一天也不太影响功能。

---

## 📝 相关代码位置

### 后端文件
- **主要修改**: `/backend/routes/capacityLoad.js` (行514-538)
- **API接口**: `POST /api/capacity-load/reset-work-shift`

### 前端文件
- **调用页面**: `/07-frontend/src/pages/mrp/CapacityLoad.vue` (行414-452)
- **调用函数**: `handleResetWorkShift()`

### 数据库表
- **企业日历**: `company_calendar` 表
  - 字段: `calendar_date`, `standard_work_hours`, `is_workday`
- **工序能力负荷**: `process_capacity_load` 表
  - 字段: `date`, `work_shift`, `process_name`

---

## 🎯 总结

### 修复内容
- ✅ 修复了日期格式化的时区转换问题
- ✅ 使用本地时区方法替代UTC转换
- ✅ 增加了调试日志输出

### 影响范围
- ✅ 工序能力负荷表的"重置上班时段"功能
- ✅ 企业日历到工序能力负荷表的数据同步
- ✅ 所有日期的上班时段自动更新

### 技术价值
这个修复揭示了一个重要的编程原则:
> **在处理日期时,必须明确区分本地时区和UTC时区,避免隐式转换导致的数据错位**

类似的问题可能存在于其他使用`.toISOString()`的地方,建议全局搜索并逐一检查。

---

## 📅 修复日期
2025-12-10

## 👤 修复人员
AI Assistant
