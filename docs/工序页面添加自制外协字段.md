# 工序页面添加"自制/外协"字段 - 修复报告

## 修复时间
2025-12-08 16:30 - 16:50

## 需求描述
在工序列表页面（`http://localhost:3002/manufacturing/process`）的主表格中添加"自制/外协"字段，支持手动录入。

---

## 修改内容

### 1. 数据库表结构修改

**表名**: `processes`
**新增字段**: `self_or_outsource`

```sql
ALTER TABLE processes 
ADD COLUMN self_or_outsource VARCHAR(20) DEFAULT NULL 
COMMENT '自制/外协' 
AFTER dispatch_method;
```

**字段说明**:
- 类型：VARCHAR(20)
- 默认值：NULL
- 可选值：'自制' 或 '外协'
- 位置：在 `dispatch_method` 字段之后

---

### 2. 前端修改

#### 2.1 表格列添加

**文件**: `/07-frontend/src/pages/manufacturing/ProcessList.vue`

**位置**: 第111-124行（在"派工方式"列后面）

```vue
<el-table-column prop="selfOrOutsource" label="自制/外协" width="120">
  <template #default="{ row }">
    <el-tag v-if="row.selfOrOutsource === '自制'" type="primary">自制</el-tag>
    <el-tag v-else-if="row.selfOrOutsource === '外协'" type="warning">外协</el-tag>
    <el-tag v-else type="info">{{ row.selfOrOutsource || '未设置' }}</el-tag>
  </template>
</el-table-column>
```

**显示效果**:
- 自制：蓝色标签
- 外协：黄色标签
- 未设置：灰色标签

---

#### 2.2 新增/编辑表单

**位置**: 第188-203行（在"派工方式"后面）

```vue
<el-col :span="12">
  <el-form-item label="自制/外协" prop="selfOrOutsource">
    <el-select v-model="formData.selfOrOutsource" placeholder="请选择自制或外协" style="width: 100%;">
      <el-option label="自制" value="自制" />
      <el-option label="外协" value="外协" />
    </el-select>
  </el-form-item>
</el-col>
```

---

#### 2.3 数据模型修改

**formData初始化** (第327行):
```javascript
const formData = ref({
  processCode: '',
  processName: '',
  processPrincipal: '',
  dispatchMethod: '',
  selfOrOutsource: '',  // ✅ 新增
  isStorage: false,
  completionWarehouse: '',
  workshopName: '',
  processWage: 0
})
```

**创建时初始化** (第436行):
```javascript
formData.value = {
  processCode: `P${new Date().getFullYear()}${String(nextProcessId.value).padStart(4, '0')}`,
  processName: '',
  processPrincipal: '',
  dispatchMethod: 'manual',
  selfOrOutsource: '',  // ✅ 新增
  isStorage: false,
  completionWarehouse: '',
  workshopName: '',
  processWage: 0
}
```

**数据加载映射** (第714行):
```javascript
tableData.value = result.data.map(item => ({
  id: item.id,
  processCode: item.process_code,
  processName: item.process_name,
  processPrincipal: item.responsible_person,
  dispatchMethod: item.dispatch_method,
  selfOrOutsource: item.self_or_outsource || '',  // ✅ 新增
  isStorage: item.is_warehousing === 1,
  // ... 其他字段
}))
```

---

### 3. 后端修改

**文件**: `/backend/routes/processes.js`

#### 3.1 创建工序 (POST /create)

**SQL语句** (第28-32行):
```javascript
const sql = `
  INSERT INTO processes (
    process_code, process_name, responsible_person, dispatch_method,
    self_or_outsource, is_warehousing, completion_warehouse, workshop_name, process_wage
  ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
`;
```

**参数** (第35-44行):
```javascript
await pool.execute(sql, [
  processData.process_code || processData.processCode,
  processData.process_name || processData.processName,
  processData.responsible_person || processData.responsiblePerson,
  processData.dispatch_method || processData.dispatchMethod,
  processData.self_or_outsource || processData.selfOrOutsource || null,  // ✅ 新增
  processData.is_warehousing || processData.isWarehousing || 0,
  processData.completion_warehouse || processData.completionWarehouse || '',
  processData.workshop_name || processData.workshopName,
  processData.process_wage || processData.processWage || 0
]);
```

---

#### 3.2 批量更新工序 (POST /batch-create)

**UPDATE SQL** (第92-96行):
```javascript
const updateSql = `
  UPDATE processes SET
    process_name = ?, responsible_person = ?, dispatch_method = ?,
    self_or_outsource = ?, is_warehousing = ?, completion_warehouse = ?, workshop_name = ?, process_wage = ?
  WHERE process_code = ?
`;
```

**INSERT SQL** (第111-115行):
```javascript
const insertSql = `
  INSERT INTO processes (
    process_code, process_name, responsible_person, dispatch_method,
    self_or_outsource, is_warehousing, completion_warehouse, workshop_name, process_wage
  ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
`;
```

---

## 字段命名规范

| 位置 | 命名方式 | 示例 |
|------|---------|------|
| 数据库 | 下划线命名 | `self_or_outsource` |
| 后端接收参数 | 支持驼峰和下划线 | `selfOrOutsource` 或 `self_or_outsource` |
| 前端数据模型 | 驼峰命名 | `selfOrOutsource` |

---

## 测试验证

### 新增工序测试
1. 打开工序页面：`http://localhost:3002/manufacturing/process`
2. 点击"新增工序"按钮
3. 填写工序信息，在"自制/外协"下拉框中选择"自制"或"外协"
4. 点击保存
5. 验证：表格中新增的工序显示对应的标签

### 编辑工序测试
1. 点击已有工序的"编辑"按钮
2. 修改"自制/外协"字段
3. 保存并验证更新成功

### 显示测试
- 自制：显示蓝色"自制"标签
- 外协：显示黄色"外协"标签
- 未设置：显示灰色"未设置"标签

---

## 涉及文件清单

### 前端文件
- `/07-frontend/src/pages/manufacturing/ProcessList.vue` - 工序列表页面

### 后端文件
- `/backend/routes/processes.js` - 工序路由接口

### 数据库
- 表：`processes`
- 新增字段：`self_or_outsource`

---

## 完成状态
✅ 数据库字段添加完成
✅ 前端表格列添加完成
✅ 前端表单字段添加完成
✅ 前端数据模型更新完成
✅ 后端CREATE接口更新完成
✅ 后端UPDATE接口更新完成
✅ 后端批量操作更新完成
✅ 后端服务已重启

---

**修复完成时间**: 2025-12-08 16:50
**状态**: ✅ 已完成并可正常使用
