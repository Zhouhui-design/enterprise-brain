# 工序页面"可用工位数量"字段完整实现

## 修复时间
2025-12-08 17:10 - 17:20

## 需求描述
在工序页面（http://localhost:3002/manufacturing/process）的主表格中增加"可用工位数量"字段，要求：
1. 输入正整数
2. 编辑之后保存的数据要能在查看页面看到
3. 能被跨表格引用

---

## 实施步骤

### 步骤1: 数据库添加字段

**执行SQL**:
```sql
ALTER TABLE processes 
ADD COLUMN available_workstations INT DEFAULT NULL 
COMMENT '可用工位数量' 
AFTER self_or_outsource;
```

**字段定义**:
- 字段名: `available_workstations`
- 类型: `INT`
- 默认值: `NULL`
- 位置: 在 `self_or_outsource` 字段之后

---

### 步骤2: 前端表格显示

**文件**: `/07-frontend/src/pages/manufacturing/ProcessList.vue`

**添加表格列** (第125行之后):
```vue
<el-table-column prop="availableWorkstations" label="可用工位数量" width="130" align="center" />
```

**显示效果**:
- 列宽: 130px
- 对齐方式: 居中
- 直接显示数字

---

### 步骤3: 前端编辑表单

**添加表单字段** (第197-203行之后):
```vue
<el-col :span="12">
  <el-form-item label="可用工位数量" prop="availableWorkstations">
    <el-input-number 
      v-model="formData.availableWorkstations" 
      :min="0" 
      :precision="0" 
      placeholder="请输入工位数量" 
      style="width: 100%;" 
    />
  </el-form-item>
</el-col>
```

**字段特性**:
- 组件: `el-input-number` (数字输入框)
- 最小值: 0 (只能输入正整数)
- 精度: 0 (不允许小数)
- 占位符: "请输入工位数量"

---

### 步骤4: 前端查看对话框

**添加显示项** (第253行之后):
```vue
<el-descriptions-item label="可用工位数量">{{ currentProcess.availableWorkstations || 0 }}</el-descriptions-item>
```

**显示规则**:
- 如果值为null或undefined，显示0
- 否则显示实际数值

---

### 步骤5: 前端数据模型

**更新formData** (第336-343行):
```javascript
const formData = ref({
  processCode: '',
  processName: '',
  processPrincipal: '',
  dispatchMethod: '',
  selfOrOutsource: '',
  availableWorkstations: 0,  // ✅ 新增
  isStorage: false,
  completionWarehouse: '',
  workshopName: '',
  processWage: 0
})
```

---

### 步骤6: 前端数据映射

#### 6.1 加载数据映射 (loadData函数)

```javascript
tableData.value = result.data.map(item => ({
  id: item.id,
  processCode: item.process_code,
  processName: item.process_name,
  processPrincipal: item.responsible_person,
  dispatchMethod: item.dispatch_method,
  selfOrOutsource: item.self_or_outsource || '',
  availableWorkstations: item.available_workstations || 0,  // ✅ 新增
  isStorage: item.is_warehousing === 1,
  completionWarehouse: item.completion_warehouse || '',
  workshopName: item.workshop_name,
  processWage: parseFloat(item.process_wage) || 0,
  createTime: new Date(item.created_at).toLocaleString('zh-CN'),
  updateTime: new Date(item.updated_at).toLocaleString('zh-CN')
}))
```

#### 6.2 新增数据初始化 (handleCreate函数)

```javascript
const handleCreate = () => {
  isEdit.value = false
  formData.value = {
    processCode: `P${new Date().getFullYear()}${String(nextProcessId.value).padStart(4, '0')}`,
    processName: '',
    processPrincipal: '',
    dispatchMethod: 'manual',
    selfOrOutsource: '',
    availableWorkstations: 0,  // ✅ 新增
    isStorage: false,
    completionWarehouse: '',
    workshopName: '',
    processWage: 0
  }
  editDialogVisible.value = true
}
```

#### 6.3 保存数据映射 (handleSave函数)

```javascript
const requestData = {
  process_code: formData.value.processCode,
  process_name: formData.value.processName,
  responsible_person: formData.value.processPrincipal,
  dispatch_method: formData.value.dispatchMethod,
  self_or_outsource: formData.value.selfOrOutsource || null,
  available_workstations: formData.value.availableWorkstations || null,  // ✅ 新增
  is_warehousing: formData.value.isStorage ? 1 : 0,
  completion_warehouse: formData.value.completionWarehouse || '',
  workshop_name: formData.value.workshopName,
  process_wage: formData.value.processWage || 0
}
```

---

### 步骤7: 后端CREATE接口

**文件**: `/backend/routes/processes.js`

**修改INSERT SQL** (第28-45行):
```javascript
const sql = `
  INSERT INTO processes (
    process_code, process_name, responsible_person, dispatch_method,
    self_or_outsource, available_workstations, is_warehousing, completion_warehouse, workshop_name, process_wage
  ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
`;

const [result] = await pool.execute(sql, [
  processData.process_code || processData.processCode,
  processData.process_name || processData.processName,
  processData.responsible_person || processData.responsiblePerson,
  processData.dispatch_method || processData.dispatchMethod,
  processData.self_or_outsource || processData.selfOrOutsource || null,
  processData.available_workstations || processData.availableWorkstations || null,  // ✅ 新增
  processData.is_warehousing || processData.isWarehousing || 0,
  processData.completion_warehouse || processData.completionWarehouse || '',
  processData.workshop_name || processData.workshopName,
  processData.process_wage || processData.processWage || 0
]);
```

---

### 步骤8: 后端UPDATE接口

**修改UPDATE SQL** (第167-184行):
```javascript
const sql = `
  UPDATE processes SET
    process_code = ?, process_name = ?, responsible_person = ?, dispatch_method = ?,
    self_or_outsource = ?, available_workstations = ?, is_warehousing = ?, completion_warehouse = ?, workshop_name = ?, process_wage = ?
  WHERE id = ?
`;

const [result] = await pool.execute(sql, [
  processData.process_code || processData.processCode,
  processData.process_name || processData.processName,
  processData.responsible_person || processData.responsiblePerson,
  processData.dispatch_method || processData.dispatchMethod,
  processData.self_or_outsource || processData.selfOrOutsource || null,
  processData.available_workstations || processData.availableWorkstations || null,  // ✅ 新增
  processData.is_warehousing || processData.isWarehousing || 0,
  processData.completion_warehouse || processData.completionWarehouse || '',
  processData.workshop_name || processData.workshopName,
  processData.process_wage || processData.processWage || 0,
  id
]);
```

---

## 数据流完整性验证

### 新增工序流程
1. 点击"新增工序"按钮
2. `formData.availableWorkstations` 初始化为 `0`
3. 用户在数字输入框输入工位数量（如：`5`）
4. 点击"保存"，前端将数据映射为 `available_workstations: 5`
5. 后端INSERT接口接收 `processData.available_workstations = 5`
6. 数据库写入 `available_workstations = 5`
7. 页面刷新，表格显示 `5`

### 编辑工序流程
1. 点击某工序的"编辑"按钮
2. `formData.value` = `{ ...row }` (包含 `availableWorkstations`)
3. 用户修改工位数量从 `5` → `10`
4. 点击"保存"，前端映射为 `available_workstations: 10`
5. 后端UPDATE接口更新数据库
6. 页面刷新，表格显示 `10`

### 查看工序流程
1. 点击工序的"查看"按钮
2. `currentProcess` 包含 `availableWorkstations` 字段
3. 查看对话框显示："可用工位数量: 10"

---

## 跨表引用支持

### 字段定义
- **数据库字段名**: `available_workstations`
- **前端驼峰命名**: `availableWorkstations`
- **数据类型**: `INT` (整数)

### 跨表引用方式

#### 方式1: 通过API接口
```javascript
// 其他页面引用工序数据
const response = await fetch('http://192.168.2.229:3005/api/processes/list')
const processes = await response.json()

// 使用可用工位数量
processes.data.forEach(process => {
  const workstations = process.available_workstations
  console.log(`${process.process_name} 有 ${workstations} 个工位`)
})
```

#### 方式2: 跨表查询 (SQL JOIN)
```sql
SELECT 
  p.process_code,
  p.process_name,
  p.available_workstations,
  other_table.field
FROM processes p
LEFT JOIN other_table ON other_table.process_code = p.process_code
WHERE p.available_workstations > 0;
```

#### 方式3: 前端Lookup匹配
```javascript
// 在其他页面中根据工序编号查找工位数量
const processMap = new Map()
processes.forEach(p => {
  processMap.set(p.process_code, p.available_workstations)
})

// 匹配使用
const workstations = processMap.get(currentProcessCode) || 0
```

---

## 测试验证

### 测试场景1: 新增工序并设置工位数量 ✅
1. 打开工序页面: `http://localhost:3002/manufacturing/process`
2. 点击"新增工序"
3. 填写工序信息，在"可用工位数量"输入 `8`
4. 点击"保存"
5. **验证1**: 提示"工序创建成功"
6. **验证2**: 表格中新工序的"可用工位数量"列显示 `8`

### 测试场景2: 编辑工序修改工位数量 ✅
1. 点击已有工序的"编辑"按钮
2. 将"可用工位数量"从 `8` 改为 `12`
3. 点击"保存"
4. **验证1**: 提示"工序更新成功"
5. **验证2**: 表格中该工序显示 `12`

### 测试场景3: 查看工序详情 ✅
1. 点击工序的"查看"按钮
2. **验证**: 查看对话框中显示"可用工位数量: 12"

### 测试场景4: 输入验证 ✅
1. 点击"编辑"，尝试输入负数 `-5`
2. **验证**: 自动纠正为 `0` (最小值限制)
3. 尝试输入小数 `5.5`
4. **验证**: 自动取整为 `6` (精度限制)

### 测试场景5: 跨表引用 ✅
1. 通过API获取工序列表
2. **验证**: 返回数据包含 `available_workstations` 字段
3. 在其他模块中根据工序编号查询工位数量
4. **验证**: 能正确获取对应的工位数量值

---

## 修改文件清单

### 数据库
- `enterprise_brain.processes` 表
  - 添加字段: `available_workstations INT DEFAULT NULL COMMENT '可用工位数量'`

### 前端文件
- `/07-frontend/src/pages/manufacturing/ProcessList.vue`
  - 添加表格列显示 (第125行)
  - 添加编辑表单字段 (第204-210行)
  - 添加查看对话框显示 (第260行)
  - 更新数据模型 `formData` (第339行)
  - 更新数据加载映射 (第723行)
  - 更新新增初始化 (第446行)
  - 更新保存请求映射 (第544行)

### 后端文件
- `/backend/routes/processes.js`
  - 修改CREATE接口SQL和参数 (第28-45行)
  - 修改UPDATE接口SQL和参数 (第167-184行)

---

## 完成状态

✅ 数据库字段已添加
✅ 前端表格显示已实现
✅ 前端编辑表单已添加
✅ 前端查看对话框已更新
✅ 数据模型已完善
✅ 前端数据映射已完成（加载、新增、保存）
✅ 后端CREATE接口已更新
✅ 后端UPDATE接口已更新
✅ 后端服务已重启
✅ 输入验证已配置（正整数限制）
✅ 支持跨表引用（API/SQL/前端Lookup）

---

## 字段命名对照表

| 层级 | 字段名 | 说明 |
|------|--------|------|
| 数据库 | `available_workstations` | 下划线命名（snake_case） |
| 后端接口 | `available_workstations` 或 `availableWorkstations` | 兼容两种命名 |
| 前端数据 | `availableWorkstations` | 驼峰命名（camelCase） |
| 前端显示 | "可用工位数量" | 中文标签 |

---

**实现完成时间**: 2025-12-08 17:20
**实现人**: AI助手
**状态**: ✅ 完全实现并验证通过
**支持跨表引用**: ✅ 是
