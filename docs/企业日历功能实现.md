# 企业日历功能实现文档

## 📋 功能概述

企业日历是一个基础数据管理模块，用于管理公司的工作日历，包括工作日、休息日、节假日和标准工时等信息。该模块支持跨表格引用，可被其他业务模块使用。

---

## ✅ 已实现功能

### 1. 核心功能
- ✅ 日历数据展示（显示未来N天的日期数据）
- ✅ 自动识别星期几
- ✅ 根据单休/双休自动标记工作日和休息日
- ✅ 中国法定节假日自动标记（2025年）
- ✅ 标准上班时长配置
- ✅ 支持手动调整工时
- ✅ 备注功能

### 2. 业务变量配置
- ✅ 系统日期前显示天数（默认90天）
- ✅ 系统日期后显示天数（默认365天）
- ✅ 标准上班时长（默认8小时）
- ✅ 休息模式（单休/双休，默认双休）

### 3. StandardTablePage组件集成
- ✅ **列拖拽功能**：支持通过拖拽调整列顺序
- ✅ **列显示/隐藏**：支持自定义显示哪些列
- ✅ **表头筛选**：支持按字段筛选数据
- ✅ **排序功能**：支持按日期等字段排序
- ✅ **分页功能**：支持分页显示，默认每页50条

### 4. 定时任务
- ✅ 每天凌晨0:00自动更新
  - 删除超出范围的过期数据
  - 自动生成新的日期数据
  - 更新工作日/休息日标记
  - 更新节假日信息

### 5. 数据筛选
- ✅ 日期范围筛选
- ✅ 默认显示从今天到未来N天的数据
- ✅ 历史数据通过筛选查询显示
- ✅ 超出配置范围的数据无法查询

---

## 🗂️ 数据库设计

### 表结构：`company_calendar`

```sql
CREATE TABLE company_calendar (
  id INT PRIMARY KEY AUTO_INCREMENT,
  calendar_date DATE NOT NULL UNIQUE COMMENT '日期',
  weekday VARCHAR(20) COMMENT '星期',
  is_workday TINYINT DEFAULT 1 COMMENT '休息/上班（0-休息，1-上班）',
  standard_work_hours DECIMAL(4,2) DEFAULT 8.00 COMMENT '标准上班时长（小时）',
  adjusted_work_hours DECIMAL(4,2) COMMENT '调整后工时（小时）',
  is_adjusted TINYINT DEFAULT 0 COMMENT '是否调整工时（0-否，1-是）',
  holiday_name VARCHAR(100) COMMENT '节假日名称',
  remark VARCHAR(500) COMMENT '备注',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_calendar_date (calendar_date),
  INDEX idx_is_workday (is_workday),
  INDEX idx_weekday (weekday)
);
```

### 页面设置：`page_settings`

```sql
-- 企业日历业务变量
('company-calendar', 'daysBeforeToday', '90')     -- 系统日期前显示天数
('company-calendar', 'daysAfterToday', '365')      -- 系统日期后显示天数
('company-calendar', 'standardWorkHours', '8')     -- 标准上班时长
('company-calendar', 'weekendMode', 'double')      -- 休息模式（single/double）
```

---

## 🔧 技术实现

### 后端API

#### 1. 获取日历列表
```
GET /api/company-calendar/list?page=1&pageSize=50&startDate=2025-12-01&endDate=2025-12-31
```

**响应**:
```json
{
  "code": 200,
  "data": {
    "records": [
      {
        "id": 1,
        "calendarDate": "2025-12-08",
        "weekday": "星期一",
        "isWorkday": 1,
        "standardWorkHours": 8.00,
        "adjustedWorkHours": null,
        "isAdjusted": 0,
        "holidayName": null,
        "remark": null
      }
    ],
    "total": 366,
    "page": 1,
    "pageSize": 50
  }
}
```

#### 2. 更新日历（调整工时）
```
PUT /api/company-calendar/update/:id
```

**请求体**:
```json
{
  "adjustedWorkHours": 10,
  "isAdjusted": true,
  "remark": "加班日"
}
```

#### 3. 获取/保存业务设置
```
GET  /api/company-calendar/settings/company-calendar
POST /api/company-calendar/settings/company-calendar
```

#### 4. 手动初始化日历数据
```
POST /api/company-calendar/init
```

### 前端页面

**文件路径**: `/07-frontend/src/pages/human-resources/CompanyCalendar.vue`

**路由**: `/human-resources/company-calendar`

**菜单位置**: 人事管理 > 企业日历

---

## 📊 主表格字段

| 字段名 | 说明 | 来源 |
|--------|------|------|
| 日期 | 日历日期 | 系统自动生成（从前N天到后N天） |
| 星期 | 星期几 | 系统自动计算 |
| 休息/上班 | 工作日标记 | 根据单休/双休+节假日自动生成 |
| 标准上班时长 | 默认工时 | 从业务变量获取 |
| 是否调整工时 | 手动调整标记 | 手动录入 |
| 调整后工时 | 调整后的工时 | 手动录入（当"是否调整"为是时） |
| 节假日 | 法定节假日名称 | 根据节假日配置自动生成 |
| 备注 | 备注信息 | 手动录入 |

---

## ⚙️ 业务规则

### 1. 数据显示范围

- **默认显示**: 从系统当天到未来365天（可配置）
- **历史数据**: 通过日期筛选查询前90天的数据（可配置）
- **超出范围**: 超出配置范围的数据无法筛选和查询

**示例**:
```
系统日期: 2025-12-08
配置: 前90天，后365天
有效范围: 2025-09-09 ~ 2026-12-07
默认显示: 2025-12-08 ~ 2026-12-07
可筛选范围: 2025-09-09 ~ 2026-12-07
```

### 2. 工作日判断规则

```javascript
// 单休模式（周日休息）
workday = 星期一~星期六 && 非节假日

// 双休模式（周六周日休息）
workday = 星期一~星期五 && 非节假日
```

### 3. 节假日配置（2025年）

- 元旦：1月1日
- 春节：1月28日-2月3日（7天）
- 清明节：4月4日-4月6日（3天）
- 劳动节：5月1日-5月3日（3天）
- 端午节：5月31日-6月2日（3天）
- 国庆节：10月1日-10月8日（8天）

### 4. 定时更新规则

**每天凌晨0:00自动执行**:

1. 删除超出范围的过期数据
   ```sql
   DELETE FROM company_calendar 
   WHERE calendar_date < (今天 - daysBeforeToday - 1)
   ```

2. 生成新的日期数据
   ```javascript
   for (let i = -daysBeforeToday; i <= daysAfterToday; i++) {
     const date = today + i天
     // 插入新数据（如果不存在）
   }
   ```

---

## 🎨 StandardTablePage组件使用

### ✅ 为什么列拖拽可用

1. **PageSettings组件已支持列拖拽**
   - 使用`vuedraggable`库实现
   - 提供拖拽手柄（Rank图标）
   - 自动保存列顺序到`localStorage`

2. **企业日历正确使用**
   ```vue
   <StandardTablePage
     settings-key="company-calendar"  <!-- 唯一标识 -->
     :columns="columns"               <!-- 列定义 -->
     @settings-save="handleSettingsSave"
   />
   ```

3. **验证方法**
   - 点击页面右上角"设置"按钮
   - 切换到"字段管理"标签
   - 拖拽字段调整顺序
   - 勾选/取消勾选控制显示/隐藏
   - 点击"保存"即可生效

### 🔍 为什么之前只有一个页面可以拖拽

**原因分析**:

1. **早期页面未使用StandardTablePage**
   - 大部分页面是手工编写的
   - 未集成PageSettings组件
   - 缺少vuedraggable依赖

2. **新页面使用StandardTablePage**
   - 自动集成PageSettings（包含列拖拽功能）
   - 无需额外开发
   - 功能一致性保证

3. **企业日历是新开发页面**
   - 严格遵循StandardTablePage规范
   - 自动获得所有标准功能
   - 包括列拖拽、筛选、排序、分页等

---

## 🔗 跨表格引用

企业日历可被其他页面引用，查询某日期的工作日信息：

### 查询示例

```javascript
// 查询某日期是否为工作日
const response = await fetch(
  `http://192.168.2.229:3005/api/company-calendar/list?startDate=2025-12-08&endDate=2025-12-08`
)
const result = await response.json()
const calendar = result.data.records[0]

console.log(`${calendar.calendarDate} 是${calendar.isWorkday ? '工作日' : '休息日'}`)
console.log(`标准工时：${calendar.standardWorkHours}小时`)
console.log(`节假日：${calendar.holidayName || '无'}`)
```

### 应用场景

- **排程系统**: 根据工作日安排生产计划
- **考勤系统**: 计算实际工作天数
- **薪资系统**: 区分工作日和加班日
- **项目管理**: 计算工作日工期

---

## 🚀 使用指南

### 1. 初始化数据

首次使用或修改业务变量后，需要初始化日历数据：

1. 点击"初始化日历数据"按钮
2. 系统会根据当前业务设置生成日期数据
3. 生成范围：系统日期前N天到后N天

### 2. 修改业务设置

1. 点击"业务设置"按钮
2. 修改以下参数：
   - 系统日期前显示天数
   - 系统日期后显示天数
   - 标准上班时长
   - 休息模式（单休/双休）
3. 点击"保存"
4. 设置将在下次凌晨0:00生效（或手动点击"初始化"立即生效）

### 3. 调整工时

1. 在表格中找到需要调整的日期
2. 点击"编辑"按钮
3. 勾选"是否调整工时"
4. 输入"调整后工时"
5. 填写备注（可选）
6. 点击"保存"

### 4. 筛选查询

1. 选择日期范围
2. 点击"搜索"
3. 查看筛选结果

---

## 📝 注意事项

1. **数据范围限制**
   - 只能查询配置范围内的数据
   - 超出范围的日期无法显示
   - 建议根据业务需求合理配置范围

2. **定时任务依赖**
   - 需确保后端服务持续运行
   - 定时任务每天0:00自动执行
   - 可通过"初始化"按钮手动触发

3. **节假日更新**
   - 当前仅配置2025年节假日
   - 每年需更新`HOLIDAYS_2025`配置
   - 建议改为数据库配置或调用API

4. **跨表引用**
   - 确保日期数据已生成
   - 注意日期格式统一（YYYY-MM-DD）
   - 处理节假日和调整工时的情况

---

## 🎯 后续优化建议

1. **节假日管理**
   - 增加节假日管理页面
   - 支持自定义节假日
   - 支持调休日配置

2. **工时模板**
   - 支持不同部门不同工时
   - 支持夏季/冬季工时切换
   - 支持弹性工作制

3. **数据导入导出**
   - 支持Excel导入日历数据
   - 支持导出年度日历
   - 支持批量调整工时

4. **可视化日历视图**
   - 增加月历视图
   - 增加周历视图
   - 节假日高亮显示

---

## 📂 相关文件

### 数据库
- `/db/migration/create_company_calendar_table.sql`

### 后端
- `/backend/routes/companyCalendar.js` - API路由
- `/backend/scheduledTasks.js` - 定时任务（含日历更新）
- `/backend/server.js` - 路由注册

### 前端
- `/07-frontend/src/pages/human-resources/CompanyCalendar.vue` - 页面组件
- `/07-frontend/src/router/modules/human-resources.js` - 路由配置

### 组件
- `/07-frontend/src/components/common/layout/StandardTablePage.vue` - 标准表格页面
- `/07-frontend/src/components/common/PageSettings.vue` - 页面设置（含列拖拽）

---

## ✅ 功能验证

1. **列拖拽功能** ✅
   - 打开企业日历页面
   - 点击右上角"设置"按钮
   - 切换到"字段管理"标签
   - 可以拖拽字段调整顺序
   - 可以勾选/取消勾选控制显示

2. **数据显示** ✅
   - 默认显示从今天到未来365天
   - 可通过日期筛选查询历史数据
   - 超出范围的数据无法查询

3. **业务设置** ✅
   - 可修改4个业务变量
   - 保存后提示将在凌晨生效
   - 可通过"初始化"立即生效

4. **定时任务** ✅
   - 每天凌晨0:00自动执行
   - 删除过期数据，生成新数据
   - 日志可查看执行情况

---

**开发完成时间**: 2025-12-08 18:30  
**开发状态**: ✅ 完成并验证通过  
**测试状态**: ✅ 所有功能正常
