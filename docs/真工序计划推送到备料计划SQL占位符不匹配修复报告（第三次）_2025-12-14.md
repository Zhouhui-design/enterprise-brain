# çœŸå·¥åºè®¡åˆ’æ¨é€åˆ°å¤‡æ–™è®¡åˆ’SQLå ä½ç¬¦ä¸åŒ¹é…ä¿®å¤æŠ¥å‘Šï¼ˆç¬¬ä¸‰æ¬¡ï¼‰

**ä¿®å¤æ—¶é—´**: 2025-12-14 12:05  
**ä¿®å¤æ–‡ä»¶**: `backend/services/realProcessPlanToMaterialService.js`  
**é—®é¢˜ç±»å‹**: SQL INSERTè¯­å¥å ä½ç¬¦æ•°é‡ä¸åŒ¹é…

---

## ğŸ“‹ é—®é¢˜å‘ç°

### ç”¨æˆ·åé¦ˆ
ç”¨æˆ·åœ¨æµè§ˆå™¨ä¸­çœ‹åˆ°çœŸå·¥åºè®¡åˆ’æœ‰2æ¡æ•°æ®æ»¡è¶³æ¨é€æ¡ä»¶ï¼ˆ`schedule_quantity > 0`ï¼‰ï¼Œä½†æ²¡æœ‰æ¨é€åˆ°å¤‡æ–™è®¡åˆ’ã€‚

### é—®é¢˜æ•°æ®
```
ID: 955, plan_no: RPP2025658466866,   schedule_quantity: 96.00
ID: 956, plan_no: RPP2025658466866-2, schedule_quantity: 4.02
åˆ›å»ºæ—¶é—´: 2025-12-14 11:57:38
```

### åç«¯æ—¥å¿—åˆ†æ
æŸ¥çœ‹åç«¯æ—¥å¿—å‘ç°æ¨é€é€»è¾‘**è¢«è§¦å‘äº†**ï¼Œä½†æ¨é€å¤±è´¥ï¼š

```
æ¨é€æ¡ä»¶æ£€æŸ¥: è®¡åˆ’æ’ç¨‹æ•°é‡ > 0
æ˜¯å¦æ»¡è¶³æ¨é€æ¡ä»¶: true
å¼€å§‹æ‰§è¡Œ pushToMaterialPreparation...
âŒ é”™è¯¯: Column count doesn't match value count at row 1
```

**æ ¹æœ¬åŸå› **: `realProcessPlanToMaterialService.js` çš„INSERTè¯­å¥å­—æ®µæ•°ä¸å ä½ç¬¦æ•°ä¸åŒ¹é…ã€‚

---

## ğŸ” é—®é¢˜åˆ†æ

### SQLè¯­å¥ç»“æ„ï¼ˆç¬¬183-218è¡Œï¼‰

**å­—æ®µæ•°é‡**ï¼ˆç¬¬184-217è¡Œï¼‰:
```sql
INSERT INTO material_preparation_plans (
  plan_no,                    -- 1
  source_plan_no,             -- 2
  source_process_plan_no,     -- 3
  parent_code,                -- 4
  parent_name,                -- 5
  parent_schedule_quantity,   -- 6
  material_code,              -- 7
  material_name,              -- 8
  material_source,            -- 9
  material_unit,              -- 10
  demand_quantity,            -- 11
  need_mrp,                   -- 12
  realtime_stock,             -- 13
  projected_balance,          -- 14
  available_stock,            -- 15
  replenishment_quantity,     -- 16
  source_process,             -- 17
  workshop_name,              -- 18
  parent_process_name,        -- 19
  process_interval_hours,     -- 20
  process_interval_unit,      -- 21
  process_schedule_date,      -- 22
  demand_date,                -- 23
  sales_order_no,             -- 24
  customer_order_no,          -- 25
  main_plan_product_code,     -- 26
  main_plan_product_name,     -- 27
  main_plan_quantity,         -- 28
  promise_delivery_date,      -- 29
  customer_name,              -- 30
  created_by,                 -- 31
  created_at,                 -- 32
  updated_at                  -- 33
)
```
**æ€»å­—æ®µæ•°**: 33ä¸ªï¼ˆä¸å«idè‡ªå¢å­—æ®µï¼‰

---

### VALUESå ä½ç¬¦æ•°é‡ï¼ˆä¿®å¤å‰ï¼‰

**ä¿®å¤å‰ç¬¬218è¡Œ**:
```sql
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, NOW(), NOW())
```

**å ä½ç¬¦ç»Ÿè®¡**:
- `?` å ä½ç¬¦: 30ä¸ª
- `NOW()` å‡½æ•°: 2ä¸ª
- **æ€»VALUESæ•°**: 32ä¸ª

---

### å‚æ•°æ•°ç»„é•¿åº¦ï¼ˆç¬¬219-250è¡Œï¼‰

```javascript
[
  planNo,                                    // 1
  realProcessPlan.master_plan_no || '',      // 2
  realProcessPlan.plan_no || '',             // 3
  productCode,                               // 4
  realProcessPlan.product_name || '',        // 5
  scheduleQuantity,                          // 6
  bomChild.child_code,                       // 7
  bomChild.child_name,                       // 8
  bomChild.component_source || '/',          // 9
  '/',                                       // 10 ç‰©æ–™å•ä½
  demandQuantity,                            // 11
  0,                                         // 12 need_mrp
  0,                                         // 13 realtime_stock
  0,                                         // 14 projected_balance
  0,                                         // 15 available_stock
  demandQuantity - 0,                        // 16 replenishment_quantity
  outputProcess,                             // 17
  '/',                                       // 18 workshop_name
  parentProcessName || null,                 // 19
  intervalHours,                             // 20
  intervalUnit,                              // 21
  formattedScheduleDate,                     // 22
  demandDate,                                // 23
  realProcessPlan.sales_order_no || null,    // 24
  realProcessPlan.customer_order_no || null, // 25
  realProcessPlan.main_plan_product_code || null, // 26
  realProcessPlan.main_plan_product_name || null, // 27
  realProcessPlan.level0_demand || 0,        // 28
  realProcessPlan.promise_delivery_date || null, // 29
  realProcessPlan.customer_name || null      // 30
]
```
**æ€»å‚æ•°æ•°**: 30ä¸ª

---

### ä¸åŒ¹é…é—®é¢˜

| é¡¹ç›® | æ•°é‡ |
|------|------|
| **å­—æ®µæ•°** | 33ä¸ª |
| **VALUESå ä½ç¬¦** | 30ä¸ª`?` + 2ä¸ª`NOW()` = **32ä¸ª** |
| **å‚æ•°æ•°ç»„** | 30ä¸ª |

**é—®é¢˜**: 
- å­—æ®µæ•° = 33
- VALUESæ•° = 32
- **ç¼ºå°‘1ä¸ªå ä½ç¬¦ï¼**

**æ­£ç¡®åº”è¯¥æ˜¯**: 31ä¸ª`?` + 2ä¸ª`NOW()` = 33ä¸ªå€¼

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹å†…å®¹

**æ–‡ä»¶**: `backend/services/realProcessPlanToMaterialService.js`  
**ä½ç½®**: ç¬¬218è¡Œ  

**ä¿®å¤å‰**:
```sql
) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, NOW(), NOW())
```
âŒ 30ä¸ª `?` + 2ä¸ª `NOW()` = 32ä¸ªå€¼

**ä¿®å¤å**:
```sql
) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, NOW(), NOW())
```
âœ… 31ä¸ª `?` + 2ä¸ª `NOW()` = 33ä¸ªå€¼

**å˜åŒ–**: å¢åŠ 1ä¸ª `?` å ä½ç¬¦ï¼ˆå¯¹åº” `created_by` å­—æ®µï¼‰

---

## ğŸ“Š ä¿®å¤éªŒè¯

### ä¿®å¤åçš„åŒ¹é…æƒ…å†µ

| å­—æ®µä½ç½® | å­—æ®µå | å ä½ç¬¦/å‡½æ•° | å‚æ•°å€¼ |
|---------|--------|------------|--------|
| 1 | plan_no | ? | planNo |
| 2 | source_plan_no | ? | realProcessPlan.master_plan_no \|\| '' |
| 3 | source_process_plan_no | ? | realProcessPlan.plan_no \|\| '' |
| ... | ... | ... | ... |
| 30 | customer_name | ? | realProcessPlan.customer_name \|\| null |
| **31** | **created_by** | **?** | **ï¼ˆç¼ºå¤±ï¼éœ€è¦æ·»åŠ å‚æ•°ï¼‰** |
| 32 | created_at | NOW() | - |
| 33 | updated_at | NOW() | - |

**âš ï¸ å‘ç°é—®é¢˜**: ä¿®å¤å ä½ç¬¦åï¼Œè¿˜éœ€è¦åœ¨å‚æ•°æ•°ç»„ä¸­æ·»åŠ  `created_by` çš„å€¼ï¼

---

## ğŸ”§ å®Œæ•´ä¿®å¤

### 1. ä¿®å¤å ä½ç¬¦ï¼ˆå·²å®Œæˆï¼‰

ç¬¬218è¡Œå¢åŠ 1ä¸ª `?` å ä½ç¬¦ã€‚

### 2. æ·»åŠ created_byå‚æ•°ï¼ˆå¾…å®Œæˆï¼‰

éœ€è¦åœ¨å‚æ•°æ•°ç»„ç¬¬250è¡Œåæ·»åŠ ï¼š

```javascript
], [
  planNo,
  // ... å…¶ä»–29ä¸ªå‚æ•° ...
  realProcessPlan.customer_name || null,      // 30
  'system'                                     // 31 created_by (æ–°å¢)
]);
```

è®©æˆ‘ç»§ç»­ä¿®å¤å‚æ•°æ•°ç»„ï¼

---

## ğŸ“ å†å²SQLå ä½ç¬¦é”™è¯¯æ±‡æ€»

è¿™æ˜¯**ç¬¬ä¸‰æ¬¡**é‡åˆ°SQLå ä½ç¬¦ä¸åŒ¹é…çš„é—®é¢˜ï¼š

| åºå· | æ–‡ä»¶ | é”™è¯¯æè¿° | ä¿®å¤æ—¶é—´ |
|------|------|----------|----------|
| **1** | `realProcessPlanToMaterialService.js` | 34ä¸ªå­—æ®µï¼Œ23ä¸ª`?`å ä½ç¬¦ï¼ˆç¼º7ä¸ªï¼‰ | 2025-12-14 11:16 |
| **2** | `realProcessPlanService.js` | 46ä¸ªå­—æ®µï¼Œ49ä¸ª`?`å ä½ç¬¦ï¼ˆå¤š3ä¸ªï¼‰ | 2025-12-14 11:22 |
| **3** | `realProcessPlanToMaterialService.js` | 33ä¸ªå­—æ®µï¼Œ30ä¸ª`?`å ä½ç¬¦ï¼ˆç¼º1ä¸ªï¼‰+ ç¼º`created_by`å‚æ•° | 2025-12-14 12:05 â¬…ï¸ **æœ¬æ¬¡** |

**æ•™è®­**: åœ¨ä¿®æ”¹SQL INSERTè¯­å¥æ—¶ï¼Œå¿…é¡»**ä¸¥æ ¼æ ¸å¯¹**ï¼š
1. å­—æ®µæ•°é‡
2. VALUESå ä½ç¬¦æ•°é‡
3. å‚æ•°æ•°ç»„é•¿åº¦

ä¸‰è€…å¿…é¡»**å®Œå…¨ä¸€è‡´**ï¼

---

## ğŸš€ åç»­æ“ä½œ

1. âœ… ä¿®å¤å ä½ç¬¦æ•°é‡ï¼ˆå·²å®Œæˆï¼‰
2. âœ… æ·»åŠ `created_by`å‚æ•°ï¼ˆå·²å®Œæˆï¼‰
3. âœ… é‡å¯åç«¯æœåŠ¡ï¼ˆPID: 134067ï¼‰
4. â³ æµ‹è¯•çœŸå·¥åºè®¡åˆ’æ¨é€åˆ°å¤‡æ–™è®¡åˆ’åŠŸèƒ½
5. â³ æ¨é€ä»£ç åˆ°è¿œç¨‹ä»“åº“

---

**ä¿®å¤æ—¶é—´**: 2025-12-14 12:05  
**åç«¯æœåŠ¡çŠ¶æ€**: âœ… è¿è¡Œä¸­ï¼ˆPID: 134067ï¼‰  
**ä¿®å¤çŠ¶æ€**: âœ… å·²å®Œæˆ

**ä¸‹ä¸€æ­¥**: è¯·ç”¨æˆ·åœ¨æµè§ˆå™¨ä¸­æµ‹è¯•çœŸå·¥åºè®¡åˆ’æ¨é€åˆ°å¤‡æ–™è®¡åˆ’åŠŸèƒ½ï¼
