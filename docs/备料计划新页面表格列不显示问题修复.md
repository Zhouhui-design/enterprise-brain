# 备料计划新页面表格列不显示问题修复报告

## 问题描述

**页面地址**：`http://localhost:3003/production-planning/material-preparation-new`

**现象**：
- 备料计划主表格所有字段都看不到
- 其他菜单、操作按钮都正常显示
- 只有选择列和操作列可见

---

## 问题分析

### 根本原因

在`MaterialPreparationPlanNew.vue`文件中，存在以下问题：

1. **列配置缺少`visible`属性**（第441-474行）
   - `defaultColumns`数组中的每个列配置对象没有`visible`属性
   - 例如：`{ prop: 'planNo', label: '备料计划编号', width: 160, filterable: true }`

2. **模板中有`visible`条件判断**（第53行）
   - 表格列渲染使用了`v-if="col.visible"`条件
   - 当`visible`属性不存在时，`col.visible`为`undefined`
   - `v-if="undefined"`等同于`v-if="false"`，导致所有列都被过滤

### 问题代码

**defaultColumns定义**（第441-474行）：
```javascript
const defaultColumns = [
  { prop: 'planNo', label: '备料计划编号', width: 160, filterable: true },
  // ❌ 缺少 visible: true
  // ... 其他32个列配置也缺少 visible 属性
]
```

**模板渲染逻辑**（第51-79行）：
```vue
<template v-for="col in visibleColumns" :key="col.prop">
  <el-table-column
    v-if="col.visible"  <!-- ❌ 这里会过滤掉所有 visible=undefined 的列 -->
    :prop="col.prop"
    :width="col.width"
    :fixed="col.prop === 'planNo' ? 'left' : undefined"
    :align="col.prop.includes('Quantity') ? 'right' : undefined"
    :formatter="getFormatter(col.prop)"
  >
    <!-- ... header template ... -->
  </el-table-column>
</template>
```

### 触发条件

这个问题是在添加"真工序计划排程日期"字段时引入的。修改了`defaultColumns`配置，但没有为每个列添加`visible: true`属性。

---

## 解决方案

### 修改内容

**文件**：`/07-frontend/src/pages/production-planning/MaterialPreparationPlanNew.vue`

**修改位置**：第441-474行

**修改前**：
```javascript
const defaultColumns = [
  { prop: 'planNo', label: '备料计划编号', width: 160, filterable: true },
  { prop: 'sourcePlanNo', label: '来源主计划编号', width: 160, filterable: true },
  // ... 其他30个列
]
```

**修改后**：
```javascript
const defaultColumns = [
  { prop: 'planNo', label: '备料计划编号', width: 160, filterable: true, visible: true },
  { prop: 'sourcePlanNo', label: '来源主计划编号', width: 160, filterable: true, visible: true },
  // ... 其他30个列都添加了 visible: true
]
```

### 修改说明

为`defaultColumns`数组中的所有32个列配置对象都添加了`visible: true`属性，确保：

1. 所有列默认可见
2. 通过"页面设置"可以控制列的显示/隐藏
3. `v-if="col.visible"`条件判断生效

---

## 技术细节

### 列配置结构

```javascript
{
  prop: string,          // 字段标识（必需）
  label: string,         // 列标题（必需）
  width: number,         // 列宽（必需）
  filterable: boolean,   // 是否支持表头筛选（必需）
  visible: boolean       // ✅ 是否可见（必需，之前缺少）
}
```

### 页面设置架构

该页面使用`usePageSettings` composable来管理列配置：

1. **初始化**：`initSettings(defaultColumns)` - 使用默认列配置初始化
2. **存储**：列配置保存在localStorage中，key为`material-preparation`
3. **计算**：`visibleColumns` computed属性返回排序后的列配置
4. **渲染**：模板使用`v-if="col.visible"`过滤可见列

### 为什么需要`visible`属性

1. **用户控制**：用户可通过"页面设置"对话框控制列的显示/隐藏
2. **个性化**：每个用户可以保存自己的列配置偏好
3. **灵活性**：支持动态调整列的显示状态

---

## 影响范围

### 修改文件
- `/07-frontend/src/pages/production-planning/MaterialPreparationPlanNew.vue`（1个文件）

### 影响功能
- ✅ 备料计划主表格列显示（修复）
- ✅ 表头筛选功能（恢复）
- ✅ 页面设置中的列管理（正常工作）

### 不影响
- ❌ 后端API
- ❌ 数据库
- ❌ 其他页面

---

## 验证方法

1. 访问页面：`http://localhost:3003/production-planning/material-preparation-new`
2. 检查主表格是否显示所有32个列
3. 验证表头筛选功能是否正常
4. 打开"页面设置"对话框，验证列管理功能

### 预期结果

| 验证项 | 预期结果 |
|--------|---------|
| 表格列显示 | 显示32个业务列 + 1个选择列 + 1个操作列 |
| 表头筛选 | 可筛选列显示搜索框，支持模糊搜索 |
| 页面设置 | 可通过"页面设置"控制列的显示/隐藏 |
| 列排序 | 可拖拽调整列的顺序 |

---

## 防止类似问题

### 最佳实践

1. **列配置规范**：
   ```javascript
   const defaultColumns = [
     { 
       prop: 'fieldName',      // ✅ 必需
       label: '字段标题',       // ✅ 必需
       width: 120,             // ✅ 必需
       filterable: true,       // ✅ 必需
       visible: true           // ✅ 必需 - 不要遗漏！
     }
   ]
   ```

2. **添加新列时的检查清单**：
   - [ ] `prop` - 字段标识
   - [ ] `label` - 列标题
   - [ ] `width` - 列宽
   - [ ] `filterable` - 是否可筛选
   - [ ] `visible` - 是否可见（默认true）

3. **代码审查**：
   - 检查所有列配置是否包含必需属性
   - 验证新增列是否正常显示

---

## 相关问题排查

如果将来再遇到"表格列不显示"的问题，按以下顺序排查：

1. **检查列配置**：
   - 是否所有列都有`visible: true`
   - 是否有拼写错误

2. **检查模板条件**：
   - 是否有`v-if="col.visible"`判断
   - 是否有其他过滤条件

3. **检查数据源**：
   - `columnConfigs`是否正确加载
   - `visibleColumns` computed是否返回数据

4. **检查localStorage**：
   - 清除浏览器localStorage中的列配置缓存
   - 刷新页面重新初始化

---

## 修复时间
2025-12-13

## 修复人员
AI Assistant (Qoder)

## 状态
✅ 已完成并验证
