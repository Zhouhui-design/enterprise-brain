# 工序计划表字段检查报告

**日期**: 2025-12-15 14:35  
**检查内容**: 主计划产品编号、主计划产品名称字段  
**检查范围**: 4个工序计划表

---

## 📊 检查结果总结

| 表名 | 主计划产品编号 | 主计划产品名称 | 数据记录数 | 状态 |
|------|---------------|---------------|-----------|------|
| `real_process_plans` | ❌ 缺失 | ❌ 缺失 | 2 | **需要添加** |
| `packing_process_plans` | ✅ 存在 | ✅ 存在 | 1 | 正常 |
| `assembly_process_plans` | ✅ 存在 | ✅ 存在 | 4 | 正常 |
| `sewing_process_plans` | ✅ 存在 | ✅ 存在 | 0 | 正常 |

---

## ❌ 发现问题

### 打包工序计划表（`real_process_plans`）缺少关键字段

**缺失字段**：
1. `master_plan_product_code` - 主计划产品编号
2. `master_plan_product_name` - 主计划产品名称

**影响**：
- ❌ 备料计划推送到打包工序计划时，无法填充主计划产品信息
- ❌ 无法追溯工序计划的源头产品
- ❌ 数据流规则不完整

**当前状态**：
- 表中有 **2条记录**
- 这2条记录缺少主计划产品信息

---

## ✅ 正常的表

### 1. 喷塑工序计划表（`packing_process_plans`）

**字段信息**：
```sql
• master_plan_product_code
  类型: varchar(50)
  允许NULL: YES
  默认值: 无

• master_plan_product_name
  类型: varchar(200)
  允许NULL: YES
  默认值: 无
```

**数据记录数**: 1条

---

### 2. 组装工序计划表（`assembly_process_plans`）

**字段信息**：
```sql
• master_plan_product_code
  类型: varchar(50)
  允许NULL: YES
  默认值: 无

• master_plan_product_name
  类型: varchar(200)
  允许NULL: YES
  默认值: 无
```

**数据记录数**: 4条

---

### 3. 缝纫工序计划表（`sewing_process_plans`）

**字段信息**：
```sql
• master_plan_product_code
  类型: varchar(50)
  允许NULL: YES
  默认值: 无

• master_plan_product_name
  类型: varchar(200)
  允许NULL: YES
  默认值: 无
```

**数据记录数**: 0条（新表，暂无数据）

---

## 🎯 推送规则说明

根据记忆中的备料计划推送规则：

```
备料计划 → 工序计划
├── 工序计划的"主计划产品编号" = 备料计划的"主计划产品编号"
└── 工序计划的"主计划产品名称" = 备料计划的"主计划产品名称"
```

**推送目标表**：
- 产出工序 = '打包' → 推送至 `packing_process_plans`（喷塑工序计划）
- 产出工序 = '组装' 且 需补货数量 > 0 → 推送至 `assembly_process_plans`（组装工序计划）
- 产出工序 = '缝纫' → 推送至 `sewing_process_plans`（缝纫工序计划）

**注意**：根据记忆，严禁推送到 `real_process_plans`（打包工序计划，原真工序计划）

---

## 🔧 修复建议

### 方案1：添加缺失字段

为 `real_process_plans` 表添加字段：

```sql
ALTER TABLE real_process_plans
ADD COLUMN master_plan_product_code VARCHAR(50) COMMENT '主计划产品编号' AFTER main_plan_product_code,
ADD COLUMN master_plan_product_name VARCHAR(200) COMMENT '主计划产品名称' AFTER master_plan_product_code;
```

**优点**：
- 保持所有工序计划表结构一致
- 支持完整的数据流规则
- 便于后续扩展

**缺点**：
- 现有2条记录的这两个字段为空，需要补充数据

---

### 方案2：确认是否需要

根据记忆，备料计划**严禁推送到真工序计划表**（`real_process_plans`），因为会导致工序能力负荷表的已占用工时计算错误。

**问题**：
- 如果备料计划不推送到 `real_process_plans`，是否需要这两个字段？
- 这两个字段是否用于其他业务场景？

---

## 📋 建议行动

### 1. 明确业务需求

**问题1**：`real_process_plans`（打包工序计划）是否接收备料计划推送？
- 如果**是** → 需要添加字段
- 如果**否** → 可以不添加，但需要确认现有数据来源

**问题2**：`real_process_plans` 中的2条数据是如何创建的？
- 手动创建？
- 其他数据流？
- 如果需要主计划产品信息，从哪里获取？

---

### 2. 数据一致性建议

为了保持**所有工序计划表结构一致**，建议：

✅ **添加字段**到 `real_process_plans` 表，即使当前不使用，也为未来扩展预留

**理由**：
1. 统一表结构，便于维护
2. 避免后续业务变更时再次修改表结构
3. 字段允许NULL，不影响现有数据

---

### 3. 字段映射规范

如果添加字段，需要在代码中配置映射：

**文件**: `backend/config/processTypes.js`

```javascript
'打包': {
  displayName: '打包工序计划',
  tableName: 'real_process_plans',  // 注意：数据库表名
  serviceName: 'realProcessPlanService',
  routeName: 'realProcessPlans',
  planPrefix: 'RPP',
  fields: {
    masterPlanProductCode: 'master_plan_product_code',  // ← 添加
    masterPlanProductName: 'master_plan_product_name'   // ← 添加
  }
}
```

---

## 🎯 下一步操作

请用户确认以下问题：

### 问题1：是否需要为 `real_process_plans` 表添加字段？
- [ ] 是，需要添加（保持表结构一致）
- [ ] 否，不需要添加（确认不会从备料计划推送数据）

### 问题2：现有数据如何处理？
如果添加字段：
- [ ] 保持现有2条记录的新字段为空
- [ ] 手动补充现有记录的主计划产品信息
- [ ] 删除现有记录，重新创建

### 问题3：备料计划推送规则确认
- [ ] 备料计划**绝对不会**推送到 `real_process_plans`
- [ ] 备料计划**可能会**推送到 `real_process_plans`（特定条件下）

---

## 📊 当前表结构对比

### `real_process_plans` 中**已有**的相关字段

根据数据库配置文件 `/backend/config/database.js`（第710行）：

```sql
main_plan_product_code VARCHAR(100) COMMENT '主计划产品编码'
main_plan_product_name VARCHAR(200) COMMENT '主计划产品名称'
```

**注意**：字段名是 `main_plan_product_code`，不是 `master_plan_product_code`

### 字段命名差异

| 表名 | 字段1命名 | 字段2命名 |
|------|----------|----------|
| `real_process_plans` | `main_plan_product_code` | `main_plan_product_name` |
| `packing_process_plans` | `master_plan_product_code` | `master_plan_product_name` |
| `assembly_process_plans` | `master_plan_product_code` | `master_plan_product_name` |
| `sewing_process_plans` | `master_plan_product_code` | `master_plan_product_name` |

**问题**：字段命名不一致！

- `real_process_plans` 使用 `main_plan_*`
- 其他表使用 `master_plan_*`

**建议**：统一字段命名为 `master_plan_*`

---

## ✅ 修复SQL脚本（如果确认需要修改）

### 选项1：重命名现有字段（推荐）

```sql
-- 将 main_plan_* 重命名为 master_plan_*，保持与其他表一致
ALTER TABLE real_process_plans
CHANGE COLUMN main_plan_product_code master_plan_product_code VARCHAR(100) COMMENT '主计划产品编码',
CHANGE COLUMN main_plan_product_name master_plan_product_name VARCHAR(200) COMMENT '主计划产品名称';
```

**优点**：
- 保持所有表字段命名一致
- 不丢失现有数据
- 代码修改最小

---

### 选项2：保留现有字段名

如果要保留 `main_plan_*` 字段名，需要修改代码中的映射配置。

---

## 📝 总结

### ✅ 已确认的事实

1. ✅ `packing_process_plans`（喷塑工序计划）有这两个字段
2. ✅ `assembly_process_plans`（组装工序计划）有这两个字段
3. ✅ `sewing_process_plans`（缝纫工序计划）有这两个字段
4. ❌ `real_process_plans`（打包工序计划）**缺少**这两个字段
5. ⚠️ `real_process_plans` 使用了不同的字段名：`main_plan_*` 而非 `master_plan_*`

### ⚠️ 需要用户确认

1. 是否需要统一字段命名为 `master_plan_*`？
2. 是否需要修改 `real_process_plans` 表结构？
3. 备料计划是否会推送到 `real_process_plans`？

---

**检查完成时间**: 2025-12-15 14:35  
**状态**: ✅ 检查完成，等待用户确认修复方案
