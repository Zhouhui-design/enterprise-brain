# çœŸå·¥åºè®¡åˆ’æ¨é€å·²å ç”¨å·¥æ—¶æ•°å€¼åŒ–åŒ¹é…ä¿®å¤æŠ¥å‘Š

## ä¿®å¤æ—¶é—´
2025-12-14

## é—®é¢˜èƒŒæ™¯

çœŸå·¥åºè®¡åˆ’æ¨é€è®¡åˆ’æ’ç¨‹å·¥æ—¶åˆ°å·¥åºèƒ½åŠ›è´Ÿè·è¡¨çš„"å·²å ç”¨å·¥æ—¶"å­—æ®µæ—¶ï¼ŒåŸæœ¬ä½¿ç”¨**å­—ç¬¦ä¸²åŒ¹é…**æ—¥æœŸï¼ˆé€šè¿‡ `formatLocalDate()` è½¬æ¢ä¸º YYYY-MM-DD æ ¼å¼ï¼‰ã€‚

ç”¨æˆ·æŒ‡å‡ºï¼šåº”è¯¥ä¸å‰ç«¯å·¥åºèƒ½åŠ›è´Ÿè·è¡¨ LOOKUP ä¼ä¸šæ—¥å†çš„é€»è¾‘ä¿æŒä¸€è‡´ï¼Œä½¿ç”¨**æ•°å€¼åŒ–æ—¥æœŸåŒ¹é…**ï¼ˆYYYYMMDDï¼‰ï¼Œé¿å…å­—ç¬¦ä¸²æ ¼å¼ä¸ä¸€è‡´é—®é¢˜ã€‚

## ä¿®å¤åŸåˆ™

**ä¸å‰ç«¯ä¿æŒä¸€è‡´ï¼šå‰åç«¯éƒ½ä½¿ç”¨æ•°å€¼åŒ–æ—¥æœŸåŒ¹é…ï¼**

### æ•°å€¼åŒ–åŒ¹é…çš„ä¼˜åŠ¿

| å¯¹æ¯”é¡¹ | å­—ç¬¦ä¸²åŒ¹é… | æ•°å€¼åŒ¹é… âœ… |
|--------|-----------|----------|
| æ—¶åŒºé—®é¢˜ | âŒ å®¹æ˜“å—toISOString()å½±å“ | âœ… ä¸æ¶‰åŠå­—ç¬¦ä¸²è½¬æ¢ |
| æ ¼å¼ä¸€è‡´æ€§ | âŒ å¤šç§æ ¼å¼ï¼ˆYYYY-MM-DDã€ISOç­‰ï¼‰ | âœ… ç»Ÿä¸€æ•°å€¼æ ¼å¼ |
| åŒ¹é…å‡†ç¡®æ€§ | âŒ æ ¼å¼ç¨æœ‰å·®å¼‚å°±å¤±è´¥ | âœ… æ•°å€¼ç²¾ç¡®åŒ¹é… |
| æ€§èƒ½ | âŒ å­—ç¬¦ä¸²æ¯”è¾ƒæ…¢ | âœ… æ•°å€¼æ¯”è¾ƒå¿« |
| å‰åç«¯ä¸€è‡´æ€§ | âŒ å‰ç«¯æ•°å€¼ã€åç«¯å­—ç¬¦ä¸² | âœ… å‰åç«¯ç»Ÿä¸€æ•°å€¼ |

## ä¿®å¤èŒƒå›´

### ä¿®æ”¹æ–‡ä»¶
`/home/sardenesy/ai_workspaces/ai_desktop_3/backend/services/realProcessPlanService.js`

### æ¶‰åŠæ–¹æ³•
1. **create** æ–¹æ³•ï¼ˆç¬¬336-399è¡Œï¼‰ï¼šçœŸå·¥åºè®¡åˆ’åˆ›å»ºåæ¨é€å·²å ç”¨å·¥æ—¶
2. **delete** æ–¹æ³•ï¼ˆç¬¬559-634è¡Œï¼‰ï¼šçœŸå·¥åºè®¡åˆ’åˆ é™¤åé‡ç½®å·²å ç”¨å·¥æ—¶ï¼ˆSUMIFï¼‰
3. **batchDelete** æ–¹æ³•ï¼ˆç¬¬688-749è¡Œï¼‰ï¼šæ‰¹é‡åˆ é™¤åæ‰¹é‡é‡ç½®å·²å ç”¨å·¥æ—¶ï¼ˆSUMIFï¼‰

## æ ¸å¿ƒä¿®å¤é€»è¾‘

### 1. create æ–¹æ³• - æ¨é€å·²å ç”¨å·¥æ—¶

**ä¿®æ”¹å‰ï¼ˆå­—ç¬¦ä¸²åŒ¹é…ï¼‰ï¼š**
```javascript
// âŒ è½¬æ¢ä¸ºå­—ç¬¦ä¸²
const scheduleDate = formatLocalDate(data.scheduleDate);  // "2025-12-20"

// âŒ ç”¨å­—ç¬¦ä¸²æŸ¥è¯¢
const [capacityRows] = await pool.execute(
  'SELECT id, work_shift, available_workstations, occupied_hours FROM process_capacity_load WHERE process_name = ? AND date = ?',
  [processName, scheduleDate]
);
```

**ä¿®æ”¹åï¼ˆæ•°å€¼åŒ¹é…ï¼‰ï¼š**
```javascript
// âœ… è½¬æ¢ä¸ºæ—¥æœŸå¯¹è±¡
const scheduleDateObj = data.scheduleDate instanceof Date ? 
  data.scheduleDate : new Date(data.scheduleDate);

// âœ… è½¬æ¢ä¸ºæ•°å€¼ (YYYYMMDD)
const scheduleDateNum = scheduleDateObj.getFullYear() * 10000 + 
                       (scheduleDateObj.getMonth() + 1) * 100 + 
                       scheduleDateObj.getDate();

// âœ… ç”¨æ•°å€¼æŸ¥è¯¢ï¼ˆMySQL SQL è®¡ç®—æ•°å€¼ï¼‰
const [capacityRows] = await pool.execute(
  `SELECT id, work_shift, available_workstations, occupied_hours, date,
          (YEAR(date) * 10000 + MONTH(date) * 100 + DAY(date)) as date_num
   FROM process_capacity_load 
   WHERE process_name = ? 
     AND (YEAR(date) * 10000 + MONTH(date) * 100 + DAY(date)) = ?`,
  [processName, scheduleDateNum]
);

console.log(`ğŸ”„ æ¨é€å·²æ’ç¨‹å·¥æ—¶åˆ°å·¥åºèƒ½åŠ›è´Ÿè·è¡¨: å·¥åº=${processName}, æ—¥æœŸæ•°å€¼=${scheduleDateNum}, æ’ç¨‹å·¥æ—¶=${scheduledHours}`);
console.log(`   æ—¥æœŸå¯¹è±¡: ${scheduleDateObj.toISOString().split('T')[0]}, æ•°å€¼: ${scheduleDateNum}`);
console.log(`   ç›®æ ‡è®°å½•: date=${record.date}, date_num=${record.date_num}`);
```

### 2. delete æ–¹æ³• - SUMIF é‡ç½®å·²å ç”¨å·¥æ—¶

**ä¿®æ”¹å‰ï¼ˆå­—ç¬¦ä¸²åŒ¹é…ï¼‰ï¼š**
```javascript
// âŒ è½¬æ¢ä¸ºå­—ç¬¦ä¸²
const scheduleDate = formatLocalDate(plan.schedule_date);

// âŒ SUMIF ç”¨å­—ç¬¦ä¸²æŸ¥è¯¢
const [sumRows] = await connection.execute(
  `SELECT COALESCE(SUM(scheduled_work_hours), 0) as total_hours 
   FROM real_process_plans 
   WHERE process_name = ? 
     AND DATE_FORMAT(schedule_date, '%Y-%m-%d') = ?`,
  [processName, scheduleDate]
);

// âŒ æŸ¥è¯¢å·¥åºèƒ½åŠ›è´Ÿè·è¡¨ä¹Ÿç”¨å­—ç¬¦ä¸²
const [capacityRows] = await connection.execute(
  'SELECT id, work_shift, available_workstations, occupied_hours FROM process_capacity_load WHERE process_name = ? AND date = ?',
  [processName, scheduleDate]
);
```

**ä¿®æ”¹åï¼ˆæ•°å€¼åŒ¹é…ï¼‰ï¼š**
```javascript
// âœ… è½¬æ¢ä¸ºæ•°å€¼
const scheduleDateObj = typeof plan.schedule_date === 'string' ? 
  new Date(plan.schedule_date) : plan.schedule_date;

const scheduleDateNum = scheduleDateObj.getFullYear() * 10000 + 
                       (scheduleDateObj.getMonth() + 1) * 100 + 
                       scheduleDateObj.getDate();

// âœ… SUMIF ç”¨æ•°å€¼æŸ¥è¯¢
const [sumRows] = await connection.execute(
  `SELECT COALESCE(SUM(scheduled_work_hours), 0) as total_hours 
   FROM real_process_plans 
   WHERE process_name = ? 
     AND (YEAR(schedule_date) * 10000 + MONTH(schedule_date) * 100 + DAY(schedule_date)) = ?`,
  [processName, scheduleDateNum]
);

// âœ… æŸ¥è¯¢å·¥åºèƒ½åŠ›è´Ÿè·è¡¨ä¹Ÿç”¨æ•°å€¼
const [capacityRows] = await connection.execute(
  `SELECT id, work_shift, available_workstations, occupied_hours, date,
          (YEAR(date) * 10000 + MONTH(date) * 100 + DAY(date)) as date_num
   FROM process_capacity_load 
   WHERE process_name = ? 
     AND (YEAR(date) * 10000 + MONTH(date) * 100 + DAY(date)) = ?`,
  [processName, scheduleDateNum]
);
```

### 3. batchDelete æ–¹æ³• - æ‰¹é‡ SUMIF é‡ç½®

**ä¿®æ”¹å‰ï¼š**
```javascript
// âŒ è®°å½•å—å½±å“çš„å·¥åº+æ—¥æœŸï¼ˆå­—ç¬¦ä¸²ï¼‰
if (plan.process_name && plan.schedule_date) {
  const scheduleDate = formatLocalDate(plan.schedule_date);
  affectedProcessDates.add(`${plan.process_name}|${scheduleDate}`);
}

// âŒ æ‰¹é‡é‡ç½®æ—¶ç”¨å­—ç¬¦ä¸²åˆ†å‰²
for (const key of affectedProcessDates) {
  const [processName, scheduleDate] = key.split('|');
  // ... å­—ç¬¦ä¸²æŸ¥è¯¢
}
```

**ä¿®æ”¹åï¼š**
```javascript
// âœ… è®°å½•å—å½±å“çš„å·¥åº+æ—¥æœŸï¼ˆæ•°å€¼ï¼‰
if (plan.process_name && plan.schedule_date) {
  const scheduleDateObj = typeof plan.schedule_date === 'string' ? 
    new Date(plan.schedule_date) : plan.schedule_date;
  
  const scheduleDateNum = scheduleDateObj.getFullYear() * 10000 + 
                         (scheduleDateObj.getMonth() + 1) * 100 + 
                         scheduleDateObj.getDate();
  
  affectedProcessDates.add(`${plan.process_name}|${scheduleDateNum}`);
}

// âœ… æ‰¹é‡é‡ç½®æ—¶ç”¨æ•°å€¼åˆ†å‰²
for (const key of affectedProcessDates) {
  const [processName, scheduleDateNumStr] = key.split('|');
  const scheduleDateNum = parseInt(scheduleDateNumStr);
  // ... æ•°å€¼æŸ¥è¯¢
}
```

## æ•°å€¼è½¬æ¢å…¬å¼

**ç»Ÿä¸€å…¬å¼ï¼ˆå‰åç«¯ä¸€è‡´ï¼‰ï¼š**
```javascript
const dateNum = year * 10000 + month * 100 + day

// ç¤ºä¾‹ï¼š
// 2025-12-20 â†’ 20251220
// 2026-01-05 â†’ 20260105
```

## MySQL SQL æ•°å€¼è®¡ç®—

```sql
-- å°† DATE ç±»å‹çš„å­—æ®µè½¬æ¢ä¸ºæ•°å€¼ï¼ˆYYYYMMDDï¼‰
YEAR(date) * 10000 + MONTH(date) * 100 + DAY(date)

-- ä½¿ç”¨åœºæ™¯1ï¼šWHERE æ¡ä»¶ï¼ˆæ¨é€/æŸ¥è¯¢æ—¶ï¼‰
WHERE process_name = ? 
  AND (YEAR(date) * 10000 + MONTH(date) * 100 + DAY(date)) = ?

-- ä½¿ç”¨åœºæ™¯2ï¼šSELECT è¿”å›å€¼ï¼ˆéªŒè¯åŒ¹é…ï¼‰
SELECT id, date,
       (YEAR(date) * 10000 + MONTH(date) * 100 + DAY(date)) as date_num
FROM process_capacity_load
```

## æ—¥å¿—æ”¹è¿›

**å¢å¼ºè°ƒè¯•ä¿¡æ¯ï¼š**
```javascript
// create æ–¹æ³•
console.log(`ğŸ”„ æ¨é€å·²æ’ç¨‹å·¥æ—¶åˆ°å·¥åºèƒ½åŠ›è´Ÿè·è¡¨: å·¥åº=${processName}, æ—¥æœŸæ•°å€¼=${scheduleDateNum}, æ’ç¨‹å·¥æ—¶=${scheduledHours}`);
console.log(`   åŸå§‹æ—¥æœŸå€¼: ${data.scheduleDate}, ç±»å‹: ${typeof data.scheduleDate}`);
console.log(`   æ—¥æœŸå¯¹è±¡: ${scheduleDateObj.toISOString().split('T')[0]}, æ•°å€¼: ${scheduleDateNum}`);
console.log(`âœ… å·²å ç”¨å·¥æ—¶æ›´æ–°æˆåŠŸ: ${previousOccupiedHours} â†’ ${newOccupiedHours} (å¢åŠ ${scheduledHours}å°æ—¶)`);
console.log(`   ç›®æ ‡è®°å½•: date=${record.date}, date_num=${record.date_num}`);

// delete æ–¹æ³•
console.log(`ğŸ”„ è‡ªåŠ¨é‡ç½®å·²å ç”¨å·¥æ—¶: å·¥åº=${processName}, æ—¥æœŸæ•°å€¼=${scheduleDateNum}`);
console.log(`âœ… å·²å ç”¨å·¥æ—¶é‡ç½®æˆåŠŸ: ${previousOccupiedHours} â†’ ${newOccupiedHours} (é‡Šæ”¾${(previousOccupiedHours - newOccupiedHours).toFixed(2)}å°æ—¶)`);
console.log(`   ç›®æ ‡è®°å½•: date=${record.date}, date_num=${record.date_num}`);

// batchDelete æ–¹æ³•
console.log(`âœ… [å·¥åº=${processName}, æ—¥æœŸæ•°å€¼=${scheduleDateNum}, date=${record.date}] ${previousOccupiedHours} â†’ ${newOccupiedHours}`);
```

## éªŒè¯æ­¥éª¤

### 1. åˆ›å»ºçœŸå·¥åºè®¡åˆ’æµ‹è¯•
```bash
# åˆ›å»ºçœŸå·¥åºè®¡åˆ’ï¼Œè®¡åˆ’æ’ç¨‹æ—¥æœŸ=2025-12-20ï¼Œè®¡åˆ’æ’ç¨‹å·¥æ—¶=8
curl -X POST http://localhost:3005/api/real-process-plan/create \
  -H "Content-Type: application/json" \
  -d '{
    "processName": "å†²åºŠ",
    "scheduleDate": "2025-12-20",
    "scheduledWorkHours": 8
  }'

# æŸ¥çœ‹æ—¥å¿—ï¼ˆåº”è¯¥è¾“å‡ºæ•°å€¼åŒ–åŒ¹é…æ—¥å¿—ï¼‰
# ğŸ”„ æ¨é€å·²æ’ç¨‹å·¥æ—¶åˆ°å·¥åºèƒ½åŠ›è´Ÿè·è¡¨: å·¥åº=å†²åºŠ, æ—¥æœŸæ•°å€¼=20251220, æ’ç¨‹å·¥æ—¶=8
# âœ… å·²å ç”¨å·¥æ—¶æ›´æ–°æˆåŠŸ: 0 â†’ 8 (å¢åŠ 8å°æ—¶)
# ç›®æ ‡è®°å½•: date=2025-12-20, date_num=20251220
```

### 2. å·¥åºèƒ½åŠ›è´Ÿè·è¡¨éªŒè¯
```bash
# æŸ¥è¯¢å·¥åºèƒ½åŠ›è´Ÿè·è¡¨
curl http://localhost:3005/api/capacity-load/list?processName=å†²åºŠ&date=2025-12-20

# é¢„æœŸç»“æœï¼š
# date: "2025-12-20"
# occupied_hours: 8  â† åº”è¯¥å¢åŠ äº†8å°æ—¶
```

### 3. åˆ é™¤æµ‹è¯•ï¼ˆSUMIF é‡ç½®ï¼‰
```bash
# åˆ é™¤çœŸå·¥åºè®¡åˆ’
curl -X DELETE http://localhost:3005/api/real-process-plan/delete/1

# æŸ¥çœ‹æ—¥å¿—
# ğŸ”„ è‡ªåŠ¨é‡ç½®å·²å ç”¨å·¥æ—¶: å·¥åº=å†²åºŠ, æ—¥æœŸæ•°å€¼=20251220
# SUMIFæŸ¥è¯¢ç»“æœ: 0, æ–°å ç”¨å·¥æ—¶: 0
# âœ… å·²å ç”¨å·¥æ—¶é‡ç½®æˆåŠŸ: 8 â†’ 0 (é‡Šæ”¾8å°æ—¶)
# ç›®æ ‡è®°å½•: date=2025-12-20, date_num=20251220
```

### 4. æ‰¹é‡åˆ é™¤æµ‹è¯•
```bash
curl -X POST http://localhost:3005/api/real-process-plan/batch-delete \
  -H "Content-Type: application/json" \
  -d '{"ids": [1, 2, 3]}'

# æŸ¥çœ‹æ—¥å¿—
# ğŸ”„ æ‰¹é‡é‡ç½® 3 ä¸ªå·¥åº+æ—¥æœŸçš„å·²å ç”¨å·¥æ—¶
# âœ… [å·¥åº=å†²åºŠ, æ—¥æœŸæ•°å€¼=20251220, date=2025-12-20] 8 â†’ 0
```

## ç›¸å…³è®°å¿†æ›´æ–°

å·²æ›´æ–°è®°å¿†æ¡ç›®ï¼š
- **`æ—¥æœŸåŒ¹é…ä½¿ç”¨æ•°å€¼åŒ–è€Œéå­—ç¬¦ä¸²åŒ¹é…è§„èŒƒ`**ï¼ˆmemory id: 8f33d851-22a6-46ca-8d78-8b82f0aed557ï¼‰
  - æ–°å¢åº”ç”¨åœºæ™¯ï¼šçœŸå·¥åºè®¡åˆ’ â†’ å·¥åºèƒ½åŠ›è´Ÿè·è¡¨æ¨é€å·²å ç”¨å·¥æ—¶

## å½±å“èŒƒå›´

### ç›´æ¥å½±å“
- âœ… çœŸå·¥åºè®¡åˆ’åˆ›å»ºæ—¶æ¨é€å·²å ç”¨å·¥æ—¶ï¼ˆæ•°å€¼åŒ¹é…ï¼‰
- âœ… çœŸå·¥åºè®¡åˆ’åˆ é™¤æ—¶ SUMIF é‡ç½®å·²å ç”¨å·¥æ—¶ï¼ˆæ•°å€¼åŒ¹é…ï¼‰
- âœ… çœŸå·¥åºè®¡åˆ’æ‰¹é‡åˆ é™¤æ—¶ SUMIF æ‰¹é‡é‡ç½®ï¼ˆæ•°å€¼åŒ¹é…ï¼‰

### é—´æ¥å½±å“
- âœ… å·¥åºèƒ½åŠ›è´Ÿè·è¡¨çš„å·²å ç”¨å·¥æ—¶æ•°æ®å‡†ç¡®æ€§æå‡
- âœ… å‰©ä½™å·¥æ—¶ã€å‰©ä½™æ—¶æ®µè®¡ç®—å‡†ç¡®æ€§æå‡
- âœ… å‰åç«¯æ—¥æœŸåŒ¹é…é€»è¾‘ç»Ÿä¸€ï¼Œé™ä½ç»´æŠ¤æˆæœ¬

### æ— å½±å“
- âŒ å…¶ä»–é¡µé¢çš„æ—¥æœŸæŸ¥è¯¢ï¼ˆéœ€å•ç‹¬è¯„ä¼°æ˜¯å¦éœ€è¦æ•°å€¼åŒ–ï¼‰
- âŒ æ•°æ®åº“è¡¨ç»“æ„ï¼ˆdate å­—æ®µä»ä¸º DATE ç±»å‹ï¼‰
- âŒ å‰ç«¯å·¥åºèƒ½åŠ›è´Ÿè·è¡¨é€»è¾‘ï¼ˆå·²ç»æ˜¯æ•°å€¼åŒ–ï¼Œæ— éœ€æ”¹åŠ¨ï¼‰

## æ¶æ„ä¼˜åŒ–

**å»ºè®®ï¼šåˆ›å»ºç»Ÿä¸€çš„æ—¥æœŸæ•°å€¼åŒ–å·¥å…·**

```javascript
// backend/utils/dateHelper.jsï¼ˆå»ºè®®åˆ›å»ºï¼‰
/**
 * å°†æ—¥æœŸè½¬æ¢ä¸ºæ•°å€¼ (YYYYMMDD)
 * @param {Date|string} date - æ—¥æœŸå¯¹è±¡æˆ–å­—ç¬¦ä¸²
 * @returns {number} - æ•°å€¼å½¢å¼çš„æ—¥æœŸ
 */
function dateToNumber(date) {
  const dateObj = date instanceof Date ? date : new Date(date);
  return dateObj.getFullYear() * 10000 + 
         (dateObj.getMonth() + 1) * 100 + 
         dateObj.getDate();
}

/**
 * MySQL SQL ç‰‡æ®µï¼šå°† DATE å­—æ®µè½¬æ¢ä¸ºæ•°å€¼
 * @param {string} fieldName - æ•°æ®åº“å­—æ®µå
 * @returns {string} - SQL ç‰‡æ®µ
 */
function dateFieldToNumberSQL(fieldName) {
  return `(YEAR(${fieldName}) * 10000 + MONTH(${fieldName}) * 100 + DAY(${fieldName}))`;
}

module.exports = {
  dateToNumber,
  dateFieldToNumberSQL
};

// ä½¿ç”¨ç¤ºä¾‹
const { dateToNumber, dateFieldToNumberSQL } = require('../utils/dateHelper');

const scheduleDateNum = dateToNumber(data.scheduleDate);
const sql = `SELECT * FROM table WHERE process_name = ? AND ${dateFieldToNumberSQL('date')} = ?`;
```

## æ€»ç»“

âœ… **æ¨é€è§„åˆ™å®Œå…¨æ­£ç¡®ï¼**

1. **æ¥æºæ—¥æœŸæ•°å€¼åŒ–**ï¼š`scheduleDateNum = year * 10000 + month * 100 + day`
2. **ç›®æ ‡æ—¥æœŸæ•°å€¼åŒ–**ï¼š`YEAR(date) * 10000 + MONTH(date) * 100 + DAY(date)`
3. **æ•°å€¼ç²¾ç¡®åŒ¹é…**ï¼šé¿å…å­—ç¬¦ä¸²æ ¼å¼ä¸ä¸€è‡´é—®é¢˜
4. **å‰åç«¯ç»Ÿä¸€**ï¼šä¸å‰ç«¯å·¥åºèƒ½åŠ›è´Ÿè·è¡¨ LOOKUP ä¼ä¸šæ—¥å†é€»è¾‘å®Œå…¨ä¸€è‡´
5. **æ—¥å¿—å®Œå–„**ï¼šè¾“å‡ºæ•°å€¼åŒ–åŒ¹é…çš„è¯¦ç»†ä¿¡æ¯ï¼Œæ–¹ä¾¿è°ƒè¯•

**è¿™æ˜¯ç»§å·¥åºèƒ½åŠ›è´Ÿè·è¡¨ LOOKUP ä¼ä¸šæ—¥å†ä¹‹åçš„ç¬¬äºŒä¸ªæ•°å€¼åŒ–åŒ¹é…åº”ç”¨ï¼** ğŸ‰
