# 客户交期格式与计划入库日期计算实施报告

## 📋 需求概述

### 需求1：订单列表客户交期格式调整
- **页面**：http://localhost:3002/sales/orders/list
- **字段**：客户交期（customerDelivery）
- **调整**：格式改为"年-月-日"（YYYY-MM-DD）

### 需求2：主生产计划入库日期自动计算
- **页面**：http://localhost:3002/production-planning/plan-list
- **字段**：计划入库日期（plannedStorageDate）
- **计算公式**：计划入库日期 = 订单承诺交期 - 提前入库期
- **提前入库期来源**：页面设置 → 业务变量 → settings.advanceStorageDays

---

## 🔧 实施内容

### 1️⃣ 订单列表客户交期格式调整

#### ✅ 前端修改（SalesOrderListNew.vue）

**修改1：表格列添加格式化模板（第100-104行）**

```vue
<!-- 修改前 -->
<el-table-column prop="customerDelivery" label="客户交期" width="120" />

<!-- 修改后 -->
<el-table-column prop="customerDelivery" label="客户交期" width="120">
  <template #default="{ row }">
    {{ formatDateYMD(row.customerDelivery) }}
  </template>
</el-table-column>
```

**修改2：添加日期格式化函数（第721-738行）**

```javascript
// ✅ 格式化日期为年月日
const formatDateYMD = (dateStr) => {
  if (!dateStr) return '-'
  try {
    const date = new Date(dateStr)
    if (isNaN(date.getTime())) return '-'
    const year = date.getFullYear()
    const month = String(date.getMonth() + 1).padStart(2, '0')
    const day = String(date.getDate()).padStart(2, '0')
    return `${year}-${month}-${day}`
  } catch (e) {
    return '-'
  }
}
```

**效果**：
- 之前：`2025-12-15T00:00:00.000Z` 或 `Sun Dec 15 2025`
- 现在：`2025-12-15` ✅

---

### 2️⃣ 主生产计划入库日期自动计算

#### ✅ 后端修改（masterProductionPlans.js）

**修改1：接收提前入库期参数（第36-46行）**

```javascript
router.post('/from-sales-order', async (req, res) => {
  try {
    const { salesOrders, advanceStorageDays } = req.body; // ✅ 接收提前入库期
    
    if (!salesOrders || !Array.isArray(salesOrders) || salesOrders.length === 0) {
      return res.status(400).json({
        code: 400,
        message: '请至少选择一个销售订单'
      });
    }
    
    console.log('📝 从销售订单创建主生产计划，数量:', salesOrders.length);
    console.log('📅 提前入库期:', advanceStorageDays, '天'); // ✅ 日志输出
```

**修改2：计算计划入库日期（第67-81行）**

```javascript
// 格式化日期
const promisedDeliveryDate = formatDateForMySQL(order.promisedDeliveryDate || order.customerDeliveryDate);

// ✅ 计算计划入库日期 = 承诺交期 - 提前入库期
let plannedStorageDate = null;
if (promisedDeliveryDate && advanceStorageDays !== undefined && advanceStorageDays !== null) {
  const deliveryDate = new Date(promisedDeliveryDate);
  deliveryDate.setDate(deliveryDate.getDate() - parseInt(advanceStorageDays || 0));
  plannedStorageDate = formatDateForMySQL(deliveryDate);
  
  console.log('📅 计划入库日期计算:', {
    承诺交期: promisedDeliveryDate,
    提前天数: advanceStorageDays,
    计划入库日期: plannedStorageDate
  });
}
```

**修改3：使用计算后的日期（第162行）**

```javascript
const [result] = await connection.execute(`
  INSERT INTO master_production_plans (
    plan_code, product_code, product_name, order_quantity,
    salesperson, sales_unit, available_stock, current_stock,
    plan_quantity, product_image, output_process, promised_delivery_date,
    status, planned_storage_date, product_source,
    internal_order_no, customer_order_no,
    created_at, updated_at
  ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, NOW(), NOW())
`, [
  planCode,
  product.productCode || '',
  product.productName || '',
  orderQuantity,
  order.salesperson || '',
  product.productUnit || '',
  availableStock,
  0, // 实时库存暂为0
  planQuantity,
  productImage,
  product.outputProcess || '',
  promisedDeliveryDate,
  '已下单',
  plannedStorageDate, // ✅ 计划入库日期（承诺交期 - 提前天数）
  productSource,
  order.internalOrderNo || '',
  order.customerOrderNo || ''
]);
```

#### ✅ 前端修改（SalesOrderListNew.vue）

**修改：正式下单时传递提前入库期（第1281-1295行）**

```javascript
console.log('📦 构造的销售订单数据:', salesOrders)

// ✅ 获取提前入库期设置
const advanceStorageDays = settings.value.advanceStorageDays || 0;
console.log('📅 提前入库期:', advanceStorageDays, '天');

// 调用后端API创建主生产计划
const response = await fetch('http://192.168.2.229:3005/api/master-production-plans/from-sales-order', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({ 
    salesOrders,
    advanceStorageDays // ✅ 传递提前入库期
  })
})
```

---

## 📊 数据流

### 完整的数据流

```
1️⃣ 页面设置
   用户设置：提前入库期 = 3天
   ↓
   保存到：settings.advanceStorageDays

2️⃣ 正式下单
   订单承诺交期：2025-12-20
   提前入库期：3天
   ↓
   前端读取：settings.advanceStorageDays = 3
   ↓
   传递给后端：{ salesOrders, advanceStorageDays: 3 }

3️⃣ 后端计算
   承诺交期：2025-12-20
   减去天数：3天
   ↓
   计划入库日期 = 2025-12-17 ✅

4️⃣ 保存到数据库
   master_production_plans.planned_storage_date = '2025-12-17'

5️⃣ 主生产计划列表
   显示：计划入库日期 = 2025-12-17
```

---

## 🧮 计算示例

### 示例1：正常计算

**输入**：
- 订单承诺交期：2025-12-20
- 提前入库期：3天

**计算过程**：
```javascript
const deliveryDate = new Date('2025-12-20');
deliveryDate.setDate(deliveryDate.getDate() - 3);
// 结果：2025-12-17
```

**输出**：
- 计划入库日期：2025-12-17 ✅

---

### 示例2：跨月计算

**输入**：
- 订单承诺交期：2025-12-02
- 提前入库期：5天

**计算过程**：
```javascript
const deliveryDate = new Date('2025-12-02');
deliveryDate.setDate(deliveryDate.getDate() - 5);
// 结果：2025-11-27
```

**输出**：
- 计划入库日期：2025-11-27 ✅

---

### 示例3：提前入库期为0

**输入**：
- 订单承诺交期：2025-12-20
- 提前入库期：0天（未设置）

**计算过程**：
```javascript
const deliveryDate = new Date('2025-12-20');
deliveryDate.setDate(deliveryDate.getDate() - 0);
// 结果：2025-12-20
```

**输出**：
- 计划入库日期：2025-12-20 ✅

---

## 🧪 测试验证

### 测试步骤1：客户交期格式验证

1. **访问订单列表**：http://localhost:3002/sales/orders/list

2. **检查客户交期列**：
   - 格式应为：`2025-12-15` ✅
   - 无日期时显示：`-`
   - 日期无效时显示：`-`

3. **预期效果**：
   | 订单编号 | 客户交期 | 格式 |
   |---------|---------|------|
   | SO202512070001 | 2025-12-15 | ✅ 年-月-日 |
   | SO202512070002 | 2025-12-20 | ✅ 年-月-日 |
   | SO202512070003 | - | ✅ 空值显示 |

---

### 测试步骤2：计划入库日期计算验证

#### 准备工作

1. **设置提前入库期**：
   - 访问订单列表：http://localhost:3002/sales/orders/list
   - 点击右上角"设置"按钮（⚙️）
   - 业务变量 → 提前入库期 → 输入：`3`
   - 保存设置

2. **创建测试订单**：
   - 新增订单
   - 承诺交期：2025-12-20
   - 添加产品

#### 执行测试

3. **正式下单**：
   - 勾选测试订单
   - 点击"正式下单"按钮
   - 确认推送

4. **查看控制台日志**：

**前端日志**：
```javascript
📅 提前入库期: 3 天
📦 构造的销售订单数据: [...]
```

**后端日志**：
```javascript
📝 从销售订单创建主生产计划，数量: 1
📅 提前入库期: 3 天

📅 计划入库日期计算: {
  承诺交期: "2025-12-20",
  提前天数: 3,
  计划入库日期: "2025-12-17"
}

✅ 成功创建主生产计划: 1 条
```

5. **验证主生产计划**：
   - 访问主生产计划列表：http://localhost:3002/production-planning/plan-list
   - 查看新创建的计划
   - **验证字段**：
     - 订单承诺交期：2025-12-20
     - **计划入库日期**：2025-12-17 ✅
     - 差值：3天 ✅

#### 数据库验证

```sql
SELECT 
  plan_code,
  product_code,
  promised_delivery_date,
  planned_storage_date,
  DATEDIFF(promised_delivery_date, planned_storage_date) AS days_diff
FROM master_production_plans
WHERE plan_code = 'MPS2025120700XX'
ORDER BY created_at DESC
LIMIT 1;

-- 预期结果：
-- plan_code: MPS2025120700XX
-- product_code: 6002A0203
-- promised_delivery_date: 2025-12-20
-- planned_storage_date: 2025-12-17    ✅
-- days_diff: 3                        ✅
```

---

## 🎯 关键改进点

### 1. 客户交期显示优化

**之前**：
- 显示格式不一致（可能是时间戳、ISO格式等）
- 用户阅读困难

**现在**：
- 统一格式：YYYY-MM-DD
- 清晰易读 ✅

---

### 2. 计划入库日期自动化

**之前**：
- 计划入库日期为空（null）
- 需要手动设置

**现在**：
- 自动计算：承诺交期 - 提前入库期
- 支持动态配置提前天数
- 自动保存到数据库 ✅

---

### 3. 业务流程完整性

**完整的入库计划流程**：
```
页面设置（提前入库期）
    ↓
销售订单（承诺交期）
    ↓
正式下单（自动计算）
    ↓
主生产计划（计划入库日期）
    ↓
备料计划（需求日期）
    ↓
工序计划（开工日期）
```

---

## 📂 修改文件清单

### 前端文件
- ✅ `/07-frontend/src/pages/sales/sales-order/SalesOrderListNew.vue`
  - 第100-104行：客户交期列添加格式化模板
  - 第721-738行：添加formatDateYMD函数
  - 第1281-1295行：正式下单传递advanceStorageDays

### 后端文件
- ✅ `/backend/routes/masterProductionPlans.js`
  - 第36-46行：接收advanceStorageDays参数
  - 第67-81行：计算计划入库日期逻辑
  - 第162行：INSERT使用计算后的plannedStorageDate

### 数据库
- ✅ `master_production_plans` 表
  - 字段：planned_storage_date（已存在，无需修改）

### 文档
- ✅ `/docs/客户交期格式与计划入库日期计算实施报告.md` - 本文档

---

## ✅ 修复完成清单

- [x] 客户交期列添加格式化显示
- [x] 添加formatDateYMD日期格式化函数
- [x] 后端接收advanceStorageDays参数
- [x] 后端实现计划入库日期计算逻辑
- [x] 前端正式下单传递提前入库期
- [x] 添加详细的控制台日志
- [x] 重启后端服务
- [x] 创建实施文档

---

## 🚀 后续应用场景

### 1. 备料计划需求日期

当主生产计划执行排程推送到备料计划时，需求日期可以参考计划入库日期：
```javascript
// 备料计划需求日期 = 主计划入库日期
demandDate = plannedStorageDate
```

### 2. 工序计划开工日期

根据计划入库日期反推工序开工日期：
```javascript
// 开工日期 = 计划入库日期 - 生产周期
startDate = plannedStorageDate - productionCycle
```

### 3. 采购计划交付日期

根据计划入库日期确定采购物料的交付日期：
```javascript
// 采购交付日期 = 计划入库日期 - 采购提前期
purchaseDeliveryDate = plannedStorageDate - purchaseLeadTime
```

---

## 📞 技术支持

### 问题排查

1. **客户交期显示异常**
   - 检查原始数据格式
   - 确认formatDateYMD函数正常
   - 查看浏览器控制台错误

2. **计划入库日期为空**
   - 检查提前入库期是否设置
   - 查看后端日志确认计算过程
   - 确认承诺交期是否有效

3. **计算结果不正确**
   - 验证提前入库期值
   - 检查日期计算逻辑
   - 查看后端控制台日志

### 调试SQL

```sql
-- 检查主生产计划的日期字段
SELECT 
  plan_code,
  product_code,
  product_name,
  promised_delivery_date,
  planned_storage_date,
  DATEDIFF(promised_delivery_date, planned_storage_date) AS advance_days,
  created_at
FROM master_production_plans
ORDER BY created_at DESC
LIMIT 10;

-- 检查异常数据（计划入库日期晚于承诺交期）
SELECT 
  plan_code,
  promised_delivery_date,
  planned_storage_date
FROM master_production_plans
WHERE planned_storage_date > promised_delivery_date;
```

---

## 🔗 相关文档

- [主生产计划执行排程产出工序字段映射报告.md](./主生产计划执行排程产出工序字段映射报告.md)
- [主生产计划产出工序字段完整实现报告.md](./主生产计划产出工序字段完整实现报告.md)
- [正式下单多产品订单修复报告.md](./正式下单多产品订单修复报告.md)

---

**实施时间**: 2025-12-07 16:07  
**实施人员**: AI Assistant  
**影响范围**: 
- 销售订单列表客户交期显示
- 主生产计划计划入库日期自动计算
**风险等级**: 低（仅优化显示格式和自动计算，不影响现有数据）  
**测试状态**: 待用户验证
