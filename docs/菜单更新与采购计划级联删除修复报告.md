# 菜单更新与采购计划级联删除修复报告

**修复日期**: 2025-12-17  
**修复人员**: AI Assistant  
**相关需求**: 菜单优化与数据级联删除

---

## 📋 需求概述

### 需求1：销售订单删除时采购计划同步删除
- **现象**: 删除销售订单时，采购计划未被同步删除
- **要求**: 删除销售订单时需触发采购计划的级联删除

### 需求2：更新打包工序计划菜单
- **现状**: `/process-planning/real-process-plan` 旧路由仍在菜单中显示
- **要求**: 禁用旧路由，添加新的打包工序计划菜单项

### 需求3：更新喷塑工序计划菜单
- **现状**: `/production-planning/packing-process-plan` 路由名称混淆
- **要求**: 禁用旧菜单，添加真正的喷塑工序计划页面

---

## 🔍 问题分析

### 需求1分析：采购计划级联删除

**代码审查结果**：
- ✅ 级联删除逻辑**已存在**于 `backend/routes/salesOrders.js` 第621-626行
- ✅ 删除SQL语句正确：`DELETE FROM procurement_plans WHERE sales_order_no = ?`
- ✅ 匹配字段：`sales_order_no = internal_order_no`

**代码位置**：
```javascript
// backend/routes/salesOrders.js : 621-626行
const [procurementPlanResult] = await connection.execute(
  'DELETE FROM procurement_plans WHERE sales_order_no = ?',
  [internalOrderNo]
);

console.log(`✅ 级联删除采购计划: ${procurementPlanResult.affectedRows} 条`);
```

**结论**：**功能已实现**，如仍未触发，可能是：
1. 后端服务未重启，使用旧代码
2. 前端调用了错误的删除接口
3. 数据库中`procurement_plans`表的字段名不匹配

### 需求2&3分析：菜单路由混淆

**历史问题**：
1. 旧打包工序计划：`/process-planning/real-process-plan` → 使用`real_process_plans`表
2. 新打包工序计划：`/production-planning/packing-process-plan` → 使用`PackingProcessPlanList.vue`
3. 旧喷塑工序计划：同样使用 `/production-planning/packing-process-plan` 路径（命名冲突）
4. 新喷塑工序计划：应使用`/production-planning/spray-painting-process-plan`

**根本原因**：工序计划表重构后，菜单配置未及时更新

---

## ✅ 修复方案

### 修复1：验证采购计划级联删除

**验证步骤**：
1. 检查后端代码：已确认级联删除逻辑存在
2. 确认数据库表结构：
   ```sql
   SELECT COLUMN_NAME FROM INFORMATION_SCHEMA.COLUMNS 
   WHERE TABLE_NAME = 'procurement_plans' AND COLUMN_NAME = 'sales_order_no';
   ```
3. 测试删除流程：
   - 创建测试销售订单
   - 查看是否生成采购计划
   - 删除销售订单
   - 验证采购计划是否被删除

**预期结果**：删除销售订单后，关联的采购计划应同步删除

### 修复2&3：更新菜单配置并添加详细注释

**修改文件**：`07-frontend/src/layout/index.vue`

**修改内容**：
```javascript
// ========================================
// ⛔ 已禁用：旧的打包工序计划菜单
// 路由：/process-planning/real-process-plan
// 原因：该路径为历史遗留路由，已迁移至新路径
// 禁用时间：2025-12-17
// 替代方案：使用下方新的打包工序计划菜单
// ========================================
// {
//   path: '/process-planning/real-process-plan',
//   name: 'RealProcessPlanList',
//   meta: { title: '打包工序计划(旧-已禁用)' },
//   icon: 'el-icon-s-claim'
// },

// ✅ 当前启用：新的打包工序计划菜单
{
  path: '/production-planning/packing-process-plan',
  name: 'PackingProcessPlanList',
  meta: { title: '打包工序计划' },
  icon: 'el-icon-box'
},

// ========================================
// ⛔ 已禁用：旧的喷塑工序计划配置（路径冲突）
// 路由：/production-planning/packing-process-plan
// 原因：与打包工序路径冲突，命名混淆
// 禁用时间：2025-12-17
// 替代方案：使用下方独立的喷塑工序计划菜单
// ========================================
// {
//   path: '/production-planning/packing-process-plan',
//   name: 'PackingProcessPlanList',
//   meta: { title: '喷塑工序计划(旧-已禁用)' },
//   icon: 'el-icon-box'
// },

// ✅ 当前启用：新的喷塑工序计划菜单
{
  path: '/production-planning/spray-painting-process-plan',
  name: 'SprayPaintingProcessPlanList',
  meta: { title: '喷塑工序计划' },
  icon: 'el-icon-brush'
},
```

**注释规范说明**：
- 使用分隔线 `========================================` 清晰标识禁用区域
- ⛔ 符号表示已禁用
- ✅ 符号表示当前启用
- 每个禁用项包含完整信息：
  - 路由路径
  - 禁用原因
  - 禁用时间
  - 替代方案

**修改行数**：
- 第595-630行（菜单配置区域）
- 增加详细注释说明
- 确保未来维护时不会混淆

---

## 📊 影响范围

### 前端变更
- ✅ 菜单结构调整
- ✅ 路由名称规范化
- ✅ 图标优化（喷塑使用brush图标）

### 后端变更
- ⚠️ 无变更（级联删除逻辑已存在）
- ℹ️ 建议重启后端服务确保使用最新代码

### 数据库变更
- ⚠️ 无变更
- ℹ️ 需确认`procurement_plans`表存在`sales_order_no`字段

---

## 🧪 验证清单

### ✅ 前端验证
1. [ ] 左侧菜单中不再显示旧的`/process-planning/real-process-plan`
2. [ ] 点击"打包工序计划"跳转到`/production-planning/packing-process-plan`
3. [ ] 点击"喷塑工序计划"跳转到`/production-planning/spray-painting-process-plan`
4. [ ] 页面能正常加载和显示数据

### ✅ 后端验证
1. [ ] 创建销售订单SO202500001
2. [ ] 确认下单后生成采购计划（查询`procurement_plans`表）
3. [ ] 删除销售订单SO202500001
4. [ ] 检查数据库：关联采购计划已被删除
5. [ ] 后端日志显示：`✅ 级联删除采购计划: X 条`

---

## 📝 相关文件清单

### 已修改文件
- `07-frontend/src/layout/index.vue` - 菜单配置更新

### 相关文件（无需修改）
- `backend/routes/salesOrders.js` - 级联删除逻辑
- `07-frontend/src/pages/production-planning/PackingProcessPlanList.vue` - 打包工序计划页面
- `07-frontend/src/pages/production-planning/SprayPaintingProcessPlanList.vue` - 喷塑工序计划页面

---

## ⚠️ 注意事项

1. **采购计划删除问题排查**：
   - 如删除销售订单后采购计划仍存在，请检查：
     - 后端服务是否已重启
     - 数据库字段名是否为`sales_order_no`
     - 前端调用的删除接口是否正确

2. **菜单缓存**：
   - 修改菜单后需刷新浏览器（Ctrl+F5）
   - 清除localStorage缓存

3. **路由命名规范**：
   - 打包工序计划：`PackingProcessPlanList`（packing = 打包）
   - 喷塑工序计划：`SprayPaintingProcessPlanList`（spray painting = 喷塑）
   - 组装工序计划：`AssemblyProcessPlanList`（assembly = 组装）

---

## 🎯 后续建议

1. **统一命名规范**：建议建立工序计划命名对照表，避免中英文混淆
2. **代码注释**：在工序配置文件中添加详细注释，说明各表对应关系
3. **测试用例**：编写自动化测试，验证级联删除逻辑
4. **文档维护**：更新系统架构文档，记录工序计划表结构变更历史

---

## ✅ 修复完成确认

- [x] 菜单配置已更新
- [ ] 前端页面验证通过（需用户测试）
- [ ] 采购计划级联删除验证通过（需用户测试）
- [ ] 所有工序计划页面功能正常（需用户测试）

**下一步操作**：
1. 重启前后端服务
2. 清除浏览器缓存
3. 测试销售订单删除功能
4. 验证菜单跳转是否正确

---

**报告生成时间**: 2025-12-17 15:10  
**报告版本**: v1.0
