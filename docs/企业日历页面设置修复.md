# 企业日历页面设置修复

## 📋 问题描述

用户反馈企业日历页面存在两个问题：

1. **页面设置Tab缺失**：缺少流程设置、编码设置、字段管理、打印设置、导出设置、业务变量等Tab
2. **字段拖拽不生效**：在页面设置中拖拽调整字段顺序后，主表格中的字段顺序没有更新

---

## 🔍 根本原因分析

### 问题1：页面设置Tab缺失

**原因**：StandardTablePage组件的`:show-page-settings`属性未启用，导致页面设置按钮不显示。

**代码位置**：`07-frontend/src/pages/human-resources/CompanyCalendar.vue`（第2-14行）

### 问题2：字段拖拽不生效

**原因**：
1. PageSettings组件保存时已正确保存字段顺序到localStorage
2. 但CompanyCalendar页面的`handleSettingsSave`函数只处理了业务变量，**未更新columns的顺序**
3. StandardTablePage使用computed的`visibleColumns`，依赖于`columns` prop，需要重新赋值才能触发响应式更新

**关键逻辑**：
```javascript
// StandardTablePage.vue
const visibleColumns = computed(() => {
  return props.columns.filter(col => col.visible !== false)
})
```

---

## ✅ 解决方案

### 修复1：启用页面设置按钮

**文件**：`07-frontend/src/pages/human-resources/CompanyCalendar.vue`

**修改**（第10行）：
```vue
<!-- 修改前 -->
<StandardTablePage
  page-title="企业日历"
  settings-key="company-calendar"
  :table-data="tableData"
  :columns="columns"
  @settings-save="handleSettingsSave"
>

<!-- 修改后 -->
<StandardTablePage
  page-title="企业日历"
  settings-key="company-calendar"
  :table-data="tableData"
  :columns="columns"
  :show-page-settings="true"  ✅ 新增
  @settings-save="handleSettingsSave"
>
```

**效果**：页面右上角显示齿轮图标，点击打开页面设置对话框，包含所有Tab：
- ✅ 流程设置
- ✅ 编码设置
- ✅ 字段管理（支持拖拽）
- ✅ 打印设置
- ✅ 导出设置
- ✅ 业务变量

---

### 修复2：实现字段顺序同步

**文件**：`07-frontend/src/pages/human-resources/CompanyCalendar.vue`

**修改**（第454-516行）：

```javascript
// 修改前：只处理业务变量
const handleSettingsSave = async (settings) => {
  try {
    const response = await fetch(
      'http://192.168.2.229:3005/api/company-calendar/settings/company-calendar',
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(settings.businessVars || {})
      }
    )
    const result = await response.json()
    if (result.code === 200) {
      ElMessage.success('保存成功')
    }
  } catch (error) {
    ElMessage.error('保存失败')
  }
}

// 修改后：同时处理字段顺序和业务变量
const handleSettingsSave = async (settings) => {
  try {
    // ✅ 更新字段顺序
    if (settings.fields && settings.fields.length > 0) {
      console.log('✅ 收到字段设置:', settings.fields.map(f => f.label).join(', '))
      
      // 创建prop到字段的映射
      const fieldMap = new Map()
      columns.value.forEach(col => {
        fieldMap.set(col.prop, col)
      })
      
      // 按照新顺序重排columns
      const newColumns = []
      settings.fields.forEach(field => {
        const column = fieldMap.get(field.prop)
        if (column) {
          newColumns.push({
            ...column,
            visible: field.visible !== false  // 更新可见性
          })
        }
      })
      
      // 添加不在settings中的字段（防止丢失）
      columns.value.forEach(col => {
        if (!newColumns.find(nc => nc.prop === col.prop)) {
          newColumns.push(col)
        }
      })
      
      columns.value = newColumns  // 🔥 关键：重新赋值触发响应式更新
      console.log('✅ 字段顺序已更新:', columns.value.map(c => c.label).join(', '))
    }
    
    // 保存业务变量到后端
    if (settings.businessVars) {
      const response = await fetch(
        'http://192.168.2.229:3005/api/company-calendar/settings/company-calendar',
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(settings.businessVars)
        }
      )
      
      const result = await response.json()
      
      if (result.code === 200) {
        ElMessage.success('保存成功，设置将在下次凌晨0:00更新时生效')
        loadData()
      } else {
        ElMessage.error(result.message || '保存失败')
      }
    } else {
      ElMessage.success('字段设置已保存')
    }
  } catch (error) {
    console.error('保存设置失败:', error)
    ElMessage.error('保存设置失败')
  }
}
```

---

## 🔑 关键技术点

### 1. Vue 3响应式原理

**问题**：为什么不能用`columns.value.sort()`或`columns.value[i] = newColumn`？

**答案**：
- `ref`对象的响应式基于**整体赋值**，而不是数组内部元素变化
- 必须使用`columns.value = newArray`触发依赖更新
- `computed`才会重新计算`visibleColumns`

### 2. 字段顺序映射算法

```javascript
// 步骤1：建立prop → column的映射
const fieldMap = new Map()
columns.value.forEach(col => fieldMap.set(col.prop, col))

// 步骤2：按settings.fields顺序重建
const newColumns = []
settings.fields.forEach(field => {
  const column = fieldMap.get(field.prop)
  if (column) newColumns.push(column)
})

// 步骤3：添加未在settings中的字段（防止丢失）
columns.value.forEach(col => {
  if (!newColumns.find(nc => nc.prop === col.prop)) {
    newColumns.push(col)
  }
})

// 步骤4：重新赋值触发响应式
columns.value = newColumns
```

### 3. PageSettings数据结构

**保存的settings对象结构**：
```javascript
{
  // 字段管理
  fields: [
    { prop: 'calendarDate', label: '日期', visible: true },
    { prop: 'weekday', label: '星期', visible: true },
    { prop: 'isWorkday', label: '休息/上班', visible: false }
  ],
  visibleFields: ['calendarDate', 'weekday'],
  
  // 业务变量
  businessVars: {
    daysBeforeToday: 90,
    daysAfterToday: 365,
    standardWorkHours: 8,
    weekendMode: 'double'
  },
  
  // 其他设置
  approvalFlow: 'single',
  requireApproval: false,
  // ...
}
```

---

## 📊 验证测试

### 测试1：页面设置是否显示所有Tab

✅ **测试步骤**：
1. 访问 http://localhost:3002/human-resources/company-calendar
2. 点击右上角齿轮图标
3. 检查是否显示所有Tab

✅ **预期结果**：
显示以下6个Tab：
- 流程设置
- 编码设置
- 字段管理
- 打印设置
- 导出设置
- 业务变量

### 测试2：字段拖拽是否生效

✅ **测试步骤**：
1. 打开页面设置 → 字段管理
2. 拖拽"星期"字段到最后
3. 点击保存
4. 刷新页面

✅ **预期结果**：
- 主表格中"星期"列移到最后
- localStorage中保存了新顺序
- 控制台输出：`✅ 字段顺序已更新: 日期, 休息/上班, 标准上班时长, ..., 星期`

### 测试3：字段显示/隐藏是否生效

✅ **测试步骤**：
1. 打开字段管理，取消勾选"备注"
2. 点击保存
3. 检查主表格

✅ **预期结果**：
- 主表格中不显示"备注"列
- 再次打开字段管理，"备注"仍然未勾选

---

## 🎯 涉及文件

| 文件路径 | 修改内容 | 行数变化 |
|---------|---------|---------|
| `07-frontend/src/pages/human-resources/CompanyCalendar.vue` | 启用页面设置+字段顺序同步 | +54 -15 |

---

## 📝 后续建议

### 1. 通用化字段顺序同步逻辑

当前实现是在CompanyCalendar页面中手动处理，建议：

**方案A**：在StandardTablePage中自动处理
```javascript
// StandardTablePage.vue
watch(() => settingsValue.value?.fields, (newFields) => {
  if (newFields && newFields.length > 0) {
    emit('update:columns', reorderColumns(props.columns, newFields))
  }
})
```

**方案B**：创建Composable
```javascript
// useColumnOrder.js
export function useColumnOrder(columns, settingsKey) {
  const handleSettingsSave = (settings) => {
    if (settings.fields) {
      columns.value = reorderColumns(columns.value, settings.fields)
    }
  }
  return { handleSettingsSave }
}
```

### 2. 性能优化

当前每次保存都重建整个columns数组，对于大型表格可能有性能问题。建议：

```javascript
// 使用Vue 3的shallowRef减少深度响应式开销
import { shallowRef } from 'vue'
const columns = shallowRef([...])

// 或使用markRaw标记不需要响应式的数据
const columns = ref(markRaw([...]))
```

### 3. 字段缺失保护

当前已实现"添加不在settings中的字段"，但可以增强错误提示：

```javascript
// 添加缺失字段时记录日志
columns.value.forEach(col => {
  if (!newColumns.find(nc => nc.prop === col.prop)) {
    console.warn(`⚠️ 字段 "${col.label}" 不在设置中，已自动添加`)
    newColumns.push(col)
  }
})
```

---

## ✅ 修复完成

企业日历页面现在完全支持：
- ✅ 所有页面设置Tab（流程、编码、字段管理、打印、导出、业务变量）
- ✅ 字段拖拽调整顺序，实时同步到主表格
- ✅ 字段显示/隐藏控制
- ✅ 设置持久化到localStorage
- ✅ 刷新后保持用户自定义设置

修复时间：2025-12-08 18:40
修复人员：AI助手
