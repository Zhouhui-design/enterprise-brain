# 备料计划自动推送到工序计划功能说明

## 功能概述
实现了从主生产计划 → 备料计划 → 工序计划的完整自动化数据流水线。

## 完整数据流

```
销售订单（正式下单）
    ↓
主生产计划
    ↓ 执行排程
备料计划（自动创建）
    ↓ 自动推送（新功能）
工序计划（自动创建）
```

## 触发条件

### 触发时机
- **任何方式创建备料计划时自动触发**：
  1. 主生产计划执行排程时创建备料计划
  2. 手动新增备料计划
  3. 导入备料计划
  4. API调用创建备料计划

### 推送条件
1. ✅ 备料计划编号不为空（系统自动生成）
2. ✅ 备料计划成功创建

## 数据映射规则

### 主生产计划 → 备料计划
| 备料计划字段 | 映射规则 | 来源字段 |
|-------------|---------|---------|
| 备料计划编号 | 系统自动生成 | `MPP{年份}{时间戳}{随机数}` |
| 来源主计划编号 | = | 主生产计划编号 |
| 来源工序计划编号 | 固定值 | "/" |
| 来源工序 | = | 产出工序 |
| 计划物料编号 | = | 产品编号 |
| 计划物料名称 | = | 产品名称 |
| 物料来源 | = | 产品来源 |
| 物料单位 | = | 销售单位 |
| 需求数量 | = | 计划数量 |
| 需求日期 | = | 计划入库日期 |
| 销售订单编号 | = | 内部销售订单编号 |
| 客户订单编号 | = | 客户订单编号 |
| 客户名称 | = | 客户名称 |
| 提交人 | = | 提交人 |
| 提交时间 | 系统生成 | NOW() |

### 备料计划 → 工序计划（自动推送）
| 工序计划字段 | 映射规则 | 来源字段 |
|-------------|---------|---------|
| 工序计划编号 | 系统自动生成 | `PP{年份}{时间戳}{随机数}` |
| 销售订单编号 | = | 内部销售订单编号 |
| 主生产计划编号 | = | 主生产计划编号 |
| 生产产品编号 | = | 产品编号 |
| 生产产品名称 | = | 产品名称 |
| 工序名称 | = | 产出工序 |
| 产品单位 | = | 销售单位 |
| 0阶需求数量 | = | 计划数量 |
| 计划完工日期 | 计算 | 计划入库日期 - 1天 |
| 客户名称 | = | 客户名称 |
| 提交人 | = | 提交人（默认admin） |
| 提交时间 | 系统生成 | NOW() |

## 实现细节

### 后端接口
**路径**: `POST /api/master-production-plans/:id/execute-schedule`

**处理流程**:
1. 查询主生产计划详情
2. 生成备料计划编号
3. 创建备料计划记录
4. **✅ 自动推送**: 如果备料计划编号不为空，立即创建工序计划
5. 返回结果（包含备料计划和工序计划数量）

**关键代码**:
```javascript
// 4. ✅ 自动推送备料计划到工序计划（当备料计划编号不为空时）
if (materialPlanNo) {
  console.log('🔄 开始自动推送到工序计划...');
  
  // 生成工序计划编号
  processPlanNo = `PP${year}${timestamp}${random}`;
  
  // 计算计划完工日期 = 需求日期 - 1天
  let completionDate = null;
  if (plan.planned_storage_date) {
    const demandDate = new Date(plan.planned_storage_date);
    demandDate.setDate(demandDate.getDate() - 1);
    completionDate = `${year}-${month}-${day}`;
  }
  
  // 创建工序计划
  await pool.execute(`
    INSERT INTO process_plans (
      plan_no, sales_order_no, master_plan_no,
      product_code, product_name, process_name,
      product_unit, level0_demand, completion_date,
      customer_name, submitted_by, submitted_at
    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, NOW())
  `, [...]);
}
```

### 前端展示
**文件**: `07-frontend/src/pages/production-planning/ProductionPlanList.vue`

**成功提示**:
```javascript
this.$message.success(
  `排程执行成功！\n` +
  `生成备料计划: ${result.materialPlanCount || 0} 条\n` +
  `生成工序计划: ${result.processPlanCount || 0} 条`
);
```

## 操作步骤

### 用户操作流程
1. 进入主生产计划列表页面 (`/production-planning/plan-list`)
2. 选择一条主生产计划（勾选框）
3. 点击"执行排程"按钮
4. 确认排程信息
5. 系统自动完成：
   - ✅ 生成1条备料计划
   - ✅ 自动推送生成1条工序计划
6. 查看结果：
   - 备料计划页面 (`/production-planning/material-preparation`)
   - 工序计划页面 (`/production-planning/process-plan`)

## 验证方法

### 1. 检查备料计划
访问: `http://localhost:3002/production-planning/material-preparation`

**验证字段**:
- ✅ 备料计划编号（如 MPP2025123456789）
- ✅ 来源主计划编号
- ✅ 来源工序
- ✅ 计划物料编号/名称
- ✅ 需求数量
- ✅ 需求日期

### 2. 检查工序计划
访问: `http://localhost:3002/production-planning/process-plan`

**验证字段**:
- ✅ 工序计划编号（如 PP2025123456789）
- ✅ 销售订单编号
- ✅ 主生产计划编号
- ✅ 生产产品编号/名称
- ✅ 工序名称
- ✅ 0阶需求数量
- ✅ 计划完工日期（需求日期 - 1天）
- ✅ 客户名称
- ✅ 提交人

### 3. 后端日志验证
```bash
tail -f /home/sardenesy/ai_workspaces/ai_desktop_3/backend/backend.log
```

**关键日志**:
```
📦 开始执行排程, 主计划ID: xxx
✅ 成功生成备料计划: MPP2025xxx
🔄 开始自动推送到工序计划...
✅ 成功生成工序计划: PP2025xxx
   工序名称: 打包
   计划完工日期: 2025-01-15
```

## 技术实现

### 涉及文件
1. **后端**:
   - `backend/routes/masterProductionPlans.js` - 执行排程接口
   
2. **前端**:
   - `07-frontend/src/pages/production-planning/ProductionPlanList.vue` - 主生产计划列表
   - `07-frontend/src/pages/production-planning/MaterialPreparationPlan.vue` - 备料计划页面
   - `07-frontend/src/pages/production-planning/ProcessPlanList.vue` - 工序计划页面

### 数据库表
1. `master_production_plans` - 主生产计划
2. `material_preparation_plans` - 备料计划
3. `process_plans` - 工序计划

## 优势特性

### 1. 自动化流程
- ✅ 一键执行排程，自动完成三级数据流转
- ✅ 无需手动操作备料计划和工序计划
- ✅ 减少人工干预，提高效率

### 2. 数据一致性
- ✅ 自动映射关联字段（销售订单编号、主计划编号）
- ✅ 保证数据链路完整性
- ✅ 自动生成唯一编号

### 3. 业务规则
- ✅ 计划完工日期自动计算（需求日期 - 1天）
- ✅ 提交时间自动记录
- ✅ 客户名称、提交人等信息自动继承

## 注意事项

1. **必须条件**: 主生产计划必须有产出工序字段
2. **日期计算**: 计划完工日期 = 需求日期 - 1天
3. **编号生成**: 备料计划编号(MPP)、工序计划编号(PP)都是自动生成
4. **提交人**: 如果主生产计划没有提交人，默认使用'admin'

## 未来扩展

可根据需要扩展功能：
- 支持批量执行排程
- 增加工序计划的详细排程逻辑
- 添加产能校验
- 支持多工序拆分

---

**更新时间**: 2025-12-08
**功能状态**: ✅ 已实现并测试通过
