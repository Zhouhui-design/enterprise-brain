# 缝纫和喷塑工序计划 - 数据流测试指南

**日期**: 2025-12-15 13:58  
**状态**: 等待用户测试  
**目的**: 验证备料计划 → 缝纫/喷塑工序计划数据流是否正常

---

## ✅ 已完成配置

### 1. 前端路由（已配置）

**文件**: `07-frontend/src/router/modules/production-planning.js`

```javascript
// ✅ 缝纫工序计划（只显示缝纫工序）
{
  path: 'sewing-process-plan',
  name: 'SewingProcessPlanList',
  component: () => import('@/pages/production-planning/SewingProcessPlanList.vue'),
  meta: { 
    title: '缝纫工序计划',
    icon: 'Scissors'
  }
},
// ✅ 喷塑工序计划（只显示喷塑工序）
{
  path: 'spray-painting-process-plan',
  name: 'SprayPaintingProcessPlanList',
  component: () => import('@/pages/production-planning/SprayPaintingProcessPlanList.vue'),
  meta: { 
    title: '喷塑工序计划',
    icon: 'Brush'
  }
}
```

### 2. 左侧菜单（已配置）

**文件**: `07-frontend/src/layout/index.vue`

**菜单路径**: 计划&物控管理 → 生产计划 → 缝纫工序计划 / 喷塑工序计划

```
计划&物控管理
└── 生产计划
    ├── 主生产计划
    ├── 主生产计划调整
    ├── 备料计划
    ├── 打包工序计划
    ├── 喷塑工序计划
    ├── 组装工序计划
    ├── 缝纫工序计划      ← 新增
    └── 喷塑工序计划      ← 新增
```

### 3. 后端支持（已完成）

| 工序类型 | 数据库表 | Service文件 | 路由文件 | API路径 |
|---------|---------|------------|---------|---------|
| 缝纫 | `sewing_process_plans` | `sewingProcessPlanService.js` | `sewingProcessPlans.js` | `/api/sewing-process-plans` |
| 喷塑 | `spray_painting_process_plans` | `sprayPaintingProcessPlanService.js` | `sprayPaintingProcessPlans.js` | `/api/spray-painting-process-plans` |

### 4. 推送规则（已配置）

**配置文件**: `backend/config/processTypes.js`

```javascript
'缝纫': {
  code: 'SEWING',
  tableName: 'sewing_process_plans',
  serviceName: 'sewingProcessPlanService',
  routePath: 'sewing-process-plans',
  planNoPrefix: 'SWPP',
  displayName: '缝纫工序计划',
  menuPath: '/production-planning/sewing-process-plan',
  enabled: true
},
'喷塑': {
  code: 'SPRAY_PAINTING',
  tableName: 'spray_painting_process_plans',
  serviceName: 'sprayPaintingProcessPlanService',
  routePath: 'spray-painting-process-plans',
  planNoPrefix: 'SPPP',
  displayName: '喷塑工序计划',
  menuPath: '/production-planning/spray-painting-process-plan',
  enabled: true
}
```

---

## 📋 数据流测试步骤

### 前置准备

1. **确认产品物料库中存在测试数据**
   - 访问：http://localhost:3003/material/list
   - 确认有产出工序="缝纫"的物料
   - 确认有产出工序="喷塑"的物料

2. **确认主生产计划存在**
   - 访问：http://localhost:3003/production-planning/plan-list
   - 如果没有，需要先创建销售订单 → 生成主生产计划

---

### 测试场景1：缝纫工序计划推送

#### 步骤1：准备测试数据

1. 在产品物料库中找到或创建一个"产出工序=缝纫"的物料
   - 物料编号：例如 `M001-SEWING`
   - 物料名称：例如 `缝纫测试物料`
   - 产出工序：`缝纫`
   - 标准工时定额：例如 `0.5`

2. 在主生产计划中创建包含该物料的计划
   - 主生产计划编号：自动生成（如 `MPP20251215001`）
   - 产品编号：使用上面的物料编号
   - 订单数量：例如 `100`

#### 步骤2：执行排程生成备料计划

1. 访问：http://localhost:3003/production-planning/plan-list
2. 找到刚才创建的主生产计划
3. 点击"执行排程"按钮
4. 等待系统生成备料计划

**预期结果**：
- ✅ 备料计划自动生成
- ✅ 备料计划中包含缝纫物料的记录

#### 步骤3：验证备料计划数据

1. 访问：http://localhost:3003/production-planning/material-preparation-new
2. 筛选查看刚才生成的备料计划
3. 确认字段值：
   - 计划物料编号 = `M001-SEWING`
   - 来源工序 = `缝纫`
   - 需补货数量 > 0

#### 步骤4：触发推送到缝纫工序计划

**推送触发方式**（根据系统设计）：
- 方式A：备料计划创建时自动推送（如果后端已实现）
- 方式B：点击备料计划的"推送"按钮手动触发
- 方式C：通过接口测试手动触发

**如果需要手动触发推送**，可以在浏览器控制台执行：
```javascript
// 获取备料计划ID
const planId = 1; // 替换为实际ID

// 调用推送API
fetch(`http://localhost:3005/api/material-preparation-plans/${planId}/push-to-process-plan`, {
  method: 'POST'
}).then(res => res.json()).then(data => console.log(data));
```

#### 步骤5：验证缝纫工序计划数据

1. 访问：http://localhost:3003/production-planning/sewing-process-plan
2. 查看表格数据

**预期结果**：
- ✅ 表格中出现新的工序计划记录
- ✅ 工序计划编号：`SWPP` 开头（如 `SWPP20251215001`）
- ✅ 生产产品编号 = `M001-SEWING`
- ✅ 生产产品名称 = `缝纫测试物料`
- ✅ 来源编号 = 备料计划编号（如 `MPP20251215001`）
- ✅ 需补货数量 = 备料计划的需补货数量
- ✅ 累积排程数量 = 计划排程数量
- ✅ 未排数量 = 需补货数量 - 累积排程数量
- ✅ 剩余需求工时 = 需求工时 - 已排程工时

#### 步骤6：验证自增规则

**条件**: 如果未排数量 > 0 且 下一个排程日期不为空

**预期结果**：
- ✅ 系统自动创建第2条排程记录
- ✅ 第2条记录的计划排程日期 = 第1条的下一个排程日期
- ✅ 第2条记录的来源编号 = 第1条的来源编号
- ✅ 第2条记录的累积排程数量 = 第1条 + 第2条的计划排程数量

---

### 测试场景2：喷塑工序计划推送

**步骤完全相同**，只需将"缝纫"替换为"喷塑"：

1. 产品物料库中产出工序 = `喷塑`
2. 物料编号示例：`M002-SPRAY`
3. 访问喷塑工序计划页面：http://localhost:3003/production-planning/spray-painting-process-plan
4. 工序计划编号前缀：`SPPP`

---

## 🔍 关键验证点

### 1. 数据路由验证

**后端日志应显示**（在 `backend` 启动终端查看）：

```bash
📍 [数据路由] 来源工序=缝纫 → 推送到缝纫工序计划 (表: sewing_process_plans)
   备料计划编号=MPP20251215001
   物料编号=M001-SEWING, 物料名称=缝纫测试物料
   需补货数量=100

✅ 缝纫工序计划创建成功: SWPP20251215001, ID: 1

🧮 开始计算字段: 累积排程数量、未排数量、剩余需求工时
   1️⃣ 累积排程数量 = 50 (来源编号=MPP20251215001)
   2️⃣ 未排数量 = 100 - 50 = 50
   3️⃣ 剩余需求工时 = 50 - 25 = 25

✅ 字段计算完成并已更新到数据库

🔁 检测到未排数量=50，下一个排程日期=2025-12-16，开始自增行递归排程...
```

### 2. 前端页面验证

**缝纫工序计划页面应显示**：
- ✅ 页面标题："缝纫工序计划"
- ✅ 表格有数据
- ✅ 数据表格支持增删改查
- ✅ 导入导出功能正常
- ✅ BOM详情弹窗正常（如果有生产BOM）

**喷塑工序计划页面应显示**：
- ✅ 页面标题："喷塑工序计划"
- ✅ 同上所有功能

### 3. 菜单导航验证

1. 点击左侧菜单"计划&物控管理"
2. 展开"生产计划"文件夹
3. 应该能看到：
   - 打包工序计划
   - 喷塑工序计划
   - 组装工序计划
   - **缝纫工序计划** ← 新增
   - **喷塑工序计划** ← 新增

4. 点击"缝纫工序计划"
   - ✅ URL变为：`/production-planning/sewing-process-plan`
   - ✅ 页面正常加载

5. 点击"喷塑工序计划"
   - ✅ URL变为：`/production-planning/spray-painting-process-plan`
   - ✅ 页面正常加载

### 4. API接口验证

**缝纫工序计划API**：
```bash
# 查询列表
curl http://localhost:3005/api/sewing-process-plans?page=1&pageSize=10

# 预期返回
{"code":200,"data":{"records":[...],"total":1,"page":1,"pageSize":10},"message":"查询成功"}
```

**喷塑工序计划API**：
```bash
# 查询列表
curl http://localhost:3005/api/spray-painting-process-plans?page=1&pageSize=10

# 预期返回
{"code":200,"data":{"records":[...],"total":1,"page":1,"pageSize":10},"message":"查询成功"}
```

---

## ❌ 可能的错误场景

### 错误1：菜单点击无响应

**原因**：前端服务未重启，未加载新路由

**解决**：
```bash
# 重启前端服务（如果需要）
cd /home/sardenesy/ai_workspaces/ai_desktop_3/07-frontend
npm run dev
```

### 错误2：页面显示404

**原因**：路由配置错误或组件路径错误

**检查**：
- 路由路径是否正确
- 组件文件是否存在
- 浏览器控制台是否有报错

### 错误3：数据未推送

**原因1**：产品物料库中"产出工序"字段值不匹配

**检查**：
```bash
# 查询数据库确认产出工序字段
mysql -u root -p enterprise_brain
SELECT material_code, material_name, process_name FROM materials WHERE process_name IN ('缝纫', '喷塑');
```

**原因2**：备料计划推送逻辑未触发

**检查后端日志**：
- 是否有 `[数据路由]` 日志
- 是否有 `不支持的工序类型` 警告

### 错误4：字段计算错误

**检查数据库**：
```sql
SELECT 
  id,
  plan_no,
  schedule_quantity,
  cumulative_schedule_qty,
  unscheduled_qty,
  remaining_required_hours,
  next_schedule_date
FROM sewing_process_plans
ORDER BY id DESC
LIMIT 5;
```

**预期**：
- `cumulative_schedule_qty` = 所有相同来源编号的 `schedule_quantity` 之和
- `unscheduled_qty` = `replenishment_qty` - `cumulative_schedule_qty`
- `remaining_required_hours` = `required_work_hours` - `scheduled_work_hours`

---

## 📊 测试报告模板

请在测试完成后填写以下内容：

### 缝纫工序计划测试结果

- [ ] 前端路由配置正常
- [ ] 左侧菜单显示正常
- [ ] 页面加载正常
- [ ] 备料计划推送成功
- [ ] 工序计划数据正确
- [ ] 累积排程数量计算正确
- [ ] 未排数量计算正确
- [ ] 剩余需求工时计算正确
- [ ] 自增规则触发正常（如果满足条件）
- [ ] BOM详情弹窗正常

**遇到的问题**：（请详细描述）


### 喷塑工序计划测试结果

- [ ] 前端路由配置正常
- [ ] 左侧菜单显示正常
- [ ] 页面加载正常
- [ ] 备料计划推送成功
- [ ] 工序计划数据正确
- [ ] 累积排程数量计算正确
- [ ] 未排数量计算正确
- [ ] 剩余需求工时计算正确
- [ ] 自增规则触发正常（如果满足条件）
- [ ] BOM详情弹窗正常

**遇到的问题**：（请详细描述）


---

## 🎯 测试完成后下一步

如果测试全部通过：
1. ✅ 告诉我"测试通过，可以备份"
2. 我会立即执行远程备份
3. 然后批量生成其他12个工序

如果测试发现问题：
1. ❌ 告诉我具体的错误信息
2. 我会立即修复
3. 修复后再次测试
4. 全部通过后再备份

---

**测试时间**: _____________  
**测试人**: 用户  
**状态**: 等待测试中...
