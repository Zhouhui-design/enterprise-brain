# BUG跟踪记录文档

## 1. 概述

本文档用于记录系统中出现的BUG，包括BUG的描述、原因分析、解决方案以及预防措施。每次修复BUG后应及时更新此文档，以便后续问题排查和系统维护。

## 2. BUG记录模板

### 2.1 模板格式

```
### BUG编号: BUG-XXXX
**标题**: [简洁描述BUG]

**发现问题时间**: YYYY-MM-DD
**修复时间**: YYYY-MM-DD
**发现人**: [发现人姓名或角色]
**修复人**: [修复人姓名]

**问题描述**:
[详细描述BUG的现象和影响]

**重现步骤**:
1. [步骤1]
2. [步骤2]
3. [步骤3]
...

**预期结果**:
[描述正常情况下应该出现的结果]

**实际结果**:
[描述实际出现的异常结果]

**影响范围**:
[描述该BUG影响的功能模块和用户群体]

**根本原因分析**:
[深入分析导致该BUG的根本原因]

**解决方案**:
[详细描述解决问题的方法和实施步骤]

**涉及文件**:
- [文件1路径]
- [文件2路径]
...

**验证方法**:
[描述如何验证BUG已被修复]

**预防措施**:
[描述如何避免类似问题再次发生]
```

## 3. 已修复BUG记录

### BUG编号: BUG-0001
**标题**: 主生产计划执行排程后无法正确显示结果信息

**发现问题时间**: 2025-12-19
**修复时间**: 2025-12-19
**发现人**: 用户
**修复人**: Lingma

**问题描述**:
在生产计划列表中选择数据并点击"执行排程"按钮后，系统报错："can't access property "materialPlanCount", result.data is undefined"，导致无法正确显示排程结果信息。

**重现步骤**:
1. 在销售订单管理中新增销售订单
2. 点击"正式下单"按钮
3. 进入生产计划列表页面
4. 选择一条生产计划数据
5. 点击"执行排程"按钮
6. 观察页面提示信息

**预期结果**:
系统应成功执行排程，并显示类似"排程执行成功！生成备料计划: 1 条"的提示信息。

**实际结果**:
页面提示错误："can't access property "materialPlanCount", result.data is undefined"

**影响范围**:
- 生产计划模块
- 备料计划生成流程
- 用户无法确认排程是否成功执行

**根本原因分析**:
前端代码在处理后端返回结果时，直接访问`result.data.materialPlanCount`属性，但后端返回的数据结构发生了变化，`result.data`可能为undefined，导致访问属性时报错。这违反了前端代码应该具备健壮性处理的原则。

**解决方案**:
1. 修改前端代码，增强对后端返回数据的处理能力
2. 使用安全访问模式（如可选链操作符或条件判断）访问嵌套属性
3. 提供合理的默认值，确保即使在数据结构不一致的情况下也能正常显示

**涉及文件**:
- [/07-frontend/src/pages/production-planning/ProductionPlanList.vue](file:///home/sardensy/enterprise-brain/enterpise-brain/07-frontend/src/pages/production-planning/ProductionPlanList.vue)
- [/backend/routes/masterProductionPlans.js](file:///home/sardensy/enterprise-brain/enterpise-brain/backend/routes/masterProductionPlans.js)

**验证方法**:
1. 重新执行上述重现步骤
2. 确认排程成功执行后能正确显示结果信息
3. 检查浏览器控制台无相关错误信息

**预防措施**:
1. 前端处理API响应时应始终考虑数据结构可能的变化
2. 建立代码审查机制，确保关键数据访问的安全性
3. 增加前端单元测试，覆盖不同数据结构场景

### BUG编号: BUG-0002
**标题**: 工序能力负荷表页面打开报错

**发现问题时间**: 2025-12-19
**修复时间**: 2025-12-19
**发现人**: 用户
**修复人**: Lingma

**问题描述**:
访问工序能力负荷表页面(http://localhost:3003/mrp/capacity-load)时，页面显示错误，无法正常展示数据。

**重现步骤**:
1. 打开工序能力负荷表页面
2. 观察页面显示情况

**预期结果**:
页面应正常显示工序能力负荷表数据及相关功能组件。

**实际结果**:
页面显示不完整或出现错误提示。

**影响范围**:
- 工序能力负荷表模块
- 产能规划功能

**根本原因分析**:
工序能力负荷表页面的前端代码存在不完整或错误的标签闭合，导致页面渲染异常。同时，页面没有正确处理API返回的数据结构，缺乏必要的错误处理机制。

**解决方案**:
1. 重构工序能力负荷表页面代码，确保标签正确闭合
2. 增加对API返回数据的处理和错误处理机制
3. 完善页面的数据展示逻辑

**涉及文件**:
- [/07-frontend/src/pages/production-planning/CapacityPlanning.vue](file:///home/sardensy/enterprise-brain/enterpise-brain/07-frontend/src/pages/production-planning/CapacityPlanning.vue)

**验证方法**:
1. 重新访问工序能力负荷表页面
2. 确认页面能正常显示且无错误
3. 检查页面功能是否正常

**预防措施**:
1. 加强前端代码的代码审查，特别注意标签闭合等问题
2. 建立前端组件的测试机制，确保组件能正确渲染
3. 统一错误处理机制，提高页面健壮性

### BUG编号: BUG-0003
**标题**: 销售订单确认下单后主生产计划没有数据

**发现问题时间**: 2025-12-19
**修复时间**: 2025-12-19
**发现人**: 用户
**修复人**: Lingma

**问题描述**:
在销售订单管理中点击"正式下单"按钮后，主生产计划列表没有生成相应的数据。

**重现步骤**:
1. 在销售订单管理中新增销售订单
2. 点击"正式下单"按钮
3. 检查主生产计划列表是否有新增数据

**预期结果**:
对于产出工序不为"采购"的销售订单，在点击"正式下单"后应在主生产计划列表中生成相应数据。

**实际结果**:
主生产计划列表没有任何新增数据。

**影响范围**:
- 销售订单管理模块
- 主生产计划生成流程
- 整体业务数据流

**根本原因分析**:
销售订单确认下单接口在处理非采购类产品的推送时，缺少了产品图片、产品来源和提交人等关键字段的处理，导致插入主生产计划表的数据不完整，进而导致数据创建失败。

**解决方案**:
1. 在销售订单确认下单接口中增加对产品图片、产品来源和提交人字段的处理
2. 从产品手册表中查询产品相关信息
3. 完善插入主生产计划表的字段列表，确保所有必需字段都有值

**涉及文件**:
- [/backend/routes/salesOrders.js](file:///home/sardensy/enterprise-brain/enterpise-brain/backend/routes/salesOrders.js)

**验证方法**:
1. 重新执行上述重现步骤
2. 确认主生产计划列表中有新增数据
3. 检查新增数据包含产品来源、客户名称、提交人等字段

**预防措施**:
1. 建立数据库字段完整性的检查机制
2. 增加接口日志记录，便于问题追踪
3. 完善接口单元测试，覆盖各种数据场景

### BUG编号: BUG-0004
**标题**: 备料计划创建后未正确推送至工序计划

**发现问题时间**: 2025-12-19
**修复时间**: 2025-12-19
**发现人**: 用户
**修复人**: Lingma

**问题描述**:
主生产计划执行排程后虽然能创建备料计划，但是备料计划未能正确推送至相应的工序计划。

**重现步骤**:
1. 在销售订单管理中新增销售订单
2. 点击"正式下单"按钮
3. 进入生产计划列表页面
4. 选择一条生产计划数据
5. 点击"执行排程"按钮
6. 检查相应工序计划列表是否有新增数据

**预期结果**:
对于物料来源为"自制"的备料计划，应当自动推送至相应的工序计划列表。

**实际结果**:
备料计划虽已创建，但未推送至工序计划。

**影响范围**:
- 备料计划模块
- 工序计划生成流程
- 整体业务数据流

**根本原因分析**:
备料计划服务中的创建方法虽然实现了推送逻辑，但在事务提交后推送的实现不够完善，未能正确处理推送结果并返回相关信息给调用方。

**解决方案**:
1. 完善备料计划服务中的创建方法，确保推送逻辑正确执行
2. 确保推送结果能正确返回给调用方
3. 增加推送过程的日志记录，便于问题追踪

**涉及文件**:
- [/backend/services/materialPreparationPlanService.js](file:///home/sardensy/enterprise-brain/enterpise-brain/backend/services/materialPreparationPlanService.js)

**验证方法**:
1. 重新执行上述重现步骤
2. 确认相应工序计划列表中有新增数据
3. 检查备料计划的状态是否正确更新

**预防措施**:
1. 建立推送流程的监控机制
2. 增加推送失败的重试机制
3. 完善推送相关的单元测试

### BUG编号: BUG-0005
**标题**: 销售订单创建接口报错 Column count doesn't match value count at row 1

**发现问题时间**: 2025-12-19
**修复时间**: 2025-12-19
**发现人**: 用户
**修复人**: Lingma

**问题描述**:
在销售订单管理页面点击"新增"按钮，填写订单信息后点击"提交"按钮，页面提示"保存订单失败: 创建订单失败"。通过curl直接调用API接口也返回相同错误。

**重现步骤**:
1. 打开销售订单管理页面
2. 点击"新增"按钮
3. 填写客户名称等必要信息
4. 添加产品信息
5. 点击"提交"按钮
6. 观察页面提示信息

**预期结果**:
销售订单应成功创建并保存到数据库中。

**实际结果**:
页面提示"保存订单失败: 创建订单失败"，后端日志显示"Column count doesn't match value count at row 1"错误。

**影响范围**:
- 销售订单管理模块
- 订单创建功能
- 整体业务流程的起点

**根本原因分析**:
销售订单创建接口中的INSERT SQL语句字段数量与值数量不匹配。检查发现sales_orders表包含updated_by字段，但在INSERT语句中没有包含该字段，而在VALUES子句中却提供了对应的值。

**解决方案**:
1. 修正销售订单创建接口中主订单插入语句，确保字段列表与值列表数量一致
2. 在字段列表中添加updated_by字段

**涉及文件**:
- [/backend/routes/salesOrders.js](file:///home/sardensy/enterprise-brain/enterpise-brain/backend/routes/salesOrders.js)

**验证方法**:
1. 重新执行上述重现步骤
2. 确认销售订单能成功创建
3. 检查数据库中订单数据是否正确保存

**预防措施**:
1. 建立SQL语句字段与值匹配的检查机制
2. 增加数据库表结构变更的通知机制，确保相关代码同步更新
3. 完善接口单元测试，覆盖各种数据插入场景