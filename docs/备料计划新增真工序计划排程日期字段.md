# 备料计划新增"真工序计划排程日期"字段报告

## 需求描述

在备料计划页面（`http://localhost:3003/production-planning/material-preparation-new`）新增列字段："真工序计划排程日期"。

**字段规则**：
- 值 = 工序计划排程日期 + 1天
- 格式：YYYY-MM-DD

---

## 实现方案

### 1. 字段定义

**字段类型**：计算字段（前端计算）  
**计算逻辑**：基于`processScheduleDate`字段，使用本地时间加1天  
**显示格式**：YYYY-MM-DD

### 2. 修改文件

**文件路径**：`/07-frontend/src/pages/production-planning/MaterialPreparationPlanNew.vue`

### 3. 修改内容

#### 修改1：添加列配置（第463行后）

```javascript
const defaultColumns = [
  // ... existing columns ...
  { prop: 'processIntervalHours', label: '工序间隔工时', width: 140, filterable: false },
  { prop: 'processIntervalUnit', label: '工序间隔单位', width: 140, filterable: true },
  { prop: 'processScheduleDate', label: '工序计划排程日期', width: 160, filterable: true },
  { prop: 'realProcessScheduleDate', label: '真工序计划排程日期', width: 180, filterable: true }, // ✅ 新增
  { prop: 'demandDate', label: '需求日期', width: 120, filterable: true },
  // ... existing columns ...
]
```

**关键配置**：
- `prop`: `realProcessScheduleDate` - 字段标识
- `label`: `真工序计划排程日期` - 列标题
- `width`: `180` - 列宽（比普通日期列稍宽，因为标题较长）
- `filterable`: `true` - 支持表头筛选

---

#### 修改2：更新表格formatter绑定（第58行）

**修改前**：
```vue
:formatter="col.prop === 'demandDate' ? formatDate : undefined"
```

**修改后**：
```vue
:formatter="getFormatter(col.prop)"
```

**原因**：需要统一使用`getFormatter`函数来处理所有格式化，包括新增的计算字段。

---

#### 修改3：添加格式化函数（第656行后）

```javascript
// 获取格式化函数
const getFormatter = (prop) => {
  // 日期字段
  if (['demandDate', 'processScheduleDate', 'promiseDeliveryDate'].includes(prop)) {
    return formatDate
  }
  
  // ✅ 真工序计划排程日期（计算字段：工序计划排程日期+1天）
  if (prop === 'realProcessScheduleDate') {
    return ({ row }) => {
      if (!row.processScheduleDate) return '-'
      try {
        // ✅ 使用本地时间计算，避免UTC时区转换
        const date = new Date(row.processScheduleDate)
        if (isNaN(date.getTime())) return '-'
        
        // +1天
        date.setDate(date.getDate() + 1)
        
        const year = date.getFullYear()
        const month = String(date.getMonth() + 1).padStart(2, '0')
        const day = String(date.getDate()).padStart(2, '0')
        return `${year}-${month}-${day}`
      } catch {
        return '-'
      }
    }
  }
  
  // ... 其他字段格式化逻辑 ...
}
```

**关键实现细节**：

1. **空值处理**：如果`processScheduleDate`为空，显示`-`
2. **日期解析**：使用`new Date()`将字符串转换为Date对象
3. **有效性验证**：使用`isNaN(date.getTime())`检查日期是否有效
4. **日期计算**：使用`setDate(date.getDate() + 1)`加1天
5. **本地时区**：使用`getFullYear()`、`getMonth()`、`getDate()`获取本地时间组件
6. **格式化输出**：手动拼接为YYYY-MM-DD格式
7. **异常处理**：使用try-catch捕获异常，返回`-`

---

## 技术规范遵循

### 1. 日期时区处理规范

✅ 遵循项目规范：**MySQL日期字段存储与查询的时区一致性规范**

- 使用本地时间方法：`getFullYear()`、`getMonth()`、`getDate()`
- 避免UTC时区转换：不使用`toISOString()`
- 格式化为YYYY-MM-DD：手动拼接字符串

### 2. 计算字段实现规范

✅ 前端计算字段实现最佳实践：

- 使用`formatter`函数进行动态计算
- 基于现有字段计算，不修改后端
- 计算逻辑清晰，易于维护

### 3. 列配置规范

✅ 遵循页面设置架构：

- 添加到`defaultColumns`配置
- 支持表头筛选（`filterable: true`）
- 适当的列宽设置

---

## 功能验证

### 测试场景

| 工序计划排程日期 | 预期真工序计划排程日期 | 格式 |
|-----------------|---------------------|------|
| 2026-01-05 | 2026-01-06 | YYYY-MM-DD |
| 2026-12-31 | 2027-01-01 | YYYY-MM-DD |
| null | - | - |
| '' | - | - |

### 验证步骤

1. 访问备料计划页面：`http://localhost:3003/production-planning/material-preparation-new`
2. 检查表格是否显示"真工序计划排程日期"列
3. 验证计算逻辑：
   - 有工序计划排程日期的记录，真工序计划排程日期 = 工序计划排程日期 + 1天
   - 工序计划排程日期为空的记录，真工序计划排程日期显示为"-"
4. 验证日期格式：所有日期均为YYYY-MM-DD格式
5. 验证跨年计算：2026-12-31 → 2027-01-01

---

## 影响范围

### 修改文件
- `/07-frontend/src/pages/production-planning/MaterialPreparationPlanNew.vue`（1个文件）

### 影响功能
- ✅ 备料计划列表展示（新增列）
- ✅ 表头筛选功能（支持筛选真工序计划排程日期）
- ✅ 页面设置（支持显示/隐藏、列排序）

### 不影响
- ❌ 后端API（无修改）
- ❌ 数据库（无字段变更）
- ❌ 其他页面

---

## 特性说明

### 1. 动态计算
每次表格渲染时，自动根据`processScheduleDate`计算`realProcessScheduleDate`，无需额外的数据请求或存储。

### 2. 时区安全
使用本地时间计算，确保在不同时区环境下都能得到正确结果，避免UTC时区转换导致的日期偏移。

### 3. 可配置
- 用户可通过"页面设置"控制该列的显示/隐藏
- 支持拖拽调整列顺序
- 支持表头筛选

### 4. 性能优化
计算逻辑简单高效，不会影响表格渲染性能。

---

## 后续优化建议

### 1. 后端持久化（可选）
如果该字段需要用于后端查询或排序，可考虑：
- 在`material_preparation_plans`表添加`real_process_schedule_date`字段
- 在真工序计划推送时自动计算并存储
- 好处：支持后端筛选、排序、统计

### 2. 批量计算优化（可选）
如果表格数据量很大（>1000条），可考虑：
- 使用`computed`缓存计算结果
- 使用虚拟滚动优化渲染

---

## 修复时间
2025-12-13

## 修复人员
AI Assistant (Qoder)

## 状态
✅ 已完成
