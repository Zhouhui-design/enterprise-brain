# 真工序计划业务变量设置与计划结束日期计算功能说明

## 功能概述
为真工序计划页面添加业务变量设置（与工序计划保持一致），并实现计划结束日期的自动计算功能。

## 一、业务变量设置

### 1. 工序间隔设置（按钮）
- **功能**：打开工序间隔设置弹窗
- **位置**：页面设置 → 业务变量设置
- **用途**：配置不同工序之间的时间间隔规则
- **组件**：复用 `ProcessIntervalSettings.vue`

### 2. 默认统筹设置（下拉选择）
- **功能**：设置备料计划推送到真工序计划时的合并规则
- **默认值**：按"来源主计划编号"合并
- **选项**：
  - 按"销售订单"合并
  - 按"来源主计划编号"合并
  - 按相同"备料计划编号"合并
  - 按相同"需求日期"合并
  - 按相同"计划物料编号"合并
- **说明**：每个选项都有详细的合并逻辑说明

### 3. 剩余工时小于（数字输入）
- **功能**：设置计划结束日期查询的剩余工时门槛值
- **默认值**：0.5 小时
- **单位**：小时
- **用途**：只有工序能力负荷表中"剩余工时" ≥ 该值的日期才会被选中
- **说明**：设置较大值可确保有足够的剩余工时进行排程

## 二、计划结束日期计算

### 计算规则

**MAXIFS跨表查询逻辑**：
```
计划结束日期 = MAXIFS(
  工序能力负荷表[日期], 
  工序能力负荷表[工序名称] = 真工序计划[工序名称],
  工序能力负荷表[剩余工时] >= 业务变量[剩余工时小于]
)
```

### 查询条件

1. **工序名称匹配**：工序能力负荷表.工序名称 = 真工序计划.工序名称
2. **剩余工时门槛**：工序能力负荷表.剩余工时 ≥ 业务变量中的"剩余工时小于"设定值（默认0.5小时）

### 前置条件

- **必须满足**：需求工时 > 0
- **必须有值**：工序名称、计划完工日期

### 触发时机

1. **自动触发**（通过watch监听器）：
   - 需求工时发生变化时
   - 工序名称发生变化时
   - 计划完工日期发生变化时

2. **手动触发**：
   - 保存数据前强制计算

### 计算流程

```
用户输入需补货数量、定时工额
    ↓
自动计算需求工时 = 需补货数量 / 定时工额
    ↓ (触发watch)
查询计划结束日期（MAXIFS）
    ↓
调用后端API：/capacity-load/query-plan-end-date
    ↓
查询工序能力负荷表
    ↓
返回符合条件的最大日期
    ↓
自动填充到计划结束日期字段
```

## 三、实现细节

### 前端实现

#### 1. 导入必要组件和工具
```javascript
import ProcessIntervalSettings from './ProcessIntervalSettings.vue'
import capacityLoadApi from '@/api/capacityLoad'
import dateUtils from '@/services/utils/date-utils'
```

#### 2. 业务变量配置
```javascript
const currentBusinessVars = ref({
  defaultMergeRule: 'masterPlanNo',
  minRemainingHours: 0.5
})

const businessVarButtons = [
  {
    label: '工序间隔设置',
    value: 'processIntervalSettings',
    onClick: openProcessIntervalSettings
  }
]

const businessVarSelects = [
  // 默认统筹设置
  // 剩余工时小于
]
```

#### 3. 计划结束日期查询函数
```javascript
const queryPlanEndDate = async () => {
  const requiredWorkHours = parseFloat(formData.value.requiredWorkHours) || 0
  const processName = formData.value.processName
  const completionDate = formData.value.completionDate
  const minRemainingHours = currentBusinessVars.value.minRemainingHours || 0.5
  
  // 前置条件检查
  if (requiredWorkHours <= 0 || !processName || !completionDate) {
    formData.value.planEndDate = null
    return null
  }
  
  // 调用API查询
  const response = await capacityLoadApi.queryPlanEndDate(
    processName,
    formatDateYMD(completionDate),
    minRemainingHours
  )
  
  // 更新计划结束日期
  if (response?.data?.planEndDate) {
    formData.value.planEndDate = response.data.planEndDate
    return response.data.planEndDate
  }
  
  return null
}
```

#### 4. 响应式监听
```javascript
// 监听需求工时、工序名称、计划完工日期变化
watch(
  () => [
    parseFloat(formData.value.requiredWorkHours) || 0,
    formData.value.processName,
    formData.value.completionDate
  ],
  () => {
    queryPlanEndDate()
  },
  { deep: true }
)
```

#### 5. 保存前计算
```javascript
const handleSave = async () => {
  try {
    // 保存前强制计算计划结束日期
    await queryPlanEndDate()
    
    await formRef.value.validate()
    // ... 保存逻辑
  }
}
```

### 后端API

**接口路径**：`POST /capacity-load/query-plan-end-date`

**请求参数**：
```javascript
{
  processName: '组装',           // 工序名称
  completionDate: '2025-12-20',  // 计划完工日期
  minRemainingHours: 0.5         // 剩余工时门槛值
}
```

**响应示例**：
```javascript
{
  code: 200,
  data: {
    planEndDate: '2025-12-18',  // 计划结束日期
    remainingHours: 2.50        // 剩余工时
  }
}
```

**SQL查询逻辑**：
```sql
SELECT 
  MAX(date) as plan_end_date,
  MAX(remaining_hours) as remaining_hours
FROM process_capacity_load 
WHERE 
  process_name = '组装'
  AND remaining_hours >= 0.5
ORDER BY date DESC
LIMIT 1
```

## 四、使用说明

### 1. 配置业务变量

1. 打开真工序计划页面：http://localhost:3007/process-planning/real-process-plan
2. 点击页面右上角的"页面设置"按钮（⚙️）
3. 选择"业务变量"标签
4. 配置以下内容：
   - **工序间隔设置**：点击按钮打开设置弹窗
   - **默认统筹设置**：选择合并规则（默认：按来源主计划编号合并）
   - **剩余工时小于**：设置门槛值（默认：0.5小时）

### 2. 新增真工序计划

1. 点击"新增"按钮
2. 填写基本信息：
   - 工序名称：例如"组装"
   - 计划完工日期：例如"2025-12-20"
   - 需补货数量：例如300
   - 定时工额：例如50
3. 系统自动计算：
   - **需求工时** = 300 / 50 = 6.00（自动计算）
   - **计划结束日期** = 自动查询工序能力负荷表（MAXIFS）
4. 点击"保存"

### 3. 查看控制台日志

浏览器控制台会输出详细的计算日志：

```
🔄 需求工时、工序名称或计划完工日期发生变化，重新查询计划结束日期
🔍 查询计划结束日期: {
  requiredWorkHours: 6,
  processName: '组装',
  completionDate: '2025-12-20',
  minRemainingHours: 0.5
}
✅ 计划结束日期查询成功: 2025-12-18, 剩余工时: 2.50
```

## 五、验证方法

### 1. 前置准备
确保工序能力负荷表中有测试数据：
- 访问：http://localhost:3007/mrp/capacity-load
- 确认有工序数据（例如：组装、焊接等）
- 确认有剩余工时数据

### 2. 测试步骤

#### 测试1：需求工时自动计算
1. 新增真工序计划
2. 输入需补货数量：300
3. 输入定时工额：50
4. 验证：需求工时自动显示 6.00

#### 测试2：计划结束日期自动查询
1. 继续上一步
2. 输入工序名称：组装
3. 选择计划完工日期：2025-12-20
4. 验证：计划结束日期自动填充（例如：2025-12-18）
5. 查看控制台日志确认查询成功

#### 测试3：业务变量门槛值影响
1. 修改"剩余工时小于"为 5.0
2. 保存后重新新增计划
3. 验证：计划结束日期查询结果可能发生变化（只选择剩余工时≥5.0的日期）

### 3. 异常情况测试

#### 情况1：需求工时为0
- 设置需补货数量为0
- 验证：计划结束日期清空
- 控制台：`⚠️ 需求工时<=0，跳过查询计划结束日期`

#### 情况2：工序名称为空
- 清空工序名称
- 验证：计划结束日期清空
- 控制台：`⚠️ 缺少必要参数：工序名称或计划完工日期`

#### 情况3：无符合条件的日期
- 输入一个不存在的工序名称
- 验证：计划结束日期为空
- 控制台：`⚠️ 未找到符合条件的计划结束日期`

## 六、涉及文件

### 前端文件
- `/07-frontend/src/pages/production-planning/RealProcessPlanList.vue`
  - 第220-232行：导入必要组件和工具
  - 第234-244行：业务变量当前配置
  - 第273-332行：业务变量配置（按钮和下拉）
  - 第428-483行：计划结束日期查询函数和watch监听器
  - 第558-560行：保存前计算

### 后端文件
- `/backend/routes/capacityLoad.js`
  - 计划结束日期查询接口（已存在，与工序计划共用）

### API文件
- `/07-frontend/src/api/capacityLoad.js`
  - `queryPlanEndDate()` 方法（已存在）

## 七、技术要点

### 1. 与工序计划保持一致
- 业务变量配置完全相同
- 计划结束日期计算逻辑相同
- 使用相同的后端API接口

### 2. 响应式计算
- 使用Vue 3的watch监听器
- 自动响应字段变化
- 异步查询不阻塞UI

### 3. 错误处理
- 完善的前置条件检查
- 详细的控制台日志
- 友好的错误提示

### 4. 性能优化
- 使用debounce避免频繁请求（可选）
- API调用失败不影响其他功能
- 异步加载不阻塞保存

## 八、注意事项

1. **数据依赖**：
   - 计划结束日期依赖工序能力负荷表数据
   - 确保工序能力负荷表数据准确且及时更新

2. **业务变量**：
   - 剩余工时门槛值影响查询结果
   - 建议根据实际产能情况合理设置

3. **字段关联**：
   - 需求工时由需补货数量和定时工额自动计算
   - 计划结束日期由需求工时触发查询
   - 字段间存在级联关系

4. **与工序计划区别**：
   - 真工序计划编号前缀：RPP
   - 工序计划编号前缀：PP
   - 其他逻辑完全一致

## 九、更新记录

### 2025-12-11
- ✅ 添加业务变量配置（工序间隔设置、默认统筹设置、剩余工时小于）
- ✅ 实现计划结束日期自动计算功能（MAXIFS）
- ✅ 添加响应式监听器
- ✅ 添加保存前强制计算
- ✅ 完善控制台日志
- ✅ 前端代码已更新并验证

## 十、相关文档
- [工序计划字段计算规则实现说明](./工序计划字段计算规则实现说明.md)
- [备料计划同步推送到真工序计划功能实现](./备料计划同步推送到真工序计划功能实现.md)
- [真工序计划页面配置继承规则](../README.md)
