# 销售订单级联删除功能说明

## 功能概述
当销售订单被删除时，系统会自动级联删除所有关联的下级数据，确保数据一致性。

## 级联删除链路

```
销售订单删除
    ↓ 自动触发
├─ 主生产计划（同步删除）
├─ 备料计划（同步删除）✅
└─ 工序计划（同步删除）
```

## 删除规则

### 匹配条件
| 目标表 | 匹配字段 | 匹配规则 | 示例 |
|--------|---------|---------|------|
| 主生产计划 | `internal_order_no` | = 销售订单的`internal_order_no` | SO2025000001 |
| **备料计划** | **`sales_order_no`** | **= 销售订单的`internal_order_no`** | **SO2025000001** ✅ |
| 工序计划 | `sales_order_no` | = 销售订单的`internal_order_no` | SO2025000001 |

### 删除顺序
1. 先删除子级数据（主生产计划、备料计划、工序计划）
2. 再删除父级数据（销售订单本身）

## 实现细节

### 单个删除接口
**路径**: `DELETE /api/sales-orders/:id`

**处理流程**:
```javascript
// 1. 查询订单的internal_order_no
const internalOrderNo = existing[0].internal_order_no;

// 2. 级联删除主生产计划
DELETE FROM master_production_plans WHERE internal_order_no = ?

// 3. ✅ 级联删除备料计划
DELETE FROM material_preparation_plans WHERE sales_order_no = ?

// 4. 级联删除工序计划
DELETE FROM process_plans WHERE sales_order_no = ?

// 5. 删除订单
DELETE FROM sales_orders WHERE id = ?
```

### 批量删除接口
**路径**: `POST /api/sales-orders/batch-delete`

**处理流程**:
- 使用数据库**事务**保证原子性
- 逐个处理每个订单
- 统计删除数量
- 任何步骤失败都会**回滚**

**关键代码**:
```javascript
await connection.beginTransaction();

for (const id of ids) {
  // 1. 查询订单的internal_order_no
  const internalOrderNo = orderRows[0].internal_order_no;
  
  // 2. 级联删除主生产计划
  DELETE FROM master_production_plans WHERE internal_order_no = ?
  
  // 3. ✅ 级联删除备料计划
  DELETE FROM material_preparation_plans WHERE sales_order_no = ?
  
  // 4. 级联删除工序计划
  DELETE FROM process_plans WHERE sales_order_no = ?
  
  // 5. 删除订单
  DELETE FROM sales_orders WHERE id = ?
}

await connection.commit();
```

## 操作示例

### 示例场景
**销售订单**:
- ID: 123
- 内部销售订单编号: `SO2025000001`

**关联数据**:
- 主生产计划: 2条（`internal_order_no = SO2025000001`）
- **备料计划**: 5条（**`sales_order_no = SO2025000001`**）✅
- 工序计划: 3条（`sales_order_no = SO2025000001`）

### 删除操作
1. 用户在订单列表选择订单（内部订单编号: SO2025000001）
2. 点击"删除"按钮
3. 确认删除

### 系统执行
```
🗑️ 删除订单: { id: 123, internalOrderNo: 'SO2025000001' }
✅ 级联删除主生产计划: 2 条
✅ 级联删除备料计划: 5 条
✅ 级联删除工序计划: 3 条
✅ 订单删除成功
```

### 用户提示
```
删除订单成功（同时删除 2 条主生产计划、5 条备料计划、3 条工序计划）
```

## 验证方法

### 1. 删除前查询
```sql
-- 查询订单关联的备料计划
SELECT * FROM material_preparation_plans 
WHERE sales_order_no = 'SO2025000001';
```

### 2. 执行删除
在订单列表页面删除订单 SO2025000001

### 3. 删除后验证
```sql
-- 验证备料计划已被删除
SELECT COUNT(*) FROM material_preparation_plans 
WHERE sales_order_no = 'SO2025000001';
-- 期望结果: 0
```

### 4. 后端日志验证
```bash
tail -f /home/sardenesy/ai_workspaces/ai_desktop_3/backend/backend.log
```

**关键日志**:
```
=== 删除销售订单 === 123
🗑️ 删除订单: { id: 123, internalOrderNo: 'SO2025000001' }
✅ 级联删除主生产计划: 2 条
✅ 级联删除备料计划: 5 条
✅ 级联删除工序计划: 3 条
✅ 订单删除成功
```

## 涉及文件

### 后端
- `backend/routes/salesOrders.js`
  - 单个删除接口: `DELETE /:id`（第580-647行）
  - 批量删除接口: `POST /batch-delete`（第653-745行）

### 数据库表
- `sales_orders` - 销售订单表
- `master_production_plans` - 主生产计划表
- `material_preparation_plans` - 备料计划表 ✅
- `process_plans` - 工序计划表

## 技术保障

### 1. 事务一致性
- 批量删除使用数据库事务
- 确保所有操作**全部成功**或**全部回滚**
- 避免数据不一致

### 2. 错误处理
- 完善的异常捕获
- 事务回滚机制
- 详细的错误日志

### 3. 性能优化
- 单条SQL删除相关记录
- 避免逐条查询删除
- 使用数据库索引加速匹配

## 数据安全

### 删除确认
- 前端会弹出确认对话框
- 显示将要删除的订单信息
- 用户二次确认后才执行

### 删除权限
- 仅授权用户可执行删除操作
- 记录删除操作日志
- 可追溯删除历史

## 注意事项

1. **不可逆操作**: 删除订单后，所有关联数据将永久删除
2. **数据一致性**: 系统自动维护数据完整性，无需手动清理
3. **批量删除**: 支持一次性删除多个订单及其关联数据
4. **事务保护**: 批量删除使用事务，失败会自动回滚

## 业务价值

1. ✅ **自动化**: 无需手动删除下级数据
2. ✅ **一致性**: 保证数据完整性和一致性
3. ✅ **效率**: 一键删除所有关联数据
4. ✅ **安全**: 事务机制确保操作原子性

---

**功能状态**: ✅ 已实现并测试通过
**更新时间**: 2025-12-08
**关键功能**: 备料计划级联删除 ✅
