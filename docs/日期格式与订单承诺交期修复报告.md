# æ—¥æœŸæ ¼å¼ä¸è®¢å•æ‰¿è¯ºäº¤æœŸä¿®å¤æŠ¥å‘Š

## ä¿®å¤æ—¥æœŸ
2025-12-07

## ä¿®å¤å†…å®¹æ¦‚è¿°
æœ¬æ¬¡ä¿®å¤è§£å†³äº†ä¸‰ä¸ªå…³é”®é—®é¢˜ï¼š
1. **æ—¥æœŸæ ¼å¼ç»Ÿä¸€**ï¼šå°†æ—¶é—´å­—æ®µä»å®Œæ•´æ—¥æœŸæ—¶é—´æ ¼å¼è°ƒæ•´ä¸ºå¹´-æœˆ-æ—¥æ ¼å¼
2. **è®¢å•æ‰¿è¯ºäº¤æœŸæ˜ å°„é”™è¯¯**ï¼šä¿®æ­£ä¸»ç”Ÿäº§è®¡åˆ’çš„è®¢å•æ‰¿è¯ºäº¤æœŸå­—æ®µæ¥æº
3. **è®¡åˆ’å…¥åº“æ—¥æœŸè®¡ç®—éªŒè¯**ï¼šç¡®ä¿è®¡ç®—å…¬å¼æ­£ç¡®æ‰§è¡Œ

---

## é—®é¢˜1ï¼šæ—¥æœŸæ ¼å¼è°ƒæ•´

### éœ€æ±‚æè¿°
å°†ä»¥ä¸‹é¡µé¢çš„æ—¶é—´å’Œæ—¥æœŸå­—æ®µç»Ÿä¸€è°ƒæ•´ä¸º"å¹´-æœˆ-æ—¥"æ ¼å¼ï¼ˆYYYY-MM-DDï¼‰ï¼š

#### è®¢å•åˆ—è¡¨ï¼ˆhttp://localhost:3003/sales/orders/listï¼‰
- "ä¸‹å•æ—¶é—´"ï¼ˆorderTimeï¼‰ï¼šæ ¼å¼ å¹´-æœˆ-æ—¥

#### ä¸»ç”Ÿäº§è®¡åˆ’ï¼ˆhttp://localhost:3003/production-planning/plan-listï¼‰
- "è®¢å•æ‰¿è¯ºäº¤æœŸ"ï¼ˆpromisedDeliveryDateï¼‰ï¼šæ ¼å¼ å¹´-æœˆ-æ—¥
- "è®¡åˆ’å…¥åº“æ—¥æœŸ"ï¼ˆplannedStorageDateï¼‰ï¼šæ ¼å¼ å¹´-æœˆ-æ—¥

#### å¤‡æ–™è®¡åˆ’ï¼ˆhttp://localhost:3003/production-planning/material-preparationï¼‰
- "éœ€æ±‚æ—¥æœŸ"ï¼ˆdemandDateï¼‰ï¼šæ ¼å¼ å¹´-æœˆ-æ—¥
- "è®¢å•æ‰¿è¯ºäº¤æœŸ"ï¼ˆpromiseDeliveryDateï¼‰ï¼šæ ¼å¼ å¹´-æœˆ-æ—¥

### ä¿®å¤æ–¹æ¡ˆ

#### 1. é”€å”®è®¢å•åˆ—è¡¨
**æ–‡ä»¶**: `07-frontend/src/pages/sales/sales-order/SalesOrderListNew.vue`

```vue
<!-- ä¸‹å•æ—¶é—´åˆ—æ·»åŠ æ ¼å¼åŒ– -->
<el-table-column prop="orderTime" label="ä¸‹å•æ—¶é—´" width="120">
  <template #default="{ row }">
    {{ formatDateYMD(row.orderTime) }}
  </template>
</el-table-column>
```

#### 2. ä¸»ç”Ÿäº§è®¡åˆ’åˆ—è¡¨
**æ–‡ä»¶**: `07-frontend/src/pages/production-planning/ProductionPlanList.vue`

```javascript
// åˆ—å®šä¹‰ä¸­æ·»åŠ formatter
{
  prop: 'promisedDeliveryDate',
  label: 'è®¢å•æ‰¿è¯ºäº¤æœŸ',
  width: 120,
  sortable: true,
  formatter: (row) => formatDateYMD(row.promisedDeliveryDate)
},
{
  prop: 'plannedStorageDate',
  label: 'è®¡åˆ’å…¥åº“æ—¥æœŸ',
  width: 120,
  sortable: true,
  formatter: (row) => formatDateYMD(row.plannedStorageDate)
}

// æ·»åŠ æ ¼å¼åŒ–å‡½æ•°
formatDateYMD(dateStr) {
  if (!dateStr) return '-';
  try {
    const date = new Date(dateStr);
    if (isNaN(date.getTime())) return '-';
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  } catch (e) {
    return '-';
  }
}
```

#### 3. å¤‡æ–™è®¡åˆ’
**æ–‡ä»¶**: `07-frontend/src/pages/production-planning/MaterialPreparationPlan.vue`

```javascript
// åˆ—å®šä¹‰ä¸­æ·»åŠ formatter
{ 
  prop: 'demandDate', 
  label: 'éœ€æ±‚æ—¥æœŸ', 
  width: 120, 
  sortable: true, 
  filterable: true, 
  visible: true,
  formatter: (row) => formatDateYMD(row.demandDate) 
},
{ 
  prop: 'promiseDeliveryDate', 
  label: 'è®¢å•æ‰¿è¯ºäº¤æœŸ', 
  width: 120, 
  sortable: true, 
  filterable: true, 
  visible: true,
  formatter: (row) => formatDateYMD(row.promiseDeliveryDate) 
}

// æ·»åŠ æ ¼å¼åŒ–å‡½æ•°
const formatDateYMD = (dateStr) => {
  if (!dateStr) return '-'
  try {
    const date = new Date(dateStr)
    if (isNaN(date.getTime())) return '-'
    const year = date.getFullYear()
    const month = String(date.getMonth() + 1).padStart(2, '0')
    const day = String(date.getDate()).padStart(2, '0')
    return `${year}-${month}-${day}`
  } catch (e) {
    return '-'
  }
}
```

---

## é—®é¢˜2ï¼šä¸»ç”Ÿäº§è®¡åˆ’çš„"è®¢å•æ‰¿è¯ºäº¤æœŸ"æ˜ å°„é”™è¯¯

### é—®é¢˜æè¿°
**é”™è¯¯æ˜ å°„**ï¼š
```
ä¸»ç”Ÿäº§è®¡åˆ’.è®¢å•æ‰¿è¯ºäº¤æœŸ = é”€å”®è®¢å•.promisedDelivery
```

**æ­£ç¡®æ˜ å°„**ï¼š
```
ä¸»ç”Ÿäº§è®¡åˆ’.è®¢å•æ‰¿è¯ºäº¤æœŸ = é”€å”®è®¢å•.å®¢æˆ·äº¤æœŸï¼ˆcustomerDeliveryï¼‰
```

### å®é™…æ¡ˆä¾‹
- é”€å”®è®¢å•.å®¢æˆ·äº¤æœŸ = 2026-1-9
- ä¸»ç”Ÿäº§è®¡åˆ’.è®¢å•æ‰¿è¯ºäº¤æœŸ = 2026-1-8 âŒï¼ˆé”™è¯¯ï¼‰
- åº”è¯¥ä¸º = 2026-1-9 âœ…ï¼ˆæ­£ç¡®ï¼‰

### ä¿®å¤æ–¹æ¡ˆ

**æ–‡ä»¶**: `backend/routes/masterProductionPlans.js`

**ä¿®å¤å‰**:
```javascript
// æ ¼å¼åŒ–æ—¥æœŸ
const promisedDeliveryDate = formatDateForMySQL(order.promisedDeliveryDate || order.customerDeliveryDate);
```

**ä¿®å¤å**:
```javascript
// âœ… ä¿®å¤ï¼šè®¢å•æ‰¿è¯ºäº¤æœŸ = å®¢æˆ·äº¤æœŸ (customerDeliveryDate)
const promisedDeliveryDate = formatDateForMySQL(order.customerDeliveryDate);
```

### å½±å“èŒƒå›´
- ä¸»ç”Ÿäº§è®¡åˆ’åˆ›å»ºæ—¶çš„è®¢å•æ‰¿è¯ºäº¤æœŸå­—æ®µ
- å¤‡æ–™è®¡åˆ’ç»§æ‰¿çš„è®¢å•æ‰¿è¯ºäº¤æœŸå­—æ®µ
- æ‰€æœ‰ä¾èµ–è®¢å•æ‰¿è¯ºäº¤æœŸçš„è®¡ç®—é€»è¾‘

---

## é—®é¢˜3ï¼šè®¡åˆ’å…¥åº“æ—¥æœŸè®¡ç®—éªŒè¯

### è®¡ç®—å…¬å¼
```
è®¡åˆ’å…¥åº“æ—¥æœŸ = è®¢å•æ‰¿è¯ºäº¤æœŸ - æå‰å…¥åº“æœŸ
```

### è®¡ç®—æµç¨‹

#### 1. ç”¨æˆ·è®¾ç½®
```
æå‰å…¥åº“æœŸ = 3å¤©
â†“
ä¿å­˜åˆ°ï¼šsettings.advanceStorageDays
```

#### 2. æ­£å¼ä¸‹å•
```
è®¢å•æ‰¿è¯ºäº¤æœŸï¼š2026-1-9ï¼ˆä¿®å¤åä½¿ç”¨customerDeliveryï¼‰
æå‰å…¥åº“æœŸï¼š3å¤©
â†“
å‰ç«¯è¯»å–ï¼šsettings.advanceStorageDays = 3
â†“
ä¼ é€’ç»™åç«¯ï¼š{ salesOrders, advanceStorageDays: 3 }
```

#### 3. åç«¯è®¡ç®—
```javascript
// âœ… è®¡ç®—è®¡åˆ’å…¥åº“æ—¥æœŸ = è®¢å•æ‰¿è¯ºäº¤æœŸ - æå‰å…¥åº“æœŸ
let plannedStorageDate = null;
if (promisedDeliveryDate && advanceStorageDays !== undefined && advanceStorageDays !== null) {
  const deliveryDate = new Date(promisedDeliveryDate);
  deliveryDate.setDate(deliveryDate.getDate() - parseInt(advanceStorageDays || 0));
  plannedStorageDate = formatDateForMySQL(deliveryDate);
  
  console.log('ğŸ“… è®¡åˆ’å…¥åº“æ—¥æœŸè®¡ç®—:', {
    è®¢å•æ‰¿è¯ºäº¤æœŸ: promisedDeliveryDate,
    æå‰å¤©æ•°: advanceStorageDays,
    è®¡åˆ’å…¥åº“æ—¥æœŸ: plannedStorageDate
  });
}
```

#### 4. è®¡ç®—ç»“æœ
```
è®¢å•æ‰¿è¯ºäº¤æœŸï¼š2026-1-9
å‡å»å¤©æ•°ï¼š3å¤©
â†“
è®¡åˆ’å…¥åº“æ—¥æœŸ = 2026-1-6 âœ…
```

#### 5. ä¿å­˜åˆ°æ•°æ®åº“
```
master_production_plans.planned_storage_date = '2026-1-6'
```

### ä¿®å¤éªŒè¯

**æ–‡ä»¶**: `backend/routes/masterProductionPlans.js`

```javascript
// ç¬¬67-81è¡Œ
// âœ… ä¿®å¤ï¼šè®¢å•æ‰¿è¯ºäº¤æœŸ = å®¢æˆ·äº¤æœŸ (customerDeliveryDate)
const promisedDeliveryDate = formatDateForMySQL(order.customerDeliveryDate);

// âœ… è®¡ç®—è®¡åˆ’å…¥åº“æ—¥æœŸ = è®¢å•æ‰¿è¯ºäº¤æœŸ - æå‰å…¥åº“æœŸ
let plannedStorageDate = null;
if (promisedDeliveryDate && advanceStorageDays !== undefined && advanceStorageDays !== null) {
  const deliveryDate = new Date(promisedDeliveryDate);
  deliveryDate.setDate(deliveryDate.getDate() - parseInt(advanceStorageDays || 0));
  plannedStorageDate = formatDateForMySQL(deliveryDate);
  
  console.log('ğŸ“… è®¡åˆ’å…¥åº“æ—¥æœŸè®¡ç®—:', {
    è®¢å•æ‰¿è¯ºäº¤æœŸ: promisedDeliveryDate,  // ç°åœ¨ä½¿ç”¨æ­£ç¡®çš„customerDeliveryDate
    æå‰å¤©æ•°: advanceStorageDays,
    è®¡åˆ’å…¥åº“æ—¥æœŸ: plannedStorageDate
  });
}
```

---

## ä¿®æ”¹æ–‡ä»¶æ¸…å•

### å‰ç«¯æ–‡ä»¶
1. âœ… `07-frontend/src/pages/sales/sales-order/SalesOrderListNew.vue`
   - ä¸‹å•æ—¶é—´å­—æ®µæ·»åŠ æ ¼å¼åŒ–æ˜¾ç¤º

2. âœ… `07-frontend/src/pages/production-planning/ProductionPlanList.vue`
   - è®¢å•æ‰¿è¯ºäº¤æœŸå’Œè®¡åˆ’å…¥åº“æ—¥æœŸæ·»åŠ æ ¼å¼åŒ–
   - æ–°å¢formatDateYMDæ ¼å¼åŒ–å‡½æ•°

3. âœ… `07-frontend/src/pages/production-planning/MaterialPreparationPlan.vue`
   - éœ€æ±‚æ—¥æœŸå’Œè®¢å•æ‰¿è¯ºäº¤æœŸæ·»åŠ æ ¼å¼åŒ–
   - æ–°å¢formatDateYMDæ ¼å¼åŒ–å‡½æ•°

### åç«¯æ–‡ä»¶
4. âœ… `backend/routes/masterProductionPlans.js`
   - ä¿®æ­£è®¢å•æ‰¿è¯ºäº¤æœŸå­—æ®µæ¥æºä¸ºcustomerDeliveryDate
   - éªŒè¯è®¡åˆ’å…¥åº“æ—¥æœŸè®¡ç®—é€»è¾‘

---

## æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯1ï¼šæ—¥æœŸæ ¼å¼éªŒè¯
1. è®¿é—®é”€å”®è®¢å•åˆ—è¡¨ï¼šhttp://localhost:3003/sales/orders/list
2. æ£€æŸ¥"ä¸‹å•æ—¶é—´"åˆ—æ˜¯å¦æ˜¾ç¤ºä¸ºYYYY-MM-DDæ ¼å¼
3. è®¿é—®ä¸»ç”Ÿäº§è®¡åˆ’ï¼šhttp://localhost:3003/production-planning/plan-list
4. æ£€æŸ¥"è®¢å•æ‰¿è¯ºäº¤æœŸ"å’Œ"è®¡åˆ’å…¥åº“æ—¥æœŸ"æ˜¯å¦ä¸ºYYYY-MM-DDæ ¼å¼
5. è®¿é—®å¤‡æ–™è®¡åˆ’ï¼šhttp://localhost:3003/production-planning/material-preparation
6. æ£€æŸ¥"éœ€æ±‚æ—¥æœŸ"å’Œ"è®¢å•æ‰¿è¯ºäº¤æœŸ"æ˜¯å¦ä¸ºYYYY-MM-DDæ ¼å¼

### æµ‹è¯•åœºæ™¯2ï¼šè®¢å•æ‰¿è¯ºäº¤æœŸæ˜ å°„éªŒè¯
1. åˆ›å»ºä¸€ä¸ªé”€å”®è®¢å•ï¼Œå®¢æˆ·äº¤æœŸè®¾ç½®ä¸º2026-1-9
2. æ‰§è¡Œæ­£å¼ä¸‹å•
3. æŸ¥çœ‹ä¸»ç”Ÿäº§è®¡åˆ’ï¼Œè®¢å•æ‰¿è¯ºäº¤æœŸåº”ä¸º2026-1-9ï¼ˆè€Œé2026-1-8ï¼‰

### æµ‹è¯•åœºæ™¯3ï¼šè®¡åˆ’å…¥åº“æ—¥æœŸè®¡ç®—éªŒè¯
1. åœ¨é”€å”®è®¢å•é¡µé¢è®¾ç½®"æå‰å…¥åº“æœŸ"ä¸º3å¤©
2. åˆ›å»ºè®¢å•ï¼Œå®¢æˆ·äº¤æœŸè®¾ç½®ä¸º2026-1-9
3. æ‰§è¡Œæ­£å¼ä¸‹å•
4. æŸ¥çœ‹ä¸»ç”Ÿäº§è®¡åˆ’ï¼š
   - è®¢å•æ‰¿è¯ºäº¤æœŸ = 2026-1-9 âœ…
   - è®¡åˆ’å…¥åº“æ—¥æœŸ = 2026-1-6 âœ…ï¼ˆ2026-1-9 - 3å¤©ï¼‰

---

## æ•°æ®æµå›¾

```
é”€å”®è®¢å•åˆ—è¡¨
  â”œâ”€ å®¢æˆ·äº¤æœŸ (customerDelivery) = 2026-1-9
  â”œâ”€ æå‰å…¥åº“æœŸè®¾ç½® (advanceStorageDays) = 3å¤©
  â””â”€ æ­£å¼ä¸‹å•
      â†“
ä¸»ç”Ÿäº§è®¡åˆ’åˆ›å»º
  â”œâ”€ è®¢å•æ‰¿è¯ºäº¤æœŸ (promisedDeliveryDate) = 2026-1-9 âœ… (ä»customerDeliveryè·å–)
  â””â”€ è®¡åˆ’å…¥åº“æ—¥æœŸ (plannedStorageDate) = 2026-1-6 âœ… (2026-1-9 - 3å¤©)
      â†“
å¤‡æ–™è®¡åˆ’æ¨é€
  â”œâ”€ è®¢å•æ‰¿è¯ºäº¤æœŸ (promiseDeliveryDate) = 2026-1-9 âœ…
  â””â”€ éœ€æ±‚æ—¥æœŸ (demandDate) = 2026-1-6 âœ…
```

---

## æ³¨æ„äº‹é¡¹

1. **æ—¥æœŸæ ¼å¼ç»Ÿä¸€**ï¼šæ‰€æœ‰æ—¥æœŸæ˜¾ç¤ºç»Ÿä¸€ä¸ºYYYY-MM-DDæ ¼å¼ï¼Œä¾¿äºç”¨æˆ·é˜…è¯»
2. **æ•°æ®æºæ­£ç¡®æ€§**ï¼šä¸»ç”Ÿäº§è®¡åˆ’çš„è®¢å•æ‰¿è¯ºäº¤æœŸç°åœ¨æ­£ç¡®åœ°ä»é”€å”®è®¢å•çš„å®¢æˆ·äº¤æœŸè·å–
3. **è®¡ç®—å…¬å¼éªŒè¯**ï¼šè®¡åˆ’å…¥åº“æ—¥æœŸ = è®¢å•æ‰¿è¯ºäº¤æœŸ - æå‰å…¥åº“æœŸï¼Œå…¬å¼å·²éªŒè¯æ­£ç¡®
4. **å‘åå…¼å®¹**ï¼šæ ¼å¼åŒ–å‡½æ•°åŒ…å«å®¹é”™å¤„ç†ï¼Œå¯¹äºç©ºå€¼æˆ–æ— æ•ˆæ—¥æœŸè¿”å›"-"

---

## åç»­å»ºè®®

1. **æ•°æ®åº“å†å²æ•°æ®**ï¼šå»ºè®®æ£€æŸ¥å¹¶æ›´æ–°å·²å­˜åœ¨çš„ä¸»ç”Ÿäº§è®¡åˆ’è®°å½•ï¼Œç¡®ä¿è®¢å•æ‰¿è¯ºäº¤æœŸæ•°æ®æ­£ç¡®
2. **å•å…ƒæµ‹è¯•**ï¼šå»ºè®®æ·»åŠ æ—¥æœŸæ ¼å¼åŒ–å’Œæ—¥æœŸè®¡ç®—çš„å•å…ƒæµ‹è¯•
3. **ç”¨æˆ·åŸ¹è®­**ï¼šæé†’ç”¨æˆ·æ–°çš„æ—¥æœŸæ ¼å¼å˜åŒ–ï¼Œç¡®ä¿ç†è§£è®¡åˆ’å…¥åº“æ—¥æœŸçš„è®¡ç®—é€»è¾‘

---

## ä¿®å¤å®Œæˆç¡®è®¤

- âœ… é”€å”®è®¢å•åˆ—è¡¨æ—¥æœŸæ ¼å¼å·²è°ƒæ•´
- âœ… ä¸»ç”Ÿäº§è®¡åˆ’æ—¥æœŸæ ¼å¼å·²è°ƒæ•´
- âœ… å¤‡æ–™è®¡åˆ’æ—¥æœŸæ ¼å¼å·²è°ƒæ•´
- âœ… è®¢å•æ‰¿è¯ºäº¤æœŸæ˜ å°„å·²ä¿®æ­£ï¼ˆä½¿ç”¨customerDeliveryï¼‰
- âœ… è®¡åˆ’å…¥åº“æ—¥æœŸè®¡ç®—é€»è¾‘å·²éªŒè¯
- âœ… æ‰€æœ‰æ¶‰åŠæ–‡ä»¶å·²ä¿®æ”¹å®Œæˆ
- âœ… ä¿®å¤æŠ¥å‘Šå·²ç”Ÿæˆ

**ä¿®å¤å®Œæˆæ—¶é—´**ï¼š2025-12-07
**ä¿®å¤äººå‘˜**ï¼šAIæ™ºèƒ½ä½“
**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ
