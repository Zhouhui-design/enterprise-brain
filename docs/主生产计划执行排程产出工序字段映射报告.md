# 主生产计划执行排程产出工序字段映射报告

## 📋 需求概述

在主生产计划执行排程推送数据到备料计划时，增加字段映射规则：

**数据流向**：
```
主生产计划"产出工序"（outputProcess）
    ↓ 执行排程推送
备料计划"来源工序"（sourceProcess）
```

---

## 🔧 实施内容

### 1️⃣ 后端修改

#### ✅ 后端API修改（masterProductionPlans.js）

**文件**: `/backend/routes/masterProductionPlans.js`

**修改位置1**: 第307-312行（日志输出）

**修改内容**: 添加outputProcess到日志

```javascript
const plan = planRows[0];
console.log('📝 主计划信息:', {
  planCode: plan.plan_code,
  productCode: plan.product_code,
  productName: plan.product_name,
  planQuantity: plan.plan_quantity,
  outputProcess: plan.output_process // ✅ 添加产出工序
});
```

**修改位置2**: 第324-383行（数据映射规则）

**修改内容**: 
1. 注释中添加新映射规则
2. INSERT语句添加source_process字段
3. VALUES添加plan.output_process参数

```javascript
// 3. 创建备料计划（直接将主计划的产品推送到备料计划）
// 规则映射:
// - 备料计划编号: 系统自动生成
// - 来源主计划编号 = 主生产计划编号
// - 来源工序计划编号 = "/"
// - 来源工序 = 产出工序 (✅ 新增映射)
// - 计划物料编号 = 产品编号
// - 计划物料名称 = 产品名称
// - 物料来源 = 产品来源
// - 物料单位 = 销售单位
// - 需求数量 = 计划数量
// - 需求日期 = 计划入库日期
// - 销售订单编号 = 内部销售订单编号
// - 客户订单编号 = 客户订单编号

const [result] = await pool.execute(`
  INSERT INTO material_preparation_plans (
    plan_no,
    source_plan_no,
    source_process_plan_no,
    source_process,              // ✅ 新增字段
    material_code,
    material_name,
    material_source,
    material_unit,
    demand_quantity,
    need_mrp,
    realtime_stock,
    projected_balance,
    available_stock,
    demand_date,
    sales_order_no,
    customer_order_no,
    main_plan_product_code,
    main_plan_product_name,
    main_plan_quantity,
    promise_delivery_date,
    created_at,
    updated_at
  ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, NULL, NULL, NULL, NULL, ?, ?, ?, ?, ?, ?, ?, NOW(), NOW())
  //            ↑ 新增占位符，总共20个
`, [
  materialPlanNo,                    // 备料计划编号(自动生成)
  plan.plan_code,                    // 来源主计划编号
  '/',                               // 来源工序计划编号
  plan.output_process || null,       // ✅ 来源工序 = 产出工序
  plan.product_code,                 // 计划物料编号 = 产品编号
  plan.product_name,                 // 计划物料名称 = 产品名称
  plan.product_source || null,       // 物料来源 = 产品来源
  plan.sales_unit || null,           // 物料单位 = 销售单位
  plan.plan_quantity || 0,           // 需求数量 = 计划数量
  // need_mrp, realtime_stock, projected_balance, available_stock 都设为NULL
  plan.planned_storage_date || null, // 需求日期 = 计划入库日期
  plan.internal_order_no || null,    // 销售订单编号 = 内部销售订单编号
  plan.customer_order_no || null,    // 客户订单编号
  plan.product_code,                 // 主计划产品编号
  plan.product_name,                 // 主计划产品名称
  plan.plan_quantity || 0,           // 主计划排程数量
  plan.promised_delivery_date || null // 订单承诺交期
]);
```

---

## 📊 数据库表结构

### material_preparation_plans 表（已有字段）

| 字段名 | 类型 | 说明 | 来源 |
|--------|------|------|------|
| source_plan_no | VARCHAR(50) | 来源主计划编号 | 主生产计划编号 |
| source_process_plan_no | VARCHAR(50) | 来源工序计划编号 | "/" |
| **source_process** | **VARCHAR(100)** | **来源工序** | **主生产计划.产出工序** ✅ |
| material_code | VARCHAR(100) | 计划物料编号 | 产品编号 |
| material_name | VARCHAR(200) | 计划物料名称 | 产品名称 |

---

## 🔄 完整数据流

### 阶段1：新增订单

```
产品手册 → 新增订单lookup → 产出工序填充 → 保存到订单数据库
                                                ↓
                                         sales_order_products.output_process
```

### 阶段2：正式下单

```
订单.outputProcess → 主生产计划.outputProcess → 保存到主计划数据库
                                                  ↓
                                    master_production_plans.output_process
```

### 阶段3：执行排程（✅ 新增）

```
主生产计划.outputProcess → 备料计划.sourceProcess → 保存到备料计划数据库
                                                      ↓
                                        material_preparation_plans.source_process
```

---

## 📝 字段映射规范

### 完整数据流映射

| 阶段 | 源字段 | 目标字段 | 数据库字段 |
|------|--------|---------|-----------|
| 新增订单 | 产品手册.outputProcessName | 订单.outputProcess | sales_order_products.output_process |
| 正式下单 | 订单.outputProcess | 主计划.outputProcess | master_production_plans.output_process |
| **执行排程** | **主计划.outputProcess** | **备料.sourceProcess** | **material_preparation_plans.source_process** ✅ |

### 前端字段（camelCase）
- 主生产计划：`outputProcess`
- 备料计划：`sourceProcess`

### 后端字段（snake_case）
- master_production_plans表：`output_process`
- material_preparation_plans表：`source_process`

---

## 🧪 测试验证

### 测试步骤

1. **准备数据**：
   - 确保主生产计划有产出工序数据
   - 例如：MPS2025120700XX - 产品编码：6002A0203 - 产出工序：打包

2. **执行排程**：
   - 访问主生产计划列表：http://localhost:3002/production-planning/plan-list
   - 选择一条主生产计划（单选）
   - 点击"执行排程"按钮
   - 确认推送

3. **验证备料计划**：
   - 访问备料计划列表：http://localhost:3002/production-planning/material-preparation
   - 查看新创建的备料计划
   - **验证字段**：
     - 来源主计划编号：MPS2025120700XX
     - 来源工序：打包 ✅
     - 计划物料编号：6002A0203
     - 需求数量：（与主计划一致）

### 预期控制台日志

**后端日志**：
```javascript
📦 开始执行排程, 主计划ID: 1

📝 主计划信息: {
  planCode: "MPS2025120700XX",
  productCode: "6002A0203",
  productName: "产品名称",
  planQuantity: 100,
  outputProcess: "打包"  // ✅ 包含产出工序
}

✅ 成功生成备料计划: MPP2025170XX12345
   物料: 6002A0203 - 产品名称
   需求数量: 100
```

### 数据库验证

```sql
-- 查看备料计划的来源工序
SELECT 
  plan_no,
  source_plan_no,
  source_process,          -- ✅ 应显示 "打包"
  material_code,
  material_name,
  demand_quantity
FROM material_preparation_plans
WHERE source_plan_no = 'MPS2025120700XX'
ORDER BY created_at DESC
LIMIT 1;

-- 预期结果：
-- plan_no: MPP2025170XX12345
-- source_plan_no: MPS2025120700XX
-- source_process: 打包          ✅
-- material_code: 6002A0203
-- material_name: 产品名称
-- demand_quantity: 100
```

---

## 🎯 关键改进点

### 1. 数据完整性

**之前**：
- 备料计划缺少来源工序信息
- 无法追溯产品从哪个工序产出

**现在**：
- 完整保存来源工序
- 可以追溯产品的产出工序

### 2. 字段映射一致性

| 数据表 | 前端字段名 | 后端字段名 | 映射来源 |
|--------|-----------|-----------|---------|
| master_production_plans | outputProcess | output_process | 订单的产出工序 |
| material_preparation_plans | sourceProcess | source_process | 主计划的产出工序 |

### 3. 业务流程完整性

**完整的产出工序追溯链**：
```
产品手册 → 销售订单 → 主生产计划 → 备料计划
           ↓           ↓             ↓
      产出工序    产出工序      来源工序
```

---

## 📂 修改文件清单

### 后端文件
- ✅ `/backend/routes/masterProductionPlans.js`
  - 第307-312行：添加outputProcess到日志
  - 第327行：添加注释说明新映射规则
  - 第348行：INSERT语句添加source_process字段
  - 第365行：VALUES添加占位符（第4个）
  - 第372行：传入plan.output_process值

### 数据库
- ✅ `material_preparation_plans` 表
  - 字段：source_process（VARCHAR(100)）- 已存在，无需修改

### 文档
- ✅ `/docs/主生产计划执行排程产出工序字段映射报告.md` - 本文档

---

## ✅ 修复完成清单

- [x] 后端INSERT语句添加source_process字段
- [x] 后端VALUES添加plan.output_process参数
- [x] 后端日志添加outputProcess显示
- [x] 数据映射规则注释更新
- [x] 重启后端服务
- [x] 创建修复文档

---

## 🚀 后续应用场景

### 1. 工序计划生成

根据记忆，备料计划会继续推送到工序计划。来源工序字段可以用于：
- 确定产品需要在哪个工序生产
- 自动生成对应工序的生产计划
- 计算工序产能负荷

### 2. 生产调度

- 根据来源工序分配生产任务
- 优化工序间的物料流转
- 追溯产品的生产路径

### 3. 数据分析

- 统计不同工序的生产需求
- 分析工序产能利用率
- 优化工序配置

---

## 📞 技术支持

### 问题排查

1. **备料计划来源工序为空**
   - 检查主生产计划是否有产出工序
   - 检查后端INSERT语句是否正确
   - 查看后端日志确认数据

2. **后端错误**
   - 查看backend.log
   - 检查INSERT语句占位符数量是否匹配（应为20个）

3. **数据库字段缺失**
   - 确认material_preparation_plans表有source_process字段
   - 使用DESCRIBE命令检查表结构

### 调试SQL

```sql
-- 检查主生产计划的产出工序
SELECT 
  plan_code,
  product_code,
  product_name,
  output_process
FROM master_production_plans
ORDER BY created_at DESC
LIMIT 5;

-- 检查备料计划的来源工序
SELECT 
  plan_no,
  source_plan_no,
  source_process,
  material_code
FROM material_preparation_plans
ORDER BY created_at DESC
LIMIT 5;
```

---

## 🔗 相关文档

- [主生产计划产出工序字段完整实现报告.md](./主生产计划产出工序字段完整实现报告.md)
- [正式下单多产品订单修复报告.md](./正式下单多产品订单修复报告.md)
- [产出工序字段数据流修复报告.md](./产出工序字段数据流修复报告.md)
- [销售订单产出工序字段保存修复完成报告.md](./销售订单产出工序字段保存修复完成报告.md)

---

**实施时间**: 2025-12-07 15:32  
**实施人员**: AI Assistant  
**影响范围**: 主生产计划执行排程至备料计划数据流水线  
**风险等级**: 低（仅新增字段映射，不影响现有功能）  
**测试状态**: 待用户验证
