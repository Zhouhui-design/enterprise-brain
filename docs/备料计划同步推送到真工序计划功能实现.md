# å¤‡æ–™è®¡åˆ’åŒæ­¥æ¨é€åˆ°çœŸå·¥åºè®¡åˆ’åŠŸèƒ½å®ç°

## âœ… åŠŸèƒ½æ¦‚è¿°
å®ç°äº†ä»ä¸»ç”Ÿäº§è®¡åˆ’ â†’ å¤‡æ–™è®¡åˆ’ â†’ **å·¥åºè®¡åˆ’ + çœŸå·¥åºè®¡åˆ’**çš„å®Œæ•´è‡ªåŠ¨åŒ–æ•°æ®æµæ°´çº¿ã€‚

## å®Œæ•´æ•°æ®æµ

```
é”€å”®è®¢å•ï¼ˆæ­£å¼ä¸‹å•ï¼‰
    â†“
ä¸»ç”Ÿäº§è®¡åˆ’
    â†“ æ‰§è¡Œæ’ç¨‹
å¤‡æ–™è®¡åˆ’ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
    â†“ è‡ªåŠ¨æ¨é€ï¼ˆåŒæ­¥ï¼‰
    â”œâ”€ å·¥åºè®¡åˆ’ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
    â””â”€ çœŸå·¥åºè®¡åˆ’ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰âœ… æ–°å¢
```

## è§¦å‘æ¡ä»¶

### è§¦å‘æ—¶æœº
- **ä»»ä½•æ–¹å¼åˆ›å»ºå¤‡æ–™è®¡åˆ’æ—¶è‡ªåŠ¨è§¦å‘**ï¼š
  1. ä¸»ç”Ÿäº§è®¡åˆ’æ‰§è¡Œæ’ç¨‹æ—¶åˆ›å»ºå¤‡æ–™è®¡åˆ’
  2. æ‰‹åŠ¨æ–°å¢å¤‡æ–™è®¡åˆ’
  3. å¯¼å…¥å¤‡æ–™è®¡åˆ’
  4. APIè°ƒç”¨åˆ›å»ºå¤‡æ–™è®¡åˆ’

### æ¨é€æ¡ä»¶
1. âœ… å¤‡æ–™è®¡åˆ’ç¼–å·ä¸ä¸ºç©ºï¼ˆç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆï¼‰
2. âœ… ç‰©æ–™æ¥æº = 'è‡ªåˆ¶'
3. âœ… éœ€è¡¥è´§æ•°é‡ > 0

### åŒæ­¥æ¨é€é€»è¾‘
- **ä½ç½®**: Serviceå±‚ï¼ˆ`MaterialPreparationPlanService.create`æ–¹æ³•ï¼‰
- **æ—¶æœº**: åˆ›å»ºå¤‡æ–™è®¡åˆ’çš„åŒæ—¶è‡ªåŠ¨æ¨é€
- **ç›®æ ‡**: åŒæ—¶æ¨é€åˆ°å·¥åºè®¡åˆ’å’ŒçœŸå·¥åºè®¡åˆ’
- **äº‹åŠ¡**: ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§

## æ•°æ®æ˜ å°„è§„åˆ™

### å¤‡æ–™è®¡åˆ’ â†’ å·¥åºè®¡åˆ’
| å·¥åºè®¡åˆ’å­—æ®µ | æ˜ å°„è§„åˆ™ | æ¥æºå­—æ®µ |
|-------------|---------|---------|
| å·¥åºè®¡åˆ’ç¼–å· | ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ | `PP{å¹´ä»½}{æ—¶é—´æˆ³}{éšæœºæ•°}` |
| é”€å”®è®¢å•ç¼–å· | = | salesOrderNo |
| ä¸»ç”Ÿäº§è®¡åˆ’ç¼–å· | = | sourcePlanNo |
| ç”Ÿäº§äº§å“ç¼–å· | = | materialCode |
| ç”Ÿäº§äº§å“åç§° | = | materialName |
| å·¥åºåç§° | = | sourceProcess |
| äº§å“å•ä½ | = | materialUnit |
| 0é˜¶éœ€æ±‚æ•°é‡ | = | mainPlanQuantity |
| **è®¡åˆ’å®Œå·¥æ—¥æœŸ** | **è®¡ç®—** | **demandDate - 1å¤©** |
| éœ€è¡¥è´§æ•°é‡ | è®¡ç®— | demandQuantity - availableStock |
| å®šæ—¶å·¥é¢ | lookup | materials.standard_time |
| å®šé¢å·¥æ—¶ | lookup | materials.quota_time |
| å®¢æˆ·åç§° | = | customerName |
| æ¥æºç¼–å· | = | planNoï¼ˆå¤‡æ–™è®¡åˆ’ç¼–å·ï¼‰|
| æ’ç¨‹æ¬¡æ•° | å›ºå®šå€¼ | 1 |
| æäº¤äºº | = | createdByï¼ˆé»˜è®¤adminï¼‰|
| æäº¤æ—¶é—´ | ç³»ç»Ÿç”Ÿæˆ | NOW() |

### å¤‡æ–™è®¡åˆ’ â†’ çœŸå·¥åºè®¡åˆ’ âœ… æ–°å¢
| çœŸå·¥åºè®¡åˆ’å­—æ®µ | æ˜ å°„è§„åˆ™ | æ¥æºå­—æ®µ |
|-------------|---------|---------|
| å·¥åºè®¡åˆ’ç¼–å· | ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ | `RPP{å¹´ä»½}{æ—¶é—´æˆ³}{éšæœºæ•°}` |
| é”€å”®è®¢å•ç¼–å· | = | salesOrderNo |
| ä¸»ç”Ÿäº§è®¡åˆ’ç¼–å· | = | sourcePlanNo |
| ç”Ÿäº§äº§å“ç¼–å· | = | materialCode |
| ç”Ÿäº§äº§å“åç§° | = | materialName |
| å·¥åºåç§° | = | sourceProcess |
| äº§å“å•ä½ | = | materialUnit |
| 0é˜¶éœ€æ±‚æ•°é‡ | = | mainPlanQuantity |
| **è®¡åˆ’å®Œå·¥æ—¥æœŸ** | **è®¡ç®—** | **demandDate - 1å¤©** |
| éœ€è¡¥è´§æ•°é‡ | è®¡ç®— | demandQuantity - availableStock |
| å®šæ—¶å·¥é¢ | lookup | materials.standard_time |
| å®šé¢å·¥æ—¶ | lookup | materials.quota_time |
| å®¢æˆ·åç§° | = | customerName |
| æ¥æºç¼–å· | = | planNoï¼ˆå¤‡æ–™è®¡åˆ’ç¼–å·ï¼‰|
| æ’ç¨‹æ¬¡æ•° | å›ºå®šå€¼ | 1 |
| æäº¤äºº | = | createdByï¼ˆé»˜è®¤adminï¼‰|
| æäº¤æ—¶é—´ | ç³»ç»Ÿç”Ÿæˆ | NOW() |

**âœ… æ•°æ®å®Œå…¨ä¸€è‡´ï¼Œä»…ç¼–å·å‰ç¼€ä¸åŒï¼š**
- å·¥åºè®¡åˆ’ï¼š`PP` å‰ç¼€
- çœŸå·¥åºè®¡åˆ’ï¼š`RPP` å‰ç¼€

## å®ç°ç»†èŠ‚

### æ ¸å¿ƒä»£ç ä¿®æ”¹
**æ–‡ä»¶**: `backend/services/materialPreparationPlanService.js`

**ä¿®æ”¹ä½ç½®**: `create` æ–¹æ³•ä¸­ï¼Œç¬¬297-351è¡Œ

**å…³é”®é€»è¾‘**:
```javascript
// åœ¨æ¨é€åˆ°å·¥åºè®¡åˆ’åï¼Œç«‹å³æ¨é€åˆ°çœŸå·¥åºè®¡åˆ’
const realProcessPlanNo = `RPP${year}${timestamp}${random}`;
console.log('ğŸ”„ åŒæ­¥æ¨é€åˆ°çœŸå·¥åºè®¡åˆ’...');

await connection.execute(`
  INSERT INTO real_process_plans (
    plan_no, sales_order_no, master_plan_no,
    product_code, product_name, process_name,
    product_unit, level0_demand, completion_date,
    replenishment_qty, standard_work_quota, standard_work_hours,
    customer_name, source_no, schedule_count,
    submitted_by, submitted_at
  ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, NOW())
`, [
  realProcessPlanNo,          // çœŸå·¥åºè®¡åˆ’ç¼–å·ï¼ˆRPPå‰ç¼€ï¼‰
  data.salesOrderNo || null,
  data.sourcePlanNo || null,
  data.materialCode || null,
  data.materialName || null,
  data.sourceProcess || null,
  data.materialUnit || null,
  data.mainPlanQuantity || 0,
  completionDate,
  replenishmentQty,
  standardWorkQuota,
  standardWorkHours,
  data.customerName || null,
  data.planNo || null,        // æ¥æºç¼–å· = å¤‡æ–™è®¡åˆ’ç¼–å·
  1,                          // æ’ç¨‹æ¬¡æ•° = 1
  data.createdBy || 'admin'
]);

console.log(`âœ… è‡ªåŠ¨ç”ŸæˆçœŸå·¥åºè®¡åˆ’: ${realProcessPlanNo}`);
```

## æ“ä½œæ­¥éª¤

### ç”¨æˆ·æ“ä½œæµç¨‹
1. è¿›å…¥ä¸»ç”Ÿäº§è®¡åˆ’åˆ—è¡¨é¡µé¢ (`http://localhost:3007/production-planning/plan-list`)
2. é€‰æ‹©ä¸€æ¡ä¸»ç”Ÿäº§è®¡åˆ’ï¼ˆå‹¾é€‰æ¡†ï¼‰
3. ç‚¹å‡»"æ‰§è¡Œæ’ç¨‹"æŒ‰é’®
4. ç¡®è®¤æ’ç¨‹ä¿¡æ¯
5. ç³»ç»Ÿè‡ªåŠ¨å®Œæˆï¼š
   - âœ… ç”Ÿæˆ1æ¡å¤‡æ–™è®¡åˆ’
   - âœ… è‡ªåŠ¨æ¨é€ç”Ÿæˆ1æ¡å·¥åºè®¡åˆ’
   - âœ… è‡ªåŠ¨æ¨é€ç”Ÿæˆ1æ¡çœŸå·¥åºè®¡åˆ’ âœ… æ–°å¢
6. æŸ¥çœ‹ç»“æœï¼š
   - å¤‡æ–™è®¡åˆ’é¡µé¢ (`http://localhost:3007/production-planning/material-preparation`)
   - å·¥åºè®¡åˆ’é¡µé¢ (`http://localhost:3007/production-planning/process-plan`)
   - çœŸå·¥åºè®¡åˆ’é¡µé¢ (`http://localhost:3007/process-planning/real-process-plan`) âœ… æ–°å¢

## éªŒè¯æ–¹æ³•

### æµ‹è¯•æ­¥éª¤
1. **å‰ç½®æ¡ä»¶**:
   - ç¡®ä¿æœ‰å·²å®¡æ ¸çš„é”€å”®è®¢å•
   - ç¡®ä¿ä¸»ç”Ÿäº§è®¡åˆ’å·²åˆ›å»º
   - ç¡®ä¿äº§å“ç‰©æ–™åº“ä¸­æœ‰å¯¹åº”çš„ç‰©æ–™æ•°æ®ï¼ˆå«å®šæ—¶å·¥é¢ã€å®šé¢å·¥æ—¶ï¼‰

2. **æ‰§è¡Œæµ‹è¯•**:
   ```bash
   # è®¿é—®ä¸»ç”Ÿäº§è®¡åˆ’é¡µé¢
   http://localhost:3007/production-planning/plan-list
   
   # é€‰æ‹©ä¸€æ¡è®¡åˆ’ï¼Œç‚¹å‡»"æ‰§è¡Œæ’ç¨‹"
   # æŸ¥çœ‹æç¤ºä¿¡æ¯ï¼Œåº”æ˜¾ç¤ºï¼š
   # "æ’ç¨‹æ‰§è¡ŒæˆåŠŸï¼Œç”Ÿæˆ1æ¡å¤‡æ–™è®¡åˆ’ã€1æ¡å·¥åºè®¡åˆ’"
   ```

3. **éªŒè¯ç»“æœ**:
   ```bash
   # æ–¹æ³•1: æŸ¥çœ‹åç«¯æ—¥å¿—
   tail -f /home/sardenesy/ai_workspaces/ai_desktop_3/backend/backend.log
   
   # åº”çœ‹åˆ°ä»¥ä¸‹æ—¥å¿—ï¼š
   # âœ… è‡ªåŠ¨ç”Ÿæˆå·¥åºè®¡åˆ’: PP202512...
   # ğŸ”„ åŒæ­¥æ¨é€åˆ°çœŸå·¥åºè®¡åˆ’...
   # âœ… è‡ªåŠ¨ç”ŸæˆçœŸå·¥åºè®¡åˆ’: RPP202512...
   ```

4. **é¡µé¢éªŒè¯**:
   - è®¿é—®å¤‡æ–™è®¡åˆ’é¡µé¢ï¼Œç¡®è®¤æ–°è®°å½•å­˜åœ¨
   - è®¿é—®å·¥åºè®¡åˆ’é¡µé¢ï¼Œç¡®è®¤æ–°è®°å½•å­˜åœ¨ï¼ˆPPå‰ç¼€ï¼‰
   - è®¿é—®çœŸå·¥åºè®¡åˆ’é¡µé¢ï¼Œç¡®è®¤æ–°è®°å½•å­˜åœ¨ï¼ˆRPPå‰ç¼€ï¼‰âœ… æ–°å¢
   - éªŒè¯æ•°æ®å­—æ®µä¸€è‡´æ€§

### SQLéªŒè¯è„šæœ¬
```sql
-- æŸ¥è¯¢æœ€æ–°çš„å¤‡æ–™è®¡åˆ’
SELECT * FROM material_preparation_plans 
ORDER BY created_at DESC LIMIT 1;

-- æŸ¥è¯¢å¯¹åº”çš„å·¥åºè®¡åˆ’
SELECT * FROM process_plans 
WHERE source_no = 'ä¸Šé¢æŸ¥è¯¢åˆ°çš„å¤‡æ–™è®¡åˆ’ç¼–å·'
ORDER BY created_at DESC;

-- æŸ¥è¯¢å¯¹åº”çš„çœŸå·¥åºè®¡åˆ’ âœ… æ–°å¢
SELECT * FROM real_process_plans 
WHERE source_no = 'ä¸Šé¢æŸ¥è¯¢åˆ°çš„å¤‡æ–™è®¡åˆ’ç¼–å·'
ORDER BY created_at DESC;

-- éªŒè¯æ•°æ®ä¸€è‡´æ€§
SELECT 
  mp.plan_no AS 'å¤‡æ–™è®¡åˆ’ç¼–å·',
  pp.plan_no AS 'å·¥åºè®¡åˆ’ç¼–å·',
  rpp.plan_no AS 'çœŸå·¥åºè®¡åˆ’ç¼–å·',
  pp.replenishment_qty AS 'å·¥åºè®¡åˆ’éœ€è¡¥è´§æ•°é‡',
  rpp.replenishment_qty AS 'çœŸå·¥åºè®¡åˆ’éœ€è¡¥è´§æ•°é‡',
  pp.standard_work_quota AS 'å·¥åºè®¡åˆ’å®šæ—¶å·¥é¢',
  rpp.standard_work_quota AS 'çœŸå·¥åºè®¡åˆ’å®šæ—¶å·¥é¢'
FROM material_preparation_plans mp
LEFT JOIN process_plans pp ON pp.source_no = mp.plan_no
LEFT JOIN real_process_plans rpp ON rpp.source_no = mp.plan_no
ORDER BY mp.created_at DESC LIMIT 1;
```

## æ¶‰åŠæ–‡ä»¶

### åç«¯
- âœ… `backend/services/materialPreparationPlanService.js` - **æ ¸å¿ƒä¿®æ”¹**ï¼ˆæ·»åŠ çœŸå·¥åºè®¡åˆ’æ¨é€é€»è¾‘ï¼‰

### æ•°æ®åº“è¡¨
- `material_preparation_plans` - å¤‡æ–™è®¡åˆ’è¡¨
- `process_plans` - å·¥åºè®¡åˆ’è¡¨
- `real_process_plans` - çœŸå·¥åºè®¡åˆ’è¡¨ âœ…
- `materials` - äº§å“ç‰©æ–™åº“è¡¨ï¼ˆlookupå®šæ—¶å·¥é¢ã€å®šé¢å·¥æ—¶ï¼‰

### å‰ç«¯é¡µé¢
- `07-frontend/src/pages/production-planning/ProductionPlanList.vue` - ä¸»ç”Ÿäº§è®¡åˆ’
- `07-frontend/src/pages/production-planning/MaterialPreparationPlan.vue` - å¤‡æ–™è®¡åˆ’
- `07-frontend/src/pages/production-planning/ProcessPlanList.vue` - å·¥åºè®¡åˆ’
- `07-frontend/src/pages/production-planning/RealProcessPlanList.vue` - çœŸå·¥åºè®¡åˆ’ âœ…

## æŠ€æœ¯ä¼˜åŠ¿

### 1. ç»Ÿä¸€çš„è‡ªåŠ¨åŒ–é€»è¾‘
- âœ… Serviceå±‚ç»Ÿä¸€å¤„ç†ï¼Œæ‰€æœ‰åˆ›å»ºæ–¹å¼éƒ½è‡ªåŠ¨æ¨é€
- âœ… å·¥åºè®¡åˆ’å’ŒçœŸå·¥åºè®¡åˆ’åŒæ­¥åˆ›å»ºï¼Œæ•°æ®ä¸€è‡´
- âœ… æ˜“äºç»´æŠ¤å’Œæ‰©å±•

### 2. äº‹åŠ¡ä¿è¯
- âœ… ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡
- âœ… å¤‡æ–™è®¡åˆ’ã€å·¥åºè®¡åˆ’ã€çœŸå·¥åºè®¡åˆ’è¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥
- âœ… ç¡®ä¿æ•°æ®ä¸€è‡´æ€§

### 3. å®Œæ•´çš„æ—¥å¿—
- âœ… æ¯æ¬¡æ¨é€éƒ½æœ‰è¯¦ç»†æ—¥å¿—
- âœ… ä¾¿äºè°ƒè¯•å’Œè¿½è¸ª
- âœ… ç”Ÿäº§ç¯å¢ƒå¯ç›‘æ§

## ä¿®æ”¹è®°å½•
- **æ—¶é—´**: 2025-12-11 17:15
- **éœ€æ±‚**: å¤‡æ–™è®¡åˆ’è‡ªåŠ¨æ¨é€åˆ°çœŸå·¥åºè®¡åˆ’
- **ä¿®æ”¹**: åœ¨å¤‡æ–™è®¡åˆ’Serviceçš„createæ–¹æ³•ä¸­ï¼Œæ·»åŠ çœŸå·¥åºè®¡åˆ’æ¨é€é€»è¾‘
- **å½±å“**: ä¸»ç”Ÿäº§è®¡åˆ’æ‰§è¡Œæ’ç¨‹åï¼ŒåŒæ—¶ç”Ÿæˆå·¥åºè®¡åˆ’å’ŒçœŸå·¥åºè®¡åˆ’
- **æµ‹è¯•**: éœ€éªŒè¯æ•°æ®ä¸€è‡´æ€§å’Œäº‹åŠ¡å®Œæ•´æ€§
