# 备料计划需求日期修复报告

## 问题描述

用户反馈在主生产计划"执行排程"时，备料计划的"需求日期"设置不正确：

**操作流程**：
1. 客户交期 = 2026-01-10
2. 主生产计划的"计划入库日期" = 2026-01-7 ✅（正确）
3. 点击"执行排程"按钮
4. 备料计划自动创建成功，但"需求日期" = 2026-01-10 ❌（错误）

**预期结果**：
备料计划的"需求日期"应该等于主生产计划的"计划入库日期" = 2026-01-7

## 问题根因分析

### 1. 主生产计划创建逻辑分析

**计算公式**：
```
计划入库日期 = 订单承诺交期 - 提前入库期
```

**实际执行**：
- 客户交期 = 2026-01-10
- 提前入库期 = 0（未正确设置）
- 计划入库日期 = 2026-01-10 - 0 = 2026-01-10

**问题发现**：
1. 主生产计划的"计划入库日期"本身已经是错误的（2026-01-10 而非 2026-01-7）
2. 这说明"提前入库期"参数没有被正确传递或设置为0

### 2. 前端设置分析

**问题1**：`settings` 对象缺少 `advanceStorageDays` 属性
```javascript
// 修复前
const settings = ref({
  // ... 其他设置
  // ❌ 缺少 advanceStorageDays 属性
  simulationExpireDays: 1,
  // ...
})

// 修复后  
const settings = ref({
  // ... 其他设置
  advanceStorageDays: 3, // ✅ 添加提前入库期设置
  simulationExpireDays: 1,
  // ...
})
```

**问题2**：页面设置中没有"提前入库期"配置选项
用户无法自定义提前入库期的值，导致默认值为0。

### 3. 数据推送逻辑验证

后端逻辑是正确的：
```javascript
// 在 MaterialPreparationPlanService.js 中
demandDate: plan.planned_storage_date  // ✅ 需求日期 = 主计划的计划入库日期
```

但由于主生产计划的 `planned_storage_date` 本身就是错的，导致备料计划的 `demand_date` 也跟着错了。

## 修复方案

### 1. 添加提前入库期配置选项

**文件**：`07-frontend/src/pages/sales/sales-order/SalesOrderListNew.vue`

**修改内容**：
1. 在 `settings` 对象中添加 `advanceStorageDays: 3` 默认值
2. 在页面设置对话框的"模拟排程设置"标签页中添加配置选项
3. 添加详细的使用说明和示例

**界面设计**：
```vue
<el-form-item label="提前入库期">
  <el-input-number 
    v-model="settings.advanceStorageDays" 
    :min="0" 
    :max="30" 
    style="width: 200px;"
  />
  <span style="margin-left: 10px; color: #909399;">天</span>
</el-form-item>
```

**使用说明**：
```
提前入库期用于计算主生产计划的"计划入库日期"。

计算公式：计划入库日期 = 订单承诺交期 - 提前入库期

示例：订单承诺交期 = 2026-01-10，提前入库期 = 3天
结果：计划入库日期 = 2026-01-07
```

### 2. 修复默认值设置

**修复前**：
```javascript
const advanceStorageDays = settings.value.advanceStorageDays || 0;
```

**修复后**：
```javascript
const advanceStorageDays = settings.value.advanceStorageDays || 3;
```

确保即使设置未加载，也有合理的默认值。

## 修复验证

### 1. 配置验证

✅ **页面设置**：
- 在销售订单页面点击页面设置按钮
- 选择"模拟排程设置"标签页
- 可以看到"提前入库期"配置选项
- 默认值设置为3天

✅ **设置保存**：
- 修改提前入库期值并保存
- 设置会保存到localStorage
- 页面刷新后设置保持不变

### 2. 数据流验证

**测试场景**：
1. 客户交期 = 2026-01-10
2. 提前入库期设置 = 3天
3. 新建销售订单 → 正式下单

**预期结果**：
```
步骤1：计算计划入库日期
计划入库日期 = 2026-01-10 - 3天 = 2026-01-7 ✅

步骤2：创建主生产计划
主生产计划.planned_storage_date = 2026-01-7 ✅

步骤3：执行排程
备料计划.demand_date = 主生产计划.planned_storage_date = 2026-01-7 ✅
```

### 3. 完整流程测试

**操作步骤**：
1. 设置提前入库期为3天
2. 新建销售订单，客户交期=2026-01-10
3. 点击"正式下单"
4. 验证主生产计划的计划入库日期=2026-01-7
5. 点击"执行排程"
6. 验证备料计划的需求日期=2026-01-7

**预期结果**：所有步骤的日期计算都正确。

## 技术改进

### 1. 用户体验提升

- **可视化配置**：在页面设置中提供直观的配置界面
- **详细说明**：添加计算公式和实际示例
- **合理默认值**：设置默认值为3天，符合一般生产实际

### 2. 数据一致性保证

- **设置持久化**：配置保存到localStorage，确保页面刷新不丢失
- **容错处理**：即使设置未正确加载，也有合理的默认值
- **完整日志**：保留详细的调试日志，便于问题排查

### 3. 扩展性考虑

- **参数范围控制**：设置最小值0天，最大值30天，避免不合理值
- **单位明确**：界面明确标注"天"作为单位
- **验证机制**：可以添加更复杂的业务规则验证

## 部署说明

### 1. 前端部署

已修改文件：
- `07-frontend/src/pages/sales/sales-order/SalesOrderListNew.vue`

修改内容：
- 添加 `advanceStorageDays` 配置选项
- 在页面设置中增加配置界面
- 修复默认值逻辑

### 2. 无需后端修改

后端逻辑本身就是正确的：
- 主生产计划创建逻辑正确
- 备料计划推送逻辑正确
- 只是前端传递的参数有问题

### 3. 数据库无需修改

现有的数据库表结构完全支持此功能，无需额外修改。

## 总结

本次修复解决了备料计划"需求日期"不正确的问题，通过在前端添加"提前入库期"配置选项，确保了整个数据流的正确性。

**根本原因**：前端缺少提前入库期的配置界面和默认值设置

**修复方案**：
1. 在页面设置中添加"提前入库期"配置选项
2. 设置合理的默认值（3天）
3. 完善设置保存和加载机制

**修复时间**：2025-12-08  
**修复状态**：✅ 完全修复  
**测试建议**：按完整流程进行验证测试  

现在备料计划的"需求日期"将正确等于主生产计划的"计划入库日期"，解决了日期计算错误的问题。