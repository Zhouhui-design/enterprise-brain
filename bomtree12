-- 1. 产品表
CREATE TABLE products (
    id INT PRIMARY KEY AUTO_INCREMENT,
    product_code VARCHAR(50) UNIQUE NOT NULL COMMENT '产品编码',
    product_name VARCHAR(200) NOT NULL COMMENT '产品名称',
    specification TEXT COMMENT '产品规格',
    unit VARCHAR(20) COMMENT '计量单位',
    product_type ENUM('成品', '半成品', '原材料') DEFAULT '成品' COMMENT '产品类型',
    status ENUM('active', 'inactive', 'archived') DEFAULT 'active' COMMENT '状态',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_product_code (product_code),
    INDEX idx_product_type (product_type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='产品基础表';

-- 2. 工序表
CREATE TABLE processes (
    id INT PRIMARY KEY AUTO_INCREMENT,
    process_code VARCHAR(50) UNIQUE NOT NULL COMMENT '工序编码',
    process_name VARCHAR(100) NOT NULL COMMENT '工序名称',
    description TEXT COMMENT '工序描述',
    standard_time DECIMAL(10,2) COMMENT '标准工时(小时)',
    cost_per_hour DECIMAL(10,2) COMMENT '小时成本',
    status ENUM('active', 'inactive') DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_process_code (process_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='工序表';

-- 3. BOM树模板表
CREATE TABLE bom_templates (
    id INT PRIMARY KEY AUTO_INCREMENT,
    template_code VARCHAR(50) UNIQUE NOT NULL COMMENT '模板编码',
    template_name VARCHAR(200) NOT NULL COMMENT '模板名称',
    description TEXT COMMENT '模板描述',
    max_levels INT DEFAULT 20 COMMENT '最大层级数',
    nodes_per_level INT DEFAULT 30 COMMENT '每层节点数',
    structure_config JSON COMMENT '结构配置',
    created_by VARCHAR(50) COMMENT '创建人',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_template_code (template_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='BOM树模板表';

-- 4. BOM树实例表
CREATE TABLE bom_instances (
    id INT PRIMARY KEY AUTO_INCREMENT,
    bom_code VARCHAR(50) UNIQUE NOT NULL COMMENT 'BOM编码',
    bom_name VARCHAR(200) NOT NULL COMMENT 'BOM名称',
    product_id INT NOT NULL COMMENT '产品ID',
    template_id INT COMMENT '模板ID',
    version VARCHAR(20) DEFAULT '1.0' COMMENT '版本号',
    status ENUM('draft', 'active', 'obsolete') DEFAULT 'draft' COMMENT '状态',
    effective_date DATE COMMENT '生效日期',
    expiry_date DATE COMMENT '失效日期',
    created_by VARCHAR(50) COMMENT '创建人',
    approved_by VARCHAR(50) COMMENT '审核人',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (product_id) REFERENCES products(id),
    FOREIGN KEY (template_id) REFERENCES bom_templates(id),
    INDEX idx_bom_code (bom_code),
    INDEX idx_product_id (product_id),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='BOM实例表';

-- 5. BOM节点关系表（用于存储列表式BOM）
CREATE TABLE bom_nodes (
    id INT PRIMARY KEY AUTO_INCREMENT,
    bom_instance_id INT NOT NULL COMMENT 'BOM实例ID',
    node_address VARCHAR(20) NOT NULL COMMENT '节点地址(L0, L1-1等)',
    product_id INT NOT NULL COMMENT '产品ID',
    process_id INT COMMENT '工序ID',
    parent_node_id INT COMMENT '父节点ID',
    quantity DECIMAL(12,4) NOT NULL DEFAULT 1 COMMENT '数量',
    scrap_rate DECIMAL(5,2) DEFAULT 0 COMMENT '损耗率(%)',
    unit_cost DECIMAL(15,4) COMMENT '单位成本',
    total_cost DECIMAL(15,4) COMMENT '总成本',
    lead_time INT COMMENT '提前期(天)',
    sort_order INT DEFAULT 0 COMMENT '排序',
    level INT NOT NULL COMMENT '层级',
    is_leaf BOOLEAN DEFAULT FALSE COMMENT '是否叶节点',
    attributes JSON COMMENT '扩展属性',
    FOREIGN KEY (bom_instance_id) REFERENCES bom_instances(id) ON DELETE CASCADE,
    FOREIGN KEY (product_id) REFERENCES products(id),
    FOREIGN KEY (process_id) REFERENCES processes(id),
    FOREIGN KEY (parent_node_id) REFERENCES bom_nodes(id) ON DELETE CASCADE,
    INDEX idx_bom_instance_id (bom_instance_id),
    INDEX idx_node_address (node_address),
    INDEX idx_parent_node_id (parent_node_id),
    INDEX idx_level (level)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='BOM节点关系表';

-- 6. BOM变更历史表
CREATE TABLE bom_change_history (
    id INT PRIMARY KEY AUTO_INCREMENT,
    bom_instance_id INT NOT NULL,
    version_from VARCHAR(20) COMMENT '变更前版本',
    version_to VARCHAR(20) COMMENT '变更后版本',
    change_type ENUM('create', 'update', 'delete', 'version') COMMENT '变更类型',
    change_description TEXT COMMENT '变更描述',
    change_details JSON COMMENT '变更详情',
    changed_by VARCHAR(50) COMMENT '变更人',
    changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (bom_instance_id) REFERENCES bom_instances(id),
    INDEX idx_bom_instance_id (bom_instance_id),
    INDEX idx_changed_at (changed_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='BOM变更历史表';

-- 7. 物料替代表
CREATE TABLE material_substitutions (
    id INT PRIMARY KEY AUTO_INCREMENT,
    bom_node_id INT NOT NULL COMMENT 'BOM节点ID',
    substitute_product_id INT NOT NULL COMMENT '替代物料ID',
    substitute_rate DECIMAL(5,2) DEFAULT 100 COMMENT '替代率(%)',
    priority INT DEFAULT 1 COMMENT '优先级(数字越小优先级越高)',
    effective_date DATE COMMENT '生效日期',
    expiry_date DATE COMMENT '失效日期',
    reason TEXT COMMENT '替代原因',
    status ENUM('active', 'inactive') DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (bom_node_id) REFERENCES bom_nodes(id) ON DELETE CASCADE,
    FOREIGN KEY (substitute_product_id) REFERENCES products(id),
    UNIQUE KEY uk_bom_node_substitute (bom_node_id, substitute_product_id),
    INDEX idx_bom_node_id (bom_node_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='物料替代表';