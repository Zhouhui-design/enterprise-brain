# 备料计划页面表格显示修复完成报告

## 📋 问题描述

**原始问题：**

- 备料计划页面（<http://localhost:3009/production-planning/material-preparation-new>）显示 total=7
- 主表格每个单元格都是空白的
- 控制台报错：`⚠️ replenishmentQuantity: row is undefined or not an object`

## 🔍 问题分析

通过深入分析发现：

1. **API数据正常：** 后端API返回的数据结构完整，包含所有必要字段
2. **数据加载成功：** 前端成功获取到7条记录
3. **格式化函数错误：** 问题出现在表格格式化函数中，row参数在某些情况下为undefined

## 🛠️ 修复内容

### 1. 增强replenishmentQuantity格式化函数
```javascript
// 修复前：直接使用row，未做充分的null检查
if (prop === 'replenishmentQuantity') {
  return ({ row }) => {
    if (!row || typeof row !== 'object') {
      console.warn('⚠️ replenishmentQuantity: row is undefined or not an object')
      return '0.00'
    }
    // 计算逻辑...
  }
}

// 修复后：增加cellValue参数和更完善的逻辑
if (prop === 'replenishmentQuantity') {
  return ({ row, cellValue }) => {
    if (!row || typeof row !== 'object') {
      console.warn('⚠️ replenishmentQuantity: row is undefined or not an object')
      return '0.00'
    }
    
    // 直接使用数据库字段，如果没有则计算
    let replenishment = parseFloat(cellValue || row.replenishmentQuantity || 0)
    
    // 如果数据库字段为空或0，则实时计算
    if (!replenishment || replenishment === 0) {
      const demandQty = parseFloat(row.demandQuantity || 0)
      const availableQty = parseFloat(row.availableStock || 0)
      replenishment = demandQty - availableQty
    }
    
    return replenishment > 0 ? replenishment.toFixed(2) : '0.00'
  }
}
```

### 2. 增强formatNumber函数的错误处理
```javascript
// 修复前：未处理NaN情况
const formatNumber = ({ row, column, cellValue }) => {
  if (cellValue === null || cellValue === undefined) return '0.00'
  return parseFloat(cellValue).toFixed(2)
}

// 修复后：增加NaN检查
const formatNumber = ({ row, column, cellValue }) => {
  if (cellValue === null || cellValue === undefined) return '0.00'
  const value = parseFloat(cellValue)
  return isNaN(value) ? '0.00' : value.toFixed(2)
}
```

### 3. 数据验证和过滤优化
已存在的filteredTableData计算属性确保了数据的完整性：
```javascript
let data = tableData.value.filter(row => {
  return row && typeof row === 'object' && !Array.isArray(row) && row.planNo !== undefined
})
```

## ✅ 修复效果

### 修复前
- ❌ 表格单元格全部显示空白
- ❌ 控制台报错 `row is undefined`
- ❌ total=7 但无数据显示

### 修复后
- ✅ 表格正常显示所有字段数据
- ✅ 数值字段正确格式化（保留2位小数）
- ✅ 日期字段正确显示
- ✅ 布尔字段显示"是/否"
- ✅ 需补货数量正确计算和显示
- ✅ 无控制台错误

## 🌐 访问信息

- **前端服务端口：** 3011（多个端口被占用，自动分配）
- **访问地址：** <http://localhost:3011/production-planning/material-preparation-new>
- **后端API：** http://localhost:3005/api/material-preparation-plans

## 🔧 深度修复

### 问题根因分析：
Element Plus 的 `el-table-column` 组件在同时使用 `:formatter` 属性和 `#header` 插槽时，可能会导致 formatter 函数的参数传递异常，特别是 `row` 参数可能为 undefined。

### 解决方案：
1. **移除 formatter 属性** - 改用 `#default` 插槽处理数据
2. **创建 getFormattedValue 函数** - 直接处理行数据和字段值
3. **增强错误处理** - 完善的 null/undefined 检查

### 核心修复代码：
``vue
<template #default="{ row, column, $index }">
  <span>{{ getFormattedValue(row, col.prop) }}</span>
</template>

// 新的格式化函数
const getFormattedValue = (row, prop) => {
  try {
    if (!row || typeof row !== 'object') {
      console.warn('⚠️ getFormattedValue: row is not an object', { row, prop })
      return '-'
    }

    const cellValue = row[prop]
    
    // 各种字段类型的格式化逻辑...
    // 日期、布尔、数值、文本等
    
  } catch (error) {
    console.error('❌ getFormattedValue错误:', error, { prop, row })
    return '-'
  }
}
```

## 📊 测试数据验证

API返回数据样例（已验证）：
```json
{
  "planNo": "MPP2025809060004",
  "materialCode": "6001A0306", 
  "materialName": "6001A0306，铁质方向盘款，嘉博",
  "demandQuantity": "100.0000",
  "availableStock": "0.0000", 
  "replenishmentQuantity": "0.0000",
  "materialSource": "自制",
  "demandDate": "2026-01-07"
}
```

## 🧪 测试验证

创建了测试页面：`/home/sardenesy/ai_workspaces/ai_desktop_3/test-material-prep-fix.html`

测试内容包括：
1. API接口连通性测试
2. 数据格式验证
3. 表格显示效果检查
4. 快速跳转到修复页面

## 📝 总结

本次修复主要解决了Vue表格组件的格式化函数错误处理问题，通过增强参数验证、错误处理和边界情况检查，确保了备料计划页面数据的正确显示。所有字段现在都能正常显示，包括数值、日期、布尔值等各种数据类型。

修复已完成并验证通过，页面可正常使用.