# 任务计划

## 任务概述
修复生产BOM和物料管理系统中的关键问题，确保价格计算逻辑正确和用户界面友好。

## 详细任务

### 任务1：修复生产BOM材料单价严格使用基础单价
- **任务描述**：修改生产BOM页面，确保材料单价严格使用基础单价，无基础单价时默认为0或不填
- **涉及文件**：07-frontend/src/pages/bom/ProductionBom.vue
- **关键修改点**：
  - handleLoadMaterialPrice() 函数中移除降级到采购单价的逻辑
  - handleChildCodeChange() 函数中的数据流水线逻辑只使用基础单价
  - handleChildNameChange() 函数中的数据流水线逻辑只使用基础单价
  - 材料费用计算确保只使用基础单价
- **业务逻辑**：
  - 材料单价 = 基础单价（base_price）
  - 无基础单价 = 0 或不填
  - 材料与人工费用分离计算
- **预期结果**：材料单价字段严格使用基础单价，无基础单价时显示0或空白

### 任务2：修复物料来源字段显示问题
- **任务描述**：优化物料管理页面的物料来源字段显示，支持多来源的友好展示
- **涉及文件**：07-frontend/src/pages/material/MaterialList.vue
- **关键修改点**：
  - 表格列的物料来源字段渲染逻辑
  - 编辑表单中的物料来源组件
  - 支持数组格式转换为可读字符串
  - 保持数据存储格式的完整性
- **预期结果**：物料来源字段显示为可读字符串，支持多来源展示

### 任务3：优化基础单价自动生成逻辑
- **任务描述**：确保物料管理服务中的基础单价自动计算逻辑正确
- **涉及文件**：backend/services/materialService.js
- **关键修改点**：
  - createMaterial() 函数中的 base_price 计算逻辑
  - createMaterials() 函数中的批量处理逻辑
  - updateMaterial() 函数中的价格更新逻辑
  - 确保只要有采购单价就自动计算基础单价
- **计算公式**：基础单价 = 采购单价 / 采购转换率
- **预期结果**：基础单价自动生成逻辑正确，数据一致性保证

### 任务4：验证和测试
- **任务描述**：全面测试修复后的功能，确保问题解决且无新问题
- **验证范围**：
  - 生产BOM页面的材料单价显示和计算
  - 物料管理页面的来源字段显示
  - 基础单价的自动生成
  - 材料与人工费用分离计算
- **测试用例**：
  - 有基础单价的材料费用计算
  - 无基础单价时的处理（显示0或空白）
  - 多来源物料的显示效果
  - 批量操作的基础单价计算

## 执行顺序
1. **第一步**：修复生产BOM材料单价严格使用基础单价（高优先级）
2. **第二步**：优化基础单价自动生成逻辑（数据源头修复）
3. **第三步**：修复物料来源字段显示问题
4. **第四步**：全面验证和测试

## 核心业务规则
1. **基础单价优先级**：材料单价只能使用基础单价，不能使用采购单价
2. **自动生成规则**：只要有采购单价，系统必须自动计算基础单价
3. **费用分离**：材料费用和人工费用是独立的，分别计算
4. **空值处理**：无基础单价时，材料单价为0或不显示，不能降级

## 风险控制
- 修改前备份相关文件
- 逐个功能模块测试，确保每个修复有效
- 保持向后兼容性，避免影响现有功能
- 充分测试边界情况，如空值、异常数据等
