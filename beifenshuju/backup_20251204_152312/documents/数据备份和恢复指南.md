# 企业大脑系统 - 数据备份和恢复完整指南

## 📋 目录
1. [快速备份](#快速备份)
2. [详细备份步骤](#详细备份步骤)
3. [数据恢复指南](#数据恢复指南)
4. [常见问题](#常见问题)

---

## 🚀 快速备份

### 一键备份脚本

```bash
cd /home/sardenesy/ai_workspaces/ai_desktop_3
chmod +x backup-all-data.sh
./backup-all-data.sh
```

**重要**: 脚本会自动备份数据库和配置文件，但 **LocalStorage数据需要手动备份**！

---

## 📦 详细备份步骤

### 步骤1: 备份前端LocalStorage数据（必须！）

#### 方法一：使用浏览器控制台（推荐）

1. **打开系统**
   - 浏览器访问: http://localhost:3001
   - 确保已登录系统

2. **打开开发者工具**
   - 按 `F12` 键
   - 或右键点击页面 → 选择"检查"

3. **切换到Console（控制台）**
   - 点击顶部的"Console"标签

4. **执行备份脚本**
   - 复制以下代码，粘贴到控制台并回车：

```javascript
// ============================================
// 企业大脑系统 - LocalStorage数据导出脚本
// ============================================

(function() {
    console.log('🔄 开始导出LocalStorage数据...\n');
    
    const allData = {};
    const dataKeys = [
        'processListData',           // 工序列表
        'processNextId',             // 工序ID计数器
        'capacityLoadData',          // 工序能力负荷表
        'capacityLoadSettings',      // 工序能力负荷表设置
        'customerListData',          // 客户台账
        'salesOrderData',            // 销售订单
        'productListData',           // 产品手册
        'materialListData',          // 物料库
        'bomData',                   // BOM数据
        'bomTreeData',               // BOM树结构
        'employeeListData',          // 员工台账
        'token',                     // 登录令牌
        'userInfo'                   // 用户信息
    ];
    
    // 导出所有相关数据
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        allData[key] = localStorage.getItem(key);
    }
    
    // 统计信息
    const stats = {
        totalKeys: Object.keys(allData).length,
        dataSize: JSON.stringify(allData).length,
        exportTime: new Date().toISOString()
    };
    
    console.log('✅ 数据导出完成！');
    console.log('📊 统计信息:');
    console.log(`   - 总键数: ${stats.totalKeys}`);
    console.log(`   - 数据大小: ${(stats.dataSize / 1024).toFixed(2)} KB`);
    console.log(`   - 导出时间: ${stats.exportTime}`);
    console.log('\n📋 请复制下方的JSON数据并保存到文件:\n');
    console.log('='.repeat(50));
    
    const exportData = {
        metadata: stats,
        data: allData
    };
    
    console.log(JSON.stringify(exportData, null, 2));
    
    console.log('='.repeat(50));
    console.log('\n💾 保存步骤:');
    console.log('   1. 复制上方所有JSON数据');
    console.log('   2. 保存为: localStorage_backup.json');
    console.log('   3. 妥善保管该文件！\n');
    
    // 也可以下载为文件
    const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `localStorage_backup_${new Date().getTime()}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    console.log('✅ 备份文件已自动下载！');
})();
```

5. **保存备份数据**
   - 控制台会自动下载一个JSON文件
   - 同时也可以复制控制台中的JSON数据保存
   - 文件名类似: `localStorage_backup_1234567890.json`

#### 方法二：使用浏览器Application面板

1. 按 `F12` 打开开发者工具
2. 切换到 `Application` 标签
3. 左侧菜单找到 `Storage` → `Local Storage` → `http://localhost:3001`
4. 右键点击 → `Copy all`
5. 粘贴到文本编辑器保存

### 步骤2: 备份后端数据库

```bash
# 数据库文件位置
/home/sardenesy/ai_workspaces/ai_desktop_3/backend/enterprise_brain.db

# 手动复制
cp /home/sardenesy/ai_workspaces/ai_desktop_3/backend/enterprise_brain.db ~/备份目录/
```

### 步骤3: 备份配置文件

需要备份的配置文件：

```bash
# 前端配置
/home/sardenesy/ai_workspaces/ai_desktop_3/07-frontend/.env.development
/home/sardenesy/ai_workspaces/ai_desktop_3/07-frontend/.env.production

# 后端配置
/home/sardenesy/ai_workspaces/ai_desktop_3/backend/config/database.js
```

### 步骤4: 备份文档（可选）

```bash
# 所有的.md文档文件
/home/sardenesy/ai_workspaces/ai_desktop_3/*.md
```

---

## 🔄 数据恢复指南

### 恢复前端LocalStorage数据

#### 方法一：使用恢复脚本（推荐）

1. **打开新系统**
   - 访问: http://localhost:3001
   - 登录系统

2. **打开开发者工具**
   - 按 `F12`
   - 切换到 `Console`

3. **执行恢复脚本**

```javascript
// ============================================
// 企业大脑系统 - LocalStorage数据恢复脚本
// ============================================

(function() {
    console.log('🔄 准备恢复LocalStorage数据...\n');
    console.log('📋 请将备份的JSON数据粘贴到下方变量中：\n');
    
    // ⚠️ 将你的备份数据粘贴到这里
    const backupData = {
        "metadata": {
            // ... 你的备份数据的metadata部分
        },
        "data": {
            // ... 你的备份数据的data部分
        }
    };
    
    // 如果直接有data对象，可以这样用：
    // const backupData = { data: { /* 你的备份数据 */ } };
    
    if (!backupData.data || Object.keys(backupData.data).length === 0) {
        console.error('❌ 错误：未找到有效的备份数据！');
        console.log('💡 提示：请将备份的JSON数据粘贴到脚本中的backupData变量里');
        return;
    }
    
    console.log('📊 备份信息:');
    if (backupData.metadata) {
        console.log(`   - 导出时间: ${backupData.metadata.exportTime}`);
        console.log(`   - 数据键数: ${backupData.metadata.totalKeys}`);
    }
    
    // 清空现有数据（可选）
    const clearExisting = confirm('是否清空现有LocalStorage数据？\n点击"确定"清空，点击"取消"保留并合并');
    if (clearExisting) {
        localStorage.clear();
        console.log('🗑️  已清空现有数据');
    }
    
    // 恢复数据
    let restoredCount = 0;
    Object.keys(backupData.data).forEach(key => {
        try {
            localStorage.setItem(key, backupData.data[key]);
            restoredCount++;
        } catch (error) {
            console.error(`❌ 恢复 ${key} 失败:`, error);
        }
    });
    
    console.log(`\n✅ 数据恢复完成！已恢复 ${restoredCount} 个数据项`);
    console.log('🔄 即将刷新页面以应用更改...');
    
    setTimeout(() => {
        location.reload();
    }, 2000);
})();
```

4. **修改脚本中的备份数据**
   - 将你保存的JSON备份数据粘贴到 `backupData` 变量中
   - 执行脚本
   - 等待页面自动刷新

#### 方法二：逐项恢复

```javascript
// 恢复单个数据项
localStorage.setItem('processListData', '你的备份数据');
localStorage.setItem('customerListData', '你的备份数据');
// ... 依此类推
```

### 恢复后端数据库

```bash
# 停止后端服务（如果正在运行）
# 然后复制数据库文件

cp ~/备份目录/enterprise_brain.db /home/sardenesy/ai_workspaces/ai_desktop_3/backend/

# 重启后端服务
```

### 恢复配置文件

```bash
# 复制配置文件到对应位置
cp ~/备份目录/.env.development /home/sardenesy/ai_workspaces/ai_desktop_3/07-frontend/
cp ~/备份目录/.env.production /home/sardenesy/ai_workspaces/ai_desktop_3/07-frontend/
cp ~/备份目录/database.js /home/sardenesy/ai_workspaces/ai_desktop_3/backend/config/
```

---

## ✅ 恢复验证清单

完成恢复后，请逐项检查：

### 前端数据验证

- [ ] 工序列表有数据 (http://localhost:3001/manufacturing/process)
- [ ] 工序能力负荷表有数据 (http://localhost:3001/mrp/capacity-load)
- [ ] 客户台账有数据 (http://localhost:3001/sales/orders/customers)
- [ ] 销售订单有数据 (http://localhost:3001/sales/orders/list)
- [ ] 产品手册有数据 (http://localhost:3001/product/manual)
- [ ] 员工台账有数据 (http://localhost:3001/human-resources/employee-list)
- [ ] 可以正常登录
- [ ] 设置项正确（如工序能力负荷表的显示天数）

### 后端数据验证

- [ ] 数据库文件存在
- [ ] 后端服务正常启动
- [ ] API接口可正常访问

### 功能验证

- [ ] 可以新增数据
- [ ] 可以编辑数据
- [ ] 可以删除数据
- [ ] 数据持久化正常
- [ ] 页面跳转正常

---

## ❓ 常见问题

### Q1: LocalStorage备份脚本没有输出数据？

**解决方案:**
- 确保已登录系统
- 检查控制台是否有错误信息
- 尝试刷新页面后重新执行

### Q2: 恢复后数据显示不完整？

**解决方案:**
- 检查备份文件是否完整
- 确认所有关键数据项都已恢复
- 清空浏览器缓存后重试

### Q3: 恢复后无法登录？

**解决方案:**
- 检查是否恢复了 `token` 和 `userInfo`
- 如果没有，重新登录即可
- 用户名/密码保持不变

### Q4: 数据库恢复后报错？

**解决方案:**
- 检查数据库文件权限
- 确保后端服务已停止再复制文件
- 检查数据库文件完整性

### Q5: 备份文件太大无法打开？

**解决方案:**
- 使用文本编辑器如VSCode打开
- 或者使用命令行工具处理
- 可以压缩后再传输

---

## 📞 技术支持

如果遇到问题：

1. 检查备份文件完整性
2. 查看浏览器控制台错误信息
3. 检查系统日志
4. 联系技术支持

---

## 🎯 最佳实践

1. **定期备份**: 建议每周至少备份一次
2. **多重备份**: 同时保存到本地和云端
3. **测试恢复**: 定期测试恢复流程
4. **版本管理**: 保留多个版本的备份
5. **文档记录**: 记录每次备份的时间和内容

---

**备份创建时间**: $(date '+%Y-%m-%d %H:%M:%S')

**重要提醒**: 
- ⚠️ LocalStorage数据最重要，务必手动备份
- ⚠️ 备份文件请妥善保管，避免丢失
- ⚠️ 恢复前建议先测试，避免覆盖现有数据
