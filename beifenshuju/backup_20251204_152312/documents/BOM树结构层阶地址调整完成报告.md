# ✅ BOM树结构层阶地址调整完成报告

**完成时间：** 2025-12-03  
**状态：** 🎉 已完成  

---

## 📋 调整概述

将BOM树结构模板的节点地址格式调整为与生产BOM子件属性表格的层阶地址格式一致。

---

## 🎯 调整内容

### 调整前的地址格式

```
L0        (产品层)
L1-1      (第1层第1个节点)
L1-2      (第1层第2个节点)
L1-30     (第1层第30个节点)
L2-1      (第2层第1个节点)
L2-2      (第2层第2个节点)
L2-900    (第2层第900个节点)
L3-1      (第3层第1个节点)
...
```

### 调整后的地址格式

```
L0        (产品层，保持不变)
1         (第1层第1个节点)
2         (第1层第2个节点)
30        (第1层第30个节点)
1.1       (第2层第1个节点，属于1号父节点的第1个子节点)
1.2       (第2层第2个节点，属于1号父节点的第2个子节点)
1.30      (第2层第30个节点，属于1号父节点的第30个子节点)
2.1       (第2层第31个节点，属于2号父节点的第1个子节点)
30.30     (第2层第900个节点，属于30号父节点的第30个子节点)
1.1.1     (第3层第1个节点，路径：1→1.1→1.1.1)
1.1.2     (第3层第2个节点，路径：1→1.1→1.1.2)
1.2.1     (第3层第31个节点，路径：1→1.2→1.2.1)
...
```

---

## 🔧 技术实现

### 1. 新增计算函数

添加了 `calculateLevelPath(level, index)` 函数：

```javascript
// 计算层阶地址（与生产BOM一致）
const calculateLevelPath = (level, index) => {
  if (level === 1) {
    // 层阶1：直接返回序号 1, 2, 3, ...
    return String(index)
  } else {
    // 层阶2及以上：计算父节点地址 + . + 当前在父节点下的序号
    // 每个父节点有30个子节点
    // 计算父节点索引：parentIndex = Math.ceil(index / 30)
    const parentIndex = Math.ceil(index / 30)
    // 计算在父节点下的序号：childSeq = ((index - 1) % 30) + 1
    const childSeq = ((index - 1) % 30) + 1
    
    // 递归计算父节点地址
    const parentPath = calculateLevelPath(level - 1, parentIndex)
    
    return `${parentPath}.${childSeq}`
  }
}
```

### 2. 修改显示模板

将节点头部的地址显示修改为使用计算函数：

**修改前：**
```vue
<span class="cell-address">L{{ level }}-{{ index }}</span>
```

**修改后：**
```vue
<span class="cell-address">{{ calculateLevelPath(level, index) }}</span>
```

---

## 📊 地址计算规则说明

### 层阶1（L1）
- **规则**：直接使用序号
- **示例**：
  - L1-1 → `1`
  - L1-15 → `15`
  - L1-30 → `30`

### 层阶2（L2）
- **规则**：父节点地址.子序号
- **父节点计算**：`parentIndex = Math.ceil(index / 30)`
- **子序号计算**：`childSeq = ((index - 1) % 30) + 1`
- **示例**：
  - L2-1（父=1, 子序=1） → `1.1`
  - L2-30（父=1, 子序=30） → `1.30`
  - L2-31（父=2, 子序=1） → `2.1`
  - L2-60（父=2, 子序=30） → `2.30`
  - L2-900（父=30, 子序=30） → `30.30`

### 层阶3（L3）
- **规则**：递归计算父节点地址 + . + 子序号
- **示例**：
  - L3-1（父=L2-1=1.1, 子序=1） → `1.1.1`
  - L3-30（父=L2-1=1.1, 子序=30） → `1.1.30`
  - L3-31（父=L2-2=1.2, 子序=1） → `1.2.1`
  - L3-900（父=L2-30=1.30, 子序=30） → `1.30.30`
  - L3-901（父=L2-31=2.1, 子序=1） → `2.1.1`

### 层阶4及以上
- **规则**：继续递归计算
- **示例**：
  - L4-1 → `1.1.1.1`
  - L5-1 → `1.1.1.1.1`
  - L20-1 → `1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1`

---

## 🎨 父子关系对应表

### 示例：层阶2的前60个节点

| 原地址 | 新地址 | 父节点（L1） | 说明 |
|--------|--------|-------------|------|
| L2-1   | 1.1    | 1           | 第1个父节点的第1个子节点 |
| L2-2   | 1.2    | 1           | 第1个父节点的第2个子节点 |
| L2-30  | 1.30   | 1           | 第1个父节点的第30个子节点 |
| L2-31  | 2.1    | 2           | 第2个父节点的第1个子节点 |
| L2-32  | 2.2    | 2           | 第2个父节点的第2个子节点 |
| L2-60  | 2.30   | 2           | 第2个父节点的第30个子节点 |

### 示例：层阶3的前90个节点

| 原地址 | 新地址  | 父节点（L2） | 说明 |
|--------|---------|-------------|------|
| L3-1   | 1.1.1   | 1.1         | 路径：1 → 1.1 → 1.1.1 |
| L3-30  | 1.1.30  | 1.1         | 路径：1 → 1.1 → 1.1.30 |
| L3-31  | 1.2.1   | 1.2         | 路径：1 → 1.2 → 1.2.1 |
| L3-60  | 1.2.30  | 1.2         | 路径：1 → 1.2 → 1.2.30 |
| L3-61  | 1.3.1   | 1.3         | 路径：1 → 1.3 → 1.3.1 |
| L3-90  | 1.3.30  | 1.3         | 路径：1 → 1.3 → 1.3.30 |

---

## ✅ 对应关系验证

### 与生产BOM子件表格的对应

在生产BOM的子件属性表格中，层阶地址的计算规则为：
- 层阶1：从上到下顺序编号（1, 2, 3...）
- 层阶2+：父节点地址.序号

**BOM树结构现在完全对应**：

| 生产BOM层阶地址 | BOM树结构地址 | 说明 |
|----------------|--------------|------|
| 1              | 1            | ✅ 一致 |
| 2              | 2            | ✅ 一致 |
| 1.1            | 1.1          | ✅ 一致 |
| 1.2            | 1.2          | ✅ 一致 |
| 2.1            | 2.1          | ✅ 一致 |
| 1.1.1          | 1.1.1        | ✅ 一致 |
| 1.1.2          | 1.1.2        | ✅ 一致 |
| 10.10.5        | 10.10.5      | ✅ 一致 |

---

## 📝 修改文件

**文件：** `/07-frontend/src/pages/bom/BomTreeStructure.vue`

**修改内容：**
1. 新增 `calculateLevelPath()` 函数（20行代码）
2. 修改节点头部地址显示（1行修改）

**代码统计：**
- 新增行数：20行
- 修改行数：1行

---

## 🎯 使用示例

### 查看层阶1节点

```
节点1：地址显示为 "1"
节点15：地址显示为 "15"
节点30：地址显示为 "30"
```

### 查看层阶2节点

```
节点1（属于父节点1）：地址显示为 "1.1"
节点30（属于父节点1）：地址显示为 "1.30"
节点31（属于父节点2）：地址显示为 "2.1"
节点900（属于父节点30）：地址显示为 "30.30"
```

### 查看层阶3节点

```
节点1（路径：1→1.1）：地址显示为 "1.1.1"
节点31（路径：1→1.2）：地址显示为 "1.2.1"
节点901（路径：2→2.1）：地址显示为 "2.1.1"
```

---

## 🎨 显示效果

### 节点卡片头部

**修改前：**
```
┌─────────────────┐
│ L1-1    父/子   │
│                 │
│ 产品编号：xxx   │
│ 产品名称：xxx   │
└─────────────────┘
```

**修改后：**
```
┌─────────────────┐
│ 1       父/子   │  ⭐ 地址更简洁
│                 │
│ 产品编号：xxx   │
│ 产品名称：xxx   │
└─────────────────┘
```

---

## 🎉 总结

成功将BOM树结构的节点地址格式调整为与生产BOM一致！

**调整效果：**
- ✅ L1-1 → 1
- ✅ L2-1 → 1.1
- ✅ L3-1 → 1.1.1
- ✅ 地址格式完全对应生产BOM
- ✅ 父子关系清晰可见
- ✅ 支持无限层级递归

**刷新浏览器，打开BOM树结构页面即可看到新的地址格式！** 🚀
