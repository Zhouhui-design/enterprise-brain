<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç¦»çº¿é¡µé¢ - äº§å“é€‰æ‹©å™¨</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #333;
    }

    .offline-container {
      background: white;
      border-radius: 16px;
      padding: 40px;
      text-align: center;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
    }

    .offline-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 24px;
      background: #f5f5f5;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
    }

    .offline-title {
      font-size: 24px;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 16px;
    }

    .offline-description {
      font-size: 16px;
      color: #7f8c8d;
      line-height: 1.6;
      margin-bottom: 32px;
    }

    .offline-features {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 32px;
      text-align: left;
    }

    .feature-item {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      font-size: 14px;
      color: #555;
    }

    .feature-item:last-child {
      margin-bottom: 0;
    }

    .feature-icon {
      width: 20px;
      height: 20px;
      margin-right: 12px;
      background: #4CAF50;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
    }

    .offline-actions {
      display: flex;
      gap: 16px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: #4CAF50;
      color: white;
    }

    .btn-primary:hover {
      background: #45a049;
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
      transform: translateY(-2px);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .network-status {
      margin-top: 24px;
      padding: 16px;
      background: #e3f2fd;
      border-radius: 8px;
      border-left: 4px solid #2196F3;
      font-size: 14px;
      color: #1976D2;
    }

    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-online {
      background: #4CAF50;
      animation: pulse 2s infinite;
    }

    .status-offline {
      background: #f44336;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    .cached-data {
      margin-top: 32px;
      padding: 20px;
      background: #fff3cd;
      border-radius: 8px;
      border-left: 4px solid #ffc107;
    }

    .data-count {
      font-size: 14px;
      color: #856404;
      margin-bottom: 8px;
    }

    .data-list {
      text-align: left;
      max-height: 200px;
      overflow-y: auto;
    }

    .data-item {
      padding: 8px 12px;
      margin-bottom: 4px;
      background: white;
      border-radius: 4px;
      font-size: 13px;
      color: #666;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .retry-indicator {
      margin-top: 16px;
      font-size: 12px;
      color: #666;
    }

    @media (max-width: 768px) {
      .offline-container {
        padding: 24px;
        margin: 20px;
      }

      .offline-title {
        font-size: 20px;
      }

      .offline-actions {
        flex-direction: column;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="offline-container">
    <div class="offline-icon">
      ğŸ“¡
    </div>
    
    <h1 class="offline-title">æ‚¨å½“å‰å¤„äºç¦»çº¿çŠ¶æ€</h1>
    
    <p class="offline-description">
      ç½‘ç»œè¿æ¥ä¸å¯ç”¨ï¼Œä½†æ‚¨ä»ç„¶å¯ä»¥ä½¿ç”¨éƒ¨åˆ†åŠŸèƒ½ã€‚<br>
      æˆ‘ä»¬å·²ä¸ºæ‚¨ç¼“å­˜äº†é‡è¦çš„æ•°æ®ï¼Œå¹¶ä¼šåœ¨ç½‘ç»œæ¢å¤åè‡ªåŠ¨åŒæ­¥ã€‚
    </p>

    <div class="offline-features">
      <div class="feature-item">
        <div class="feature-icon">âœ“</div>
        <span>æµè§ˆå·²ç¼“å­˜çš„äº§å“æ•°æ®</span>
      </div>
      <div class="feature-item">
        <div class="feature-icon">âœ“</div>
        <span>ä½¿ç”¨äº§å“ç­›é€‰å’Œæœç´¢åŠŸèƒ½</span>
      </div>
      <div class="feature-item">
        <div class="feature-icon">âœ“</div>
        <span>æ¯”è¾ƒå’Œé€‰æ‹©äº§å“</span>
      </div>
      <div class="feature-item">
        <div class="feature-icon">âœ“</div>
        <span>æ“ä½œå°†åœ¨ç½‘ç»œæ¢å¤åè‡ªåŠ¨åŒæ­¥</span>
      </div>
    </div>

    <div class="offline-actions">
      <button class="btn btn-primary" onclick="tryReconnect()">
        <span>ğŸ”„</span>
        é‡æ–°è¿æ¥
      </button>
      
      <button class="btn btn-secondary" onclick="continueOffline()">
        <span>ğŸ“±</span>
        ç»§ç»­ç¦»çº¿ä½¿ç”¨
      </button>
    </div>

    <div class="network-status" id="networkStatus">
      <span class="status-indicator status-offline" id="statusIndicator"></span>
      <span id="statusText">æ­£åœ¨æ£€æŸ¥ç½‘ç»œè¿æ¥...</span>
    </div>

    <div class="cached-data" id="cachedData" style="display: none;">
      <div class="data-count" id="dataCount">æ­£åœ¨åŠ è½½ç¼“å­˜æ•°æ®...</div>
      <div class="data-list" id="dataList"></div>
    </div>

    <div class="retry-indicator" id="retryIndicator" style="display: none;">
      æ­£åœ¨å°è¯•é‡æ–°è¿æ¥... <span id="retryCount"></span>
    </div>
  </div>

  <script>
    // ç½‘ç»œçŠ¶æ€æ£€æµ‹
    let isOnline = navigator.onLine
    let retryCount = 0
    let maxRetries = 5
    
    // æ£€æŸ¥ç½‘ç»œè¿æ¥
    function checkNetworkStatus() {
      const statusIndicator = document.getElementById('statusIndicator')
      const statusText = document.getElementById('statusText')
      
      if (navigator.onLine) {
        statusIndicator.className = 'status-indicator status-online'
        statusText.textContent = 'ç½‘ç»œè¿æ¥æ­£å¸¸ï¼Œå³å°†è¿”å›ä¸»é¡µ...'
        
        // æ£€æµ‹åˆ°ç½‘ç»œè¿æ¥ï¼Œå»¶è¿Ÿè¿”å›ä¸»é¡µ
        setTimeout(() => {
          window.location.href = '/'
        }, 2000)
      } else {
        statusIndicator.className = 'status-indicator status-offline'
        statusText.textContent = 'ç½‘ç»œè¿æ¥ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®'
      }
    }

    // å°è¯•é‡æ–°è¿æ¥
    function tryReconnect() {
      const retryIndicator = document.getElementById('retryIndicator')
      const retryCountElement = document.getElementById('retryCount')
      
      if (retryCount >= maxRetries) {
        retryCount = 0
        showMessage('é‡è¯•æ¬¡æ•°è¿‡å¤šï¼Œè¯·ç¨åå†è¯•', 'error')
        return
      }
      
      retryCount++
      retryIndicator.style.display = 'block'
      retryCountElement.textContent = `ç¬¬ ${retryCount} æ¬¡å°è¯•`
      
      // æ¨¡æ‹Ÿç½‘ç»œæ£€æµ‹
      fetch('/', { 
        method: 'HEAD',
        cache: 'no-cache'
      })
      .then(() => {
        if (navigator.onLine) {
          showMessage('ç½‘ç»œè¿æ¥æ¢å¤ï¼', 'success')
          setTimeout(() => {
            window.location.href = '/'
          }, 1500)
        } else {
          setTimeout(tryReconnect, 2000)
        }
      })
      .catch(() => {
        setTimeout(tryReconnect, 2000)
      })
    }

    // ç»§ç»­ç¦»çº¿ä½¿ç”¨
    async function continueOffline() {
      // å°è¯•åŠ è½½ç¼“å­˜æ•°æ®
      try {
        // ä» indexedDB æˆ– localStorage è·å–ç¼“å­˜æ•°æ®
        const cachedData = await loadCachedData()
        displayCachedData(cachedData)
        
        // é‡å®šå‘åˆ°ç¦»çº¿æ¨¡å¼çš„åº”ç”¨
        window.location.href = '/?offline=true'
      } catch (error) {
        console.error('åŠ è½½ç¼“å­˜æ•°æ®å¤±è´¥:', error)
        showMessage('ç¼“å­˜æ•°æ®ä¸å¯ç”¨ï¼Œè¯·è¿æ¥ç½‘ç»œåé‡è¯•', 'error')
      }
    }

    // åŠ è½½ç¼“å­˜æ•°æ®
    async function loadCachedData() {
      // ç®€åŒ–çš„ç¼“å­˜æ•°æ®åŠ è½½é€»è¾‘
      const cachedData = {
        products: [],
        categories: [],
        userPreferences: {}
      }

      try {
        // å°è¯•ä» localStorage è·å–æ•°æ®
        const cachedProducts = localStorage.getItem('cached-products')
        const cachedCategories = localStorage.getItem('cached-categories')
        const cachedPreferences = localStorage.getItem('user-preferences')

        if (cachedProducts) {
          cachedData.products = JSON.parse(cachedProducts)
        }
        
        if (cachedCategories) {
          cachedData.categories = JSON.parse(cachedCategories)
        }
        
        if (cachedPreferences) {
          cachedData.userPreferences = JSON.parse(cachedPreferences)
        }
      } catch (error) {
        console.warn('Failed to load cached data from localStorage:', error)
      }

      return cachedData
    }

    // æ˜¾ç¤ºç¼“å­˜æ•°æ®ä¿¡æ¯
    function displayCachedData(data) {
      const cachedDataElement = document.getElementById('cachedData')
      const dataCountElement = document.getElementById('dataCount')
      const dataListElement = document.getElementById('dataList')
      
      cachedDataElement.style.display = 'block'
      
      const totalCount = data.products.length + data.categories.length
      dataCountElement.textContent = `å·²ç¼“å­˜æ•°æ®ï¼š${totalCount} é¡¹`
      
      let html = ''
      
      if (data.products.length > 0) {
        html += `<div class="data-item">
          <span>ğŸ“¦ äº§å“æ•°æ®</span>
          <span>${data.products.length} é¡¹</span>
        </div>`
      }
      
      if (data.categories.length > 0) {
        html += `<div class="data-item">
          <span>ğŸ·ï¸ åˆ†ç±»æ•°æ®</span>
          <span>${data.categories.length} é¡¹</span>
        </div>`
      }
      
      if (Object.keys(data.userPreferences).length > 0) {
        html += `<div class="data-item">
          <span>âš™ï¸ ç”¨æˆ·è®¾ç½®</span>
          <span>å·²ä¿å­˜</span>
        </div>`
      }
      
      dataListElement.innerHTML = html
    }

    // æ˜¾ç¤ºæ¶ˆæ¯
    function showMessage(message, type = 'info') {
      const statusElement = document.getElementById('networkStatus')
      
      const colors = {
        success: '#4CAF50',
        error: '#f44336',
        info: '#2196F3',
        warning: '#ff9800'
      }
      
      statusElement.style.background = colors[type] + '20'
      statusElement.style.borderLeftColor = colors[type]
      statusElement.innerHTML = `
        <span class="status-indicator" style="background: ${colors[type]}"></span>
        <span>${message}</span>
      `
    }

    // ç½‘ç»œçŠ¶æ€ç›‘å¬
    window.addEventListener('online', () => {
      isOnline = true
      checkNetworkStatus()
      retryCount = 0
      document.getElementById('retryIndicator').style.display = 'none'
    })

    window.addEventListener('offline', () => {
      isOnline = false
      checkNetworkStatus()
    })

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç½‘ç»œçŠ¶æ€
    document.addEventListener('DOMContentLoaded', () => {
      checkNetworkStatus()
      
      // å®šæœŸæ£€æŸ¥ç½‘ç»œçŠ¶æ€
      setInterval(checkNetworkStatus, 5000)
    })

    // é˜²æ­¢é¡µé¢ç¼“å­˜
    window.addEventListener('load', () => {
      // å¼ºåˆ¶é‡æ–°éªŒè¯ç¼“å­˜
      if ('caches' in window) {
        caches.keys().then(function(names) {
          names.forEach(function(name) {
            if (name.includes('product-selector-cache')) {
              caches.delete(name)
            }
          })
        })
      }
    })

    // PWA æç¤º
    let deferredPrompt
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault()
      deferredPrompt = e
      
      // æ˜¾ç¤ºå®‰è£…æç¤º
      setTimeout(() => {
        if (deferredPrompt && !localStorage.getItem('pwa-dismissed')) {
          const installBtn = document.createElement('button')
          installBtn.className = 'btn btn-primary'
          installBtn.innerHTML = 'ğŸ“± å®‰è£…åº”ç”¨'
          installBtn.onclick = () => {
            deferredPrompt.prompt()
            deferredPrompt.userChoice.then((choiceResult) => {
              if (choiceResult.outcome === 'accepted') {
                console.log('PWA installed')
              }
              deferredPrompt = null
            })
            localStorage.setItem('pwa-dismissed', 'true')
          }
          
          document.querySelector('.offline-actions').appendChild(installBtn)
        }
      }, 3000)
    })

    // å¤„ç†é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        const retryBtn = document.querySelector('.btn-primary')
        if (retryBtn && retryBtn.offsetHeight > 0) {
          retryBtn.click()
        }
      }
      
      if (e.key === 'Escape') {
        const offlineBtn = document.querySelector('.btn-secondary')
        if (offlineBtn && offlineBtn.offsetHeight > 0) {
          offlineBtn.click()
        }
      }
    })

    // è‡ªåŠ¨é‡è¿é€»è¾‘
    let autoReconnect = false
    const autoReconnectInterval = setInterval(() => {
      if (!isOnline && !autoReconnect) {
        autoReconnect = true
        tryReconnect()
        setTimeout(() => {
          autoReconnect = false
        }, 10000) // 10ç§’åé‡ç½®è‡ªåŠ¨é‡è¿æ ‡å¿—
      }
    }, 30000) // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
  </script>
</body>
</html>