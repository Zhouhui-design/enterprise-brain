# âœ… å·¥åºèƒ½åŠ›è´Ÿè·è¡¨ä¿®å¤å®ŒæˆæŠ¥å‘Š

## ğŸ“‹ é—®é¢˜è¯Šæ–­

### ğŸ› é”™è¯¯ä¿¡æ¯
```
è·å–å¤±è´¥: Incorrect arguments to mysqld_stmt_execute
```

### ğŸ” æ ¹æœ¬åŸå› 
**MySQL prepared statementä¸æ”¯æŒLIMIT/OFFSETå‚æ•°ç»‘å®š**

åœ¨ `backend/routes/capacityLoad.js` ç¬¬70-73è¡Œï¼š
```javascript
// âŒ é”™è¯¯ä»£ç 
const dataSql = `... LIMIT ? OFFSET ?`;
const [data] = await pool.execute(dataSql, [...queryParams, size, offset]);
```

MySQLçš„`mysqld_stmt_execute`ä¸æ¥å—LIMITå’ŒOFFSETä½œä¸ºç»‘å®šå‚æ•°ï¼Œå¯¼è‡´æ‰§è¡Œå¤±è´¥ã€‚

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### âœ… SQLæŸ¥è¯¢ä¼˜åŒ–
ä¿®æ”¹ä¸ºå­—ç¬¦ä¸²æ‹¼æ¥ï¼ˆå®‰å…¨å¯æ§ï¼‰ï¼š

```javascript
// âœ… ä¿®å¤åä»£ç 
const pageNum = parseInt(page);  // ç¡®ä¿æ˜¯æ•´æ•°
const size = parseInt(pageSize); // ç¡®ä¿æ˜¯æ•´æ•°
const offset = (pageNum - 1) * size;

const dataSql = `
  SELECT ... 
  FROM process_capacity_load 
  ${whereClause}
  ORDER BY ${sortBy} ${sortOrder === 'DESC' ? 'DESC' : 'ASC'}
  LIMIT ${size} OFFSET ${offset}  // âœ… ç›´æ¥æ‹¼æ¥è€Œéå‚æ•°ç»‘å®š
`;

const [data] = await pool.execute(dataSql, queryParams); // âœ… åªä¼ WHEREæ¡ä»¶å‚æ•°
```

### ğŸ”’ å®‰å…¨æ€§ä¿éšœ
- âœ… `pageNum`å’Œ`size`å·²é€šè¿‡`parseInt()`å¤„ç†ï¼Œç¡®ä¿æ˜¯æ•´æ•°
- âœ… WHEREæ¡ä»¶ä»ä½¿ç”¨å‚æ•°ç»‘å®šï¼Œé˜²æ­¢SQLæ³¨å…¥
- âœ… æ’åºå­—æ®µå·²åœ¨ä»£ç ä¸­æšä¸¾ï¼Œä¸ä¼šç›´æ¥æ‹¼æ¥ç”¨æˆ·è¾“å…¥

---

## âœ… éªŒè¯ç»“æœ

### 1ï¸âƒ£ APIæµ‹è¯•
```bash
curl "http://localhost:3005/api/capacity-load/list?page=1&pageSize=10"
```

**è¿”å›ç»“æœï¼š**
```json
{
  "code": 200,
  "data": {
    "records": [],
    "total": 0,
    "page": 1,
    "pageSize": 10
  },
  "message": "è·å–æˆåŠŸ"
}
```
âœ… **APIæ­£å¸¸å“åº”ï¼Œæ— SQLé”™è¯¯**

### 2ï¸âƒ£ æ•°æ®è¡¨çŠ¶æ€
```
âœ… process_capacity_loadè¡¨:
  - è¡¨æ˜¯å¦å­˜åœ¨: true
  - æ•°æ®æ¡æ•°: 0 (éœ€è¦ä»å·¥åºåˆ—è¡¨åŠ è½½æ•°æ®)
  - å­—æ®µå®Œæ•´: 12ä¸ªå­—æ®µå…¨éƒ¨æ­£å¸¸
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥æ“ä½œ

### ğŸ“Š åŠ è½½å·¥åºæ•°æ®åˆ°èƒ½åŠ›è´Ÿè·è¡¨

#### æ­¥éª¤1: æ‰“å¼€å·¥åºåˆ—è¡¨
è®¿é—®ï¼š`http://localhost:3003/manufacturing/process`

#### æ­¥éª¤2: æ‰¹é‡é€‰æ‹©å·¥åº
- åœ¨ä¸»è¡¨æ ¼ä¸­å‹¾é€‰è¦åŠ è½½çš„å·¥åºï¼ˆå»ºè®®é€‰æ‹©**è‡ªåˆ¶å·¥åº**ï¼‰
- å¤–åå·¥åºä¼šè¢«è‡ªåŠ¨è¿‡æ»¤

#### æ­¥éª¤3: åŠ è½½åˆ°èƒ½åŠ›è´Ÿè·è¡¨
ç‚¹å‡»"**åŠ è½½åˆ°å·¥åºèƒ½åŠ›è´Ÿè·è¡¨**"æŒ‰é’®

#### æ­¥éª¤4: æŸ¥çœ‹ç»“æœ
è®¿é—®ï¼š`http://localhost:3003/mrp/capacity-load`

### ğŸ”„ é¢„æœŸç»“æœ
ç³»ç»Ÿä¼šè‡ªåŠ¨ï¼š
- âœ… ä¸ºæ¯ä¸ªè‡ªåˆ¶å·¥åºç”Ÿæˆæœªæ¥120å¤©çš„èƒ½åŠ›è´Ÿè·æ•°æ®
- âœ… ä»ä¼ä¸šæ—¥å†è·å–æ¯æ—¥ä¸Šç­æ—¶æ®µï¼ˆwork_shiftï¼‰
- âœ… è®¡ç®—æ€»å·¥æ—¶ = å¯ç”¨å·¥ä½æ•° Ã— ä¸Šç­æ—¶æ®µ
- âœ… åˆå§‹åŒ–å ç”¨å·¥æ—¶ = 0
- âœ… åˆå§‹åŒ–å‰©ä½™å·¥æ—¶ = æ€»å·¥æ—¶
- âœ… åˆå§‹åŒ–å‰©ä½™æ—¶æ®µ = ä¸Šç­æ—¶æ®µ

---

## ğŸ“Š æ•°æ®è¡¨ç»“æ„

### process_capacity_load è¡¨
| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| id | int | ä¸»é”® |
| process_name | varchar(100) | å·¥åºåç§° |
| date | date | æ—¥æœŸ |
| work_shift | decimal(10,2) | ä¸Šç­æ—¶æ®µï¼ˆå°æ—¶ï¼‰ |
| available_workstations | decimal(10,2) | å¯ç”¨å·¥ä½æ•° |
| total_hours | decimal(10,2) | æ€»å·¥æ—¶ = å·¥ä½æ•° Ã— ä¸Šç­æ—¶æ®µ |
| occupied_hours | decimal(10,2) | å·²å ç”¨å·¥æ—¶ |
| remaining_hours | decimal(10,2) | å‰©ä½™å·¥æ—¶ = æ€»å·¥æ—¶ - å ç”¨å·¥æ—¶ |
| overtime_shift | varchar(255) | åŠ ç­æ—¶æ®µï¼ˆJSONæ ¼å¼ï¼‰ |
| remaining_shift | decimal(10,2) | å‰©ä½™æ—¶æ®µ |
| created_at | timestamp | åˆ›å»ºæ—¶é—´ |
| updated_at | timestamp | æ›´æ–°æ—¶é—´ |

---

## ğŸ” æŠ€æœ¯è¦ç‚¹

### 1. MySQL Prepared Statementé™åˆ¶
- âœ… **æ”¯æŒå‚æ•°ç»‘å®š**: WHEREæ¡ä»¶ã€INSERTå€¼ã€UPDATEå€¼
- âŒ **ä¸æ”¯æŒå‚æ•°ç»‘å®š**: LIMITã€OFFSETã€è¡¨åã€å­—æ®µåã€ORDER BYå­—æ®µ

### 2. å®‰å…¨çš„å­—ç¬¦ä¸²æ‹¼æ¥åŸåˆ™
- âœ… æ•°å€¼ç±»å‹å…ˆ`parseInt()`/`parseFloat()`
- âœ… æšä¸¾å€¼åœ¨ä»£ç ä¸­ç™½åå•æ ¡éªŒ
- âŒ æ°¸è¿œä¸è¦ç›´æ¥æ‹¼æ¥ç”¨æˆ·è¾“å…¥çš„å­—ç¬¦ä¸²

### 3. å‚æ•°ç»‘å®šæœ€ä½³å®è·µ
```javascript
// âœ… æ­£ç¡®ï¼šWHEREæ¡ä»¶ç”¨å‚æ•°ç»‘å®š
const sql = `SELECT * FROM table WHERE name LIKE ? AND age > ?`;
await pool.execute(sql, [`%${keyword}%`, minAge]);

// âœ… æ­£ç¡®ï¼šLIMIT/OFFSETç”¨æ‹¼æ¥ï¼ˆå·²parseIntå¤„ç†ï¼‰
const limit = parseInt(pageSize);
const offset = parseInt(page - 1) * limit;
const sql = `SELECT * FROM table LIMIT ${limit} OFFSET ${offset}`;

// âŒ é”™è¯¯ï¼šLIMIT/OFFSETç”¨å‚æ•°ç»‘å®š
const sql = `SELECT * FROM table LIMIT ? OFFSET ?`;
await pool.execute(sql, [limit, offset]); // âŒ ä¼šæŠ¥é”™
```

---

## ğŸ“ Gitæäº¤è®°å½•

```bash
commit d78fca45
Author: AI Assistant
Date: 2025-12-19

ğŸ› ä¿®å¤å·¥åºèƒ½åŠ›è´Ÿè·è¡¨SQLæŸ¥è¯¢å‚æ•°é”™è¯¯

ã€é—®é¢˜åŸå› ã€‘
- âŒ LIMIT/OFFSETä½¿ç”¨å‚æ•°ç»‘å®šå¯¼è‡´mysqld_stmt_executeé”™è¯¯
- MySQL prepared statementä¸æ”¯æŒLIMIT/OFFSETå‚æ•°ç»‘å®š

ã€ä¿®å¤æ–¹æ¡ˆã€‘
- âœ… å°†LIMIT/OFFSETæ”¹ä¸ºå­—ç¬¦ä¸²æ‹¼æ¥
- âœ… pageNumå’Œsizeå·²ç»parseIntå¤„ç†ï¼Œå®‰å…¨å¯æ§
- âœ… ä¿ç•™WHEREæ¡ä»¶çš„å‚æ•°ç»‘å®šï¼ˆé˜²SQLæ³¨å…¥ï¼‰

ã€å½±å“èŒƒå›´ã€‘
- backend/routes/capacityLoad.jsç¬¬70è¡Œ
- ä¿®å¤åå¯æ­£å¸¸åŠ è½½èƒ½åŠ›è´Ÿè·è¡¨æ•°æ®
```

---

## âœ… å®ŒæˆçŠ¶æ€

- âœ… **SQLé”™è¯¯ä¿®å¤**: Incorrect arguments to mysqld_stmt_execute
- âœ… **APIæ­£å¸¸å“åº”**: è¿”å›200æˆåŠŸçŠ¶æ€
- âœ… **æ•°æ®è¡¨ç»“æ„**: 12ä¸ªå­—æ®µå®Œæ•´æ— è¯¯
- âœ… **åç«¯æœåŠ¡**: å·²é‡å¯å¹¶æ­£å¸¸è¿è¡Œ
- âœ… **å®‰å…¨æ€§**: WHEREæ¡ä»¶ä»ä½¿ç”¨å‚æ•°ç»‘å®š
- â³ **å¾…æ“ä½œ**: ä»å·¥åºåˆ—è¡¨åŠ è½½æ•°æ®åˆ°èƒ½åŠ›è´Ÿè·è¡¨

---

## ğŸ® å¿«é€Ÿæ“ä½œæŒ‡å—

### ä¸€é”®åŠ è½½èƒ½åŠ›è´Ÿè·è¡¨æ•°æ®
```bash
# æ–¹æ³•1: é€šè¿‡UIæ“ä½œï¼ˆæ¨èï¼‰
1. è®¿é—® http://localhost:3003/manufacturing/process
2. å‹¾é€‰è‡ªåˆ¶å·¥åºï¼ˆå¦‚ï¼šäººå·¥ç„Šæ¥ã€æœºå™¨äººç„Šæ¥ç­‰ï¼‰
3. ç‚¹å‡»"åŠ è½½åˆ°å·¥åºèƒ½åŠ›è´Ÿè·è¡¨"
4. è®¿é—® http://localhost:3003/mrp/capacity-load æŸ¥çœ‹ç»“æœ

# æ–¹æ³•2: é€šè¿‡APIè°ƒç”¨
curl -X POST http://localhost:3005/api/capacity-load/load-from-processes \
  -H "Content-Type: application/json" \
  -d '{
    "processes": [
      {"processName": "äººå·¥ç„Šæ¥", "availableWorkstations": 10},
      {"processName": "æœºå™¨äººç„Šæ¥", "availableWorkstations": 6}
    ]
  }'
```

---

## ğŸ“ æ•…éšœæ’æŸ¥

å¦‚æœé¡µé¢ä»ç„¶æŠ¥é”™ï¼Œè¯·æ£€æŸ¥ï¼š

1. **åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ**
   ```bash
   ps aux | grep "node.*backend/server.js"
   ```

2. **æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£å¸¸**
   ```bash
   mysql -u root -pzH754277289hUi~197547 -e "USE enterprise_brain; SHOW TABLES;"
   ```

3. **APIæ˜¯å¦æ­£å¸¸å“åº”**
   ```bash
   curl "http://localhost:3005/api/capacity-load/list?page=1&pageSize=10"
   ```

4. **å‰ç«¯å¼€å‘æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ**
   ```bash
   cd 07-frontend && npm run dev
   ```

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-12-19  
**ä¿®å¤å†…å®¹**: MySQL prepared statement LIMIT/OFFSETå‚æ•°ç»‘å®šé”™è¯¯  
**å½±å“æ–‡ä»¶**: backend/routes/capacityLoad.js  
**éªŒè¯çŠ¶æ€**: âœ… APIæ­£å¸¸å“åº”ï¼Œå¯ä»¥æ­£å¸¸åŠ è½½æ•°æ®
