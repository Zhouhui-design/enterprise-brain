# ✅ 工序能力负荷表修复完成报告

## 📋 问题描述

**前端页面**: http://localhost:3003/mrp/capacity-load

**错误信息**:
```
获取失败: Unknown column 'overtime_shift' in 'field list'
```

**错误原因**: 数据库表 `process_capacity_load` 缺少 `overtime_shift` 字段

---

## 🔧 修复内容

### 1. 添加缺失的字段

已成功添加 `overtime_shift` 字段到 `process_capacity_load` 表：

```sql
ALTER TABLE process_capacity_load 
ADD COLUMN overtime_shift VARCHAR(255) DEFAULT NULL COMMENT '加班时段' 
AFTER remaining_hours
```

**字段信息**:
- 字段名: `overtime_shift`
- 类型: `VARCHAR(255)`
- 允许NULL: `YES`
- 默认值: `NULL`
- 注释: 加班时段

---

## 📊 当前表结构

`process_capacity_load` 表现在包含以下字段（共12个）：

| 序号 | 字段名 | 类型 | 允许NULL | 说明 |
|------|--------|------|----------|------|
| 1 | id | int | NOT NULL | 主键 |
| 2 | process_name | varchar(100) | NOT NULL | 工序名称 |
| 3 | date | date | NOT NULL | 日期 |
| 4 | work_shift | decimal(10,2) | NULL | 上班时段 |
| 5 | available_workstations | decimal(10,2) | NULL | 可用工位数量 |
| 6 | total_hours | decimal(10,2) | NULL | 总工时 |
| 7 | occupied_hours | decimal(10,2) | NULL | 已占用工时 |
| 8 | remaining_hours | decimal(10,2) | NULL | 剩余工时 |
| 9 | **overtime_shift** | **varchar(255)** | **NULL** | **加班时段** ⬅️ **新增** |
| 10 | remaining_shift | decimal(10,2) | NULL | 剩余时段 |
| 11 | created_at | timestamp | NULL | 创建时间 |
| 12 | updated_at | timestamp | NULL | 更新时间 |

---

## 📊 数据状态

**当前数据量**: **0 条**

⚠️ **表中没有数据，需要手动生成数据**

---

## 🎯 下一步操作

### 步骤1: 生成工序能力负荷数据

1. 打开工序能力负荷表页面：
   ```
   http://localhost:3003/mrp/capacity-load
   ```

2. 点击**"加载工序"**或**"从工序加载"**按钮

3. 选择要加载的工序（例如：打包、组装、喷塑等）

4. 系统会自动生成未来N天（默认120天）的工序能力负荷数据

### 步骤2: 验证数据

刷新页面后，应该能看到生成的数据：
- 工序名称
- 日期
- 可用工位数量
- 上班时段
- 已占用工时
- 剩余工时
- 加班时段

---

## 🔍 数据生成逻辑

当点击"从工序加载"时，系统会：

1. **查询工序列表**：从工序管理中获取所有工序及其可用工位数量

2. **生成日期范围**：从当前日期开始，生成未来N天的记录

3. **关联企业日历**：
   - 查询企业日历的标准上班时长
   - 将标准上班时长填充到 `work_shift` 字段
   - 休息日的上班时段为 NULL

4. **计算工时**：
   - 总工时 = 上班时段 × 可用工位数量
   - 剩余工时 = 总工时 - 已占用工时（初始为0）
   - 剩余时段 = 剩余工时 ÷ 可用工位数量

5. **保存数据**：插入到 `process_capacity_load` 表

---

## 📝 相关API接口

| 接口 | 说明 |
|------|------|
| `GET /api/capacity-load/list` | 获取工序能力负荷表列表 |
| `POST /api/capacity-load/load-from-processes` | 从工序加载数据 |
| `POST /api/capacity-load/update-occupied-hours` | 更新已占用工时 |
| `POST /api/capacity-load/release-occupied-hours` | 释放已占用工时 |
| `POST /api/capacity-load/reset-work-shift` | 重置上班时段 |
| `POST /api/capacity-load/reset-remaining-hours` | 重置剩余工时 |

---

## ✅ 验证结果

### 1. 字段修复验证
```bash
# 运行验证脚本
node check-capacity-load-table.js

# 期望输出
✅ process_capacity_load 表已存在
🔍 overtime_shift 字段: ✅ 存在
```

### 2. 前端页面验证
```
打开: http://localhost:3003/mrp/capacity-load

期望结果:
- ✅ 页面正常加载，无报错
- ✅ 显示"从工序加载"按钮
- ✅ 点击加载后能生成数据
```

---

## 🎉 修复状态

| 项目 | 状态 | 说明 |
|------|------|------|
| 数据库表 | ✅ 已存在 | `process_capacity_load` |
| overtime_shift字段 | ✅ 已添加 | VARCHAR(255) NULL |
| 表结构 | ✅ 完整 | 12个字段 |
| 数据初始化 | ⏳ 待操作 | 需要在前端手动加载工序 |
| API接口 | ✅ 正常 | 所有接口可用 |

---

## 🔧 修复脚本

已创建以下脚本供后续使用：

1. **check-capacity-load-table.js** - 检查表结构和数据
2. **init-capacity-load-table.js** - 初始化表结构
3. **add-overtime-shift-field.js** - 添加 overtime_shift 字段（已执行）

---

## 📞 如需进一步帮助

如果前端页面仍有问题，请提供：
1. 浏览器Console完整日志
2. Network请求详情
3. 后端服务日志

---

**修复完成时间**: 2025-12-19  
**修复状态**: ✅ 字段已添加，表结构完整  
**下一步**: 在前端页面加载工序数据
