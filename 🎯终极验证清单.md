# 🎯 备料计划功能终极验证清单

## ✅ 已完成的工作

### 1. 后端数据验证 ✅
- ✅ 数据库有 **64条** 备料计划数据
- ✅ Service层返回正确格式 `{ list: [], total: 64 }`
- ✅ 主生产计划执行排程成功生成备料计划

### 2. 推送规则调整 ✅
- ✅ **解禁**: 备料计划 → 采购计划推送
- ✅ **永久禁止**: 备料计划 → 真工序计划推送（防止工时冲突）

### 3. 前端代码优化 ✅
- ✅ 修复主生产计划"执行排程"响应处理
- ✅ 优化备料计划页面数据加载日志
- ✅ 添加详细的错误提示

---

## 🔍 现在需要您做的验证

### 步骤1: 快速诊断（自动化）

在终端运行：
```bash
cd /home/sardensy/enterprise-brain/enterpise-brain
./diagnose-frontend-issue.sh
```

**期望输出**:
```
✅ 后端服务运行正常
✅ API响应正常
📊 返回数据总数: 64 条
✅ 前端服务运行正常
```

如果有 ❌ 错误，按提示操作。

---

### 步骤2: 浏览器验证（手动）

#### 2.1 打开备料计划页面

1. 在浏览器访问：`http://localhost:5173`
2. 导航到：**计划管控 → 生产计划 → 备料计划**

#### 2.2 打开开发者工具

按 **F12** 或右键点击"检查"

#### 2.3 查看Console日志

切换到 **Console** 标签，应该看到：

**✅ 正常情况**:
```
📤 备料计划请求参数: {page: 1, pageSize: 20, planNo: "", ...}
📥 备料计划响应数据: {list: Array(20), total: 64}
   - list数量: 20
   - total: 64
✅ 数据加载成功，共 64 条记录
```

**❌ 异常情况** (如果看到):
```
❌ 加载数据失败: ...
```
→ 截图发给我，我会帮您分析

#### 2.4 查看Network请求

切换到 **Network** 标签：

1. 刷新页面（Ctrl+R）
2. 找到 `/api/material-preparation-plans` 请求
3. 点击查看详情：
   - **Status**: 应该是 `200 OK`
   - **Response**: 应该包含 `{ code: 200, data: { list: [...], total: 64 } }`

**如果Status不是200**:
- 400: 请求参数错误
- 404: API路径不存在
- 500: 服务器内部错误
- CORS错误: 跨域问题

→ 截图发给我

#### 2.5 查看页面显示

**✅ 正常情况**:
- 表格显示 20 条备料计划数据
- 分页显示"共 64 条记录"
- 每条记录包含：计划编号、来源主计划、物料编号、物料名称等

**❌ 异常情况**:
- 表格为空
- 显示"暂无数据"
- 页面加载中一直转圈

→ 截图发给我，并提供Console日志

---

### 步骤3: 测试推送规则

#### 3.1 执行主生产计划排程

1. 导航到：**计划管控 → 生产计划 → 主生产计划**
2. 选择一条主生产计划
3. 点击"执行排程"
4. 确认执行

#### 3.2 查看后端日志

在终端运行：
```bash
tail -f /home/sardensy/enterprise-brain/enterpise-brain/backend/logs/app.log
```

**期望看到**:
```
🛒 备料计划创建成功，来源工序=采购，开始自动推送到采购计划...
✅ 推送采购计划成功: MPP... → 采购计划 (...)
⏭️ 推送到真工序计划已永久禁用（防止工时冲突）
```

#### 3.3 验证采购计划

1. 导航到：**采购管理 → 采购计划**
2. 查看是否有新增的采购计划
3. 验证采购计划数据是否正确

---

## 🆘 常见问题解决

### 问题1: 前端页面空白或一直加载

**解决方案**:
```bash
# 清除浏览器缓存
Ctrl + Shift + Delete

# 硬刷新页面
Ctrl + Shift + R

# 或在Console执行
localStorage.clear()
location.reload()
```

### 问题2: CORS跨域错误

**症状**:
```
Access to fetch at 'http://localhost:3000/api/...' has been blocked by CORS policy
```

**解决方案**:
检查后端是否运行，并重启后端服务：
```bash
cd /home/sardensy/enterprise-brain/enterpise-brain/backend
pkill -f "node server.js"
node server.js
```

### 问题3: 数据格式错误

**症状**:
Console显示收到数据，但表格为空

**解决方案**:
在Console执行：
```javascript
// 查看实际收到的数据
console.log('收到的数据:', tableData.value)
console.log('数据类型:', typeof tableData.value)
console.log('是否数组:', Array.isArray(tableData.value))
```

截图发给我。

### 问题4: API返回404

**症状**:
Network显示 `404 Not Found`

**解决方案**:
检查API路径配置：
```bash
# 查看前端配置
cat 07-frontend/.env.development

# 应该包含
VITE_API_BASE_URL=http://localhost:3000/api
```

---

## 📸 需要提供的信息

如果前端还是看不到数据，请提供以下截图：

1. **浏览器Console日志**
   - 展开所有日志
   - 包含 📤 和 📥 的完整输出
   - 任何红色错误信息

2. **Network请求详情**
   - `/api/material-preparation-plans` 请求
   - Status状态码
   - Response响应内容（完整JSON）

3. **页面显示截图**
   - 整个备料计划页面
   - 表格区域
   - 分页信息

4. **后端日志**（如果有）
   ```bash
   tail -n 50 backend/logs/app.log
   ```

---

## ✅ 验证成功标准

- [ ] 快速诊断脚本全部 ✅
- [ ] 备料计划页面正常加载
- [ ] Console显示正确的日志
- [ ] Network请求状态200
- [ ] 表格显示64条数据（每页20条）
- [ ] 分页显示正确
- [ ] 执行排程后自动推送到采购计划
- [ ] 不推送到真工序计划

---

## 🎯 预期效果

**最终效果**:

1. **备料计划页面**:
   - ✅ 显示64条备料计划数据
   - ✅ 分页正常工作（每页20条，共4页）
   - ✅ 所有字段正确显示

2. **数据流**:
   - ✅ 主生产计划 → 执行排程 → 生成备料计划
   - ✅ 备料计划（来源工序=采购）→ 自动推送 → 采购计划
   - ❌ 备料计划 → **不推送** → 真工序计划（已禁用）

3. **日志输出**:
   - ✅ 前端Console有详细日志
   - ✅ 后端日志显示推送过程
   - ✅ 无错误提示

---

**准备好了吗？开始验证吧！** 🚀

如有任何问题，随时提供截图给我！
