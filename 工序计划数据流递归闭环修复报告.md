# 工序计划数据流递归闭环修复报告

**修复时间**: 2025-12-15 10:35  
**修复原因**: 工序计划命名变更 + 数据流路由错误修复  
**涉及文件**: 3个Service文件

---

## 🎯 核心问题

### 问题1：工序计划命名变更未完全执行

**旧命名体系**：
- 真工序计划（realProcessPlanService.js，表：real_process_plans）
- 打包工序计划（packingProcessPlanService.js，表：packing_process_plans）
- 组装工序计划（assemblyProcessPlanService.js，表：assembly_process_plans）

**新命名体系**（根据规则文档`docs/备料计划到组装工序计划数据流规则说明.md`第72-77行）：
| 来源工序 | 推送目标 | 数据库表 | Service文件 |
|---------|---------|---------|------------|
| `打包` | 打包工序计划 | `real_process_plans` | realProcessPlanService.js |
| `组装` | 组装工序计划 | `assembly_process_plans` | assemblyProcessPlanService.js |
| `喷塑` | 喷塑工序计划 | `packing_process_plans` | packingProcessPlanService.js |

**残留问题**：
- ✅ 代码中仍有"真工序计划"的日志输出（realProcessPlanService.js）
- ✅ 备料计划推送逻辑中表映射错误（打包→packing_process_plans ❌）

### 问题2：数据流路由错误

**错误的路由规则**（修复前）：
```javascript
if (processName === '打包') {
  checkTable = 'packing_process_plans';  // ❌ 错误！打包应该推送到real_process_plans
  ProcessPlanService = require('./packingProcessPlanService');
} else if (processName === '组装') {
  checkTable = 'assembly_process_plans';  // ✅ 正确
  ProcessPlanService = require('./assemblyProcessPlanService');
}
```

**正确的路由规则**（修复后）：
```javascript
if (processName === '打包') {
  checkTable = 'real_process_plans';  // ✅ 打包工序计划表
  ProcessPlanService = require('./realProcessPlanService');
} else if (processName === '组装') {
  checkTable = 'assembly_process_plans';  // ✅ 组装工序计划表
  ProcessPlanService = require('./assemblyProcessPlanService');
} else if (processName === '喷塑') {
  checkTable = 'packing_process_plans';  // ✅ 喷塑工序计划表（原打包表改名）
  ProcessPlanService = require('./packingProcessPlanService');
}
```

---

## 🔧 修复内容

### 文件1：`backend/services/materialPreparationPlanService.js`

#### 修改1：支持喷塑工序（第927-945行）

**修改前**：
```javascript
// ✅ 检查来源工序是否支持（仅支持打包和组装）
if (processName !== '打包' && processName !== '组装') {
  console.log(`⏭️ 来源工序=${processName}，不在推送范围内（仅支持打包/组装），跳过推送`);
  return { success: false, reason: 'unsupported_source_process', processName };
}

// ✅ 防重复推送检查（使用来源工序确定检查表）
let checkTable;
if (processName === '打包') {
  checkTable = 'packing_process_plans';  // ❌ 错误
} else if (processName === '组装') {
  checkTable = 'assembly_process_plans';
}
```

**修改后**：
```javascript
// ✅ 检查来源工序是否支持（支持打包、组装、喷塑）
if (processName !== '打包' && processName !== '组装' && processName !== '喷塑') {
  console.log(`⏭️ 来源工序=${processName}，不在推送范围内（仅支持打包/组装/喷塑），跳过推送`);
  return { success: false, reason: 'unsupported_source_process', processName };
}

// ✅ 防重复推送检查（使用来源工序确定检查表）
let checkTable;
if (processName === '打包') {
  checkTable = 'real_process_plans';  // ✅ 打包工序计划表
} else if (processName === '组装') {
  checkTable = 'assembly_process_plans';  // ✅ 组装工序计划表
} else if (processName === '喷塑') {
  checkTable = 'packing_process_plans';  // ✅ 喷塑工序计划表（原打包表改名）
}
```

#### 修改2：目标表路由（第1073-1086行）

**修改前**：
```javascript
let targetTable;
if (processName === '打包') {
  targetTable = 'packing_process_plans';  // ❌ 错误
} else if (processName === '组装') {
  targetTable = 'assembly_process_plans';
} else {
  console.warn(`⚠️ [查询已排程工时] 不支持的工序类型: ${processName}，已跳过推送`);
  return { success: false, reason: 'unsupported_process', processName };
}
```

**修改后**：
```javascript
let targetTable;
if (processName === '打包') {
  targetTable = 'real_process_plans';  // ✅ 打包工序计划表
} else if (processName === '组装') {
  targetTable = 'assembly_process_plans';  // ✅ 组装工序计划表
} else if (processName === '喷塑') {
  targetTable = 'packing_process_plans';  // ✅ 喷塑工序计划表（原打包表改名）
} else {
  console.warn(`⚠️ [查询已排程工时] 不支持的工序类型: ${processName}，已跳过推送`);
  return { success: false, reason: 'unsupported_process', processName };
}
```

#### 修改3：Service路由逻辑（第1163-1186行）

**修改前**：
```javascript
if (processName === '打包') {  // ✅ 使用processName
  ProcessPlanService = require('./packingProcessPlanService');  // ❌ 错误
  planNoPrefix = 'PKPP';
  serviceName = '打包工序计划';
} else if (processName === '组装') {  // ✅ 使用processName
  ProcessPlanService = require('./assemblyProcessPlanService');
  planNoPrefix = 'ASPP';
  serviceName = '组装工序计划';
} else {
  // ⚠️ 禁止推送到真工序计划，仅支持打包和组装（已在前面检查过，这里不应该执行到）
  console.warn(`⚠️ [数据路由] 不支持的工序类型: ${processName}，已跳过推送`);
  return { success: false, reason: 'unsupported_process', processName };
}
```

**修改后**：
```javascript
if (processName === '打包') {  // ✅ 打包 → real_process_plans（打包工序计划）
  ProcessPlanService = require('./realProcessPlanService');  // ✅ 修复
  planNoPrefix = 'RPP';  // Real Process Plan
  serviceName = '打包工序计划';
} else if (processName === '组装') {  // ✅ 组装 → assembly_process_plans（组装工序计划）
  ProcessPlanService = require('./assemblyProcessPlanService');
  planNoPrefix = 'ASPP';  // Assembly Process Plan
  serviceName = '组装工序计划';
} else if (processName === '喷塑') {  // ✅ 喷塑 → packing_process_plans（喷塑工序计划）
  ProcessPlanService = require('./packingProcessPlanService');  // ✅ 新增
  planNoPrefix = 'SPPP';  // Spray Painting Process Plan
  serviceName = '喷塑工序计划';
} else {
  // ⚠️ 不支持的工序类型（已在前面检查过，这里不应该执行到）
  console.warn(`⚠️ [数据路由] 不支持的工序类型: ${processName}，已跳过推送`);
  return { success: false, reason: 'unsupported_process', processName };
}
```

**代码统计**：
- 新增行数：23行
- 删除行数：15行

---

### 文件2：`backend/services/realProcessPlanService.js`

#### 修改内容：将"真工序计划"改名为"打包工序计划"

**日志输出修改（第266-350行）**：
```javascript
// 修改前：
console.log(`\n🔍 [自动推送检查] 真工序计划 -> 备料计划`);
console.log(`   真工序计划ID: ${result.insertId}`);
console.log(`   真工序计划编号: ${data.planNo}`);

// 修改后：
console.log(`\n🔍 [自动推送检查] 打包工序计划 -> 备料计划`);
console.log(`   打包工序计划ID: ${result.insertId}`);
console.log(`   打包工序计划编号: ${data.planNo}`);
```

**注释修改（第266-267行、283行、305行、321行、337行、339行、427行、461行）**：
- "真工序计划" → "打包工序计划"
- 共11处修改

**代码统计**：
- 新增行数：11行
- 删除行数：11行

---

### 文件3：`backend/services/packingProcessPlanService.js`

#### 修改内容：将"打包工序计划"改名为"喷塑工序计划"

**日志输出修改（第266-350行）**：
```javascript
// 修改前：
console.log(`\n🔍 [自动推送检查] 打包工序计划 -> 备料计划`);
console.log(`   打包工序计划ID: ${result.insertId}`);
console.log(`   打包工序计划编号: ${data.planNo}`);

// 修改后：
console.log(`\n🔍 [自动推送检查] 喷塑工序计划 -> 备料计划`);
console.log(`   喷塑工序计划ID: ${result.insertId}`);
console.log(`   喷塑工序计划编号: ${data.planNo}`);
```

**注释修改（第266-267行、283行、305行、321行、337行、339行、427行、461行）**：
- "打包工序计划" → "喷塑工序计划"
- 共11处修改

**代码统计**：
- 新增行数：11行
- 删除行数：11行

---

## 📊 完整数据流示例

### 示例：产品6001A0306的递归数据流

```
主生产计划 (产品6001A0306)
    ↓ 执行排程
备料计划 bl01 (物料6001A0306, 来源工序=打包, 需补货数量=10)
    ↓ IFS判断：来源工序=打包 → 推送到real_process_plans
打包工序计划 RPP001 (生产6001A0306, 来源编号=bl01, 计划排程数量>0)
    ↓ 推送BOM子件到备料计划
备料计划 bl02 (物料470001A, 来源工序=组装, 需补货数量=5)
备料计划 bl03 (物料470002A, 来源工序=组装, 需补货数量=3)
备料计划 bl04 (物料511442B, 来源工序=采购, 需补货数量=20)  ❌ 不推送
    ↓ IFS判断：来源工序=组装 → 推送到assembly_process_plans
组装工序计划 ASPP001 (生产470001A, 来源编号=bl02)
组装工序计划 ASPP002 (生产470002A, 来源编号=bl03)
    ↓ 推送BOM子件到备料计划
备料计划 bl05 (物料XXX, 来源工序=喷塑, 需补货数量=Y)
    ↓ IFS判断：来源工序=喷塑 → 推送到packing_process_plans
喷塑工序计划 SPPP001 (生产XXX, 来源编号=bl05)
    ↓ 继续循环...
直到满足终止条件（需补货数量≤0 或 物料来源=采购 或 BOM子件为空）
```

---

## ✅ 验证要点

### 1. 表映射验证

| 来源工序 | 目标表 | Service | 计划编号前缀 |
|---------|-------|---------|-------------|
| 打包 | `real_process_plans` | realProcessPlanService.js | RPP |
| 组装 | `assembly_process_plans` | assemblyProcessPlanService.js | ASPP |
| 喷塑 | `packing_process_plans` | packingProcessPlanService.js | SPPP |

### 2. 数据流完整性验证

**步骤1**：创建主生产计划，执行排程
```sql
-- 查询备料计划
SELECT plan_no, material_code, source_process, replenishment_quantity
FROM material_preparation_plans
WHERE main_plan_product_code = '6001A0306'
ORDER BY created_at;
```

**步骤2**：验证工序计划推送
```sql
-- 打包工序计划（来源工序=打包）
SELECT plan_no, product_code, source_no, process_name
FROM real_process_plans
WHERE main_plan_product_code = '6001A0306';

-- 组装工序计划（来源工序=组装）
SELECT plan_no, product_code, source_no, process_name
FROM assembly_process_plans
WHERE master_plan_product_code = '6001A0306';

-- 喷塑工序计划（来源工序=喷塑）
SELECT plan_no, product_code, source_no, process_name
FROM packing_process_plans
WHERE master_plan_product_code = '6001A0306';
```

### 3. 日志输出验证

**备料计划推送日志**：
```
📍 [数据路由] 来源工序=打包 → 推送到打包工序计划 (表: real_process_plans)
📍 [数据路由] 来源工序=组装 → 推送到组装工序计划 (表: assembly_process_plans)
📍 [数据路由] 来源工序=喷塑 → 推送到喷塑工序计划 (表: packing_process_plans)
```

**工序计划推送日志**：
```
🔍 [自动推送检查] 打包工序计划 -> 备料计划
🔍 [自动推送检查] 组装工序计划 -> 备料计划
🔍 [自动推送检查] 喷塑工序计划 -> 备料计划
```

---

## 🎯 关键成功因素

1. **命名一致性**：代码、日志、注释中的命名与规则文档保持一致
2. **表映射正确性**：来源工序与数据库表的映射关系正确
3. **Service路由正确性**：根据来源工序路由到正确的Service文件
4. **递归终止条件**：通过IFS条件判断自然终止数据流
5. **完整性验证**：每个环节都能正确执行并传递数据

---

## 📝 总结

### 修复前的问题

1. ❌ 工序计划命名未完全更新（代码中残留"真工序计划"）
2. ❌ 备料计划推送路由错误（打包→packing_process_plans）
3. ❌ 缺少喷塑工序的支持

### 修复后的改进

1. ✅ 完全更新命名体系（打包工序计划、组装工序计划、喷塑工序计划）
2. ✅ 修复推送路由（打包→real_process_plans）
3. ✅ 新增喷塑工序支持（喷塑→packing_process_plans）
4. ✅ 三个工序计划Service都支持递归推送到备料计划
5. ✅ 完整的数据流闭环：主生产计划 → 备料计划 ⇄ 工序计划 → 备料计划 → ...

### 代码统计

- **修改文件数**：3个
- **总新增行数**：45行
- **总删除行数**：37行
- **净增加行数**：8行

---

**修复完成时间**: 2025-12-15 10:40  
**修复验证状态**: 等待用户测试  
**建议下一步**: 执行主生产计划排程，验证完整数据流

---

**文档结束** ✨
