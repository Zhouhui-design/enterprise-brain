# âœ… æ‰“åŒ…å·¥åºå­—æ®µæ˜ å°„é—®é¢˜å®Œæ•´åˆ†ææŠ¥å‘Š

**æ—¥æœŸ**: 2025-12-19  
**é—®é¢˜**: å¤‡æ–™è®¡åˆ’æ¨é€åˆ°æ‰“åŒ…å·¥åºè®¡åˆ’æ—¶ï¼Œå¤šä¸ªå­—æ®µæœªæ­£ç¡®æ˜ å°„

---

## ğŸ“‹ æ•°æ®æµè·¯å¾„ç¡®è®¤

```
ä¸»ç”Ÿäº§è®¡åˆ’ MPS2025000001
    â†“
å¤‡æ–™è®¡åˆ’ MPP2025658732657 (æ¥æºå·¥åº=æ‰“åŒ…) â† ã€æ¥æºæ•°æ®ã€‘
    â†“
æ‰“åŒ…å·¥åºè®¡åˆ’ RPP2512197332 â† ã€ç›®æ ‡æ•°æ®ã€‘
    â†“
å¤‡æ–™è®¡åˆ’ MPP202512201766183658799897 (BOMå­ä»¶æ¨é€)
```

---

## ğŸ” é—®é¢˜è¯Šæ–­ç»“æœ

### âœ… æ­£ç¡®æ˜ å°„çš„å­—æ®µï¼ˆ9ä¸ªï¼‰

| å­—æ®µ | å¤‡æ–™è®¡åˆ’å€¼ | æ‰“åŒ…å·¥åºå€¼ | çŠ¶æ€ |
|------|-----------|-----------|------|
| é”€å”®è®¢å•ç¼–å· | SO2025000001 | SO2025000001 | âœ… |
| å®¢æˆ·è®¢å•ç¼–å· | 0633 | 0633 | âœ… |
| ä¸»ç”Ÿäº§è®¡åˆ’ç¼–å· | MPS2025000001 | MPS2025000001 | âœ… |
| ç”Ÿäº§äº§å“ç¼–å· | 6001A0306 | 6001A0306 | âœ… |
| ç”Ÿäº§äº§å“åç§° | 6001A0306ï¼Œé“è´¨æ–¹å‘ç›˜æ¬¾ï¼Œå˜‰åš | 6001A0306ï¼Œé“è´¨æ–¹å‘ç›˜æ¬¾ï¼Œå˜‰åš | âœ… |
| å·¥åºåç§° | æ‰“åŒ… | æ‰“åŒ… | âœ… |
| éœ€è¡¥è´§æ•°é‡ | 163.0000 | 163.0000 | âœ… |
| å®šæ—¶å·¥é¢ | (Lookup) | 6.00 | âœ… |
| è®¡åˆ’æ’ç¨‹æ—¥æœŸ | (éœ€æ±‚æ—¥æœŸ) 2026-01-06 | 2026-01-06 | âœ… |

### âŒ é”™è¯¯æ˜ å°„çš„å­—æ®µï¼ˆ8ä¸ªï¼‰

| # | å­—æ®µå | æ•°æ®åº“å­—æ®µ | å¤‡æ–™è®¡åˆ’å€¼ | æ‰“åŒ…å·¥åºå€¼ | é¢„æœŸå€¼ | çŠ¶æ€ |
|---|-------|-----------|-----------|-----------|--------|------|
| 1 | **ä¸»è®¡åˆ’äº§å“ç¼–å·** | `main_plan_product_code` | `6001A0306` | **ç©º** | `6001A0306` | âŒ |
| 2 | **ä¸»è®¡åˆ’äº§å“åç§°** | `main_plan_product_name` | `6001A0306ï¼Œé“è´¨æ–¹å‘ç›˜æ¬¾ï¼Œå˜‰åš` | **ç©º** | `6001A0306ï¼Œé“è´¨æ–¹å‘ç›˜æ¬¾ï¼Œå˜‰åš` | âŒ |
| 3 | **è®¡åˆ’å¼€å§‹æ—¥æœŸ** | `plan_start_date` | - | **ç©º** | `2026-01-06` (æ–°å¢è¡Œ=è®¡åˆ’æ’ç¨‹æ—¥æœŸ) | âŒ |
| 4 | **è®¢å•æ‰¿è¯ºäº¤æœŸ** | `order_promise_delivery_date` | `2026-01-09` | **ç©º** | `2026-01-09` | âŒ |
| 5 | **0é˜¶éœ€æ±‚æ•°é‡** | `level0_demand` | `null` (ä¸»è®¡åˆ’æ’ç¨‹æ•°é‡) | `0.0000` | `163.0000` (=éœ€è¡¥è´§æ•°é‡) | âŒ |
| 6 | **å½“å¤©æ€»å·¥æ—¶** | `daily_total_hours` | - | `0.00` | `16.00` (2Ã—8) | âŒ |
| 7 | **éœ€æ±‚å·¥æ—¶** | `required_work_hours` | - | `0.00` | `27.17` (163Ã·6) | âŒ |
| 8 | **è®¡åˆ’æ’ç¨‹æ•°é‡** | `schedule_quantity` | - | `163.0000` | `0.0000` (0Ã—6) | âŒ |

---

## ğŸ“Š è¯¦ç»†é—®é¢˜åˆ†æ

### é—®é¢˜1: ä¸»è®¡åˆ’äº§å“ç¼–å·/åç§°æœªæ˜ å°„

**æ¥æºæ•°æ®ï¼ˆå¤‡æ–™è®¡åˆ’ï¼‰**:
```
main_plan_product_code = '6001A0306'
main_plan_product_name = '6001A0306ï¼Œé“è´¨æ–¹å‘ç›˜æ¬¾ï¼Œå˜‰åš'
```

**ç›®æ ‡æ•°æ®ï¼ˆæ‰“åŒ…å·¥åºï¼‰**:
```
main_plan_product_code = NULL  âŒ
main_plan_product_name = NULL  âŒ
```

**åŸå› **: åç«¯æ¨é€ä»£ç æœªæ˜ å°„è¿™ä¸¤ä¸ªå­—æ®µ

**ä¿®å¤ä½ç½®**: `backend/services/materialPreparationPlanService.js` ä¸­çš„ `pushToProcessPlan()` æ–¹æ³•

---

### é—®é¢˜2: è®¡åˆ’å¼€å§‹æ—¥æœŸæœªè®¾ç½®

**é¢„æœŸè§„åˆ™**: 
- æ–°å¢è¡Œ: `plan_start_date = schedule_date`
- è‡ªå¢è¡Œ: `plan_start_date = ä¸Šä¸€è¡Œçš„ next_schedule_date`

**å½“å‰å€¼**: `NULL` âŒ

**åŸå› **: åç«¯æ¨é€æ—¶æœªè®¾ç½® `planStartDate` å­—æ®µ

---

### é—®é¢˜3: è®¢å•æ‰¿è¯ºäº¤æœŸæœªæ˜ å°„

**æ¥æºæ•°æ®**: `promise_delivery_date = '2026-01-09'`

**ç›®æ ‡æ•°æ®**: `order_promise_delivery_date = NULL` âŒ

**åŸå› **: åç«¯æ¨é€ä»£ç å­—æ®µåæ˜ å°„é”™è¯¯æˆ–æœªæ˜ å°„

---

### é—®é¢˜4: 0é˜¶éœ€æ±‚æ•°é‡è®¡ç®—é”™è¯¯

**é¢„æœŸè§„åˆ™**: 
```
æ‰“åŒ…å·¥åºçš„ level0_demand = å¤‡æ–™è®¡åˆ’çš„ parent_schedule_quantity
```

**å¤‡æ–™è®¡åˆ’å€¼**: `parent_schedule_quantity = NULL`

**é—®é¢˜**: å¤‡æ–™è®¡åˆ’ä¸­ `parent_schedule_quantity` æœ¬èº«å°±æ˜¯ç©ºå€¼ï¼

**æ ¹æœ¬åŸå› **: éœ€è¦è¿½æº¯åˆ°ä¸»ç”Ÿäº§è®¡åˆ’æ¨é€å¤‡æ–™è®¡åˆ’æ—¶ï¼Œ`parent_schedule_quantity` æœªæ­£ç¡®å¡«å……

**æ­£ç¡®é€»è¾‘**: åº”è¯¥ç­‰äºå¤‡æ–™è®¡åˆ’çš„ `replenishment_quantity` (163.0000)

---

### é—®é¢˜5: å½“å¤©æ€»å·¥æ—¶æœªè®¡ç®—

**å·¥åºèƒ½åŠ›è´Ÿè·è¡¨æ•°æ®**:
```sql
SELECT * FROM process_capacity_load 
WHERE process_name='æ‰“åŒ…' AND date='2026-01-06'

ç»“æœ:
- work_shift = 8.00
- available_workstations = 2.00
- total_hours = 0.00  â† è¿™ä¸ªå­—æ®µæœ¬èº«å°±æ˜¯0ï¼
```

**é¢„æœŸè®¡ç®—**:
```
daily_total_hours = available_workstations Ã— work_shift
                 = 2.00 Ã— 8.00 
                 = 16.00
```

**å½“å‰å€¼**: `0.00` âŒ

**åŸå› **: 
1. å·¥åºèƒ½åŠ›è´Ÿè·è¡¨çš„ `total_hours` å­—æ®µæœªæ­£ç¡®è®¡ç®—
2. åç«¯æ¨é€ä»£ç æœªæ‰§è¡Œæ­¤è®¡ç®—

---

### é—®é¢˜6: éœ€æ±‚å·¥æ—¶è®¡ç®—æœªæ‰§è¡Œ

**é¢„æœŸè§„åˆ™**:
```
required_work_hours = replenishment_qty Ã· standard_work_quota
                   = 163.0000 Ã· 6.00
                   = 27.17
```

**å½“å‰å€¼**: `0.00` âŒ

**åŸå› **: åç«¯ `create()` æ–¹æ³•ä¸­çš„è®¡ç®—é€»è¾‘æœªè§¦å‘æˆ–è®¡ç®—ç»“æœæœªä¿å­˜

---

### é—®é¢˜7: è®¡åˆ’æ’ç¨‹æ•°é‡é€»è¾‘é”™è¯¯

**é¢„æœŸè§„åˆ™**:
```
schedule_quantity = scheduled_work_hours Ã— standard_work_quota
                 = 0.00 Ã— 6.00
                 = 0.0000
```

**å½“å‰å€¼**: `163.0000` âŒï¼ˆç›´æ¥ä½¿ç”¨äº†needsè¡¥è´§æ•°é‡ï¼‰

**é—®é¢˜**: å½“å‰ä»£ç é€»è¾‘é”™è¯¯ï¼Œåº”è¯¥æ ¹æ®æ’ç¨‹å·¥æ—¶è®¡ç®—ï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨éœ€è¡¥è´§æ•°é‡

---

## ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤æ–‡ä»¶å®šä½

ä¸»è¦éœ€è¦ä¿®æ”¹ä»¥ä¸‹åç«¯æ–‡ä»¶:

1. **`backend/services/materialPreparationPlanService.js`**
   - `pushToProcessPlan()` æ–¹æ³• - ä¿®å¤å­—æ®µæ˜ å°„

2. **`backend/services/packingProcessPlanService.js`**
   - `create()` æ–¹æ³• - ä¿®å¤å­—æ®µè®¡ç®—é€»è¾‘

3. **`backend/services/masterProductionPlanService.js`**
   - ä¿®å¤æ¨é€å¤‡æ–™è®¡åˆ’æ—¶çš„ `parent_schedule_quantity` å¡«å……

### ä¿®å¤æ¸…å•

#### ä¿®å¤1: ä¸»è®¡åˆ’äº§å“ç¼–å·/åç§°æ˜ å°„

**æ–‡ä»¶**: `materialPreparationPlanService.js`

```javascript
// åœ¨ pushToProcessPlan() æ–¹æ³•ä¸­æ·»åŠ :
mainPlanProductCode: materialPrepData.main_plan_product_code,  // âœ… æ–°å¢
mainPlanProductName: materialPrepData.main_plan_product_name,  // âœ… æ–°å¢
```

#### ä¿®å¤2: è®¡åˆ’å¼€å§‹æ—¥æœŸè®¾ç½®

```javascript
planStartDate: materialPrepData.demand_date,  // âœ… æ–°å¢ï¼ˆæ–°å¢è¡Œ=éœ€æ±‚æ—¥æœŸï¼‰
```

#### ä¿®å¤3: è®¢å•æ‰¿è¯ºäº¤æœŸæ˜ å°„

```javascript
orderPromiseDeliveryDate: materialPrepData.promise_delivery_date,  // âœ… æ–°å¢
```

#### ä¿®å¤4: 0é˜¶éœ€æ±‚æ•°é‡ä¿®å¤

éœ€è¦ä¸¤æ­¥ä¿®å¤:

**æ­¥éª¤1**: ä¿®å¤å¤‡æ–™è®¡åˆ’çš„ `parent_schedule_quantity`
```javascript
// åœ¨ä¸»ç”Ÿäº§è®¡åˆ’æ¨é€å¤‡æ–™è®¡åˆ’æ—¶:
parent_schedule_quantity: mps.plan_quantity  // ä½¿ç”¨ä¸»è®¡åˆ’çš„è®¡åˆ’æ•°é‡
```

**æ­¥éª¤2**: ä¿®å¤æ‰“åŒ…å·¥åºçš„ `level0_demand`
```javascript
level0Demand: materialPrepData.parent_schedule_quantity || materialPrepData.replenishment_quantity
```

#### ä¿®å¤5: å½“å¤©æ€»å·¥æ—¶è®¡ç®—

```javascript
// åœ¨ packingProcessPlanService.js çš„ create() æ–¹æ³•ä¸­:

// æŸ¥è¯¢å·¥åºèƒ½åŠ›è´Ÿè·è¡¨
const [capacityRows] = await pool.execute(`
  SELECT available_workstations, work_shift 
  FROM process_capacity_load 
  WHERE process_name = ? AND date = ?
`, [data.processName, data.scheduleDate]);

let dailyTotalHours = 0;
if (capacityRows.length > 0) {
  const capacity = capacityRows[0];
  dailyTotalHours = capacity.available_workstations * capacity.work_shift;
  console.log(`âœ… [å½“å¤©æ€»å·¥æ—¶è®¡ç®—] ${capacity.available_workstations} Ã— ${capacity.work_shift} = ${dailyTotalHours}`);
}
```

#### ä¿®å¤6: éœ€æ±‚å·¥æ—¶è®¡ç®—

```javascript
// åœ¨ packingProcessPlanService.js çš„ create() æ–¹æ³•ä¸­:

let requiredWorkHours = 0;
const replenishmentQty = parseFloat(data.replenishmentQty || 0);
const standardWorkQuota = parseFloat(standardWorkQuota);

if (standardWorkQuota > 0 && replenishmentQty > 0) {
  requiredWorkHours = (replenishmentQty / standardWorkQuota).toFixed(2);
  console.log(`âœ… [éœ€æ±‚å·¥æ—¶è®¡ç®—] ${replenishmentQty} Ã· ${standardWorkQuota} = ${requiredWorkHours}`);
}
```

#### ä¿®å¤7: è®¡åˆ’æ’ç¨‹æ•°é‡é€»è¾‘ä¿®æ­£

```javascript
// è®¡åˆ’æ’ç¨‹æ•°é‡åº”è¯¥ç”±æ’ç¨‹å·¥æ—¶å†³å®šï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨éœ€è¡¥è´§æ•°é‡
const scheduledWorkHours = parseFloat(data.scheduledWorkHours || 0);
const scheduleQuantity = (scheduledWorkHours * standardWorkQuota).toFixed(4);

// æ³¨æ„ï¼šå¦‚æœ scheduledWorkHours = 0ï¼Œåˆ™ scheduleQuantity = 0
// éœ€è¡¥è´§æ•°é‡(replenishment_qty)æ˜¯éœ€æ±‚æ€»é‡ï¼Œä¸ç­‰äºæœ¬æ¬¡æ’ç¨‹æ•°é‡
```

---

## ğŸ¯ éªŒè¯æ­¥éª¤

ä¿®å¤åéœ€è¦éªŒè¯ä»¥ä¸‹æµç¨‹:

1. **åˆ›å»ºæ–°çš„é”€å”®è®¢å•**
2. **ä¸»ç”Ÿäº§è®¡åˆ’ â†’ æ‰§è¡Œæ’ç¨‹**
3. **æ£€æŸ¥ç”Ÿæˆçš„å¤‡æ–™è®¡åˆ’**:
   - `parent_schedule_quantity` åº”è¯¥ = ä¸»è®¡åˆ’çš„ `plan_quantity`
   - `main_plan_product_code` å’Œ `main_plan_product_name` åº”æœ‰å€¼
4. **æ£€æŸ¥ç”Ÿæˆçš„æ‰“åŒ…å·¥åºè®¡åˆ’**:
   - æ‰€æœ‰8ä¸ªé”™è¯¯å­—æ®µéƒ½åº”æœ‰æ­£ç¡®å€¼
   - éœ€æ±‚å·¥æ—¶ = 163 Ã· 6 = 27.17
   - å½“å¤©æ€»å·¥æ—¶ = 2 Ã— 8 = 16.00

---

## ğŸ“ æ•°æ®åº“å­—æ®µå‘½åå¯¹ç…§è¡¨

### å¤‡æ–™è®¡åˆ’è¡¨ (material_preparation_plans)

| ä¸­æ–‡å | æ•°æ®åº“å­—æ®µ | ç±»å‹ |
|-------|-----------|------|
| ä¸»è®¡åˆ’äº§å“ç¼–å· | `main_plan_product_code` | VARCHAR |
| ä¸»è®¡åˆ’äº§å“åç§° | `main_plan_product_name` | VARCHAR |
| ä¸»è®¡åˆ’æ’ç¨‹æ•°é‡ | `parent_schedule_quantity` | DECIMAL |
| éœ€æ±‚æ—¥æœŸ | `demand_date` | DATE |
| è®¢å•æ‰¿è¯ºäº¤æœŸ | `promise_delivery_date` | DATE |
| éœ€è¡¥è´§æ•°é‡ | `replenishment_quantity` | DECIMAL |

### æ‰“åŒ…å·¥åºè®¡åˆ’è¡¨ (packing_process_plans)

| ä¸­æ–‡å | æ•°æ®åº“å­—æ®µ | ç±»å‹ |
|-------|-----------|------|
| ä¸»è®¡åˆ’äº§å“ç¼–å· | `main_plan_product_code` | VARCHAR |
| ä¸»è®¡åˆ’äº§å“åç§° | `main_plan_product_name` | VARCHAR |
| è®¡åˆ’å¼€å§‹æ—¥æœŸ | `plan_start_date` | DATE |
| è®¢å•æ‰¿è¯ºäº¤æœŸ | `order_promise_delivery_date` | DATE |
| 0é˜¶éœ€æ±‚æ•°é‡ | `level0_demand` | DECIMAL |
| å½“å¤©æ€»å·¥æ—¶ | `daily_total_hours` | DECIMAL |
| éœ€æ±‚å·¥æ—¶ | `required_work_hours` | DECIMAL |
| è®¡åˆ’æ’ç¨‹æ•°é‡ | `schedule_quantity` | DECIMAL |
| éœ€è¡¥è´§æ•°é‡ | `replenishment_qty` | DECIMAL |
| å®šæ—¶å·¥é¢ | `standard_work_quota` | DECIMAL |
| è®¡åˆ’æ’ç¨‹å·¥æ—¶ | `scheduled_work_hours` | DECIMAL |

---

## âœ… æ€»ç»“

**å‘ç°é—®é¢˜**: 8ä¸ªå­—æ®µæœªæ­£ç¡®æ˜ å°„æˆ–è®¡ç®—

**æ ¹æœ¬åŸå› **:
1. åç«¯æ¨é€ä»£ç ç¼ºå°‘å­—æ®µæ˜ å°„
2. å­—æ®µè®¡ç®—é€»è¾‘æœªæ‰§è¡Œæˆ–æœ‰é”™è¯¯
3. ä¸Šæ¸¸æ•°æ®ï¼ˆå¤‡æ–™è®¡åˆ’çš„ parent_schedule_quantityï¼‰æœªæ­£ç¡®å¡«å……

**ä¼˜å…ˆçº§**:
- ğŸ”´ é«˜ä¼˜å…ˆçº§: ä¸»è®¡åˆ’äº§å“ç¼–å·/åç§°ã€è®¢å•æ‰¿è¯ºäº¤æœŸã€è®¡åˆ’å¼€å§‹æ—¥æœŸ
- ğŸŸ¡ ä¸­ä¼˜å…ˆçº§: å½“å¤©æ€»å·¥æ—¶ã€éœ€æ±‚å·¥æ—¶
- ğŸŸ¢ ä½ä¼˜å…ˆçº§: 0é˜¶éœ€æ±‚æ•°é‡ã€è®¡åˆ’æ’ç¨‹æ•°é‡ï¼ˆéœ€é‡æ–°ç†è§£ä¸šåŠ¡é€»è¾‘ï¼‰

éœ€è¦æˆ‘å¼€å§‹ä¿®å¤è¿™äº›é—®é¢˜å—ï¼Ÿ
