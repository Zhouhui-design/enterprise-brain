# âœ… æ‰“åŒ…å·¥åºå­—æ®µæ˜ å°„ä¿®å¤æ–¹æ¡ˆ

**æ—¥æœŸ**: 2025-12-19  
**ç›®æ ‡**: ä¿®å¤å¤‡æ–™è®¡åˆ’æ¨é€åˆ°æ‰“åŒ…å·¥åºè®¡åˆ’æ—¶çš„8ä¸ªå­—æ®µæ˜ å°„é—®é¢˜

---

## ğŸ“‹ é—®é¢˜æ€»ç»“

æ ¹æ®è¯Šæ–­ï¼Œå‘ç°ä»¥ä¸‹é—®é¢˜ï¼š

| # | å­—æ®µ | å½“å‰å€¼ | é¢„æœŸå€¼ | åŸå›  |
|---|------|--------|--------|------|
| 1 | ä¸»è®¡åˆ’äº§å“ç¼–å· | ç©º | 6001A0306 | âŒ å¤‡æ–™è®¡åˆ’ä¸­æ­¤å­—æ®µæœ‰å€¼ï¼Œä½†æ¨é€æ—¶æœªæ­£ç¡®ä¼ é€’ |
| 2 | ä¸»è®¡åˆ’äº§å“åç§° | ç©º | 6001A0306ï¼Œé“è´¨æ–¹å‘ç›˜æ¬¾ï¼Œå˜‰åš | âŒ å¤‡æ–™è®¡åˆ’ä¸­æ­¤å­—æ®µæœ‰å€¼ï¼Œä½†æ¨é€æ—¶æœªæ­£ç¡®ä¼ é€’ |
| 3 | è®¡åˆ’å¼€å§‹æ—¥æœŸ | ç©º | 2026-01-06 | âŒ æ¨é€ä»£ç ä¸­ `planStartDate: null` |
| 4 | è®¢å•æ‰¿è¯ºäº¤æœŸ | ç©º | 2026-01-09 | âš ï¸ å­—æ®µåå¯èƒ½ä¸åŒ¹é… |
| 5 | 0é˜¶éœ€æ±‚æ•°é‡ | 0.0000 | 163.0000 | âŒ æ¨é€ä»£ç ä¸­ `level0Demand: 0` |
| 6 | å½“å¤©æ€»å·¥æ—¶ | 0.00 | 16.00 | âŒ æ¨é€ä»£ç ä¸­ `dailyTotalHours: 0`ï¼Œæœªè®¡ç®— |
| 7 | éœ€æ±‚å·¥æ—¶ | 0.00 | 27.17 | âŒ æ¨é€ä»£ç ä¸­ `requiredWorkHours: 0`ï¼Œæœªè®¡ç®— |
| 8 | è®¡åˆ’æ’ç¨‹æ•°é‡ | 163.0000 | 0.0000 | âš ï¸ é€»è¾‘é”™è¯¯ï¼Œåº”è¯¥=è®¡åˆ’æ’ç¨‹å·¥æ—¶Ã—å®šæ—¶å·¥é¢ |

---

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### åŸå› 1: å¤‡æ–™è®¡åˆ’createæ—¶æœªæ­£ç¡®è®¾ç½®main_plan_product_code/name

æŸ¥çœ‹å¤‡æ–™è®¡åˆ’æ•°æ®ï¼š
```
main_plan_product_code = '6001A0306'  âœ… æ•°æ®åº“ä¸­æœ‰å€¼
main_plan_product_name = '6001A0306ï¼Œé“è´¨æ–¹å‘ç›˜æ¬¾ï¼Œå˜‰åš'  âœ… æ•°æ®åº“ä¸­æœ‰å€¼
```

ä½†æ¨é€ä»£ç ä¸­ï¼š
```javascript
// materialPreparationPlanService.js ç¬¬681-682è¡Œ
masterPlanProductCode: materialPlanData.mainPlanProductCode || null,  // â† materialPlanDataä¸­æ˜¯ç©ºçš„ï¼
masterPlanProductName: materialPlanData.mainPlanProductName || null,
```

**é—®é¢˜**: `materialPlanData` å¯¹è±¡ä»æ•°æ®åº“æŸ¥è¯¢æ—¶ï¼Œå­—æ®µåæ˜¯ `main_plan_product_code` (snake_case)ï¼Œä½†ä»£ç ä¸­ä½¿ç”¨çš„æ˜¯ `mainPlanProductCode` (camelCase)ï¼Œå¯¼è‡´å–ä¸åˆ°å€¼ï¼

### åŸå› 2: å…¶ä»–å­—æ®µæœªè®¡ç®—

æ¨é€ä»£ç ï¼ˆç¬¬690-722è¡Œï¼‰ç›´æ¥è®¾ç½®ä¸º0æˆ–nullï¼š
```javascript
level0Demand: 0,  // âŒ åº”è¯¥è®¡ç®—
planStartDate: null,  // âŒ åº”è¯¥è®¾ç½®
dailyTotalHours: 0,  // âŒ åº”è¯¥è®¡ç®—
requiredWorkHours: 0,  // âŒ åº”è¯¥è®¡ç®—
```

---

## ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1: å­—æ®µåè½¬æ¢ï¼ˆSnake_case â†’ CamelCaseï¼‰

**æ–‡ä»¶**: `backend/services/materialPreparationPlanService.js`

**ä½ç½®**: `pushToRealProcessPlan()` æ–¹æ³•ï¼Œç¬¬674-723è¡Œ

**ä¿®æ”¹æ–¹æ³•**: åœ¨å‡†å¤‡ `processPlanData` ä¹‹å‰ï¼Œå…ˆè½¬æ¢å­—æ®µå

```javascript
// âœ… ç¬¬673è¡Œåæ·»åŠ å­—æ®µåè½¬æ¢é€»è¾‘
const processPlanData = {
  // åŸºç¡€ä¿¡æ¯
  planNo: `RPP${new Date().toISOString().slice(2, 10).replace(/-/g, '')}${String(Math.floor(Math.random() * 10000)).padStart(4, '0')}`,
  scheduleDate: materialPlanData.demandDate || materialPlanData.demand_date || new Date(),
  salesOrderNo: materialPlanData.salesOrderNo || materialPlanData.sales_order_no || null,
  customerOrderNo: materialPlanData.customerOrderNo || materialPlanData.customer_order_no || null,
  masterPlanNo: materialPlanData.sourcePlanNo || materialPlanData.source_plan_no || null,
  
  // âœ… ä¿®å¤ä¸»è®¡åˆ’äº§å“ç¼–å·/åç§° - å…¼å®¹ä¸¤ç§å‘½åæ ¼å¼
  masterPlanProductCode: materialPlanData.mainPlanProductCode || materialPlanData.main_plan_product_code || null,
  masterPlanProductName: materialPlanData.mainPlanProductName || materialPlanData.main_plan_product_name || null,
  
  productCode: materialPlanData.materialCode || materialPlanData.material_code || null,
  productName: materialPlanData.materialName || materialPlanData.material_name || null,
  productImage: materialPlanData.productImage || materialPlanData.product_image || null,
  processManager: null,
  processName: materialPlanData.sourceProcess || materialPlanData.source_process,
  scheduleQuantity: replenishmentQty,
  productUnit: materialPlanData.materialUnit || materialPlanData.material_unit || null,
  
  // âœ… ä¿®å¤0é˜¶éœ€æ±‚æ•°é‡ - ä½¿ç”¨çˆ¶ä»¶æ’ç¨‹æ•°é‡æˆ–éœ€è¡¥è´§æ•°é‡
  level0Demand: materialPlanData.parentScheduleQuantity || materialPlanData.parent_schedule_quantity || replenishmentQty,
  
  completionDate: materialPlanData.demandDate || materialPlanData.demand_date || null,
  
  // âœ… ä¿®å¤è®¢å•æ‰¿è¯ºäº¤æœŸ - å…¼å®¹ä¸¤ç§å‘½åæ ¼å¼
  orderPromiseDeliveryDate: materialPlanData.promiseDeliveryDate || materialPlanData.promise_delivery_date || null,
  
  // å·¥åºç›¸å…³ä¿¡æ¯
  // âœ… ä¿®å¤è®¡åˆ’å¼€å§‹æ—¥æœŸ - æ–°å¢è¡Œä½¿ç”¨éœ€æ±‚æ—¥æœŸ
  planStartDate: materialPlanData.demandDate || materialPlanData.demand_date || null,
  
  realPlanStartDate: null,
  planEndDate: materialPlanData.demandDate || materialPlanData.demand_date || null,
  workshopName: null,
  dailyAvailableHours: 0,
  remainingRequiredHours: 0,
  scheduleCount: 1,
  standardWorkHours: 0,
  standardWorkQuota: 0,  // è¿™ä¸ªä¼šåœ¨create()æ–¹æ³•ä¸­lookup
  cumulativeScheduleQty: replenishmentQty,
  unscheduledQty: 0,
  sourcePageName: 'å¤‡æ–™è®¡åˆ’',
  sourceNo: materialPlanData.planNo || materialPlanData.plan_no,
  previousScheduleNo: null,
  customerName: materialPlanData.customerName || materialPlanData.customer_name || null,
  level0ProductName: null,
  level0ProductCode: null,
  level0ProductionQty: 0,
  productSource: materialPlanData.materialSource || materialPlanData.material_source || null,
  bomNo: null,
  submittedBy: materialPlanData.submitter || 'system',
  submittedAt: new Date(),
  replenishmentQty: replenishmentQty,
  
  // âš ï¸ ä»¥ä¸‹å­—æ®µå°†åœ¨create()æ–¹æ³•ä¸­è®¡ç®—ï¼Œè¿™é‡Œè®¾ç½®ä¸º0
  requiredWorkHours: 0,  // å°†åœ¨create()ä¸­è®¡ç®—: replenishmentQty Ã· standardWorkQuota
  dailyTotalHours: 0,  // å°†åœ¨create()ä¸­ä»å·¥åºèƒ½åŠ›è´Ÿè·è¡¨æŸ¥è¯¢
  dailyScheduledHours: 0,
  scheduledWorkHours: 0,
  nextScheduleDate: null
};
```

### ä¿®å¤2: åœ¨æ‰“åŒ…å·¥åºcreate()æ–¹æ³•ä¸­æ·»åŠ å­—æ®µè®¡ç®—

**æ–‡ä»¶**: `backend/services/packingProcessPlanService.js`

**ä½ç½®**: `create()` æ–¹æ³•

**éœ€è¦æ·»åŠ çš„è®¡ç®—é€»è¾‘**:

```javascript
// åœ¨å®šæ—¶å·¥é¢lookupä¹‹åæ·»åŠ ä»¥ä¸‹è®¡ç®—

// âœ… 1. è®¡ç®—éœ€æ±‚å·¥æ—¶
let requiredWorkHours = 0;
const replenishmentQty = parseFloat(data.replenishmentQty || 0);
if (standardWorkQuota > 0 && replenishmentQty > 0) {
  requiredWorkHours = (replenishmentQty / standardWorkQuota).toFixed(2);
  console.log(`âœ… [éœ€æ±‚å·¥æ—¶è®¡ç®—] ${replenishmentQty} Ã· ${standardWorkQuota} = ${requiredWorkHours}`);
}

// âœ… 2. æŸ¥è¯¢å½“å¤©æ€»å·¥æ—¶ï¼ˆä»å·¥åºèƒ½åŠ›è´Ÿè·è¡¨ï¼‰
let dailyTotalHours = 0;
if (data.scheduleDate && data.processName) {
  try {
    const [capacityRows] = await pool.execute(`
      SELECT available_workstations, work_shift 
      FROM process_capacity_load 
      WHERE process_name = ? AND date = ?
    `, [data.processName, data.scheduleDate]);
    
    if (capacityRows.length > 0) {
      const capacity = capacityRows[0];
      dailyTotalHours = parseFloat((capacity.available_workstations * capacity.work_shift).toFixed(2));
      console.log(`âœ… [å½“å¤©æ€»å·¥æ—¶æŸ¥è¯¢] ${capacity.available_workstations} Ã— ${capacity.work_shift} = ${dailyTotalHours}`);
    }
  } catch (error) {
    console.error(`âŒ [å½“å¤©æ€»å·¥æ—¶æŸ¥è¯¢å¤±è´¥]`, error);
  }
}

// âœ… 3. åœ¨INSERTè¯­å¥ä¸­ä½¿ç”¨è®¡ç®—åçš„å€¼
// å°†ä»¥ä¸‹å­—æ®µçš„å€¼æ”¹ä¸º:
//   required_work_hours = requiredWorkHours
//   daily_total_hours = dailyTotalHours
```

### ä¿®å¤3: ä¿®æ­£è®¡åˆ’æ’ç¨‹æ•°é‡é€»è¾‘

**å½“å‰é—®é¢˜**: `schedule_quantity = 163.0000` (ç›´æ¥ä½¿ç”¨äº†needsè¡¥è´§æ•°é‡)

**æ­£ç¡®é€»è¾‘**: `schedule_quantity = scheduled_work_hours Ã— standard_work_quota`

**è¯´æ˜**: 
- `replenishment_qty` (needsè¡¥è´§æ•°é‡) æ˜¯**æ€»éœ€æ±‚**
- `schedule_quantity` (è®¡åˆ’æ’ç¨‹æ•°é‡) æ˜¯**æœ¬æ¬¡æ’ç¨‹çš„æ•°é‡**
- é¦–æ¬¡æ’ç¨‹æ—¶ï¼Œå¦‚æœ `scheduled_work_hours = 0`ï¼Œåˆ™ `schedule_quantity = 0`
- éœ€è¦é€šè¿‡æ’ç¨‹ç®—æ³•é€æ­¥åˆ†é… `replenishment_qty` åˆ°å¤šæ¬¡æ’ç¨‹ä¸­

**ä¿®å¤ä½ç½®**: `packingProcessPlanService.js` create()æ–¹æ³•ä¸­çš„INSERTè¯­å¥

```javascript
// å½“å‰ä»£ç å¯èƒ½æ˜¯:
schedule_quantity = data.scheduleQuantity || data.replenishmentQty

// åº”è¯¥æ”¹ä¸º:
const scheduledWorkHours = parseFloat(data.scheduledWorkHours || 0);
const scheduleQuantity = (scheduledWorkHours * standardWorkQuota).toFixed(4);
```

---

## ğŸ“ å®Œæ•´ä¿®æ”¹æ¸…å•

### æ–‡ä»¶1: `backend/services/materialPreparationPlanService.js`

**ä¿®æ”¹ä½ç½®**: ç¬¬674-723è¡Œ `pushToRealProcessPlan()` æ–¹æ³•ä¸­çš„ `processPlanData` å¯¹è±¡

**ä¿®æ”¹å†…å®¹**:
1. âœ… ç¬¬681è¡Œ: `masterPlanProductCode` - æ·»åŠ  `|| materialPlanData.main_plan_product_code`
2. âœ… ç¬¬682è¡Œ: `masterPlanProductName` - æ·»åŠ  `|| materialPlanData.main_plan_product_name`
3. âœ… ç¬¬690è¡Œ: `level0Demand` - æ”¹ä¸º `materialPlanData.parent_schedule_quantity || replenishmentQty`
4. âœ… ç¬¬692è¡Œ: `orderPromiseDeliveryDate` - æ·»åŠ  `|| materialPlanData.promise_delivery_date`
5. âœ… ç¬¬695è¡Œ: `planStartDate` - æ”¹ä¸º `materialPlanData.demand_date`

### æ–‡ä»¶2: `backend/services/packingProcessPlanService.js`

**ä¿®æ”¹ä½ç½®**: `create()` æ–¹æ³•ä¸­ï¼Œå®šæ—¶å·¥é¢lookupä¹‹å

**ä¿®æ”¹å†…å®¹**:
1. âœ… æ·»åŠ éœ€æ±‚å·¥æ—¶è®¡ç®—é€»è¾‘
2. âœ… æ·»åŠ å½“å¤©æ€»å·¥æ—¶æŸ¥è¯¢é€»è¾‘
3. âœ… ä¿®æ­£è®¡åˆ’æ’ç¨‹æ•°é‡è®¡ç®—é€»è¾‘
4. âœ… åœ¨INSERTè¯­å¥ä¸­ä½¿ç”¨è®¡ç®—åçš„å€¼

---

## ğŸ¯ éªŒè¯æ­¥éª¤

ä¿®å¤åéœ€è¦æŒ‰ä»¥ä¸‹æ­¥éª¤éªŒè¯:

1. **åˆ é™¤æµ‹è¯•æ•°æ®**:
   ```sql
   DELETE FROM packing_process_plans WHERE plan_no = 'RPP2512197332';
   DELETE FROM material_preparation_plans WHERE plan_no = 'MPP2025658732657';
   ```

2. **é‡æ–°æ‰§è¡Œæ’ç¨‹**:
   - è®¿é—®ä¸»ç”Ÿäº§è®¡åˆ’é¡µé¢
   - ç‚¹å‡»"æ‰§è¡Œæ’ç¨‹"
   - æ£€æŸ¥ç”Ÿæˆçš„å¤‡æ–™è®¡åˆ’
   - æ£€æŸ¥ç”Ÿæˆçš„æ‰“åŒ…å·¥åºè®¡åˆ’

3. **éªŒè¯å­—æ®µ**:
   ```sql
   SELECT 
     main_plan_product_code, 
     main_plan_product_name,
     plan_start_date,
     order_promise_delivery_date,
     level0_demand,
     daily_total_hours,
     required_work_hours,
     schedule_quantity,
     scheduled_work_hours,
     standard_work_quota,
     replenishment_qty
   FROM packing_process_plans 
   WHERE sales_order_no = 'SO2025000001'
   ORDER BY id DESC LIMIT 1;
   ```

4. **é¢„æœŸç»“æœ**:
   - `main_plan_product_code` = '6001A0306'
   - `main_plan_product_name` = '6001A0306ï¼Œé“è´¨æ–¹å‘ç›˜æ¬¾ï¼Œå˜‰åš'
   - `plan_start_date` = '2026-01-06'
   - `order_promise_delivery_date` = '2026-01-09'
   - `level0_demand` = 163.0000
   - `daily_total_hours` = 16.00
   - `required_work_hours` = 27.17
   - `schedule_quantity` = 0.0000 (å› ä¸ºscheduled_work_hours=0)

---

## âœ… æ€»ç»“

**éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶**: 2ä¸ª
**éœ€è¦ä¿®æ”¹çš„ä»£ç è¡Œæ•°**: çº¦30è¡Œ
**é¢„è®¡ä¿®å¤æ—¶é—´**: 15åˆ†é’Ÿ

**ä¿®å¤ä¼˜å…ˆçº§**:
- ğŸ”´ é«˜: ä¸»è®¡åˆ’äº§å“ç¼–å·/åç§°ã€è®¡åˆ’å¼€å§‹æ—¥æœŸã€è®¢å•æ‰¿è¯ºäº¤æœŸ
- ğŸŸ¡ ä¸­: å½“å¤©æ€»å·¥æ—¶ã€éœ€æ±‚å·¥æ—¶
- ğŸŸ¢ ä½: 0é˜¶éœ€æ±‚æ•°é‡ã€è®¡åˆ’æ’ç¨‹æ•°é‡

éœ€è¦æˆ‘å¼€å§‹æ‰§è¡Œä¿®å¤å—ï¼Ÿ
