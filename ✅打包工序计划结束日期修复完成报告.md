# âœ… æ‰“åŒ…å·¥åºè®¡åˆ’ç»“æŸæ—¥æœŸä¿®å¤å®ŒæˆæŠ¥å‘Š

ç”Ÿæˆæ—¶é—´ï¼š2025-12-20  
çŠ¶æ€ï¼š**å·²ä¿®å¤å®Œæˆ** âœ…

---

## ğŸ“‹ é—®é¢˜æè¿°

### ç°è±¡
æ‰“åŒ…å·¥åºè®¡åˆ’æ•°æ®è¡Œä¸­ï¼š
- **è®¡åˆ’å®Œå·¥æ—¥æœŸ** = `2026-01-06` âœ…
- **è®¡åˆ’ç»“æŸæ—¥æœŸ** = `2026-01-07` âŒï¼ˆæœŸæœ›ä¹Ÿæ˜¯ `2026-01-06`ï¼‰

### é¢„æœŸè§„åˆ™
**å¤‡æ–™è®¡åˆ’æ¨é€ç”Ÿæˆçš„å·¥åºè®¡åˆ’æ•°æ®è¡Œ**ï¼š
```
è®¡åˆ’ç»“æŸæ—¥æœŸ = è®¡åˆ’å®Œå·¥æ—¥æœŸ
```

---

## ğŸ” é—®é¢˜æ ¹æºåˆ†æ

### æ•°æ®æµç¨‹

#### 1ï¸âƒ£ å¤‡æ–™è®¡åˆ’æ¨é€é˜¶æ®µï¼ˆâœ… æ­£ç¡®ï¼‰
**æ–‡ä»¶**ï¼š`backend/services/materialPreparationPlanService.js`

**ç¬¬693è¡Œ**ï¼š
```javascript
completionDate: materialPlanData.demandDate || materialPlanData.demand_date || null,
```
âœ… è®¡åˆ’å®Œå·¥æ—¥æœŸ = éœ€æ±‚æ—¥æœŸï¼ˆ`2026-01-06`ï¼‰

**ç¬¬701è¡Œ**ï¼š
```javascript
planEndDate: materialPlanData.demandDate || materialPlanData.demand_date || null,
```
âœ… è®¡åˆ’ç»“æŸæ—¥æœŸ = éœ€æ±‚æ—¥æœŸï¼ˆ`2026-01-06`ï¼‰

**æ¨é€æ—¶ä¸¤ä¸ªå­—æ®µéƒ½æ˜¯ `2026-01-06`** âœ…

---

#### 2ï¸âƒ£ æ‰“åŒ…å·¥åºcreateæ–¹æ³•ï¼ˆâŒ é—®é¢˜æ‰€åœ¨ï¼‰
**æ–‡ä»¶**ï¼š`backend/services/packingProcessPlanService.js`

**ä¿®å¤å‰çš„ç¬¬307-336è¡Œ**ï¼š
```javascript
// âœ… è®¡ç®—è®¡åˆ’ç»“æŸæ—¥æœŸ
// è§„åˆ™ï¼šåŸºäºéœ€è¡¥è´§æ•°é‡ã€å®šæ—¶å·¥é¢ã€è®¡åˆ’å¼€å§‹æ—¥æœŸã€å·¥åºèƒ½åŠ›è´Ÿè·è¡¨è®¡ç®—
let planEndDate = data.planEndDate || null;

if (replenishment > 0 && standardWorkQuota > 0) {
  // âŒ é—®é¢˜ï¼šæ— è®ºæ•°æ®æ¥æºï¼Œéƒ½ä¼šé‡æ–°è®¡ç®—planEndDate
  const calculatedEndDate = await PlanEndDateCalculator.calculate({
    replenishmentQty: replenishment,
    standardWorkQuota: standardWorkQuota,
    planStartDate: data.planStartDate,
    scheduleDate: data.scheduleDate,
    processName: data.processName
  });
  
  planEndDate = calculatedEndDate; // âŒ è¦†ç›–äº†æ¨é€ä¼ å…¥çš„å€¼
}
```

**é—®é¢˜**ï¼š
- `PlanEndDateCalculator.calculate()` è®¡ç®—å‡º `2026-01-07`
- **è¦†ç›–äº†**å¤‡æ–™è®¡åˆ’æ¨é€æ—¶ä¼ å…¥çš„ `2026-01-06`
- å¯¼è‡´ `planEndDate â‰  completionDate`

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹æ–‡ä»¶ï¼š`backend/services/packingProcessPlanService.js`

**ä¿®å¤ä½ç½®**ï¼šç¬¬307-336è¡Œ

**ä¿®å¤é€»è¾‘**ï¼š
```javascript
// âœ… æ–°å¢è§„åˆ™ï¼šæ ¹æ®æ•°æ®æ¥æºå†³å®šæ˜¯å¦è®¡ç®—
if (data.sourcePageName === 'å¤‡æ–™è®¡åˆ’' && data.completionDate) {
  // ğŸ“Œ å¤‡æ–™è®¡åˆ’æ¨é€çš„æ•°æ®ï¼šè®¡åˆ’ç»“æŸæ—¥æœŸ = è®¡åˆ’å®Œå·¥æ—¥æœŸ
  planEndDate = data.completionDate;
} else {
  // å…¶ä»–æ¥æºï¼šæ‰§è¡ŒåŸæœ‰è®¡ç®—é€»è¾‘
  if (replenishment > 0 && standardWorkQuota > 0) {
    const calculatedEndDate = await PlanEndDateCalculator.calculate(...);
    planEndDate = calculatedEndDate;
  }
}
```

### ä¿®å¤åçš„å®Œæ•´ä»£ç ï¼š

```javascript
// âœ… è®¡ç®—è®¡åˆ’ç»“æŸæ—¥æœŸ
// è§„åˆ™ï¼š
// 1. å¦‚æœæ˜¯å¤‡æ–™è®¡åˆ’æ¨é€çš„æ•°æ®ï¼ˆsourcePageName='å¤‡æ–™è®¡åˆ’'ï¼‰ï¼Œç›´æ¥ä½¿ç”¨ completionDate
// 2. å¦åˆ™ï¼ŒåŸºäºéœ€è¡¥è´§æ•°é‡ã€å®šæ—¶å·¥é¢ã€è®¡åˆ’å¼€å§‹æ—¥æœŸã€å·¥åºèƒ½åŠ›è´Ÿè·è¡¨è®¡ç®—
let planEndDate = data.planEndDate || null;

// ğŸ“Œ å…³é”®è§„åˆ™ï¼šå¤‡æ–™è®¡åˆ’æ¨é€çš„æ•°æ®ï¼Œè®¡åˆ’ç»“æŸæ—¥æœŸ = è®¡åˆ’å®Œå·¥æ—¥æœŸ
if (data.sourcePageName === 'å¤‡æ–™è®¡åˆ’' && data.completionDate) {
  planEndDate = data.completionDate;
  console.log(`âœ… [è®¡åˆ’ç»“æŸæ—¥æœŸ] æ¥æº=å¤‡æ–™è®¡åˆ’ï¼Œä½¿ç”¨è®¡åˆ’å®Œå·¥æ—¥æœŸ: ${planEndDate}`);
}
// å…¶ä»–æ¥æºï¼Œæ‰§è¡Œè®¡ç®—é€»è¾‘
else if (replenishment > 0 && standardWorkQuota > 0) {
  try {
    console.log(`ğŸ” [è®¡åˆ’ç»“æŸæ—¥æœŸè®¡ç®—] å¼€å§‹è®¡ç®—...`);
    const calculatedEndDate = await PlanEndDateCalculator.calculate({
      replenishmentQty: replenishment,
      standardWorkQuota: standardWorkQuota,
      planStartDate: data.planStartDate,
      scheduleDate: data.scheduleDate,
      processName: data.processName
    });
    
    if (calculatedEndDate) {
      planEndDate = calculatedEndDate;
      console.log(`âœ… [è®¡åˆ’ç»“æŸæ—¥æœŸè®¡ç®—] è®¡ç®—æˆåŠŸ: ${planEndDate.toISOString().split('T')[0]}`);
    } else {
      console.log(`âš ï¸ [è®¡åˆ’ç»“æŸæ—¥æœŸè®¡ç®—] è®¡ç®—å¤±è´¥ï¼Œä½¿ç”¨ä¼ å…¥å€¼æˆ–null`);
    }
  } catch (calcError) {
    console.error(`âŒ [è®¡åˆ’ç»“æŸæ—¥æœŸè®¡ç®—] è®¡ç®—å¼‚å¸¸:`, calcError);
  }
} else {
  console.log(`âš ï¸ [è®¡åˆ’ç»“æŸæ—¥æœŸè®¡ç®—] ä¸æ»¡è¶³è®¡ç®—æ¡ä»¶`);
}
```

---

## âœ… ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰
```
sourcePageName = 'å¤‡æ–™è®¡åˆ’'
completionDate = 2026-01-06
planEndDate    = 2026-01-07  âŒï¼ˆè¢«è®¡ç®—å™¨è¦†ç›–ï¼‰
```

### ä¿®å¤å
```
sourcePageName = 'å¤‡æ–™è®¡åˆ’'
completionDate = 2026-01-06
planEndDate    = 2026-01-06  âœ…ï¼ˆç›´æ¥ä½¿ç”¨completionDateï¼‰
```

---

## ğŸ¯ éªŒè¯æ­¥éª¤

### 1. åˆ é™¤æ—§æµ‹è¯•æ•°æ®
```sql
DELETE FROM packing_process_plans WHERE plan_no = 'RPP2512195495';
```

### 2. é‡æ–°æ‰§è¡Œä¸»ç”Ÿäº§è®¡åˆ’æ’ç¨‹
1. è®¿é—®ä¸»ç”Ÿäº§è®¡åˆ’é¡µé¢
2. ç‚¹å‡»"æ‰§è¡Œæ’ç¨‹"æŒ‰é’®
3. ç­‰å¾…å¤‡æ–™è®¡åˆ’è‡ªåŠ¨ç”Ÿæˆ
4. ç­‰å¾…æ‰“åŒ…å·¥åºè®¡åˆ’è‡ªåŠ¨æ¨é€

### 3. éªŒè¯æ•°æ®
```sql
SELECT 
  plan_no, 
  completion_date, 
  plan_end_date,
  source_page_name
FROM packing_process_plans 
WHERE source_page_name = 'å¤‡æ–™è®¡åˆ’'
ORDER BY created_at DESC 
LIMIT 5;
```

**é¢„æœŸç»“æœ**ï¼š
```
+---------------+-----------------+---------------+------------------+
| plan_no       | completion_date | plan_end_date | source_page_name |
+---------------+-----------------+---------------+------------------+
| RPP2512xxxxx  | 2026-01-06      | 2026-01-06    | å¤‡æ–™è®¡åˆ’         |
+---------------+-----------------+---------------+------------------+
```
âœ… `completion_date = plan_end_date`

### 4. å‰ç«¯é¡µé¢éªŒè¯
è®¿é—®æ‰“åŒ…å·¥åºè®¡åˆ’åˆ—è¡¨é¡µé¢ï¼š
```
http://localhost:3003/production-planning/packing-process-plan
```

æ£€æŸ¥åˆ—è¡¨ä¸­çš„æ•°æ®è¡Œï¼š
- **è®¡åˆ’å®Œå·¥æ—¥æœŸ** = `2026-01-06` âœ…
- **è®¡åˆ’ç»“æŸæ—¥æœŸ** = `2026-01-06` âœ…

---

## ğŸ“Š ä¿®å¤å½±å“èŒƒå›´

### âœ… å·²ä¿®å¤
- æ‰“åŒ…å·¥åºè®¡åˆ’ï¼ˆ`packingProcessPlanService.js`ï¼‰

### âš ï¸ å…¶ä»–å·¥åºè®¡åˆ’æ˜¯å¦éœ€è¦ä¿®å¤ï¼Ÿ

å»ºè®®æ£€æŸ¥ä»¥ä¸‹å·¥åºè®¡åˆ’æœåŠ¡æ˜¯å¦å­˜åœ¨ç›¸åŒé—®é¢˜ï¼š
1. `assemblyProcessPlanService.js`ï¼ˆç»„è£…å·¥åºï¼‰
2. `sewingProcessPlanService.js`ï¼ˆç¼çº«å·¥åºï¼‰
3. `sprayPaintingProcessPlanService.js`ï¼ˆå–·å¡‘å·¥åºï¼‰
4. `manualWeldingProcessPlanService.js`ï¼ˆæ‰‹å·¥ç„Šæ¥å·¥åºï¼‰
5. å…¶ä»–å·¥åºè®¡åˆ’æœåŠ¡...

**æ£€æŸ¥æ–¹æ³•**ï¼š
æœç´¢ `PlanEndDateCalculator.calculate` è°ƒç”¨ï¼Œç¡®è®¤æ˜¯å¦éœ€è¦æ·»åŠ ç›¸åŒçš„åˆ¤æ–­é€»è¾‘ï¼š
```javascript
if (data.sourcePageName === 'å¤‡æ–™è®¡åˆ’' && data.completionDate) {
  planEndDate = data.completionDate;
}
```

---

## ğŸ”„ åç»­ä¼˜åŒ–å»ºè®®

### 1. ç»Ÿä¸€è§„åˆ™
å»ºè®®åœ¨æ‰€æœ‰å·¥åºè®¡åˆ’æœåŠ¡ä¸­ç»Ÿä¸€è§„åˆ™ï¼š
- **å¤‡æ–™è®¡åˆ’æ¨é€**ï¼š`planEndDate = completionDate`
- **æ‰‹åŠ¨åˆ›å»º**ï¼š`planEndDate = PlanEndDateCalculator.calculate(...)`

### 2. ä»£ç å¤ç”¨
å¯ä»¥å°†æ­¤é€»è¾‘å°è£…ä¸ºå…¬å…±æ–¹æ³•ï¼š
```javascript
// utils/planEndDateHelper.js
static determinePlanEndDate(data, calculatedDate) {
  if (data.sourcePageName === 'å¤‡æ–™è®¡åˆ’' && data.completionDate) {
    return data.completionDate; // å¤‡æ–™è®¡åˆ’æ¨é€ï¼šä½¿ç”¨å®Œå·¥æ—¥æœŸ
  }
  return calculatedDate; // å…¶ä»–æ¥æºï¼šä½¿ç”¨è®¡ç®—å€¼
}
```

### 3. æ—¥å¿—ç›‘æ§
å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒæ·»åŠ æ—¥å¿—ç›‘æ§ï¼š
```javascript
console.log(`[è®¡åˆ’ç»“æŸæ—¥æœŸ] æ¥æº=${data.sourcePageName}, å®Œå·¥=${data.completionDate}, ç»“æŸ=${planEndDate}`);
```

---

## âœ… ä¿®å¤å®Œæˆæ€»ç»“

| ä¿®å¤é¡¹ | çŠ¶æ€ |
|--------|------|
| é—®é¢˜åˆ†æ | âœ… å·²å®Œæˆ |
| ä»£ç ä¿®æ”¹ | âœ… å·²å®Œæˆ |
| åç«¯é‡å¯ | âœ… å·²å®Œæˆ |
| æµ‹è¯•éªŒè¯ | â³ å¾…é‡æ–°æ’ç¨‹éªŒè¯ |
| å…¶ä»–å·¥åºæ£€æŸ¥ | âš ï¸ å»ºè®®ç»Ÿä¸€ä¿®å¤ |

---

## ğŸ¯ ä¸‹ä¸€æ­¥æ“ä½œ

1. **åˆ é™¤æ—§æµ‹è¯•æ•°æ®**
2. **é‡æ–°æ‰§è¡Œä¸»ç”Ÿäº§è®¡åˆ’æ’ç¨‹**
3. **éªŒè¯æ‰“åŒ…å·¥åºè®¡åˆ’çš„ä¸¤ä¸ªæ—¥æœŸæ˜¯å¦ç›¸ç­‰**
4. **å¦‚éœ€è¦ï¼Œç»Ÿä¸€ä¿®å¤å…¶ä»–å·¥åºè®¡åˆ’æœåŠ¡**

éœ€è¦æˆ‘å¸®ä½ æ‰¹é‡ä¿®å¤å…¶ä»–å·¥åºè®¡åˆ’æœåŠ¡å—ï¼Ÿ
