# å¤‡æ–™è®¡åˆ’åˆ°å·¥åºè®¡åˆ’æ­£ç¡®æ•°æ®è·¯ç”±ä¿®å¤æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜èƒŒæ™¯

ç”¨æˆ·æŠ¥å‘Šï¼šå¤‡æ–™è®¡åˆ’ä¸­"æ¥æºå·¥åº"=ç»„è£…çš„æ•°æ®è¢«æ¨é€åˆ°äº†ç»„è£…å·¥åºè®¡åˆ’ï¼Œè¿™æ˜¯ä¸€ä¸ª**ä¸¥é‡çš„ä¸šåŠ¡é€»è¾‘é”™è¯¯**ã€‚

## âš ï¸ æ ¹æœ¬åŸå› åˆ†æ

### CodeBuddyçš„é”™è¯¯æ–¹æ¡ˆ
åœ¨æ¢å¤å¤‡ä»½ä¹‹å‰ï¼ŒCodeBuddyæä¾›äº†ä¸€ä¸ªä¿®å¤æ–¹æ¡ˆï¼Œä½†**è¯¥æ–¹æ¡ˆå®Œå…¨è¿èƒŒäº†é¡¹ç›®è§„èŒƒ**ï¼š
- âŒ **é”™è¯¯åšæ³•**ï¼šä½¿ç”¨å¤‡æ–™è®¡åˆ’çš„`sourceProcess`ï¼ˆæ¥æºå·¥åºï¼‰å­—æ®µè¿›è¡Œæ•°æ®è·¯ç”±
- âŒ **é”™è¯¯é€»è¾‘**ï¼š`sourceProcess='ç»„è£…'` â†’ æ¨é€åˆ°`assembly_process_plans`è¡¨

### é¡¹ç›®è§„èŒƒè¦æ±‚ï¼ˆè®°å¿†è§„èŒƒï¼‰
æ ¹æ®é¡¹ç›®è®°å¿†è§„èŒƒæ˜ç¡®æŒ‡å‡ºï¼š
> **å¤‡æ–™è®¡åˆ’æ¨é€è§„åˆ™åŸºäºäº§å‡ºå·¥åºè€Œéæ¥æºå·¥åº**
> å¤‡æ–™è®¡åˆ’å‘å·¥åºè®¡åˆ’çš„æ•°æ®æ¨é€å¿…é¡»åŸºäºäº§å“ç‰©æ–™åº“çš„"äº§å‡ºå·¥åº"(process_name)å­—æ®µï¼Œè€Œéå¤‡æ–™è®¡åˆ’çš„"æ¥æºå·¥åº"(source_process)å­—æ®µã€‚

**æ­£ç¡®çš„æ¨é€è§„åˆ™**ï¼š
- âœ… äº§å‡ºå·¥åº='æ‰“åŒ…' â†’ æ¨é€è‡³æ‰“åŒ…å·¥åºè®¡åˆ’(packing_process_plans)
- âœ… äº§å‡ºå·¥åº='ç»„è£…' â†’ æ¨é€è‡³ç»„è£…å·¥åºè®¡åˆ’(assembly_process_plans)
- âš ï¸ å…¶ä»–å·¥åº â†’ ä¸æ¨é€
- ğŸš« **ä¸¥ç¦æ¨é€åˆ°çœŸå·¥åºè®¡åˆ’è¡¨**(real_process_plans)

### ä¸šåŠ¡é€»è¾‘è¯´æ˜
- **æ¥æºå·¥åº**(`sourceProcess`)ï¼šè¡¨ç¤ºå¤‡æ–™è®¡åˆ’æ•°æ®ä»å“ªä¸ªå·¥åºæ¥çš„ï¼ˆç”¨äºè¿½æº¯ï¼‰
- **äº§å‡ºå·¥åº**(`process_name`)ï¼šè¡¨ç¤ºè¯¥ç‰©æ–™çš„ç”Ÿäº§å·¥åºæ˜¯ä»€ä¹ˆï¼ˆç”¨äºè·¯ç”±ï¼‰

**ä¸¾ä¾‹**ï¼š
- ç‰©æ–™6001A0306çš„`process_name`=æ‰“åŒ…
- å³ä½¿å¤‡æ–™è®¡åˆ’ä¸­`sourceProcess`=ç»„è£…
- **ä¹Ÿåº”è¯¥æ¨é€åˆ°æ‰“åŒ…å·¥åºè®¡åˆ’**ï¼Œå› ä¸ºè¿™ä¸ªç‰©æ–™æ˜¯åœ¨æ‰“åŒ…å·¥åºç”Ÿäº§çš„

## ğŸ”§ æ­£ç¡®çš„ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤æ–‡ä»¶
`backend/services/materialPreparationPlanService.js` - `pushToRealProcessPlan`æ–¹æ³•

### æ ¸å¿ƒä¿®æ”¹ï¼ˆå…±79è¡Œä»£ç ä¿®æ”¹ï¼‰

#### 1. æŸ¥è¯¢äº§å‡ºå·¥åºï¼ˆç¬¬893-951è¡Œï¼‰
```javascript
// âš ï¸ æ³¨æ„ï¼šåº”è¯¥æ ¹æ®äº§å“ç‰©æ–™åº“çš„"äº§å‡ºå·¥åº"(process_name)æ¨é€ï¼Œè€Œéå¤‡æ–™è®¡åˆ’çš„"æ¥æºå·¥åº"(source_process)
// ä»äº§å“ç‰©æ–™åº“æŸ¥è¯¢å®šæ—¶å·¥é¢ã€å®šé¢å·¥æ—¶å’Œäº§å‡ºå·¥åº
let standardWorkQuota = 0;
let standardWorkHours = 0;
let outputProcess = null;  // âœ… æ–°å¢ï¼šäº§å‡ºå·¥åºå­—æ®µ

if (data.materialCode) {
  try {
    const [materialRows] = await connection.execute(
      'SELECT material_code, standard_time, quota_time, process_name FROM materials WHERE material_code = ? LIMIT 1',
      [data.materialCode]
    );
    
    if (materialRows.length > 0) {
      const material = materialRows[0];
      standardWorkQuota = parseFloat(material.standard_time || 0);
      standardWorkHours = parseFloat(material.quota_time || 0);
      outputProcess = material.process_name;  // âœ… äº§å‡ºå·¥åº
      console.log(`âœ… æŸ¥è¯¢åˆ°ç‰©æ–™æ•°æ®: å®šæ—¶å·¥é¢=${standardWorkQuota}, å®šé¢å·¥æ—¶=${standardWorkHours}, äº§å‡ºå·¥åº=${outputProcess}`);
    }
  } catch (queryError) {
    console.error(`âŒ æŸ¥è¯¢ç‰©æ–™æ•°æ®å¤±è´¥:`, queryError.message);
  }
}

// âœ… æ£€æŸ¥äº§å‡ºå·¥åºæ˜¯å¦ä¸ºç©º
if (!outputProcess) {
  console.warn(`âš ï¸ äº§å‡ºå·¥åºä¸ºç©ºï¼Œæ— æ³•æ¨é€: ç‰©æ–™ç¼–å·=${data.materialCode}`);
  return { success: false, reason: 'no_output_process', materialCode: data.materialCode };
}

// âœ… æ£€æŸ¥äº§å‡ºå·¥åºæ˜¯å¦æ”¯æŒï¼ˆä»…æ”¯æŒæ‰“åŒ…å’Œç»„è£…ï¼‰
if (outputProcess !== 'æ‰“åŒ…' && outputProcess !== 'ç»„è£…') {
  console.log(`â­ï¸ äº§å‡ºå·¥åº=${outputProcess}ï¼Œä¸åœ¨æ¨é€èŒƒå›´å†…ï¼ˆä»…æ”¯æŒæ‰“åŒ…/ç»„è£…ï¼‰ï¼Œè·³è¿‡æ¨é€`);
  return { success: false, reason: 'unsupported_output_process', outputProcess };
}
```

#### 2. é˜²é‡å¤æ£€æŸ¥ä½¿ç”¨outputProcessï¼ˆç¬¬932-951è¡Œï¼‰
```javascript
// âœ… é˜²é‡å¤æ¨é€æ£€æŸ¥ï¼ˆå¿…é¡»åœ¨è·å–outputProcessä¹‹åï¼Œä½¿ç”¨äº§å‡ºå·¥åºæ¥ç¡®å®šæ£€æŸ¥è¡¨ï¼‰
let checkTable;
if (outputProcess === 'æ‰“åŒ…') {
  checkTable = 'packing_process_plans';
} else if (outputProcess === 'ç»„è£…') {
  checkTable = 'assembly_process_plans';
}

// æ‰§è¡Œé˜²é‡æ£€æŸ¥
const [existingPlans] = await connection.execute(`
  SELECT id, plan_no FROM ${checkTable}
  WHERE source_no = ? AND product_code = ?
  LIMIT 1
`, [data.planNo, data.materialCode]);

if (existingPlans.length > 0) {
  console.log(`â­ï¸ [é˜²é‡æ£€æŸ¥] æ£€æµ‹åˆ°é‡å¤æ¨é€ï¼Œè·³è¿‡: å¤‡æ–™è®¡åˆ’=${data.planNo} â†’ å·¥åºè®¡åˆ’=${existingPlans[0].plan_no}`);
  console.log(`   äº§å‡ºå·¥åº=${outputProcess}, ç›®æ ‡è¡¨=${checkTable}`);
  console.log(`   å¤‡æ–™è®¡åˆ’æ¥æºå·¥åº=${data.sourceProcess} (ä»…ä½œè®°å½•)`);
  return { success: false, reason: 'duplicate', planNo: existingPlans[0].plan_no, table: checkTable, outputProcess };
}
```

#### 3. æ‰€æœ‰æŸ¥è¯¢å·¥åºèƒ½åŠ›è´Ÿè·è¡¨çš„åœ°æ–¹ä½¿ç”¨outputProcessï¼ˆå…±5å¤„ï¼‰
- æŸ¥è¯¢è®¡åˆ’ç»“æŸæ—¥æœŸï¼š`WHERE process_name = ?` ä½¿ç”¨`outputProcess`
- æŸ¥è¯¢è®¡åˆ’å¼€å§‹æ—¥æœŸï¼š`WHERE process_name = ?` ä½¿ç”¨`outputProcess`  
- æŸ¥è¯¢å½“å¤©æ€»å·¥æ—¶ï¼š`WHERE process_name = ?` ä½¿ç”¨`outputProcess`
- æŸ¥è¯¢å½“å¤©å·²æ’ç¨‹å·¥æ—¶ï¼š`WHERE process_name = ?` ä½¿ç”¨`outputProcess`

#### 4. ç¡®å®šç›®æ ‡è¡¨ä½¿ç”¨outputProcessï¼ˆç¬¬1073-1083è¡Œï¼‰
```javascript
// âœ… æå‰ç¡®å®šç›®æ ‡è¡¨åï¼ˆæ ¹æ®äº§å‡ºå·¥åºè·¯ç”±ï¼‰
let targetTable;
if (outputProcess === 'æ‰“åŒ…') {
  targetTable = 'packing_process_plans';
} else if (outputProcess === 'ç»„è£…') {
  targetTable = 'assembly_process_plans';
} else {
  console.warn(`âš ï¸ [æŸ¥è¯¢å·²æ’ç¨‹å·¥æ—¶] ä¸æ”¯æŒçš„å·¥åºç±»å‹: ${outputProcess}ï¼Œå·²è·³è¿‡æ¨é€`);
  return { success: false, reason: 'unsupported_process', processName: outputProcess };
}
```

#### 5. realProcessPlanDataä½¿ç”¨outputProcessï¼ˆç¬¬1138è¡Œï¼‰
```javascript
processName: outputProcess,  // âœ… ä½¿ç”¨äº§å‡ºå·¥åºï¼Œè€ŒésourceProcess
```

#### 6. Serviceè·¯ç”±é€»è¾‘ä½¿ç”¨outputProcessï¼ˆç¬¬1163-1184è¡Œï¼‰
```javascript
// âœ… æ ¹æ®äº§å‡ºå·¥åºè·¯ç”±åˆ°ä¸åŒçš„Service
let ProcessPlanService;
let planNoPrefix;
let serviceName;

if (outputProcess === 'æ‰“åŒ…') {  // âœ… ä½¿ç”¨outputProcess
  ProcessPlanService = require('./packingProcessPlanService');
  planNoPrefix = 'PKPP';
  serviceName = 'æ‰“åŒ…å·¥åºè®¡åˆ’';
} else if (outputProcess === 'ç»„è£…') {  // âœ… ä½¿ç”¨outputProcess
  ProcessPlanService = require('./assemblyProcessPlanService');
  planNoPrefix = 'ASPP';
  serviceName = 'ç»„è£…å·¥åºè®¡åˆ’';
} else {
  console.warn(`âš ï¸ [æ•°æ®è·¯ç”±] ä¸æ”¯æŒçš„å·¥åºç±»å‹: ${outputProcess}ï¼Œå·²è·³è¿‡æ¨é€`);
  return { success: false, reason: 'unsupported_process', processName: outputProcess };
}

console.log(`ğŸ“ [æ•°æ®è·¯ç”±] äº§å‡ºå·¥åº=${outputProcess} â†’ æ¨é€åˆ°${serviceName} (è¡¨: ${targetTable})`);
console.log(`   å¤‡æ–™è®¡åˆ’çš„æ¥æºå·¥åº=${data.sourceProcess} (ä»…ä½œè®°å½•ï¼Œä¸ç”¨äºè·¯ç”±)`);
console.log(`   ç‰©æ–™ç¼–å·=${data.materialCode}, ç‰©æ–™åç§°=${data.materialName}`);
```

#### 7. è¿”å›å€¼æ·»åŠ outputProcessï¼ˆç¬¬1208è¡Œï¼‰
```javascript
return { success: true, planNo: realProcessPlanNo, id: createdPlanId, targetTable, serviceName, outputProcess };
```

## ğŸ“Š ä¿®æ”¹ç»Ÿè®¡

- **ä¿®æ”¹æ–‡ä»¶**ï¼š1ä¸ªæ–‡ä»¶
- **ä¿®æ”¹è¡Œæ•°**ï¼š70è¡Œæ–°å¢ï¼Œ52è¡Œåˆ é™¤
- **æ ¸å¿ƒä¿®æ”¹ç‚¹**ï¼š8å¤„
- **æ–°å¢å­—æ®µæŸ¥è¯¢**ï¼š1ä¸ªï¼ˆ`process_name`ï¼‰
- **æ–°å¢éªŒè¯é€»è¾‘**ï¼š2ä¸ªï¼ˆç©ºå€¼æ£€æŸ¥ã€æ”¯æŒæ€§æ£€æŸ¥ï¼‰
- **è·¯ç”±é€»è¾‘ä¿®æ”¹**ï¼šæ‰€æœ‰`data.sourceProcess`æ”¹ä¸º`outputProcess`ï¼ˆå…±çº¦15å¤„ï¼‰

## âœ… éªŒè¯è¦ç‚¹

### æ­£ç¡®çš„æ•°æ®æµå‘

**æµ‹è¯•åœºæ™¯1**ï¼šå¤‡æ–™è®¡åˆ’`sourceProcess`=ç»„è£…ï¼Œç‰©æ–™`process_name`=æ‰“åŒ…
- âœ… **é¢„æœŸç»“æœ**ï¼šæ¨é€åˆ°`packing_process_plans`ï¼ˆæ‰“åŒ…å·¥åºè®¡åˆ’è¡¨ï¼‰
- âœ… **é˜²é‡æ£€æŸ¥**ï¼šåœ¨`packing_process_plans`è¡¨ä¸­æ£€æŸ¥
- âœ… **processNameå­—æ®µ**ï¼šå†™å…¥"æ‰“åŒ…"

**æµ‹è¯•åœºæ™¯2**ï¼šå¤‡æ–™è®¡åˆ’`sourceProcess`=æ‰“åŒ…ï¼Œç‰©æ–™`process_name`=ç»„è£…  
- âœ… **é¢„æœŸç»“æœ**ï¼šæ¨é€åˆ°`assembly_process_plans`ï¼ˆç»„è£…å·¥åºè®¡åˆ’è¡¨ï¼‰
- âœ… **é˜²é‡æ£€æŸ¥**ï¼šåœ¨`assembly_process_plans`è¡¨ä¸­æ£€æŸ¥
- âœ… **processNameå­—æ®µ**ï¼šå†™å…¥"ç»„è£…"

**æµ‹è¯•åœºæ™¯3**ï¼šå¤‡æ–™è®¡åˆ’`sourceProcess`=ç»„è£…ï¼Œç‰©æ–™`process_name`=ç»„è£…
- âœ… **é¢„æœŸç»“æœ**ï¼šæ¨é€åˆ°`assembly_process_plans`ï¼ˆç»„è£…å·¥åºè®¡åˆ’è¡¨ï¼‰
- âœ… **é˜²é‡æ£€æŸ¥**ï¼šåœ¨`assembly_process_plans`è¡¨ä¸­æ£€æŸ¥
- âœ… **processNameå­—æ®µ**ï¼šå†™å…¥"ç»„è£…"

### å…³é”®æ—¥å¿—è¾“å‡ºç¤ºä¾‹

```javascript
// æŸ¥è¯¢ç‰©æ–™æ•°æ®æ—¶
âœ… æŸ¥è¯¢åˆ°ç‰©æ–™æ•°æ®: å®šæ—¶å·¥é¢=X, å®šé¢å·¥æ—¶=Y, äº§å‡ºå·¥åº=æ‰“åŒ…

// é˜²é‡æ£€æŸ¥æ—¶
â­ï¸ [é˜²é‡æ£€æŸ¥] æ£€æµ‹åˆ°é‡å¤æ¨é€ï¼Œè·³è¿‡: å¤‡æ–™è®¡åˆ’=MPXX â†’ å·¥åºè®¡åˆ’=PKPPXX
   äº§å‡ºå·¥åº=æ‰“åŒ…, ç›®æ ‡è¡¨=packing_process_plans
   å¤‡æ–™è®¡åˆ’æ¥æºå·¥åº=ç»„è£… (ä»…ä½œè®°å½•)

// æ•°æ®è·¯ç”±æ—¶
ğŸ“ [æ•°æ®è·¯ç”±] äº§å‡ºå·¥åº=æ‰“åŒ… â†’ æ¨é€åˆ°æ‰“åŒ…å·¥åºè®¡åˆ’ (è¡¨: packing_process_plans)
   å¤‡æ–™è®¡åˆ’çš„æ¥æºå·¥åº=ç»„è£… (ä»…ä½œè®°å½•ï¼Œä¸ç”¨äºè·¯ç”±)
   ç‰©æ–™ç¼–å·=6001A0306, ç‰©æ–™åç§°=XXX
```

## ğŸ¯ CodeBuddyé”™è¯¯æ–¹æ¡ˆå¯¹æ¯”

| å¯¹æ¯”é¡¹ | CodeBuddyæ–¹æ¡ˆï¼ˆé”™è¯¯âŒï¼‰ | æ­£ç¡®æ–¹æ¡ˆï¼ˆæœ¬æ¬¡ä¿®å¤âœ…ï¼‰ |
|--------|------------------------|------------------------|
| **è·¯ç”±ä¾æ®** | `data.sourceProcess`ï¼ˆæ¥æºå·¥åºï¼‰ | `outputProcess`ï¼ˆäº§å‡ºå·¥åºï¼‰ |
| **æ•°æ®æ¥æº** | å¤‡æ–™è®¡åˆ’è¡¨å­—æ®µ | äº§å“ç‰©æ–™åº“`process_name`å­—æ®µ |
| **ä¸šåŠ¡é€»è¾‘** | æ ¹æ®æ•°æ®æ¥æºè·¯ç”± | æ ¹æ®ç‰©æ–™ç”Ÿäº§å·¥åºè·¯ç”± |
| **ç¬¦åˆè§„èŒƒ** | âŒ è¿èƒŒé¡¹ç›®è§„èŒƒ | âœ… ç¬¦åˆé¡¹ç›®è§„èŒƒ |
| **æ¨é€å‡†ç¡®æ€§** | âŒ ä¼šæ¨é€åˆ°é”™è¯¯çš„è¡¨ | âœ… æ¨é€åˆ°æ­£ç¡®çš„è¡¨ |

### CodeBuddyé”™è¯¯çš„åŸå› 
1. **æœªæŸ¥é˜…é¡¹ç›®è§„èŒƒ**ï¼šæ²¡æœ‰æ£€æŸ¥è®°å¿†ä¸­çš„æ¨é€è§„åˆ™
2. **å­—é¢ç†è§£é”™è¯¯**ï¼šçœ‹åˆ°"æ¥æºå·¥åº"=ç»„è£…å°±æ¨é€åˆ°ç»„è£…å·¥åºè®¡åˆ’
3. **å¿½ç•¥ä¸šåŠ¡é€»è¾‘**ï¼šæ²¡æœ‰ç†è§£"äº§å‡ºå·¥åº"æ‰æ˜¯å†³å®šæ¨é€ç›®æ ‡çš„å…³é”®å­—æ®µ

## ğŸ‰ ä¿®å¤å®Œæˆ

### âœ… å·²å®Œæˆ
1. æŸ¥è¯¢äº§å“ç‰©æ–™åº“`process_name`å­—æ®µè·å–äº§å‡ºå·¥åº
2. æ·»åŠ äº§å‡ºå·¥åºç©ºå€¼æ£€æŸ¥å’Œæ”¯æŒæ€§æ£€æŸ¥
3. å°†æ‰€æœ‰è·¯ç”±é€»è¾‘ä»`data.sourceProcess`æ”¹ä¸º`outputProcess`
4. æ›´æ–°é˜²é‡å¤æ£€æŸ¥é€»è¾‘ä½¿ç”¨`outputProcess`
5. å¢å¼ºæ—¥å¿—è¾“å‡ºï¼Œæ˜ç¡®åŒºåˆ†"äº§å‡ºå·¥åº"å’Œ"æ¥æºå·¥åº"
6. è¿”å›å€¼æ·»åŠ `outputProcess`ä¾¿äºè¿½è¸ª

### âœ… è´¨é‡ä¿è¯
- ä»£ç ç¬¦åˆé¡¹ç›®è§„èŒƒè¦æ±‚
- å®Œå…¨ç§»é™¤äº†å¯¹`data.sourceProcess`çš„è·¯ç”±ä¾èµ–
- é˜²é‡å¤æ£€æŸ¥ä¸å®é™…æ¨é€è¡¨ä¸€è‡´
- è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºä¾¿äºè°ƒè¯•

### ğŸ“ åç»­å»ºè®®
1. **æ¸…ç†æµ‹è¯•æ•°æ®**ï¼šåˆ é™¤ä¹‹å‰æ¨é€é”™è¯¯çš„å·¥åºè®¡åˆ’æ•°æ®
2. **æ‰§è¡Œæµ‹è¯•**ï¼šè§¦å‘ä¸»ç”Ÿäº§è®¡åˆ’æ’ç¨‹ï¼ŒéªŒè¯å¤‡æ–™è®¡åˆ’æ¨é€æ˜¯å¦æ­£ç¡®
3. **æ—¥å¿—ç›‘æ§**ï¼šè§‚å¯Ÿæ—¥å¿—è¾“å‡ºï¼Œç¡®è®¤äº§å‡ºå·¥åºå’Œæ¨é€ç›®æ ‡æ­£ç¡®
4. **æ•°æ®éªŒè¯**ï¼šæ£€æŸ¥æ•°æ®åº“ä¸­å·¥åºè®¡åˆ’è¡¨çš„`process_name`å­—æ®µæ˜¯å¦ä¸ç‰©æ–™åº“çš„`process_name`ä¸€è‡´

---

**ä¿®å¤å®Œæˆæ—¶é—´**ï¼š2025å¹´12æœˆ15æ—¥  
**ä¿®å¤æ–‡ä»¶**ï¼š`backend/services/materialPreparationPlanService.js`  
**æµ‹è¯•çŠ¶æ€**ï¼šâ³ å¾…ç”¨æˆ·æµ‹è¯•  
**éƒ¨ç½²çŠ¶æ€**ï¼šâœ… ä»£ç å·²ä¿®å¤ï¼Œå¾…éªŒè¯
