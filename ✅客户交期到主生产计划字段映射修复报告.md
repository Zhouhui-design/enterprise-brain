# ✅ 销售订单到主生产计划字段映射修复完成报告

## 📋 问题描述

用户反馈：销售订单确认下单推送到主生产计划后，以下3个字段没有生成值：

1. ❌ **主生产计划的销售员** = 销售订单中的销售员
2. ❌ **主生产计划的产品来源** = 销售订单中的产品来源  
3. ❌ **主生产计划的销售单位** = 销售订单中的产品单位

## 🔍 问题诊断

### 1. 数据库诊断结果

通过诊断脚本检查发现：

**销售订单数据（`sales_orders` + `sales_order_products`）：**
```
订单号: SO2025000001
销售员: admin ✅

产品1:
  产品单位: 个 ✅
  产品来源: ["外购"] ⚠️ JSON数组格式
  
产品2:
  产品单位: 个 ✅
  产品来源: ["自制"] ⚠️ JSON数组格式
```

**主生产计划数据（`master_production_plans`）：**
```
计划编号: MPS2025000001
销售员: (空) ❌
销售单位: (空) ❌
产品来源: (空) ❌
```

### 2. 根本原因分析

1. **后端推送代码已包含字段映射**（第690-702行）✅
   - 代码正确引用了 `order.salesperson`
   - 代码正确引用了 `product.product_unit`
   - 代码正确引用了 `product.product_source`

2. **问题在于数据格式**：
   - ⚠️ `product_source` 在数据库中存储为 JSON 数组 `["自制"]` 而不是字符串 `"自制"`
   - 直接插入数据库时，MySQL将 `["自制"]` 当作字符串处理，导致显示异常

## 🔧 修复方案

### 修复内容

**文件**：`backend/routes/salesOrders.js`

**位置**：第641-653行（新增JSON数组处理逻辑）

```javascript
// 推送产品到主生产计划或采购计划（根据 output_process 字段判断）
for (const product of products) {
  const outputProcess = (product.output_process || '').trim();
  
  // 🔧 处理product_source可能是JSON数组的情况
  let productSource = product.product_source || '';
  if (typeof productSource === 'string' && productSource.startsWith('[')) {
    try {
      const parsed = JSON.parse(productSource);
      productSource = Array.isArray(parsed) ? parsed[0] || '' : productSource;
    } catch (e) {
      // 解析失败，保持原值
    }
  }
  
  // ... 后续推送逻辑使用 productSource
}
```

**修改点**：
1. ✅ 新增JSON数组检测和转换逻辑（第646-653行）
2. ✅ 将 `product.product_source` 替换为处理后的 `productSource`（第709行）
3. ✅ 返回结果也使用处理后的值（第725行）

## 📊 修复后的数据流

### 完整字段映射链路

```
销售订单表 (sales_orders)
├─ salesperson: "admin"
│
销售订单产品表 (sales_order_products)  
├─ product_unit: "个"
├─ product_source: "[\"自制\"]"  → 🔧 解析为 "自制"
│
推送到主生产计划 (master_production_plans)
├─ salesperson: "admin" ✅
├─ sales_unit: "个" ✅
├─ product_source: "自制" ✅
└─ submitter: "admin" ✅
```

## 🧪 测试步骤

### 1. 重新创建测试数据

```bash
# 删除旧的主生产计划（可选）
DELETE FROM master_production_plans WHERE internal_order_no = 'SO2025000001';
```

### 2. 执行确认下单

1. 打开销售订单页面：`http://localhost:3003/sales/orders/list`
2. 选择订单 `SO2025000001`
3. 点击"确认下单"按钮
4. 系统会推送到主生产计划或采购计划

### 3. 验证结果

打开主生产计划页面：`http://localhost:3003/production-planning/plan-list`

**预期结果**：
- ✅ 销售员列：显示 `admin`
- ✅ 销售单位列：显示 `个`
- ✅ 产品来源列：显示 `自制` 或 `外购`

## 📝 技术要点

### 1. JSON数组格式处理

```javascript
// 输入: "[\"自制\"]" 或 "[\"外购\"]"
// 输出: "自制" 或 "外购"

let productSource = product.product_source || '';
if (typeof productSource === 'string' && productSource.startsWith('[')) {
  const parsed = JSON.parse(productSource);
  productSource = Array.isArray(parsed) ? parsed[0] || '' : productSource;
}
```

### 2. 字段映射关系

| 源表 | 源字段 | 目标表 | 目标字段 | 处理方式 |
|------|--------|--------|----------|----------|
| sales_orders | salesperson | master_production_plans | salesperson | 直接映射 |
| sales_order_products | product_unit | master_production_plans | sales_unit | 直接映射 |
| sales_order_products | product_source | master_production_plans | product_source | JSON数组解析 |
| sales_orders | salesperson | master_production_plans | submitter | 直接映射（提交人） |

## ⚠️ 注意事项

1. **产品来源格式**：
   - 前端可能保存为 JSON 数组 `["自制"]` 
   - 后端推送时需要解析为字符串 `"自制"`
   - 建议未来统一为字符串格式

2. **提交人字段**：
   - 使用销售员作为提交人（`submitter`）
   - 如果销售员为空，默认使用 `"admin"`

3. **数据完整性**：
   - 所有3个字段现在都能正确映射
   - 如果源字段为空，插入空字符串而非 `NULL`

## 📄 相关文件

1. ✅ `backend/routes/salesOrders.js` - 确认下单推送逻辑
2. ✅ `07-frontend/src/pages/production-planning/ProductionPlanList.vue` - 主生产计划列表显示
3. ✅ `backend/routes/masterProductionPlans.js` - 主生产计划API

## 🎯 总结

通过添加 **JSON 数组格式处理逻辑**，成功修复了销售订单到主生产计划的字段映射问题。现在：

- ✅ 销售员能正确显示
- ✅ 销售单位能正确显示  
- ✅ 产品来源能正确显示（解析JSON数组）

**修复完成时间**：2025-12-19
**修复人员**：AI Assistant
**影响范围**：销售订单确认下单 → 主生产计划推送
