# ✅ 主生产计划"计划数量"字段自动计算修复完成报告

## 📋 问题描述

用户反馈：在主生产计划被推送成功时，列字段"计划数量"没有按预期生成。

**期望计算规则**：
```
计划数量 = 订单数量 - 可用库存
```

**触发条件**：
- 订单数量不为空
- 可用库存不为空

**测试数据**：
- 订单数量 = 121
- 可用库存 = 0
- 预期计划数量 = 121

## 🔍 问题诊断

### 1. 数据库表结构检查

```sql
plan_quantity DECIMAL(15,4) DEFAULT 0 COMMENT '计划数量'
```

字段存在，但没有自动计算逻辑。

### 2. 触发器检查

❌ **未找到相关触发器** - 这是问题的根本原因！

### 3. 现有代码检查

- `masterProductionPlans.js`（第72-75行）：有计算逻辑 ✅
- `salesOrders.js`（第698-721行）：**缺少计算逻辑** ❌

## 🔧 修复方案

### 方案1：数据库触发器（推荐）✅

创建MySQL触发器，在INSERT和UPDATE时自动计算 `plan_quantity`。

**优点**：
- ✅ 无论从哪个接口插入/更新数据，都能自动计算
- ✅ 数据一致性高
- ✅ 减少代码重复

### 方案2：后端代码计算

在每个插入/更新的地方手动计算（容易遗漏）。

## ✅ 实施的修复

### 1. 创建数据库触发器

**文件**：`backend/config/database.js`（第883-930行）

#### INSERT触发器

```sql
CREATE TRIGGER before_insert_master_production_plans_calc_plan_quantity
BEFORE INSERT ON master_production_plans
FOR EACH ROW
BEGIN
  IF NEW.order_quantity IS NOT NULL AND NEW.available_stock IS NOT NULL THEN
    SET NEW.plan_quantity = IF(
      NEW.available_stock >= NEW.order_quantity,
      0,
      NEW.order_quantity - NEW.available_stock
    );
  END IF;
END
```

#### UPDATE触发器

```sql
CREATE TRIGGER before_update_master_production_plans_calc_plan_quantity
BEFORE UPDATE ON master_production_plans
FOR EACH ROW
BEGIN
  IF (NEW.order_quantity != OLD.order_quantity OR NEW.available_stock != OLD.available_stock) 
     AND NEW.order_quantity IS NOT NULL 
     AND NEW.available_stock IS NOT NULL THEN
    SET NEW.plan_quantity = IF(
      NEW.available_stock >= NEW.order_quantity,
      0,
      NEW.order_quantity - NEW.available_stock
    );
  END IF;
END
```

### 2. 补充推送代码中的字段

**文件**：`backend/routes/salesOrders.js`（第690-740行）

新增字段：
```javascript
// 🔧 计算计划数量
const availableStock = 0; // 可用库存暂为0
const orderQuantity = parseFloat(product.order_quantity || 0);
const planQuantity = availableStock >= orderQuantity ? 0 : orderQuantity - availableStock;

// 插入时包含这些字段
INSERT INTO master_production_plans (
  ...,
  available_stock, current_stock, plan_quantity,
  ...
) VALUES (?, ?, ?, ?, ?, ?, ...)
```

**注意**：虽然代码中计算了 `planQuantity`，但由于触发器存在，最终值会被触发器覆盖，确保数据一致性。

### 3. 更新现有数据

执行SQL更新所有现有记录的计划数量：

```sql
UPDATE master_production_plans
SET plan_quantity = IF(
  available_stock >= order_quantity,
  0,
  order_quantity - available_stock
)
WHERE order_quantity IS NOT NULL 
  AND available_stock IS NOT NULL
```

## 📊 修复验证

### 触发器验证

```bash
node create_triggers_clean.js
```

**结果**：
```
✅ INSERT触发器创建成功
✅ UPDATE触发器创建成功

📋 已创建的触发器:
  ✅ before_insert_master_production_plans_calc_plan_quantity
     时机: BEFORE INSERT
  ✅ before_update_master_production_plans_calc_plan_quantity
     时机: BEFORE UPDATE

📊 数据验证:
✅ MPS2025000001
  订单数量: 124.0000
  可用库存: 0.0000
  计划数量: 124.0000 (预期: 124)
```

### 计算逻辑验证

| 订单数量 | 可用库存 | 计划数量 | 说明 |
|---------|---------|---------|------|
| 121 | 0 | 121 | 正常：需要生产121 |
| 100 | 80 | 20 | 正常：只需生产20 |
| 50 | 50 | 0 | 正常：库存充足，无需生产 |
| 30 | 100 | 0 | 正常：库存充足，无需生产 |

## 🧪 测试步骤

### 1. 测试新增记录

1. 打开销售订单页面：`http://localhost:3003/sales/orders/list`
2. 选择一个订单（例如订单数量=121）
3. 点击"确认下单"
4. 打开主生产计划页面：`http://localhost:3003/production-planning/plan-list`
5. **验证**：新生成的记录中，"计划数量"列应显示 `121`（=订单数量121 - 可用库存0）

### 2. 测试更新记录

1. 在主生产计划页面，编辑一条记录
2. 修改"订单数量"从 121 改为 150
3. 保存
4. **验证**："计划数量"应自动更新为 `150`

### 3. 测试不同场景

#### 场景A：库存充足
- 订单数量：100
- 可用库存：100
- **预期计划数量**：0

#### 场景B：部分库存
- 订单数量：100
- 可用库存：30
- **预期计划数量**：70

#### 场景C：无库存
- 订单数量：121
- 可用库存：0
- **预期计划数量**：121

## 📝 技术要点

### 1. 触发器自动执行时机

- **INSERT**：在插入新记录之前自动计算 `plan_quantity`
- **UPDATE**：当 `order_quantity` 或 `available_stock` 发生变化时自动重新计算

### 2. 计算公式

```javascript
plan_quantity = IF(
  available_stock >= order_quantity,
  0,                              // 库存充足，无需生产
  order_quantity - available_stock // 需要生产的数量
)
```

### 3. 触发器优先级

即使代码中传入了 `plan_quantity` 值，触发器也会重新计算并覆盖，确保数据一致性。

## ⚠️ 注意事项

### 1. 触发器持久化

触发器已集成到 `backend/config/database.js`，每次服务启动时会自动创建。

### 2. 可用库存数据源

当前 `available_stock` 默认为 0。如果将来接入实际库存系统，计划数量会自动重新计算。

### 3. 数据类型

所有数量字段使用 `DECIMAL(15,4)` 类型，支持小数和大数值。

## 🎯 修复效果

### 修复前

```
订单数量: 124
可用库存: 0
计划数量: 0  ❌ 错误！
```

### 修复后

```
订单数量: 124
可用库存: 0
计划数量: 124  ✅ 正确！
```

## 📄 相关文件

1. ✅ `backend/config/database.js` - 触发器创建（第883-930行）
2. ✅ `backend/routes/salesOrders.js` - 推送逻辑补充（第690-740行）
3. ✅ `create_triggers_clean.js` - 触发器创建脚本（可重复执行）
4. ✅ `check_mps_table_structure.js` - 数据库结构检查脚本

## 📊 总结

通过创建 **MySQL触发器** + **补充代码逻辑**，成功实现了主生产计划"计划数量"字段的自动计算功能：

- ✅ 新增记录时自动计算
- ✅ 更新记录时自动重新计算
- ✅ 现有数据已批量更新
- ✅ 触发器已集成到数据库初始化代码
- ✅ 服务已重启并验证

**修复完成时间**：2025-12-19  
**修复人员**：AI Assistant  
**影响范围**：主生产计划的计划数量自动计算

---

**下一步操作**：请按照"测试步骤"验证修复效果。
