# 销售订单创建功能修复说明

## 修复时间
2025-12-05

## 问题描述

### 用户报告
用户在新增销售订单页面点击"保存"或"提交"按钮时,提示保存失败/提交失败。

### 错误信息
从浏览器控制台日志 `/home/sardenesy/ai_workspaces/ai_desktop_3/beifenshuju/console-export-2025-12-5_10-32-34.log` 中发现:

```
XHRPOST http://192.168.2.229:3005/api/sales-orders
[HTTP/1.1 500 Internal Server Error]

❌ 保存订单失败: 
Object { message: "Request failed with status code 500" }
```

从后端日志 `server.log` 中发现:

```
❌ 创建订单失败: Error: Incorrect datetime value: '2025-12-05T02:31:56.165Z' 
for column 'order_time' at row 1
code: 'ER_TRUNCATED_WRONG_VALUE'
errno: 1292
```

## 根本原因

销售订单创建路由存在两个主要问题:

### 1. 日期格式不兼容 (主要问题)
- **前端发送**: ISO 8601格式 `2025-12-05T02:31:56.165Z`
- **MySQL需要**: DATETIME格式 `2025-12-05 02:31:56`
- **影响字段**: `order_time`, `promised_delivery`, `customer_delivery`, `estimated_completion_date`, `payment_date`

### 2. undefined参数问题
- 某些可选字段未传值时为`undefined`
- MySQL2驱动不允许`undefined`,必须转为`null`
- 影响所有可选字段

## 修复方案

### 修改文件
`/home/sardenesy/ai_workspaces/ai_desktop_3/backend/routes/salesOrders.js`

### 1. 添加日期格式转换函数

```javascript
/**
 * 将ISO日期格式转换为MySQL DATETIME格式
 * @param {string} isoDate - ISO格式的日期字符串
 * @returns {string|null} - MySQL DATETIME格式或null
 */
function formatDateForMySQL(isoDate) {
  if (!isoDate) return null
  try {
    const date = new Date(isoDate)
    if (isNaN(date.getTime())) return null
    // 格式: YYYY-MM-DD HH:MM:SS
    return date.toISOString().slice(0, 19).replace('T', ' ')
  } catch (error) {
    return null
  }
}
```

**关键转换**:
- `2025-12-05T02:31:56.165Z` → `2025-12-05 02:31:56`
- `slice(0, 19)` 去掉毫秒和时区
- `replace('T', ' ')` 将T替换为空格

### 2. 修改主订单插入 - 处理日期和undefined

**修改前**:
```javascript
await connection.execute(`...`, [
  id, internalOrderNo, customerOrderNo, customerName, customerId,
  salesperson, quotationNo, orderType,
  orderTime, promisedDelivery, customerDelivery, estimatedCompletionDate,
  // ... 其他字段
])
```

**修改后**:
```javascript
await connection.execute(`...`, [
  id, internalOrderNo, customerOrderNo || null, customerName, customerId || null,
  salesperson || null, quotationNo || null, orderType || null,
  formatDateForMySQL(orderTime), formatDateForMySQL(promisedDelivery), 
  formatDateForMySQL(customerDelivery), formatDateForMySQL(estimatedCompletionDate),
  // ... 其他字段,所有可选字段都添加 || null
])
```

### 3. 修改产品明细插入 - 处理undefined

**修改前**:
```javascript
await connection.execute(`...`, [
  id, product.productCode, product.productName, product.productSpec, product.productColor,
  product.productUnit, product.orderQuantity, product.unitPriceExcludingTax, product.taxRate,
  // ...
])
```

**修改后**:
```javascript
await connection.execute(`...`, [
  id, 
  product.productCode || null, 
  product.productName || null, 
  product.productSpec || null, 
  product.productColor || null,
  product.productUnit || null, 
  product.orderQuantity || 0,  // 数值类型用0
  product.unitPriceExcludingTax || 0, 
  product.taxRate || 0,
  // ...
])
```

### 4. 修改回款计划插入 - 处理日期和undefined

**修改前**:
```javascript
await connection.execute(`...`, [
  id, payment.paymentRatio, payment.paymentAmount, 
  payment.paymentDate, payment.paymentAccount
])
```

**修改后**:
```javascript
await connection.execute(`...`, [
  id, 
  payment.paymentRatio || 0, 
  payment.paymentAmount || 0, 
  formatDateForMySQL(payment.paymentDate),  // 转换日期
  payment.paymentAccount || null
])
```

## 验证结果

### 测试用例
```bash
curl -X POST 'http://localhost:3005/api/sales-orders' \
  -H 'Content-Type: application/json' \
  -d '{
    "customerName": "测试客户001",
    "orderTime": "2025-12-05T10:30:00.000Z",
    "status": "draft",
    "products": [
      {
        "productCode": "TEST001",
        "productName": "测试产品",
        "orderQuantity": 10,
        "unitPriceExcludingTax": 100
      }
    ]
  }'
```

### 成功返回
```json
{
    "success": true,
    "message": "创建订单成功",
    "data": {
        "id": "da167dd8-4499-415b-b663-055d4369d71f",
        "internal_order_no": "SO2025000001",
        "customer_name": "测试客户001",
        "order_time": "2025-12-05T02:30:00.000Z",
        "status": "draft",
        "created_at": "2025-12-05T02:36:30.000Z"
    }
}
```

### 验证点
✅ 创建订单成功,返回200状态码
✅ 自动生成内部订单编号 `SO2025000001`
✅ 日期字段正确保存到MySQL
✅ 产品明细正确关联
✅ 订单列表可以查询到新订单

## 技术要点

### 日期格式转换
```javascript
// ISO 8601 → MySQL DATETIME
'2025-12-05T02:31:56.165Z' → '2025-12-05 02:31:56'

// 实现
isoDate.toISOString().slice(0, 19).replace('T', ' ')
```

### undefined处理规则
- **字符串字段**: `field || null`
- **数值字段**: `field || 0`
- **日期字段**: `formatDateForMySQL(field)` (函数内部已处理null)

### 防止SQL注入
所有参数都使用占位符`?`,不直接拼接SQL

## 用户使用指南

### 1. 刷新浏览器
强制刷新: `Ctrl + F5`

### 2. 创建销售订单
1. 打开销售订单列表页面
2. 点击"新增"按钮
3. 填写客户信息和产品明细
4. 点击"保存"(保存草稿,不关闭页面)
   或
   点击"提交"(保存并关闭页面)

### 3. 预期结果
- ✅ 提示"保存成功"或"提交成功"
- ✅ 订单列表显示新订单
- ✅ 订单编号自动生成 (格式: SO+年份+6位递增编号)

## 相关文件

### 后端文件
- `/backend/routes/salesOrders.js` - 销售订单路由(已修复)
- `/backend/config/database.js` - MySQL数据库配置

### 前端文件
- `/07-frontend/src/pages/sales/sales-order/SalesOrderCreate.vue` - 新增订单页面
- `/07-frontend/src/pages/sales/sales-order/SalesOrderListNew.vue` - 订单列表页面
- `/07-frontend/src/api/salesOrder.js` - 订单API服务

### 数据库表
- `sales_orders` - 销售订单主表
- `sales_order_products` - 订单产品明细表
- `sales_order_payment_schedule` - 回款计划表

## 后续建议

### 已修复功能
- ✅ 创建销售订单 (POST /api/sales-orders)
- ✅ 查询订单列表 (GET /api/sales-orders)
- ✅ 查询订单详情 (GET /api/sales-orders/:id)

### 待修复功能(如有需要)
- ⚠️ 更新销售订单 (PUT /api/sales-orders/:id)
- ⚠️ 删除销售订单 (DELETE /api/sales-orders/:id)
- ⚠️ 批量删除订单 (POST /api/sales-orders/batch-delete)

**建议**: 根据实际业务需求,优先验证创建和查询功能是否满足需求,再决定是否修复编辑和删除功能,以节省开发成本。

## 成本优化说明

### 本次修复成本
- ✅ 快速定位问题(日期格式和undefined)
- ✅ 一次性修复所有相关问题
- ✅ 修复核心创建功能,满足业务验证需求

### 符合用户偏好
- ✅ 节省credits: 只修复核心功能
- ✅ 快速实现: 创建和查询功能已完整
- ✅ 业务验证: 可以开始录入真实订单数据

### 延迟修复建议
如果后续需要编辑/删除功能,再进行修复,避免过度开发。
