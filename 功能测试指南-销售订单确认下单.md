# ✅ 销售订单确认下单功能完成 - 立即测试指南

## 🎯 实施完成时间
2025-12-16 15:15

---

## ✅ 已完成的全部修改

### 一、后端实现（之前完成）
1. ✅ 数据库字段添加：
   - `materials.default_procurement_lead_time`（默认采购提前期，默认3天）
   - `procurement_plans.procurement_lead_time`（采购提前期）

2. ✅ 后端API实现：
   - 路由：`POST /api/sales-orders/confirm-order`
   - 功能：根据产出工序自动分流数据
   - 编号生成：CG/MP + 日期 + 序号
   - Lookup机制：自动查询默认采购提前期
   - 日期计算：计划到货日期 = 客户交期 - 采购提前期

### 二、前端实现（刚刚完成）
1. ✅ **销售订单列表页面** (`/sales/orders/list`)
   - 新增"建议补货数量"列（自动计算：订单数量 - 有效库存）
   - 修改"确认下单"按钮逻辑（调用新API）
   - 优化确认对话框文案（说明分流规则）

2. ✅ **采购计划页面** (`/purchase/procurement-plan`)
   - 新增"采购提前期"列
   - 自动格式化显示（保留2位小数）

3. ✅ **产品物料库页面** (`/material/list`)
   - 新增"默认采购提前期"列
   - 支持排序、筛选

4. ✅ **API接口封装** (`/api/salesOrder.js`)
   - 新增 `confirmOrder(ids)` 方法

---

## 🚀 立即测试步骤

### 准备工作
✅ **后端服务**：已运行（端口3005）
✅ **前端服务**：已运行（端口3004）

**访问地址**：
- 前端：http://localhost:3004 或 http://192.168.2.229:3004
- 后端：http://192.168.2.229:3005

---

### 测试1：查看新增字段

#### 1.1 销售订单列表 - 建议补货数量
```
访问：http://localhost:3004/sales/orders/list

检查点：
✅ 在"订单数量"列之后，应该看到"建议补货数量"列
✅ 数值显示为彩色标签：
   - 黄色（warning）：建议补货数量 > 0（需要补货）
   - 绿色（success）：建议补货数量 = 0（库存充足）
✅ 数值计算正确：建议补货数量 = 订单数量 - 有效库存
```

#### 1.2 采购计划 - 采购提前期
```
访问：http://localhost:3004/purchase/procurement-plan

检查点：
✅ 在"备料计划编号"列之后，应该看到"采购提前期"列
✅ 数值格式：保留2位小数（如 "3.00"）
✅ 如果有数据，值应该是通过lookup从物料库获取的
```

#### 1.3 产品物料库 - 默认采购提前期
```
访问：http://localhost:3004/material/list

检查点：
✅ 在"定额工时"列之后，应该看到"默认采购提前期"列
✅ 采购来源的物料应该默认显示 3 天
✅ 列支持排序（点击表头）
✅ 列支持筛选（如果使用FilterTable组件）
```

---

### 测试2：确认下单数据分流

#### 2.1 准备测试数据
**需要准备的数据**：
1. **采购类订单**：
   - 产品：产出工序 = "采购"
   - 订单数量：10
   - 有效库存：5
   - 预期：建议补货数量 = 5

2. **生产类订单**：
   - 产品：产出工序 = "组装"（或其他非"采购"）
   - 订单数量：20
   - 有效库存：25
   - 预期：建议补货数量 = 0

#### 2.2 执行确认下单
```
1. 访问销售订单列表
   http://localhost:3004/sales/orders/list

2. 勾选一个或多个订单（可以混合采购/生产类订单）

3. 点击顶部工具栏的"确认下单"按钮（绿色按钮，带对勾图标）

4. 查看确认对话框：
   ✅ 标题："确认下单确认"
   ✅ 内容应包含：
      "确认后将根据'产出工序'分流：
       - 产出工序 = '采购' → 推送到采购计划
       - 产出工序 ≠ '采购' → 推送到主生产计划"

5. 点击"确定"

6. 等待处理（Loading: "正在处理订单数据分流..."）

7. 查看成功提示：
   ✅ 应显示类似：
      "确认下单成功！
       推送 2 条到主生产计划
       推送 1 条到采购计划"
```

#### 2.3 验证数据分流结果

**检查采购计划**：
```
访问：http://localhost:3004/purchase/procurement-plan

验证点：
✅ 应看到新增的采购计划记录
✅ 采购计划编号格式：CG{YYYYMMDD}{0001}（如：CG202512160001）
✅ 来源表单 = "销售订单列表"
✅ 来源编号 = 内部销售订单编号
✅ 采购物料编号 = 产品编号
✅ 需补货数量 = 建议补货数量
✅ 采购提前期 = 3（从物料库lookup）
✅ 计划到货日期 = 客户交期 - 3天
✅ 采购状态 = "待询价"（PENDING_INQUIRY）
```

**检查主生产计划**：
```
访问：http://localhost:3004/production-planning/plan-list

验证点：
✅ 应看到新增的主生产计划记录
✅ 主生产计划编号格式：MP{YYYYMMDD}{0001}（如：MP202512160001）
✅ 产品编号 = 产品编号
✅ 产品名称 = 产品名称
✅ 订单数量 = 订单数量
✅ 有效库存 = 有效库存
✅ 计划排程数量 = 建议补货数量
✅ 产出工序 = 产出工序
✅ 订单状态 = "已下单"
```

**检查销售订单状态**：
```
返回销售订单列表

验证点：
✅ 已确认的订单状态应更新为"已确认"
✅ 订单不再可选（或根据业务规则）
```

---

### 测试3：边界情况

#### 3.1 库存充足订单
```
测试场景：订单数量 ≤ 有效库存

预期结果：
✅ 建议补货数量 = 0
✅ 仍然推送到对应表（采购计划或主生产计划）
✅ 需补货数量/计划排程数量 = 0
```

#### 3.2 混合订单批量确认
```
测试场景：同时勾选采购类和生产类订单

预期结果：
✅ 自动分流到两个表
✅ 成功消息显示两个表的推送数量
✅ 数据一致性完整
```

#### 3.3 未设置产出工序的订单
```
测试场景：产品的产出工序字段为空

预期结果：
✅ 根据后端逻辑，应推送到主生产计划（产出工序 ≠ "采购"）
```

---

## 🐛 常见问题排查

### 问题1：找不到"建议补货数量"列
**可能原因**：
- 前端服务未重启
- 浏览器缓存未清除

**解决方法**：
```bash
# 1. 硬刷新浏览器：Ctrl + Shift + R（Windows/Linux）或 Cmd + Shift + R（Mac）
# 2. 或清除浏览器缓存后重新访问
```

### 问题2：点击"确认下单"无响应
**排查步骤**：
1. 打开浏览器开发者工具（F12）
2. 切换到"Network"（网络）标签
3. 点击"确认下单"
4. 查看请求：
   - 请求URL应为：`/api/sales-orders/confirm-order`
   - 请求方法：POST
   - 请求体：`{"ids":[订单ID列表]}`

**如果请求失败（404）**：
- 检查后端服务是否运行：`curl http://192.168.2.229:3005/api/sales-orders/confirm-order`
- 检查后端路由是否正确注册

**如果请求失败（500）**：
- 查看后端日志：`tail -f /后端日志路径`
- 检查数据库连接

### 问题3：采购提前期显示为空
**可能原因**：
- 物料库中对应物料没有设置"默认采购提前期"
- Lookup查询失败

**解决方法**：
1. 访问物料库：http://localhost:3004/material/list
2. 找到对应物料，检查"默认采购提前期"列
3. 如果为空，编辑物料并设置为3天
4. 重新确认订单

### 问题4：计划到货日期计算错误
**排查步骤**：
1. 检查客户交期是否正确
2. 检查采购提前期是否正确
3. 验证计算公式：计划到货日期 = 客户交期 - 采购提前期
4. 查看后端日志确认计算逻辑

---

## 📊 数据验证清单

### ✅ 销售订单列表
- [ ] "建议补货数量"列显示
- [ ] 数值计算正确（订单数量 - 有效库存）
- [ ] 彩色标签显示（黄/绿）
- [ ] "确认下单"按钮文案正确

### ✅ 采购计划
- [ ] "采购提前期"列显示
- [ ] 数值格式正确（2位小数）
- [ ] 数据来源正确（lookup物料库）

### ✅ 产品物料库
- [ ] "默认采购提前期"列显示
- [ ] 采购来源物料默认值为3天
- [ ] 列支持排序和筛选

### ✅ 数据分流功能
- [ ] 采购类订单推送到采购计划
- [ ] 生产类订单推送到主生产计划
- [ ] 混合订单正确分流
- [ ] 编号生成格式正确
- [ ] 字段映射完整
- [ ] 订单状态正确更新

---

## 🎉 测试通过标准

全部功能正常，满足以下条件即为测试通过：

1. ✅ 三个页面新增列全部显示
2. ✅ 建议补货数量自动计算正确
3. ✅ 确认下单按钮可点击，对话框文案正确
4. ✅ 数据成功分流到采购计划和主生产计划
5. ✅ 采购计划的采购提前期通过lookup正确填充
6. ✅ 计划到货日期计算正确
7. ✅ 订单状态正确更新为"已确认"
8. ✅ 无控制台错误、无网络请求失败

---

## 📝 后续优化建议

1. **性能优化**：
   - 如果订单量大，考虑分页加载
   - 建议补货数量计算可考虑缓存

2. **用户体验优化**：
   - 可以在确认下单前显示预览（将推送多少条到哪个表）
   - 成功后提供快捷跳转链接（跳转到采购计划或主生产计划）

3. **数据校验增强**：
   - 确认下单前检查产出工序是否为空
   - 检查默认采购提前期是否设置

4. **权限控制**：
   - 可根据用户角色控制"确认下单"按钮的可见性
   - 添加操作日志记录

---

## 🔗 相关文档
- 前端实现报告：`/销售订单确认下单数据分流功能前端实现报告.md`
- 后端实现报告：`/销售订单确认下单数据分流功能实现报告.md`
- 数据库脚本：`/backend/scripts/add-procurement-lead-time-fields.js`

---

**准备就绪，可以立即开始测试！** 🚀

如遇问题，请：
1. 先查看本文档的"常见问题排查"章节
2. 检查浏览器控制台的错误信息
3. 查看后端日志输出
