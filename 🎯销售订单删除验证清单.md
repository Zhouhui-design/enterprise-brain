# 🎯 销售订单删除验证清单

## 快速验证步骤

### 1️⃣ 准备测试数据

#### 创建一个完整的销售订单流程：

1. **创建销售订单**
   - 访问：http://localhost:3003/sales/orders/list
   - 点击"新增"
   - 填写客户信息和产品信息
   - 保存订单（获得内部订单编号，例如：SO2025000001）

2. **确认下单（推送到主生产计划）**
   - 选择刚创建的订单
   - 点击"确认下单"
   - ✅ 验证：主生产计划页面应出现新数据

3. **执行排程（生成备料计划和工序计划）**
   - 访问：http://localhost:3003/production-planning/plan-list
   - 选择刚生成的主生产计划
   - 点击"执行排程"
   - ✅ 验证：备料计划和工序计划页面应出现新数据

---

### 2️⃣ 验证级联删除

#### 记录删除前的数据：

假设内部订单编号是：`SO2025000001`

| 页面 | URL | 预期数据 |
|------|-----|----------|
| 销售订单 | /sales/orders/list | 1条 |
| 主生产计划 | /production-planning/plan-list | X条 |
| 备料计划 | /production-planning/material-preparation-new | X条 |
| 工序计划 | /production-planning/packing-process-plan 等 | X条 |
| 采购计划 | /purchase/procurement-plan | X条 |

#### 执行删除操作：

1. 回到销售订单页面
2. 选择订单 `SO2025000001`
3. 点击"删除"按钮
4. 确认删除

#### 验证删除结果：

**✅ 期望结果：**
- 销售订单：已删除（0条）
- 主生产计划：已删除（0条，`internal_order_no = SO2025000001` 的记录）
- 备料计划：已删除（0条，`sales_order_no = SO2025000001` 的记录）
- 工序计划：已删除（0条，`sales_order_no = SO2025000001` 的记录）
- 采购计划：已删除（0条，`sales_order_no = SO2025000001` 的记录）

---

### 3️⃣ 查看后端日志

打开后端日志：
```bash
cd /home/sardensy/enterprise-brain/enterpise-brain
tail -f backend.log
```

**期望看到的日志：**
```
🔄 开始删除销售订单: {订单ID}
📋 内部订单编号: SO2025000001
✅ 级联删除主生产计划: X 条
✅ 级联删除备料计划: X 条
✅ 级联删除采购计划: X 条
✅ 级联删除 packing_process_plans: X 条
✅ 级联删除 assembly_process_plans: X 条
... (其他工序计划)
✅ 删除订单产品明细
✅ 删除回款计划
✅ 删除主订单记录
🎉 订单级联删除成功: {
  internalOrderNo: 'SO2025000001',
  主生产计划: X,
  备料计划: X,
  采购计划: X,
  工序计划: X,
  总计: X
}
```

---

## 🔍 手动数据库验证（可选）

如果想直接查看数据库，可以执行：

```bash
cd /home/sardensy/enterprise-brain/enterpise-brain
node -e "
const { pool } = require('./backend/config/database');
(async () => {
  const conn = await pool.getConnection();
  const orderNo = 'SO2025000001'; // 替换为实际的订单编号
  
  console.log('销售订单:', (await conn.execute('SELECT COUNT(*) as c FROM sales_orders WHERE internal_order_no = ?', [orderNo]))[0][0].c);
  console.log('主生产计划:', (await conn.execute('SELECT COUNT(*) as c FROM master_production_plans WHERE internal_order_no = ?', [orderNo]))[0][0].c);
  console.log('备料计划:', (await conn.execute('SELECT COUNT(*) as c FROM material_preparation_plans WHERE sales_order_no = ?', [orderNo]))[0][0].c);
  console.log('采购计划:', (await conn.execute('SELECT COUNT(*) as c FROM procurement_plans WHERE sales_order_no = ?', [orderNo]))[0][0].c);
  console.log('工序计划:', (await conn.execute('SELECT COUNT(*) as c FROM packing_process_plans WHERE sales_order_no = ?', [orderNo]))[0][0].c);
  
  conn.release();
  await pool.end();
})();
"
```

**删除前**：所有计数应该 > 0  
**删除后**：所有计数应该 = 0

---

## ✅ 验证检查清单

- [ ] 销售订单已删除
- [ ] 主生产计划已级联删除
- [ ] 备料计划已级联删除
- [ ] 采购计划已级联删除
- [ ] 所有工序计划已级联删除
- [ ] 后端日志显示删除统计
- [ ] 前端提示删除成功
- [ ] 无残留数据

---

## 🎉 验证完成

如果以上所有步骤都通过，说明：
- ✅ 销售订单删除功能正常
- ✅ 级联删除逻辑完整
- ✅ 数据一致性保证
- ✅ 功能已可用于生产环境

---

**测试时间**: _______  
**测试人员**: _______  
**测试结果**: ⬜ 通过 / ⬜ 失败  
**备注**: _______
