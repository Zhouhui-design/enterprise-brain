# 销售订单"确认下单"数据分流功能实现报告

## 实施时间
2025-12-16 14:57 - 进行中

## 需求概述

### 核心需求
1. **产品物料库增加"默认采购提前期"字段**（采购属性区域）
2. **批量更新数据库**：所有采购来源物料的默认采购提前期设为3天
3. **采购计划增加"采购提前期"列**
4. **销售订单列表增加"建议补货数量"列**（值=订单数量-有效库存）
5. **销售订单"确认下单"按钮**实现数据分流：
   - 产出工序≠"采购" → 推送主生产计划
   - 产出工序="采购" → 推送采购计划

### 数据流规则（订单→采购计划）
- 来源表单 = "销售订单列表"
- 来源编号 = 内部销售订单编号
- 采购物料编号 = 产品编号
- 采购物料名称 = 产品名称
- 图片 = 产品图片
- 需补货数量 = 建议补货数量
- 基本单位 = 产品单位
- 销售订单编号 = 内部销售订单编号
- 客户订单编号 = 客户订单编号
- 采购提前期 = lookup(产品物料库.默认采购提前期)
- 计划到货日期 = 客户交期 - 采购提前期

---

## 已完成部分

### ✅ 1. 数据库字段添加

**执行脚本**：`/backend/scripts/add-procurement-lead-time-fields.js`

**修改内容**：
1. **materials表新增字段**：
   ```sql
   ALTER TABLE materials 
   ADD COLUMN default_procurement_lead_time INT DEFAULT 3 COMMENT '默认采购提前期(天数)'
   AFTER purchase_cycle
   ```

2. **procurement_plans表新增字段**：
   ```sql
   ALTER TABLE procurement_plans 
   ADD COLUMN procurement_lead_time INT DEFAULT NULL COMMENT '采购提前期(天数)'
   AFTER material_plan_no
   ```

3. **批量更新采购物料**：
   ```sql
   UPDATE materials 
   SET default_procurement_lead_time = 3 
   WHERE source = '采购' OR source LIKE '%采购%'
   ```

**执行结果**：
- ✅ materials表字段添加成功
- ✅ procurement_plans表字段添加成功
- ✅ 已更新 0 条采购物料的默认提前期（说明当前数据库中可能没有采购来源的物料数据）

---

### ✅ 2. 后端API实现 - "确认下单"

**文件**：`/backend/routes/salesOrders.js`

**新增路由**：`POST /api/sales-orders/confirm-order`

**核心逻辑**：

```javascript
router.post('/confirm-order', async (req, res) => {
  // 1. 接收订单ID列表
  const { ids } = req.body
  
  // 2. 遍历每个订单
  for (const orderId of ids) {
    // 2.1 查询订单及产品明细
    const order = await getOrder(orderId)
    const products = await getOrderProducts(orderId)
    
    // 2.2 查询库存以计算建议补货数量
    const inventoryMap = await getInventoryMap()
    
    // 2.3 遍历产品，根据产出工序分流
    for (const product of products) {
      const outputProcess = product.output_process
      const suggestedQty = product.order_quantity - (inventoryMap.get(product.product_code) || 0)
      
      if (outputProcess === '采购') {
        // ===== 推送到采购计划 =====
        // 生成采购计划编号：CG + YYYYMMDD + 0001
        const procurementPlanNo = generateProcurementPlanNo()
        
        // Lookup默认采购提前期
        const leadTime = await getMaterialLeadTime(product.product_code)
        
        // 计算计划到货日期 = 客户交期 - 采购提前期
        const planArrivalDate = calculateArrivalDate(order.customer_delivery, leadTime)
        
        // 插入采购计划
        await insertProcurementPlan({
          procurement_plan_no: procurementPlanNo,
          source_form_name: '销售订单列表',
          source_no: order.internal_order_no,
          material_code: product.product_code,
          material_name: product.product_name,
          required_quantity: suggestedQty,
          base_unit: product.product_unit,
          sales_order_no: order.internal_order_no,
          customer_order_no: order.customer_order_no,
          procurement_lead_time: leadTime,
          plan_arrival_date: planArrivalDate,
          procurement_status: 'PENDING_INQUIRY'
        })
      } else {
        // ===== 推送到主生产计划 =====
        // 生成主生产计划编号：MP + YYYYMMDD + 0001
        const planCode = generateMasterPlanNo()
        
        // 插入主生产计划
        await insertMasterPlan({
          plan_code: planCode,
          product_code: product.product_code,
          product_name: product.product_name,
          order_quantity: product.order_quantity,
          available_stock: inventoryMap.get(product.product_code) || 0,
          plan_quantity: suggestedQty,
          output_process: outputProcess,
          promised_delivery_date: order.promised_delivery || order.customer_delivery,
          internal_order_no: order.internal_order_no,
          customer_order_no: order.customer_order_no,
          customer_name: order.customer_name,
          status: '已下单'
        })
      }
    }
    
    // 3. 更新订单状态为"已确认"
    await updateOrderStatus(orderId, '已确认')
  }
  
  // 4. 返回成功结果
  res.json({
    success: true,
    message: `推送 ${totalMasterPlans} 条到主生产计划，${totalProcurementPlans} 条到采购计划`
  })
})
```

**关键特性**：
1. **数据分流逻辑**：根据产出工序字段自动分流
2. **编号自动生成**：
   - 采购计划编号：`CG{YYYYMMDD}{0001}`
   - 主生产计划编号：`MP{YYYYMMDD}{0001}`
3. **Lookup机制**：从物料表查询默认采购提前期
4. **日期计算**：计划到货日期 = 客户交期 - 采购提前期
5. **事务保障**：使用数据库事务确保数据一致性
6. **状态更新**：订单状态自动更新为"已确认"

---

## 待实现部分

### ⏳ 3. 前端销售订单列表修改

**文件**：`/07-frontend/src/pages/sales/sales-order/SalesOrderListNew.vue`

**需要修改**：
1. **增加"建议补货数量"列**：
   ```javascript
   {
     prop: 'suggestedReplenishmentQty',
     label: '建议补货数量',
     width: 140,
     filterable: true,
     visible: true
   }
   ```
   
   计算逻辑：
   ```javascript
   const suggestedQty = computed(() => {
     return row.orderQuantity - (row.availableStock || 0)
   })
   ```

2. **增加"确认下单"按钮**：
   ```vue
   <template #toolbar-right>
     <el-button
       type="primary"
       :disabled="!hasSelection"
       @click="handleConfirmOrder"
     >
       确认下单
     </el-button>
   </template>
   ```

3. **实现确认下单方法**：
   ```javascript
   const handleConfirmOrder = async () => {
     try {
       await ElMessageBox.confirm('确定对选中的订单执行确认下单吗？', '确认下单')
       
       const ids = selectedRows.value.map(row => row.id)
       const response = await salesOrderApi.confirmOrder(ids)
       
       ElMessage.success(response.message)
       loadData() // 刷新列表
     } catch (error) {
       if (error !== 'cancel') {
         ElMessage.error('确认下单失败: ' + error.message)
       }
     }
   }
   ```

4. **添加API方法**：
   ```javascript
   // /07-frontend/src/api/salesOrder.js
   export const salesOrderApi = {
     confirmOrder(ids) {
       return request.post('/sales-orders/confirm-order', { ids })
     }
   }
   ```

---

### ⏳ 4. 前端采购计划列表修改

**文件**：`/07-frontend/src/pages/purchase/ProcurementPlanList.vue`

**需要修改**：
1. **增加"采购提前期"列**：
   ```javascript
   const defaultColumns = [
     // ... existing columns
     { 
       prop: 'procurementLeadTime', 
       label: '采购提前期(天)', 
       width: 120, 
       filterable: false, 
       visible: true 
     },
     // ... existing columns
   ]
   ```

2. **更新Service层**：
   ```javascript
   // /backend/services/procurementPlanService.js
   async create(data) {
     const sql = `
       INSERT INTO procurement_plans (
         procurement_plan_no, purchase_order_no, source_form_name, source_no,
         material_code, material_name, material_image, required_quantity, base_unit,
         sales_order_no, customer_order_no, master_plan_no, process_plan_no, material_plan_no,
         procurement_lead_time, -- ✅ 新增字段
         plan_arrival_date, procurement_status, supplier_name, purchaser,
         // ... 其他字段
       ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ...)
     `;
     
     const params = [
       data.procurementPlanNo, data.purchaseOrderNo, data.sourceFormName, data.sourceNo,
       data.materialCode, data.materialName, data.materialImage, data.requiredQuantity, data.baseUnit,
       data.salesOrderNo, data.customerOrderNo, data.masterPlanNo, data.processPlanNo, data.materialPlanNo,
       data.procurementLeadTime, // ✅ 新增参数
       data.planArrivalDate, data.procurementStatus, data.supplierName, data.purchaser,
       // ... 其他参数
     ];
   }
   ```

---

### ⏳ 5. 前端产品物料库修改

**文件**：`/07-frontend/src/pages/material/MaterialList.vue`

**需要修改**：
1. **增加"默认采购提前期"列**（采购属性区域）：
   ```javascript
   {
     prop: 'defaultProcurementLeadTime',
     label: '默认采购提前期(天)',
     width: 160,
     filterable: false,
     visible: true,
     editable: true
   }
   ```

2. **更新Service层**：
   ```javascript
   // /backend/services/materialService.js
   async createMaterial(materialData) {
     const sql = `
       INSERT INTO materials (
         material_code, material_name, size_spec, color, material,
         major_category, middle_category, minor_category,
         source, default_procurement_lead_time, -- ✅ 新增字段
         // ... 其他字段
       ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ...)
     `;
   }
   ```

---

## 技术细节

### 1. 采购计划编号生成规则
- **格式**：`CG{YYYYMMDD}{序号4位}`
- **示例**：`CG202512160001`
- **逻辑**：
  ```javascript
  const dailyCount = await countTodayPlans() + 1
  const today = new Date().toISOString().split('T')[0].replace(/-/g, '')
  const planNo = `CG${today}${String(dailyCount).padStart(4, '0')}`
  ```

### 2. 计划到货日期计算
- **公式**：`计划到货日期 = 客户交期 - 采购提前期`
- **示例**：
  - 客户交期：2025-12-25
  - 采购提前期：3天
  - 计划到货日期：2025-12-22
- **实现**：
  ```javascript
  const customerDelivery = new Date(order.customer_delivery)
  customerDelivery.setDate(customerDelivery.getDate() - leadTime)
  const planArrivalDate = customerDelivery.toISOString().split('T')[0]
  ```

### 3. Lookup机制
- **目标**：从物料表查询默认采购提前期
- **SQL**：
  ```sql
  SELECT default_procurement_lead_time 
  FROM materials 
  WHERE material_code = ?
  ```
- **默认值**：如果查询不到，默认为3天

### 4. 建议补货数量计算
- **公式**：`建议补货数量 = 订单数量 - 有效库存`
- **逻辑**：
  ```javascript
  const availableStock = inventoryMap.get(productCode) || 0
  const suggestedQty = Math.max(0, orderQuantity - availableStock)
  ```
- **注意**：确保不为负数

---

## 数据流图

```
销售订单列表
    │
    │ 点击"确认下单"
    │
    ├─► 查询订单产品明细
    │        │
    │        ├─► 查询output_process字段
    │        │
    │        └─► 查询库存计算建议补货数量
    │
    ├─► 判断产出工序
    │        │
    │        ├─► 产出工序 = "采购"
    │        │        │
    │        │        ├─► Lookup默认采购提前期
    │        │        │
    │        │        ├─► 计算计划到货日期
    │        │        │
    │        │        └─► 插入采购计划表
    │        │
    │        └─► 产出工序 ≠ "采购"
    │                 │
    │                 └─► 插入主生产计划表
    │
    └─► 更新订单状态为"已确认"
```

---

## 相关文件清单

### 后端文件
1. ✅ `/backend/scripts/add-procurement-lead-time-fields.js` - 数据库字段添加脚本
2. ✅ `/backend/routes/salesOrders.js` - 销售订单路由（新增确认下单API）
3. ⏳ `/backend/services/procurementPlanService.js` - 采购计划Service（待更新）
4. ⏳ `/backend/services/materialService.js` - 物料Service（待更新）

### 前端文件
1. ⏳ `/07-frontend/src/pages/sales/sales-order/SalesOrderListNew.vue` - 销售订单列表页（待修改）
2. ⏳ `/07-frontend/src/pages/purchase/ProcurementPlanList.vue` - 采购计划列表页（待修改）
3. ⏳ `/07-frontend/src/pages/material/MaterialList.vue` - 产品物料库页（待修改）
4. ⏳ `/07-frontend/src/api/salesOrder.js` - 销售订单API（待新增方法）
5. ⏳ `/07-frontend/src/api/procurementPlan.js` - 采购计划API（已有）

### 数据库表
1. ✅ `materials` - 物料表（新增default_procurement_lead_time字段）
2. ✅ `procurement_plans` - 采购计划表（新增procurement_lead_time字段）
3. `sales_orders` - 销售订单表
4. `sales_order_products` - 销售订单产品明细表
5. `master_production_plans` - 主生产计划表
6. `inventory` - 库存表

---

## 验证步骤

### 1. 测试确认下单API
```bash
# 测试请求
curl -X POST http://localhost:3005/api/sales-orders/confirm-order \
  -H "Content-Type: application/json" \
  -d '{"ids": ["订单ID1", "订单ID2"]}'
  
# 预期响应
{
  "success": true,
  "message": "确认下单成功！推送 2 条到主生产计划，1 条到采购计划",
  "data": {
    "masterPlansCreated": 2,
    "procurementPlansCreated": 1
  }
}
```

### 2. 验证数据流
1. **销售订单表**：
   - 订单状态更新为"已确认"
   
2. **主生产计划表**：
   - 产出工序≠"采购"的产品推送到此表
   - plan_code格式正确：`MP{YYYYMMDD}{0001}`
   
3. **采购计划表**：
   - 产出工序="采购"的产品推送到此表
   - procurement_plan_no格式正确：`CG{YYYYMMDD}{0001}`
   - procurement_lead_time字段正确填充
   - plan_arrival_date计算正确

### 3. 前端功能测试
1. **销售订单列表**：
   - "建议补货数量"列显示正确
   - "确认下单"按钮可用
   - 批量选择后点击"确认下单"，数据正确推送
   
2. **采购计划列表**：
   - "采购提前期"列显示正确
   - 新增采购计划时可编辑该字段
   
3. **产品物料库**：
   - "默认采购提前期"列显示正确
   - 编辑物料时可修改该字段

---

## 下一步操作

1. **完成前端销售订单列表修改**
2. **完成前端采购计划列表修改**
3. **完成前端产品物料库修改**
4. **测试完整数据流**
5. **用户验证反馈**

---

**报告生成时间**：2025-12-16 15:30  
**当前状态**：后端API已完成，前端修改进行中  
**预计完成时间**：待用户确认后继续
