# ç¼çº«å·¥åºè®¡åˆ’å­—æ®µè®¡ç®—æœªè§¦å‘é—®é¢˜åˆ†ææŠ¥å‘Š

**é—®é¢˜å‘ç°æ—¶é—´**: 2025-12-15 20:04  
**é—®é¢˜æè¿°**: ç¼çº«å·¥åºè®¡åˆ’ç”Ÿæˆå,å­—æ®µè®¡ç®—æœªè§¦å‘  
**ç”¨æˆ·åé¦ˆ**: "ç¼çº«å·¥åºç”Ÿæˆä¹‹åï¼Œæ²¡æœ‰è§¦å‘æ•°æ®è®¡ç®—ï¼›è®¡åˆ’æ’ç¨‹æ—¥æœŸï¼Œå½“å¤©æ€»å·¥æ—¶ï¼Œç­‰ç­‰ æ‰€æœ‰éœ€è¦è®¡ç®—çš„æ•°æ®éƒ½æ²¡è®¡ç®—"

---

## âŒ é—®é¢˜ç°è±¡

### æ•°æ®åº“æŸ¥è¯¢ç»“æœ
```sql
SELECT id, plan_no, schedule_date, daily_total_hours, 
       daily_scheduled_hours, scheduled_work_hours, 
       next_schedule_date
FROM sewing_process_plans;
```

### å®é™…æ•°æ®
| å­—æ®µ | å€¼ | æœŸæœ›å€¼ | çŠ¶æ€ |
|-----|----|----|------|
| schedule_date | NULL | å…·ä½“æ—¥æœŸ(å¦‚2025-12-16) | âŒ |
| daily_total_hours | 0.00 | å¦‚48.00 | âŒ |
| daily_scheduled_hours | 0.00 | å¦‚24.00 | âŒ |
| scheduled_work_hours | 0.00 | å¦‚8.50 | âŒ |
| next_schedule_date | NULL | å…·ä½“æ—¥æœŸ(å¦‚2025-12-17) | âŒ |
| cumulative_schedule_qty | 0.0000 | - | âœ… æ­£ç¡® |
| unscheduled_qty | 4.0800/96.0000 | - | âœ… æ­£ç¡® |

---

## ğŸ” é—®é¢˜åˆ†æ

### 1. æ•°æ®æµè·¯å¾„
```
å¤‡æ–™è®¡åˆ’ (material_preparation_plans)
  â†“ (pushToRealProcessPlanæ–¹æ³•)
  â†“ 
  â”œâ†’ æŸ¥è¯¢é…ç½® (getProcessConfig('ç¼çº«'))
  â”œâ†’ è®¡ç®—å„ç§å­—æ®µ
  â”œâ†’ è°ƒç”¨ SewingProcessPlanService.create()
  â””â†’ æ›´æ–°è®¡ç®—å­—æ®µ (UPDATE)
```

### 2. å­—æ®µè®¡ç®—é€»è¾‘ä½ç½®
**æ–‡ä»¶**: `/backend/services/materialPreparationPlanService.js`  
**æ–¹æ³•**: `pushToRealProcessPlan`

**å…³é”®è®¡ç®—æ­¥éª¤**:
1. **ç¬¬596-618è¡Œ**: è®¡ç®—`dailyTotalHours` (å½“å¤©æ€»å·¥æ—¶)
   - ä¾èµ–: `scheduleDate` + `processName`
   - æŸ¥è¯¢: `process_capacity_load`è¡¨
   
2. **ç¬¬620-648è¡Œ**: è®¡ç®—`dailyScheduledHours` (å½“å¤©å·²æ’ç¨‹å·¥æ—¶)
   - ä¾èµ–: `scheduleDate` + `processName`
   - æŸ¥è¯¢: ç›®æ ‡å·¥åºè®¡åˆ’è¡¨
   
3. **ç¬¬650-656è¡Œ**: è®¡ç®—`dailyAvailableHours` (å½“å¤©å¯ç”¨å·¥æ—¶)
   - å…¬å¼: `dailyTotalHours - dailyScheduledHours`
   
4. **ç¬¬658-663è¡Œ**: è®¡ç®—`scheduledWorkHours` (è®¡åˆ’æ’ç¨‹å·¥æ—¶)
   - å…¬å¼: `min(requiredWorkHours, dailyAvailableHours)`
   
5. **ç¬¬672-682è¡Œ**: è®¡ç®—`nextScheduleDate` (ä¸‹ä¸€æ’ç¨‹æ—¥æœŸ)
   - å…¬å¼: `scheduleDate + 1å¤©`

### 3. é—®é¢˜æ ¹æº

**æ ¸å¿ƒé—®é¢˜**: `scheduleDate`ä¸ºNULL!

**è¿½æº¯è®¡ç®—é“¾**:
```
scheduleDate = realPlanStartDate  (ç¬¬594è¡Œ)
  â†‘
realPlanStartDate = planStartDate + 1å¤©  (ç¬¬582-591è¡Œ)
  â†‘  
planStartDate = åå‘ç´¯ç§¯å·¥æ—¶æŸ¥è¯¢  (ç¬¬549-580è¡Œ)
  â†‘
ä¾èµ–: requiredWorkHours > 0 && processName && planEndDate
  â†‘
planEndDate = å·¥åºèƒ½åŠ›è´Ÿè·è¡¨æŸ¥è¯¢  (ç¬¬526-547è¡Œ)
  â†‘
ä¾èµ–: requiredWorkHours > 0 && processName && completionDate
  â†‘
completionDate = demandDate - 1å¤©  (ç¬¬507-516è¡Œ)
  â†‘
ä¾èµ–: data.demandDateå­˜åœ¨
```

**å¤±è´¥ç‚¹æ£€æµ‹**:
- âœ… `data.demandDate`å­˜åœ¨å—?
- âœ… `completionDate`è®¡ç®—æˆåŠŸå—?
- âœ… `processName` = "ç¼çº«"å­˜åœ¨å—?
- âš ï¸ `requiredWorkHours`è®¡ç®—æˆåŠŸå—?
- âš ï¸ å·¥åºèƒ½åŠ›è´Ÿè·è¡¨ä¸­æœ‰"ç¼çº«"å·¥åºçš„æ•°æ®å—?

---

## ğŸ§ª è¯Šæ–­å»ºè®®

### æ£€æŸ¥1: å·¥åºèƒ½åŠ›è´Ÿè·è¡¨æ•°æ®
```sql
SELECT * FROM process_capacity_load 
WHERE process_name = 'ç¼çº«' 
ORDER BY date DESC 
LIMIT 5;
```

**é¢„æœŸ**: åº”è¯¥æœ‰ç¼çº«å·¥åºçš„æ—¥æœŸã€å·¥ä½æ•°ã€ç­æ¬¡ç­‰æ•°æ®  
**å¦‚æœä¸ºç©º**: è¿™æ˜¯æ ¹æœ¬åŸå› !

### æ£€æŸ¥2: å¤‡æ–™è®¡åˆ’æ•°æ®
```sql
SELECT plan_no, material_code, material_name, 
       demand_date, source_process, 
       replenishment_quantity
FROM material_preparation_plans 
WHERE source_process = 'ç¼çº«' 
ORDER BY id DESC 
LIMIT 5;
```

**æ£€æŸ¥ç‚¹**:
- `demand_date`æ˜¯å¦å­˜åœ¨?
- `replenishment_quantity`æ˜¯å¦>0?
- `source_process`æ˜¯å¦="ç¼çº«"?

### æ£€æŸ¥3: ç‰©æ–™å®šé¢æ•°æ®
```sql
SELECT material_code, material_name, 
       standard_time, quota_time 
FROM materials 
WHERE material_code IN (
  SELECT DISTINCT material_code 
  FROM material_preparation_plans 
  WHERE source_process = 'ç¼çº«'
);
```

**æ£€æŸ¥ç‚¹**:
- `standard_time` (å®šæ—¶å·¥é¢)æ˜¯å¦>0?
- `quota_time` (å®šé¢å·¥æ—¶)æ˜¯å¦>0?

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆA: è¡¥å…¨å·¥åºèƒ½åŠ›è´Ÿè·è¡¨æ•°æ® (æ¨è)

**å¦‚æœ`process_capacity_load`è¡¨ä¸­æ²¡æœ‰"ç¼çº«"å·¥åºæ•°æ®**:

1. **æ·»åŠ ç¼çº«å·¥åºèƒ½åŠ›è´Ÿè·æ•°æ®**
```sql
-- ç¤ºä¾‹: æ·»åŠ æœªæ¥30å¤©çš„ç¼çº«å·¥åºèƒ½åŠ›
INSERT INTO process_capacity_load 
(process_name, date, work_shift, available_workstations, 
 occupied_hours, remaining_hours, remaining_shift)
SELECT 
  'ç¼çº«' as process_name,
  DATE_ADD(CURDATE(), INTERVAL n DAY) as date,
  8.0 as work_shift,
  6 as available_workstations,
  0.00 as occupied_hours,
  48.00 as remaining_hours,
  8.0 as remaining_shift
FROM (
  SELECT 0 as n UNION SELECT 1 UNION SELECT 2 ... UNION SELECT 29
) numbers;
```

2. **é‡æ–°è§¦å‘æ•°æ®æ¨é€**
   - åˆ é™¤å·²ç”Ÿæˆçš„ç¼çº«å·¥åºè®¡åˆ’
   - é‡æ–°æ¨é€å¤‡æ–™è®¡åˆ’åˆ°ç¼çº«å·¥åº
   - ç³»ç»Ÿä¼šè‡ªåŠ¨é‡æ–°è®¡ç®—æ‰€æœ‰å­—æ®µ

### æ–¹æ¡ˆB: ä¿®å¤ä»£ç é€»è¾‘ (å¦‚æœèƒ½åŠ›è´Ÿè·æ•°æ®å­˜åœ¨)

**å¦‚æœèƒ½åŠ›è´Ÿè·è¡¨æœ‰æ•°æ®,ä½†å­—æ®µè®¡ç®—ä»ç„¶å¤±è´¥**:

1. **æ·»åŠ è°ƒè¯•æ—¥å¿—**
   åœ¨`materialPreparationPlanService.js`çš„`pushToRealProcessPlan`æ–¹æ³•ä¸­æ·»åŠ :
   ```javascript
   // ç¬¬515è¡Œå
   console.log(`âœ… completionDateè®¡ç®—ç»“æœ: ${completionDate}`);
   
   // ç¬¬546è¡Œå
   console.log(`âœ… planEndDateæŸ¥è¯¢ç»“æœ: ${planEndDate}, æŸ¥è¯¢æ¡ä»¶: processName=${processName}, completionDate=${completionDate}`);
   
   // ç¬¬580è¡Œå
   console.log(`âœ… planStartDateè®¡ç®—ç»“æœ: ${planStartDate}`);
   
   // ç¬¬591è¡Œå
   console.log(`âœ… realPlanStartDateè®¡ç®—ç»“æœ: ${realPlanStartDate}`);
   
   // ç¬¬594è¡Œå
   console.log(`âœ… scheduleDateæœ€ç»ˆå€¼: ${scheduleDate}`);
   ```

2. **æŸ¥çœ‹æ—¥å¿—è¾“å‡º,å®šä½å¤±è´¥ç‚¹**

### æ–¹æ¡ˆC: æ‰‹åŠ¨æ›´æ–°å·²ç”Ÿæˆçš„è®°å½• (ä¸´æ—¶æ–¹æ¡ˆ)

**å¦‚æœéœ€è¦å¿«é€Ÿä¿®å¤å½“å‰æ•°æ®**:

```sql
-- å‡è®¾è®¡åˆ’æ’ç¨‹æ—¥æœŸåº”è¯¥æ˜¯ä»Šå¤©+1
UPDATE sewing_process_plans 
SET schedule_date = DATE_ADD(CURDATE(), INTERVAL 1 DAY),
    next_schedule_date = DATE_ADD(CURDATE(), INTERVAL 2 DAY)
WHERE schedule_date IS NULL;

-- ç„¶åæ‰‹åŠ¨è®¡ç®—å…¶ä»–å­—æ®µ
-- (éœ€è¦é€æ¡è®¡ç®—ï¼Œæ ¹æ®å®é™…æƒ…å†µ)
```

**è­¦å‘Š**: è¿™åªæ˜¯ä¸´æ—¶æ–¹æ¡ˆ,ä¸è§£å†³æ ¹æœ¬é—®é¢˜!

---

## ğŸ“Š ä¿®å¤éªŒè¯æ­¥éª¤

ä¿®å¤å,éœ€è¦éªŒè¯:

### 1. åˆ é™¤æ—§æ•°æ®
```sql
DELETE FROM sewing_process_plans WHERE schedule_date IS NULL;
```

### 2. è§¦å‘é‡æ–°æ¨é€
```sql
-- æŸ¥æ‰¾æ¥æºå·¥åº=ç¼çº«çš„å¤‡æ–™è®¡åˆ’
SELECT plan_no, material_code, replenishment_quantity
FROM material_preparation_plans
WHERE source_process = 'ç¼çº«';
```

### 3. åœ¨å‰ç«¯æ“ä½œ
- æ‰“å¼€å¤‡æ–™è®¡åˆ’é¡µé¢
- æ‰¾åˆ°æ¥æºå·¥åº=ç¼çº«çš„è®°å½•
- è§¦å‘æ¨é€åˆ°å·¥åºè®¡åˆ’
- (æˆ–è€…é€šè¿‡APIæ‰‹åŠ¨è°ƒç”¨æ¨é€æ¥å£)

### 4. éªŒè¯ç»“æœ
```sql
SELECT 
  id, plan_no, product_name, 
  schedule_date,  -- âœ… åº”è¯¥æœ‰å…·ä½“æ—¥æœŸ
  daily_total_hours,  -- âœ… åº”è¯¥>0
  daily_scheduled_hours,  -- âœ… åº”è¯¥>=0
  scheduled_work_hours,  -- âœ… åº”è¯¥>0
  next_schedule_date,  -- âœ… åº”è¯¥æœ‰å…·ä½“æ—¥æœŸ
  cumulative_schedule_qty,
  unscheduled_qty
FROM sewing_process_plans
ORDER BY id DESC
LIMIT 5;
```

**æœŸæœ›ç»“æœ**: æ‰€æœ‰æ—¥æœŸå’Œå·¥æ—¶å­—æ®µéƒ½åº”è¯¥æœ‰æ­£ç¡®çš„å€¼!

---

## ğŸ’¡ æ ¹æœ¬åŸå› æ¨æµ‹

åŸºäºé—®é¢˜åˆ†æ,æœ€å¯èƒ½çš„åŸå› æ˜¯:

### **å·¥åºèƒ½åŠ›è´Ÿè·è¡¨ç¼ºå°‘"ç¼çº«"å·¥åºæ•°æ®** â­

**è¯æ®**:
1. `schedule_date` = NULL
2. æ—¥æœŸè®¡ç®—é“¾å®Œå…¨ä¾èµ–å·¥åºèƒ½åŠ›è´Ÿè·è¡¨
3. å¦‚æœèƒ½åŠ›è´Ÿè·è¡¨æ— æ•°æ®,æ•´ä¸ªè®¡ç®—é“¾å´©æºƒ

**éªŒè¯æ–¹æ³•**:
```sql
SELECT COUNT(*) as count
FROM process_capacity_load
WHERE process_name = 'ç¼çº«';
```

å¦‚æœè¿”å›`count = 0`,é—®é¢˜ç¡®è®¤!

---

## ğŸ”§ æ¨èä¿®å¤æ­¥éª¤

### ç¬¬1æ­¥: éªŒè¯æ ¹æœ¬åŸå› 
```bash
mysql -u root -pä¼ä¸šå¤§è„‘æ•°æ®åº“å¯†ç  enterprise_brain -e "
SELECT COUNT(*) as sewing_capacity_records
FROM process_capacity_load
WHERE process_name = 'ç¼çº«';
"
```

### ç¬¬2æ­¥: æ·»åŠ ç¼çº«å·¥åºèƒ½åŠ›æ•°æ®
```bash
# è¿è¡ŒSQLè„šæœ¬æ·»åŠ æœªæ¥30å¤©çš„èƒ½åŠ›æ•°æ®
# (å…·ä½“SQLè§"æ–¹æ¡ˆA"éƒ¨åˆ†)
```

### ç¬¬3æ­¥: æ¸…ç©ºæ—§æ•°æ®
```bash
mysql -u root -på¯†ç  enterprise_brain -e "
DELETE FROM sewing_process_plans WHERE schedule_date IS NULL;
"
```

### ç¬¬4æ­¥: é‡æ–°è§¦å‘æ¨é€
- åœ¨åç«¯æ—¥å¿—ä¸­è§‚å¯Ÿæ¨é€è¿‡ç¨‹
- æ£€æŸ¥æ˜¯å¦æœ‰æŠ¥é”™
- éªŒè¯æ–°ç”Ÿæˆçš„è®°å½•å­—æ®µæ˜¯å¦æ­£ç¡®

### ç¬¬5æ­¥: å…¨é¢éªŒè¯
- æ‰“å¼€å‰ç«¯ç¼çº«å·¥åºè®¡åˆ’é¡µé¢
- æ£€æŸ¥æ‰€æœ‰å­—æ®µæ˜¯å¦æ­£å¸¸æ˜¾ç¤º
- æµ‹è¯•é€’å½’æ’ç¨‹åŠŸèƒ½æ˜¯å¦æ­£å¸¸

---

## ğŸ“‹ ç›¸å…³æ–‡ä»¶

### åç«¯
- `/backend/services/materialPreparationPlanService.js` â­ æ ¸å¿ƒæ–‡ä»¶
  - `pushToRealProcessPlan`æ–¹æ³• (ç¬¬424-800è¡Œ)
  - å­—æ®µè®¡ç®—é€»è¾‘
  
- `/backend/services/sewingProcessPlanService.js`
  - `create`æ–¹æ³• (ç¬¬195-430è¡Œ)
  
- `/backend/config/processTypes.js`
  - ç¼çº«å·¥åºé…ç½® (ç¬¬43-53è¡Œ)

### æ•°æ®åº“è¡¨
- `sewing_process_plans` - ç¼çº«å·¥åºè®¡åˆ’
- `process_capacity_load` - å·¥åºèƒ½åŠ›è´Ÿè·
- `material_preparation_plans` - å¤‡æ–™è®¡åˆ’
- `materials` - ç‰©æ–™åº“(å®šæ—¶å·¥é¢/å®šé¢å·¥æ—¶)

---

## âœ… é¢„æœŸä¿®å¤æ•ˆæœ

ä¿®å¤å,ç¼çº«å·¥åºè®¡åˆ’åº”è¯¥:

| å­—æ®µ | ä¿®å¤å‰ | ä¿®å¤å |
|-----|-------|-------|
| schedule_date | NULL âŒ | 2025-12-16 âœ… |
| daily_total_hours | 0.00 âŒ | 48.00 âœ… |
| daily_scheduled_hours | 0.00 âŒ | 8.50 âœ… |
| scheduled_work_hours | 0.00 âŒ | 8.50 âœ… |
| next_schedule_date | NULL âŒ | 2025-12-17 âœ… |
| cumulative_schedule_qty | 0.0000 âœ… | ä¿æŒæ­£ç¡® âœ… |
| unscheduled_qty | 4.0800 âœ… | ä¿æŒæ­£ç¡® âœ… |

---

**åˆ†æå®Œæˆæ—¶é—´**: 2025-12-15 20:10  
**åˆ†æäºº**: AIåŠ©æ‰‹  
**çŠ¶æ€**: ğŸ” é—®é¢˜å·²å®šä½,ç­‰å¾…ç”¨æˆ·éªŒè¯æ ¹æœ¬åŸå› å¹¶ä¿®å¤
