# 工序计划字段计算规则实现说明

## ✅ 实现完成时间
2025-12-11 15:15

## 📋 实现的计算规则

### 1. 需求工时 (requiredWorkHours)

#### 计算公式
```
需求工时 = 需补货数量(replenishmentQty) / 定时工额(standardWorkQuota)
```

#### 精度要求
- 结果保留2位小数

#### 计算时机
- **前置条件**: 需补货数量 > 0 且 定时工额 > 0
- **触发时机**: 
  - 新增工序计划时
  - 编辑工序计划时
  - 需补货数量或定时工额发生变化时(自动响应)
  - 保存前强制重新计算

#### 实现位置
- **前端**: `07-frontend/src/pages/production-planning/ProcessPlanList.vue`
  - 第603-617行: `calculateRequiredWorkHours()` 函数
  - 第678-689行: watch监听器(自动响应式计算)
  - 第233行: 表单中显示(disabled状态)
  
- **后端**: `backend/services/processPlanService.js`
  - 第138行: INSERT语句包含 `required_work_hours`
  - 第186行: 保存计算结果到数据库
  - 第212行: UPDATE语句包含 `required_work_hours`
  - 第256行: 更新计算结果到数据库

---

### 2. 计划结束日期 (planEndDate)

#### 计算规则
跨表查询工序能力负荷表,使用 **MAXIFS** 规则:

```sql
SELECT MAX(date) 
FROM process_capacity_load 
WHERE 
  process_name = 工序计划.工序名称 
  AND date <= 工序计划.计划完工日期
  AND remaining_hours >= 业务变量.剩余工时小于
```

#### 前置条件
- **必须满足**: 需求工时(requiredWorkHours) > 0

#### 查询条件
1. **工序名称匹配**: 工序能力负荷表.工序名称 = 工序计划.工序名称
2. **日期范围**: 工序能力负荷表.日期 <= 工序计划.计划完工日期
3. **剩余工时门槛**: 工序能力负荷表.剩余工时 >= 业务变量中的"剩余工时小于"设定值(默认0.5小时)

#### 返回结果
- 返回符合条件的 **最大日期**
- 如果没有符合条件的日期,返回 `null`

#### 业务变量配置
- **变量名**: 剩余工时小于
- **默认值**: 0.5 小时
- **配置位置**: 页面右上角 "业务变量" → "剩余工时小于"
- **说明**: 只有剩余工时 >= 该值的日期才会被选中

#### 实现位置
- **前端**: `07-frontend/src/pages/production-planning/ProcessPlanList.vue`
  - 第618-666行: `queryPlanEndDate()` 异步查询函数
  - 第690-704行: watch监听器(自动响应式查询)
  - 第184行: 表单中显示(disabled状态)
  
- **前端API**: `07-frontend/src/api/capacityLoad.js`
  - 第4-11行: `queryPlanEndDate()` API方法
  
- **后端API**: `backend/routes/capacityLoad.js`
  - 第130-212行: `/capacity-load/query-plan-end-date` POST接口
  - 实现MAXIFS查询逻辑

---

## 🔄 自动响应式计算流程

### 流程图

```
用户输入需补货数量 → watch监听 → 自动计算需求工时 → watch监听 → 自动查询计划结束日期
     ↓                                      ↓                           ↓
用户输入定时工额 ────────────────────────→ 需求工时更新 ────────────→ planEndDate更新
                                            ↓
                                   用户输入工序名称/计划完工日期
```

### 具体步骤

1. **用户输入**: 需补货数量 = 100, 定时工额 = 50
2. **自动触发**: watch监听到变化
3. **计算需求工时**: 100 / 50 = 2.00
4. **自动触发**: watch监听到需求工时>0
5. **查询计划结束日期**: 
   - 条件: 工序名称="组装", 计划完工日期="2025-12-20", 剩余工时>=0.5
   - 结果: planEndDate = "2025-12-18" (符合条件的最大日期)

---

## 📝 表单字段状态

| 字段名称 | 字段属性 | 是否可编辑 | 说明 |
|---------|---------|-----------|------|
| 需补货数量 | replenishmentQty | ✅ 可编辑 | 用户手动输入 |
| 定时工额 | standardWorkQuota | ✅ 可编辑 | 用户手动输入 |
| 需求工时 | requiredWorkHours | ❌ 禁用 | 自动计算,不可编辑 |
| 工序名称 | processName | ✅ 可编辑 | 用户手动输入 |
| 计划完工日期 | completionDate | ✅ 可编辑 | 用户手动选择 |
| 计划结束日期 | planEndDate | ❌ 禁用 | 自动查询,不可编辑 |

---

## 🎯 测试验证步骤

### 测试1: 需求工时计算

1. 打开工序计划页面: `http://localhost:3004/production-planning/process-plan`
2. 点击 "新增" 按钮
3. 输入以下数据:
   - 需补货数量: 100
   - 定时工额: 50
4. **预期结果**: 需求工时自动显示 `2.00`
5. 修改需补货数量为: 150
6. **预期结果**: 需求工时自动更新为 `3.00`

### 测试2: 计划结束日期查询

**前置准备**: 确保工序能力负荷表中有数据

1. 在测试1的基础上继续
2. 输入以下数据:
   - 工序名称: (选择一个存在于工序能力负荷表中的工序)
   - 计划完工日期: 2025-12-20
3. **预期结果**: 
   - 如果需求工时>0,计划结束日期自动查询并显示
   - 控制台显示查询日志
4. 修改计划完工日期
5. **预期结果**: 计划结束日期自动重新查询

### 测试3: 数据持久化

1. 完成测试1和测试2后,点击 "保存"
2. 刷新页面
3. 点击 "编辑" 按钮查看刚才保存的记录
4. **预期结果**: 
   - 需求工时正确显示为计算值
   - 计划结束日期正确显示为查询值

---

## 🐛 调试说明

### 控制台日志

所有计算和查询都会在浏览器控制台输出详细日志:

```javascript
// 需求工时计算日志
🔢 计算需求工时: { replenishmentQty: 100, standardWorkQuota: 50 }
✅ 需求工时计算结果: 100 / 50 = 2.00

// 计划结束日期查询日志
🔍 查询计划结束日期: { requiredWorkHours: 2, processName: '组装', completionDate: '2025-12-20', minRemainingHours: 0.5 }
✅ 计划结束日期查询成功: 2025-12-18, 剩余工时: 2.50

// 响应式触发日志
🔄 需补货数量或定时工额发生变化，重新计算需求工时
🔄 需求工时、工序名称或计划完工日期发生变化，重新查询计划结束日期
```

### 常见问题排查

#### 问题1: 需求工时未自动计算
- **检查**: 需补货数量和定时工额是否都>0
- **解决**: 确保两个字段都有有效值

#### 问题2: 计划结束日期为空
- **检查**: 
  1. 需求工时是否>0
  2. 工序名称是否在工序能力负荷表中存在
  3. 是否有符合剩余工时条件的日期
- **解决**: 查看控制台日志,根据提示调整数据

#### 问题3: 计算值未保存到数据库
- **检查**: 后端服务是否正常运行
- **解决**: 重启后端服务,检查后端日志

---

## 📁 相关文件清单

### 前端文件
- `07-frontend/src/pages/production-planning/ProcessPlanList.vue` - 主页面(已修改)
- `07-frontend/src/api/capacityLoad.js` - 工序能力负荷API(已存在)

### 后端文件
- `backend/services/processPlanService.js` - 工序计划服务(已修改)
- `backend/routes/capacityLoad.js` - 工序能力负荷路由(已存在)

### 数据库
- `process_plans` 表
  - `required_work_hours` 字段 (DECIMAL(18,4))
  - `plan_end_date` 字段 (DATE)
- `process_capacity_load` 表
  - 用于MAXIFS查询

---

## ✅ 实现验证清单

- [x] 需求工时计算函数实现
- [x] 需求工时响应式监听
- [x] 计划结束日期查询函数实现
- [x] 计划结束日期响应式监听
- [x] 表单字段添加(disabled状态)
- [x] 新增时自动计算
- [x] 编辑时自动计算
- [x] 保存前强制计算
- [x] 后端CREATE接口支持
- [x] 后端UPDATE接口支持
- [x] 数据库字段存在
- [x] 业务变量配置(剩余工时小于)
- [x] 详细日志输出
- [x] 后端服务重启

---

## 🎉 总结

所有计算规则已完整实现,包括:

1. ✅ **需求工时自动计算**: 需补货数量 / 定时工额,保留2位小数
2. ✅ **计划结束日期自动查询**: 跨表MAXIFS查询,支持业务变量配置
3. ✅ **响应式自动更新**: 依赖字段变化时自动重新计算/查询
4. ✅ **数据持久化**: 前后端完整支持保存和加载
5. ✅ **用户体验优化**: 字段禁用,自动计算,无需手动操作

现在可以打开工序计划页面进行测试验证! 🚀
