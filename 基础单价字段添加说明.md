# 基础单价字段添加说明

## 📅 更新时间
2025年12月2日

## 🎯 更新内容

### 一、新增字段：基础单价

**位置：** 产品物料库 → 编辑物料页面 → 采购属性

**字段名称：** 基础单价（base_price）

**计算公式：**
```
基础单价 = 采购单价 ÷ 采购转化率
```

**字段特性：**
- ✅ 只读字段（不可手动编辑）
- ✅ 自动计算（修改采购单价或采购转化率时自动更新）
- ✅ 保留2位小数
- ✅ 自动保存到数据库

---

## 📋 使用场景

### 场景说明

**问题：** 不同采购单位的价格无法直接比较

**示例：**
```
物料A：采购单价 = 100元/箱，采购转化率 = 10（1箱=10个）
物料B：采购单价 = 12元/个，采购转化率 = 1（1个=1个）

直接比较：100元 vs 12元（无法比较）
基础单价：
  物料A：100 ÷ 10 = 10元/个
  物料B：12 ÷ 1 = 12元/个
现在可以直接比较：物料A更便宜
```

**用途：**
1. **价格对比** - 统一单位后可直接比较不同物料的价格
2. **成本核算** - 基于基础单位计算成本更准确
3. **采购决策** - 快速识别最优惠的供应商

---

## 🎨 界面展示

### 编辑页面（采购属性）

```
┌────────────────────────────────────────────────┐
│ 采购属性                                        │
├────────────────────────────────────────────────┤
│                                                │
│ 采购单位：箱                                    │
│ 采购周期：7天                                   │
│ 基础单价：¥10.00  [只读，灰色背景]             │
│ 计算公式：基础单价 = 采购单价 ÷ 采购转化率      │
│                                                │
│ 采购转化率：10                                  │
│ 采购单价：¥100.00                               │
│                                                │
└────────────────────────────────────────────────┘
```

**特点：**
- 基础单价字段为**只读**（disabled状态）
- 显示**灰色背景**，明显区分可编辑字段
- 下方显示**计算公式**提示
- 修改采购单价或采购转化率时**实时更新**

---

### 查看页面（采购属性）

```
┌────────────────────────────────────────────────┐
│ 采购属性                                        │
├────────────────────────────────────────────────┤
│ 采购单位：箱                                    │
│ 采购转化率：10                                  │
│ 采购周期：7天                                   │
│ 采购单价：¥100.00                               │
│ 基础单价：¥10.00 (采购单价 ÷ 采购转化率)       │
│           ^绿色加粗    ^灰色小字说明             │
└────────────────────────────────────────────────┘
```

**特点：**
- 基础单价显示为**绿色加粗**（突出显示）
- 右侧显示**计算公式说明**（灰色小字）
- 便于快速识别基础单价

---

## 🔧 技术实现

### 1. 数据库更新

**添加字段：**
```sql
ALTER TABLE materials 
ADD COLUMN base_price REAL DEFAULT 0
```

**字段说明：**
- 字段名：`base_price`
- 数据类型：REAL（浮点数）
- 默认值：0
- 允许空值：是

**历史数据处理：**
```javascript
// 自动计算并更新所有现有物料的基础单价
UPDATE materials 
SET base_price = 
  CASE 
    WHEN purchase_conversion_rate > 0 
    THEN purchase_price / purchase_conversion_rate 
    ELSE 0 
  END
```

已更新756条物料记录的基础单价 ✅

---

### 2. 前端实现

#### 编辑页面（MaterialEdit.vue）

**计算属性：**
```javascript
// 计算属性：基础单价
const basePriceComputed = computed(() => {
  const purchasePrice = formData.purchasePrice || 0
  const purchaseConversionRate = formData.purchaseConversionRate || 1
  
  // 基础单价 = 采购单价 ÷ 采购转化率
  if (purchaseConversionRate > 0) {
    return (purchasePrice / purchaseConversionRate).toFixed(2)
  }
  return '0.00'
})
```

**变化监听：**
```javascript
// 处理采购数据变化（重新计算基础单价）
const handlePurchaseDataChange = () => {
  const purchasePrice = formData.purchasePrice || 0
  const purchaseConversionRate = formData.purchaseConversionRate || 1
  
  // 计算并更新基础单价
  if (purchaseConversionRate > 0) {
    formData.basePrice = purchasePrice / purchaseConversionRate
  } else {
    formData.basePrice = 0
  }
}
```

**UI组件：**
```vue
<el-form-item label="基础单价">
  <el-input-number 
    :model-value="basePriceComputed" 
    disabled
    :precision="2" 
    :min="0" 
    style="width: 100%;" 
  />
  <div style="font-size: 12px; color: #909399; margin-top: 4px;">
    计算公式：基础单价 = 采购单价 ÷ 采购转化率
  </div>
</el-form-item>
```

---

#### 查看页面（MaterialView.vue）

**计算属性：**
```javascript
// 计算属性：基础单价
const basePriceComputed = computed(() => {
  if (!props.materialData) return '0.00'
  
  const purchasePrice = props.materialData.purchasePrice || 0
  const purchaseConversionRate = props.materialData.purchaseConversionRate || 1
  
  // 基础单价 = 采购单价 ÷ 采购转化率
  if (purchaseConversionRate > 0) {
    return (purchasePrice / purchaseConversionRate).toFixed(2)
  }
  return '0.00'
})
```

**UI显示：**
```vue
<el-descriptions-item label="基础单价">
  <span style="color: #67c23a; font-weight: bold;">
    ¥{{ basePriceComputed }}
  </span>
  <span style="color: #909399; font-size: 12px; margin-left: 8px;">
    (采购单价 ÷ 采购转化率)
  </span>
</el-descriptions-item>
```

---

### 3. 后端实现

#### 创建物料（materialService.js）

```javascript
// 计算基础单价
const purchasePrice = materialData.purchase_price || materialData.purchasePrice || 0;
const purchaseConversionRate = materialData.purchase_conversion_rate || materialData.purchaseConversionRate || 1;
const basePrice = purchaseConversionRate > 0 ? purchasePrice / purchaseConversionRate : 0;

// 插入数据时包含base_price
INSERT INTO materials (..., purchase_price, base_price, status)
VALUES (..., ?, ?, ?)
```

#### 更新物料（materialService.js）

```javascript
// 计算基础单价
const purchasePrice = materialData.purchase_price || materialData.purchasePrice || 0;
const purchaseConversionRate = materialData.purchase_conversion_rate || materialData.purchaseConversionRate || 1;
const basePrice = purchaseConversionRate > 0 ? purchasePrice / purchaseConversionRate : 0;

// 更新数据时包含base_price
UPDATE materials SET
  ...,
  purchase_price = ?,
  base_price = ?,
  status = ?
WHERE id = ?
```

---

## 📊 计算示例

### 示例1：标准转化

```
采购单价：100元
采购转化率：10
基础单价：100 ÷ 10 = 10.00元
```

### 示例2：无转化

```
采购单价：50元
采购转化率：1
基础单价：50 ÷ 1 = 50.00元
```

### 示例3：零转化率保护

```
采购单价：100元
采购转化率：0（异常情况）
基础单价：0.00元（避免除以0错误）
```

---

## ✅ 已完成的工作

### 数据库层面
- ✅ 添加`base_price`字段到materials表
- ✅ 更新所有现有物料的基础单价（756条）
- ✅ 验证数据正确性

### 后端层面
- ✅ 更新`createMaterial`函数（支持base_price）
- ✅ 更新`updateMaterial`函数（支持base_price）
- ✅ 自动计算基础单价逻辑
- ✅ 零除保护（转化率为0时返回0）

### 前端层面
- ✅ MaterialEdit.vue添加基础单价字段（只读）
- ✅ MaterialEdit.vue添加计算公式说明
- ✅ MaterialEdit.vue添加实时计算逻辑
- ✅ MaterialView.vue添加基础单价显示
- ✅ MaterialView.vue添加绿色高亮样式

### 规则保护
- ✅ 数据备份（备份时间：2025-12-02 08:46:56）
- ✅ 字段只读（禁止手动修改）
- ✅ 自动计算（确保数据一致性）

---

## 🔍 测试验证

### 验证数据（前5条）

| 物料编码 | 物料名称 | 采购单价 | 采购转化率 | 基础单价 |
|---------|---------|---------|-----------|---------|
| 230008B | 60*48面包脚套管/EPE管 | 0.37 | 1 | 0.37 |
| 230017B | EPE套管35*25 | 0.18 | 1 | 0.18 |
| 460183A | 6006门头带武狄LOGO喷塑件 | 0 | 1 | 0 |
| 653020B | M8*16*1.5MM黑色尼龙塑料平垫 | 0.03 | 1 | 0.03 |
| 130152B | M8防松螺母黑色 | 0.02 | 1 | 0.02 |

**验证结果：** 所有数据计算正确 ✅

---

## 📝 注意事项

### 使用注意

1. **基础单价为只读字段**
   - 不要尝试手动修改
   - 修改采购单价或采购转化率会自动更新

2. **采购转化率不能为0**
   - 系统会自动保护（转化率为0时基础单价为0）
   - 建议采购转化率最小值为1

3. **数据一致性**
   - 基础单价会自动保存到数据库
   - 修改采购数据后记得保存

### 常见问题

**Q1: 基础单价显示0.00是什么原因？**
A: 可能是采购单价为0，或采购转化率为0（异常）

**Q2: 能否手动修改基础单价？**
A: 不能，基础单价是计算字段，只能通过修改采购单价或采购转化率来改变

**Q3: 修改采购单价后基础单价没更新？**
A: 需要保存物料信息后才会写入数据库，页面显示会实时更新

---

## 🎉 更新总结

### 核心价值

1. **统一价格单位** - 不同采购单位的价格可直接比较
2. **提高效率** - 无需手动计算基础价格
3. **避免错误** - 自动计算避免人工计算错误
4. **数据追溯** - 基础单价保存到数据库，可追溯历史

### 用户体验改善

- ✅ 界面清晰：只读字段明显区分
- ✅ 计算准确：自动计算，零误差
- ✅ 实时更新：修改采购数据立即看到结果
- ✅ 公式提示：用户知道如何计算

### 技术亮点

- ✅ 数据库字段自动添加并初始化
- ✅ 前后端完整实现
- ✅ 零除保护
- ✅ 历史数据自动迁移

**现在您可以在物料编辑和查看页面看到基础单价了！** 🎊
