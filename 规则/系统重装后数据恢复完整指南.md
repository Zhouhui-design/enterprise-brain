# 系统重装后数据恢复完整指南

## 紧急备份措施

### 1. 立即推送当前代码到远程
```bash
cd /home/sardensy/enterprise-brain/enterpise-brain
git add -A
git commit -m "紧急备份：修复确认下单功能和数据库字段缺失"
git push origin feature-3
```

### 2. 代码恢复流程（重装系统后）

#### 步骤1：安装必要环境
```bash
# 安装Node.js (建议18.x或20.x)
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 安装MySQL
sudo apt update
sudo apt install mysql-server
sudo mysql_secure_installation

# 安装Git
sudo apt install git
```

#### 步骤2：克隆代码仓库
```bash
# 从远程仓库克隆代码
git clone https://gitcode.com/sardenesy/enterpise-brain.git
cd enterpise-brain
git checkout feature-3

# 或者如果已有本地代码，重新关联远程仓库
git remote add origin https://gitcode.com/sardenesy/enterpise-brain.git
git fetch origin
git reset --hard origin/feature-3
```

#### 步骤3：数据库恢复
```bash
# 登录MySQL创建数据库
mysql -u root -p
CREATE DATABASE enterprise_brain CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
EXIT;

# 恢复数据库结构（代码中的初始化脚本会自动创建表）
cd backend
npm install
node server.js  # 启动服务会自动初始化数据库
```

## 已修复的问题

### 1. 销售订单创建失败
**问题**：`Unknown column 'submitter' in 'field list'`
**修复**：
```sql
ALTER TABLE sales_orders ADD COLUMN submitter VARCHAR(100) DEFAULT 'admin' COMMENT '提交人' AFTER salesperson;
ALTER TABLE sales_order_products ADD COLUMN output_process VARCHAR(100) COMMENT '产出工序' AFTER accessories;
```

### 2. 确认下单失败
**问题**：`Unknown column 'default_procurement_lead_time' in 'field list'`
**修复**：
```sql
ALTER TABLE materials ADD COLUMN default_procurement_lead_time INT DEFAULT 3 COMMENT '默认采购提前期（天）' AFTER purchase_cycle;
ALTER TABLE procurement_plans ADD COLUMN procurement_lead_time INT DEFAULT 3 COMMENT '采购提前期（天）' AFTER plan_arrival_date;
```

## 数据库完整性修复脚本

创建完整的数据库修复脚本：
```sql
-- 销售订单相关表修复
ALTER TABLE sales_orders ADD COLUMN IF NOT EXISTS submitter VARCHAR(100) DEFAULT 'admin' COMMENT '提交人' AFTER salesperson;
ALTER TABLE sales_order_products ADD COLUMN IF NOT EXISTS output_process VARCHAR(100) COMMENT '产出工序' AFTER accessories;

-- 物料和采购相关表修复
ALTER TABLE materials ADD COLUMN IF NOT EXISTS default_procurement_lead_time INT DEFAULT 3 COMMENT '默认采购提前期（天）' AFTER purchase_cycle;
ALTER TABLE procurement_plans ADD COLUMN IF NOT EXISTS procurement_lead_time INT DEFAULT 3 COMMENT '采购提前期（天）' AFTER plan_arrival_date;

-- 确保必要索引存在
CREATE INDEX IF NOT EXISTS idx_sales_orders_status ON sales_orders(status);
CREATE INDEX IF NOT EXISTS idx_sales_order_products_order_id ON sales_order_products(order_id);
CREATE INDEX IF NOT EXISTS idx_materials_material_code ON materials(material_code);
CREATE INDEX IF NOT EXISTS idx_procurement_plans_source_no ON procurement_plans(source_no);
```

## 系统重装后检查清单

### 1. 环境检查
- [ ] Node.js 18+ 已安装
- [ ] MySQL 8.0+ 已安装并运行
- [ ] Git 已配置
- [ ] 端口3003、3005、3306可用

### 2. 代码检查
- [ ] 代码从远程仓库成功拉取
- [ ] npm依赖已安装
- [ ] 配置文件正确（数据库连接等）

### 3. 数据库检查
- [ ] 数据库enterprise_brain已创建
- [ ] 所有表结构完整
- [ ] 必要字段已添加
- [ ] 索引已创建

### 4. 功能测试
- [ ] 销售订单列表页面正常
- [ ] 新增销售订单功能正常
- [ ] 确认下单功能正常
- [ ] 主生产计划推送正常
- [ ] 采购计划推送正常

## 备份策略建议

### 1. 代码备份
```bash
# 每日自动推送脚本
#!/bin/bash
cd /path/to/project
git add -A
git commit -m "自动备份 $(date +'%Y-%m-%d %H:%M:%S')"
git push origin feature-3
```

### 2. 数据库备份
```bash
# 每日数据库备份脚本
#!/bin/bash
mysqldump -u root -p enterprise_brain > /backup/enterprise_brain_$(date +%Y%m%d).sql
```

### 3. 完整恢复脚本
```bash
#!/bin/bash
# 完整系统恢复脚本
echo "开始恢复企业大脑系统..."

# 1. 恢复代码
git clone https://gitcode.com/sardenesy/enterpise-brain.git
cd enterpise-brain
git checkout feature-3

# 2. 恢复数据库
mysql -u root -p -e "CREATE DATABASE IF NOT EXISTS enterprise_brain"
mysql -u root -p enterprise_brain < /backup/enterprise_brain_latest.sql

# 3. 安装依赖并启动
npm install
npm run dev

echo "系统恢复完成！"
```

## 紧急联系方式
- 远程仓库：https://gitcode.com/sardenesy/enterpise-brain/tree/feature-3
- 本地服务：http://localhost:3003
- 数据库：localhost:3306/enterprise_brain

## 重要提醒
1. **定期推送**：每天结束工作前务必推送代码到远程
2. **数据库备份**：每周至少备份一次数据库
3. **文档同步**：重要修改要同步更新文档
4. **测试验证**：重装系统后要全面测试所有功能

---

**最后更新时间**：2025-12-18
**修复内容**：销售订单创建、确认下单功能、数据库字段缺失