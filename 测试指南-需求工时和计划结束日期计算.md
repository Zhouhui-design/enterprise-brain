# 测试指南 - 需求工时和计划结束日期计算

## 🧪 测试环境

- **页面地址**: http://localhost:3004/production-planning/process-plan
- **测试时间**: 2025-12-11
- **功能**: 需求工时自动计算 + 计划结束日期自动查询

---

## 📝 测试步骤

### 测试1: 新增工序计划 - 需求工时计算

#### 操作步骤:

1. **打开页面**: 访问 http://localhost:3004/production-planning/process-plan
2. **点击"新增"按钮**: 右上角或表格上方的"新增"按钮
3. **等待对话框打开**: 观察对话框是否完整显示
4. **输入测试数据**:
   ```
   需补货数量: 100
   定时工额: 50
   ```
5. **观察控制台**: 按F12打开浏览器开发者工具,切换到Console标签

#### 预期结果:

**控制台日志**:
```
=== handleAdd 被调用 ===
设置后的 formData: {...}
🔢 计算需求工时: { replenishmentQty: 100, standardWorkQuota: 50 }
✅ 需求工时计算结果: 100 / 50 = 2.00
```

**界面显示**:
- ✅ "需求工时"字段自动显示: `2.00`
- ✅ 该字段为禁用状态(灰色,不可编辑)

#### 动态测试:

6. **修改需补货数量**: 改为 `150`
7. **观察变化**:
   - 控制台输出: `🔄 需补货数量或定时工额发生变化，重新计算需求工时`
   - 需求工时自动更新为: `3.00` (150 / 50)

8. **修改定时工额**: 改为 `25`
9. **观察变化**:
   - 控制台输出: `🔄 需补货数量或定时工额发生变化，重新计算需求工时`
   - 需求工时自动更新为: `6.00` (150 / 25)

#### 边界测试:

10. **设置需补货数量为0**: 
    - 需求工时应显示: `0.00`
    - 控制台: `⚠️ 需求工时计算条件不满足，设为0`

11. **设置定时工额为0**:
    - 需求工时应显示: `0.00`
    - 控制台: `⚠️ 需求工时计算条件不满足，设为0`

---

### 测试2: 新增工序计划 - 计划结束日期查询

#### 前置条件:
确保工序能力负荷表中有测试数据。可以通过以下步骤检查:
1. 访问: http://localhost:3003/mrp/capacity-load
2. 确认表中有数据,记下一个工序名称(例如:"组装")

#### 操作步骤:

1. **在测试1的基础上继续**
2. **输入工序信息**:
   ```
   工序名称: 组装  (或其他存在于工序能力负荷表中的工序)
   计划完工日期: 2025-12-20  (选择一个未来日期)
   ```
3. **等待几秒**: 查询是异步的,需要等待响应

#### 预期结果:

**控制台日志**:
```
🔄 需求工时、工序名称或计划完工日期发生变化，重新查询计划结束日期
🔍 查询计划结束日期: { 
  requiredWorkHours: 6, 
  processName: '组装', 
  completionDate: '2025-12-20', 
  minRemainingHours: 0.5 
}
✅ 计划结束日期查询成功: 2025-12-18, 剩余工时: 2.50
```

**界面显示**:
- ✅ "计划结束日期"字段自动显示查询结果(例如: `2025-12-18`)
- ✅ 该字段为禁用状态(灰色,不可编辑)

#### 条件测试:

4. **设置需求工时为0** (通过设置需补货数量或定时工额为0):
   - 控制台: `⚠️ 需求工时<=0，跳过查询计划结束日期`
   - 计划结束日期清空

5. **恢复需求工时>0**:
   - 计划结束日期自动重新查询

#### 查询失败情况:

6. **输入不存在的工序名称**:
   - 控制台: `⚠️ 未找到符合条件的计划结束日期`
   - 计划结束日期显示为空

---

### 测试3: 保存并验证持久化

#### 操作步骤:

1. **在测试1和测试2的基础上**
2. **确认数据**:
   ```
   需补货数量: 150
   定时工额: 25
   需求工时: 6.00 (自动计算)
   工序名称: 组装
   计划完工日期: 2025-12-20
   计划结束日期: (自动查询的值)
   ```
3. **点击"保存"按钮**
4. **观察控制台**:
   ```
   🔢 计算需求工时: { replenishmentQty: 150, standardWorkQuota: 25 }
   ✅ 需求工时计算结果: 150 / 25 = 6.00
   🔍 查询计划结束日期: {...}
   💾 保存的数据: {
     replenishmentQty: 150,
     standardWorkQuota: 25,
     requiredWorkHours: 6,
     planEndDate: '2025-12-18'
   }
   ```
5. **等待保存成功提示**: "创建成功"

#### 验证持久化:

6. **刷新页面**: 按F5或Ctrl+R
7. **查找刚才创建的记录**: 使用搜索或翻页
8. **点击"编辑"按钮**
9. **验证数据**:
   - ✅ 需补货数量: `150`
   - ✅ 定时工额: `25`
   - ✅ 需求工时: `6.00`
   - ✅ 计划结束日期: `2025-12-18`

#### 编辑后重新计算:

10. **修改需补货数量**: 改为 `200`
11. **观察变化**:
    - 需求工时自动更新为: `8.00` (200 / 25)
    - 控制台输出重新计算日志
12. **保存修改**
13. **再次刷新验证**: 确认修改后的值已保存

---

### 测试4: 业务变量配置

#### 操作步骤:

1. **点击页面右上角"业务变量"按钮**
2. **找到"剩余工时小于"配置**
3. **当前默认值**: `0.5` 小时
4. **修改为**: `1.0` 小时
5. **保存设置**

#### 验证影响:

6. **新增工序计划**
7. **输入测试数据** (与测试2相同)
8. **观察计划结束日期查询**:
   - 控制台显示: `minRemainingHours: 1.0`
   - 查询结果可能不同(因为筛选条件更严格)

---

## 🐛 故障排查

### 问题1: 需求工时未计算

**症状**: 输入需补货数量和定时工额后,需求工时仍为空或0

**检查步骤**:
1. 打开浏览器控制台(F12)
2. 查看是否有JavaScript错误
3. 确认是否有日志输出: `🔢 计算需求工时`

**可能原因**:
- 前端代码未正确加载
- watch监听器未触发
- 计算函数有异常

**解决方法**:
1. 刷新页面(Ctrl+Shift+R 强制刷新)
2. 清除浏览器缓存
3. 检查网络请求是否正常

---

### 问题2: 计划结束日期未查询

**症状**: 输入工序名称和计划完工日期后,计划结束日期为空

**检查步骤**:
1. 确认需求工时 > 0
2. 查看控制台是否有错误
3. 检查网络请求: 切换到Network标签,筛选XHR

**可能原因**:
- 需求工时=0(前置条件不满足)
- 工序能力负荷表中没有该工序数据
- 没有符合剩余工时条件的日期
- 后端API异常

**解决方法**:
1. 确保需求工时>0
2. 访问工序能力负荷表页面,确认有数据
3. 查看控制台日志中的查询参数
4. 检查Network中的API响应

---

### 问题3: 保存后数据丢失

**症状**: 保存成功,但刷新后编辑,字段值为空

**检查步骤**:
1. 查看保存时的控制台日志
2. 检查Network中的保存请求
3. 查看请求payload是否包含字段值

**可能原因**:
- 前端未正确传递字段值
- 后端未正确保存字段值
- 数据库字段不存在

**解决方法**:
1. 检查前端保存前的日志: `💾 保存的数据`
2. 检查后端是否正常运行
3. 检查数据库字段是否存在

---

## ✅ 测试检查清单

完成测试后,请确认以下项目:

- [ ] 需求工时在新增时自动计算
- [ ] 需求工时在编辑时自动计算
- [ ] 需补货数量变化时需求工时自动更新
- [ ] 定时工额变化时需求工时自动更新
- [ ] 需求工时字段为禁用状态
- [ ] 计划结束日期在满足条件时自动查询
- [ ] 计划结束日期字段为禁用状态
- [ ] 工序名称变化时计划结束日期自动重新查询
- [ ] 计划完工日期变化时计划结束日期自动重新查询
- [ ] 需求工时=0时不查询计划结束日期
- [ ] 保存时计算值正确传递
- [ ] 保存后刷新数据正确回显
- [ ] 编辑后重新计算功能正常
- [ ] 业务变量配置生效
- [ ] 控制台日志完整输出

---

## 📊 预期性能

- **计算响应**: < 50ms (即时)
- **查询响应**: < 500ms (依赖网络和数据库)
- **保存响应**: < 1s

---

## 📞 技术支持

如果测试过程中遇到问题,请提供:

1. **浏览器信息**: Chrome/Firefox/Edge版本
2. **控制台日志**: 完整的Console输出
3. **网络请求**: Network标签中相关请求的详情
4. **操作步骤**: 详细的复现步骤
5. **截图**: 问题界面和控制台截图

---

## 🎯 测试通过标准

所有检查清单项目打勾 ✅ = 测试通过

祝测试顺利! 🚀
