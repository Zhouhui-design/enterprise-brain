# é”€å”®è®¢å•åˆ é™¤çº§è”æ‰€æœ‰å·¥åºè®¡åˆ’ä¿®å¤æŠ¥å‘Š

**æ—¥æœŸ**: 2025-12-16 06:25  
**ä¿®å¤å†…å®¹**: é”€å”®è®¢å•åˆ é™¤æ—¶çº§è”åˆ é™¤æ‰€æœ‰å·¥åºè®¡åˆ’è¡¨  
**ä¿®å¤åŸå› **: ä¹‹å‰åªåˆ é™¤çœŸå·¥åºè®¡åˆ’(æ‰“åŒ…)ï¼Œç¼ºå°‘ç»„è£…ã€å–·å¡‘ã€ç¼çº«å·¥åºè®¡åˆ’çš„çº§è”åˆ é™¤

---

## âœ… ä¿®å¤å†…å®¹

### é—®é¢˜æè¿°
é”€å”®è®¢å•åˆ é™¤æ—¶ï¼Œåªçº§è”åˆ é™¤äº†ä»¥ä¸‹è¡¨ï¼š
- `master_production_plans` - ä¸»ç”Ÿäº§è®¡åˆ’
- `material_preparation_plans` - å¤‡æ–™è®¡åˆ’  
- `process_plans` - å·¥åºè®¡åˆ’ï¼ˆæ—§è¡¨ï¼‰
- `real_process_plans` - æ‰“åŒ…å·¥åºè®¡åˆ’

**ç¼ºå¤±çš„çº§è”åˆ é™¤**ï¼š
- âŒ `assembly_process_plans` - ç»„è£…å·¥åºè®¡åˆ’
- âŒ `spray_painting_process_plans` - å–·å¡‘å·¥åºè®¡åˆ’
- âŒ `sewing_process_plans` - ç¼çº«å·¥åºè®¡åˆ’

è¿™å¯¼è‡´åˆ é™¤é”€å”®è®¢å•åï¼Œç»„è£…ã€å–·å¡‘ã€ç¼çº«å·¥åºè®¡åˆ’çš„æ•°æ®æ®‹ç•™ï¼Œæ•°æ®ä¸ä¸€è‡´ã€‚

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹çš„æ¥å£

#### 1. å•ä¸ªåˆ é™¤æ¥å£
**è·¯å¾„**: `DELETE /api/sales-orders/:id`

**æ–°å¢ä»£ç **ï¼š
```javascript
// âœ… çº§è”åˆ é™¤ç»„è£…å·¥åºè®¡åˆ’
const [assemblyPlanResult] = await connection.execute(
  'DELETE FROM assembly_process_plans WHERE sales_order_no = ?',
  [internalOrderNo]
);
console.log(`âœ… çº§è”åˆ é™¤ç»„è£…å·¥åºè®¡åˆ’: ${assemblyPlanResult.affectedRows} æ¡`);

// âœ… çº§è”åˆ é™¤å–·å¡‘å·¥åºè®¡åˆ’
const [sprayPaintingPlanResult] = await connection.execute(
  'DELETE FROM spray_painting_process_plans WHERE sales_order_no = ?',
  [internalOrderNo]
);
console.log(`âœ… çº§è”åˆ é™¤å–·å¡‘å·¥åºè®¡åˆ’: ${sprayPaintingPlanResult.affectedRows} æ¡`);

// âœ… çº§è”åˆ é™¤ç¼çº«å·¥åºè®¡åˆ’
const [sewingPlanResult] = await connection.execute(
  'DELETE FROM sewing_process_plans WHERE sales_order_no = ?',
  [internalOrderNo]
);
console.log(`âœ… çº§è”åˆ é™¤ç¼çº«å·¥åºè®¡åˆ’: ${sewingPlanResult.affectedRows} æ¡`);
```

**æ›´æ–°è¿”å›æ¶ˆæ¯**ï¼š
```javascript
message: `åˆ é™¤è®¢å•æˆåŠŸï¼ˆåŒæ—¶åˆ é™¤ ${masterPlanResult.affectedRows} æ¡ä¸»ç”Ÿäº§è®¡åˆ’ã€${materialPlanResult.affectedRows} æ¡å¤‡æ–™è®¡åˆ’ã€${processPlanResult.affectedRows} æ¡å·¥åºè®¡åˆ’ã€${realProcessPlanResult.affectedRows} æ¡æ‰“åŒ…å·¥åºè®¡åˆ’ã€${assemblyPlanResult.affectedRows} æ¡ç»„è£…å·¥åºè®¡åˆ’ã€${sprayPaintingPlanResult.affectedRows} æ¡å–·å¡‘å·¥åºè®¡åˆ’ã€${sewingPlanResult.affectedRows} æ¡ç¼çº«å·¥åºè®¡åˆ’ï¼‰`
```

#### 2. æ‰¹é‡åˆ é™¤æ¥å£
**è·¯å¾„**: `POST /api/sales-orders/batch-delete`

**æ–°å¢å˜é‡**ï¼š
```javascript
let totalAssemblyPlans = 0
let totalSprayPaintingPlans = 0
let totalSewingPlans = 0
```

**æ–°å¢çº§è”åˆ é™¤é€»è¾‘**ï¼š
```javascript
// 4.1 çº§è”åˆ é™¤ç»„è£…å·¥åºè®¡åˆ’
const [assemblyPlanResult] = await connection.execute(
  'DELETE FROM assembly_process_plans WHERE sales_order_no = ?',
  [internalOrderNo]
);
totalAssemblyPlans += assemblyPlanResult.affectedRows;

// 4.2 çº§è”åˆ é™¤å–·å¡‘å·¥åºè®¡åˆ’
const [sprayPaintingPlanResult] = await connection.execute(
  'DELETE FROM spray_painting_process_plans WHERE sales_order_no = ?',
  [internalOrderNo]
);
totalSprayPaintingPlans += sprayPaintingPlanResult.affectedRows;

// 4.3 çº§è”åˆ é™¤ç¼çº«å·¥åºè®¡åˆ’
const [sewingPlanResult] = await connection.execute(
  'DELETE FROM sewing_process_plans WHERE sales_order_no = ?',
  [internalOrderNo]
);
totalSewingPlans += sewingPlanResult.affectedRows;
```

**æ›´æ–°è¿”å›æ•°æ®**ï¼š
```javascript
res.json({
  success: true,
  message: `æˆåŠŸåˆ é™¤ ${ids.length} ä¸ªè®¢å•ï¼ˆåŒæ—¶åˆ é™¤ ${totalMasterPlans} æ¡ä¸»ç”Ÿäº§è®¡åˆ’ã€${totalMaterialPlans} æ¡å¤‡æ–™è®¡åˆ’ã€${totalProcessPlans} æ¡å·¥åºè®¡åˆ’ã€${totalRealProcessPlans} æ¡æ‰“åŒ…å·¥åºè®¡åˆ’ã€${totalAssemblyPlans} æ¡ç»„è£…å·¥åºè®¡åˆ’ã€${totalSprayPaintingPlans} æ¡å–·å¡‘å·¥åºè®¡åˆ’ã€${totalSewingPlans} æ¡ç¼çº«å·¥åºè®¡åˆ’ï¼‰`,
  data: {
    deletedCount: ids.length,
    masterPlansDeleted: totalMasterPlans,
    materialPlansDeleted: totalMaterialPlans,
    processPlansDeleted: totalProcessPlans,
    realProcessPlansDeleted: totalRealProcessPlans,
    assemblyPlansDeleted: totalAssemblyPlans,
    sprayPaintingPlansDeleted: totalSprayPaintingPlans,
    sewingPlansDeleted: totalSewingPlans
  }
})
```

---

## ğŸ“Š å®Œæ•´çš„çº§è”åˆ é™¤é“¾è·¯

```
é”€å”®è®¢å•åˆ é™¤
    â†“ è‡ªåŠ¨è§¦å‘
â”œâ”€ ä¸»ç”Ÿäº§è®¡åˆ’ï¼ˆåŒæ­¥åˆ é™¤ï¼‰
â”œâ”€ å¤‡æ–™è®¡åˆ’ï¼ˆåŒæ­¥åˆ é™¤ï¼‰
â”œâ”€ å·¥åºè®¡åˆ’ï¼ˆåŒæ­¥åˆ é™¤ - æ—§è¡¨ï¼‰
â”œâ”€ æ‰“åŒ…å·¥åºè®¡åˆ’ï¼ˆåŒæ­¥åˆ é™¤ï¼‰âœ…
â”œâ”€ ç»„è£…å·¥åºè®¡åˆ’ï¼ˆåŒæ­¥åˆ é™¤ï¼‰âœ… æ–°å¢
â”œâ”€ å–·å¡‘å·¥åºè®¡åˆ’ï¼ˆåŒæ­¥åˆ é™¤ï¼‰âœ… æ–°å¢
â””â”€ ç¼çº«å·¥åºè®¡åˆ’ï¼ˆåŒæ­¥åˆ é™¤ï¼‰âœ… æ–°å¢
```

### åŒ¹é…è§„åˆ™

| ç›®æ ‡è¡¨ | åŒ¹é…å­—æ®µ | åŒ¹é…è§„åˆ™ | å·¥åºç±»å‹ |
|--------|---------|---------|---------|
| `master_production_plans` | `internal_order_no` | = é”€å”®è®¢å•çš„`internal_order_no` | - |
| `material_preparation_plans` | `sales_order_no` | = é”€å”®è®¢å•çš„`internal_order_no` | - |
| `process_plans` | `sales_order_no` | = é”€å”®è®¢å•çš„`internal_order_no` | æ—§è¡¨ |
| `real_process_plans` | `sales_order_no` | = é”€å”®è®¢å•çš„`internal_order_no` | æ‰“åŒ… |
| **`assembly_process_plans`** | **`sales_order_no`** | **= é”€å”®è®¢å•çš„`internal_order_no`** | **ç»„è£…** âœ… |
| **`spray_painting_process_plans`** | **`sales_order_no`** | **= é”€å”®è®¢å•çš„`internal_order_no`** | **å–·å¡‘** âœ… |
| **`sewing_process_plans`** | **`sales_order_no`** | **= é”€å”®è®¢å•çš„`internal_order_no`** | **ç¼çº«** âœ… |

---

## ğŸ§ª éªŒè¯æ–¹æ³•

### 1. å‡†å¤‡æµ‹è¯•æ•°æ®

1. åˆ›å»ºé”€å”®è®¢å•å¹¶æ­£å¼ä¸‹å•
2. æ‰§è¡Œæ’ç¨‹ï¼Œç”Ÿæˆå¤‡æ–™è®¡åˆ’
3. ä»å¤‡æ–™è®¡åˆ’æ¨é€åˆ°å„å·¥åºè®¡åˆ’ï¼š
   - ç»„è£…å·¥åºè®¡åˆ’
   - å–·å¡‘å·¥åºè®¡åˆ’
   - ç¼çº«å·¥åºè®¡åˆ’ï¼ˆå¦‚æœå¯ç”¨ï¼‰
   - æ‰“åŒ…å·¥åºè®¡åˆ’

### 2. åˆ é™¤å‰æŸ¥è¯¢

```sql
-- æŸ¥è¯¢é”€å”®è®¢å•ç¼–å·
SELECT internal_order_no FROM sales_orders WHERE id = 123;
-- å‡è®¾ç»“æœï¼šSO2025000001

-- æŸ¥è¯¢å„å·¥åºè®¡åˆ’è¡¨
SELECT COUNT(*) FROM assembly_process_plans WHERE sales_order_no = 'SO2025000001';
SELECT COUNT(*) FROM spray_painting_process_plans WHERE sales_order_no = 'SO2025000001';
SELECT COUNT(*) FROM sewing_process_plans WHERE sales_order_no = 'SO2025000001';
SELECT COUNT(*) FROM real_process_plans WHERE sales_order_no = 'SO2025000001';
```

### 3. æ‰§è¡Œåˆ é™¤

- åœ¨é”€å”®è®¢å•åˆ—è¡¨é¡µé¢ï¼Œé€‰æ‹©è®¢å•
- ç‚¹å‡»"åˆ é™¤"æŒ‰é’®
- ç¡®è®¤åˆ é™¤

### 4. åˆ é™¤åéªŒè¯

```sql
-- éªŒè¯æ‰€æœ‰å·¥åºè®¡åˆ’å·²è¢«åˆ é™¤
SELECT COUNT(*) FROM assembly_process_plans WHERE sales_order_no = 'SO2025000001';
-- æœŸæœ›ç»“æœ: 0

SELECT COUNT(*) FROM spray_painting_process_plans WHERE sales_order_no = 'SO2025000001';
-- æœŸæœ›ç»“æœ: 0

SELECT COUNT(*) FROM sewing_process_plans WHERE sales_order_no = 'SO2025000001';
-- æœŸæœ›ç»“æœ: 0

SELECT COUNT(*) FROM real_process_plans WHERE sales_order_no = 'SO2025000001';
-- æœŸæœ›ç»“æœ: 0
```

### 5. åç«¯æ—¥å¿—éªŒè¯

**é¢„æœŸæ—¥å¿—è¾“å‡º**ï¼š
```
=== åˆ é™¤é”€å”®è®¢å• === 123
ğŸ—‘ï¸ åˆ é™¤è®¢å•: { id: 123, internalOrderNo: 'SO2025000001' }
âœ… çº§è”åˆ é™¤ä¸»ç”Ÿäº§è®¡åˆ’: 2 æ¡
âœ… çº§è”åˆ é™¤å¤‡æ–™è®¡åˆ’: 5 æ¡
âœ… çº§è”åˆ é™¤å·¥åºè®¡åˆ’: 0 æ¡
âœ… çº§è”åˆ é™¤ç»„è£…å·¥åºè®¡åˆ’: 3 æ¡
âœ… çº§è”åˆ é™¤å–·å¡‘å·¥åºè®¡åˆ’: 2 æ¡
âœ… çº§è”åˆ é™¤ç¼çº«å·¥åºè®¡åˆ’: 0 æ¡
âœ… çº§è”åˆ é™¤æ‰“åŒ…å·¥åºè®¡åˆ’: 1 æ¡
âœ… è®¢å•åˆ é™¤æˆåŠŸ
```

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### åç«¯
- `backend/routes/salesOrders.js`
  - å•ä¸ªåˆ é™¤æ¥å£: `DELETE /:id`ï¼ˆç¬¬620-746è¡Œï¼‰
  - æ‰¹é‡åˆ é™¤æ¥å£: `POST /batch-delete`ï¼ˆç¬¬763-970è¡Œï¼‰

### æ•°æ®åº“è¡¨
- `sales_orders` - é”€å”®è®¢å•è¡¨
- `master_production_plans` - ä¸»ç”Ÿäº§è®¡åˆ’è¡¨
- `material_preparation_plans` - å¤‡æ–™è®¡åˆ’è¡¨
- `process_plans` - å·¥åºè®¡åˆ’è¡¨ï¼ˆæ—§è¡¨ï¼‰
- `real_process_plans` - æ‰“åŒ…å·¥åºè®¡åˆ’è¡¨
- `assembly_process_plans` - ç»„è£…å·¥åºè®¡åˆ’è¡¨ âœ…
- `spray_painting_process_plans` - å–·å¡‘å·¥åºè®¡åˆ’è¡¨ âœ…
- `sewing_process_plans` - ç¼çº«å·¥åºè®¡åˆ’è¡¨ âœ…

---

## âš ï¸ é‡è¦è¯´æ˜

### 1. é€šç”¨è§„åˆ™ï¼ˆå·²åŠ å…¥è®°å¿†ï¼‰

**è§„åˆ™åç§°**: é”€å”®è®¢å•åˆ é™¤çº§è”æ‰€æœ‰å·¥åºè®¡åˆ’

**è§„åˆ™å†…å®¹**:
- é”€å”®è®¢å•åˆ é™¤æ—¶ï¼Œå¿…é¡»çº§è”åˆ é™¤**æ‰€æœ‰å·¥åºè®¡åˆ’è¡¨**çš„ç›¸å…³è®°å½•
- åŒ¹é…å­—æ®µï¼š`sales_order_no` = é”€å”®è®¢å•çš„ `internal_order_no`
- å·¥åºè®¡åˆ’è¡¨åŒ…æ‹¬ï¼š
  - `real_process_plans` - æ‰“åŒ…å·¥åºè®¡åˆ’
  - `assembly_process_plans` - ç»„è£…å·¥åºè®¡åˆ’
  - `spray_painting_process_plans` - å–·å¡‘å·¥åºè®¡åˆ’
  - `sewing_process_plans` - ç¼çº«å·¥åºè®¡åˆ’
  - ä»¥åŠä»»ä½•æœªæ¥æ–°å¢çš„å·¥åºè®¡åˆ’è¡¨

**é€‚ç”¨åœºæ™¯**:
- å•ä¸ªåˆ é™¤é”€å”®è®¢å•
- æ‰¹é‡åˆ é™¤é”€å”®è®¢å•
- ä»»ä½•éœ€è¦åˆ é™¤é”€å”®è®¢å•çš„åœºæ™¯

### 2. äº‹åŠ¡ä¸€è‡´æ€§
- æ‰¹é‡åˆ é™¤ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡
- ç¡®ä¿æ‰€æœ‰æ“ä½œ**å…¨éƒ¨æˆåŠŸ**æˆ–**å…¨éƒ¨å›æ»š**
- é¿å…æ•°æ®ä¸ä¸€è‡´

### 3. å·¥åºèƒ½åŠ›è´Ÿè·è¡¨é‡Šæ”¾
- åˆ é™¤æ‰“åŒ…å·¥åºè®¡åˆ’æ—¶ï¼Œä¼šè‡ªåŠ¨é‡Šæ”¾å·¥åºèƒ½åŠ›è´Ÿè·è¡¨çš„å·²å ç”¨å·¥æ—¶
- ä½¿ç”¨SUMIFé‡æ–°è®¡ç®—å·²å ç”¨å·¥æ—¶
- å…¶ä»–å·¥åºè®¡åˆ’è¡¨ï¼ˆç»„è£…ã€å–·å¡‘ã€ç¼çº«ï¼‰æš‚æ—¶ä¸é‡Šæ”¾å·¥æ—¶ï¼ˆå¯æ ¹æ®éœ€è¦æ‰©å±•ï¼‰

---

## ğŸ¯ ä¸šåŠ¡ä»·å€¼

1. âœ… **æ•°æ®ä¸€è‡´æ€§**: ç¡®ä¿åˆ é™¤é”€å”®è®¢å•åï¼Œæ‰€æœ‰ä¸‹çº§æ•°æ®éƒ½è¢«æ¸…ç†
2. âœ… **è‡ªåŠ¨åŒ–**: æ— éœ€æ‰‹åŠ¨åˆ é™¤å„å·¥åºè®¡åˆ’è¡¨çš„æ•°æ®
3. âœ… **é€šç”¨è§„åˆ™**: é€‚ç”¨äºæ‰€æœ‰å·¥åºè®¡åˆ’è¡¨ï¼ŒåŒ…æ‹¬æœªæ¥æ–°å¢çš„å·¥åº
4. âœ… **äº‹åŠ¡å®‰å…¨**: æ‰¹é‡åˆ é™¤ä½¿ç”¨äº‹åŠ¡ï¼Œå¤±è´¥è‡ªåŠ¨å›æ»š
5. âœ… **æ—¥å¿—å®Œå–„**: è¯¦ç»†è®°å½•æ¯ä¸ªè¡¨çš„åˆ é™¤æ•°é‡

---

## ğŸš€ éƒ¨ç½²çŠ¶æ€

- âœ… åç«¯ä»£ç å·²ä¿®æ”¹
- âœ… åç«¯æœåŠ¡å·²é‡å¯
- âœ… è¿œç¨‹å¤‡ä»½å·²å®Œæˆï¼ˆcommit: 104a4b5ï¼‰
- âœ… ä¿®å¤æŠ¥å‘Šå·²ç”Ÿæˆ

---

**åŠŸèƒ½çŠ¶æ€**: âœ… å·²å®ç°å¹¶éƒ¨ç½²  
**æ›´æ–°æ—¶é—´**: 2025-12-16 06:25  
**å…³é”®ä¿®å¤**: ç»„è£…ã€å–·å¡‘ã€ç¼çº«å·¥åºè®¡åˆ’çº§è”åˆ é™¤ âœ…

