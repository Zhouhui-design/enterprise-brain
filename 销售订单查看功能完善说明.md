# 销售订单查看功能完善说明

## 完成时间
2025-12-05

## 需求说明

用户要求:
> 在销售订单点击查看按钮,需要能看到订单详情页中的所有信息,要和编辑销售订单中的信息一样,编辑销售订单与销售订单详情页的区别是一个可编辑,一个不可编辑,字段排版都是一样的

## 实现内容

### 1. 重写销售订单查看页面

**文件**: `/07-frontend/src/pages/sales/sales-order/SalesOrderView.vue`

**核心特点**:
- ✅ 字段排版与编辑页面(**SalesOrderCreate.vue**)完全一致
- ✅ 使用相同的卡片布局和分组结构
- ✅ 所有表单字段设为`disabled`(不可编辑)
- ✅ 支持查看产品明细表格
- ✅ 支持查看回款计划表格

**布局结构** (与编辑页面一致):
```
订单详情标签页
├── 基本信息卡片
│   ├── 内部订单编号
│   ├── 客户订单编号
│   ├── 客户名称
│   ├── 销售员
│   ├── 报价单号
│   └── 订单类型
├── 时间信息卡片
│   ├── 下单时间
│   ├── 承诺交期
│   ├── 客户交期
│   └── 预计完成日期
├── 部门信息卡片
│   ├── 销售部门
│   ├── 送货方式
│   └── 销售退货单号
├── 金额信息卡片
│   ├── 订单币种
│   ├── 当前汇率
│   ├── 税率
│   ├── 手续费
│   ├── 订单总金额
│   ├── 总金额(未税)
│   └── 总税额
├── 附件和备注卡片
│   ├── 订单附件
│   ├── 包装附件
│   └── 订单说明
├── 包装信息卡片
│   ├── 包装方式
│   └── 包装需求描述
├── 收货信息卡片
│   ├── 收货人
│   ├── 收货地址
│   ├── 账单收件人
│   └── 账单收件地址
├── 产品信息卡片
│   └── 产品明细表格
│       ├── 序号
│       ├── 产品编号
│       ├── 产品名称
│       ├── 规格
│       ├── 颜色
│       ├── 单位
│       ├── 订单数量
│       ├── 销售单价(未税)
│       └── 税率
├── 回款信息卡片
│   ├── 收款方式
│   ├── 预收占比
│   ├── 预收金额
│   ├── 计划回款账户
│   ├── 应回款总额
│   └── 回款计划表格
│       ├── 序号
│       ├── 回款比例
│       ├── 回款金额
│       ├── 计划回款日期
│       └── 回款账户
└── 售后信息卡片
    ├── 是否有售后
    ├── 售后订单号
    └── 售后详情
```

### 2. 扩展前端API

**文件**: `/07-frontend/src/api/salesOrder.js`

**新增方法**:
```javascript
// 获取订单详情(别名,与查看页面兼容)
getOrderDetail(id) {
  return axios.get(`${API_BASE_URL}/sales-orders/${id}`).then(res => res.data)
}

// 获取订单产品明细
getOrderProducts(orderId) {
  return axios.get(`${API_BASE_URL}/sales-orders/${orderId}/products`).then(res => res.data)
}

// 获取订单回款计划
getOrderPayments(orderId) {
  return axios.get(`${API_BASE_URL}/sales-orders/${orderId}/payments`).then(res => res.data)
}
```

### 3. 扩展后端API

**文件**: `/backend/routes/salesOrders.js`

**新增路由**:

#### 获取订单产品明细
```javascript
/**
 * 获取订单产品明细
 * GET /api/sales-orders/:id/products
 */
router.get('/:id/products', async (req, res) => {
  // 从 sales_order_products 表查询
  const [products] = await connection.execute(
    'SELECT * FROM sales_order_products WHERE order_id = ?', 
    [id]
  )
  
  res.json({
    success: true,
    data: products
  })
})
```

#### 获取订单回款计划
```javascript
/**
 * 获取订单回款计划
 * GET /api/sales-orders/:id/payments
 */
router.get('/:id/payments', async (req, res) => {
  // 从 sales_order_payment_schedule 表查询
  const [payments] = await connection.execute(
    'SELECT * FROM sales_order_payment_schedule WHERE order_id = ?', 
    [id]
  )
  
  res.json({
    success: true,
    data: payments
  })
})
```

## 关键技术实现

### 1. 字段兼容性处理

由于数据库字段使用下划线命名(如`customer_name`),而某些前端可能使用驼峰命名(如`customerName`),查看页面同时支持两种格式:

```vue
<el-input :model-value="orderData.customer_name || orderData.customerName" disabled />
```

### 2. 日期格式化

```javascript
// 格式化日期时间
const formatDateTime = (value) => {
  if (!value) return ''
  const date = new Date(value)
  return date.toLocaleString('zh-CN', { 
    year: 'numeric', 
    month: '2-digit', 
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit'
  })
}

// 格式化日期
const formatDate = (value) => {
  if (!value) return ''
  const date = new Date(value)
  return date.toLocaleDateString('zh-CN')
}
```

### 3. 数据加载流程

```javascript
onMounted(async () => {
  // 1. 加载订单主信息
  const response = await salesOrderApi.getOrderDetail(props.orderId)
  orderData.value = response.data
  
  // 2. 加载产品明细
  const productsResponse = await salesOrderApi.getOrderProducts(props.orderId)
  productList.value = productsResponse.data || []
  
  // 3. 加载回款计划
  const paymentsResponse = await salesOrderApi.getOrderPayments(props.orderId)
  paymentScheduleList.value = paymentsResponse.data || []
})
```

### 4. 只读样式优化

```css
.view-form :deep(.el-input.is-disabled .el-input__wrapper) {
  background-color: #f5f7fa;
  cursor: default;
}

.view-form :deep(.el-textarea.is-disabled .el-textarea__inner) {
  background-color: #f5f7fa;
  cursor: default;
}
```

## API测试验证

### 测试订单详情API
```bash
curl 'http://localhost:3005/api/sales-orders/b6a3b8c6-e60a-42e1-a2b7-cc0a77936890'
```

**响应**:
```json
{
  "success": true,
  "data": {
    "id": "b6a3b8c6-e60a-42e1-a2b7-cc0a77936890",
    "internal_order_no": "SO2025000001",
    "customer_name": "测试客户001",
    "order_time": "2025-12-04T18:39:11.000Z",
    "products": [...],
    "paymentSchedule": [...]
  }
}
```

### 测试产品明细API
```bash
curl 'http://localhost:3005/api/sales-orders/b6a3b8c6-e60a-42e1-a2b7-cc0a77936890/products'
```

**响应**:
```json
{
  "success": true,
  "data": [
    {
      "product_code": "6001A0306",
      "product_name": "6001A0306,铁质方向盘款,嘉博",
      "order_quantity": "100.00",
      ...
    }
  ]
}
```

### 测试回款计划API
```bash
curl 'http://localhost:3005/api/sales-orders/b6a3b8c6-e60a-42e1-a2b7-cc0a77936890/payments'
```

**响应**:
```json
{
  "success": true,
  "data": []
}
```

## 使用说明

### 1. 查看订单详情

在销售订单列表页面:
1. 找到要查看的订单
2. 点击"查看"按钮
3. 弹出查看对话框,显示完整订单信息

### 2. 关闭查看页面

点击底部的"关闭"按钮即可关闭查看页面。

## 与编辑页面的对比

| 特性 | 编辑页面(SalesOrderCreate.vue) | 查看页面(SalesOrderView.vue) |
|------|-------------------------------|------------------------------|
| 字段排版 | ✅ 相同 | ✅ 相同 |
| 卡片布局 | ✅ 相同 | ✅ 相同 |
| 字段分组 | ✅ 相同 | ✅ 相同 |
| 产品表格 | ✅ 可编辑 | ✅ 只读展示 |
| 回款表格 | ✅ 可编辑 | ✅ 只读展示 |
| 表单控件 | `<el-input v-model>` | `<el-input :model-value disabled>` |
| 操作按钮 | 保存、提交 | 关闭 |

## 优势特点

### 1. 用户体验一致
- 编辑和查看页面使用相同的布局
- 用户无需适应不同的界面风格
- 快速定位所需信息

### 2. 信息完整性
- 显示所有订单字段
- 包含产品明细表格
- 包含回款计划表格
- 不遗漏任何重要信息

### 3. 视觉区分
- 只读字段使用灰色背景
- 明确告知用户当前为查看模式
- 避免误操作

### 4. 性能优化
- 独立的API请求产品和回款数据
- 支持异步加载
- 数据获取更高效

## 相关文件清单

### 前端文件
- `/07-frontend/src/pages/sales/sales-order/SalesOrderView.vue` - 查看页面(已重写)
- `/07-frontend/src/pages/sales/sales-order/SalesOrderCreate.vue` - 编辑页面(参考)
- `/07-frontend/src/api/salesOrder.js` - API服务(已扩展)

### 后端文件
- `/backend/routes/salesOrders.js` - 订单路由(已扩展)

### 数据库表
- `sales_orders` - 销售订单主表
- `sales_order_products` - 订单产品明细表
- `sales_order_payment_schedule` - 回款计划表

## 后续扩展建议

### 如有需要,可以添加:
1. **打印功能**: 添加打印按钮,打印订单详情
2. **导出功能**: 导出订单为PDF或Excel
3. **操作日志**: 显示订单的修改历史
4. **相关单据**: 显示关联的发货单、发票等
5. **快捷操作**: 在查看页面直接进入编辑模式

## 总结

✅ 查看页面与编辑页面字段排版完全一致
✅ 所有字段均为只读,不可编辑
✅ 支持查看产品明细和回款计划
✅ 数据加载流程完整,无遗漏
✅ API接口完善,支持独立查询

用户现在可以通过查看按钮查看订单的完整信息,体验与编辑页面一致,只是不能修改数据。
