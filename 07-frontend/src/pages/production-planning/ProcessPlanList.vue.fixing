<template>
  <StandardTablePage
    page-title="å·¥åºè®¡åˆ’åˆ—è¡¨"
    settings-key="processPlanListV2"
    :table-data="tableData"
    :columns="allColumns"
    :loading="loading"
    :total="pagination.total"
    :current-page="pagination.page"
    :page-size="pagination.pageSize"
    :show-create="true"
    :show-page-settings="true"
    :show-selection="true"
    :show-filter="true"
    :show-pagination="true"
    :show-enhanced-toolbar="true"
    :show-add="false"
    :show-batch-delete="true"
    :show-export="true"
    :show-import="true"
    :show-print="true"
    :show-breadcrumb="true"
    :breadcrumb-items="breadcrumbItems"
    :show-business-vars="true"
    :disable-column-settings="true"
    :business-var-buttons="businessVarButtons"
    :business-var-selects="businessVarSelects"
    :default-settings="defaultSettings"
    @create="handleAdd"
    @selection-change="handleSelectionChange"
    @page-change="handlePageChange"
    @size-change="handleSizeChange"
    @batch-delete="handleBatchDelete"
    @export="handleExport"
    @import="handleImport"
    @refresh="loadData"
    @settings-save="handleSavePageSettings"
  >
    <!-- æœç´¢è¡¨å• -->
    <template #search-form>
      <el-form :inline="true" :model="searchForm" size="small">
        <el-form-item label="å·¥åºè®¡åˆ’ç¼–å·">
          <el-input 
            ref="searchInputRef"
            v-model="searchForm.planNo" 
            placeholder="è¯·è¾“å…¥" 
            clearable 
            @keyup.enter="handleSearch"
          />
        </el-form-item>
        <el-form-item label="ä¸»ç”Ÿäº§è®¡åˆ’ç¼–å·">
          <el-input v-model="searchForm.masterPlanNo" placeholder="è¯·è¾“å…¥" clearable />
        </el-form-item>
        <el-form-item label="å·¥åºåç§°">
          <el-input v-model="searchForm.processName" placeholder="è¯·è¾“å…¥" clearable />
        </el-form-item>
        <el-form-item label="è®¡åˆ’æ’ç¨‹æ—¥æœŸ">
          <el-date-picker
            v-model="searchForm.scheduleDateRange"
            type="daterange"
            range-separator="è‡³"
            start-placeholder="å¼€å§‹æ—¥æœŸ"
            end-placeholder="ç»“æŸæ—¥æœŸ"
            clearable
          />
        </el-form-item>
        <el-form-item>
          <el-button type="primary" @click="handleSearch">æŸ¥è¯¢</el-button>
          <el-button @click="handleReset">é‡ç½®</el-button>
        </el-form-item>
      </el-form>
    </template>

    <!-- äº§å“å›¾ç‰‡åˆ— -->
    <template #column-productImage="{ row }">
      <el-image
        v-if="row.productImage"
        :src="row.productImage"
        :preview-src-list="[row.productImage]"
        fit="cover"
        style="width: 50px; height: 50px; border-radius: 4px;"
      />
      <span v-else style="color: #999;">æ— å›¾ç‰‡</span>
    </template>

    <!-- âœ… è¿›åº¦çŠ¶æ€åˆ— -->
    <template #column-progressStatus="{ row }">
      <div style="display: flex; align-items: center; justify-content: center; gap: 6px;">
        <template v-if="row.unscheduledQty && row.unscheduledQty !== '' && row.unscheduledQty !== null && parseFloat(row.scheduledWorkHours || 0) > 0">
          <!-- æœªæ’æ•°é‡ä¸ä¸ºç©º AND è®¡åˆ’æ’ç¨‹å·¥æ—¶>0ï¼šæ’ç¨‹å®Œæ¯• -->
          <el-icon :size="16" color="#67C23A">
            <CircleCheck />
          </el-icon>
          <span style="color: #67C23A; font-weight: 500;">æ’ç¨‹å®Œæ¯•</span>
        </template>
        <template v-else-if="parseFloat(row.scheduledWorkHours || 0) === 0">
          <!-- è®¡åˆ’æ’ç¨‹å·¥æ—¶=0ï¼šæ’ç¨‹ä¸­ -->
          <el-icon :size="16" color="#E6A23C" style="animation: rotate 2s linear infinite;">
            <Loading />
          </el-icon>
          <span style="color: #E6A23C; font-weight: 500;">æ’ç¨‹ä¸­</span>
        </template>
        <template v-else>
          <!-- å…¶ä»–æƒ…å†µé»˜è®¤æ˜¾ç¤ºæ’ç¨‹ä¸­ -->
          <el-icon :size="16" color="#E6A23C" style="animation: rotate 2s linear infinite;">
            <Loading />
          </el-icon>
          <span style="color: #E6A23C; font-weight: 500;">æ’ç¨‹ä¸­</span>
        </template>
      </div>
    </template>

    <!-- âœ… BOMè¯¦æƒ…åˆ— -->
    <template #column-bomDetail="{ row }">
      <el-button 
        size="small" 
        type="primary" 
        link
        @click="handleShowBomDetail(row)"
      >
        æŸ¥çœ‹
      </el-button>
    </template>

    <!-- æ“ä½œåˆ— -->
    <template #column-actions="{ row }">
      <el-button size="small" type="primary" @click="handleEdit(row)">ç¼–è¾‘</el-button>
      <el-button size="small" type="danger" @click="handleDelete(row)">åˆ é™¤</el-button>
    </template>
  </StandardTablePage>

  <!-- æ–°å¢/ç¼–è¾‘å¯¹è¯æ¡† -->
  <el-dialog
    v-model="dialogVisible"
    :title="isEdit ? 'ç¼–è¾‘å·¥åºè®¡åˆ’' : 'æ–°å¢å·¥åºè®¡åˆ’'"
    width="80%"
    :close-on-click-modal="false"
  >
    <el-form ref="formRef" :model="formData" :rules="formRules" label-width="140px">
      <el-row :gutter="20">
        <el-col :span="8">
          <el-form-item label="å·¥åºè®¡åˆ’ç¼–å·" prop="planNo">
            <el-input v-model="formData.planNo" placeholder="è‡ªåŠ¨ç”Ÿæˆ" disabled />
          </el-form-item>
        </el-col>
        <el-col :span="8">
          <el-form-item label="ä¸»ç”Ÿäº§è®¡åˆ’ç¼–å·" prop="masterPlanNo">
            <el-input v-model="formData.masterPlanNo" placeholder="è¯·è¾“å…¥" />
          </el-form-item>
        </el-col>
        <el-col :span="8">
          <el-form-item label="å·¥åºåç§°" prop="processName">
            <el-input v-model="formData.processName" placeholder="è¯·è¾“å…¥" />
          </el-form-item>
        </el-col>
      </el-row>
      
      <el-row :gutter="20">
        <el-col :span="8">
          <el-form-item label="è®¡åˆ’æ’ç¨‹æ—¥æœŸ" prop="scheduleDate">
            <el-date-picker v-model="formData.scheduleDate" type="date" placeholder="é€‰æ‹©æ—¥æœŸ" style="width: 100%" />
          </el-form-item>
        </el-col>
        <el-col :span="8">
          <el-form-item label="è®¡åˆ’æ’ç¨‹æ•°é‡" prop="scheduleQuantity">
            <el-input-number v-model="formData.scheduleQuantity" :min="0" :precision="2" style="width: 100%" />
          </el-form-item>
        </el-col>
        <el-col :span="8">
          <el-form-item label="è®¡åˆ’å®Œå·¥æ—¥æœŸ" prop="completionDate">
            <el-date-picker v-model="formData.completionDate" type="date" placeholder="é€‰æ‹©æ—¥æœŸ" style="width: 100%" />
          </el-form-item>
        </el-col>
      </el-row>

      <el-row :gutter="20">
        <el-col :span="8">
          <el-form-item label="è®¡åˆ’å¼€å§‹æ—¥æœŸ" prop="planStartDate">
            <el-date-picker v-model="formData.planStartDate" type="date" placeholder="é€‰æ‹©æ—¥æœŸ" style="width: 100%" />
          </el-form-item>
        </el-col>
        <el-col :span="8">
          <el-form-item label="è®¡åˆ’ç»“æŸæ—¥æœŸ" prop="planEndDate">
            <el-date-picker v-model="formData.planEndDate" type="date" placeholder="é€‰æ‹©æ—¥æœŸ" disabled style="width: 100%" />
          </el-form-item>
        </el-col>
        <el-col :span="8">
          <el-form-item label="ç”Ÿäº§äº§å“ç¼–å·" prop="productCode">
            <el-input v-model="formData.productCode" placeholder="è¯·è¾“å…¥" />
          </el-form-item>
        </el-col>
      </el-row>

      <el-row :gutter="20">
        <el-col :span="8">
          <el-form-item label="ç”Ÿäº§äº§å“åç§°" prop="productName">
            <el-input v-model="formData.productName" placeholder="è¯·è¾“å…¥" />
          </el-form-item>
        </el-col>
        <el-col :span="8">
          <el-form-item label="å·¥åºè´Ÿè´£äºº" prop="processManager">
            <el-input v-model="formData.processManager" placeholder="è¯·è¾“å…¥" />
          </el-form-item>
        </el-col>
        <el-col :span="8">
          <el-form-item label="è½¦é—´åç§°" prop="workshopName">
            <el-input v-model="formData.workshopName" placeholder="è¯·è¾“å…¥" />
          </el-form-item>
        </el-col>
      </el-row>

      <el-row :gutter="20">
        <el-col :span="8">
          <el-form-item label="å®šé¢å·¥æ—¶" prop="standardWorkHours">
            <el-input-number v-model="formData.standardWorkHours" :min="0" :precision="2" style="width: 100%" />
          </el-form-item>
        </el-col>
        <el-col :span="8">
          <el-form-item label="è®¡åˆ’æ’ç¨‹å·¥æ—¶" prop="scheduledWorkHours">
            <el-input-number v-model="formData.scheduledWorkHours" :min="0" :precision="2" style="width: 100%" />
          </el-form-item>
        </el-col>
      </el-row>
    </el-form>

    <template #footer>
      <el-button @click="dialogVisible = false">å–æ¶ˆ</el-button>
      <el-button type="primary" @click="handleSave">ä¿å­˜</el-button>
    </template>
  </el-dialog>

  <!-- å¯¼å…¥å¯¹è¯æ¡† -->
  <el-dialog v-model="importDialogVisible" title="å¯¼å…¥å·¥åºè®¡åˆ’" width="500px">
    <el-upload
      drag
      :auto-upload="false"
      :on-change="handleFileChange"
      accept=".xlsx,.xls"
    >
      <el-icon class="el-icon--upload"><UploadFilled /></el-icon>
      <div class="el-upload__text">å°†æ–‡ä»¶æ‹–åˆ°æ­¤å¤„ï¼Œæˆ–<em>ç‚¹å‡»ä¸Šä¼ </em></div>
      <template #tip>
        <div class="el-upload__tip">åªæ”¯æŒ xlsx/xls æ ¼å¼æ–‡ä»¶</div>
      </template>
    </el-upload>
    <template #footer>
      <el-button @click="importDialogVisible = false">å–æ¶ˆ</el-button>
      <el-button type="primary" @click="confirmImport">ç¡®å®šå¯¼å…¥</el-button>
    </template>
  </el-dialog>

  <!-- âœ… å·¥åºé—´éš”è®¾ç½®å¼¹çª— -->
  <el-dialog
    v-model="processIntervalDialogVisible"
    title="å·¥åºé—´éš”è®¾ç½®"
    width="90%"
    top="5vh"
    :close-on-click-modal="false"
    destroy-on-close
  >
    <ProcessIntervalSettings />
  </el-dialog>

  <!-- âœ… BOMè¯¦æƒ…å¼¹çª— -->
  <BomDetailDialog ref="bomDetailDialogRef" />
</template>

<script setup>
import { ref, reactive, onMounted } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import { UploadFilled, Loading, CircleCheck } from '@element-plus/icons-vue'
import StandardTablePage from '@/components/common/layout/StandardTablePage.vue'
import ProcessIntervalSettings from './ProcessIntervalSettings.vue'  // âœ… å¯¼å…¥å·¥åºé—´éš”è®¾ç½®ç»„ä»¶
import BomDetailDialog from './BomDetailDialog.vue'  // âœ… å¯¼å…¥BOMè¯¦æƒ…å¼¹çª—
import * as XLSX from 'xlsx'
import api from '@/api/processPlan'
import capacityLoadApi from '@/api/capacityLoad'  // âœ… å¯¼å…¥å·¥åºèƒ½åŠ›è´Ÿè·API
import materialApiService from '@/services/api/materialApiService'  // âœ… å¯¼å…¥äº§å“ç‰©æ–™åº“API
import dateUtils from '@/services/utils/date-utils'  // âœ… å¯¼å…¥æ—¥æœŸå·¥å…·

// âœ… æ—¥æœŸæ ¼å¼åŒ–å‡½æ•°ï¼šå¹´-æœˆ-æ—¥
const formatDateYMD = (date) => {
  if (!date) return ''
  return dateUtils.format(date, 'YYYY-MM-DD')
}

/**
 * å·¥åºè®¡åˆ’åˆ—è¡¨é¡µé¢ v2.0
 * ä½¿ç”¨ StandardTablePage v2.1 ç»Ÿä¸€ç»„ä»¶
 * 
 * åŠŸèƒ½ç‰¹ç‚¹ï¼š
 * 1. âœ… é¢åŒ…å±‘å¯¼èˆª
 * 2. âœ… å“åº”å¼æ–­ç‚¹ç³»ç»Ÿ
 * 3. âœ… é”®ç›˜å¯¼èˆªï¼ˆESC/Ctrl+F/Ctrl+Nï¼‰
 * 4. âœ… ç‚¹å‡»å¤–éƒ¨å…³é—­
 * 5. âœ… åˆ—æ‹–æ‹½ï¼ˆé€šè¿‡PageSettingsç»„ä»¶ï¼‰
 * 6. âœ… è¡¨å¤´ç­›é€‰ã€æ’åº
 * 7. âœ… å¢åˆ æ”¹æŸ¥ã€å¯¼å…¥å¯¼å‡ºã€æ‰“å°
 * 8. âœ… é¡µé¢è®¾ç½®ï¼ˆä¸šåŠ¡å˜é‡ã€å­—æ®µç®¡ç†ï¼‰
 * 
 * æ›´æ–°è®°å½•ï¼š
 * - v2.0 (2025-12-08): è¿ç§»åˆ° StandardTablePage v2.1 ç»Ÿä¸€ç»„ä»¶
 * - v1.0: åˆå§‹ç‰ˆæœ¬
 */

// ========== æ•°æ®çŠ¶æ€ ==========
const tableData = ref([])
const selectedRows = ref([])
const loading = ref(false)

// âœ… ä¸šåŠ¡å˜é‡å½“å‰é…ç½®
const currentBusinessVars = ref({
  defaultMergeRule: 'masterPlanNo',
  minRemainingHours: 0.5
})

// ========== é¢åŒ…å±‘å¯¼èˆª ==========
const breadcrumbItems = [
  { label: 'ç”Ÿäº§ç®¡ç†', path: '/production' },
  { label: 'è®¡åˆ’ç®¡ç†', path: '/production/planning' },
  { label: 'å·¥åºè®¡åˆ’' }
]

// ========== æœç´¢è¡¨å• ==========
const searchForm = reactive({
  planNo: '',
  masterPlanNo: '',
  processName: '',
  scheduleDateRange: []
})

const searchInputRef = ref(null)

// ========== åˆ†é¡µ ==========
const pagination = reactive({
  page: 1,
  pageSize: 20,
  total: 0
})

// ========== å¯¹è¯æ¡† ==========
const dialogVisible = ref(false)
const importDialogVisible = ref(false)
const isEdit = ref(false)

// ========== è¡¨å•æ•°æ® ==========
const formData = ref({})
const formRef = ref(null)

// ========== è¡¨å•éªŒè¯è§„åˆ™ ==========
const formRules = {
  processName: [{ required: true, message: 'è¯·è¾“å…¥å·¥åºåç§°', trigger: 'blur' }],
  scheduleQuantity: [{ required: true, message: 'è¯·è¾“å…¥è®¡åˆ’æ’ç¨‹æ•°é‡', trigger: 'blur' }]
}

// ========== BOMè¯¦æƒ…å¼¹çª— ==========
const bomDetailDialogRef = ref(null)

// æ‰“å¼€BOMè¯¦æƒ…
const handleShowBomDetail = (row) => {
  bomDetailDialogRef.value.open(row)
}

// ========== å·¥åºé—´éš”è®¾ç½®å¼¹çª— ==========
const processIntervalDialogVisible = ref(false)

// æ‰“å¼€å·¥åºé—´éš”è®¾ç½®
const openProcessIntervalSettings = () => {
  processIntervalDialogVisible.value = true
}

// ========== ä¸šåŠ¡å˜é‡é…ç½® ==========
// ä¸šåŠ¡å˜é‡ - æŒ‰é’®é…ç½®
const businessVarButtons = [
  {
    label: 'å·¥åºé—´éš”è®¾ç½®',
    value: 'processIntervalSettings',
    onClick: openProcessIntervalSettings
  }
]

// ä¸šåŠ¡å˜é‡ - ä¸‹æ‹‰é€‰æ‹©é…ç½®
const businessVarSelects = [
  {
    label: 'é»˜è®¤ç»Ÿç­¹è®¾ç½®',
    value: 'defaultMergeRule',
    options: [
      { label: 'æŒ‰"é”€å”®è®¢å•"åˆå¹¶', value: 'salesOrder' },
      { label: 'æŒ‰"æ¥æºä¸»è®¡åˆ’ç¼–å·"åˆå¹¶', value: 'masterPlanNo' },
      { label: 'æŒ‰ç›¸åŒ"å¤‡æ–™è®¡åˆ’ç¼–å·"åˆå¹¶', value: 'materialPlanNo' },
      { label: 'æŒ‰ç›¸åŒ"éœ€æ±‚æ—¥æœŸ"åˆå¹¶', value: 'demandDate' },
      { label: 'æŒ‰ç›¸åŒ"è®¡åˆ’ç‰©æ–™ç¼–å·"åˆå¹¶', value: 'materialCode' }
    ],
    defaultValue: 'masterPlanNo',
    description: `<div style="margin-top: 8px; padding: 8px; background-color: #f5f7fa; border-radius: 4px; font-size: 12px; line-height: 1.6;">
      <div style="margin-bottom: 4px;">â€¢ <strong>æŒ‰"é”€å”®è®¢å•"åˆå¹¶</strong>ï¼šå¤‡æ–™è®¡åˆ’æ¨é€æ•°æ®åˆ°å·¥åºè®¡åˆ’æ—¶ï¼Œç›¸åŒ"é”€å”®è®¢å•ç¼–å·"ä¸”ç›¸åŒ"è®¡åˆ’ç‰©æ–™ç¼–å·"åˆå¹¶ä¸€èµ·æ’ç¨‹</div>
      <div style="margin-bottom: 4px;">â€¢ <strong>æŒ‰"æ¥æºä¸»è®¡åˆ’ç¼–å·"åˆå¹¶</strong>ï¼šå¤‡æ–™è®¡åˆ’æ¨é€æ•°æ®åˆ°å·¥åºè®¡åˆ’æ—¶ï¼Œç›¸åŒ"æ¥æºä¸»è®¡åˆ’ç¼–å·"ä¸”ç›¸åŒ"è®¡åˆ’ç‰©æ–™ç¼–å·"åˆå¹¶ä¸€èµ·æ’ç¨‹</div>
      <div style="margin-bottom: 4px;">â€¢ <strong>æŒ‰ç›¸åŒ"å¤‡æ–™è®¡åˆ’ç¼–å·"åˆå¹¶</strong>ï¼šå¤‡æ–™è®¡åˆ’æ¨é€æ•°æ®åˆ°å·¥åºè®¡åˆ’æ—¶ï¼Œç›¸åŒ"å¤‡æ–™è®¡åˆ’ç¼–å·"ä¸”ç›¸åŒ"è®¡åˆ’ç‰©æ–™ç¼–å·"åˆå¹¶ä¸€èµ·æ’ç¨‹</div>
      <div style="margin-bottom: 4px;">â€¢ <strong>æŒ‰ç›¸åŒ"éœ€æ±‚æ—¥æœŸ"åˆå¹¶</strong>ï¼šå¤‡æ–™è®¡åˆ’æ¨é€æ•°æ®åˆ°å·¥åºè®¡åˆ’æ—¶ï¼Œç›¸åŒ"éœ€æ±‚æ—¥æœŸ"ä¸”ç›¸åŒ"è®¡åˆ’ç‰©æ–™ç¼–å·"åˆå¹¶ä¸€èµ·æ’ç¨‹</div>
      <div style="margin-bottom: 4px;">â€¢ <strong>æŒ‰ç›¸åŒ"è®¡åˆ’ç‰©æ–™ç¼–å·"</strong>ï¼šå¤‡æ–™è®¡åˆ’æ¨é€æ•°æ®åˆ°å·¥åºè®¡åˆ’æ—¶ï¼Œç›¸åŒ"è®¡åˆ’ç‰©æ–™ç¼–å·"åˆå¹¶ä¸€èµ·æ’ç¨‹</div>
    </div>`,
    tip: 'ğŸ’¡ æ¸©é¦¨æç¤ºï¼šå¦‚æœ‰éœ€è¦è‡ªå®šä¹‰åˆå¹¶ç»Ÿç­¹è§„åˆ™çš„ï¼Œè¯·è”ç³»å‘¨è¾‰ 18627407019'
  },
  {
    label: 'å‰©ä½™å·¥æ—¶å°äº',
    value: 'minRemainingHours',
    type: 'number',
    defaultValue: 0.5,
    unit: 'å°æ—¶',
    description: `<div style="margin-top: 8px; padding: 8px; background-color: #fff3cd; border-radius: 4px; font-size: 12px; line-height: 1.6;">
      <div style="margin-bottom: 4px;">â€¢ è®¾ç½®è®¡åˆ’ç»“æŸæ—¥æœŸæŸ¥è¯¢çš„å‰©ä½™å·¥æ—¶é—¨æ§›å€¼</div>
      <div style="margin-bottom: 4px;">â€¢ åªæœ‰å·¥åºèƒ½åŠ›è´Ÿè·è¡¨ä¸­"å‰©ä½™å·¥æ—¶" â‰¥ è¯¥å€¼çš„æ—¥æœŸæ‰ä¼šè¢«é€‰ä¸­</div>
      <div style="margin-bottom: 4px;">â€¢ é»˜è®¤å€¼ï¼š0.5å°æ—¶</div>
    </div>`,
    tip: 'ğŸ’¡ æ¸©é¦¨æç¤ºï¼šè®¾ç½®è¾ƒå¤§å€¼å¯ç¡®ä¿æœ‰è¶³å¤Ÿçš„å‰©ä½™å·¥æ—¶è¿›è¡Œæ’ç¨‹'
  }
]

// ========== é»˜è®¤è®¾ç½® ==========
const defaultSettings = {
  exportFilePrefix: 'å·¥åºè®¡åˆ’',
  codePrefix: 'PP',
  defaultMergeRule: 'masterPlanNo',  // é»˜è®¤æŒ‰"æ¥æºä¸»è®¡åˆ’ç¼–å·"åˆå¹¶
  minRemainingHours: 0.5  // âœ… é»˜è®¤å‰©ä½™å·¥æ—¶é—¨æ§›å€¼ï¼š0.5å°æ—¶
}

// âœ… æ‰€æœ‰åˆ—å®šä¹‰
const allColumns = ref([
  { prop: 'selection', label: 'é€‰æ‹©', type: 'selection', width: 55, fixed: 'left', visible: true },
  { prop: 'rowIndex', label: 'åºå·', width: 80, sortable: false, filterable: false, visible: true,
    formatter: (row, column, cellValue, index) => index + 1 },  // âœ… éœ€æ±‚ 2ï¼šåºå·ï¼ˆè¡Œä½ç½®ï¼‰
  { prop: 'scheduleDate', label: 'è®¡åˆ’æ’ç¨‹æ—¥æœŸ', width: 120, sortable: true, filterable: true, visible: true,
    formatter: (row) => formatDateYMD(row.scheduleDate) },  // âœ… éœ€æ±‚ 4ï¼šè®¡åˆ’æ’ç¨‹æ—¥æœŸ = çœŸè®¡åˆ’å¼€å§‹æ—¥æœŸ
  { prop: 'salesOrderNo', label: 'é”€å”®è®¢å•ç¼–å·', width: 160, sortable: true, filterable: true, visible: true },
  { prop: 'masterPlanNo', label: 'ä¸»ç”Ÿäº§è®¡åˆ’ç¼–å·', width: 160, sortable: true, filterable: true, visible: true },
  { prop: 'shippingPlanNo', label: 'å‘è´§è®¡åˆ’ç¼–å·', width: 160, sortable: true, filterable: true, visible: true },
  { prop: 'productCode', label: 'ç”Ÿäº§äº§å“ç¼–å·', width: 140, sortable: true, filterable: true, visible: true },
  { prop: 'productName', label: 'ç”Ÿäº§äº§å“åç§°', width: 180, sortable: true, filterable: true, visible: true },
  { prop: 'productImage', label: 'äº§å“å›¾ç‰‡', width: 100, slot: 'productImage', visible: true },
  { prop: 'processManager', label: 'å·¥åºè´Ÿè´£äºº', width: 120, filterable: true, visible: true },
  { prop: 'processName', label: 'å·¥åºåç§°', width: 140, sortable: true, filterable: true, visible: true },
  { prop: 'planNo', label: 'å·¥åºè®¡åˆ’ç¼–å·', width: 160, sortable: true, filterable: true, fixed: 'left', visible: true },
  { prop: 'dailyTotalHours', label: 'å½“å¤©æ€»å·¥æ—¶', width: 120, sortable: true, align: 'right', visible: true,
    formatter: (row) => row.dailyTotalHours !== undefined ? parseFloat(row.dailyTotalHours).toFixed(2) : '0.00' },  // âœ… éœ€æ±‚1ï¼š2ä½å°æ•°
  { prop: 'dailyScheduledHours', label: 'å½“å¤©å·²æ’ç¨‹å·¥æ—¶', width: 150, sortable: true, align: 'right', visible: true,
    formatter: (row) => row.dailyScheduledHours !== undefined ? parseFloat(row.dailyScheduledHours).toFixed(2) : '0.00' },  // âœ… éœ€æ±‚1ï¼š2ä½å°æ•°
  { prop: 'dailyAvailableHours', label: 'å·¥åºå½“å¤©å¯ç”¨å·¥æ—¶', width: 160, sortable: true, align: 'right', visible: true,
    formatter: (row) => row.dailyAvailableHours !== undefined ? parseFloat(row.dailyAvailableHours).toFixed(2) : '0.00' },  // âœ… éœ€æ±‚1ï¼š2ä½å°æ•°
  { prop: 'scheduleQuantity', label: 'è®¡åˆ’æ’ç¨‹æ•°é‡', width: 130, sortable: true, align: 'right', visible: true },  // âœ… éœ€æ±‚ 9
  { prop: 'scheduledWorkHours', label: 'è®¡åˆ’æ’ç¨‹å·¥æ—¶', width: 130, sortable: true, align: 'right', visible: true,
    formatter: (row) => row.scheduledWorkHours !== undefined ? parseFloat(row.scheduledWorkHours).toFixed(2) : '0.00' },  // âœ… éœ€æ±‚1ï¼š2ä½å°æ•°
  { prop: 'productUnit', label: 'äº§å“å•ä½', width: 100, visible: true },
  { prop: 'level0Demand', label: '0é˜¶éœ€æ±‚æ•°é‡', width: 130, sortable: true, align: 'right', visible: true },
  { prop: 'completionDate', label: 'è®¡åˆ’å®Œå·¥æ—¥æœŸ', width: 120, sortable: true, visible: true,
    formatter: (row) => formatDateYMD(row.completionDate) },  // âœ… æ·»åŠ æ—¥æœŸæ ¼å¼åŒ–
  { prop: 'planStartDate', label: 'è®¡åˆ’å¼€å§‹æ—¥æœŸ', width: 120, sortable: true, filterable: true, visible: true,
    formatter: (row) => formatDateYMD(row.planStartDate) },  // âœ… æ–°å¢ï¼šè®¡åˆ’å¼€å§‹æ—¥æœŸ
  { prop: 'realPlanStartDate', label: 'çœŸè®¡åˆ’å¼€å§‹æ—¥æœŸ', width: 130, sortable: true, filterable: true, visible: true,
    formatter: (row) => formatDateYMD(row.realPlanStartDate)
  },  // âœ… æ–°å¢ï¼šçœŸè®¡åˆ’å¼€å§‹æ—¥æœŸ = è®¡åˆ’å¼€å§‹æ—¥æœŸ + 1å¤©(å·²åœ¨æ•°æ®è®¡ç®—æ—¶å¤„ç†)
  { prop: 'planEndDate', label: 'è®¡åˆ’ç»“æŸæ—¥æœŸ', width: 120, sortable: true, filterable: true, visible: true,
    formatter: (row) => formatDateYMD(row.planEndDate) },  // âœ… æ–°å¢ï¼šè®¡åˆ’ç»“æŸæ—¥æœŸ
  { prop: 'workshopName', label: 'è½¦é—´åç§°', width: 120, filterable: true, visible: true },
  { prop: 'nextScheduleDate', label: 'ä¸‹ä¸€ä¸ªæ’ç¨‹æ—¥æœŸ', width: 140, sortable: true, filterable: true, visible: true,
    formatter: (row) => formatDateYMD(row.nextScheduleDate) },  // âœ… éœ€æ±‚1ï¼šè¿˜éœ€æ’ç¨‹å·¥æ—¶æ”¹ä¸ºä¸‹ä¸€ä¸ªæ’ç¨‹æ—¥æœŸ
  { prop: 'scheduleCount', label: 'æ’ç¨‹æ¬¡æ•°', width: 100, sortable: true, align: 'right', visible: true },
  { prop: 'standardWorkQuota', label: 'å®šæ—¶å·¥é¢', width: 100, sortable: true, align: 'right', visible: true },  // âœ… ä¿®æ”¹ï¼šå®šé¢å·¥æ—¶æ”¹ä¸ºå®šæ—¶å·¥é¢
  { prop: 'standardWorkHours', label: 'å®šé¢å·¥æ—¶', width: 100, sortable: true, align: 'right', visible: true },  // âœ… ä¿®æ”¹ï¼šå®šæ—¶å·¥é¢æ”¹ä¸ºå®šé¢å·¥æ—¶
  { prop: 'requiredWorkHours', label: 'éœ€æ±‚å·¥æ—¶', width: 100, sortable: true, align: 'right', visible: true,
    formatter: (row) => row.requiredWorkHours !== undefined ? parseFloat(row.requiredWorkHours).toFixed(2) : '0.00' },  // âœ… éœ€æ±‚1ï¼š2ä½å°æ•°
  { prop: 'remainingRequiredHours', label: 'å‰©ä½™éœ€æ±‚å·¥æ—¶', width: 120, sortable: true, align: 'right', visible: true,
    formatter: (row) => row.remainingRequiredHours !== undefined ? parseFloat(row.remainingRequiredHours).toFixed(2) : '0.00' },  // âœ… éœ€æ±‚2ï¼šå‰©ä½™éœ€æ±‚å·¥æ—¶
  { prop: 'cumulativeScheduleQty', label: 'ç´¯ç§¯æ’ç¨‹æ•°é‡', width: 130, sortable: true, align: 'right', visible: true,
    formatter: (row) => row.cumulativeScheduleQty !== undefined ? parseFloat(row.cumulativeScheduleQty).toFixed(2) : '0.00' },  // âœ… éœ€æ±‚3ï¼šå·²æ’å·¥æ—¶æ”¹ä¸ºç´¯ç§¯æ’ç¨‹æ•°é‡
  { prop: 'unscheduledQty', label: 'æœªæ’æ•°é‡', width: 100, sortable: true, align: 'right', visible: true,
    formatter: (row) => row.unscheduledQty !== undefined ? parseFloat(row.unscheduledQty).toFixed(2) : '0.00' },  // âœ… éœ€æ±‚4ï¼šæœªæ’å·¥æ—¶æ”¹ä¸ºæœªæ’æ•°é‡
  { prop: 'progressStatus', label: 'è¿›åº¦çŠ¶æ€', width: 140, sortable: true, filterable: true, align: 'center', visible: true, slot: 'progressStatus' },  // âœ… æ–°å¢ï¼šè¿›åº¦çŠ¶æ€(ä½¿ç”¨æ’æ§½)
  { prop: 'replenishmentQty', label: 'éœ€è¡¥è´§æ•°é‡', width: 120, sortable: true, align: 'right', visible: true },
  { prop: 'sourcePageName', label: 'æ¥æºé¡µé¢åç§°', width: 130, filterable: true, visible: false },
  { prop: 'sourceNo', label: 'æ¥æºç¼–å·', width: 160, filterable: true, visible: true },  // âœ… éœ€æ±‚1ï¼šæ¥æºç¼–å·é»˜è®¤æ˜¾ç¤º
  { prop: 'previousScheduleNo', label: 'ä¸Šä¸€ä¸ªæ’ç¨‹å•å·', width: 160, filterable: true, visible: false },
  { prop: 'customerName', label: 'å®¢æˆ·åç§°', width: 150, filterable: true, visible: true },
  { prop: 'level0ProductName', label: '0é˜¶äº§å“åç§°', width: 150, filterable: true, visible: false },
  { prop: 'level0ProductCode', label: '0é˜¶äº§å“ç¼–å·', width: 140, filterable: true, visible: false },
  { prop: 'level0ProductionQty', label: '0é˜¶ä¸»è®¡åˆ’ç”Ÿäº§æ•°é‡', width: 160, sortable: true, align: 'right', visible: false },
  { prop: 'productSource', label: 'äº§å“æ¥æº', width: 120, filterable: true, visible: false },
  { prop: 'bomNo', label: 'ç”Ÿäº§BOMç¼–å·', width: 160, filterable: true, sortable: true, visible: true },  // âœ… æ˜¾ç¤ºBOMç¼–å·
  { prop: 'hierarchyAddress', label: 'å±‚é˜¶åœ°å€', width: 120, filterable: true, visible: true },  // âœ… æ–°å¢å±‚é˜¶åœ°å€
  { prop: 'bomDetail', label: 'BOMè¯¦æƒ…', width: 100, slot: 'bomDetail', align: 'center', visible: true },  // âœ… æ–°å¢BOMè¯¦æƒ…åˆ—
  { prop: 'submittedBy', label: 'æäº¤äºº', width: 100, filterable: true, visible: true },
  { prop: 'submittedAt', label: 'æäº¤æ—¶é—´', width: 160, sortable: true, visible: true },
  { prop: 'actions', label: 'æ“ä½œ', width: 180, fixed: 'right', slot: 'actions', visible: true }
])

// âœ… åŠ è½½æ•°æ® - ä»…åŠ è½½å·²ä¿å­˜çš„æ•°æ®ï¼Œä¸é‡æ–°è®¡ç®—
const loadData = async () => {
  loading.value = true
  try {
    const params = {
      page: pagination.page,
      pageSize: pagination.pageSize,
      planNo: searchForm.planNo,
      masterPlanNo: searchForm.masterPlanNo,
      processName: searchForm.processName
    }
    
    // æ·»åŠ æ—¥æœŸèŒƒå›´
    if (searchForm.scheduleDateRange && searchForm.scheduleDateRange.length === 2) {
      params.scheduleDateStart = searchForm.scheduleDateRange[0]
      params.scheduleDateEnd = searchForm.scheduleDateRange[1]
    }
    
    console.log('ğŸ”„ å¼€å§‹åŠ è½½å·¥åºè®¡åˆ’æ•°æ®...')
    const data = await api.getList(params)
    tableData.value = data.records || []
    pagination.total = data.total || 0
    
    console.log(`âœ… æ•°æ®åŠ è½½å®Œæˆï¼Œå…± ${tableData.value.length} æ¡è®°å½•`)
    console.log('ğŸ“Š åŠ è½½çš„æ•°æ®å·²åŒ…å«æ‰€æœ‰è®¡ç®—å­—æ®µï¼Œæ— éœ€é‡å¤è®¡ç®—')
    
    // âš ï¸ å…³é”®ä¿®å¤ï¼šåˆ é™¤æ‰€æœ‰é‡æ–°è®¡ç®—é€»è¾‘
    // æ•°æ®åº“ä¸­å·²ç»å­˜å‚¨äº†æ‰€æœ‰è®¡ç®—å¥½çš„å­—æ®µï¼Œç›´æ¥ä½¿ç”¨å³å¯
    // é‡æ–°è®¡ç®—ä¼šå¯¼è‡´ï¼š
    // 1. é‡å¤æ¨é€å·²å ç”¨å·¥æ—¶åˆ°å·¥åºèƒ½åŠ›è´Ÿè·è¡¨(ç´¯åŠ é”™è¯¯)
    // 2. é‡å¤ç”Ÿæˆè‡ªå¢è®°å½•(æ•°æ®é‡å¤)
    // 3. æ€§èƒ½ä¸¥é‡ä¸‹é™(æ¯æ¬¡åˆ·æ–°éƒ½è°ƒç”¨å¤§é‡ API)
    
    ElMessage.success('æ•°æ®åŠ è½½æˆåŠŸ')
  } catch (error) {
    console.error('âŒ åŠ è½½æ•°æ®å¤±è´¥:', error)
    ElMessage.error('åŠ è½½æ•°æ®å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'))
  } finally {
    loading.value = false
  }
}

// æœç´¢
const handleSearch = () => {
  pagination.page = 1
  loadData()
}

// é‡ç½®
const handleReset = () => {
        row.realPlanStartDate = null
        row.scheduleDate = null
        return row
      }
      
      try {
        const completionDate = formatDateYMD(row.completionDate)
        const minRemainingHours = currentBusinessVars.value.minRemainingHours || 0.5
        
        // æŸ¥è¯¢è®¡åˆ’ç»“æŸæ—¥æœŸ
        const endResponse = await capacityLoadApi.queryPlanEndDate(row.processName, completionDate, minRemainingHours)
        
        if (endResponse?.planEndDate) {
          row.planEndDate = endResponse.planEndDate
          
          // æŸ¥è¯¢è®¡åˆ’å¼€å§‹æ—¥æœŸ
          const requiredWorkHours = parseFloat(row.requiredWorkHours || 0)
          
          if (requiredWorkHours > 0) {
            const planEndDateFormatted = formatDateYMD(row.planEndDate)
            console.log(`ğŸ” [${row.planNo}] æŸ¥è¯¢è®¡åˆ’å¼€å§‹æ—¥æœŸ: å·¥åº=${row.processName}, ç»“æŸæ—¥æœŸ=${planEndDateFormatted}, éœ€æ±‚å·¥æ—¶=${requiredWorkHours}, æœ€å°å‰©ä½™å·¥æ—¶=${minRemainingHours}`)
            
            const startResponse = await capacityLoadApi.queryPlanStartDate(
              row.processName, 
              planEndDateFormatted, 
              requiredWorkHours, 
              minRemainingHours
            )
            
            console.log(`ğŸ“¡ [${row.planNo}] è®¡åˆ’å¼€å§‹æ—¥æœŸAPIå“åº”:`, startResponse)
            
            if (startResponse?.planStartDate) {
              // âœ… ä¿®å¤:ç¡®ä¿æ—¥æœŸæ ¼å¼ç»Ÿä¸€ä¸ºYYYY-MM-DDå­—ç¬¦ä¸²,é¿å…æ—¶åŒºé—®é¢˜
              row.planStartDate = startResponse.planStartDate
              console.log(`âœ… [${row.planNo}] æ‰¾åˆ°è®¡åˆ’å¼€å§‹æ—¥æœŸ: ${row.planStartDate}, ç´¯è®¡å·¥æ—¶: ${startResponse.accumulatedHours}`)
              
              // âœ… è®¡ç®—çœŸè®¡åˆ’å¼€å§‹æ—¥æœŸ = è®¡åˆ’å¼€å§‹æ—¥æœŸ + 1å¤©(ä½¿ç”¨å­—ç¬¦ä¸²æ“ä½œé¿å…æ—¶åŒºé—®é¢˜)
              const [year, month, day] = row.planStartDate.split('-').map(Number)
              const startDate = new Date(year, month - 1, day)  // æœˆä»½ä»0å¼€å§‹
              startDate.setDate(startDate.getDate() + 1)
              const realYear = startDate.getFullYear()
              const realMonth = String(startDate.getMonth() + 1).padStart(2, '0')
              const realDay = String(startDate.getDate()).padStart(2, '0')
              row.realPlanStartDate = `${realYear}-${realMonth}-${realDay}`
              
              // âœ… éœ€æ±‚ 4ï¼šè®¡åˆ’æ’ç¨‹æ—¥æœŸ = çœŸè®¡åˆ’å¼€å§‹æ—¥æœŸ
              row.scheduleDate = row.realPlanStartDate
              console.log(`âœ… [${row.planNo}] çœŸè®¡åˆ’å¼€å§‹æ—¥æœŸ=${row.realPlanStartDate}, è®¡åˆ’æ’ç¨‹æ—¥æœŸ=${row.scheduleDate}`)
            } else {
              console.warn(`âš ï¸ [${row.planNo}] æœªæ‰¾åˆ°è®¡åˆ’å¼€å§‹æ—¥æœŸ! å·¥åº=${row.processName}, ç»“æŸæ—¥æœŸ=${planEndDateFormatted}, éœ€æ±‚å·¥æ—¶=${requiredWorkHours}`)
              console.warn(`   å¯èƒ½åŸå› : 1)å·¥åºèƒ½åŠ›è´Ÿè·è¡¨ä¸­è¯¥å·¥åºçš„å‰©ä½™å·¥æ—¶ä¸è¶³; 2)å‰©ä½™å·¥æ—¶éƒ½<${minRemainingHours}å°æ—¶; 3)è¯·æ£€æŸ¥å·¥åºèƒ½åŠ›è´Ÿè·è¡¨æ•°æ®`)
              row.planStartDate = null
              row.realPlanStartDate = null
              row.scheduleDate = null
            }
          } else {
            // âœ… ä¿®å¤:å½“éœ€æ±‚å·¥æ—¶=0æ—¶,ä½¿ç”¨å­—ç¬¦ä¸²æ“ä½œé¿å…æ—¶åŒºé—®é¢˜
            row.planStartDate = row.planEndDate
            const [year, month, day] = row.planEndDate.split('-').map(Number)
            const startDate = new Date(year, month - 1, day)
            startDate.setDate(startDate.getDate() + 1)
            const realYear = startDate.getFullYear()
            const realMonth = String(startDate.getMonth() + 1).padStart(2, '0')
            const realDay = String(startDate.getDate()).padStart(2, '0')
            row.realPlanStartDate = `${realYear}-${realMonth}-${realDay}`
            row.scheduleDate = row.realPlanStartDate
          }
        } else {
          row.planEndDate = null
          row.planStartDate = null
          row.realPlanStartDate = null
          row.scheduleDate = null
        }
      } catch (error) {
        console.error(`â— æŸ¥è¯¢è®¡åˆ’æ—¥æœŸå¤±è´¥:`, error)
        row.planEndDate = null
        row.planStartDate = null
        row.realPlanStartDate = null
        row.scheduleDate = null
      }
      
      return row
    })
    
    await Promise.all(planDatePromises)
    
    // âœ… æ­¥éª¤ 3ï¼šæŸ¥è¯¢å½“å¤©æ€»å·¥æ—¶ï¼ˆéœ€æ±‚ 3ï¼šå½“å¤©æ€»å·¥æ—¶ = å¯ç”¨å·¥ä½æ•°é‡ Ã— ä¸Šç­æ—¶æ®µï¼‰
    const totalHoursPromises = tableData.value.map(async (row) => {
      // âœ… éªŒè¯å¿…è¦å­—æ®µ
      if (!row.processName || !row.scheduleDate) {
        console.warn('âš ï¸ è·³è¿‡æŸ¥è¯¢å½“å¤©æ€»å·¥æ—¶ï¼šç¼ºå°‘å·¥åºåç§°æˆ–è®¡åˆ’æ’ç¨‹æ—¥æœŸ', { processName: row.processName, scheduleDate: row.scheduleDate })
        row.dailyTotalHours = 0
        return row
      }
      
      try {
        const scheduleDateFormatted = formatDateYMD(row.scheduleDate)
        
        // âœ… å†æ¬¡éªŒè¯æ ¼å¼åŒ–åçš„æ—¥æœŸ
        if (!scheduleDateFormatted) {
          console.warn('âš ï¸ æ—¥æœŸæ ¼å¼åŒ–å¤±è´¥', row.scheduleDate)
          row.dailyTotalHours = 0
          return row
        }
        
        const capacityResponse = await capacityLoadApi.queryCapacityByDate(row.processName, scheduleDateFormatted)
        
        if (capacityResponse) {
          // APIå“åº”å·²ç»è¢«requestæ‹¦æˆªå™¨å¤„ç†è¿‡ï¼Œç›´æ¥ä½¿ç”¨
          const availableWorkstations = parseFloat(capacityResponse.availableWorkstations || 0)
          const workShift = parseFloat(capacityResponse.workShift || 0)
          row.dailyTotalHours = parseFloat((availableWorkstations * workShift).toFixed(2))
        } else {
          row.dailyTotalHours = 0
        }
      } catch (error) {
        console.error(`â— æŸ¥è¯¢å½“å¤©æ€»å·¥æ—¶å¤±è´¥ [å·¥åº: ${row.processName}, æ—¥æœŸ: ${row.scheduleDate}]:`, error)
        row.dailyTotalHours = 0
      }
      
      return row
    })
    
    await Promise.all(totalHoursPromises)
    
    // âœ… æ­¥éª¤ 4ï¼šè®¡ç®—å½“å¤©å·²æ’ç¨‹å·¥æ—¶ï¼ˆéœ€æ±‚ 5ï¼šSUMIFSé€»è¾‘ï¼‰
    tableData.value = tableData.value.map((row, index) => {
      if (!row.processName || !row.scheduleDate) {
        row.dailyScheduledHours = 0
        row.dailyAvailableHours = row.dailyTotalHours
        row.scheduledWorkHours = 0
        row.scheduleQuantity = 0
        return row
      }
      
      // SUMIFS: æ±‚å’Œæ¡ä»¶ 1ï¼šå·¥åºåç§°ç›¸åŒï¼Œæ¡ä»¶ 2ï¼šåºå· < å½“å‰åºå·ï¼Œæ¡ä»¶ 3ï¼šè®¡åˆ’æ’ç¨‹æ—¥æœŸç›¸åŒ
      const scheduleDateFormatted = formatDateYMD(row.scheduleDate)
      let sumScheduledHours = 0
      
      for (let i = 0; i < index; i++) {
        const prevRow = tableData.value[i]
        if (prevRow.processName === row.processName && 
            formatDateYMD(prevRow.scheduleDate) === scheduleDateFormatted) {
          sumScheduledHours += parseFloat(prevRow.scheduledWorkHours || 0)
        }
      }
      
      row.dailyScheduledHours = parseFloat(sumScheduledHours.toFixed(2))
      
      // âœ… éœ€æ±‚ 6ï¼šå·¥åºå½“å¤©å¯ç”¨å·¥æ—¶ = å½“å¤©æ€»å·¥æ—¶ - å½“å¤©å·²æ’ç¨‹å·¥æ—¶
      row.dailyAvailableHours = parseFloat((row.dailyTotalHours - row.dailyScheduledHours).toFixed(2))
      
      // âœ… éœ€æ±‚ 7ï¼šè®¡åˆ’æ’ç¨‹å·¥æ—¶ = MIN(éœ€æ±‚å·¥æ—¶, å·¥åºå½“å¤©å¯ç”¨å·¥æ—¶)
      const requiredWorkHours = parseFloat(row.requiredWorkHours || 0)
      row.scheduledWorkHours = parseFloat(Math.min(requiredWorkHours, row.dailyAvailableHours).toFixed(2))
      
      return row
    })
    
    // âœ… æ­¥éª¤ 5ï¼šæŸ¥è¯¢æœ€å°åŒ…è£…é‡å¹¶è®¡ç®—è®¡åˆ’æ’ç¨‹æ•°é‡ï¼ˆéœ€æ±‚ 9ï¼‰
    // éœ€è¦ä»äº§å“ç‰©æ–™åº“æŸ¥è¯¢minimum_packaging_quantity
    const quantityPromises = tableData.value.map(async (row) => {
      if (!row.productCode) {
        row.scheduleQuantity = 0
        return row
      }
      
      try {
        // æŸ¥è¯¢äº§å“ç‰©æ–™åº“è·å–æœ€å°åŒ…è£…é‡
        try {
          const materialResponse = await materialApiService.getMaterialByCode(row.productCode)
          
          if (materialResponse && materialResponse.minimumPackagingQuantity !== undefined) {
            const minimumPackagingQty = parseFloat(materialResponse.minimumPackagingQuantity || 1)
            const standardWorkQuota = parseFloat(row.standardWorkQuota || 0)
            const scheduledWorkHours = parseFloat(row.scheduledWorkHours || 0)
            
            if (standardWorkQuota > 0 && minimumPackagingQty > 0) {
              // âœ… éœ€æ±‚ 9ï¼šè®¡åˆ’æ’ç¨‹æ•°é‡ = CEILING(è®¡åˆ’æ’ç¨‹å·¥æ—¶ Ã— å®šæ—¶å·¥é¢, æœ€å°åŒ…è£…é‡)
              const rawQuantity = scheduledWorkHours * standardWorkQuota
              row.scheduleQuantity = parseFloat((Math.ceil(rawQuantity / minimumPackagingQty) * minimumPackagingQty).toFixed(4))
            } else {
              row.scheduleQuantity = 0
            }
          } else {
            console.warn(`âš ï¸ ç‰©æ–™ ${row.productCode} æ— æœ€å°åŒ…è£…é‡ä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤å€¼1`)
            const minimumPackagingQty = 1
            const standardWorkQuota = parseFloat(row.standardWorkQuota || 0)
            const scheduledWorkHours = parseFloat(row.scheduledWorkHours || 0)
            
            if (standardWorkQuota > 0) {
              const rawQuantity = scheduledWorkHours * standardWorkQuota
              row.scheduleQuantity = parseFloat((Math.ceil(rawQuantity / minimumPackagingQty) * minimumPackagingQty).toFixed(4))
            } else {
              row.scheduleQuantity = 0
            }
          }
        } catch (materialError) {
          console.warn(`âš ï¸ è·å–ç‰©æ–™ ${row.productCode} ä¿¡æ¯å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼:`, materialError.message)
          const minimumPackagingQty = 1
          const standardWorkQuota = parseFloat(row.standardWorkQuota || 0)
          const scheduledWorkHours = parseFloat(row.scheduledWorkHours || 0)
          
          if (standardWorkQuota > 0) {
            const rawQuantity = scheduledWorkHours * standardWorkQuota
            row.scheduleQuantity = parseFloat((Math.ceil(rawQuantity / minimumPackagingQty) * minimumPackagingQty).toFixed(4))
          } else {
            row.scheduleQuantity = 0
          }
        }
      } catch (error) {
        console.error(`â— æŸ¥è¯¢æœ€å°åŒ…è£…é‡å¤±è´¥:`, error)
        row.scheduleQuantity = 0
      }
      
      return row
    })
    
    await Promise.all(quantityPromises)
    
    // âœ… æ­¥éª¤ 5.5ï¼šæ›´æ–°å·¥åºèƒ½åŠ›è´Ÿè·è¡¨çš„å·²å ç”¨å·¥æ—¶ï¼ˆæ–°å¢æ•°æ®æµï¼‰
    // è§¦å‘æ¡ä»¶ï¼šè®¡åˆ’æ’ç¨‹å·¥æ—¶ä¸ä¸ºç©º
    console.log(`ğŸ”„ [æ­¥éª¤5.5] å¼€å§‹æ›´æ–°${tableData.value.length}æ¡è®°å½•çš„å·²å ç”¨å·¥æ—¶`)
    const updateOccupiedHoursPromises = tableData.value.map(async (row, index) => {
      // âœ… éªŒè¯è§¦å‘æ¡ä»¶
      if (!row.scheduledWorkHours || parseFloat(row.scheduledWorkHours) === 0) {
        console.log(`â­ï¸ [ç¬¬${index+1}æ¡] è·³è¿‡æ›´æ–°å·²å ç”¨å·¥æ—¶: ${row.planNo}, è®¡åˆ’æ’ç¨‹å·¥æ—¶ä¸ºç©ºæˆ–0`)
        return row
      }
      
      if (!row.processName || !row.scheduleDate) {
        console.warn(`âš ï¸ [ç¬¬${index+1}æ¡] è·³è¿‡æ›´æ–°å·²å ç”¨å·¥æ—¶: ${row.planNo}, ç¼ºå°‘å·¥åºåç§°æˆ–è®¡åˆ’æ’ç¨‹æ—¥æœŸ`)
        return row
      }
      
      try {
        const scheduleDateFormatted = formatDateYMD(row.scheduleDate)
        if (!scheduleDateFormatted) {
          console.warn(`âš ï¸ [ç¬¬${index+1}æ¡] æ—¥æœŸæ ¼å¼åŒ–å¤±è´¥: ${row.scheduleDate}`)
          return row
        }
        
        // âœ… è°ƒç”¨APIæ›´æ–°å·¥åºèƒ½åŠ›è´Ÿè·è¡¨
        console.log(`ğŸ”„ [ç¬¬${index+1}æ¡] å¼€å§‹è°ƒç”¨API: å·¥åº=${row.processName}, æ—¥æœŸ=${scheduleDateFormatted}, å·¥æ—¶=${row.scheduledWorkHours}`)
        
        const updateResponse = await capacityLoadApi.updateOccupiedHours(
          row.processName,
          scheduleDateFormatted,
          row.scheduledWorkHours
        )
        
        console.log(`âœ… [ç¬¬${index+1}æ¡] APIè°ƒç”¨å®Œæˆ:`, updateResponse)
        
        if (updateResponse?.updated) {
          console.log(`âœ… [ç¬¬${index+1}æ¡] å·²å ç”¨å·¥æ—¶æ›´æ–°æˆåŠŸ: ${updateResponse.previousOccupiedHours} + ${updateResponse.addedHours} = ${updateResponse.newOccupiedHours}`)
        } else {
          console.log(`âš ï¸ [ç¬¬${index+1}æ¡] å·²å ç”¨å·¥æ—¶æœªæ›´æ–°: ${updateResponse?.reason || 'æœªçŸ¥åŸå› '}`)
        }
      } catch (error) {
        console.error(`â— [ç¬¬${index+1}æ¡] æ›´æ–°å·²å ç”¨å·¥æ—¶å¤±è´¥ [å·¥åº: ${row.processName}, æ—¥æœŸ: ${row.scheduleDate}]:`, error)
        // âœ… ä¸é˜»å¡ä¸»æµç¨‹ï¼Œç»§ç»­æ‰§è¡Œ
      }
      
      return row
    })
    
    console.log(`â³ [æ­¥éª¤5.5] ç­‰å¾…æ‰€æœ‰APIè°ƒç”¨å®Œæˆ...`)
    await Promise.all(updateOccupiedHoursPromises)
    console.log(`âœ… [æ­¥éª¤5.5] æ‰€æœ‰å·²å ç”¨å·¥æ—¶æ›´æ–°å®Œæˆ`)
    
    // âœ… æ­¥éª¤ 6ï¼šè®¡ç®—ç´¯ç§¯æ’ç¨‹æ•°é‡ã€æœªæ’æ•°é‡å’Œå‰©ä½™éœ€æ±‚å·¥æ—¶ï¼ˆéœ€æ±‚3ã€4ã€2ï¼‰
    tableData.value = tableData.value.map((row, currentIndex) => {
      // âœ… éœ€æ±‚3ï¼šç´¯ç§¯æ’ç¨‹æ•°é‡ = SUMIFS(è®¡åˆ’æ’ç¨‹æ•°é‡, æ¥æºç¼–å·=æœ¬è¡Œæ¥æºç¼–å·, ç”Ÿäº§äº§å“ç¼–å·=æœ¬è¡Œç”Ÿäº§äº§å“ç¼–å·)
      const cumulativeScheduleQty = tableData.value.reduce((sum, compareRow, compareIndex) => {
        // åªç»Ÿè®¡æ»¡è¶³æ¡ä»¶çš„è¡Œ
        if (
          compareRow.sourceNo === row.sourceNo &&  // æ¡ä»¶1ï¼šæ¥æºç¼–å·ç›¸åŒ
          compareRow.productCode === row.productCode  // æ¡ä»¶2ï¼šç”Ÿäº§äº§å“ç¼–å·ç›¸åŒ
        ) {
          const scheduleQty = parseFloat(compareRow.scheduleQuantity || 0)
          return sum + scheduleQty
        }
        return sum
      }, 0)
      
      row.cumulativeScheduleQty = parseFloat(cumulativeScheduleQty.toFixed(4))
      
      // âœ… éœ€æ±‚4ï¼šæœªæ’æ•°é‡ = éœ€è¡¥è´§æ•°é‡ - ç´¯ç§¯æ’ç¨‹æ•°é‡
      const replenishmentQty = parseFloat(row.replenishmentQty || 0)
      row.unscheduledQty = parseFloat((replenishmentQty - row.cumulativeScheduleQty).toFixed(4))
      
      // âœ… éœ€æ±‚2ï¼šå‰©ä½™éœ€æ±‚å·¥æ—¶ = æœªæ’æ•°é‡ / å®šæ—¶å·¥é¢
      const standardWorkQuota = parseFloat(row.standardWorkQuota || 0)
      if (standardWorkQuota > 0 && row.unscheduledQty > 0) {
        row.remainingRequiredHours = parseFloat((row.unscheduledQty / standardWorkQuota).toFixed(2))
      } else {
        row.remainingRequiredHours = 0
      }
      
      return row
    })
    
    // âœ… æ­¥éª¤ 7ï¼šæŸ¥è¯¢ä¸‹ä¸€ä¸ªæ’ç¨‹æ—¥æœŸï¼ˆéœ€æ±‚1ï¼‰
    const nextScheduleDatePromises = tableData.value.map(async (row) => {
      // âœ… éªŒè¯å¿…è¦å­—æ®µ
      if (!row.processName || !row.scheduleDate) {
        console.warn('âš ï¸ è·³è¿‡æŸ¥è¯¢ä¸‹ä¸€ä¸ªæ’ç¨‹æ—¥æœŸï¼šç¼ºå°‘å·¥åºåç§°æˆ–è®¡åˆ’æ’ç¨‹æ—¥æœŸ', { processName: row.processName, scheduleDate: row.scheduleDate })
        row.nextScheduleDate = null
        return row
      }
      
      try {
        const scheduleDateFormatted = formatDateYMD(row.scheduleDate)
        
        // âœ… å†æ¬¡éªŒè¯æ ¼å¼åŒ–åçš„æ—¥æœŸ
        if (!scheduleDateFormatted) {
          console.warn('âš ï¸ æ—¥æœŸæ ¼å¼åŒ–å¤±è´¥', row.scheduleDate)
          row.nextScheduleDate = null
          return row
        }
        
        const minRemainingHours = currentBusinessVars.value.minRemainingHours || 0.5
        const nextDateResponse = await capacityLoadApi.queryNextScheduleDate(
          row.processName, 
          scheduleDateFormatted, 
          minRemainingHours
        )
        
        if (nextDateResponse?.nextScheduleDate) {
          row.nextScheduleDate = nextDateResponse.nextScheduleDate
        } else {
          row.nextScheduleDate = null
        }
      } catch (error) {
        console.error(`â— æŸ¥è¯¢ä¸‹ä¸€ä¸ªæ’ç¨‹æ—¥æœŸå¤±è´¥ [å·¥åº: ${row.processName}, æ—¥æœŸ: ${row.scheduleDate}]:`, error)
        row.nextScheduleDate = null
      }
      
      return row
    })
    
    await Promise.all(nextScheduleDatePromises)
    
    // âœ… æ­¥éª¤ 8:è‡ªå¢æ•°æ®è§„åˆ™(éœ€æ±‚3)- å–æ¶ˆé™åˆ¶,è‡ªåŠ¨å¾ªç¯ç›´åˆ°æ‰€æœ‰è®°å½•çš„æœªæ’æ•°é‡=0
    // è§¦å‘æ¡ä»¶:å·¥åºè®¡åˆ’åˆ›å»ºæˆåŠŸ,ä¸”"æœªæ’æ•°é‡>0"
    let totalNewRecords = 0
    let maxNewRecords = 100  // âœ… å–æ¶ˆä¸´æ—¶é™åˆ¶:å…è®¸ç”Ÿæˆæœ€å¤š100æ¡æ–°è®°å½•(é˜²æ­¢æ— é™å¾ªç¯)
    let iteration = 0
    
    // âœ… ç”¨äºæ ‡è®°å“ªäº›è®°å½•å·²ç»ä½œä¸ºæºæ•°æ®ç”Ÿæˆè¿‡æ–°è®°å½•
    const processedRecords = new Set()
            
    while (totalNewRecords < maxNewRecords) {
      iteration++
      console.log(`\nğŸ”„ [è‡ªå¢å¾ªç¯ ${iteration}] æ£€æŸ¥æ˜¯å¦æœ‰æœªæ’æ•°é‡>0çš„è®°å½•... (å·²ç”Ÿæˆ${totalNewRecords}/${maxNewRecords}æ¡)`)
              
      const newRecords = []
              
      // âœ… ã€å…³é”®ä¿®å¤ã€‘:åªæ£€æŸ¥æœ¬è½®å¾ªç¯å¼€å§‹å‰å·²å­˜åœ¨çš„è®°å½•,é¿å…é‡å¤ç”Ÿæˆ
      const existingRecordsCount = tableData.value.length
              
      // æ£€æŸ¥å·²å­˜åœ¨çš„è®°å½•(ä¸åŒ…æ‹¬æœ¬è½®æ–°ç”Ÿæˆçš„),æ‰¾å‡ºæ»¡è¶³è‡ªå¢æ¡ä»¶çš„è®°å½•
      for (let i = 0; i < existingRecordsCount; i++) {
        const row = tableData.value[i]
        
        // âš ï¸ è·³è¿‡å·²ç»ä½œä¸ºæºæ•°æ®ç”Ÿæˆè¿‡æ–°è®°å½•çš„è¡Œ
        if (processedRecords.has(row.planNo)) {
          console.log(`â­ï¸ è·³è¿‡å·²å¤„ç†çš„è®°å½•: ${row.planNo}`)
          continue
        }
                
        // âœ… æ£€æŸ¥è‡ªå¢è§¦å‘æ¡ä»¶(è§„åˆ™7):
        // 1. ä¸‹ä¸€ä¸ªæ’ç¨‹æ—¥æœŸä¸ä¸ºç©º
        // 2. å‰©ä½™éœ€æ±‚å·¥æ—¶ä¸ä¸ºç©º
        // 3. æœªæ’æ•°é‡ä¸ä¸ºç©º
        // 4. æœªæ’æ•°é‡ > 0
        const hasNextScheduleDate = row.nextScheduleDate && row.nextScheduleDate !== null && row.nextScheduleDate !== ''
        const hasRemainingRequiredHours = row.remainingRequiredHours !== null && row.remainingRequiredHours !== undefined && row.remainingRequiredHours !== ''
        const hasUnscheduledQty = row.unscheduledQty !== null && row.unscheduledQty !== undefined && row.unscheduledQty !== ''
        const unscheduledQtyGreaterThanZero = parseFloat(row.unscheduledQty || 0) > 0
        
        if (hasNextScheduleDate && hasRemainingRequiredHours && hasUnscheduledQty && unscheduledQtyGreaterThanZero) {
          // âš ï¸ åœ¨ç”Ÿæˆæ–°è®°å½•å‰æ£€æŸ¥æ˜¯å¦è¾¾åˆ°ä¸Šé™
          if (totalNewRecords + newRecords.length >= maxNewRecords) {
            console.log(`âš ï¸ å·²è¾¾åˆ°ç”Ÿæˆä¸Šé™(${maxNewRecords}æ¡),åœæ­¢ç”Ÿæˆæ–°è®°å½•`)
            break
          }
          console.log(`âœ… æ»¡è¶³è‡ªå¢æ¡ä»¶: ${row.planNo}, ä¸‹ä¸€ä¸ªæ’ç¨‹æ—¥æœŸ=${row.nextScheduleDate}, å‰©ä½™éœ€æ±‚å·¥æ—¶=${row.remainingRequiredHours}, æœªæ’æ•°é‡=${row.unscheduledQty}`)
          
          // âœ… åˆ›å»ºæ–°è®°å½•
          const newRecord = {
            // ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆå­—æ®µ
            planNo: generatePlanNo(),
            id: null,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            submittedAt: new Date().toISOString(),
            
            // âœ… è®¡åˆ’æ’ç¨‹æ—¥æœŸ = ä¸‹ä¸€ä¸ªæ’ç¨‹æ—¥æœŸ
            scheduleDate: row.nextScheduleDate,
            
            // âœ… å¤åˆ¶çš„å­—æ®µ
            salesOrderNo: row.salesOrderNo,
            masterPlanNo: row.masterPlanNo,
            shippingPlanNo: row.shippingPlanNo,
            productCode: row.productCode,
            productName: row.productName,
            productImage: row.productImage,
            processManager: row.processManager,
            processName: row.processName,
            productUnit: row.productUnit,
            level0Demand: row.level0Demand,
            completionDate: row.completionDate,
            planEndDate: row.planEndDate,
            workshopName: row.workshopName,
            standardWorkQuota: row.standardWorkQuota,
            standardWorkHours: row.standardWorkHours,
            replenishmentQty: row.replenishmentQty,
            sourceNo: row.sourceNo,
            customerName: row.customerName,
            bomNo: row.bomNo,
            hierarchyAddress: row.hierarchyAddress,
            submittedBy: row.submittedBy,
            
            // âœ… æ’ç¨‹æ¬¡æ•° = æ’ç¨‹æ¬¡æ•° + 1
            scheduleCount: (parseFloat(row.scheduleCount || 0) + 1),
            
            // âœ… éœ€æ±‚å·¥æ—¶ = å‰©ä½™éœ€æ±‚å·¥æ—¶
            requiredWorkHours: row.remainingRequiredHours,
            
            // âœ… è®¡åˆ’å¼€å§‹æ—¥æœŸ = "/"
            planStartDate: null,
            
            // âœ… çœŸè®¡åˆ’å¼€å§‹æ—¥æœŸ = "/"
            realPlanStartDate: null,
            
            // âœ… ç´¯ç§¯æ’ç¨‹æ•°é‡ = ç´¯ç§¯æ’ç¨‹æ•°é‡ï¼ˆå¤åˆ¶ï¼‰
            cumulativeScheduleQty: row.cumulativeScheduleQty,
            
            // âœ… éœ€è¦é‡æ–°è®¡ç®—çš„å­—æ®µ
            dailyTotalHours: 0,
            dailyScheduledHours: 0,
            dailyAvailableHours: 0,
            scheduleQuantity: 0,
            scheduledWorkHours: 0,
            nextScheduleDate: null,
            unscheduledQty: 0,
            remainingRequiredHours: 0
          }
          
          newRecords.push(newRecord)
          console.log(`âœ… ç”Ÿæˆæ–°è®°å½•: ${newRecord.planNo}, è®¡åˆ’æ’ç¨‹æ—¥æœŸ: ${newRecord.scheduleDate}, æ’ç¨‹æ¬¡æ•°: ${newRecord.scheduleCount}`)
          
          // âœ… æ ‡è®°è¯¥è®°å½•å·²ç»ä½œä¸ºæºæ•°æ®ç”Ÿæˆè¿‡æ–°è®°å½•
          processedRecords.add(row.planNo)
          console.log(`ğŸ”’ æ ‡è®°è®°å½•ä¸ºå·²å¤„ç†: ${row.planNo}`)
        }
      }
      
      // å¦‚æœæ²¡æœ‰æ–°è®°å½•æˆ–è¾¾åˆ°ä¸Šé™,é€€å‡ºå¾ªç¯
      if (newRecords.length === 0 || totalNewRecords >= maxNewRecords) {
        if (totalNewRecords >= maxNewRecords) {
          console.log(`âš ï¸ [è‡ªå¢å¾ªç¯ç»“æŸ] è¾¾åˆ°ç”Ÿæˆä¸Šé™(${maxNewRecords}æ¡),å…±å¾ªç¯${iteration}æ¬¡`)
        } else {
          console.log(`âœ… [è‡ªå¢å¾ªç¯ç»“æŸ] æ‰€æœ‰è®°å½•çš„æœªæ’æ•°é‡éƒ½=0,å…±å¾ªç¯${iteration}æ¬¡,ç”Ÿæˆ${totalNewRecords}æ¡æ–°è®°å½•`)
        }
        break
      }
      
      console.log(`ğŸ“ [è‡ªå¢å¾ªç¯ ${iteration}] æœ¬è½®ç”Ÿæˆ ${newRecords.length} æ¡æ–°è®°å½•`)
      totalNewRecords += newRecords.length
      
      // âœ… å°†æ–°è®°å½•æ·»åŠ åˆ°tableData
      tableData.value = [...tableData.value, ...newRecords]
      
      // âœ… é‡æ–°è®¡ç®—æ–°è®°å½•çš„å­—æ®µ - æ€§èƒ½ä¼˜åŒ–:å¹¶è¡Œæ‰§è¡Œå¯ä»¥å¹¶è¡Œçš„APIè°ƒç”¨
      const recalcPromises = newRecords.map(async (newRow) => {
        if (!newRow.processName || !newRow.scheduleDate) {
          return newRow
        }
        
        try {
          const scheduleDateFormatted = formatDateYMD(newRow.scheduleDate)
          if (!scheduleDateFormatted) return newRow
          
          const minRemainingHours = currentBusinessVars.value.minRemainingHours || 0.5
          
          // âœ… æ€§èƒ½ä¼˜åŒ–: å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰APIæŸ¥è¯¢
          const [
            endResponse,
            capacityResponse,
            materialResponse
          ] = await Promise.all([
            // 1. æŸ¥è¯¢è®¡åˆ’ç»“æŸæ—¥æœŸ
            capacityLoadApi.queryPlanEndDate(newRow.processName, formatDateYMD(newRow.completionDate), minRemainingHours),
            // 2. æŸ¥è¯¢å½“å¤©æ€»å·¥æ—¶
            capacityLoadApi.queryCapacityByDate(newRow.processName, scheduleDateFormatted),
            // 3. æŸ¥è¯¢æœ€å°åŒ…è£…é‡
            newRow.productCode 
              ? materialApiService.getMaterialByCode(newRow.productCode).catch(err => {
                  console.warn(`âš ï¸ æ–°è®°å½•æŸ¥è¯¢æœ€å°åŒ…è£…é‡å¤±è´¥:`, err)
                  return null
                })
              : Promise.resolve(null)
          ])
          
          // âœ… å¤„ç†è®¡åˆ’ç»“æŸæ—¥æœŸ
          if (endResponse?.planEndDate) {
            newRow.planEndDate = endResponse.planEndDate
          }
          
          // âœ… å¤„ç†å½“å¤©æ€»å·¥æ—¶
          if (capacityResponse) {
            const availableWorkstations = parseFloat(capacityResponse.availableWorkstations || 0)
            const workShift = parseFloat(capacityResponse.workShift || 0)
            newRow.dailyTotalHours = parseFloat((availableWorkstations * workShift).toFixed(2))
          }
          
          // âœ… è®¡ç®—å½“å¤©å·²æ’ç¨‹å·¥æ—¶ï¼ˆSUMIFSï¼‰
          const scheduleDateFormattedForSum = formatDateYMD(newRow.scheduleDate)
          let sumScheduledHours = 0
          for (const compareRow of tableData.value) {
            if (compareRow.processName === newRow.processName && 
                formatDateYMD(compareRow.scheduleDate) === scheduleDateFormattedForSum &&
                compareRow.planNo !== newRow.planNo) {
              sumScheduledHours += parseFloat(compareRow.scheduledWorkHours || 0)
            }
          }
          newRow.dailyScheduledHours = parseFloat(sumScheduledHours.toFixed(2))
          
          // âœ… å·¥åºå½“å¤©å¯ç”¨å·¥æ—¶ = å½“å¤©æ€»å·¥æ—¶ - å½“å¤©å·²æ’ç¨‹å·¥æ—¶
          newRow.dailyAvailableHours = parseFloat((newRow.dailyTotalHours - newRow.dailyScheduledHours).toFixed(2))
          
          // âœ… è®¡åˆ’æ’ç¨‹å·¥æ—¶ = MIN(éœ€æ±‚å·¥æ—¶, å·¥åºå½“å¤©å¯ç”¨å·¥æ—¶)
          newRow.scheduledWorkHours = parseFloat(Math.min(newRow.requiredWorkHours, newRow.dailyAvailableHours).toFixed(2))
          
          // âœ… å¤„ç†æœ€å°åŒ…è£…é‡å¹¶è®¡ç®—è®¡åˆ’æ’ç¨‹æ•°é‡
          if (materialResponse && materialResponse.minimumPackagingQuantity !== undefined) {
            const minimumPackagingQty = parseFloat(materialResponse.minimumPackagingQuantity || 1)
            const standardWorkQuota = parseFloat(newRow.standardWorkQuota || 0)
            if (standardWorkQuota > 0 && minimumPackagingQty > 0) {
              const rawQuantity = newRow.scheduledWorkHours * standardWorkQuota
              newRow.scheduleQuantity = parseFloat((Math.ceil(rawQuantity / minimumPackagingQty) * minimumPackagingQty).toFixed(4))
            }
          }
          
          // âœ… é‡æ–°è®¡ç®—ç´¯ç§¯æ’ç¨‹æ•°é‡ï¼ˆSUMIFSï¼šæ¥æºç¼–å·+ç”Ÿäº§äº§å“ç¼–å·åŒ¹é…ï¼ŒåŒ…æ‹¬æœ¬è¡Œï¼‰
          let cumulativeQty = 0
          for (const compareRow of tableData.value) {
            // âœ… åŒ…æ‹¬æœ¬è¡Œï¼Œä¸æ­¥éª¤6é€»è¾‘ä¸€è‡´
            if (compareRow.sourceNo === newRow.sourceNo && 
                compareRow.productCode === newRow.productCode) {
              cumulativeQty += parseFloat(compareRow.scheduleQuantity || 0)
            }
          }
          newRow.cumulativeScheduleQty = parseFloat(cumulativeQty.toFixed(4))
          console.log(`ğŸ”¢ [${newRow.planNo}] SUMIFSç´¯ç§¯æ’ç¨‹æ•°é‡è®¡ç®—(åŒ…æ‹¬æœ¬è¡Œ): æ¥æºç¼–å·=${newRow.sourceNo}, äº§å“ç¼–å·=${newRow.productCode}, ç´¯ç§¯=${newRow.cumulativeScheduleQty}`)
          
          // âœ… é‡æ–°è®¡ç®—æœªæ’æ•°é‡å’Œå‰©ä½™éœ€æ±‚å·¥æ—¶
          // âš ï¸ æœªæ’æ•°é‡ = éœ€è¡¥è´§æ•°é‡ - ç´¯ç§¯æ’ç¨‹æ•°é‡ (ä¸å†å‡å»è®¡åˆ’æ’ç¨‹æ•°é‡ï¼Œå› ä¸ºç´¯ç§¯å·²åŒ…å«æœ¬è¡Œ)
          const replenishmentQty = parseFloat(newRow.replenishmentQty || 0)
          newRow.unscheduledQty = parseFloat((replenishmentQty - newRow.cumulativeScheduleQty).toFixed(4))
          
          const standardWorkQuota = parseFloat(newRow.standardWorkQuota || 0)
          if (standardWorkQuota > 0 && newRow.unscheduledQty > 0) {
            newRow.remainingRequiredHours = parseFloat((newRow.unscheduledQty / standardWorkQuota).toFixed(2))
          } else {
            newRow.remainingRequiredHours = 0
          }
          
          console.log(`ğŸ“Š [${newRow.planNo}] ç´¯ç§¯æ’ç¨‹æ•°é‡: ${newRow.cumulativeScheduleQty}, è®¡åˆ’æ’ç¨‹æ•°é‡: ${newRow.scheduleQuantity}, æœªæ’æ•°é‡: ${newRow.unscheduledQty}`)
          
          // âœ… æŸ¥è¯¢ä¸‹ä¸€ä¸ªæ’ç¨‹æ—¥æœŸï¼ˆåªæœ‰æœªæ’æ•°é‡>0æ—¶æ‰éœ€è¦æŸ¥è¯¢ï¼‰
          if (newRow.unscheduledQty > 0) {
            const nextDateResponse = await capacityLoadApi.queryNextScheduleDate(
              newRow.processName, 
              scheduleDateFormatted, 
              minRemainingHours
            )
            if (nextDateResponse?.nextScheduleDate) {
              newRow.nextScheduleDate = nextDateResponse.nextScheduleDate
              console.log(`ğŸ”„ [${newRow.planNo}] æœªæ’æ•°é‡=${newRow.unscheduledQty}>0ï¼Œä¸‹ä¸€ä¸ªæ’ç¨‹æ—¥æœŸ=${newRow.nextScheduleDate}`)
            } else {
              console.warn(`âš ï¸ [${newRow.planNo}] æœªæ’æ•°é‡=${newRow.unscheduledQty}>0ï¼Œä½†æœªæ‰¾åˆ°ä¸‹ä¸€ä¸ªæ’ç¨‹æ—¥æœŸ`)
            }
          }
          
        } catch (error) {
          console.error(`â— æ–°è®°å½•è®¡ç®—å¤±è´¥:`, error)
        }
        
        return newRow
      })
      
      await Promise.all(recalcPromises)
      console.log(`âœ… [è‡ªå¢å¾ªç¯ ${iteration}] æœ¬è½®${newRecords.length}æ¡æ–°è®°å½•è®¡ç®—å®Œæˆ`)
      
      // âœ… æ­¥éª¤ 7.5ï¼šå¯¹æœ¬è½®æ–°å¢è®°å½•ä¹Ÿæ›´æ–°å·¥åºèƒ½åŠ›è´Ÿè·è¡¨çš„å·²å ç”¨å·¥æ—¶
      console.log(`ğŸ”„ [è‡ªå¢å¾ªç¯ ${iteration}] å¼€å§‹æ›´æ–°${newRecords.length}æ¡æ–°è®°å½•çš„å·²å ç”¨å·¥æ—¶`)
      const updateNewRecordsPromises = newRecords.map(async (newRow) => {
        // éªŒè¯è§¦å‘æ¡ä»¶
        if (!newRow.scheduledWorkHours || parseFloat(newRow.scheduledWorkHours) === 0) {
          console.log(`â­ï¸ [${newRow.planNo}] è·³è¿‡æ›´æ–°å·²å ç”¨å·¥æ—¶: è®¡åˆ’æ’ç¨‹å·¥æ—¶ä¸ºç©ºæˆ–0`)
          return newRow
        }
        
        if (!newRow.processName || !newRow.scheduleDate) {
          console.warn(`âš ï¸ [${newRow.planNo}] è·³è¿‡æ›´æ–°å·²å ç”¨å·¥æ—¶: ç¼ºå°‘å·¥åºåç§°æˆ–è®¡åˆ’æ’ç¨‹æ—¥æœŸ`)
          return newRow
        }
        
        try {
          const scheduleDateFormatted = formatDateYMD(newRow.scheduleDate)
          
          console.log(`ğŸ”„ [${newRow.planNo}] æ›´æ–°å·²å ç”¨å·¥æ—¶: å·¥åº=${newRow.processName}, æ—¥æœŸ=${scheduleDateFormatted}, è®¡åˆ’æ’ç¨‹å·¥æ—¶=${newRow.scheduledWorkHours}`)
          
          // è°ƒç”¨APIæ›´æ–°
          const updateResponse = await capacityLoadApi.updateOccupiedHours(
            newRow.processName,
            scheduleDateFormatted,
            newRow.scheduledWorkHours
          )
          
          if (updateResponse?.updated) {
            console.log(`âœ… [${newRow.planNo}] å·²å ç”¨å·¥æ—¶æ›´æ–°æˆåŠŸ: ${updateResponse.previousOccupiedHours} + ${updateResponse.addedHours} = ${updateResponse.newOccupiedHours}`)
          }
        } catch (error) {
          console.error(`â— [${newRow.planNo}] æ›´æ–°å·²å ç”¨å·¥æ—¶å¤±è´¥:`, error)
          // ä¸é˜»å¡ä¸»æµç¨‹
        }
        
        return newRow
      })
      
      await Promise.all(updateNewRecordsPromises)
      console.log(`âœ… [è‡ªå¢å¾ªç¯ ${iteration}] æœ¬è½®æ–°è®°å½•å·²å ç”¨å·¥æ—¶æ›´æ–°å®Œæˆ`)
    }
    
    // âœ… åˆ é™¤ä¸´æ—¶æç¤ºï¼Œç»Ÿä¸€ä½¿ç”¨æˆåŠŸæ¶ˆæ¯
    if (totalNewRecords > 0) {
      ElMessage.success(`æ•°æ®åŠ è½½æˆåŠŸ,è‡ªåŠ¨ç”Ÿæˆ ${totalNewRecords} æ¡æ–°æ’ç¨‹è®°å½•`)
    } else {
      ElMessage.success('æ•°æ®åŠ è½½æˆåŠŸ')
    }
  } catch (error) {
    console.error('âŒ åŠ è½½æ•°æ®å¤±è´¥:', error)
    ElMessage.error('åŠ è½½æ•°æ®å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'))
  } finally {
    loading.value = false
  }
}

// æœç´¢
const handleSearch = () => {
  pagination.page = 1
  loadData()
}

// é‡ç½®
const handleReset = () => {
  Object.keys(searchForm).forEach(key => {
    searchForm[key] = Array.isArray(searchForm[key]) ? [] : ''
  })
  pagination.page = 1
  loadData()
}

// æ–°å¢
const handleAdd = () => {
  isEdit.value = false
  formData.value = {
    planNo: generatePlanNo(),
    scheduleDate: new Date(),
    scheduleQuantity: 0,
    scheduledWorkHours: 0,  // âœ… æ”¹åï¼šè®¡åˆ’æ’ç¨‹å·¥æ—¶
    standardWorkHours: 0,
    replenishmentQty: 0
  }
  dialogVisible.value = true
}

// ç¼–è¾‘
const handleEdit = (row) => {
  isEdit.value = true
  formData.value = { ...row }
  dialogVisible.value = true
}

// åˆ é™¤
const handleDelete = async (row) => {
  try {
    await ElMessageBox.confirm(`ç¡®å®šè¦åˆ é™¤å·¥åºè®¡åˆ’â€œ${row.planNo}â€å—?`, 'æç¤º', {
      confirmButtonText: 'ç¡®å®š',
      cancelButtonText: 'å–æ¶ˆ',
      type: 'warning'
    })
    
    // âœ… æ­¥éª¤1ï¼šè®°å½•åˆ é™¤å‰çš„å…³é”®ä¿¡æ¯ï¼ˆç”¨äºé‡Šæ”¾å·²å ç”¨å·¥æ—¶ï¼‰
    const deletedInfo = {
      planNo: row.planNo,
      processName: row.processName,
      scheduleDate: row.scheduleDate,
      scheduledWorkHours: parseFloat(row.scheduledWorkHours || 0)
    }
    
    console.log(`ğŸ—‘ï¸ åˆ é™¤å·¥åºè®¡åˆ’:`, deletedInfo)
    
    // âœ… æ­¥éª¤2ï¼šæ‰§è¡Œåˆ é™¤
    await api.deleteById(row.id)
    console.log(`âœ… å·¥åºè®¡åˆ’åˆ é™¤æˆåŠŸ`)
    
    // âœ… æ­¥éª¤3ï¼šå¦‚æœæœ‰è®¡åˆ’æ’ç¨‹å·¥æ—¶ï¼Œé‡Šæ”¾å·¥åºèƒ½åŠ›è´Ÿè·è¡¨çš„å·²å ç”¨å·¥æ—¶ï¼ˆå‡æ³•é€»è¾‘ï¼‰
    if (deletedInfo.scheduledWorkHours > 0 && deletedInfo.processName && deletedInfo.scheduleDate) {
      try {
        const scheduleDateFormatted = formatDateYMD(deletedInfo.scheduleDate)
        console.log(`ğŸ”„ å¼€å§‹é‡Šæ”¾å·²å ç”¨å·¥æ—¶: å·¥åº=${deletedInfo.processName}, æ—¥æœŸ=${scheduleDateFormatted}, å·¥æ—¶=${deletedInfo.scheduledWorkHours}`)
        
        const releaseResponse = await capacityLoadApi.releaseOccupiedHours(
          deletedInfo.processName,
          scheduleDateFormatted,
          deletedInfo.scheduledWorkHours
        )
        
        if (releaseResponse?.updated) {
          console.log(`âœ… å·²å ç”¨å·¥æ—¶é‡Šæ”¾æˆåŠŸ: ${releaseResponse.previousOccupiedHours} - ${releaseResponse.releasedHours} = ${releaseResponse.newOccupiedHours}`)
        } else {
          console.log(`âš ï¸ æœªæ‰¾åˆ°åŒ¹é…è®°å½•ï¼Œè·³è¿‡é‡Šæ”¾: ${releaseResponse?.reason || 'æœªçŸ¥åŸå› '}`)
        }
      } catch (error) {
        console.error(`â— é‡Šæ”¾å·²å ç”¨å·¥æ—¶å¤±è´¥:`, error)
        // ä¸é˜»å¡ä¸»æµç¨‹
      }
    } else {
      console.log(`â­ï¸ è·³è¿‡é‡Šæ”¾: è®¡åˆ’æ’ç¨‹å·¥æ—¶=${deletedInfo.scheduledWorkHours}, å·¥åº=${deletedInfo.processName}, æ—¥æœŸ=${deletedInfo.scheduleDate}`)
    }
    
    ElMessage.success('åˆ é™¤æˆåŠŸ')
    loadData()
  } catch (error) {
    if (error !== 'cancel') {
      console.error('âŒ åˆ é™¤å¤±è´¥:', error)
      ElMessage.error('åˆ é™¤å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'))
    }
  }
}

// æ‰¹é‡åˆ é™¤
const handleBatchDelete = async () => {
  if (selectedRows.value.length === 0) {
    ElMessage.warning('è¯·é€‰æ‹©è¦åˆ é™¤çš„è®°å½•')
    return
  }

  try {
    await ElMessageBox.confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedRows.value.length} æ¡è®°å½•å—?`, 'æç¤º', {
      confirmButtonText: 'ç¡®å®š',
      cancelButtonText: 'å–æ¶ˆ',
      type: 'warning'
    })
    
    // âœ… æ­¥éª¤1ï¼šè®°å½•æ‰€æœ‰åˆ é™¤è®°å½•çš„å…³é”®ä¿¡æ¯
    const deletedRecordsInfo = selectedRows.value
      .filter(row => row.scheduledWorkHours && parseFloat(row.scheduledWorkHours) > 0)
      .map(row => ({
        processName: row.processName,
        scheduleDate: row.scheduleDate,
        scheduledWorkHours: parseFloat(row.scheduledWorkHours || 0),
        planNo: row.planNo
      }))
    
    console.log(`ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤ ${selectedRows.value.length} æ¡è®°å½•ï¼Œå…¶ä¸­ ${deletedRecordsInfo.length} æ¡éœ€è¦é‡Šæ”¾å·²å ç”¨å·¥æ—¶`)
    
    // âœ… æ­¥éª¤2ï¼šæ‰§è¡Œæ‰¹é‡åˆ é™¤
    const ids = selectedRows.value.map(row => row.id)
    await api.batchDelete(ids)
    console.log(`âœ… æ‰¹é‡åˆ é™¤æˆåŠŸ`)
    
    // âœ… æ­¥éª¤3ï¼šåˆå¹¶åŒä¸€å·¥åº+åŒä¸€æ—¥æœŸçš„å·¥æ—¶ï¼Œé¿å…ç«æ€æ¡ä»¶
    if (deletedRecordsInfo.length > 0) {
      console.log(`ğŸ”„ å¼€å§‹é‡Šæ”¾ ${deletedRecordsInfo.length} æ¡è®°å½•çš„å·²å ç”¨å·¥æ—¶`)
      
      // âœ¨ å…³é”®ä¼˜åŒ–ï¼šæŒ‰å·¥åº+æ—¥æœŸåˆå¹¶å·¥æ—¶
      const mergedMap = new Map()
      
      deletedRecordsInfo.forEach(info => {
        const scheduleDateFormatted = formatDateYMD(info.scheduleDate)
        const key = `${info.processName}__${scheduleDateFormatted}` // å·¥åº+æ—¥æœŸä½œä¸ºå”¯ä¸€key
        
        if (mergedMap.has(key)) {
          // å·²å­˜åœ¨ï¼Œç´¯åŠ å·¥æ—¶
          const existing = mergedMap.get(key)
          existing.totalHours += info.scheduledWorkHours
          existing.planNos.push(info.planNo)
        } else {
          // æ–°å¢
          mergedMap.set(key, {
            processName: info.processName,
            scheduleDate: scheduleDateFormatted,
            totalHours: info.scheduledWorkHours,
            planNos: [info.planNo]
          })
        }
      })
      
      console.log(`ğŸ“Š åˆå¹¶åéœ€è¦é‡Šæ”¾ ${mergedMap.size} ä¸ªå·¥åº-æ—¥æœŸç»„åˆ`)
      
      // âœ… é¡ºåºæ‰§è¡Œé‡Šæ”¾ï¼ˆé¿å…å¹¶å‘ç«æ€ï¼‰
      for (const [key, merged] of mergedMap.entries()) {
        try {
          console.log(`ğŸ”„ [å·¥åº=${merged.processName}, æ—¥æœŸ=${merged.scheduleDate}] é‡Šæ”¾æ€»å·¥æ—¶=${merged.totalHours.toFixed(2)}, æ¶‰åŠè®¡åˆ’: ${merged.planNos.join(', ')}`)
          
          const releaseResponse = await capacityLoadApi.releaseOccupiedHours(
            merged.processName,
            merged.scheduleDate,
            merged.totalHours
          )
          
          if (releaseResponse?.updated) {
            console.log(`âœ… [å·¥åº=${merged.processName}, æ—¥æœŸ=${merged.scheduleDate}] é‡Šæ”¾æˆåŠŸ: ${releaseResponse.previousOccupiedHours} - ${releaseResponse.releasedHours} = ${releaseResponse.newOccupiedHours}`)
          } else {
            console.log(`âš ï¸ [å·¥åº=${merged.processName}, æ—¥æœŸ=${merged.scheduleDate}] æœªæ‰¾åˆ°åŒ¹é…è®°å½•: ${releaseResponse?.reason || 'æœªçŸ¥åŸå› '}`)
          }
        } catch (error) {
          console.error(`â— [å·¥åº=${merged.processName}, æ—¥æœŸ=${merged.scheduleDate}] é‡Šæ”¾å¤±è´¥:`, error)
          // ä¸é˜»å¡å…¶ä»–è®°å½•
        }
      }
      
      console.log(`âœ… æ‰€æœ‰å·²å ç”¨å·¥æ—¶é‡Šæ”¾å®Œæˆ`)
    }
    
    ElMessage.success('æ‰¹é‡åˆ é™¤æˆåŠŸ')
    selectedRows.value = []
    loadData()
  } catch (error) {
    if (error !== 'cancel') {
      console.error('âŒ æ‰¹é‡åˆ é™¤å¤±è´¥:', error)
      ElMessage.error('æ‰¹é‡åˆ é™¤å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'))
    }
  }
}

// ä¿å­˜
const handleSave = async () => {
  try {
    await formRef.value.validate()
    
    if (isEdit.value) {
      await api.update(formData.value.id, formData.value)
      ElMessage.success('æ›´æ–°æˆåŠŸ')
    } else {
      await api.create(formData.value)
      ElMessage.success('åˆ›å»ºæˆåŠŸ')
    }
    
    dialogVisible.value = false
    loadData()
  } catch (error) {
    console.error('âŒ ä¿å­˜å¤±è´¥:', error)
    if (error !== false) {
      ElMessage.error('ä¿å­˜å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'))
    }
  }
}

// ç”Ÿæˆè®¡åˆ’ç¼–å·
const generatePlanNo = () => {
  const year = new Date().getFullYear()
  const timestamp = Date.now().toString().slice(-6)
  const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0')
  return `PP${year}${timestamp}${random}`
}

// å¯¼å…¥
const handleImport = () => {
  importDialogVisible.value = true
}

let importFile = null

const handleFileChange = (file) => {
  importFile = file.raw
}

const confirmImport = () => {
  if (!importFile) {
    ElMessage.warning('è¯·é€‰æ‹©æ–‡ä»¶')
    return
  }
  
  const reader = new FileReader()
  reader.onload = (e) => {
    try {
      const workbook = XLSX.read(e.target.result, { type: 'binary' })
      const worksheet = workbook.Sheets[workbook.SheetNames[0]]
      const jsonData = XLSX.utils.sheet_to_json(worksheet)
      
      // TODO: æ•°æ®æ˜ å°„å’Œå¯¼å…¥é€»è¾‘
      ElMessage.success(`æˆåŠŸå¯¼å…¥ ${jsonData.length} æ¡æ•°æ®`)
      importDialogVisible.value = false
      loadData()
    } catch (error) {
      console.error('âŒ å¯¼å…¥å¤±è´¥:', error)
      ElMessage.error('å¯¼å…¥å¤±è´¥')
    }
  }
  reader.readAsBinaryString(importFile)
}

// å¯¼å‡º
const handleExport = () => {
  const exportData = tableData.value.map(row => ({
    'å·¥åºè®¡åˆ’ç¼–å·': row.planNo,
    'è®¡åˆ’æ’ç¨‹æ—¥æœŸ': row.scheduleDate,
    'ä¸»ç”Ÿäº§è®¡åˆ’ç¼–å·': row.masterPlanNo,
    'å·¥åºåç§°': row.processName,
    'è®¡åˆ’æ’ç¨‹æ•°é‡': row.scheduleQuantity,
    'å·¥åºè´Ÿè´£äºº': row.processManager,
    'è½¦é—´åç§°': row.workshopName,
    'è®¡åˆ’å®Œå·¥æ—¥æœŸ': row.completionDate
  }))
  
  const worksheet = XLSX.utils.json_to_sheet(exportData)
  const workbook = XLSX.utils.book_new()
  XLSX.utils.book_append_sheet(workbook, worksheet, 'å·¥åºè®¡åˆ’')
  XLSX.writeFile(workbook, `å·¥åºè®¡åˆ’_${new Date().getTime()}.xlsx`)
  
  ElMessage.success('å¯¼å‡ºæˆåŠŸ')
}

// åˆ†é¡µå˜åŒ–
const handlePageChange = (page) => {
  pagination.page = page
  loadData()
}

const handleSizeChange = (size) => {
  pagination.pageSize = size
  pagination.page = 1
  loadData()
}

// é€‰æ‹©å˜åŒ–
const handleSelectionChange = (selection) => {
  selectedRows.value = selection
}

// é¡µé¢è®¾ç½®ä¿å­˜
const handleSavePageSettings = (settings) => {
  console.log('=== é¡µé¢è®¾ç½®ä¿å­˜è°ƒè¯•ä¿¡æ¯ ===')
  console.log('settings å¯¹è±¡:', settings)
  console.log('settings.fields:', settings.fields)
  console.log('å½“å‰ allColumns æ•°é‡:', allColumns.value.length)
  
  // âœ… ä¿å­˜ä¸šåŠ¡å˜é‡é…ç½®
  if (settings.businessVars) {
    console.log('âœ… ä¿å­˜ä¸šåŠ¡å˜é‡é…ç½®:', settings.businessVars)
    currentBusinessVars.value = {
      ...currentBusinessVars.value,
      ...settings.businessVars
    }
    console.log('âœ… å½“å‰ä¸šåŠ¡å˜é‡:', currentBusinessVars.value)
  }
  
  // âœ… åº”ç”¨åˆ—é¡ºåºå’Œå¯è§æ€§ï¼ˆæ”¯æŒæ‹–æ‹½ï¼‰
  if (settings.fields && Array.isArray(settings.fields)) {
    console.log('âœ… æ”¶åˆ°å­—æ®µè®¾ç½®ï¼Œæ•°é‡:', settings.fields.length)
    
    // æ ¹æ® settings.fields æ›´æ–° allColumns çš„é¡ºåºå’Œå¯è§æ€§
    const fieldMap = new Map(settings.fields.map(f => [f.prop, f]))
    
    // é‡æ–°æ’åº allColumns
    const newColumns = []
    settings.fields.forEach(field => {
      const col = allColumns.value.find(c => c.prop === field.prop)
      if (col) {
        // âœ… ä¿æŒæ‰€æœ‰åŸæœ‰å±æ€§ï¼Œåªæ›´æ–°å¯è§æ€§
        const newCol = {
          ...col,
          visible: field.visible !== false
        }
        newColumns.push(newCol)
        console.log(`âœ… æ·»åŠ åˆ—: ${field.label}, visible: ${field.visible}, fixed: ${col.fixed || 'none'}`)
      }
    })
    
    // æ·»åŠ æœªåœ¨ settings.fields ä¸­çš„åˆ—ï¼ˆä¿æŒåŸé¡ºåºï¼‰
    allColumns.value.forEach(col => {
      if (!fieldMap.has(col.prop)) {
        newColumns.push({ ...col })
      }
    })
    
    // âœ… å…³é”®ï¼šæ›¿æ¢æ•´ä¸ªæ•°ç»„å¼•ç”¨
    allColumns.value = newColumns
    
    console.log('âœ… åˆ—é¡ºåºå·²æ›´æ–°:')
    console.log('æ–°é¡ºåº:', newColumns.map(c => c.label).join(', '))
    console.log('å¯è§åˆ—:', newColumns.filter(c => c.visible).map(c => c.label).join(', '))
    
    // âœ… æ·»åŠ å»¶è¿Ÿï¼Œç¡®ä¿æ¸²æŸ“å®Œæˆ
    setTimeout(() => {
      console.log('âœ… åˆ—æ›´æ–°å®Œæˆ')
    }, 100)
    
  } else if (settings.visibleFields) {
    // å‘åå…¼å®¹ï¼šåªæœ‰å¯è§æ€§ï¼Œæ²¡æœ‰é¡ºåº
    allColumns.value.forEach(col => {
      col.visible = settings.visibleFields.includes(col.prop)
    })
    console.log('âœ… åº”ç”¨å¯è§æ€§è®¾ç½®ï¼ˆæ—§æ ¼å¼ï¼‰')
  }
  
  ElMessage.success('è®¾ç½®å·²åº”ç”¨')
}

// ========== åˆå§‹åŒ– ==========
onMounted(() => {
  loadData()
  
  // âœ… æ·»åŠ è°ƒè¯•ä¿¡æ¯
  console.log('=== å·¥åºè®¡åˆ’é¡µé¢åˆå§‹åŒ– ===')
  console.log('allColumns æ•°é‡:', allColumns.value.length)
  console.log('StandardTablePage ç‰ˆæœ¬: v2.1')
  console.log('åˆ—é…ç½®:', allColumns.value.map(c => `${c.label}(${c.prop})`).join(', '))
  console.log('fixed åˆ—:', allColumns.value.filter(c => c.fixed).map(c => `${c.label}: ${c.fixed}`).join(', '))
  console.log('é¡µé¢åŠ è½½å®Œæˆ')
})
</script>

<style scoped lang="scss">
// StandardTablePage v2.1 å·²åŒ…å«æ‰€æœ‰å“åº”å¼æ ·å¼ï¼Œæ— éœ€é¢å¤–æ ·å¼

// âœ… è¿›åº¦çŠ¶æ€æ—‹è½¬åŠ¨ç”»
@keyframes rotate {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}
</style>
