<template>
  <StandardTablePage
    page-title="å·¥åºè®¡åˆ’åˆ—è¡¨"
    settings-key="processPlanListV2"
    :table-data="tableData"
    :columns="allColumns"
    :loading="loading"
    :total="pagination.total"
    :current-page="pagination.page"
    :page-size="pagination.pageSize"
    :show-create="true"
    :show-page-settings="true"
    :show-selection="true"
    :show-filter="true"
    :show-pagination="true"
    :show-enhanced-toolbar="true"
    :show-add="false"
    :show-batch-delete="true"
    :show-export="true"
    :show-import="true"
    :show-print="true"
    :show-breadcrumb="true"
    :breadcrumb-items="breadcrumbItems"
    :show-business-vars="true"
    :disable-column-settings="true"
    :business-var-buttons="businessVarButtons"
    :business-var-selects="businessVarSelects"
    :default-settings="defaultSettings"
    @create="handleAdd"
    @selection-change="handleSelectionChange"
    @page-change="handlePageChange"
    @size-change="handleSizeChange"
    @batch-delete="handleBatchDelete"
    @export="handleExport"
    @import="handleImport"
    @refresh="loadData"
    @settings-save="handleSavePageSettings"
  >
    <!-- æœç´¢è¡¨å• -->
    <template #search-form>
      <el-form :inline="true" :model="searchForm" size="small">
        <el-form-item label="å·¥åºè®¡åˆ’ç¼–å·">
          <el-input 
            ref="searchInputRef"
            v-model="searchForm.planNo" 
            placeholder="è¯·è¾“å…¥" 
            clearable 
            @keyup.enter="handleSearch"
          />
        </el-form-item>
        <el-form-item label="ä¸»ç”Ÿäº§è®¡åˆ’ç¼–å·">
          <el-input v-model="searchForm.masterPlanNo" placeholder="è¯·è¾“å…¥" clearable />
        </el-form-item>
        <el-form-item label="å·¥åºåç§°">
          <el-input v-model="searchForm.processName" placeholder="è¯·è¾“å…¥" clearable />
        </el-form-item>
        <el-form-item label="è®¡åˆ’æ’ç¨‹æ—¥æœŸ">
          <el-date-picker
            v-model="searchForm.scheduleDateRange"
            type="daterange"
            range-separator="è‡³"
            start-placeholder="å¼€å§‹æ—¥æœŸ"
            end-placeholder="ç»“æŸæ—¥æœŸ"
            clearable
          />
        </el-form-item>
        <el-form-item>
          <el-button type="primary" @click="handleSearch">æŸ¥è¯¢</el-button>
          <el-button @click="handleReset">é‡ç½®</el-button>
        </el-form-item>
      </el-form>
    </template>

    <!-- äº§å“å›¾ç‰‡åˆ— -->
    <template #column-productImage="{ row }">
      <el-image
        v-if="row.productImage"
        :src="row.productImage"
        :preview-src-list="[row.productImage]"
        fit="cover"
        style="width: 50px; height: 50px; border-radius: 4px;"
      />
      <span v-else style="color: #999;">æ— å›¾ç‰‡</span>
    </template>

    <!-- âœ… è¿›åº¦çŠ¶æ€åˆ— -->
    <template #column-progressStatus="{ row }">
      <div style="display: flex; align-items: center; justify-content: center; gap: 6px;">
        <template v-if="row.unscheduledQty && row.unscheduledQty !== '' && row.unscheduledQty !== null && parseFloat(row.scheduledWorkHours || 0) > 0">
          <!-- æœªæ’æ•°é‡ä¸ä¸ºç©º AND è®¡åˆ’æ’ç¨‹å·¥æ—¶>0ï¼šæ’ç¨‹å®Œæ¯• -->
          <el-icon :size="16" color="#67C23A">
            <CircleCheck />
          </el-icon>
          <span style="color: #67C23A; font-weight: 500;">æ’ç¨‹å®Œæ¯•</span>
        </template>
        <template v-else-if="parseFloat(row.scheduledWorkHours || 0) === 0">
          <!-- è®¡åˆ’æ’ç¨‹å·¥æ—¶=0ï¼šæ’ç¨‹ä¸­ -->
          <el-icon :size="16" color="#E6A23C" style="animation: rotate 2s linear infinite;">
            <Loading />
          </el-icon>
          <span style="color: #E6A23C; font-weight: 500;">æ’ç¨‹ä¸­</span>
        </template>
        <template v-else>
          <!-- å…¶ä»–æƒ…å†µé»˜è®¤æ˜¾ç¤ºæ’ç¨‹ä¸­ -->
          <el-icon :size="16" color="#E6A23C" style="animation: rotate 2s linear infinite;">
            <Loading />
          </el-icon>
          <span style="color: #E6A23C; font-weight: 500;">æ’ç¨‹ä¸­</span>
        </template>
      </div>
    </template>

    <!-- âœ… BOMè¯¦æƒ…åˆ— -->
    <template #column-bomDetail="{ row }">
      <el-button 
        size="small" 
        type="primary" 
        link
        @click="handleShowBomDetail(row)"
      >
        æŸ¥çœ‹
      </el-button>
    </template>

    <!-- æ“ä½œåˆ— -->
    <template #column-actions="{ row }">
      <el-button size="small" type="primary" @click="handleEdit(row)">ç¼–è¾‘</el-button>
      <el-button size="small" type="danger" @click="handleDelete(row)">åˆ é™¤</el-button>
    </template>
  </StandardTablePage>

  <!-- æ–°å¢/ç¼–è¾‘å¯¹è¯æ¡† -->
  <el-dialog
    v-model="dialogVisible"
    :title="isEdit ? 'ç¼–è¾‘å·¥åºè®¡åˆ’' : 'æ–°å¢å·¥åºè®¡åˆ’'"
    width="80%"
    :close-on-click-modal="false"
  >
    <el-form ref="formRef" :model="formData" :rules="formRules" label-width="140px">
      <el-row :gutter="20">
        <el-col :span="8">
          <el-form-item label="å·¥åºè®¡åˆ’ç¼–å·" prop="planNo">
            <el-input v-model="formData.planNo" placeholder="è‡ªåŠ¨ç”Ÿæˆ" disabled />
          </el-form-item>
        </el-col>
        <el-col :span="8">
          <el-form-item label="ä¸»ç”Ÿäº§è®¡åˆ’ç¼–å·" prop="masterPlanNo">
            <el-input v-model="formData.masterPlanNo" placeholder="è¯·è¾“å…¥" />
          </el-form-item>
        </el-col>
        <el-col :span="8">
          <el-form-item label="å·¥åºåç§°" prop="processName">
            <el-input v-model="formData.processName" placeholder="è¯·è¾“å…¥" />
          </el-form-item>
        </el-col>
      </el-row>
      
      <el-row :gutter="20">
        <el-col :span="8">
          <el-form-item label="è®¡åˆ’æ’ç¨‹æ—¥æœŸ" prop="scheduleDate">
            <el-date-picker v-model="formData.scheduleDate" type="date" placeholder="é€‰æ‹©æ—¥æœŸ" style="width: 100%" />
          </el-form-item>
        </el-col>
        <el-col :span="8">
          <el-form-item label="è®¡åˆ’æ’ç¨‹æ•°é‡" prop="scheduleQuantity">
            <el-input-number v-model="formData.scheduleQuantity" :min="0" :precision="2" style="width: 100%" />
          </el-form-item>
        </el-col>
        <el-col :span="8">
          <el-form-item label="è®¡åˆ’å®Œå·¥æ—¥æœŸ" prop="completionDate">
            <el-date-picker v-model="formData.completionDate" type="date" placeholder="é€‰æ‹©æ—¥æœŸ" style="width: 100%" />
          </el-form-item>
        </el-col>
      </el-row>

      <el-row :gutter="20">
        <el-col :span="8">
          <el-form-item label="è®¡åˆ’å¼€å§‹æ—¥æœŸ" prop="planStartDate">
            <el-date-picker v-model="formData.planStartDate" type="date" placeholder="é€‰æ‹©æ—¥æœŸ" style="width: 100%" />
          </el-form-item>
        </el-col>
        <el-col :span="8">
          <el-form-item label="è®¡åˆ’ç»“æŸæ—¥æœŸ" prop="planEndDate">
            <el-date-picker v-model="formData.planEndDate" type="date" placeholder="é€‰æ‹©æ—¥æœŸ" disabled style="width: 100%" />
          </el-form-item>
        </el-col>
        <el-col :span="8">
          <el-form-item label="ç”Ÿäº§äº§å“ç¼–å·" prop="productCode">
            <el-input v-model="formData.productCode" placeholder="è¯·è¾“å…¥" />
          </el-form-item>
        </el-col>
      </el-row>

      <el-row :gutter="20">
        <el-col :span="8">
          <el-form-item label="ç”Ÿäº§äº§å“åç§°" prop="productName">
            <el-input v-model="formData.productName" placeholder="è¯·è¾“å…¥" />
          </el-form-item>
        </el-col>
        <el-col :span="8">
          <el-form-item label="å·¥åºè´Ÿè´£äºº" prop="processManager">
            <el-input v-model="formData.processManager" placeholder="è¯·è¾“å…¥" />
          </el-form-item>
        </el-col>
        <el-col :span="8">
          <el-form-item label="è½¦é—´åç§°" prop="workshopName">
            <el-input v-model="formData.workshopName" placeholder="è¯·è¾“å…¥" />
          </el-form-item>
        </el-col>
      </el-row>

      <el-row :gutter="20">
        <el-col :span="8">
          <el-form-item label="éœ€è¡¥è´§æ•°é‡" prop="replenishmentQty">
            <el-input-number v-model="formData.replenishmentQty" :min="0" :precision="2" placeholder="è¯·è¾“å…¥" style="width: 100%" />
          </el-form-item>
        </el-col>
        <el-col :span="8">
          <el-form-item label="å®šæ—¶å·¥é¢" prop="standardWorkQuota">
            <el-input-number v-model="formData.standardWorkQuota" :min="0" :precision="2" placeholder="è¯·è¾“å…¥" style="width: 100%" />
          </el-form-item>
        </el-col>
        <el-col :span="8">
          <el-form-item label="å®šé¢å·¥æ—¶" prop="standardWorkHours">
            <el-input-number v-model="formData.standardWorkHours" :min="0" :precision="2" style="width: 100%" />
          </el-form-item>
        </el-col>
      </el-row>

      <el-row :gutter="20">
        <el-col :span="8">
          <el-form-item label="éœ€æ±‚å·¥æ—¶" prop="requiredWorkHours">
            <el-input-number v-model="formData.requiredWorkHours" :min="0" :precision="2" disabled placeholder="è‡ªåŠ¨è®¡ç®—" style="width: 100%" />
          </el-form-item>
        </el-col>
        <el-col :span="8">
          <el-form-item label="è®¡åˆ’æ’ç¨‹å·¥æ—¶" prop="scheduledWorkHours">
            <el-input-number v-model="formData.scheduledWorkHours" :min="0" :precision="2" style="width: 100%" />
          </el-form-item>
        </el-col>
      </el-row>
    </el-form>

    <template #footer>
      <el-button @click="dialogVisible = false">å–æ¶ˆ</el-button>
      <el-button type="primary" @click="handleSave">ä¿å­˜</el-button>
    </template>
  </el-dialog>

  <!-- å¯¼å…¥å¯¹è¯æ¡† -->
  <el-dialog v-model="importDialogVisible" title="å¯¼å…¥å·¥åºè®¡åˆ’" width="500px">
    <el-upload
      drag
      :auto-upload="false"
      :on-change="handleFileChange"
      accept=".xlsx,.xls"
    >
      <el-icon class="el-icon--upload"><UploadFilled /></el-icon>
      <div class="el-upload__text">å°†æ–‡ä»¶æ‹–åˆ°æ­¤å¤„ï¼Œæˆ–<em>ç‚¹å‡»ä¸Šä¼ </em></div>
      <template #tip>
        <div class="el-upload__tip">åªæ”¯æŒ xlsx/xls æ ¼å¼æ–‡ä»¶</div>
      </template>
    </el-upload>
    <template #footer>
      <el-button @click="importDialogVisible = false">å–æ¶ˆ</el-button>
      <el-button type="primary" @click="confirmImport">ç¡®å®šå¯¼å…¥</el-button>
    </template>
  </el-dialog>

  <!-- âœ… å·¥åºé—´éš”è®¾ç½®å¼¹çª— -->
  <el-dialog
    v-model="processIntervalDialogVisible"
    title="å·¥åºé—´éš”è®¾ç½®"
    width="90%"
    top="5vh"
    :close-on-click-modal="false"
    destroy-on-close
  >
    <ProcessIntervalSettings />
  </el-dialog>

  <!-- âœ… BOMè¯¦æƒ…å¼¹çª— -->
  <BomDetailDialog ref="bomDetailDialogRef" />
</template>

<script setup>
import { ref, reactive, onMounted, watch } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import { UploadFilled, Loading, CircleCheck } from '@element-plus/icons-vue'
import StandardTablePage from '@/components/common/layout/StandardTablePage.vue'
import ProcessIntervalSettings from './ProcessIntervalSettings.vue'  // âœ… å¯¼å…¥å·¥åºé—´éš”è®¾ç½®ç»„ä»¶
import BomDetailDialog from './BomDetailDialog.vue'  // âœ… å¯¼å…¥BOMè¯¦æƒ…å¼¹çª—
import * as XLSX from 'xlsx'
import api from '@/api/processPlan'
import capacityLoadApi from '@/api/capacityLoad'  // âœ… å¯¼å…¥å·¥åºèƒ½åŠ›è´Ÿè·API
import materialApiService from '@/services/api/materialApiService'  // âœ… å¯¼å…¥äº§å“ç‰©æ–™åº“API
import dateUtils from '@/services/utils/date-utils'  // âœ… å¯¼å…¥æ—¥æœŸå·¥å…·

// âœ… æ—¥æœŸæ ¼å¼åŒ–å‡½æ•°ï¼šå¹´-æœˆ-æ—¥
const formatDateYMD = (date) => {
  if (!date) return ''
  return dateUtils.format(date, 'YYYY-MM-DD')
}

/**
 * å·¥åºè®¡åˆ’åˆ—è¡¨é¡µé¢ v2.0
 * ä½¿ç”¨ StandardTablePage v2.1 ç»Ÿä¸€ç»„ä»¶
 * 
 * åŠŸèƒ½ç‰¹ç‚¹ï¼š
 * 1. âœ… é¢åŒ…å±‘å¯¼èˆª
 * 2. âœ… å“åº”å¼æ–­ç‚¹ç³»ç»Ÿ
 * 3. âœ… é”®ç›˜å¯¼èˆªï¼ˆESC/Ctrl+F/Ctrl+Nï¼‰
 * 4. âœ… ç‚¹å‡»å¤–éƒ¨å…³é—­
 * 5. âœ… åˆ—æ‹–æ‹½ï¼ˆé€šè¿‡PageSettingsç»„ä»¶ï¼‰
 * 6. âœ… è¡¨å¤´ç­›é€‰ã€æ’åº
 * 7. âœ… å¢åˆ æ”¹æŸ¥ã€å¯¼å…¥å¯¼å‡ºã€æ‰“å°
 * 8. âœ… é¡µé¢è®¾ç½®ï¼ˆä¸šåŠ¡å˜é‡ã€å­—æ®µç®¡ç†ï¼‰
 * 
 * æ›´æ–°è®°å½•ï¼š
 * - v2.0 (2025-12-08): è¿ç§»åˆ° StandardTablePage v2.1 ç»Ÿä¸€ç»„ä»¶
 * - v1.0: åˆå§‹ç‰ˆæœ¬
 */

// ========== æ•°æ®çŠ¶æ€ ==========
const tableData = ref([])
const selectedRows = ref([])
const loading = ref(false)

// âœ… ä¸šåŠ¡å˜é‡å½“å‰é…ç½®
const currentBusinessVars = ref({
  defaultMergeRule: 'masterPlanNo',
  minRemainingHours: 0.5
})

// ========== é¢åŒ…å±‘å¯¼èˆª ==========
const breadcrumbItems = [
  { label: 'ç”Ÿäº§ç®¡ç†', path: '/production' },
  { label: 'è®¡åˆ’ç®¡ç†', path: '/production/planning' },
  { label: 'å·¥åºè®¡åˆ’' }
]

// ========== æœç´¢è¡¨å• ==========
const searchForm = reactive({
  planNo: '',
  masterPlanNo: '',
  processName: '',
  scheduleDateRange: []
})

const searchInputRef = ref(null)

// ========== åˆ†é¡µ ==========
const pagination = reactive({
  page: 1,
  pageSize: 20,
  total: 0
})

// ========== å¯¹è¯æ¡† ==========
const dialogVisible = ref(false)
const importDialogVisible = ref(false)
const isEdit = ref(false)

// ========== è¡¨å•æ•°æ® ==========
const formData = ref({})
const formRef = ref(null)

// ========== å®æ—¶è®¡ç®—éœ€æ±‚å·¥æ—¶ ==========
watch(
  () => [formData.value.replenishmentQty, formData.value.standardWorkQuota, formData.value.standardWorkHours],
  ([replenishmentQty, standardWorkQuota, standardWorkHours]) => {
    // âœ… åªåœ¨æ–°å¢æ¨¡å¼ä¸‹è‡ªåŠ¨è®¡ç®—ï¼Œç¼–è¾‘æ¨¡å¼ä¸è‡ªåŠ¨è®¡ç®—
    if (!isEdit.value && dialogVisible.value) {
      const qty = parseFloat(replenishmentQty || 0)
      const quota = parseFloat(standardWorkQuota || 0)
      const hours = parseFloat(standardWorkHours || 0)
      
      // âœ… æ£€æŸ¥ç”Ÿæˆæ¡ä»¶: (å®šæ—¶å·¥é¢>0 OR å®šé¢å·¥æ—¶>0) AND éœ€è¡¥è´§æ•°é‡>0
      if ((quota > 0 || hours > 0) && qty > 0) {
        // âœ… ä¼˜å…ˆä½¿ç”¨å®šæ—¶å·¥é¢è®¡ç®—,å¦‚æœå®šæ—¶å·¥é¢ä¸º0åˆ™ä½¿ç”¨å®šé¢å·¥æ—¶
        const divisor = quota > 0 ? quota : hours
        formData.value.requiredWorkHours = parseFloat((qty / divisor).toFixed(2))
        console.log(`ğŸ’¡ å®æ—¶è®¡ç®—éœ€æ±‚å·¥æ—¶: ${formData.value.requiredWorkHours} = ${qty} / ${divisor}`)
      } else {
        formData.value.requiredWorkHours = 0
      }
    }
  },
  { deep: true }
)

// ========== è¡¨å•éªŒè¯è§„åˆ™ ==========
const formRules = {
  processName: [{ required: true, message: 'è¯·è¾“å…¥å·¥åºåç§°', trigger: 'blur' }],
  scheduleQuantity: [{ required: true, message: 'è¯·è¾“å…¥è®¡åˆ’æ’ç¨‹æ•°é‡', trigger: 'blur' }]
}

// ========== BOMè¯¦æƒ…å¼¹çª— ==========
const bomDetailDialogRef = ref(null)

// æ‰“å¼€BOMè¯¦æƒ…
const handleShowBomDetail = (row) => {
  bomDetailDialogRef.value.open(row)
}

// ========== å·¥åºé—´éš”è®¾ç½®å¼¹çª— ==========
const processIntervalDialogVisible = ref(false)

// âœ… æ‰¹é‡é‡æ–°è®¡ç®—éœ€æ±‚å·¥æ—¶
const handleRecalculateRequiredHours = async () => {
  try {
    await ElMessageBox.confirm(
      'ç¡®å®šè¦é‡æ–°è®¡ç®—æ‰€æœ‰å·¥åºè®¡åˆ’çš„éœ€æ±‚å·¥æ—¶å—ï¼Ÿ\\n\\næ­¤æ“ä½œä¼šï¼š\\n1. æŒ‰å…¬å¼é‡æ–°è®¡ç®—ï¼šéœ€æ±‚å·¥æ—¶ = éœ€è¡¥è´§æ•°é‡ / å®šæ—¶å·¥é¢\\n2. å››èˆäº”å…¥ä¿ç•™2ä½å°æ•°\\n3. æ›´æ–°æ•°æ®åº“ä¸­çš„scheduled_hourså­—æ®µ\\n4. å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…',
      'æ‰¹é‡é‡æ–°è®¡ç®—éœ€æ±‚å·¥æ—¶ç¡®è®¤',
      {
        confirmButtonText: 'ç¡®å®šæ‰§è¡Œ',
        cancelButtonText: 'å–æ¶ˆ',
        type: 'warning',
        dangerouslyUseHTMLString: true
      }
    )

    console.log('ğŸ”„ å¼€å§‹æ‰¹é‡é‡æ–°è®¡ç®—éœ€æ±‚å·¥æ—¶...')
    
    // è·å–æ‰€æœ‰å·¥åºè®¡åˆ’æ•°æ®
    const allData = await api.getList({ page: 1, pageSize: 10000 })
    const allRecords = allData.records || []
    
    if (allRecords.length === 0) {
      ElMessage.warning('æ²¡æœ‰æ‰¾åˆ°å·¥åºè®¡åˆ’æ•°æ®')
      return
    }

    console.log(`ğŸ“Š æ‰¾åˆ° ${allRecords.length} æ¡å·¥åºè®¡åˆ’è®°å½•`)
    
    let successCount = 0
    let errorCount = 0
    let skipCount = 0

    // é€æ¡å¤„ç†
    for (let i = 0; i < allRecords.length; i++) {
      const record = allRecords[i]
      
      try {
        console.log(`\\nğŸ”„ [${i + 1}/${allRecords.length}] å¤„ç†è®°å½•: ${record.planNo}`)
        
        // æ£€æŸ¥å¿…è¦å­—æ®µ
        if (!record.replenishmentQty || !record.standardWorkQuota) {
          console.log(`â­ï¸ è·³è¿‡: ç¼ºå°‘éœ€è¡¥è´§æ•°é‡æˆ–å®šæ—¶å·¥é¢`)
          skipCount++
          continue
        }

        // è®¡ç®—éœ€æ±‚å·¥æ—¶ = éœ€è¡¥è´§æ•°é‡ / å®šæ—¶å·¥é¢
        const replenishmentQty = parseFloat(record.replenishmentQty || 0)
        const standardWorkQuota = parseFloat(record.standardWorkQuota || 0)
        let requiredHours = 0
        
        if (standardWorkQuota > 0 && replenishmentQty > 0) {
          requiredHours = parseFloat((replenishmentQty / standardWorkQuota).toFixed(2))
        }
        
        // æ›´æ–°æ•°æ®åº“
        await api.update(record.id, {
          ...record,
          scheduledHours: requiredHours  // âœ… éœ€æ±‚å·¥æ—¶ -> scheduled_hours
        })
        
        console.log(`âœ… æ›´æ–°æˆåŠŸ: ${record.planNo} -> ${requiredHours}å°æ—¶ (${replenishmentQty}/${standardWorkQuota})`)
        successCount++
        
        // é¿å…è¯·æ±‚è¿‡å¿«
        if (i % 10 === 0) {
          await new Promise(resolve => setTimeout(resolve, 100))
        }
        
      } catch (error) {
        console.error(`âŒ å¤„ç†è®°å½•å¤±è´¥: ${record.planNo}`, error)
        errorCount++
      }
    }

    console.log(`\\nâœ… æ‰¹é‡é‡æ–°è®¡ç®—å®Œæˆ:`)
    console.log(`   æ€»è®°å½•æ•°: ${allRecords.length}`)
    console.log(`   æˆåŠŸæ›´æ–°: ${successCount}`)
    console.log(`   è·³è¿‡è®°å½•: ${skipCount}`)
    console.log(`   å¤±è´¥è®°å½•: ${errorCount}`)

    ElMessage.success(
      `æ‰¹é‡é‡æ–°è®¡ç®—éœ€æ±‚å·¥æ—¶å®Œæˆï¼
æ€»è®¡: ${allRecords.length} æ¡
æˆåŠŸ: ${successCount} æ¡
è·³è¿‡: ${skipCount} æ¡
å¤±è´¥: ${errorCount} æ¡`
    )

    // é‡æ–°åŠ è½½æ•°æ®
    loadData()

  } catch (error) {
    if (error !== 'cancel') {
      console.error('âŒ æ‰¹é‡é‡æ–°è®¡ç®—å¤±è´¥:', error)
      ElMessage.error('æ‰¹é‡é‡æ–°è®¡ç®—å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'))
    }
  }
}

// æ‰“å¼€å·¥åºé—´éš”è®¾ç½®
const openProcessIntervalSettings = () => {
  processIntervalDialogVisible.value = true
}

// âœ… é‡æ–°è®¡ç®—è®¡åˆ’ç»“æŸæ—¥æœŸ
const handleRecalculatePlanEndDate = async () => {
  try {
    await ElMessageBox.confirm(
      'ç¡®å®šè¦é‡æ–°è®¡ç®—æ‰€æœ‰å·¥åºè®¡åˆ’çš„è®¡åˆ’ç»“æŸæ—¥æœŸå—ï¼Ÿ\n\næ­¤æ“ä½œä¼šï¼š\n1. ä¸ºæ‰€æœ‰å·¥åºè®¡åˆ’é‡æ–°æŸ¥è¯¢è®¡åˆ’ç»“æŸæ—¥æœŸ\n2. æ›´æ–°æ•°æ®åº“ä¸­çš„è®¡åˆ’ç»“æŸæ—¥æœŸå­—æ®µ\n3. å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…',
      'æ‰¹é‡é‡æ–°è®¡ç®—ç¡®è®¤',
      {
        confirmButtonText: 'ç¡®å®šæ‰§è¡Œ',
        cancelButtonText: 'å–æ¶ˆ',
        type: 'warning',
        dangerouslyUseHTMLString: true
      }
    )

    console.log('ğŸ”„ å¼€å§‹æ‰¹é‡é‡æ–°è®¡ç®—è®¡åˆ’ç»“æŸæ—¥æœŸ...')
    
    // è·å–æ‰€æœ‰å·¥åºè®¡åˆ’æ•°æ®ï¼ˆä¸åˆ†é¡µï¼Œè·å–å…¨éƒ¨ï¼‰
    const allData = await api.getList({ page: 1, pageSize: 10000 })
    const allRecords = allData.records || []
    
    if (allRecords.length === 0) {
      ElMessage.warning('æ²¡æœ‰æ‰¾åˆ°å·¥åºè®¡åˆ’æ•°æ®')
      return
    }

    console.log(`ğŸ“Š æ‰¾åˆ° ${allRecords.length} æ¡å·¥åºè®¡åˆ’è®°å½•`)
    
    const minRemainingHours = currentBusinessVars.value.minRemainingHours || 0.5
    let successCount = 0
    let errorCount = 0
    let skipCount = 0

    // é€æ¡å¤„ç†
    for (let i = 0; i < allRecords.length; i++) {
      const record = allRecords[i]
      
      try {
        console.log(`\nğŸ”„ [${i + 1}/${allRecords.length}] å¤„ç†è®°å½•: ${record.planNo}`)
        
        // æ£€æŸ¥å¿…è¦å­—æ®µ
        if (!record.processName || !record.completionDate) {
          console.log(`â­ï¸ è·³è¿‡: ç¼ºå°‘å·¥åºåç§°æˆ–å®Œå·¥æ—¥æœŸ`)
          skipCount++
          continue
        }

        // æŸ¥è¯¢è®¡åˆ’ç»“æŸæ—¥æœŸ
        const completionDateFormatted = formatDateYMD(record.completionDate)
        console.log(`ğŸ” æŸ¥è¯¢è®¡åˆ’ç»“æŸæ—¥æœŸ: å·¥åº=${record.processName}, å®Œå·¥æ—¥æœŸ=${completionDateFormatted}, é—¨æ§›å€¼=${minRemainingHours}`)
        
        const response = await capacityLoadApi.queryPlanEndDate(
          record.processName,
          completionDateFormatted,
          minRemainingHours
        )
        
        if (response?.planEndDate) {
          // æ›´æ–°æ•°æ®åº“
          await api.update(record.id, {
            ...record,
            planEndDate: response.planEndDate
          })
          
          console.log(`âœ… æ›´æ–°æˆåŠŸ: ${record.planNo} -> ${response.planEndDate}`)
          successCount++
        } else {
          console.log(`âš ï¸ æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ç»“æŸæ—¥æœŸ: ${record.planNo}`)
          // å³ä½¿æ²¡æ‰¾åˆ°ä¹Ÿè¦æ›´æ–°ä¸ºnull
          await api.update(record.id, {
            ...record,
            planEndDate: null
          })
          skipCount++
        }
        
        // é¿å…è¯·æ±‚è¿‡å¿«
        if (i % 10 === 0) {
          await new Promise(resolve => setTimeout(resolve, 100))
        }
        
      } catch (error) {
        console.error(`âŒ å¤„ç†è®°å½•å¤±è´¥: ${record.planNo}`, error)
        errorCount++
      }
    }

    console.log(`\nâœ… æ‰¹é‡é‡æ–°è®¡ç®—å®Œæˆ:`)
    console.log(`   æ€»è®°å½•æ•°: ${allRecords.length}`)
    console.log(`   æˆåŠŸæ›´æ–°: ${successCount}`)
    console.log(`   è·³è¿‡è®°å½•: ${skipCount}`)
    console.log(`   å¤±è´¥è®°å½•: ${errorCount}`)

    ElMessage.success(
      `æ‰¹é‡é‡æ–°è®¡ç®—å®Œæˆï¼
æ€»è®¡: ${allRecords.length} æ¡
æˆåŠŸ: ${successCount} æ¡
è·³è¿‡: ${skipCount} æ¡
å¤±è´¥: ${errorCount} æ¡`
    )

    // é‡æ–°åŠ è½½æ•°æ®
    loadData()

  } catch (error) {
    if (error !== 'cancel') {
      console.error('âŒ æ‰¹é‡é‡æ–°è®¡ç®—å¤±è´¥:', error)
      ElMessage.error('æ‰¹é‡é‡æ–°è®¡ç®—å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'))
    }
  }
}

// ========== ä¸šåŠ¡å˜é‡é…ç½® ==========
// ä¸šåŠ¡å˜é‡ - æŒ‰é’®é…ç½®
const businessVarButtons = [
  {
    label: 'å·¥åºé—´éš”è®¾ç½®',
    value: 'processIntervalSettings',
    onClick: openProcessIntervalSettings
  },
  {
    label: 'é‡æ–°è®¡ç®—è®¡åˆ’ç»“æŸæ—¥æœŸ',
    value: 'recalculatePlanEndDate',
    onClick: handleRecalculatePlanEndDate,
    type: 'warning'
  },
  {
    label: 'é‡æ–°è®¡ç®—éœ€æ±‚å·¥æ—¶',
    value: 'recalculateRequiredHours',
    onClick: handleRecalculateRequiredHours,
    type: 'danger'
  }
]

// ä¸šåŠ¡å˜é‡ - ä¸‹æ‹‰é€‰æ‹©é…ç½®
const businessVarSelects = [
  {
    label: 'é»˜è®¤ç»Ÿç­¹è®¾ç½®',
    value: 'defaultMergeRule',
    options: [
      { label: 'æŒ‰"é”€å”®è®¢å•"åˆå¹¶', value: 'salesOrder' },
      { label: 'æŒ‰"æ¥æºä¸»è®¡åˆ’ç¼–å·"åˆå¹¶', value: 'masterPlanNo' },
      { label: 'æŒ‰ç›¸åŒ"å¤‡æ–™è®¡åˆ’ç¼–å·"åˆå¹¶', value: 'materialPlanNo' },
      { label: 'æŒ‰ç›¸åŒ"éœ€æ±‚æ—¥æœŸ"åˆå¹¶', value: 'demandDate' },
      { label: 'æŒ‰ç›¸åŒ"è®¡åˆ’ç‰©æ–™ç¼–å·"åˆå¹¶', value: 'materialCode' }
    ],
    defaultValue: 'masterPlanNo',
    description: `<div style="margin-top: 8px; padding: 8px; background-color: #f5f7fa; border-radius: 4px; font-size: 12px; line-height: 1.6;">
      <div style="margin-bottom: 4px;">â€¢ <strong>æŒ‰"é”€å”®è®¢å•"åˆå¹¶</strong>ï¼šå¤‡æ–™è®¡åˆ’æ¨é€æ•°æ®åˆ°å·¥åºè®¡åˆ’æ—¶ï¼Œç›¸åŒ"é”€å”®è®¢å•ç¼–å·"ä¸”ç›¸åŒ"è®¡åˆ’ç‰©æ–™ç¼–å·"åˆå¹¶ä¸€èµ·æ’ç¨‹</div>
      <div style="margin-bottom: 4px;">â€¢ <strong>æŒ‰"æ¥æºä¸»è®¡åˆ’ç¼–å·"åˆå¹¶</strong>ï¼šå¤‡æ–™è®¡åˆ’æ¨é€æ•°æ®åˆ°å·¥åºè®¡åˆ’æ—¶ï¼Œç›¸åŒ"æ¥æºä¸»è®¡åˆ’ç¼–å·"ä¸”ç›¸åŒ"è®¡åˆ’ç‰©æ–™ç¼–å·"åˆå¹¶ä¸€èµ·æ’ç¨‹</div>
      <div style="margin-bottom: 4px;">â€¢ <strong>æŒ‰ç›¸åŒ"å¤‡æ–™è®¡åˆ’ç¼–å·"åˆå¹¶</strong>ï¼šå¤‡æ–™è®¡åˆ’æ¨é€æ•°æ®åˆ°å·¥åºè®¡åˆ’æ—¶ï¼Œç›¸åŒ"å¤‡æ–™è®¡åˆ’ç¼–å·"ä¸”ç›¸åŒ"è®¡åˆ’ç‰©æ–™ç¼–å·"åˆå¹¶ä¸€èµ·æ’ç¨‹</div>
      <div style="margin-bottom: 4px;">â€¢ <strong>æŒ‰ç›¸åŒ"éœ€æ±‚æ—¥æœŸ"åˆå¹¶</strong>ï¼šå¤‡æ–™è®¡åˆ’æ¨é€æ•°æ®åˆ°å·¥åºè®¡åˆ’æ—¶ï¼Œç›¸åŒ"éœ€æ±‚æ—¥æœŸ"ä¸”ç›¸åŒ"è®¡åˆ’ç‰©æ–™ç¼–å·"åˆå¹¶ä¸€èµ·æ’ç¨‹</div>
      <div style="margin-bottom: 4px;">â€¢ <strong>æŒ‰ç›¸åŒ"è®¡åˆ’ç‰©æ–™ç¼–å·"</strong>ï¼šå¤‡æ–™è®¡åˆ’æ¨é€æ•°æ®åˆ°å·¥åºè®¡åˆ’æ—¶ï¼Œç›¸åŒ"è®¡åˆ’ç‰©æ–™ç¼–å·"åˆå¹¶ä¸€èµ·æ’ç¨‹</div>
    </div>`,
    tip: 'ğŸ’¡ æ¸©é¦¨æç¤ºï¼šå¦‚æœ‰éœ€è¦è‡ªå®šä¹‰åˆå¹¶ç»Ÿç­¹è§„åˆ™çš„ï¼Œè¯·è”ç³»å‘¨è¾‰ 18627407019'
  },
  {
    label: 'å‰©ä½™å·¥æ—¶å°äº',
    value: 'minRemainingHours',
    type: 'number',
    defaultValue: 0.5,
    unit: 'å°æ—¶',
    description: `<div style="margin-top: 8px; padding: 8px; background-color: #fff3cd; border-radius: 4px; font-size: 12px; line-height: 1.6;">
      <div style="margin-bottom: 4px;">â€¢ è®¾ç½®è®¡åˆ’ç»“æŸæ—¥æœŸæŸ¥è¯¢çš„å‰©ä½™å·¥æ—¶é—¨æ§›å€¼</div>
      <div style="margin-bottom: 4px;">â€¢ åªæœ‰å·¥åºèƒ½åŠ›è´Ÿè·è¡¨ä¸­"å‰©ä½™å·¥æ—¶" â‰¥ è¯¥å€¼çš„æ—¥æœŸæ‰ä¼šè¢«é€‰ä¸­</div>
      <div style="margin-bottom: 4px;">â€¢ é»˜è®¤å€¼ï¼š0.5å°æ—¶</div>
    </div>`,
    tip: 'ğŸ’¡ æ¸©é¦¨æç¤ºï¼šè®¾ç½®è¾ƒå¤§å€¼å¯ç¡®ä¿æœ‰è¶³å¤Ÿçš„å‰©ä½™å·¥æ—¶è¿›è¡Œæ’ç¨‹'
  }
]

// ========== é»˜è®¤è®¾ç½® ==========
const defaultSettings = {
  exportFilePrefix: 'å·¥åºè®¡åˆ’',
  codePrefix: 'PP',
  defaultMergeRule: 'masterPlanNo',  // é»˜è®¤æŒ‰"æ¥æºä¸»è®¡åˆ’ç¼–å·"åˆå¹¶
  minRemainingHours: 0.5  // âœ… é»˜è®¤å‰©ä½™å·¥æ—¶é—¨æ§›å€¼ï¼š0.5å°æ—¶
}

// âœ… æ‰€æœ‰åˆ—å®šä¹‰
const allColumns = ref([
  { prop: 'selection', label: 'é€‰æ‹©', type: 'selection', width: 55, fixed: 'left', visible: true },
  { prop: 'rowIndex', label: 'åºå·', width: 80, sortable: false, filterable: false, visible: true,
    formatter: (row, column, cellValue, index) => index + 1 },  // âœ… éœ€æ±‚ 2ï¼šåºå·ï¼ˆè¡Œä½ç½®ï¼‰
  { prop: 'scheduleDate', label: 'è®¡åˆ’æ’ç¨‹æ—¥æœŸ', width: 120, sortable: true, filterable: true, visible: true,
    formatter: (row) => formatDateYMD(row.scheduleDate) },  // âœ… éœ€æ±‚ 4ï¼šè®¡åˆ’æ’ç¨‹æ—¥æœŸ = çœŸè®¡åˆ’å¼€å§‹æ—¥æœŸ
  { prop: 'salesOrderNo', label: 'é”€å”®è®¢å•ç¼–å·', width: 160, sortable: true, filterable: true, visible: true },
  { prop: 'masterPlanNo', label: 'ä¸»ç”Ÿäº§è®¡åˆ’ç¼–å·', width: 160, sortable: true, filterable: true, visible: true },
  { prop: 'shippingPlanNo', label: 'å‘è´§è®¡åˆ’ç¼–å·', width: 160, sortable: true, filterable: true, visible: true },
  { prop: 'productCode', label: 'ç”Ÿäº§äº§å“ç¼–å·', width: 140, sortable: true, filterable: true, visible: true },
  { prop: 'productName', label: 'ç”Ÿäº§äº§å“åç§°', width: 180, sortable: true, filterable: true, visible: true },
  { prop: 'productImage', label: 'äº§å“å›¾ç‰‡', width: 100, slot: 'productImage', visible: true },
  { prop: 'processManager', label: 'å·¥åºè´Ÿè´£äºº', width: 120, filterable: true, visible: true },
  { prop: 'processName', label: 'å·¥åºåç§°', width: 140, sortable: true, filterable: true, visible: true },
  { prop: 'planNo', label: 'å·¥åºè®¡åˆ’ç¼–å·', width: 160, sortable: true, filterable: true, fixed: 'left', visible: true },
  { prop: 'dailyTotalHours', label: 'å½“å¤©æ€»å·¥æ—¶', width: 120, sortable: true, align: 'right', visible: true,
    formatter: (row) => row.dailyTotalHours !== undefined ? parseFloat(row.dailyTotalHours).toFixed(2) : '0.00' },  // âœ… éœ€æ±‚1ï¼š2ä½å°æ•°
  { prop: 'dailyScheduledHours', label: 'å½“å¤©å·²æ’ç¨‹å·¥æ—¶', width: 150, sortable: true, align: 'right', visible: true,
    formatter: (row) => row.dailyScheduledHours !== undefined ? parseFloat(row.dailyScheduledHours).toFixed(2) : '0.00' },  // âœ… éœ€æ±‚1ï¼š2ä½å°æ•°
  { prop: 'dailyAvailableHours', label: 'å·¥åºå½“å¤©å¯ç”¨å·¥æ—¶', width: 160, sortable: true, align: 'right', visible: true,
    formatter: (row) => row.dailyAvailableHours !== undefined ? parseFloat(row.dailyAvailableHours).toFixed(2) : '0.00' },  // âœ… éœ€æ±‚1ï¼š2ä½å°æ•°
  { prop: 'scheduleQuantity', label: 'è®¡åˆ’æ’ç¨‹æ•°é‡', width: 130, sortable: true, align: 'right', visible: true },  // âœ… éœ€æ±‚ 9
  { prop: 'scheduledWorkHours', label: 'è®¡åˆ’æ’ç¨‹å·¥æ—¶', width: 130, sortable: true, align: 'right', visible: true,
    formatter: (row) => row.scheduledWorkHours !== undefined ? parseFloat(row.scheduledWorkHours).toFixed(2) : '0.00' },  // âœ… éœ€æ±‚1ï¼š2ä½å°æ•°
  { prop: 'productUnit', label: 'äº§å“å•ä½', width: 100, visible: true },
  { prop: 'level0Demand', label: '0é˜¶éœ€æ±‚æ•°é‡', width: 130, sortable: true, align: 'right', visible: true },
  { prop: 'completionDate', label: 'è®¡åˆ’å®Œå·¥æ—¥æœŸ', width: 120, sortable: true, visible: true,
    formatter: (row) => formatDateYMD(row.completionDate) },  // âœ… æ·»åŠ æ—¥æœŸæ ¼å¼åŒ–
  { prop: 'planStartDate', label: 'è®¡åˆ’å¼€å§‹æ—¥æœŸ', width: 120, sortable: true, filterable: true, visible: true,
    formatter: (row) => formatDateYMD(row.planStartDate) },  // âœ… æ–°å¢ï¼šè®¡åˆ’å¼€å§‹æ—¥æœŸ
  { prop: 'realPlanStartDate', label: 'çœŸè®¡åˆ’å¼€å§‹æ—¥æœŸ', width: 130, sortable: true, filterable: true, visible: true,
    formatter: (row) => formatDateYMD(row.realPlanStartDate)
  },  // âœ… æ–°å¢ï¼šçœŸè®¡åˆ’å¼€å§‹æ—¥æœŸ = è®¡åˆ’å¼€å§‹æ—¥æœŸ + 1å¤©(å·²åœ¨æ•°æ®è®¡ç®—æ—¶å¤„ç†)
  { prop: 'planEndDate', label: 'è®¡åˆ’ç»“æŸæ—¥æœŸ', width: 120, sortable: true, filterable: true, visible: true,
    formatter: (row) => formatDateYMD(row.planEndDate) },  // âœ… æ–°å¢ï¼šè®¡åˆ’ç»“æŸæ—¥æœŸ
  { prop: 'workshopName', label: 'è½¦é—´åç§°', width: 120, filterable: true, visible: true },
  { prop: 'nextScheduleDate', label: 'ä¸‹ä¸€ä¸ªæ’ç¨‹æ—¥æœŸ', width: 140, sortable: true, filterable: true, visible: true,
    formatter: (row) => formatDateYMD(row.nextScheduleDate) },  // âœ… éœ€æ±‚1ï¼šè¿˜éœ€æ’ç¨‹å·¥æ—¶æ”¹ä¸ºä¸‹ä¸€ä¸ªæ’ç¨‹æ—¥æœŸ
  { prop: 'scheduleCount', label: 'æ’ç¨‹æ¬¡æ•°', width: 100, sortable: true, align: 'right', visible: true },
  { prop: 'standardWorkQuota', label: 'å®šæ—¶å·¥é¢', width: 100, sortable: true, align: 'right', visible: true },  // âœ… ä¿®æ”¹ï¼šå®šé¢å·¥æ—¶æ”¹ä¸ºå®šæ—¶å·¥é¢
  { prop: 'standardWorkHours', label: 'å®šé¢å·¥æ—¶', width: 100, sortable: true, align: 'right', visible: true },  // âœ… ä¿®æ”¹ï¼šå®šæ—¶å·¥é¢æ”¹ä¸ºå®šé¢å·¥æ—¶
  { prop: 'requiredWorkHours', label: 'éœ€æ±‚å·¥æ—¶', width: 100, sortable: true, align: 'right', visible: true,
    formatter: (row) => row.requiredWorkHours !== undefined ? parseFloat(row.requiredWorkHours).toFixed(2) : '0.00' },  // âœ… éœ€æ±‚1ï¼š2ä½å°æ•°
  { prop: 'remainingRequiredHours', label: 'å‰©ä½™éœ€æ±‚å·¥æ—¶', width: 120, sortable: true, align: 'right', visible: true,
    formatter: (row) => row.remainingRequiredHours !== undefined ? parseFloat(row.remainingRequiredHours).toFixed(2) : '0.00' },  // âœ… éœ€æ±‚2ï¼šå‰©ä½™éœ€æ±‚å·¥æ—¶
  { prop: 'cumulativeScheduleQty', label: 'ç´¯ç§¯æ’ç¨‹æ•°é‡', width: 130, sortable: true, align: 'right', visible: true,
    formatter: (row) => row.cumulativeScheduleQty !== undefined ? parseFloat(row.cumulativeScheduleQty).toFixed(2) : '0.00' },  // âœ… éœ€æ±‚3ï¼šå·²æ’å·¥æ—¶æ”¹ä¸ºç´¯ç§¯æ’ç¨‹æ•°é‡
  { prop: 'unscheduledQty', label: 'æœªæ’æ•°é‡', width: 100, sortable: true, align: 'right', visible: true,
    formatter: (row) => row.unscheduledQty !== undefined ? parseFloat(row.unscheduledQty).toFixed(2) : '0.00' },  // âœ… éœ€æ±‚4ï¼šæœªæ’å·¥æ—¶æ”¹ä¸ºæœªæ’æ•°é‡
  { prop: 'progressStatus', label: 'è¿›åº¦çŠ¶æ€', width: 140, sortable: true, filterable: true, align: 'center', visible: true, slot: 'progressStatus' },  // âœ… æ–°å¢ï¼šè¿›åº¦çŠ¶æ€(ä½¿ç”¨æ’æ§½)
  { prop: 'replenishmentQty', label: 'éœ€è¡¥è´§æ•°é‡', width: 120, sortable: true, align: 'right', visible: true },
  { prop: 'sourcePageName', label: 'æ¥æºé¡µé¢åç§°', width: 130, filterable: true, visible: false },
  { prop: 'sourceNo', label: 'æ¥æºç¼–å·', width: 160, filterable: true, visible: true },  // âœ… éœ€æ±‚1ï¼šæ¥æºç¼–å·é»˜è®¤æ˜¾ç¤º
  { prop: 'previousScheduleNo', label: 'ä¸Šä¸€ä¸ªæ’ç¨‹å•å·', width: 160, filterable: true, visible: false },
  { prop: 'customerName', label: 'å®¢æˆ·åç§°', width: 150, filterable: true, visible: true },
  { prop: 'level0ProductName', label: '0é˜¶äº§å“åç§°', width: 150, filterable: true, visible: false },
  { prop: 'level0ProductCode', label: '0é˜¶äº§å“ç¼–å·', width: 140, filterable: true, visible: false },
  { prop: 'level0ProductionQty', label: '0é˜¶ä¸»è®¡åˆ’ç”Ÿäº§æ•°é‡', width: 160, sortable: true, align: 'right', visible: false },
  { prop: 'productSource', label: 'äº§å“æ¥æº', width: 120, filterable: true, visible: false },
  { prop: 'bomNo', label: 'ç”Ÿäº§BOMç¼–å·', width: 160, filterable: true, sortable: true, visible: true },  // âœ… æ˜¾ç¤ºBOMç¼–å·
  { prop: 'hierarchyAddress', label: 'å±‚é˜¶åœ°å€', width: 120, filterable: true, visible: true },  // âœ… æ–°å¢å±‚é˜¶åœ°å€
  { prop: 'bomDetail', label: 'BOMè¯¦æƒ…', width: 100, slot: 'bomDetail', align: 'center', visible: true },  // âœ… æ–°å¢BOMè¯¦æƒ…åˆ—
  { prop: 'submittedBy', label: 'æäº¤äºº', width: 100, filterable: true, visible: true },
  { prop: 'submittedAt', label: 'æäº¤æ—¶é—´', width: 160, sortable: true, visible: true },
  { prop: 'actions', label: 'æ“ä½œ', width: 180, fixed: 'right', slot: 'actions', visible: true }
])

// âœ… åŠ è½½æ•°æ® - ä»…åŠ è½½å·²ä¿å­˜çš„æ•°æ®ï¼Œä¸é‡æ–°è®¡ç®—
const loadData = async () => {
  loading.value = true
  try {
    const params = {
      page: pagination.page,
      pageSize: pagination.pageSize,
      planNo: searchForm.planNo,
      masterPlanNo: searchForm.masterPlanNo,
      processName: searchForm.processName
    }
    
    // æ·»åŠ æ—¥æœŸèŒƒå›´
    if (searchForm.scheduleDateRange && searchForm.scheduleDateRange.length === 2) {
      params.scheduleDateStart = searchForm.scheduleDateRange[0]
      params.scheduleDateEnd = searchForm.scheduleDateRange[1]
    }
    
    console.log('ğŸ”„ å¼€å§‹åŠ è½½å·¥åºè®¡åˆ’æ•°æ®...')
    const data = await api.getList(params)
    tableData.value = data.records || []
    pagination.total = data.total || 0
    
    console.log(`âœ… æ•°æ®åŠ è½½å®Œæˆï¼Œå…± ${tableData.value.length} æ¡è®°å½•`)
    console.log('ğŸ“Š åŠ è½½çš„æ•°æ®å·²åŒ…å«æ‰€æœ‰è®¡ç®—å­—æ®µï¼Œæ— éœ€é‡å¤è®¡ç®—')
    
    // âš ï¸ å…³é”®ä¿®å¤ï¼šåˆ é™¤æ‰€æœ‰é‡æ–°è®¡ç®—é€»è¾‘
    // æ•°æ®åº“ä¸­å·²ç»å­˜å‚¨äº†æ‰€æœ‰è®¡ç®—å¥½çš„å­—æ®µï¼Œç›´æ¥ä½¿ç”¨å³å¯
    // é‡æ–°è®¡ç®—ä¼šå¯¼è‡´ï¼š
    // 1. é‡å¤æ¨é€å·²å ç”¨å·¥æ—¶åˆ°å·¥åºèƒ½åŠ›è´Ÿè·è¡¨(ç´¯åŠ é”™è¯¯)
    // 2. é‡å¤ç”Ÿæˆè‡ªå¢è®°å½•(æ•°æ®é‡å¤)
    // 3. æ€§èƒ½ä¸¥é‡ä¸‹é™(æ¯æ¬¡åˆ·æ–°éƒ½è°ƒç”¨å¤§é‡ API)
    
    ElMessage.success('æ•°æ®åŠ è½½æˆåŠŸ')
  } catch (error) {
    console.error('âŒ åŠ è½½æ•°æ®å¤±è´¥:', error)
    ElMessage.error('åŠ è½½æ•°æ®å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'))
  } finally {
    loading.value = false
  }
}

// æœç´¢
const handleSearch = () => {
  pagination.page = 1
  loadData()
}

// é‡ç½®
const handleReset = () => {
  Object.keys(searchForm).forEach(key => {
    searchForm[key] = Array.isArray(searchForm[key]) ? [] : ''
  })
  pagination.page = 1
  loadData()
}

// æ–°å¢
const handleAdd = () => {
  isEdit.value = false
  formData.value = {
    planNo: generatePlanNo(),
    scheduleDate: new Date(),
    scheduleQuantity: 0,
    scheduledWorkHours: 0,  // âœ… æ”¹åï¼šè®¡åˆ’æ’ç¨‹å·¥æ—¶
    standardWorkHours: 0,
    replenishmentQty: 0,  // âœ… éœ€è¡¥è´§æ•°é‡
    standardWorkQuota: 0,  // âœ… å®šæ—¶å·¥é¢
    requiredWorkHours: 0  // âœ… éœ€æ±‚å·¥æ—¶ï¼ˆè‡ªåŠ¨è®¡ç®—ï¼‰
  }
  dialogVisible.value = true
}

// ç¼–è¾‘
const handleEdit = (row) => {
  isEdit.value = true
  formData.value = { ...row }
  dialogVisible.value = true
}

// åˆ é™¤
const handleDelete = async (row) => {
  try {
    await ElMessageBox.confirm(`ç¡®å®šè¦åˆ é™¤å·¥åºè®¡åˆ’â€œ${row.planNo}â€å—?`, 'æç¤º', {
      confirmButtonText: 'ç¡®å®š',
      cancelButtonText: 'å–æ¶ˆ',
      type: 'warning'
    })
    
    // âœ… æ­¥éª¤1ï¼šè®°å½•åˆ é™¤å‰çš„å…³é”®ä¿¡æ¯ï¼ˆç”¨äºé‡Šæ”¾å·²å ç”¨å·¥æ—¶ï¼‰
    const deletedInfo = {
      planNo: row.planNo,
      processName: row.processName,
      scheduleDate: row.scheduleDate,
      scheduledWorkHours: parseFloat(row.scheduledWorkHours || 0)
    }
    
    console.log(`ğŸ—‘ï¸ åˆ é™¤å·¥åºè®¡åˆ’:`, deletedInfo)
    
    // âœ… æ­¥éª¤2ï¼šæ‰§è¡Œåˆ é™¤
    await api.deleteById(row.id)
    console.log(`âœ… å·¥åºè®¡åˆ’åˆ é™¤æˆåŠŸ`)
    
    // âœ… æ­¥éª¤3ï¼šå¦‚æœæœ‰è®¡åˆ’æ’ç¨‹å·¥æ—¶ï¼Œé‡Šæ”¾å·¥åºèƒ½åŠ›è´Ÿè·è¡¨çš„å·²å ç”¨å·¥æ—¶ï¼ˆå‡æ³•é€»è¾‘ï¼‰
    if (deletedInfo.scheduledWorkHours > 0 && deletedInfo.processName && deletedInfo.scheduleDate) {
      try {
        const scheduleDateFormatted = formatDateYMD(deletedInfo.scheduleDate)
        console.log(`ğŸ”„ å¼€å§‹é‡Šæ”¾å·²å ç”¨å·¥æ—¶: å·¥åº=${deletedInfo.processName}, æ—¥æœŸ=${scheduleDateFormatted}, å·¥æ—¶=${deletedInfo.scheduledWorkHours}`)
        
        const releaseResponse = await capacityLoadApi.releaseOccupiedHours(
          deletedInfo.processName,
          scheduleDateFormatted,
          deletedInfo.scheduledWorkHours
        )
        
        if (releaseResponse?.updated) {
          console.log(`âœ… å·²å ç”¨å·¥æ—¶é‡Šæ”¾æˆåŠŸ: ${releaseResponse.previousOccupiedHours} - ${releaseResponse.releasedHours} = ${releaseResponse.newOccupiedHours}`)
        } else {
          console.log(`âš ï¸ æœªæ‰¾åˆ°åŒ¹é…è®°å½•ï¼Œè·³è¿‡é‡Šæ”¾: ${releaseResponse?.reason || 'æœªçŸ¥åŸå› '}`)
        }
      } catch (error) {
        console.error(`â— é‡Šæ”¾å·²å ç”¨å·¥æ—¶å¤±è´¥:`, error)
        // ä¸é˜»å¡ä¸»æµç¨‹
      }
    } else {
      console.log(`â­ï¸ è·³è¿‡é‡Šæ”¾: è®¡åˆ’æ’ç¨‹å·¥æ—¶=${deletedInfo.scheduledWorkHours}, å·¥åº=${deletedInfo.processName}, æ—¥æœŸ=${deletedInfo.scheduleDate}`)
    }
    
    ElMessage.success('åˆ é™¤æˆåŠŸ')
    loadData()
  } catch (error) {
    if (error !== 'cancel') {
      console.error('âŒ åˆ é™¤å¤±è´¥:', error)
      ElMessage.error('åˆ é™¤å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'))
    }
  }
}

// æ‰¹é‡åˆ é™¤
const handleBatchDelete = async () => {
  if (selectedRows.value.length === 0) {
    ElMessage.warning('è¯·é€‰æ‹©è¦åˆ é™¤çš„è®°å½•')
    return
  }

  try {
    await ElMessageBox.confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedRows.value.length} æ¡è®°å½•å—?`, 'æç¤º', {
      confirmButtonText: 'ç¡®å®š',
      cancelButtonText: 'å–æ¶ˆ',
      type: 'warning'
    })
    
    // âœ… æ­¥éª¤1ï¼šè®°å½•æ‰€æœ‰åˆ é™¤è®°å½•çš„å…³é”®ä¿¡æ¯
    const deletedRecordsInfo = selectedRows.value
      .filter(row => row.scheduledWorkHours && parseFloat(row.scheduledWorkHours) > 0)
      .map(row => ({
        processName: row.processName,
        scheduleDate: row.scheduleDate,
        scheduledWorkHours: parseFloat(row.scheduledWorkHours || 0),
        planNo: row.planNo
      }))
    
    console.log(`ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤ ${selectedRows.value.length} æ¡è®°å½•ï¼Œå…¶ä¸­ ${deletedRecordsInfo.length} æ¡éœ€è¦é‡Šæ”¾å·²å ç”¨å·¥æ—¶`)
    
    // âœ… æ­¥éª¤2ï¼šæ‰§è¡Œæ‰¹é‡åˆ é™¤
    const ids = selectedRows.value.map(row => row.id)
    await api.batchDelete(ids)
    console.log(`âœ… æ‰¹é‡åˆ é™¤æˆåŠŸ`)
    
    // âœ… æ­¥éª¤3ï¼šåˆå¹¶åŒä¸€å·¥åº+åŒä¸€æ—¥æœŸçš„å·¥æ—¶ï¼Œé¿å…ç«æ€æ¡ä»¶
    if (deletedRecordsInfo.length > 0) {
      console.log(`ğŸ”„ å¼€å§‹é‡Šæ”¾ ${deletedRecordsInfo.length} æ¡è®°å½•çš„å·²å ç”¨å·¥æ—¶`)
      
      // âœ¨ å…³é”®ä¼˜åŒ–ï¼šæŒ‰å·¥åº+æ—¥æœŸåˆå¹¶å·¥æ—¶
      const mergedMap = new Map()
      
      deletedRecordsInfo.forEach(info => {
        const scheduleDateFormatted = formatDateYMD(info.scheduleDate)
        const key = `${info.processName}__${scheduleDateFormatted}` // å·¥åº+æ—¥æœŸä½œä¸ºå”¯ä¸€key
        
        if (mergedMap.has(key)) {
          // å·²å­˜åœ¨ï¼Œç´¯åŠ å·¥æ—¶
          const existing = mergedMap.get(key)
          existing.totalHours += info.scheduledWorkHours
          existing.planNos.push(info.planNo)
        } else {
          // æ–°å¢
          mergedMap.set(key, {
            processName: info.processName,
            scheduleDate: scheduleDateFormatted,
            totalHours: info.scheduledWorkHours,
            planNos: [info.planNo]
          })
        }
      })
      
      console.log(`ğŸ“Š åˆå¹¶åéœ€è¦é‡Šæ”¾ ${mergedMap.size} ä¸ªå·¥åº-æ—¥æœŸç»„åˆ`)
      
      // âœ… é¡ºåºæ‰§è¡Œé‡Šæ”¾ï¼ˆé¿å…å¹¶å‘ç«æ€ï¼‰
      for (const [key, merged] of mergedMap.entries()) {
        try {
          console.log(`ğŸ”„ [å·¥åº=${merged.processName}, æ—¥æœŸ=${merged.scheduleDate}] é‡Šæ”¾æ€»å·¥æ—¶=${merged.totalHours.toFixed(2)}, æ¶‰åŠè®¡åˆ’: ${merged.planNos.join(', ')}`)
          
          const releaseResponse = await capacityLoadApi.releaseOccupiedHours(
            merged.processName,
            merged.scheduleDate,
            merged.totalHours
          )
          
          if (releaseResponse?.updated) {
            console.log(`âœ… [å·¥åº=${merged.processName}, æ—¥æœŸ=${merged.scheduleDate}] é‡Šæ”¾æˆåŠŸ: ${releaseResponse.previousOccupiedHours} - ${releaseResponse.releasedHours} = ${releaseResponse.newOccupiedHours}`)
          } else {
            console.log(`âš ï¸ [å·¥åº=${merged.processName}, æ—¥æœŸ=${merged.scheduleDate}] æœªæ‰¾åˆ°åŒ¹é…è®°å½•: ${releaseResponse?.reason || 'æœªçŸ¥åŸå› '}`)
          }
        } catch (error) {
          console.error(`â— [å·¥åº=${merged.processName}, æ—¥æœŸ=${merged.scheduleDate}] é‡Šæ”¾å¤±è´¥:`, error)
          // ä¸é˜»å¡å…¶ä»–è®°å½•
        }
      }
      
      console.log(`âœ… æ‰€æœ‰å·²å ç”¨å·¥æ—¶é‡Šæ”¾å®Œæˆ`)
    }
    
    ElMessage.success('æ‰¹é‡åˆ é™¤æˆåŠŸ')
    selectedRows.value = []
    loadData()
  } catch (error) {
    if (error !== 'cancel') {
      console.error('âŒ æ‰¹é‡åˆ é™¤å¤±è´¥:', error)
      ElMessage.error('æ‰¹é‡åˆ é™¤å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'))
    }
  }
}

// ä¿å­˜
const handleSave = async () => {
  try {
    await formRef.value.validate()
    
    if (isEdit.value) {
      // âœ… ç¼–è¾‘æ¨¡å¼ï¼šç›´æ¥æ›´æ–° - ç¡®ä¿éœ€æ±‚å·¥æ—¶æ­£ç¡®æ˜ å°„
      const updateData = {
        ...formData.value,
        scheduledHours: formData.value.requiredWorkHours  // âœ… éœ€æ±‚å·¥æ—¶ -> scheduled_hours
      }
      await api.update(formData.value.id, updateData)
      ElMessage.success('æ›´æ–°æˆåŠŸ')
      dialogVisible.value = false
      loadData()
    } else {
      // âœ… åˆ›å»ºæ¨¡å¼ï¼šå…ˆè®¡ç®—æ‰€æœ‰å­—æ®µï¼Œå†ä¿å­˜ï¼Œç„¶åå¾ªç¯è‡ªå¢
      console.log('ğŸ”„ å¼€å§‹åˆ›å»ºæ–°å·¥åºè®¡åˆ’ï¼Œè®¡ç®—æ‰€æœ‰å­—æ®µ...')
      
      const minRemainingHours = currentBusinessVars.value.minRemainingHours || 0.5
      
      // æ­¥éª¤1ï¼šè®¡ç®—éœ€æ±‚å·¥æ—¶ = éœ€è¡¥è´§æ•°é‡ / å®šæ—¶å·¥é¢
      // ç”Ÿæˆæ¡ä»¶: AND((å®šæ—¶å·¥é¢>0) OR (å®šé¢å·¥æ—¶>0), éœ€è¡¥è´§æ•°é‡>0)
      const replenishmentQty = parseFloat(formData.value.replenishmentQty || 0)
      const standardWorkQuota = parseFloat(formData.value.standardWorkQuota || 0)
      const standardWorkHours = parseFloat(formData.value.standardWorkHours || 0)
      
      // âœ… æ£€æŸ¥ç”Ÿæˆæ¡ä»¶: (å®šæ—¶å·¥é¢>0 OR å®šé¢å·¥æ—¶>0) AND éœ€è¡¥è´§æ•°é‡>0
      if ((standardWorkQuota > 0 || standardWorkHours > 0) && replenishmentQty > 0) {
        // âœ… ä¼˜å…ˆä½¿ç”¨å®šæ—¶å·¥é¢è®¡ç®—,å¦‚æœå®šæ—¶å·¥é¢ä¸º0åˆ™ä½¿ç”¨å®šé¢å·¥æ—¶
        const divisor = standardWorkQuota > 0 ? standardWorkQuota : standardWorkHours
        formData.value.requiredWorkHours = parseFloat((replenishmentQty / divisor).toFixed(2))
        console.log(`ğŸ“Š éœ€æ±‚å·¥æ—¶: ${formData.value.requiredWorkHours} = ${replenishmentQty} / ${divisor}`)
      } else {
        formData.value.requiredWorkHours = 0
        console.log(`â­ï¸ è·³è¿‡éœ€æ±‚å·¥æ—¶è®¡ç®—: å®šæ—¶å·¥é¢=${standardWorkQuota}, å®šé¢å·¥æ—¶=${standardWorkHours}, éœ€è¡¥è´§æ•°é‡=${replenishmentQty}`)
      }
      
      // æ­¥éª¤2ï¼šæŸ¥è¯¢è®¡åˆ’ç»“æŸæ—¥æœŸ (MAXIFSï¼šå·¥åºèƒ½åŠ›è´Ÿè·è¡¨çš„â€œæ—¥æœŸâ€<=â€œè®¡åˆ’å®Œå·¥æ—¥æœŸâ€ && â€œå·¥åºåç§°â€åŒ¹é… && â€œå‰©ä½™å·¥æ—¶â€>=é—¨æ§›å€¼)
      if (formData.value.processName && formData.value.completionDate) {
        try {
          const completionDate = formatDateYMD(formData.value.completionDate)
          console.log(`ğŸ” æŸ¥è¯¢è®¡åˆ’ç»“æŸæ—¥æœŸ (MAXIFS): å·¥åº=${formData.value.processName}, å®Œå·¥æ—¥æœŸ=${completionDate}, å‰©ä½™å·¥æ—¶é—¨æ§›=${minRemainingHours}`)
          
          const response = await capacityLoadApi.queryPlanEndDate(
            formData.value.processName, 
            completionDate, 
            minRemainingHours
          )
          
          if (response?.planEndDate) {
            formData.value.planEndDate = response.planEndDate
            console.log(`âœ… è®¡åˆ’ç»“æŸæ—¥æœŸ: ${formData.value.planEndDate}`)
          } else {
            formData.value.planEndDate = null
            console.log(`âš ï¸ æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è®¡åˆ’ç»“æŸæ—¥æœŸ`)
          }
        } catch (error) {
          console.error('â— æŸ¥è¯¢è®¡åˆ’ç»“æŸæ—¥æœŸå¤±è´¥:', error)
          formData.value.planEndDate = null
        }
      }
      
      // æ­¥éª¤3ï¼šæŸ¥è¯¢å½“å¤©æ€»å·¥æ—¶ (å¯ç”¨å·¥ä½æ•° * ä¸Šç­æ—¶é•¿)
      if (formData.value.processName && formData.value.scheduleDate) {
        try {
          const scheduleDateFormatted = formatDateYMD(formData.value.scheduleDate)
          const capacityResponse = await capacityLoadApi.queryCapacityByDate(
            formData.value.processName,
            scheduleDateFormatted
          )
          
          if (capacityResponse) {
            const availableWorkstations = parseFloat(capacityResponse.availableWorkstations || 0)
            const workShift = parseFloat(capacityResponse.workShift || 0)
            formData.value.dailyTotalHours = parseFloat((availableWorkstations * workShift).toFixed(2))
            console.log(`âœ… å½“å¤©æ€»å·¥æ—¶: ${formData.value.dailyTotalHours}`)
          } else {
            formData.value.dailyTotalHours = 0
          }
        } catch (error) {
          console.error('â— æŸ¥è¯¢å½“å¤©æ€»å·¥æ—¶å¤±è´¥:', error)
          formData.value.dailyTotalHours = 0
        }
      }
      
      // æ­¥éª¤4ï¼šè®¡ç®—å½“å¤©å·²æ’ç¨‹å·¥æ—¶ (SUMIFS: åŒå·¥åº+åŒæ—¥æœŸçš„æ‰€æœ‰è®°å½•çš„è®¡åˆ’æ’ç¨‹å·¥æ—¶ä¹‹å’Œ)
      // æ­¤æ—¶è¿˜æœªä¿å­˜ï¼Œæ— æ³•æŸ¥è¯¢åŒæ—¥æœŸçš„å…¶ä»–è®°å½•ï¼Œé»˜è®¤ä¸º0
      formData.value.dailyScheduledHours = 0
      console.log(`ğŸ“Š å½“å¤©å·²æ’ç¨‹å·¥æ—¶: ${formData.value.dailyScheduledHours} (åˆ›å»ºæ—¶é»˜è®¤ä¸º0)`)
      
      // æ­¥éª¤5ï¼šè®¡ç®—å·¥åºå½“å¤©å¯ç”¨å·¥æ—¶ = å½“å¤©æ€»å·¥æ—¶ - å½“å¤©å·²æ’ç¨‹å·¥æ—¶
      formData.value.dailyAvailableHours = parseFloat(
        (formData.value.dailyTotalHours - formData.value.dailyScheduledHours).toFixed(2)
      )
      console.log(`âœ… å·¥åºå½“å¤©å¯ç”¨å·¥æ—¶: ${formData.value.dailyAvailableHours}`)
      
      // æ­¥éª¤6ï¼šè®¡ç®—è®¡åˆ’æ’ç¨‹å·¥æ—¶ = MIN(éœ€æ±‚å·¥æ—¶, å·¥åºå½“å¤©å¯ç”¨å·¥æ—¶)
      formData.value.scheduledWorkHours = parseFloat(
        Math.min(formData.value.requiredWorkHours || 0, formData.value.dailyAvailableHours).toFixed(2)
      )
      console.log(`âœ… è®¡åˆ’æ’ç¨‹å·¥æ—¶: ${formData.value.scheduledWorkHours}`)
      
      // æ­¥éª¤7ï¼šè®¡ç®—è®¡åˆ’æ’ç¨‹æ•°é‡ (CEILING: å‘ä¸Šå–æ•´åˆ°æœ€å°åŒ…è£…é‡çš„å€æ•°)
      if (formData.value.productCode) {
        try {
          const materialResponse = await materialApiService.getMaterialByCode(formData.value.productCode)
          if (materialResponse?.minimumPackagingQuantity) {
            const minimumPackagingQty = parseFloat(materialResponse.minimumPackagingQuantity || 1)
            if (standardWorkQuota > 0 && minimumPackagingQty > 0) {
              const rawQuantity = formData.value.scheduledWorkHours * standardWorkQuota
              formData.value.scheduleQuantity = parseFloat(
                (Math.ceil(rawQuantity / minimumPackagingQty) * minimumPackagingQty).toFixed(4)
              )
              console.log(`âœ… è®¡åˆ’æ’ç¨‹æ•°é‡: ${formData.value.scheduleQuantity} (æœ€å°åŒ…è£…é‡=${minimumPackagingQty})`)
            } else {
              formData.value.scheduleQuantity = 0
            }
          } else {
            formData.value.scheduleQuantity = 0
          }
        } catch (error) {
          console.warn('âš ï¸ æŸ¥è¯¢æœ€å°åŒ…è£…é‡å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼1:', error)
          const minimumPackagingQty = 1
          if (standardWorkQuota > 0) {
            const rawQuantity = formData.value.scheduledWorkHours * standardWorkQuota
            formData.value.scheduleQuantity = parseFloat(
              (Math.ceil(rawQuantity / minimumPackagingQty) * minimumPackagingQty).toFixed(4)
            )
          } else {
            formData.value.scheduleQuantity = 0
          }
        }
      }
      
      // æ­¥éª¤8ï¼šè®¡ç®—ç´¯ç§¯æ’ç¨‹æ•°é‡ (SUMIFS: æ¥æºç¼–å·+äº§å“ç¼–å·åŒ¹é…)
      // åˆ›å»ºæ—¶ï¼Œåªæœ‰å½“å‰è®°å½•ï¼Œç´¯ç§¯ = è®¡åˆ’æ’ç¨‹æ•°é‡
      formData.value.cumulativeScheduleQty = parseFloat((formData.value.scheduleQuantity || 0).toFixed(4))
      console.log(`ğŸ“Š ç´¯ç§¯æ’ç¨Œæ•°é‡: ${formData.value.cumulativeScheduleQty} (åˆ›å»ºæ—¶=è®¡åˆ’æ’ç¨‹æ•°é‡)`)
      
      // æ­¥éª¤9ï¼šè®¡ç®—æœªæ’æ•°é‡ = éœ€è¡¥è´§æ•°é‡ - ç´¯ç§¯æ’ç¨‹æ•°é‡
      formData.value.unscheduledQty = parseFloat(
        (replenishmentQty - formData.value.cumulativeScheduleQty).toFixed(4)
      )
      console.log(`âœ… æœªæ’æ•°é‡: ${formData.value.unscheduledQty}`)
      
      // æ­¥éª¤10ï¼šè®¡ç®—å‰©ä½™éœ€æ±‚å·¥æ—¶ = æœªæ’æ•°é‡ / å®šæ—¶å·¥é¢
      if (standardWorkQuota > 0 && formData.value.unscheduledQty > 0) {
        formData.value.remainingRequiredHours = parseFloat(
          (formData.value.unscheduledQty / standardWorkQuota).toFixed(2)
        )
      } else {
        formData.value.remainingRequiredHours = 0
      }
      console.log(`âœ… å‰©ä½™éœ€æ±‚å·¥æ—¶: ${formData.value.remainingRequiredHours}`)
      
      // æ­¥éª¤11ï¼šæŸ¥è¯¢ä¸‹ä¸€ä¸ªæ’ç¨‹æ—¥æœŸ (åªæœ‰æœªæ’æ•°é‡>0æ—¶æ‰éœ€è¦)
      if (formData.value.unscheduledQty > 0 && formData.value.processName && formData.value.scheduleDate) {
        try {
          const scheduleDateFormatted = formatDateYMD(formData.value.scheduleDate)
          const nextDateResponse = await capacityLoadApi.queryNextScheduleDate(
            formData.value.processName,
            scheduleDateFormatted,
            minRemainingHours
          )
          
          if (nextDateResponse?.nextScheduleDate) {
            formData.value.nextScheduleDate = nextDateResponse.nextScheduleDate
            console.log(`âœ… ä¸‹ä¸€ä¸ªæ’ç¨‹æ—¥æœŸ: ${formData.value.nextScheduleDate}`)
          } else {
            formData.value.nextScheduleDate = null
            console.log(`âš ï¸ æœªæ‰¾åˆ°ä¸‹ä¸€ä¸ªæ’ç¨‹æ—¥æœŸ`)
          }
        } catch (error) {
          console.error('â— æŸ¥è¯¢ä¸‹ä¸€ä¸ªæ’ç¨‹æ—¥æœŸå¤±è´¥:', error)
          formData.value.nextScheduleDate = null
        }
      }
      
      // æ­¥éª¤12ï¼šåˆ›å»ºè®°å½• - ç¡®ä¿éœ€æ±‚å·¥æ—¶æ­£ç¡®æ˜ å°„
      console.log('ğŸ’¾ ä¿å­˜è®°å½•åˆ°æ•°æ®åº“...')
      const updateData = {
        ...formData.value,
        scheduledHours: formData.value.requiredWorkHours  // âœ… éœ€æ±‚å·¥æ—¶ -> scheduled_hours
      }
      const createdRecord = await api.create(updateData)
      console.log('âœ… è®°å½•åˆ›å»ºæˆåŠŸ:', createdRecord)
      
      // æ­¥éª¤13ï¼šæ›´æ–°å·¥åºèƒ½åŠ›è´Ÿè·è¡¨çš„å·²å ç”¨å·¥æ—¶
      if (formData.value.scheduledWorkHours && parseFloat(formData.value.scheduledWorkHours) > 0) {
        try {
          const scheduleDateFormatted = formatDateYMD(formData.value.scheduleDate)
          console.log(`ğŸ”„ æ›´æ–°å·²å ç”¨å·¥æ—¶: å·¥åº=${formData.value.processName}, æ—¥æœŸ=${scheduleDateFormatted}, å·¥æ—¶=${formData.value.scheduledWorkHours}`)
          
          const updateResponse = await capacityLoadApi.updateOccupiedHours(
            formData.value.processName,
            scheduleDateFormatted,
            formData.value.scheduledWorkHours
          )
          
          if (updateResponse?.updated) {
            console.log(`âœ… å·²å ç”¨å·¥æ—¶æ›´æ–°æˆåŠŸ: ${updateResponse.previousOccupiedHours} + ${updateResponse.addedHours} = ${updateResponse.newOccupiedHours}`)
          }
        } catch (error) {
          console.error('â— æ›´æ–°å·²å ç”¨å·¥æ—¶å¤±è´¥:', error)
        }
      }
      
      // æ­¥éª¤14ï¼šæ£€æŸ¥æ˜¯å¦éœ€è¦å¾ªç¯è‡ªå¢ï¼ˆæœªæ’æ•°é‡>0ï¼‰
      if (formData.value.unscheduledQty && parseFloat(formData.value.unscheduledQty) > 0) {
        console.log('ğŸ”„ æ£€æµ‹åˆ°æœªæ’æ•°é‡>0ï¼Œå¼€å§‹å¾ªç¯è‡ªå¢...')
        await performAutoIncrement(createdRecord)
      }
      
      ElMessage.success('åˆ›å»ºæˆåŠŸ')
      dialogVisible.value = false
      loadData()
    }
  } catch (error) {
    console.error('âŒ ä¿å­˜å¤±è´¥:', error)
    if (error !== false) {
      ElMessage.error('ä¿å­˜å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'))
    }
  }
}

// âœ… å¾ªç¯è‡ªå¢å‡½æ•°ï¼šåªåœ¨åˆ›å»ºæˆåŠŸåæ‰§è¡Œï¼Œä¸åœ¨åˆ·æ–°æ—¶æ‰§è¡Œ
const performAutoIncrement = async (initialRecord) => {
  const maxIterations = 100
  const processedRecords = new Set() // é˜²æ­¢é‡å¤å¤„ç†
  let iteration = 0
  let totalNewRecords = 0
  
  // å°†åˆå§‹è®°å½•æ ‡è®°ä¸ºå·²å¤„ç†
  processedRecords.add(initialRecord.planNo || initialRecord.plan_no)
  
  console.log('ğŸ”„ å¼€å§‹å¾ªç¯è‡ªå¢ï¼Œåˆå§‹è®°å½•:', initialRecord)
  
  // è·å–å½“å‰æ‰€æœ‰è®°å½•ï¼ˆåŒ…æ‹¬åˆšåˆ›å»ºçš„ï¼‰
  const currentData = await api.getList({ page: 1, pageSize: 1000 })
  let allRecords = currentData.records || []
  
  while (iteration < maxIterations) {
    iteration++
    console.log(`\nğŸ”„ [è‡ªå¢å¾ªç¯ ${iteration}] æ£€æŸ¥æ˜¯å¦æœ‰æœªæ’æ•°é‡>0çš„è®°å½•... (å·²ç”Ÿæˆ${totalNewRecords}æ¡)`)
    
    const newRecords = []
    
    // æ£€æŸ¥æ‰€æœ‰è®°å½•ï¼Œæ‰¾å‡ºéœ€è¦è‡ªå¢çš„è®°å½•
    for (const row of allRecords) {
      // æ£€æŸ¥æ¡ä»¶ï¼š
      // 1. æœªè¢«å¤„ç†è¿‡
      // 2. æœªæ’æ•°é‡>0
      // 3. æœ‰ä¸‹ä¸€ä¸ªæ’ç¨‹æ—¥æœŸ
      const planNo = row.planNo || row.plan_no
      const unscheduledQty = parseFloat(row.unscheduledQty || row.unscheduled_qty || 0)
      const nextScheduleDate = row.nextScheduleDate || row.next_schedule_date
      
      if (!processedRecords.has(planNo) && unscheduledQty > 0 && nextScheduleDate) {
        console.log(`ğŸ¯ æ‰¾åˆ°éœ€è¦è‡ªå¢çš„è®°å½•: ${planNo}, æœªæ’æ•°é‡=${unscheduledQty}, ä¸‹ä¸€ä¸ªæ’ç¨‹æ—¥æœŸ=${nextScheduleDate}`)
        
        // ç”Ÿæˆæ–°è®°å½•
        const newPlanNo = generatePlanNo()
        const newRecord = {
          planNo: newPlanNo,
          scheduleDate: nextScheduleDate,
          salesOrderNo: row.salesOrderNo || row.sales_order_no,
          masterPlanNo: row.masterPlanNo || row.master_plan_no,
          shippingPlanNo: row.shippingPlanNo || row.shipping_plan_no,
          productCode: row.productCode || row.product_code,
          productName: row.productName || row.product_name,
          productImage: row.productImage || row.product_image,
          processManager: row.processManager || row.process_manager,
          processName: row.processName || row.process_name,
          productUnit: row.productUnit || row.product_unit,
          level0Demand: row.level0Demand || row.level0_demand,
          completionDate: row.completionDate || row.completion_date,
          planEndDate: row.planEndDate || row.plan_end_date,
          workshopName: row.workshopName || row.workshop_name,
          standardWorkQuota: row.standardWorkQuota || row.standard_work_quota,
          standardWorkHours: row.standardWorkHours || row.standard_work_hours,
          replenishmentQty: row.replenishmentQty || row.replenishment_qty,
          sourceNo: row.sourceNo || row.source_no,
          customerName: row.customerName || row.customer_name,
          bomNo: row.bomNo || row.bom_no,
          hierarchyAddress: row.hierarchyAddress || row.hierarchy_address,
          submittedBy: row.submittedBy || row.submitted_by,
          scheduleCount: (parseFloat(row.scheduleCount || row.schedule_count || 0) + 1),
          requiredWorkHours: row.remainingRequiredHours || row.remaining_required_hours || 0,
          planStartDate: null,
          realPlanStartDate: null,
          cumulativeScheduleQty: row.cumulativeScheduleQty || row.cumulative_schedule_qty || 0
        }
        
        newRecords.push(newRecord)
        processedRecords.add(planNo)
        console.log(`âœ… ç”Ÿæˆæ–°è®°å½•: ${newPlanNo}, è®¡åˆ’æ’ç¨‹æ—¥æœŸ: ${nextScheduleDate}, æ’ç¨‹æ¬¡æ•°: ${newRecord.scheduleCount}`)
      }
    }
    
    // å¦‚æœæ²¡æœ‰æ–°è®°å½•ï¼Œé€€å‡ºå¾ªç¯
    if (newRecords.length === 0) {
      console.log(`âœ… [è‡ªå¢å¾ªç¯ç»“æŸ] æ‰€æœ‰è®°å½•çš„æœªæ’æ•°é‡éƒ½=0ï¼Œå…±å¾ªç¯${iteration}æ¬¡ï¼Œç”Ÿæˆ${totalNewRecords}æ¡æ–°è®°å½•`)
      break
    }
    
    console.log(`ğŸ“ [è‡ªå¢å¾ªç¯ ${iteration}] æœ¬è½®ç”Ÿæˆ ${newRecords.length} æ¡æ–°è®°å½•`)
    
    // ä¿å­˜æ–°è®°å½•å¹¶è®¡ç®—å­—æ®µ
    for (const newRecord of newRecords) {
      try {
        // åˆ›å»ºè®°å½•
        const created = await api.create(newRecord)
        totalNewRecords++
        
        // é‡æ–°æŸ¥è¯¢æ‰€æœ‰è®°å½•ï¼Œä»¥ä¾¿ä¸‹ä¸€è½®å¾ªç¯ä½¿ç”¨
        const updatedData = await api.getList({ page: 1, pageSize: 1000 })
        allRecords = updatedData.records || []
        
        console.log(`âœ… æ–°è®°å½•åˆ›å»ºæˆåŠŸ: ${newRecord.planNo}`)
      } catch (error) {
        console.error(`âŒ åˆ›å»ºæ–°è®°å½•å¤±è´¥:`, error)
      }
    }
  }
  
  if (totalNewRecords > 0) {
    console.log(`âœ… å¾ªç¯è‡ªå¢å®Œæˆï¼Œå…±ç”Ÿæˆ ${totalNewRecords} æ¡æ–°è®°å½•`)
  }
}

// ç”Ÿæˆè®¡åˆ’ç¼–å·
const generatePlanNo = () => {
  const year = new Date().getFullYear()
  const timestamp = Date.now().toString().slice(-6)
  const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0')
  return `PP${year}${timestamp}${random}`
}

// å¯¼å…¥
const handleImport = () => {
  importDialogVisible.value = true
}

let importFile = null

const handleFileChange = (file) => {
  importFile = file.raw
}

const confirmImport = () => {
  if (!importFile) {
    ElMessage.warning('è¯·é€‰æ‹©æ–‡ä»¶')
    return
  }
  
  const reader = new FileReader()
  reader.onload = (e) => {
    try {
      const workbook = XLSX.read(e.target.result, { type: 'binary' })
      const worksheet = workbook.Sheets[workbook.SheetNames[0]]
      const jsonData = XLSX.utils.sheet_to_json(worksheet)
      
      // TODO: æ•°æ®æ˜ å°„å’Œå¯¼å…¥é€»è¾‘
      ElMessage.success(`æˆåŠŸå¯¼å…¥ ${jsonData.length} æ¡æ•°æ®`)
      importDialogVisible.value = false
      loadData()
    } catch (error) {
      console.error('âŒ å¯¼å…¥å¤±è´¥:', error)
      ElMessage.error('å¯¼å…¥å¤±è´¥')
    }
  }
  reader.readAsBinaryString(importFile)
}

// å¯¼å‡º
const handleExport = () => {
  const exportData = tableData.value.map(row => ({
    'å·¥åºè®¡åˆ’ç¼–å·': row.planNo,
    'è®¡åˆ’æ’ç¨‹æ—¥æœŸ': row.scheduleDate,
    'ä¸»ç”Ÿäº§è®¡åˆ’ç¼–å·': row.masterPlanNo,
    'å·¥åºåç§°': row.processName,
    'è®¡åˆ’æ’ç¨‹æ•°é‡': row.scheduleQuantity,
    'å·¥åºè´Ÿè´£äºº': row.processManager,
    'è½¦é—´åç§°': row.workshopName,
    'è®¡åˆ’å®Œå·¥æ—¥æœŸ': row.completionDate
  }))
  
  const worksheet = XLSX.utils.json_to_sheet(exportData)
  const workbook = XLSX.utils.book_new()
  XLSX.utils.book_append_sheet(workbook, worksheet, 'å·¥åºè®¡åˆ’')
  XLSX.writeFile(workbook, `å·¥åºè®¡åˆ’_${new Date().getTime()}.xlsx`)
  
  ElMessage.success('å¯¼å‡ºæˆåŠŸ')
}

// åˆ†é¡µå˜åŒ–
const handlePageChange = (page) => {
  pagination.page = page
  loadData()
}

const handleSizeChange = (size) => {
  pagination.pageSize = size
  pagination.page = 1
  loadData()
}

// é€‰æ‹©å˜åŒ–
const handleSelectionChange = (selection) => {
  selectedRows.value = selection
}

// é¡µé¢è®¾ç½®ä¿å­˜
const handleSavePageSettings = (settings) => {
  console.log('=== é¡µé¢è®¾ç½®ä¿å­˜è°ƒè¯•ä¿¡æ¯ ===')
  console.log('settings å¯¹è±¡:', settings)
  console.log('settings.fields:', settings.fields)
  console.log('å½“å‰ allColumns æ•°é‡:', allColumns.value.length)
  
  // âœ… ä¿å­˜ä¸šåŠ¡å˜é‡é…ç½®
  if (settings.businessVars) {
    console.log('âœ… ä¿å­˜ä¸šåŠ¡å˜é‡é…ç½®:', settings.businessVars)
    currentBusinessVars.value = {
      ...currentBusinessVars.value,
      ...settings.businessVars
    }
    console.log('âœ… å½“å‰ä¸šåŠ¡å˜é‡:', currentBusinessVars.value)
  }
  
  // âœ… åº”ç”¨åˆ—é¡ºåºå’Œå¯è§æ€§ï¼ˆæ”¯æŒæ‹–æ‹½ï¼‰
  if (settings.fields && Array.isArray(settings.fields)) {
    console.log('âœ… æ”¶åˆ°å­—æ®µè®¾ç½®ï¼Œæ•°é‡:', settings.fields.length)
    
    // æ ¹æ® settings.fields æ›´æ–° allColumns çš„é¡ºåºå’Œå¯è§æ€§
    const fieldMap = new Map(settings.fields.map(f => [f.prop, f]))
    
    // é‡æ–°æ’åº allColumns
    const newColumns = []
    settings.fields.forEach(field => {
      const col = allColumns.value.find(c => c.prop === field.prop)
      if (col) {
        // âœ… ä¿æŒæ‰€æœ‰åŸæœ‰å±æ€§ï¼Œåªæ›´æ–°å¯è§æ€§
        const newCol = {
          ...col,
          visible: field.visible !== false
        }
        newColumns.push(newCol)
        console.log(`âœ… æ·»åŠ åˆ—: ${field.label}, visible: ${field.visible}, fixed: ${col.fixed || 'none'}`)
      }
    })
    
    // æ·»åŠ æœªåœ¨ settings.fields ä¸­çš„åˆ—ï¼ˆä¿æŒåŸé¡ºåºï¼‰
    allColumns.value.forEach(col => {
      if (!fieldMap.has(col.prop)) {
        newColumns.push({ ...col })
      }
    })
    
    // âœ… å…³é”®ï¼šæ›¿æ¢æ•´ä¸ªæ•°ç»„å¼•ç”¨
    allColumns.value = newColumns
    
    console.log('âœ… åˆ—é¡ºåºå·²æ›´æ–°:')
    console.log('æ–°é¡ºåº:', newColumns.map(c => c.label).join(', '))
    console.log('å¯è§åˆ—:', newColumns.filter(c => c.visible).map(c => c.label).join(', '))
    
    // âœ… æ·»åŠ å»¶è¿Ÿï¼Œç¡®ä¿æ¸²æŸ“å®Œæˆ
    setTimeout(() => {
      console.log('âœ… åˆ—æ›´æ–°å®Œæˆ')
    }, 100)
    
  } else if (settings.visibleFields) {
    // å‘åå…¼å®¹ï¼šåªæœ‰å¯è§æ€§ï¼Œæ²¡æœ‰é¡ºåº
    allColumns.value.forEach(col => {
      col.visible = settings.visibleFields.includes(col.prop)
    })
    console.log('âœ… åº”ç”¨å¯è§æ€§è®¾ç½®ï¼ˆæ—§æ ¼å¼ï¼‰')
  }
  
  ElMessage.success('è®¾ç½®å·²åº”ç”¨')
}

// ========== åˆå§‹åŒ– ==========
onMounted(() => {
  loadData()
  
  // âœ… æ·»åŠ è°ƒè¯•ä¿¡æ¯
  console.log('=== å·¥åºè®¡åˆ’é¡µé¢åˆå§‹åŒ– ===')
  console.log('allColumns æ•°é‡:', allColumns.value.length)
  console.log('StandardTablePage ç‰ˆæœ¬: v2.1')
  console.log('åˆ—é…ç½®:', allColumns.value.map(c => `${c.label}(${c.prop})`).join(', '))
  console.log('fixed åˆ—:', allColumns.value.filter(c => c.fixed).map(c => `${c.label}: ${c.fixed}`).join(', '))
  console.log('é¡µé¢åŠ è½½å®Œæˆ')
})
</script>

<style scoped lang="scss">
// StandardTablePage v2.1 å·²åŒ…å«æ‰€æœ‰å“åº”å¼æ ·å¼ï¼Œæ— éœ€é¢å¤–æ ·å¼

// âœ… è¿›åº¦çŠ¶æ€æ—‹è½¬åŠ¨ç”»
@keyframes rotate {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}
</style>
