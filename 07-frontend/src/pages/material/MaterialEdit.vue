<template>
  <div class="material-edit">
    <el-tabs v-model="activeTab" type="card">
      <!-- Âü∫Á°ÄÂ±ûÊÄß -->
      <el-tab-pane label="Âü∫Á°ÄÂ±ûÊÄß" name="basic">
        <el-form :model="formData" :rules="rules" ref="materialFormRef" label-width="120px">
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="Áâ©ÊñôÁºñÁ†Å">
                <el-input v-model="formData.materialCode" placeholder="Ëá™Âä®ÁîüÊàê" disabled />
              </el-form-item>
              <el-form-item label="BOMÁºñÂè∑" prop="bomNumber">
                <el-input v-model="formData.bomNumber" placeholder="ËØ∑ËæìÂÖ•BOMÁºñÂè∑" />
              </el-form-item>
              <el-form-item label="Áâ©ÊñôÂêçÁß∞" prop="materialName">
                <el-input v-model="formData.materialName" placeholder="ËØ∑ËæìÂÖ•Áâ©ÊñôÂêçÁß∞" />
              </el-form-item>
              <el-form-item label="Â∞∫ÂØ∏ËßÑÊ†º" prop="sizeSpec">
                <el-input v-model="formData.sizeSpec" placeholder="ËØ∑ËæìÂÖ•Â∞∫ÂØ∏ËßÑÊ†º" />
              </el-form-item>
              <el-form-item label="È¢úËâ≤" prop="color">
                <el-input v-model="formData.color" placeholder="ËØ∑ËæìÂÖ•È¢úËâ≤" />
              </el-form-item>
              <el-form-item label="ÊùêË¥®" prop="material">
                <el-input v-model="formData.material" placeholder="ËØ∑ËæìÂÖ•ÊùêË¥®" />
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="Â§ßÁ±ª" prop="majorCategory">
                <el-input v-model="formData.majorCategory" placeholder="ËØ∑ËæìÂÖ•Â§ßÁ±ª" />
              </el-form-item>
              <el-form-item label="‰∏≠Á±ª" prop="middleCategory">
                <el-input v-model="formData.middleCategory" placeholder="ËØ∑ËæìÂÖ•‰∏≠Á±ª" />
              </el-form-item>
              <el-form-item label="Â∞èÁ±ª" prop="minorCategory">
                <el-input v-model="formData.minorCategory" placeholder="ËØ∑ËæìÂÖ•Â∞èÁ±ª" />
              </el-form-item>
              <el-form-item label="ÂûãÂè∑" prop="model">
                <el-input v-model="formData.model" placeholder="ËØ∑ËæìÂÖ•ÂûãÂè∑" />
              </el-form-item>
              <el-form-item label="Á≥ªÂàó" prop="series">
                <el-input v-model="formData.series" placeholder="ËØ∑ËæìÂÖ•Á≥ªÂàó" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="Êù•Ê∫ê" prop="source">
                <el-select v-model="formData.source" multiple placeholder="ËØ∑ÈÄâÊã©Êù•Ê∫ê" style="width: 100%;">
                  <el-option label="Ëá™Âà∂" value="Ëá™Âà∂" />
                  <el-option label="ÂÆ¢‰æõ" value="ÂÆ¢‰æõ" />
                  <el-option label="Â§ñË¥≠" value="Â§ñË¥≠" />
                  <el-option label="Â§ñÂçè" value="Â§ñÂçè" />
                </el-select>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="Âü∫Á°ÄÂçï‰Ωç" prop="baseUnit">
                <el-input v-model="formData.baseUnit" placeholder="Â¶ÇÔºö‰∏™„ÄÅÂè∞„ÄÅÂ•ó" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="Áâ©ÊñôÂõæÁâá">
                <el-upload
                  class="avatar-uploader"
                  action="#"
                  :show-file-list="false"
                  :auto-upload="false"
                  :on-change="handleImageChange"
                  accept="image/*"
                >
                  <img v-if="formData.materialImage" :src="formData.materialImage" class="avatar" />
                  <el-icon v-else class="avatar-uploader-icon"><Plus /></el-icon>
                </el-upload>
                <div v-if="formData.materialImage" style="margin-top: 10px;">
                  <el-button size="small" type="danger" @click="handleRemoveImage">Âà†Èô§ÂõæÁâá</el-button>
                </div>
              </el-form-item>
            </el-col>
          </el-row>
          <el-form-item label="Áâ©ÊñôËØ¶Ëø∞">
            <el-input 
              v-model="formData.description" 
              type="textarea" 
              :rows="3" 
              placeholder="ËØ∑ËæìÂÖ•Áâ©ÊñôËØ¶Ëø∞" 
            />
          </el-form-item>
        </el-form>
      </el-tab-pane>

      <!-- ÈîÄÂîÆÂ±ûÊÄß -->
      <el-tab-pane label="ÈîÄÂîÆÂ±ûÊÄß" name="sales">
        <el-form :model="formData" :rules="rules" ref="materialFormRef" label-width="120px">
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="ÈîÄÂîÆÂçï‰Ωç" prop="saleUnit">
                <el-input v-model="formData.saleUnit" placeholder="ËØ∑ËæìÂÖ•ÈîÄÂîÆÂçï‰Ωç" />
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="ÈîÄÂîÆËΩ¨ÂåñÁéá" prop="saleConversionRate">
                <el-input-number v-model="formData.saleConversionRate" :precision="2" :min="0" placeholder="ËØ∑ËæìÂÖ•ÈîÄÂîÆËΩ¨ÂåñÁéá" style="width: 100%;" />
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </el-tab-pane>

      <!-- ÊäÄÊúØÁ†îÂèëÂ±ûÊÄß -->
      <el-tab-pane label="ÊäÄÊúØÁ†îÂèëÂ±ûÊÄß" name="rd">
        <el-empty description="ÊöÇÊó†ÊäÄÊúØÁ†îÂèëÂ±ûÊÄß" />
      </el-tab-pane>

      <!-- Áîü‰∫ßÂ±ûÊÄß -->
      <el-tab-pane label="Áîü‰∫ßÂ±ûÊÄß" name="production">
        <el-form :model="formData" :rules="rules" ref="materialFormRef" label-width="120px">
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="‰∫ßÂá∫Â∑•Â∫èÂêçÁß∞" prop="processName">
                <SmartSelect
                  v-model="formData.processName"
                  :options="processList"
                  label-field="processName"
                  value-field="processName"
                  description-field="processCode"
                  placeholder="ËØ∑ÈÄâÊã©ÊàñËæìÂÖ•Â∑•Â∫èÂêçÁß∞"
                  :filterable="true"
                  :clearable="true"
                  :show-description="true"
                  style="width: 100%;"
                />
              </el-form-item>
              <el-form-item label="ÂÆöÊó∂Â∑•È¢ù" prop="standardTime">
                <el-input-number v-model="formData.standardTime" :precision="2" :min="0" style="width: 100%;" />
              </el-form-item>
              <el-form-item label="ÂÆöÈ¢ùÂ∑•Êó∂" prop="quotaTime">
                <el-input-number v-model="formData.quotaTime" :precision="2" :min="0" style="width: 100%;" />
              </el-form-item>
              <el-form-item label="ÊúÄÂ∞èÂåÖË£ÖÈáè" prop="minimumPackagingQuantity">
                <el-input-number v-model="formData.minimumPackagingQuantity" :precision="6" :min="0" placeholder="ÈªòËÆ§ÂÄºÔºö1" style="width: 100%;" />
                <div style="font-size: 12px; color: #909399; margin-top: 4px;">
                  Áî®‰∫éËÆ°ÁÆóÊéíÁ®ãÊï∞ÈáèÁöÑÊúÄÂ∞èÂåÖË£ÖÂçï‰Ωç
                </div>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="Â∑•Â∫èÂçï‰ª∑" prop="processPrice">
                <el-input-number v-model="formData.processPrice" :precision="2" :min="0" style="width: 100%;" />
              </el-form-item>
              <el-form-item label="kg/pcs" prop="kgPerPcs">
                <el-input-number v-model="formData.kgPerPcs" :precision="4" :min="0" style="width: 100%;" />
              </el-form-item>
              <el-form-item label="pcs/kg" prop="pcsPerKg">
                <el-input-number v-model="formData.pcsPerKg" :precision="4" :min="0" style="width: 100%;" />
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </el-tab-pane>

      <!-- ÈááË¥≠Â±ûÊÄß -->
      <el-tab-pane label="ÈááË¥≠Â±ûÊÄß" name="purchase">
        <el-form :model="formData" :rules="rules" ref="materialFormRef" label-width="120px">
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="ÈááË¥≠Âçï‰Ωç" prop="purchaseUnit">
                <el-input v-model="formData.purchaseUnit" placeholder="ËØ∑ËæìÂÖ•ÈááË¥≠Âçï‰Ωç" />
              </el-form-item>
              <el-form-item label="ÈááË¥≠Âë®Êúü" prop="purchaseCycle">
                <el-input v-model="formData.purchaseCycle" placeholder="Â¶ÇÔºö7Â§©„ÄÅ15Â§©" />
              </el-form-item>
              <el-form-item label="Âü∫Á°ÄÂçï‰ª∑">
                <el-input-number 
                  :model-value="basePriceComputed" 
                  disabled
                  :precision="2" 
                  :min="0" 
                  style="width: 100%;" 
                />
                <div style="font-size: 12px; color: #909399; margin-top: 4px;">
                  ËÆ°ÁÆóÂÖ¨ÂºèÔºöÂü∫Á°ÄÂçï‰ª∑ = ÈááË¥≠Âçï‰ª∑ √∑ ÈááË¥≠ËΩ¨ÂåñÁéá
                </div>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="ÈááË¥≠ËΩ¨ÂåñÁéá" prop="purchaseConversionRate">
                <el-input-number 
                  v-model="formData.purchaseConversionRate" 
                  :precision="2" 
                  :min="0" 
                  placeholder="ËØ∑ËæìÂÖ•ÈááË¥≠ËΩ¨ÂåñÁéá" 
                  @change="handlePurchaseDataChange"
                  style="width: 100%;" 
                />
              </el-form-item>
              <el-form-item label="ÈááË¥≠Âçï‰ª∑" prop="purchasePrice">
                <el-input-number 
                  v-model="formData.purchasePrice" 
                  :precision="2" 
                  :min="0" 
                  @change="handlePurchaseDataChange"
                  style="width: 100%;" 
                />
              </el-form-item>
            </el-col>
          </el-row>

          <!-- ‚úÖ ‰æõË¥ßÂïÜ‰ø°ÊÅØÂ≠êË°®Ê†º -->
          <el-divider content-position="left">‰æõË¥ßÂïÜ‰ø°ÊÅØ</el-divider>
          
          <div style="margin-bottom: 10px;">
            <el-button type="primary" size="small" @click="handleAddSupplier">
              <el-icon><Plus /></el-icon>
              Ê∑ªÂä†‰æõÂ∫îÂïÜ
            </el-button>
          </div>

          <el-table :data="formData.suppliers" border stripe style="width: 100%;">
            <el-table-column prop="sequence" label="Â∫èÂè∑" width="80" align="center">
              <template #default="{ $index }">
                {{ $index + 1 }}
              </template>
            </el-table-column>
            
            <el-table-column prop="supplierName" label="‰æõÂ∫îÂïÜÂêçÁß∞" width="200">
              <template #default="{ row }">
                <el-select 
                  v-model="row.supplierName" 
                  filterable 
                  placeholder="ËØ∑ÈÄâÊã©‰æõÂ∫îÂïÜ"
                  style="width: 100%;"
                >
                  <el-option
                    v-for="supplier in supplierList"
                    :key="supplier.supplierName"
                    :label="supplier.supplierName"
                    :value="supplier.supplierName"
                  />
                </el-select>
              </template>
            </el-table-column>

            <el-table-column prop="minimumOrderQuantity" label="Ëµ∑ÂÆöÈáè" width="120">
              <template #default="{ row }">
                <el-input-number 
                  v-model="row.minimumOrderQuantity" 
                  :precision="4" 
                  :min="0"
                  size="small"
                  style="width: 100%;"
                />
              </template>
            </el-table-column>

            <el-table-column prop="tierRange" label="Èò∂Ê¢ØËåÉÂõ¥" width="150">
              <template #default="{ row }">
                <el-input 
                  v-model="row.tierRange" 
                  size="small"
                  placeholder="Â¶Ç1000-5000"
                />
              </template>
            </el-table-column>

            <el-table-column prop="tierUnitPrice" label="Èò∂Ê¢ØÂçï‰ª∑" width="120">
              <template #default="{ row }">
                <el-input-number 
                  v-model="row.tierUnitPrice" 
                  :precision="2" 
                  :min="0"
                  size="small"
                  style="width: 100%;"
                />
              </template>
            </el-table-column>

            <el-table-column prop="taxRate" label="Á®éÁéá(%)" width="100">
              <template #default="{ row }">
                <el-input-number 
                  v-model="row.taxRate" 
                  :precision="2" 
                  :min="0"
                  :max="100"
                  size="small"
                  style="width: 100%;"
                />
              </template>
            </el-table-column>

            <el-table-column prop="standardPackagingQuantity" label="Ê†áÂáÜÂåÖË£ÖÊï∞Èáè" width="150">
              <template #default="{ row }">
                <el-input-number 
                  v-model="row.standardPackagingQuantity" 
                  :precision="4" 
                  :min="0"
                  size="small"
                  style="width: 100%;"
                />
              </template>
            </el-table-column>

            <el-table-column prop="orderingRule" label="‰∏ãÂçïËßÑÂàô" width="120">
              <template #default="{ row }">
                <el-select v-model="row.orderingRule" size="small" style="width: 100%;">
                  <el-option label="ÈªòËÆ§" value="ÈªòËÆ§" />
                  <el-option label="Â§áÁî®" value="Â§áÁî®" />
                </el-select>
              </template>
            </el-table-column>

            <el-table-column label="Êìç‰Ωú" width="80" fixed="right" align="center">
              <template #default="{ $index }">
                <el-button 
                  type="danger" 
                  size="small" 
                  link
                  @click="handleDeleteSupplier($index)"
                >
                  Âà†Èô§
                </el-button>
              </template>
            </el-table-column>
          </el-table>
        </el-form>
      </el-tab-pane>

      <!-- ÂìÅË¥®Â±ûÊÄß -->
      <el-tab-pane label="ÂìÅË¥®Â±ûÊÄß" name="quality">
        <el-empty description="ÊöÇÊó†ÂìÅË¥®Â±ûÊÄß" />
      </el-tab-pane>

      <!-- Ë¥¢Âä°Â±ûÊÄß -->
      <el-tab-pane label="Ë¥¢Âä°Â±ûÊÄß" name="finance">
        <el-empty description="ÊöÇÊó†Ë¥¢Âä°Â±ûÊÄß" />
      </el-tab-pane>

      <!-- ‰ªìÂÇ®Â±ûÊÄß -->
      <el-tab-pane label="‰ªìÂÇ®Â±ûÊÄß" name="warehouse">
        <el-empty description="ÊöÇÊó†‰ªìÂÇ®Â±ûÊÄß" />
      </el-tab-pane>
    </el-tabs>

    <div class="footer-buttons">
      <div class="nav-buttons">
        <el-button @click="handlePrevious" :disabled="!hasPrevious">
          <el-icon><ArrowLeft /></el-icon>
          ‰∏ä‰∏ÄÈ°π
        </el-button>
        <el-button @click="handleNext" :disabled="!hasNext">
          ‰∏ã‰∏ÄÈ°π
          <el-icon><ArrowRight /></el-icon>
        </el-button>
      </div>
      <div class="action-buttons">
        <el-button @click="handleCancel">ÂèñÊ∂à</el-button>
        <el-button type="success" @click="handleSave">‰øùÂ≠ò</el-button>
        <el-button type="primary" @click="handleSubmit">Êèê‰∫§</el-button>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, reactive, watch, onMounted, computed } from 'vue'
import { ElMessage } from 'element-plus'
import { Plus, ArrowLeft, ArrowRight } from '@element-plus/icons-vue'
import SmartSelect from '@/components/SmartSelect.vue'
import request from '@/utils/request'
import axios from 'axios'

const props = defineProps({
  materialData: {
    type: Object,
    default: null
  },
  isEdit: {
    type: Boolean,
    default: false
  },
  // ÊâπÈáèÁºñËæëÁõ∏ÂÖ≥
  allMaterials: {
    type: Array,
    default: () => []
  },
  currentIndex: {
    type: Number,
    default: -1
  }
})

const emit = defineEmits(['success', 'save', 'cancel', 'navigate'])

const activeTab = ref('basic')
const processList = ref([]) // Â∑•Â∫èÂàóË°®
const supplierList = ref([]) // ‚úÖ ‰æõÂ∫îÂïÜÂàóË°®
const materialFormRef = ref(null) // Ë°®ÂçïÂºïÁî®

// Ë°®ÂçïÈ™åËØÅËßÑÂàô
const rules = ref({
  materialName: [
    { required: true, message: 'ËØ∑ËæìÂÖ•Áâ©ÊñôÂêçÁß∞', trigger: 'blur' },
    { min: 2, max: 100, message: 'Áâ©ÊñôÂêçÁß∞ÈïøÂ∫¶Âú® 2 Âà∞ 100 ‰∏™Â≠óÁ¨¶', trigger: 'blur' }
  ],
  majorCategory: [
    { required: true, message: 'ËØ∑ËæìÂÖ•Â§ßÁ±ª', trigger: 'blur' }
  ],
  baseUnit: [
    { required: true, message: 'ËØ∑ËæìÂÖ•Âü∫Á°ÄÂçï‰Ωç', trigger: 'blur' }
  ],
  bomNumber: [
    { max: 50, message: 'BOMÁºñÂè∑ÈïøÂ∫¶‰∏çËÉΩË∂ÖËøá50‰∏™Â≠óÁ¨¶', trigger: 'blur' }
  ],
  sizeSpec: [
    { max: 100, message: 'Â∞∫ÂØ∏ËßÑÊ†ºÈïøÂ∫¶‰∏çËÉΩË∂ÖËøá100‰∏™Â≠óÁ¨¶', trigger: 'blur' }
  ],
  color: [
    { max: 50, message: 'È¢úËâ≤ÈïøÂ∫¶‰∏çËÉΩË∂ÖËøá50‰∏™Â≠óÁ¨¶', trigger: 'blur' }
  ],
  material: [
    { max: 50, message: 'ÊùêË¥®ÈïøÂ∫¶‰∏çËÉΩË∂ÖËøá50‰∏™Â≠óÁ¨¶', trigger: 'blur' }
  ],
  middleCategory: [
    { max: 50, message: '‰∏≠Á±ªÈïøÂ∫¶‰∏çËÉΩË∂ÖËøá50‰∏™Â≠óÁ¨¶', trigger: 'blur' }
  ],
  minorCategory: [
    { max: 50, message: 'Â∞èÁ±ªÈïøÂ∫¶‰∏çËÉΩË∂ÖËøá50‰∏™Â≠óÁ¨¶', trigger: 'blur' }
  ],
  model: [
    { max: 50, message: 'ÂûãÂè∑ÈïøÂ∫¶‰∏çËÉΩË∂ÖËøá50‰∏™Â≠óÁ¨¶', trigger: 'blur' }
  ],
  series: [
    { max: 50, message: 'Á≥ªÂàóÈïøÂ∫¶‰∏çËÉΩË∂ÖËøá50‰∏™Â≠óÁ¨¶', trigger: 'blur' }
  ],
  source: [
    { required: true, message: 'ËØ∑ÈÄâÊã©Êù•Ê∫ê', trigger: 'change' }
  ],
  description: [
    { max: 500, message: 'Áâ©ÊñôËØ¶Ëø∞ÈïøÂ∫¶‰∏çËÉΩË∂ÖËøá500‰∏™Â≠óÁ¨¶', trigger: 'blur' }
  ],
  saleUnit: [
    { max: 20, message: 'ÈîÄÂîÆÂçï‰ΩçÈïøÂ∫¶‰∏çËÉΩË∂ÖËøá20‰∏™Â≠óÁ¨¶', trigger: 'blur' }
  ],
  saleConversionRate: [
    { type: 'number', minimum: 0, message: 'ÈîÄÂîÆËΩ¨ÂåñÁéá‰∏çËÉΩÂ∞è‰∫é0', trigger: 'blur' }
  ],
  purchaseUnit: [
    { max: 20, message: 'ÈááË¥≠Âçï‰ΩçÈïøÂ∫¶‰∏çËÉΩË∂ÖËøá20‰∏™Â≠óÁ¨¶', trigger: 'blur' }
  ],
  purchaseConversionRate: [
    { type: 'number', minimum: 0, message: 'ÈááË¥≠ËΩ¨ÂåñÁéá‰∏çËÉΩÂ∞è‰∫é0', trigger: 'blur' }
  ],
  processName: [
    { max: 100, message: 'Â∑•Â∫èÂêçÁß∞ÈïøÂ∫¶‰∏çËÉΩË∂ÖËøá100‰∏™Â≠óÁ¨¶', trigger: 'blur' }
  ],
  standardTime: [
    { type: 'number', minimum: 0, message: 'Ê†áÂáÜÂ∑•Êó∂‰∏çËÉΩÂ∞è‰∫é0', trigger: 'blur' }
  ],
  quotaTime: [
    { type: 'number', minimum: 0, message: 'ÂÆöÈ¢ùÂ∑•Êó∂‰∏çËÉΩÂ∞è‰∫é0', trigger: 'blur' }
  ],
  minimumPackagingQuantity: [
    { type: 'number', minimum: 0, message: 'ÊúÄÂ∞èÂåÖË£ÖÈáè‰∏çËÉΩÂ∞è‰∫é0', trigger: 'blur' }
  ],
  processPrice: [
    { type: 'number', minimum: 0, message: 'Â∑•Â∫èÂçï‰ª∑‰∏çËÉΩÂ∞è‰∫é0', trigger: 'blur' }
  ],
  kgPerPcs: [
    { type: 'number', minimum: 0, message: 'kg/pcs‰∏çËÉΩÂ∞è‰∫é0', trigger: 'blur' }
  ],
  pcsPerKg: [
    { type: 'number', minimum: 0, message: 'pcs/kg‰∏çËÉΩÂ∞è‰∫é0', trigger: 'blur' }
  ],
  purchaseCycle: [
    { max: 50, message: 'ÈááË¥≠Âë®ÊúüÈïøÂ∫¶‰∏çËÉΩË∂ÖËøá50‰∏™Â≠óÁ¨¶', trigger: 'blur' }
  ],
  purchasePrice: [
    { type: 'number', minimum: 0, message: 'ÈááË¥≠Âçï‰ª∑‰∏çËÉΩÂ∞è‰∫é0', trigger: 'blur' }
  ]
})

const formData = reactive({
  materialCode: '',
  bomNumber: '',
  materialName: '',
  sizeSpec: '',
  color: '',
  material: '',
  majorCategory: '',
  middleCategory: '',
  minorCategory: '',
  model: '',
  series: '',
  source: [],
  description: '',
  materialImage: '',
  baseUnit: '‰∏™',
  saleUnit: '',
  saleConversionRate: 0,
  purchaseUnit: '',
  purchaseConversionRate: 0,
  kgPerPcs: 0,
  pcsPerKg: 0,
  processName: '',
  standardTime: 0,
  quotaTime: 0,
  minimumPackagingQuantity: 1,  // ‚úÖ Êñ∞Â¢ûÔºöÊúÄÂ∞èÂåÖË£ÖÈáèÔºåÈªòËÆ§ÂÄº‰∏∫1
  processPrice: 0,
  purchaseCycle: '',
  purchasePrice: 0,
  basePrice: 0, // Âü∫Á°ÄÂçï‰ª∑ÔºàËÆ°ÁÆóÂ≠óÊÆµÔºâ
  suppliers: [] // ‚úÖ ‰æõË¥ßÂïÜ‰ø°ÊÅØÂàóË°®
})

// ËÆ°ÁÆóÂ±ûÊÄßÔºöÂü∫Á°ÄÂçï‰ª∑
const basePriceComputed = computed(() => {
  const purchasePrice = formData.purchasePrice || 0
  const purchaseConversionRate = formData.purchaseConversionRate || 1
  
  // Âü∫Á°ÄÂçï‰ª∑ = ÈááË¥≠Âçï‰ª∑ √∑ ÈááË¥≠ËΩ¨ÂåñÁéá
  if (purchaseConversionRate > 0) {
    return (purchasePrice / purchaseConversionRate).toFixed(2)
  }
  return '0.00'
})

// Â§ÑÁêÜÈááË¥≠Êï∞ÊçÆÂèòÂåñÔºàÈáçÊñ∞ËÆ°ÁÆóÂü∫Á°ÄÂçï‰ª∑Ôºâ
const handlePurchaseDataChange = () => {
  const purchasePrice = formData.purchasePrice || 0
  const purchaseConversionRate = formData.purchaseConversionRate || 1
  
  // ËÆ°ÁÆóÂπ∂Êõ¥Êñ∞Âü∫Á°ÄÂçï‰ª∑
  if (purchaseConversionRate > 0) {
    formData.basePrice = purchasePrice / purchaseConversionRate
  } else {
    formData.basePrice = 0
  }
}

// ÁõëÂê¨ props ÂèòÂåñ
watch(() => props.materialData, (newVal) => {
  if (newVal) {
    // Ê∑±Êã∑Ë¥ùÊï∞ÊçÆ
    const materialData = JSON.parse(JSON.stringify(newVal))
    
    // Â∞ÜÂ≠óÁ¨¶‰∏≤Á±ªÂûãÁöÑÊï∞Â≠óËΩ¨Êç¢‰∏∫NumberÁ±ªÂûã
    const numberFields = [
      'saleConversionRate', 'standardTime', 'quotaTime', 'minimumPackagingQuantity',
      'processPrice', 'kgPerPcs', 'pcsPerKg', 'purchaseConversionRate', 'purchasePrice',
      'basePrice', 'evaluationScore', 'paymentTerms', 'cooperationStartDate',
      'taxRate', 'minimumOrderQuantity', 'tierUnitPrice', 'standardPackagingQuantity'
    ]
    
    // ËΩ¨Êç¢‰∏ªË°®ÂçïÁöÑÊï∞Â≠óÂ≠óÊÆµ
    numberFields.forEach(field => {
      if (materialData[field] !== undefined && materialData[field] !== null) {
        materialData[field] = parseFloat(materialData[field])
      }
    })
    
    // ËΩ¨Êç¢‰æõË¥ßÂïÜ‰ø°ÊÅØÂàóË°®‰∏≠ÁöÑÊï∞Â≠óÂ≠óÊÆµ
    if (materialData.suppliers && Array.isArray(materialData.suppliers)) {
      materialData.suppliers = materialData.suppliers.map(supplier => {
        const supplierCopy = { ...supplier }
        const supplierNumberFields = [
          'minimumOrderQuantity', 'tierUnitPrice', 'taxRate', 'standardPackagingQuantity'
        ]
        supplierNumberFields.forEach(field => {
          if (supplierCopy[field] !== undefined && supplierCopy[field] !== null) {
            supplierCopy[field] = parseFloat(supplierCopy[field])
          }
        })
        return supplierCopy
      })
    }
    
    Object.assign(formData, materialData)
  }
}, { immediate: true })

// ËÆ°ÁÆóÂ±ûÊÄßÔºöÊòØÂê¶Êúâ‰∏ä‰∏ÄÈ°π
const hasPrevious = computed(() => {
  return props.currentIndex > 0
})

// ËÆ°ÁÆóÂ±ûÊÄßÔºöÊòØÂê¶Êúâ‰∏ã‰∏ÄÈ°π
const hasNext = computed(() => {
  return props.currentIndex >= 0 && props.currentIndex < props.allMaterials.length - 1
})

// Â§ÑÁêÜÂõæÁâá‰∏ä‰º†
const handleImageChange = (file) => {
  const reader = new FileReader()
  reader.onload = (e) => {
    formData.materialImage = e.target.result
  }
  reader.readAsDataURL(file.raw)
}

// Âà†Èô§ÂõæÁâá
const handleRemoveImage = () => {
  formData.materialImage = ''
}

const handleCancel = () => {
  emit('cancel')
}

// ‰øùÂ≠òÔºà‰∏çÂÖ≥Èó≠È°µÈù¢Ôºâ
const handleSave = async () => {
  if (!materialFormRef.value) return
  
  try {
    await materialFormRef.value.validate()
    
    // ÂèëÈÄÅÊï∞ÊçÆÂà∞Áà∂ÁªÑ‰ª∂
    emit('save', { ...formData })
    ElMessage.success('‰øùÂ≠òÊàêÂäü')
  } catch (error) {
    console.error('Ë°®ÂçïÈ™åËØÅÂ§±Ë¥•:', error)
    ElMessage.error('Ë°®ÂçïÈ™åËØÅÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Â°´ÂÜôÂÜÖÂÆπ')
  }
}

// Êèê‰∫§ÔºàÂÖ≥Èó≠È°µÈù¢Ôºâ
const handleSubmit = async () => {
  if (!materialFormRef.value) return
  
  try {
    await materialFormRef.value.validate()
    
    // ÂèëÈÄÅÊï∞ÊçÆÂà∞Áà∂ÁªÑ‰ª∂
    emit('success', { ...formData })
  } catch (error) {
    console.error('Ë°®ÂçïÈ™åËØÅÂ§±Ë¥•:', error)
    ElMessage.error('Ë°®ÂçïÈ™åËØÅÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Â°´ÂÜôÂÜÖÂÆπ')
  }
}

// ‰∏ä‰∏ÄÈ°π
const handlePrevious = () => {
  if (hasPrevious.value) {
    // ÂÖà‰øùÂ≠òÂΩìÂâçÊï∞ÊçÆ
    if (formData.materialName) {
      emit('save', { ...formData })
    }
    // ÁÑ∂ÂêéÂàáÊç¢Âà∞‰∏ä‰∏ÄÈ°π
    emit('navigate', 'prev')
  }
}

// ‰∏ã‰∏ÄÈ°π
const handleNext = () => {
  if (hasNext.value) {
    // ÂÖà‰øùÂ≠òÂΩìÂâçÊï∞ÊçÆ
    if (formData.materialName) {
      emit('save', { ...formData })
    }
    // ÁÑ∂ÂêéÂàáÊç¢Âà∞‰∏ã‰∏ÄÈ°π
    emit('navigate', 'next')
  }
}

// Âä†ËΩΩÂ∑•Â∫èÂàóË°®
onMounted(() => {
  loadProcessList()
  loadSupplierList() // ‚úÖ Âä†ËΩΩ‰æõÂ∫îÂïÜÂàóË°®
})

// ‰ªéÂêéÁ´ØAPIÂä†ËΩΩÂ∑•Â∫èÂàóË°®Êï∞ÊçÆ
const loadProcessList = async () => {
  try {
    console.log('üîç ÂºÄÂßãÂä†ËΩΩÂ∑•Â∫èÂàóË°®...')
    
    // ‰ΩøÁî®‰∏éÂ∑•Â∫èÂàóË°®È°µÈù¢Áõ∏ÂêåÁöÑAPIÂú∞ÂùÄ
    const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://192.168.2.229:3005/api'
    const axiosInstance = axios.create({
      timeout: 5000,
      baseURL: API_BASE_URL
    })
    
    const response = await axiosInstance.get('/processes/list')
    const result = response.data
    
    if (result.code === 200 && result.data) {
      // ËΩ¨Êç¢ÂêéÁ´ØÊï∞ÊçÆÊ†ºÂºè‰∏∫ÂâçÁ´ØÈúÄË¶ÅÁöÑÊ†ºÂºè
      processList.value = result.data.map(item => ({
        id: item.id,
        processCode: item.process_code,
        processName: item.process_name,
        processPrincipal: item.responsible_person,
        dispatchMethod: item.dispatch_method,
        selfOrOutsource: item.self_or_outsource || '',
        availableWorkstations: item.available_workstations || 0,
        isStorage: item.is_warehousing === 1,
        completionWarehouse: item.completion_warehouse || '',
        workshopName: item.workshop_name,
        processWage: parseFloat(item.process_wage) || 0,
        createTime: new Date(item.created_at).toLocaleString('zh-CN'),
        updateTime: new Date(item.updated_at).toLocaleString('zh-CN')
      }))
      
      console.log(`‚úÖ ‰ªéÂêéÁ´ØÂä†ËΩΩÂ∑•Â∫èÂàóË°®ÊàêÂäüÔºåÂÖ± ${processList.value.length} Êù°Êï∞ÊçÆ`)
      
      // ÂêåÊó∂‰øùÂ≠òÂà∞localStorage‰Ωú‰∏∫Â§á‰ªΩ
      localStorage.setItem('processListData', JSON.stringify(processList.value))
    } else {
      console.warn('‚ö†Ô∏è ÂêéÁ´ØËøîÂõûÊï∞ÊçÆÊ†ºÂºèÂºÇÂ∏∏:', result)
      // Â∞ùËØï‰ªélocalStorageÂä†ËΩΩÂ§á‰ªΩÊï∞ÊçÆ
      loadProcessListFromLocal()
    }
  } catch (error) {
    console.error('‚ùå ‰ªéÂêéÁ´ØÂä†ËΩΩÂ∑•Â∫èÂàóË°®Â§±Ë¥•:', error)
    // APIÂ§±Ë¥•ÔºåÂ∞ùËØï‰ªélocalStorageÂä†ËΩΩÂ§á‰ªΩÊï∞ÊçÆ
    loadProcessListFromLocal()
  }
}

// ‰ªélocalStorageÂä†ËΩΩÂ∑•Â∫èÊï∞ÊçÆ‰Ωú‰∏∫Â§áÁî®ÊñπÊ°à
const loadProcessListFromLocal = () => {
  try {
    const processData = localStorage.getItem('processListData')
    if (processData) {
      const data = JSON.parse(processData)
      processList.value = data || []
      console.log('‚úÖ ‰ªélocalStorageÂä†ËΩΩÂ∑•Â∫èÊï∞ÊçÆÊàêÂäü:', processList.value.length, 'Êù°')
    } else {
      console.log('‚ö†Ô∏è Êú™ÊâæÂà∞Â∑•Â∫èÊï∞ÊçÆ')
      processList.value = []
    }
  } catch (error) {
    console.error('‚ùå ‰ªélocalStorageÂä†ËΩΩÂ∑•Â∫èÊï∞ÊçÆÂ§±Ë¥•:', error)
    processList.value = []
  }
}

// ‚úÖ Âä†ËΩΩ‰æõÂ∫îÂïÜÂàóË°®
const loadSupplierList = async () => {
  try {
    const response = await request.get('/supplier-management')
    if (response.code === 200 && response.data) {
      supplierList.value = response.data.records || []
      console.log('Âä†ËΩΩ‰æõÂ∫îÂïÜÊï∞ÊçÆÊàêÂäü:', supplierList.value.length, 'Êù°')
    }
  } catch (error) {
    console.error('Âä†ËΩΩ‰æõÂ∫îÂïÜÊï∞ÊçÆÂ§±Ë¥•:', error)
    ElMessage.error('Âä†ËΩΩ‰æõÂ∫îÂïÜÊï∞ÊçÆÂ§±Ë¥•')
  }
}

// ‚úÖ Ê∑ªÂä†‰æõÂ∫îÂïÜ
const handleAddSupplier = () => {
  formData.suppliers.push({
    supplierName: '',
    minimumOrderQuantity: 0,
    tierRange: '',
    tierUnitPrice: 0,
    taxRate: 13,
    standardPackagingQuantity: 0,
    orderingRule: 'ÈªòËÆ§'
  })
}

// ‚úÖ Âà†Èô§‰æõÂ∫îÂïÜ
const handleDeleteSupplier = (index) => {
  formData.suppliers.splice(index, 1)
}
</script>

<style scoped>
.material-edit {
  padding: 20px;
}

.footer-buttons {
  margin-top: 20px;
  padding-top: 20px;
  border-top: 1px solid #dcdfe6;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.nav-buttons,
.action-buttons {
  display: flex;
  gap: 10px;
}

/* ÂõæÁâá‰∏ä‰º†Ê†∑Âºè */
.avatar-uploader {
  border: 1px dashed #d9d9d9;
  border-radius: 6px;
  cursor: pointer;
  position: relative;
  overflow: hidden;
  transition: border-color 0.3s;
}

.avatar-uploader:hover {
  border-color: #409EFF;
}

.avatar-uploader-icon {
  font-size: 28px;
  color: #8c939d;
  width: 178px;
  height: 178px;
  display: flex;
  justify-content: center;
  align-items: center;
}

.avatar {
  width: 178px;
  height: 178px;
  display: block;
  object-fit: cover;
}
</style>
