<template>
  <div class="sales-order-list-container">
    <!-- é¡¶éƒ¨å·¥å…·æ  -->
    <div class="toolbar">
      <div class="toolbar-left">
        <h2>é”€å”®è®¢å•ç®¡ç†</h2>
      </div>
      <div class="toolbar-right">
        <el-button type="primary" @click="handleCreate">
          <el-icon><Plus /></el-icon>
          æ–°å¢
        </el-button>
        <el-button type="success" @click="handleConfirmOrder">
          <el-icon><CircleCheck /></el-icon>
          æ­£å¼ä¸‹å•
        </el-button>
        <el-button type="danger" :disabled="!hasSelection" @click="handleManualTerminate">æ‰‹åŠ¨ç»ˆæ­¢</el-button>
        <el-button type="success" :disabled="!canExecuteMRP" @click="handleMRPCalculation">
          <el-icon><DataAnalysis /></el-icon>
          æ‰§è¡ŒMRPè¿ç®—
        </el-button>
        <el-button @click="handleDraft">è‰ç¨¿ç®±</el-button>
        <el-button type="danger" :disabled="!hasSelection" @click="handleDelete">åˆ é™¤</el-button>
        <el-button @click="handleFieldManagement">å­—æ®µç®¡ç†</el-button>
        <el-button @click="handleImport">å¯¼å…¥</el-button>
        <el-button @click="handleExport">å¯¼å‡º</el-button>
        <el-button @click="handleRefresh">åˆ·æ–°</el-button>
        <el-button @click="handleChange">å˜æ›´</el-button>
        <el-button @click="handlePrint">æ‰“å°</el-button>
        <el-button @click="handlePause">æš‚åœ</el-button>
        <el-button type="primary" @click="handleSettings" circle>
          <el-icon><Setting /></el-icon>
        </el-button>
      </div>
    </div>

    <!-- æœç´¢ç­›é€‰åŒº -->
    <div class="search-area">
      <el-input 
        v-model="searchText" 
        placeholder="æœç´¢è®¢å•ç¼–å·ã€å®¢æˆ·åç§°..." 
        clearable
        style="width: 300px; margin-right: 10px;"
      >
        <template #prefix>
          <el-icon><Search /></el-icon>
        </template>
      </el-input>
      <el-select v-model="statusFilter" placeholder="è®¢å•çŠ¶æ€" clearable style="width: 180px; margin-right: 10px;">
        <el-option label="å…¨éƒ¨" value="" />
        <el-option label="å¾…ä¸‹å•" value="å¾…ä¸‹å•" />
        <el-option label="å·²æ¨¡æ‹Ÿæ’ç¨‹å¾…ä¸‹å•" value="å·²æ¨¡æ‹Ÿæ’ç¨‹å¾…ä¸‹å•" />
        <el-option label="è‰ç¨¿" value="draft" />
        <el-option label="å¾…å®¡æ ¸" value="pending" />
        <el-option label="å·²å®¡æ ¸" value="approved" />
        <el-option label="ç”Ÿäº§ä¸­" value="production" />
        <el-option label="å·²å‘è´§" value="shipped" />
        <el-option label="å·²å®Œæˆ" value="completed" />
        <el-option label="å·²å–æ¶ˆ" value="cancelled" />
        <el-option label="æ‰‹åŠ¨ç»ˆæ­¢" value="terminated" />
      </el-select>
      
      <!-- æ¨¡æ‹Ÿæ’ç¨‹è®¢å•æç¤º -->
      <el-tag v-if="simulatedOrders.length > 0" type="warning" style="margin-right: 10px;">
        å½“å‰æœ‰ {{ simulatedOrders.length }} ä¸ªæ¨¡æ‹Ÿæ’ç¨‹è®¢å•æœªä¸‹å•
      </el-tag>
    </div>

    <!-- ä¸»è¡¨æ ¼ -->
    <div class="table-container">
      <el-table
        ref="tableRef"
        :data="filteredTableData"
        stripe
        border
        :height="tableHeight"
        @selection-change="handleSelectionChange"
        :row-style="getRowStyle"
        :span-method="spanMethod"
      >
        <el-table-column type="selection" width="55" fixed="left" />
        <el-table-column prop="orderStatus" label="è®¢å•çŠ¶æ€" width="100" fixed="left">
          <template #default="{ row }">
            <el-tag :type="getStatusType(row.orderStatus)">{{ row.orderStatus || '-' }}</el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="internalOrderNo" label="å†…éƒ¨é”€å”®è®¢å•ç¼–å·" width="160" fixed="left" />
        <el-table-column prop="customerOrderNo" label="å®¢æˆ·è®¢å•ç¼–å·" width="150" />
        <el-table-column prop="customerName" label="å®¢æˆ·åç§°" width="150" />
        <el-table-column prop="salesperson" label="é”€å”®å‘˜" width="100" />
        <el-table-column prop="quotationNo" label="æŠ¥ä»·å•å·" width="140" />
        <el-table-column prop="orderTime" label="ä¸‹å•æ—¶é—´" width="120">
          <template #default="{ row }">
            {{ formatDateYMD(row.orderTime) }}
          </template>
        </el-table-column>
        <el-table-column prop="promisedDelivery" label="æ‰¿è¯ºäº¤æœŸ" width="120" />
        <el-table-column prop="returnOrderNo" label="é”€å”®é€€è´§å•å·" width="140" />
        <el-table-column prop="deliveryMethod" label="é€è´§æ–¹å¼" width="120" />
        <el-table-column prop="salesDepartment" label="é”€å”®éƒ¨é—¨" width="120" />
        <el-table-column prop="orderCurrency" label="è®¢å•å¸ç§" width="100" />
        <el-table-column prop="currentExchangeRate" label="å½“å‰æ±‡ç‡" width="100" />
        <el-table-column prop="taxRate" label="ç¨ç‡" width="80" />
        <el-table-column prop="customerDelivery" label="å®¢æˆ·äº¤æœŸ" width="120">
          <template #default="{ row }">
            {{ formatDateYMD(row.customerDelivery) }}
          </template>
        </el-table-column>
        <el-table-column prop="estimatedCompletionDate" label="é¢„è®¡å®Œæˆæ—¥æœŸ" width="140" />
        <el-table-column prop="orderAttachment" label="è®¢å•é™„ä»¶" width="100">
          <template #default="{ row }">
            <el-button v-if="row.orderAttachment" link type="primary" size="small">æŸ¥çœ‹</el-button>
            <span v-else>-</span>
          </template>
        </el-table-column>
        <el-table-column prop="orderNotes" label="è®¢å•è¯´æ˜" width="150" show-overflow-tooltip />
        <el-table-column prop="totalAmountExcludingTax" label="è®¢å•æ€»é‡‘é¢ï¼ˆæœªç¨ï¼‰" width="160" align="right">
          <template #default="{ row }">
            {{ formatCurrency(row.totalAmountExcludingTax) }}
          </template>
        </el-table-column>
        <el-table-column prop="totalAmountIncludingTax" label="è®¢å•æ€»é‡‘é¢ï¼ˆå«ç¨ï¼‰" width="160" align="right">
          <template #default="{ row }">
            {{ formatCurrency(row.totalAmountIncludingTax) }}
          </template>
        </el-table-column>
        <el-table-column prop="packagingMethod" label="åŒ…è£…æ–¹å¼" width="120" />
        <el-table-column prop="packagingRequirements" label="åŒ…è£…éœ€æ±‚æè¿°" width="150" show-overflow-tooltip />
        <el-table-column prop="packagingAttachment" label="åŒ…è£…é™„ä»¶" width="100">
          <template #default="{ row }">
            <el-button v-if="row.packagingAttachment" link type="primary" size="small">æŸ¥çœ‹</el-button>
            <span v-else>-</span>
          </template>
        </el-table-column>
        <el-table-column prop="consignee" label="æ”¶è´§äºº" width="100" />
        <el-table-column prop="deliveryAddress" label="æ”¶è´§åœ°å€" width="200" show-overflow-tooltip />
        <el-table-column prop="billRecipient" label="è´¦å•æ”¶ä»¶äºº" width="120" />
        <el-table-column prop="billAddress" label="è´¦å•æ”¶ä»¶åœ°å€" width="200" show-overflow-tooltip />
        <el-table-column prop="paymentMethod" label="æ”¶æ¬¾æ–¹å¼" width="120" />
        <el-table-column prop="advancePaymentRatio" label="é¢„æ”¶å æ¯”" width="100" />
        <el-table-column prop="fees" label="æ‰‹ç»­è´¹æˆ–å…¶ä»–è´¹ç”¨" width="140" align="right">
          <template #default="{ row }">
            {{ formatCurrency(row.fees) }}
          </template>
        </el-table-column>
        <el-table-column prop="paymentPlan" label="å›æ¬¾è®¡åˆ’" width="120" />
        <el-table-column prop="totalReceivable" label="åº”å›æ¬¾æ€»é¢" width="140" align="right">
          <template #default="{ row }">
            {{ formatCurrency(row.totalReceivable) }}
          </template>
        </el-table-column>
        <el-table-column prop="plannedPaymentDate" label="è®¡åˆ’å›æ¬¾æ—¥æœŸ" width="140" />
        <el-table-column prop="plannedPaymentAmount" label="è®¡åˆ’å›æ¬¾é‡‘é¢" width="140" align="right">
          <template #default="{ row }">
            {{ formatCurrency(row.plannedPaymentAmount) }}
          </template>
        </el-table-column>
        <el-table-column prop="createTime" label="åˆ›å»ºæ—¶é—´" width="160" />
        <el-table-column prop="orderType" label="è®¢å•ç±»å‹" width="100" />
        
        <!-- äº§å“ç›¸å…³å­—æ®µ -->
        <el-table-column prop="productCode" label="äº§å“ç¼–å·" width="140" />
        <el-table-column prop="productName" label="äº§å“åç§°" width="150" />
        <el-table-column prop="productImage" label="äº§å“å›¾ç‰‡" width="100">
          <template #default="{ row }">
            <el-image v-if="row.productImage" :src="row.productImage" style="width: 50px; height: 50px;" fit="cover" />
            <span v-else>-</span>
          </template>
        </el-table-column>
        <el-table-column prop="salesBomSelection" label="é”€å”®BOMé€‰æ‹©" width="140" />
        <el-table-column prop="majorCategory" label="å¤§ç±»" width="100" />
        <el-table-column prop="middleCategory" label="ä¸­ç±»" width="100" />
        <el-table-column prop="minorCategory" label="å°ç±»" width="100" />
        <el-table-column prop="productSource" label="äº§å“æ¥æº" width="100" />
        <el-table-column prop="productSpec" label="äº§å“è§„æ ¼" width="150" show-overflow-tooltip />
        <el-table-column prop="productColor" label="äº§å“é¢œè‰²" width="100" />
        <el-table-column prop="productMaterial" label="äº§å“æè´¨" width="120" />
        <el-table-column prop="productDescription" label="äº§å“è¯¦è¿°" width="200" show-overflow-tooltip />
        <el-table-column prop="outputProcess" label="äº§å‡ºå·¥åº" width="120" show-overflow-tooltip />
        <el-table-column prop="realtimeInventory" label="å®æ—¶åº“å­˜" width="100" align="right" />
        <el-table-column prop="availableInventory" label="å¯é”€å”®åº“å­˜" width="120" align="right" />
        <el-table-column prop="effectiveInventory" label="æœ‰æ•ˆåº“å­˜" width="100" align="right" />
        <el-table-column prop="estimatedBalance" label="é¢„è®¡ç»“å­˜" width="100" align="right" />
        <el-table-column prop="productUnit" label="äº§å“å•ä½" width="100" />
        <el-table-column prop="orderQuantity" label="è®¢å•æ•°é‡" width="100" align="right" />
        <el-table-column prop="unitPriceExcludingTax" label="é”€å”®å•ä»·ï¼ˆæœªç¨ï¼‰" width="150" align="right">
          <template #default="{ row }">
            {{ formatCurrency(row.unitPriceExcludingTax) }}
          </template>
        </el-table-column>
        <el-table-column prop="productTaxRate" label="ç¨ç‡" width="80" />
        <el-table-column prop="unitPriceIncludingTax" label="å«ç¨å•ä»·" width="120" align="right">
          <template #default="{ row }">
            {{ formatCurrency(row.unitPriceIncludingTax) }}
          </template>
        </el-table-column>
        <el-table-column prop="amountExcludingTax" label="é‡‘é¢ï¼ˆæœªç¨ï¼‰" width="120" align="right">
          <template #default="{ row }">
            {{ formatCurrency(row.amountExcludingTax) }}
          </template>
        </el-table-column>
        <el-table-column prop="amountIncludingTax" label="å«ç¨é‡‘é¢" width="120" align="right">
          <template #default="{ row }">
            {{ formatCurrency(row.amountIncludingTax) }}
          </template>
        </el-table-column>
        <el-table-column prop="appliedShipmentQty" label="å·²ç”³è¯·å‘è´§æ•°é‡" width="140" align="right" />
        <el-table-column prop="unappliedShipmentQty" label="æœªç”³è¯·å‘è´§æ•°é‡" width="140" align="right" />
        <el-table-column prop="shippedQty" label="å·²å‘è´§æ•°é‡" width="120" align="right" />
        <el-table-column prop="unshippedQty" label="æœªå‘è´§æ•°é‡" width="120" align="right" />
        <el-table-column prop="receivedAmount" label="å·²å›æ¬¾é‡‘é¢" width="120" align="right">
          <template #default="{ row }">
            {{ formatCurrency(row.receivedAmount) }}
          </template>
        </el-table-column>
        <el-table-column prop="unreceivedAmount" label="æœªå›æ¬¾é‡‘é¢" width="120" align="right">
          <template #default="{ row }">
            {{ formatCurrency(row.unreceivedAmount) }}
          </template>
        </el-table-column>
        <el-table-column prop="hasAfterSales" label="æ˜¯å¦æœ‰å”®å" width="120">
          <template #default="{ row }">
            <el-tag :type="row.hasAfterSales ? 'warning' : 'success'">{{ row.hasAfterSales ? 'æ˜¯' : 'å¦' }}</el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="afterSalesDetails" label="å”®åè¯¦æƒ…" width="150" show-overflow-tooltip />
        <el-table-column prop="afterSalesOrderNo" label="å”®åè®¢å•å·" width="140" />
        
        <!-- æ“ä½œåˆ— -->
        <el-table-column label="æ“ä½œ" width="320" fixed="right">
          <template #default="{ row }">
            <el-button link type="primary" @click="handleEdit(row)">ç¼–è¾‘</el-button>
            <el-button link type="success" @click="handleView(row)">æŸ¥çœ‹</el-button>
            <el-button 
              link 
              type="warning" 
              @click="handleSimulateScheduling(row)"
              v-if="row.orderStatus === 'å¾…ä¸‹å•' || row.orderStatus === 'è‰ç¨¿'"
            >
              æ¨¡æ‹Ÿæ’ç¨‹
            </el-button>
            <el-button 
              link 
              type="success" 
              @click="handleConfirmOrder(row)"
              v-if="row.orderStatus === 'å¾…ä¸‹å•' || row.orderStatus === 'å·²æ¨¡æ‹Ÿæ’ç¨‹å¾…ä¸‹å•'"
            >
              ç¡®è®¤ä¸‹å•
            </el-button>
            <el-button link type="danger" @click="handleDeleteRow(row)">åˆ é™¤</el-button>
          </template>
        </el-table-column>
      </el-table>
    </div>

    <!-- åˆ†é¡µ -->
    <div class="pagination-container">
      <el-pagination
        v-model:current-page="currentPage"
        v-model:page-size="pageSize"
        :page-sizes="[10, 20, 50, 100]"
        :total="totalCount"
        layout="total, sizes, prev, pager, next, jumper"
        @size-change="handleSizeChange"
        @current-change="handleCurrentChange"
      />
    </div>

    <!-- é¡µé¢è®¾ç½®å¯¹è¯æ¡† -->
    <el-dialog v-model="settingsVisible" title="é¡µé¢è®¾ç½®" width="800px">
      <el-tabs v-model="activeTab">
        <el-tab-pane label="æµç¨‹è®¾ç½®" name="workflow">
          <el-form label-width="160px">
            <el-form-item label="å®¡æ‰¹æµç¨‹">
              <el-select v-model="settings.approvalFlow" style="width: 100%;">
                <el-option label="å•çº§å®¡æ‰¹" value="single" />
                <el-option label="å¤šçº§å®¡æ‰¹" value="multi" />
                <el-option label="è‡ªå®šä¹‰" value="custom" />
              </el-select>
            </el-form-item>
          </el-form>
        </el-tab-pane>
        
        <el-tab-pane label="æ¨¡æ‹Ÿæ’ç¨‹è®¾ç½®" name="scheduling">
          <el-form label-width="200px">
            <el-form-item label="æ¨¡æ‹Ÿæ’ç¨‹å¤±æ•ˆå¤©æ•°">
              <el-input-number 
                v-model="settings.simulationExpireDays" 
                :min="1" 
                :max="30" 
                style="width: 200px;"
              />
              <span style="margin-left: 10px; color: #909399;">å¤©</span>
            </el-form-item>
            <el-form-item label="è¯´æ˜">
              <el-alert 
                type="info" 
                :closable="false"
                show-icon
              >
                <template #title>
                  <div style="line-height: 1.6;">
                    æ¨¡æ‹Ÿæ’ç¨‹æœŸé—´ï¼Œå½“æ–°å¢è®¢å•çš„æ‰¿è¯ºäº¤æœŸå‡å»è®¾ç½®å¤©æ•°å°äºç­‰äºæœ¬è®¢å•çš„é¢„è®¡å®Œæˆæ—¥æœŸï¼Œ<br/>
                    åˆ™æœ¬è®¢å•çš„æ¨¡æ‹Ÿæ’ç¨‹ç»“æœå¤±æ•ˆï¼Œéœ€è¦é‡æ–°æ¨¡æ‹Ÿæ’ç¨‹ã€‚
                  </div>
                </template>
              </el-alert>
            </el-form-item>
            <el-form-item label="ç¤ºä¾‹">
              <el-alert type="warning" :closable="false">
                <template #title>
                  <div style="line-height: 1.6;">
                    <b>ç¤ºä¾‹ï¼š</b>è®¾ç½®å¤±æ•ˆå¤©æ•°ä¸º 3 å¤©<br/>
                    Aè®¢å•ï¼šé¢„è®¡å®Œæˆæ—¥æœŸ = 2025-12-10<br/>
                    Bè®¢å•ï¼ˆæ–°å¢ï¼‰ï¼šæ‰¿è¯ºäº¤æœŸ = 2025-12-12<br/>
                    <b>è®¡ç®—ï¼š</b>2025-12-12 - 3å¤© = 2025-12-09<br/>
                    <b>ç»“æœï¼š</b>2025-12-09 < 2025-12-10ï¼Œ<span style="color: #E6A23C;">â†’ Aè®¢å•æ¨¡æ‹Ÿæ’ç¨‹å¤±æ•ˆ</span>
                  </div>
                </template>
              </el-alert>
            </el-form-item>
          </el-form>
        </el-tab-pane>
        
        <el-tab-pane label="ä¸šåŠ¡å˜é‡è®¾ç½®" name="variables">
          <el-form label-width="160px">
            <el-form-item label="é»˜è®¤å¸ç§">
              <el-select v-model="settings.defaultCurrency" style="width: 200px;">
                <el-option label="äººæ°‘å¸ (CNY)" value="CNY" />
                <el-option label="ç¾å…ƒ (USD)" value="USD" />
                <el-option label="æ¬§å…ƒ (EUR)" value="EUR" />
              </el-select>
            </el-form-item>
            <el-form-item label="é»˜è®¤æ±‡ç‡">
              <el-input-number v-model="settings.defaultExchangeRate" :min="0.1" :step="0.1" style="width: 200px;" />
            </el-form-item>
            <el-form-item label="é»˜è®¤ç¨ç‡">
              <el-input-number v-model="settings.defaultTaxRate" :min="0" :max="100" style="width: 200px;" />
              <span style="margin-left: 10px; color: #909399;">%</span>
            </el-form-item>
            <el-form-item label="é»˜è®¤ä»˜æ¬¾æ–¹å¼">
              <el-select v-model="settings.defaultPaymentMethod" style="width: 200px;">
                <el-option label="é¢„ä»˜+å°¾æ¬¾" value="é¢„ä»˜+å°¾æ¬¾" />
                <el-option label="è´§åˆ°ä»˜æ¬¾" value="è´§åˆ°ä»˜æ¬¾" />
                <el-option label="æœˆç»“" value="æœˆç»“" />
              </el-select>
            </el-form-item>
            <el-form-item label="é»˜è®¤é€è´§æ–¹å¼">
              <el-select v-model="settings.defaultDeliveryMethod" style="width: 200px;">
                <el-option label="å¿«é€’" value="å¿«é€’" />
                <el-option label="ç‰©æµ" value="ç‰©æµ" />
                <el-option label="è‡ªæ" value="è‡ªæ" />
              </el-select>
            </el-form-item>
          </el-form>
        </el-tab-pane>
        
        <el-tab-pane label="èœå•è®¾ç½®" name="menu">
          <el-form label-width="120px">
            <el-form-item label="èœå•ä½ç½®">
              <el-radio-group v-model="settings.menuPosition">
                <el-radio label="top">é¡¶éƒ¨</el-radio>
                <el-radio label="left">å·¦ä¾§</el-radio>
              </el-radio-group>
            </el-form-item>
          </el-form>
        </el-tab-pane>
        
        <el-tab-pane label="é¢œè‰²è®¾ç½®" name="color">
          <el-form label-width="120px">
            <el-form-item label="ä¸»é¢˜è‰²">
              <el-color-picker v-model="settings.themeColor" />
            </el-form-item>
            <el-form-item label="é¡µé¢èƒŒæ™¯è‰²">
              <el-color-picker v-model="settings.backgroundColor" />
            </el-form-item>
            <el-form-item label="è¡¨æ ¼è¡ŒèƒŒæ™¯è‰²">
              <el-color-picker v-model="settings.tableRowColor" />
            </el-form-item>
          </el-form>
        </el-tab-pane>
        
        <el-tab-pane label="ç¼–ç è®¾ç½®" name="encoding">
          <el-form label-width="120px">
            <el-form-item label="è®¢å•ç¼–å·è§„åˆ™">
              <el-input v-model="settings.orderNoRule" placeholder="å¦‚: SO{YYYY}{MM}{DD}{####}" />
            </el-form-item>
          </el-form>
        </el-tab-pane>
      </el-tabs>
      <template #footer>
        <el-button @click="settingsVisible = false">å–æ¶ˆ</el-button>
        <el-button type="primary" @click="handleSaveSettings">ä¿å­˜</el-button>
      </template>
    </el-dialog>

    <!-- å­—æ®µç®¡ç†å¯¹è¯æ¡† -->
    <el-dialog v-model="fieldManagementVisible" title="å­—æ®µç®¡ç†" width="600px">
      <el-checkbox-group v-model="visibleFields">
        <div v-for="field in allFields" :key="field.prop" style="margin-bottom: 10px;">
          <el-checkbox :label="field.prop">{{ field.label }}</el-checkbox>
        </div>
      </el-checkbox-group>
      <template #footer>
        <el-button @click="fieldManagementVisible = false">å–æ¶ˆ</el-button>
        <el-button type="primary" @click="handleSaveFieldSettings">ä¿å­˜</el-button>
      </template>
    </el-dialog>

    <!-- æ–°å¢è®¢å•å¯¹è¯æ¡† -->
    <el-dialog 
      v-model="createDialogVisible" 
      title="æ–°å¢é”€å”®è®¢å•" 
      width="90%" 
      :close-on-click-modal="false"
      destroy-on-close
    >
      <SalesOrderCreate @success="handleCreateSuccess" @cancel="createDialogVisible = false" />
    </el-dialog>

    <!-- ç¼–è¾‘è®¢å•å¯¹è¯æ¡† -->
    <el-dialog 
      v-model="editDialogVisible" 
      title="ç¼–è¾‘é”€å”®è®¢å•" 
      width="90%" 
      :close-on-click-modal="false"
      destroy-on-close
    >
      <SalesOrderCreate 
        :order-data="currentOrder" 
        :is-edit="true"
        @success="handleEditSuccess" 
        @cancel="editDialogVisible = false" 
      />
    </el-dialog>

    <!-- æŸ¥çœ‹è®¢å•å¯¹è¯æ¡† -->
    <el-dialog 
      v-model="viewDialogVisible" 
      title="é”€å”®è®¢å•è¯¦æƒ…" 
      width="80%" 
      :close-on-click-modal="false"
    >
      <SalesOrderView 
        :order-id="currentOrder?.id" 
        @close="viewDialogVisible = false" 
      />
    </el-dialog>

    <!-- å¯¼å…¥å¯¹è¯æ¡† -->
    <el-dialog v-model="importDialogVisible" title="å¯¼å…¥é”€å”®è®¢å•" width="500px">
      <el-upload
        class="upload-demo"
        drag
        action="#"
        :auto-upload="false"
        :on-change="handleFileChange"
        accept=".xlsx,.xls"
      >
        <el-icon class="el-icon--upload"><UploadFilled /></el-icon>
        <div class="el-upload__text">
          å°†æ–‡ä»¶æ‹–åˆ°æ­¤å¤„ï¼Œæˆ–<em>ç‚¹å‡»ä¸Šä¼ </em>
        </div>
        <template #tip>
          <div class="el-upload__tip">
            ä»…æ”¯æŒ xlsx/xls æ ¼å¼æ–‡ä»¶ï¼Œå¤§å°ä¸è¶…è¿‡ 10MB
          </div>
        </template>
      </el-upload>
      <template #footer>
        <el-button @click="importDialogVisible = false">å–æ¶ˆ</el-button>
        <el-button type="primary" @click="handleImportConfirm">ç¡®å®šå¯¼å…¥</el-button>
      </template>
    </el-dialog>

    <!-- MRPè¿ç®—ç»“æœå¯¹è¯æ¡† -->
    <el-dialog
      v-model="mrpDialogVisible"
      title="MRPè¿ç®—ç»“æœ"
      width="90%"
      :close-on-click-modal="false"
      @close="closeMRPDialog"
    >
      <div v-loading="mrpCalculating" element-loading-text="æ­£åœ¨è®¡ç®—MRP...">
        <div v-if="mrpResult">
          <!-- æ±‡æ€»ä¿¡æ¯ -->
          <el-card shadow="hover" style="margin-bottom: 20px;">
            <template #header>
              <div style="display: flex; align-items: center;">
                <el-icon style="margin-right: 8px;"><DataAnalysis /></el-icon>
                <span>è¿ç®—æ±‡æ€»</span>
              </div>
            </template>
            <el-row :gutter="20">
              <el-col :span="6">
                <el-statistic title="å·²å¤„ç†è®¢å•" :value="mrpResult.summary.ordersProcessed" />
              </el-col>
              <el-col :span="6">
                <el-statistic title="ç‰©æ–™ç§ç±»æ€»æ•°" :value="mrpResult.summary.totalMaterials" />
              </el-col>
              <el-col :span="6">
                <el-statistic title="éœ€è¦ç”Ÿäº§" :value="mrpResult.summary.productionCount" suffix="ç§" />
              </el-col>
              <el-col :span="6">
                <el-statistic title="éœ€è¦é‡‡è´­" :value="mrpResult.summary.purchaseCount" suffix="ç§" />
              </el-col>
            </el-row>
          </el-card>

          <!-- å·²å¤„ç†è®¢å• -->
          <el-card shadow="hover" style="margin-bottom: 20px;">
            <template #header>å·²å¤„ç†è®¢å•</template>
            <el-table :data="mrpResult.processedOrders" border stripe max-height="200">
              <el-table-column prop="orderNo" label="è®¢å•ç¼–å·" width="180" />
              <el-table-column prop="customerName" label="å®¢æˆ·åç§°" width="150" />
              <el-table-column prop="orderStatus" label="è®¢å•çŠ¶æ€" width="120">
                <template #default="{ row }">
                  <el-tag>{{ row.orderStatus }}</el-tag>
                </template>
              </el-table-column>
            </el-table>
          </el-card>

          <!-- Tabs: ç”Ÿäº§éœ€æ±‚ & é‡‡è´­éœ€æ±‚ -->
          <el-tabs type="border-card">
            <!-- ç”Ÿäº§éœ€æ±‚ -->
            <el-tab-pane>
              <template #label>
                <span>
                  <el-icon><Tools /></el-icon>
                  ç”Ÿäº§éœ€æ±‚ ({{ mrpResult.productionRequirements.length }})
                </span>
              </template>
              <el-table 
                :data="mrpResult.productionRequirements" 
                border 
                stripe
                max-height="400"
                :default-sort="{ prop: 'level', order: 'ascending' }"
              >
                <el-table-column type="index" label="åºå·" width="60" />
                <el-table-column prop="level" label="å±‚é˜¶" width="80" align="center" sortable />
                <el-table-column prop="materialCode" label="ç‰©æ–™ç¼–å·" width="150" />
                <el-table-column prop="materialName" label="ç‰©æ–™åç§°" width="180" />
                <el-table-column prop="demandQty" label="æ€»éœ€æ±‚é‡" width="120" align="right">
                  <template #default="{ row }">
                    <span style="font-weight: bold; color: #409EFF;">{{ row.demandQty?.toFixed(4) || 0 }}</span>
                  </template>
                </el-table-column>
                <el-table-column prop="currentStock" label="å½“å‰åº“å­˜" width="120" align="right">
                  <template #default="{ row }">
                    {{ row.currentStock?.toFixed(4) || 0 }}
                  </template>
                </el-table-column>
                <el-table-column prop="netDemandQty" label="å‡€éœ€æ±‚é‡" width="120" align="right">
                  <template #default="{ row }">
                    <el-tag v-if="row.netDemandQty > 0" type="warning">
                      {{ row.netDemandQty?.toFixed(4) }}
                    </el-tag>
                    <span v-else style="color: #67C23A;">0</span>
                  </template>
                </el-table-column>
                <el-table-column prop="source" label="æ¥æº" width="100" />
                <el-table-column prop="sourceOrders" label="æ¥æºBOM" width="200">
                  <template #default="{ row }">
                    {{ row.sourceOrders?.join(', ') || '-' }}
                  </template>
                </el-table-column>
              </el-table>
            </el-tab-pane>

            <!-- é‡‡è´­éœ€æ±‚ -->
            <el-tab-pane>
              <template #label>
                <span>
                  <el-icon><ShoppingCart /></el-icon>
                  é‡‡è´­éœ€æ±‚ ({{ mrpResult.purchaseRequirements.length }})
                </span>
              </template>
              <el-table 
                :data="mrpResult.purchaseRequirements" 
                border 
                stripe
                max-height="400"
                :default-sort="{ prop: 'netDemandQty', order: 'descending' }"
              >
                <el-table-column type="index" label="åºå·" width="60" />
                <el-table-column prop="materialCode" label="ç‰©æ–™ç¼–å·" width="150" />
                <el-table-column prop="materialName" label="ç‰©æ–™åç§°" width="180" />
                <el-table-column prop="demandQty" label="æ€»éœ€æ±‚é‡" width="120" align="right">
                  <template #default="{ row }">
                    <span style="font-weight: bold; color: #409EFF;">{{ row.demandQty?.toFixed(4) || 0 }}</span>
                  </template>
                </el-table-column>
                <el-table-column prop="currentStock" label="å½“å‰åº“å­˜" width="120" align="right">
                  <template #default="{ row }">
                    {{ row.currentStock?.toFixed(4) || 0 }}
                  </template>
                </el-table-column>
                <el-table-column prop="netDemandQty" label="å‡€éœ€æ±‚é‡" width="120" align="right" sortable>
                  <template #default="{ row }">
                    <el-tag v-if="row.netDemandQty > 0" type="danger">
                      {{ row.netDemandQty?.toFixed(4) }}
                    </el-tag>
                    <span v-else style="color: #67C23A;">0</span>
                  </template>
                </el-table-column>
                <el-table-column prop="source" label="æ¥æº" width="100" />
                <el-table-column prop="sourceOrders" label="æ¥æºBOM" width="200">
                  <template #default="{ row }">
                    {{ row.sourceOrders?.join(', ') || '-' }}
                  </template>
                </el-table-column>
              </el-table>
            </el-tab-pane>
          </el-tabs>
        </div>
      </div>

      <template #footer>
        <el-button @click="closeMRPDialog">å…³é—­</el-button>
        <el-button type="primary" @click="closeMRPDialog">ç¡®å®š</el-button>
      </template>
    </el-dialog>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import { ElMessage, ElMessageBox, ElLoading } from 'element-plus'
import { salesOrderApi } from '@/api/salesOrder'
import mrpAPI from '@/api/mrp'
import materialApiService from '@/services/api/materialApiService'
import { Search, Setting, Plus, UploadFilled, DataAnalysis, Tools, ShoppingCart, CircleCheck } from '@element-plus/icons-vue'
import SalesOrderCreate from './SalesOrderCreate.vue'
import SalesOrderView from './SalesOrderView.vue'
import { useRouter } from 'vue-router'

const router = useRouter()

// æ•°æ®
const tableRef = ref(null)
const searchText = ref('')
const statusFilter = ref('')
const simulatingOrderId = ref(null) // å½“å‰æ­£åœ¨æ¨¡æ‹Ÿæ’ç¨‹çš„è®¢å•ID
const simulatedOrders = ref([]) // å·²æ¨¡æ‹Ÿæ’ç¨‹çš„è®¢å•åˆ—è¡¨
const selectedRows = ref([])
const currentPage = ref(1)
const pageSize = ref(20)
const totalCount = ref(0)
const tableHeight = ref(600)
const settingsVisible = ref(false)
const fieldManagementVisible = ref(false)
const createDialogVisible = ref(false)
const editDialogVisible = ref(false)
const viewDialogVisible = ref(false)
const importDialogVisible = ref(false)
const currentOrder = ref(null)
const activeTab = ref('workflow')

// è¡¨æ ¼æ•°æ®ï¼ˆæ¨¡æ‹Ÿæ•°æ®ï¼‰
const tableData = ref([])

// ç‰©æ–™æ•°æ®ç¼“å­˜ï¼ˆç”¨äºlookupäº§å‡ºå·¥åºï¼‰
const materialDataMap = ref(new Map())

// ä¸‹ä¸€ä¸ªè®¢å•ID
const nextOrderId = ref(2)

// æ‰€æœ‰å­—æ®µé…ç½®
const allFields = ref([
  { prop: 'orderStatus', label: 'è®¢å•çŠ¶æ€' },
  { prop: 'internalOrderNo', label: 'å†…éƒ¨é”€å”®è®¢å•ç¼–å·' },
  { prop: 'customerOrderNo', label: 'å®¢æˆ·è®¢å•ç¼–å·' },
  { prop: 'customerName', label: 'å®¢æˆ·åç§°' },
  // ... å…¶ä»–å­—æ®µ
])

const visibleFields = ref([])

// è®¾ç½®
const settings = ref({
  approvalFlow: 'single',
  menuPosition: 'left',
  themeColor: '#409EFF',
  backgroundColor: '#f5f7fa',
  tableRowColor: '#ffffff',
  orderNoRule: 'SO{YYYY}{MM}{DD}{####}',
  simulationExpireDays: 1, // æ¨¡æ‹Ÿæ’ç¨‹å¤±æ•ˆå¤©æ•°
  defaultCurrency: 'CNY', // é»˜è®¤å¸ç§
  defaultExchangeRate: 1.0, // é»˜è®¤æ±‡ç‡
  defaultTaxRate: 13, // é»˜è®¤ç¨ç‡
  defaultPaymentMethod: 'é¢„ä»˜+å°¾æ¬¾', // é»˜è®¤ä»˜æ¬¾æ–¹å¼
  defaultDeliveryMethod: 'å¿«é€’' // é»˜è®¤é€è´§æ–¹å¼
})

// è®¡ç®—å±æ€§
const hasSelection = computed(() => selectedRows.value.length > 0)

const filteredTableData = computed(() => {
  let data = tableData.value
  
  // æœç´¢è¿‡æ»¤
  if (searchText.value) {
    data = data.filter(row => 
      row.internalOrderNo.includes(searchText.value) ||
      row.customerName.includes(searchText.value)
    )
  }
  
  // çŠ¶æ€è¿‡æ»¤
  if (statusFilter.value) {
    data = data.filter(row => row.orderStatus === statusFilter.value)
  }
  
  totalCount.value = data.length
  return data.slice((currentPage.value - 1) * pageSize.value, currentPage.value * pageSize.value)
})

// æ–¹æ³•
const formatCurrency = (value) => {
  if (!value) return 'Â¥0.00'
  return `Â¥${Number(value).toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`
}

// âœ… æ ¼å¼åŒ–æ—¥æœŸä¸ºå¹´æœˆæ—¥
const formatDateYMD = (dateStr) => {
  if (!dateStr) return '-'
  try {
    const date = new Date(dateStr)
    if (isNaN(date.getTime())) return '-'
    const year = date.getFullYear()
    const month = String(date.getMonth() + 1).padStart(2, '0')
    const day = String(date.getDate()).padStart(2, '0')
    return `${year}-${month}-${day}`
  } catch (e) {
    return '-'
  }
}

const getStatusType = (status) => {
  const typeMap = {
    'è‰ç¨¿': 'info',
    'å¾…å®¡æ ¸': 'warning',
    'å·²å®¡æ ¸': 'success',
    'ç”Ÿäº§ä¸­': 'primary',
    'å·²å‘è´§': 'primary',
    'å·²å®Œæˆ': 'success',
    'å·²å–æ¶ˆ': 'danger',
    'æ‰‹åŠ¨ç»ˆæ­¢': 'danger'
  }
  return typeMap[status] || 'info'
}

const getRowStyle = ({ row }) => {
  return {
    backgroundColor: settings.value.tableRowColor
  }
}

const handleSelectionChange = (selection) => {
  selectedRows.value = selection
}

const handleSizeChange = (size) => {
  pageSize.value = size
  currentPage.value = 1
}

const handleCurrentChange = (page) => {
  currentPage.value = page
}

// å·¥å…·æ æ“ä½œ
const handleCreate = () => {
  createDialogVisible.value = true
}

// åŠ è½½è®¢å•æ•°æ®
const loadOrders = async () => {
  try {
    const response = await salesOrderApi.getSalesOrders({
      page: currentPage.value,
      pageSize: pageSize.value
    })
    
    if (response.data.success) {
      const orders = response.data.data.list
      
      // ğŸ”„ å°†è®¢å•æŒ‰äº§å“å±•å¼€ï¼Œæ¯ä¸ªäº§å“ä¸€è¡Œ
      const expandedRows = []
      
      orders.forEach(order => {
        // è§£æäº§å“åˆ—è¡¨
        let products = []
        
        // å¦‚æœæœ‰productListå­—æ®µä¸”æ˜¯å­—ç¬¦ä¸²ï¼Œå°è¯•è§£æ
        if (order.productList && typeof order.productList === 'string') {
          try {
            const parsedProducts = JSON.parse(order.productList)
            products = parsedProducts.map(p => ({
              productCode: p.product_code || p.productCode,
              productName: p.product_name || p.productName,
              productImage: p.product_image || p.productImage,
              productSpec: p.product_spec || p.productSpec,
              productColor: p.product_color || p.productColor,
              productMaterial: p.product_material || p.productMaterial,
              productDescription: p.product_description || p.productDescription,
              productUnit: p.product_unit || p.productUnit,
              orderQuantity: p.order_quantity || p.orderQuantity,
              outputProcess: p.output_process || p.outputProcess || '' // âœ… ä»æ•°æ®åº“è¯»å–äº§å‡ºå·¥åº
            }))
          } catch (e) {
            console.warn('è§£æäº§å“åˆ—è¡¨å¤±è´¥:', e)
            products = []
          }
        } else if (Array.isArray(order.productList)) {
          products = order.productList.map(p => ({
            productCode: p.product_code || p.productCode,
            productName: p.product_name || p.productName,
            productImage: p.product_image || p.productImage,
            productSpec: p.product_spec || p.productSpec,
            productColor: p.product_color || p.productColor,
            productMaterial: p.product_material || p.productMaterial,
            productDescription: p.product_description || p.productDescription,
            productUnit: p.product_unit || p.productUnit,
            orderQuantity: p.order_quantity || p.orderQuantity,
            outputProcess: p.output_process || p.outputProcess || '' // âœ… ä»æ•°æ®åº“è¯»å–äº§å‡ºå·¥åº
          }))
        }
        
        // å¦‚æœæ²¡æœ‰äº§å“åˆ—è¡¨ï¼Œä½†æœ‰å•ä¸ªäº§å“ä¿¡æ¯ï¼Œåˆ›å»ºäº§å“æ•°ç»„
        if (products.length === 0 && order.productCode) {
          products = [{
            productCode: order.productCode,
            productName: order.productName,
            productImage: order.productImage,
            productSpec: order.productSpec,
            productColor: order.productColor,
            productMaterial: order.productMaterial,
            productDescription: order.productDescription,
            productUnit: order.productUnit,
            orderQuantity: order.orderQuantity,
            outputProcess: order.output_process || order.outputProcess || '' // âœ… ä»æ•°æ®åº“è¯»å–äº§å‡ºå·¥åº
          }]
        }
        
        // å¦‚æœè¿˜æ˜¯æ²¡æœ‰äº§å“ï¼Œåˆ›å»ºä¸€ä¸ªç©ºäº§å“
        if (products.length === 0) {
          products = [{
            productCode: '',
            productName: '',
            productImage: '',
            productSpec: '',
            productColor: '',
            productMaterial: '',
            productDescription: '',
            productUnit: '',
            orderQuantity: ''
          }]
        }
        
        // ä¸ºæ¯ä¸ªäº§å“åˆ›å»ºä¸€è¡Œï¼Œä½†å…±äº«ç›¸åŒçš„è®¢å•ä¸»å­—æ®µ
        products.forEach((product, productIndex) => {
          expandedRows.push({
            id: order.id,
            productIndex, // äº§å“åœ¨è¯¥è®¢å•ä¸­çš„ç´¢å¼•
            productCount: products.length, // è¯¥è®¢å•çš„äº§å“æ€»æ•°
            
            // è®¢å•ä¸»å­—æ®µï¼ˆæ¯ä¸ªäº§å“è¡Œéƒ½æœ‰ï¼Œä½†ä¼šè¢«åˆå¹¶ï¼‰
            internalOrderNo: order.internal_order_no,
            customerOrderNo: order.customer_order_no,
            customerName: order.customer_name,
            customerId: order.customer_id,
            salesperson: order.salesperson,
            quotationNo: order.quotation_no,
            orderType: order.order_type,
            orderStatus: order.status || 'å¾…ä¸‹å•',
            
            // äº§å“ä¿¡æ¯ï¼ˆæ¯ä¸ªäº§å“è¡Œéƒ½ä¸åŒï¼‰
            productCode: product.productCode,
            productName: product.productName,
            productImage: product.productImage,
            productSpec: product.productSpec,
            productColor: product.productColor,
            productMaterial: product.productMaterial,
            productDescription: product.productDescription,
            productUnit: product.productUnit,
            orderQuantity: product.orderQuantity,
            outputProcess: product.outputProcess || '', // âœ… ç›´æ¥ä»äº§å“æ•°æ®ä¸­è¯»å–ï¼Œæ— éœ€lookup
            
            // æ—¶é—´ä¿¡æ¯
            orderTime: order.order_time,
            promisedDelivery: order.promised_delivery,
            customerDelivery: order.customer_delivery,
            estimatedCompletionDate: order.estimated_completion_date,
            createTime: new Date(order.created_at).toLocaleString('zh-CN'),
            updateTime: order.updated_at ? new Date(order.updated_at).toLocaleString('zh-CN') : null,
            
            // é”€å”®éƒ¨é—¨å’Œç‰©æµä¿¡æ¯
            salesDepartment: order.sales_department,
            deliveryMethod: order.delivery_method,
            returnOrderNo: order.return_order_no,
            
            // é‡‘é¢ä¿¡æ¯
            orderCurrency: order.order_currency,
            currentExchangeRate: order.current_exchange_rate,
            taxRate: order.tax_rate,
            totalAmountExcludingTax: order.total_amount_excluding_tax,
            totalAmountIncludingTax: order.total_amount_including_tax,
            totalAmount: order.total_amount,
            
            // é™„ä»¶å’Œè¯´æ˜
            orderAttachment: order.order_attachment,
            orderNotes: order.order_notes,
            
            // åŒ…è£…ä¿¡æ¯
            packagingMethod: order.packaging_method,
            packagingRequirements: order.packaging_requirements,
            packagingAttachment: order.packaging_attachment,
            
            // æ”¶è´§ä¿¡æ¯
            consignee: order.consignee,
            deliveryAddress: order.delivery_address,
            billRecipient: order.bill_recipient,
            billAddress: order.bill_address,
            
            // å›æ¬¾ä¿¡æ¯
            paymentMethod: order.payment_method,
            advancePaymentRatio: order.advance_payment_ratio,
            fees: order.fees,
            paymentPlan: order.payment_plan,
            totalReceivable: order.total_receivable,
            plannedPaymentDate: order.planned_payment_date,
            plannedPaymentAmount: order.planned_payment_amount,
            receivedAmount: order.received_amount || 0,
            unreceivedAmount: order.unreceived_amount || 0,
            
            // å¤‡æ³¨
            remark: order.remark,
            
            // å®Œæ•´è®¢å•æ•°æ®(ç”¨äºç¼–è¾‘å’ŒæŸ¥çœ‹)
            orderDetail: order
          })
        })
      })
      
      tableData.value = expandedRows
      totalCount.value = response.data.data.total
      console.log('âœ… ä»åç«¯åŠ è½½è®¢å•:', orders.length, 'ä¸ªï¼Œå±•å¼€ä¸º', expandedRows.length, 'è¡Œ')
      
      // âœ… äº§å‡ºå·¥åºç›´æ¥ä»æ•°æ®åº“è¯»å–ï¼Œæ— éœ€lookup
    }
  } catch (error) {
    console.error('âŒ åŠ è½½è®¢å•å¤±è´¥:', error)
    ElMessage.error('åŠ è½½è®¢å•æ•°æ®å¤±è´¥')
  }
}

const handleCreateSuccess = async (orderData) => {
  createDialogVisible.value = false
  ElMessage.success('è®¢å•åˆ›å»ºæˆåŠŸï¼')
  await loadOrders() // é‡æ–°åŠ è½½æ•°æ®
}

// âŒ å·²åºŸå¼ƒï¼šlookupäº§å‡ºå·¥åºåŠŸèƒ½ï¼ˆç°åœ¨ç›´æ¥ä»æ•°æ®åº“è¯»å–ï¼‰
// äº§å‡ºå·¥åºåœ¨æ–°å¢è®¢å•æ—¶å·²ç»é€šè¿‡äº§å“æ‰‹å†Œlookupå¹¶ä¿å­˜åˆ°æ•°æ®åº“
// è®¢å•åˆ—è¡¨ç›´æ¥è¯»å–æ•°æ®åº“ä¸­çš„output_processå­—æ®µï¼Œæ— éœ€å†æ¬¡lookup
const lookupOutputProcess_DEPRECATED = async () => {
  try {
    console.log('âš ï¸ æ­¤å‡½æ•°å·²åºŸå¼ƒï¼Œäº§å‡ºå·¥åºç›´æ¥ä»æ•°æ®åº“è¯»å–')
    
    // åŠ è½½ç‰©æ–™æ•°æ®ï¼ˆå¦‚æœè¿˜æ²¡æœ‰åŠ è½½ï¼‰
    if (materialDataMap.value.size === 0) {
      console.log('ğŸ“¥ æ­£åœ¨åŠ è½½ç‰©æ–™æ•°æ®...')
      const materials = await materialApiService.getAllMaterials()
      console.log('ğŸ“¦ è·å–åˆ°ç‰©æ–™æ•°æ®:', materials?.length || 0, 'æ¡')
      
      if (materials && Array.isArray(materials)) {
        materials.forEach(material => {
          materialDataMap.value.set(material.materialCode, {
            materialCode: material.materialCode,
            materialName: material.materialName,
            outputProcessName: material.outputProcessName || '' // äº§å‡ºå·¥åºåç§°
          })
          
          // æ‰“å°å‰3æ¡ç‰©æ–™æ•°æ®ä¾›æ£€æŸ¥
          if (materialDataMap.value.size <= 3) {
            console.log(`  ç‰©æ–™æ ·æœ¬: ${material.materialCode} -> ${material.outputProcessName || '(æ— äº§å‡ºå·¥åº)'}`,)
          }
        })
        console.log('ğŸ’¾ ç‰©æ–™æ•°æ®åŠ è½½å®Œæˆ:', materialDataMap.value.size, 'æ¡')
      } else {
        console.warn('âš ï¸ ç‰©æ–™æ•°æ®ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯')
      }
    } else {
      console.log('âœ… ç‰©æ–™æ•°æ®å·²ç¼“å­˜:', materialDataMap.value.size, 'æ¡')
    }
    
    console.log('ğŸ”„ å¼€å§‹éå†è®¢å•è¿›è¡Œlookup...')
    let matchCount = 0
    let processedCount = 0
    
    // å¯¹æ¯ä¸ªè®¢å•è¿›è¡Œlookup
    tableData.value.forEach((order, index) => {
      console.log(`\nğŸ“‹ è®¢å•[${index}]:`, {
        internalOrderNo: order.internalOrderNo,
        productCode: order.productCode,
        currentOutputProcess: order.outputProcess
      })
      
      // åªå¤„ç†ï¼š1) æœ‰å†…éƒ¨è®¢å•ç¼–å·  2) æ²¡æœ‰äº§å‡ºå·¥åº  3) æœ‰äº§å“ç¼–å·
      if (order.internalOrderNo && !order.outputProcess && order.productCode) {
        processedCount++
        const material = materialDataMap.value.get(order.productCode)
        
        console.log(`  ğŸ” æŸ¥æ‰¾ç‰©æ–™ ${order.productCode}:`, material ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°')
        
        if (material) {
          console.log(`    ç‰©æ–™ä¿¡æ¯:`, {
            materialCode: material.materialCode,
            materialName: material.materialName,
            outputProcessName: material.outputProcessName
          })
          
          if (material.outputProcessName) {
            order.outputProcess = material.outputProcessName
            matchCount++
            console.log(`    âœ… lookupæˆåŠŸ: è®¢å• ${order.internalOrderNo}, äº§å“ ${order.productCode} -> äº§å‡ºå·¥åº: ${material.outputProcessName}`)
          } else {
            console.log(`    âš ï¸ ç‰©æ–™æ²¡æœ‰äº§å‡ºå·¥åºåç§°`)
          }
        } else {
          console.log(`    âŒ ç‰©æ–™åº“ä¸­æœªæ‰¾åˆ°äº§å“ç¼–ç : ${order.productCode}`)
        }
      } else {
        const reasons = []
        if (!order.internalOrderNo) reasons.push('æ— å†…éƒ¨è®¢å•ç¼–å·')
        if (order.outputProcess) reasons.push('å·²æœ‰äº§å‡ºå·¥åº')
        if (!order.productCode) reasons.push('æ— äº§å“ç¼–å·')
        console.log(`  â­ï¸ è·³è¿‡: ${reasons.join(', ')}`)
      }
    })
    
    console.log(`\nâœ… lookupå®Œæˆ: å¤„ç† ${processedCount} ä¸ªè®¢å•ï¼ŒæˆåŠŸåŒ¹é… ${matchCount} ä¸ª`)
  } catch (error) {
    console.error('âŒ lookupäº§å‡ºå·¥åºå¤±è´¥:', error)
  }
}

const handleManualTerminate = async () => {
  try {
    await ElMessageBox.confirm(`ç¡®å®šè¦ç»ˆæ­¢é€‰ä¸­çš„ ${selectedRows.value.length} ä¸ªè®¢å•å—ï¼Ÿ`, 'æç¤º', {
      confirmButtonText: 'ç¡®å®š',
      cancelButtonText: 'å–æ¶ˆ',
      type: 'warning'
    })
    
    // æ›´æ–°è®¢å•çŠ¶æ€ä¸ºæ‰‹åŠ¨ç»ˆæ­¢
    selectedRows.value.forEach(row => {
      const order = tableData.value.find(o => o.id === row.id)
      if (order) {
        order.orderStatus = 'æ‰‹åŠ¨ç»ˆæ­¢'
      }
    })
    
    selectedRows.value = []
    ElMessage.success('è®¢å•å·²æ‰‹åŠ¨ç»ˆæ­¢')
  } catch {}
}

const handleDraft = () => {
  ElMessage.info('æ‰“å¼€è‰ç¨¿ç®±')
}

const handleDelete = async () => {
  try {
    await ElMessageBox.confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedRows.value.length} ä¸ªè®¢å•å—ï¼Ÿ`, 'æç¤º', {
      confirmButtonText: 'ç¡®å®š',
      cancelButtonText: 'å–æ¶ˆ',
      type: 'warning'
    })
    
    const ids = selectedRows.value.map(row => row.id)
    const response = await salesOrderApi.batchDeleteSalesOrders(ids)
    
    if (response.data.success) {
      selectedRows.value = []
      ElMessage.success('åˆ é™¤æˆåŠŸ')
      await loadOrders()
    }
  } catch (error) {
    if (error !== 'cancel') {
      ElMessage.error('åˆ é™¤å¤±è´¥')
    }
  }
}

const handleDeleteRow = async (row) => {
  try {
    await ElMessageBox.confirm(`ç¡®å®šè¦åˆ é™¤è®¢å•"${row.internalOrderNo}"å—ï¼Ÿ`, 'æç¤º', {
      confirmButtonText: 'ç¡®å®š',
      cancelButtonText: 'å–æ¶ˆ',
      type: 'warning'
    })
    
    const response = await salesOrderApi.deleteSalesOrder(row.id)
    if (response.data.success) {
      ElMessage.success('åˆ é™¤æˆåŠŸ')
      await loadOrders()
    }
  } catch (error) {
    if (error !== 'cancel') {
      ElMessage.error('åˆ é™¤å¤±è´¥')
    }
  }
}

const handleEdit = async (row) => {
  try {
    // ä»åç«¯é‡æ–°è·å–å®Œæ•´æ•°æ®
    const response = await salesOrderApi.getSalesOrderById(row.id)
    if (response.data && response.data.success) {
      currentOrder.value = response.data.data
      editDialogVisible.value = true
    } else {
      ElMessage.error('è·å–è®¢å•è¯¦æƒ…å¤±è´¥')
    }
  } catch (error) {
    console.error('âŒ è·å–è®¢å•è¯¦æƒ…å¤±è´¥:', error)
    ElMessage.error('è·å–è®¢å•è¯¦æƒ…å¤±è´¥')
  }
}

const handleEditSuccess = (orderData) => {
  const index = tableData.value.findIndex(o => o.id === orderData.id)
  if (index !== -1) {
    tableData.value[index] = {
      ...orderData,
      updateTime: new Date().toLocaleString('zh-CN')
    }
  }
  editDialogVisible.value = false
  ElMessage.success('è®¢å•æ›´æ–°æˆåŠŸ')
}

const handleView = async (row) => {
  // ç›´æ¥ä¼ é€’è®¢å•ID,ç”±æŸ¥çœ‹ç»„ä»¶è‡ªè¡ŒåŠ è½½
  currentOrder.value = { id: row.id }
  viewDialogVisible.value = true
}

const handleFieldManagement = () => {
  fieldManagementVisible.value = true
}

const handleImport = () => {
  importDialogVisible.value = true
}

const handleFileChange = (file) => {
  console.log('é€‰æ‹©æ–‡ä»¶:', file)
}

const handleImportConfirm = () => {
  ElMessage.success('å¯¼å…¥æˆåŠŸ')
  importDialogVisible.value = false
}

const handleExport = () => {
  // å¯¼å‡ºå½“å‰ç­›é€‰çš„æ•°æ®
  const dataToExport = filteredTableData.value
  
  // æ¨¡æ‹ŸCSVå¯¼å‡ºï¼ˆå®é™…é¡¹ç›®ä¸­å¯ä½¿ç”¨xlsxåº“ï¼‰
  let csvContent = 'è®¢å•çŠ¶æ€,å†…éƒ¨è®¢å•ç¼–å·,å®¢æˆ·è®¢å•ç¼–å·,å®¢æˆ·åç§°,é”€å”®å‘˜\n'
  dataToExport.forEach(row => {
    csvContent += `${row.orderStatus},${row.internalOrderNo},${row.customerOrderNo},${row.customerName},${row.salesperson}\n`
  })
  
  // åˆ›å»ºä¸‹è½½é“¾æ¥
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' })
  const link = document.createElement('a')
  link.href = URL.createObjectURL(blob)
  link.download = `é”€å”®è®¢å•_${new Date().getTime()}.csv`
  link.click()
  
  ElMessage.success(`å¯¼å‡ºæˆåŠŸï¼Œå…± ${dataToExport.length} æ¡è®°å½•`)
}

const handleRefresh = async () => {
  await loadOrders()
  ElMessage.success('åˆ·æ–°æˆåŠŸ')
}

// æ­£å¼ä¸‹å•
const canConfirmOrder = computed(() => {
  const result = selectedRows.value.length > 0 && 
    selectedRows.value.every(order => 
      order.orderStatus === 'å¾…ä¸‹å•' || order.orderStatus === 'å·²æ¨¡æ‹Ÿæ’ç¨‹å¾…ä¸‹å•'
    )
  console.log('ğŸ” æ­£å¼ä¸‹å•æŒ‰é’®çŠ¶æ€:', {
    é€‰ä¸­è®¢å•æ•°: selectedRows.value.length,
    è®¢å•çŠ¶æ€: selectedRows.value.map(o => ({ ç¼–å·: o.internalOrderNo, çŠ¶æ€: o.orderStatus })),
    æŒ‰é’®å¯ç”¨: result
  })
  return result
})

const handleConfirmOrder = async () => {
  console.log('ğŸ“‹ ç‚¹å‡»æ­£å¼ä¸‹å•æŒ‰é’®ï¼Œé€‰ä¸­è®¢å•:', selectedRows.value)
  
  // æ£€æŸ¥æ˜¯å¦é€‰ä¸­è®¢å•
  if (selectedRows.value.length === 0) {
    ElMessage.warning('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªé”€å”®è®¢å•')
    return
  }

  try {
    await ElMessageBox.confirm(
      `ç¡®å®šè¦å¯¹é€‰ä¸­çš„ ${selectedRows.value.length} ä¸ªè®¢å•æ‰§è¡Œæ­£å¼ä¸‹å•å—ï¼Ÿ\n\næ­£å¼ä¸‹å•åå°†è‡ªåŠ¨åˆ›å»ºä¸»ç”Ÿäº§è®¡åˆ’ã€‚`,
      'æ­£å¼ä¸‹å•ç¡®è®¤',
      {
        confirmButtonText: 'ç¡®å®š',
        cancelButtonText: 'å–æ¶ˆ',
        type: 'success'
      }
    )
  } catch (error) {
    return // ç”¨æˆ·å–æ¶ˆ
  }

  const loading = ElLoading.service({
    lock: true,
    text: 'æ­£åœ¨åˆ›å»ºä¸»ç”Ÿäº§è®¡åˆ’...',
    background: 'rgba(0, 0, 0, 0.7)'
  })

  try {
    console.log('ğŸ“‹ å¼€å§‹æ­£å¼ä¸‹å•æµç¨‹ï¼Œé€‰ä¸­è®¢å•æ•°:', selectedRows.value.length)
    
    // âš ï¸ é‡è¦ï¼šè®¢å•åˆ—è¡¨æ˜¯æŒ‰äº§å“å±•å¼€çš„ï¼Œéœ€è¦å…ˆæŒ‰è®¢å•IDå»é‡ï¼Œæ”¶é›†åŒä¸€è®¢å•çš„æ‰€æœ‰äº§å“
    const orderMap = new Map()
    
    selectedRows.value.forEach(row => {
      const orderId = row.id
      
      if (!orderMap.has(orderId)) {
        // ç¬¬ä¸€æ¬¡é‡åˆ°è¿™ä¸ªè®¢å•ï¼Œåˆå§‹åŒ–è®¢å•æ•°æ®
        orderMap.set(orderId, {
          id: orderId,
          internalOrderNo: row.internalOrderNo,
          customerOrderNo: row.customerOrderNo,
          salesperson: row.salesperson,
          customerDeliveryDate: row.customerDelivery,
          promisedDeliveryDate: row.promisedDelivery,
          products: []
        })
      }
      
      // æ·»åŠ å½“å‰äº§å“åˆ°è®¢å•çš„äº§å“åˆ—è¡¨
      if (row.productCode) {
        orderMap.get(orderId).products.push({
          productCode: row.productCode,
          productName: row.productName,
          orderQuantity: row.orderQuantity,
          productUnit: row.productUnit,
          productImage: row.productImage,
          outputProcess: row.outputProcess || ''
        })
      }
    })
    
    // è½¬æ¢ä¸ºMapæ•°ç»„
    const salesOrders = Array.from(orderMap.values())
    
    console.log('ğŸ“¦ æ•´ç†åçš„è®¢å•æ•°æ®:', salesOrders.map(o => ({
      internalOrderNo: o.internalOrderNo,
      äº§å“æ•°é‡: o.products.length,
      äº§å“ç¼–ç : o.products.map(p => p.productCode)
    })))
    
    console.log('ğŸ“¦ æ„é€ çš„é”€å”®è®¢å•æ•°æ®:', salesOrders)
    
    // âœ… è·å–æå‰å…¥åº“æœŸè®¾ç½®
    const advanceStorageDays = settings.value.advanceStorageDays || 0;
    console.log('ğŸ“… æå‰å…¥åº“æœŸ:', advanceStorageDays, 'å¤©');
    
    // è°ƒç”¨åç«¯APIåˆ›å»ºä¸»ç”Ÿäº§è®¡åˆ’
    const response = await fetch('http://192.168.2.229:3005/api/master-production-plans/from-sales-order', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ 
        salesOrders,
        advanceStorageDays // âœ… ä¼ é€’æå‰å…¥åº“æœŸ
      })
    })
    
    const result = await response.json()
    
    if (result.code === 200) {
      console.log('âœ… ä¸»ç”Ÿäº§è®¡åˆ’åˆ›å»ºæˆåŠŸ:', result.data)
      
      // æ›´æ–°è®¢å•çŠ¶æ€ä¸º"å·²ä¸‹å•"
      for (const order of selectedRows.value) {
        await salesOrderApi.updateSalesOrder(order.id, {
          status: 'å·²ä¸‹å•'
        })
      }
      
      ElMessage.success(`å·²æˆåŠŸä¸‹å• ${selectedRows.value.length} ä¸ªè®¢å•ï¼Œåˆ›å»ºäº† ${result.data.length} æ¡ä¸»ç”Ÿäº§è®¡åˆ’`)
      
      // åˆ·æ–°è®¢å•åˆ—è¡¨
      await loadOrders()
      
      // æ¸…ç©ºé€‰æ‹©
      selectedRows.value = []
    } else {
      throw new Error(result.message || 'åˆ›å»ºä¸»ç”Ÿäº§è®¡åˆ’å¤±è´¥')
    }
    
  } catch (error) {
    console.error('âŒ æ­£å¼ä¸‹å•å¤±è´¥:', error)
    ElMessage.error(`ä¸‹å•å¤±è´¥: ${error.message || 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥'}`)
  } finally {
    loading.close()
  }
}

// MRPè¿ç®—æŒ‰é’®å¯ç”¨æ¡ä»¶
const canExecuteMRP = computed(() => {
  if (selectedRows.value.length !== 1) return false
  const order = selectedRows.value[0]
  return order.orderStatus === 'å¾…ä¸‹å•' || order.orderStatus === 'æ¨¡æ‹Ÿæ’ç¨‹å¤±æ•ˆ'
})

// MRPè¿ç®—
const mrpDialogVisible = ref(false)
const mrpCalculating = ref(false)
const mrpResult = ref(null)

const handleMRPCalculation = async () => {
  if (!canExecuteMRP.value) {
    if (selectedRows.value.length === 0) {
      ElMessage.warning('è¯·é€‰æ‹©è¦è¿›è¡ŒMRPè¿ç®—çš„è®¢å•')
    } else if (selectedRows.value.length > 1) {
      ElMessage.warning('MRPè¿ç®—åªèƒ½é€‰æ‹©ä¸€ä¸ªè®¢å•')
    } else {
      ElMessage.warning('è¯·é€‰æ‹©çŠ¶æ€ä¸ºâ€œå¾…ä¸‹å•â€æˆ–â€œæ¨¡æ‹Ÿæ’ç¨‹å¤±æ•ˆâ€çš„è®¢å•')
    }
    return
  }

  // ç¡®è®¤å¯¹è¯æ¡†
  try {
    await ElMessageBox.confirm(
      `ç¡®å®šè¦å¯¹è®¢å•ã€Š${selectedRows.value[0].internalOrderNo}ã€‹æ‰§è¡ŒMRPè¿ç®—å—ï¼Ÿ<br/><br/>` +
      `<span style="color: #909399;">è¿ç®—å°†æ ¹æ®ç”Ÿäº§BOMè®¡ç®—æ¯ä¸ªåŠæˆå“ã€æˆå“çš„ç”Ÿäº§éœ€æ±‚å’Œé‡‡è´­éœ€æ±‚ï¼Œå¹¶å°†ç»“æœä¿å­˜åˆ°ç‰©æ–™éœ€æ±‚æ˜ç»†</span>`,
      'MRPè¿ç®—ç¡®è®¤',
      {
        dangerouslyUseHTMLString: true,
        confirmButtonText: 'å¼€å§‹è¿ç®—',
        cancelButtonText: 'å–æ¶ˆ',
        type: 'info'
      }
    )
  } catch (error) {
    return // ç”¨æˆ·å–æ¶ˆ
  }

  mrpCalculating.value = true
  mrpDialogVisible.value = true
  mrpResult.value = null

  try {
    const orderIds = selectedRows.value.map(order => order.id)
    console.log('å¼€å§‹MRPè¿ç®—ï¼Œè®¢å•IDs:', orderIds)

    const response = await mrpAPI.calculate(orderIds)
    
    if (response.code === 200) {
      mrpResult.value = response.data
      console.log('MRPè¿ç®—ç»“æœ:', mrpResult.value)
      
      // TODO: å°†MRPè¿ç®—ç»“æœä¿å­˜åˆ°ç‰©æ–™éœ€æ±‚æ˜ç»†è¡¨
      // è¿™é‡Œéœ€è¦è°ƒç”¨ç‰©æ–™éœ€æ±‚æ˜ç»†çš„APIæ¥ä¿å­˜æ•°æ®
      
      ElMessage.success('MRPè¿ç®—å®Œæˆï¼Œç»“æœå·²ä¿å­˜åˆ°ç‰©æ–™éœ€æ±‚æ˜ç»†')
    } else {
      throw new Error(response.message || 'MRPè¿ç®—å¤±è´¥')
    }
  } catch (error) {
    console.error('MRPè¿ç®—é”™è¯¯:', error)
    ElMessage.error(`MRPè¿ç®—å¤±è´¥: ${error.message || 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥'}`)
    mrpDialogVisible.value = false
  } finally {
    mrpCalculating.value = false
  }
}

const closeMRPDialog = () => {
  mrpDialogVisible.value = false
  mrpResult.value = null
}

const handleChange = () => {
  ElMessage.info('å˜æ›´åŠŸèƒ½')
}

const handlePrint = () => {
  window.print()
}

const handlePause = () => {
  ElMessage.info('æš‚åœåŠŸèƒ½')
}

const handleSettings = () => {
  settingsVisible.value = true
}

const handleSaveSettings = () => {
  // ä¿å­˜è®¾ç½®åˆ°localStorage
  localStorage.setItem('salesOrderSettings', JSON.stringify(settings.value))
  
  // åŒæ­¥ä¿å­˜åˆ°ä¸šåŠ¡è®¾ç½®æœåŠ¡
  import('@/services/businessSettingsService.js').then(({ updateModuleSettings }) => {
    updateModuleSettings('scheduling', {
      simulationExpireDays: settings.value.simulationExpireDays
    })
    updateModuleSettings('order', {
      defaultCurrency: settings.value.defaultCurrency,
      defaultExchangeRate: settings.value.defaultExchangeRate,
      defaultTaxRate: settings.value.defaultTaxRate,
      defaultPaymentMethod: settings.value.defaultPaymentMethod,
      defaultDeliveryMethod: settings.value.defaultDeliveryMethod
    })
  })
  
  ElMessage.success('è®¾ç½®å·²ä¿å­˜')
  settingsVisible.value = false
  // åº”ç”¨è®¾ç½®
  applySettings()
}

const handleSaveFieldSettings = () => {
  localStorage.setItem('salesOrderVisibleFields', JSON.stringify(visibleFields.value))
  ElMessage.success('å­—æ®µè®¾ç½®å·²ä¿å­˜')
  fieldManagementVisible.value = false
}

const applySettings = () => {
  // åº”ç”¨ä¸»é¢˜è‰²
  document.documentElement.style.setProperty('--el-color-primary', settings.value.themeColor)
  // åº”ç”¨èƒŒæ™¯è‰²
  const container = document.querySelector('.sales-order-list-container')
  if (container) {
    container.style.backgroundColor = settings.value.backgroundColor
  }
}

// ğŸ”€ å•å…ƒæ ¼åˆå¹¶æ–¹æ³•ï¼šåˆå¹¶åŒä¸€è®¢å•çš„ä¸»å­—æ®µ
const spanMethod = ({ row, column, rowIndex, columnIndex }) => {
  // éœ€è¦åˆå¹¶çš„åˆ—ï¼šå‹¾é€‰æ¡†ã€å†…éƒ¨è®¢å•ç¼–å·ã€å®¢æˆ·è®¢å•ç¼–å·ã€å®¢æˆ·äº¤æœŸç­‰ä¸»è®¢å•å­—æ®µ
  const mergeColumns = [
    'internalOrderNo',
    'customerOrderNo', 
    'customerName',
    'salesperson',
    'quotationNo',              // æŠ¥ä»·å•å·
    'orderType',
    'orderStatus',
    'orderTime',
    'customerDelivery',
    'promisedDelivery',
    'estimatedCompletionDate',  // é¢„è®¡å®Œæˆæ—¥æœŸ
    'createTime',
    'returnOrderNo',            // é”€å”®é€€è´§å•å·
    'deliveryMethod',           // é€è´§æ–¹å¼
    'orderCurrency',            // è®¢å•å¸ç§
    'currentExchangeRate',      // å½“å‰æ±‡ç‡
    'taxRate',                  // ç¨ç‡
    'orderAttachment',          // è®¢å•é™„ä»¶
    'orderNotes',               // è®¢å•è¯´æ˜
    'totalAmountExcludingTax',  // è®¢å•æ€»é‡‘é¢ï¼ˆæœªç¨ï¼‰
    'totalAmountIncludingTax',  // è®¢å•æ€»é‡‘é¢ï¼ˆå«ç¨ï¼‰
    'totalAmount',              // è®¢å•æ€»é‡‘é¢
    'packagingMethod',          // åŒ…è£…æ–¹å¼
    'packagingRequirements',    // åŒ…è£…éœ€æ±‚æè¿°
    'packagingAttachment',      // åŒ…è£…é™„ä»¶
    'consignee',                // æ”¶è´§äºº
    'deliveryAddress',          // æ”¶è´§åœ°å€
    'billRecipient',            // è´¦å•æ”¶ä»¶äºº
    'billAddress',              // è´¦å•æ”¶ä»¶åœ°å€
    'paymentMethod',            // æ”¶æ¬¾æ–¹å¼
    'advancePaymentRatio',      // é¢„æ”¶å æ¯”
    'fees',                     // æ‰‹ç»­è´¹æˆ–å…¶ä»–è´¹ç”¨
    'paymentPlan',              // å›æ¬¾è®¡åˆ’
    'totalReceivable',          // åº”å›æ¬¾æ€»é¢
    'plannedPaymentDate',       // è®¡åˆ’å›æ¬¾æ—¥æœŸ
    'plannedPaymentAmount'      // è®¡åˆ’å›æ¬¾é‡‘é¢
  ]
  
  const columnProp = column.property
  const columnType = column.type
  const columnLabel = column.label
  
  // å¤„ç†å‹¾é€‰æ¡†åˆ— (type='selection')
  if (columnType === 'selection') {
    if (row.productIndex === 0) {
      return {
        rowspan: row.productCount, // åˆå¹¶çš„è¡Œæ•°=è¯¥è®¢å•çš„äº§å“æ€»æ•°
        colspan: 1
      }
    } else {
      // éç¬¬ä¸€è¡Œï¼Œéšè—è¯¥å•å…ƒæ ¼
      return {
        rowspan: 0,
        colspan: 0
      }
    }
  }
  
  // å¤„ç†æ“ä½œåˆ— (label='æ“ä½œ')
  if (columnLabel === 'æ“ä½œ') {
    if (row.productIndex === 0) {
      return {
        rowspan: row.productCount, // åˆå¹¶çš„è¡Œæ•°=è¯¥è®¢å•çš„äº§å“æ€»æ•°
        colspan: 1
      }
    } else {
      // éç¬¬ä¸€è¡Œï¼Œéšè—è¯¥å•å…ƒæ ¼
      return {
        rowspan: 0,
        colspan: 0
      }
    }
  }
  
  // å¤„ç†å…¶ä»–éœ€è¦åˆå¹¶çš„åˆ—
  if (mergeColumns.includes(columnProp)) {
    // å¦‚æœæ˜¯è¯¥è®¢å•çš„ç¬¬ä¸€ä¸ªäº§å“è¡Œï¼Œåˆå¹¶å•å…ƒæ ¼
    if (row.productIndex === 0) {
      return {
        rowspan: row.productCount, // åˆå¹¶çš„è¡Œæ•°=è¯¥è®¢å•çš„äº§å“æ€»æ•°
        colspan: 1
      }
    } else {
      // éç¬¬ä¸€è¡Œï¼Œéšè—è¯¥å•å…ƒæ ¼
      return {
        rowspan: 0,
        colspan: 0
      }
    }
  }
  
  // å…¶ä»–åˆ—ä¸åˆå¹¶
  return {
    rowspan: 1,
    colspan: 1
  }
}

// æ¨¡æ‹Ÿæ’ç¨‹
const handleSimulateScheduling = async (row) => {
  try {
    // æ˜¾ç¤ºæ¨¡æ‹Ÿæ’ç¨‹è¯´æ˜
    await ElMessageBox.confirm(
      'æ¨¡æ‹Ÿæ’ç¨‹è®¡ç®—æœŸé—´ä¸è€ƒè™‘åŒæ—¶æœŸæ¨¡æ‹Ÿæ’ç¨‹çš„è®¢å•ï¼Œåªè€ƒè™‘å·²ç¡®è®¤ä¸‹å•çš„è®¢å•ã€‚å¦‚æœ‰éœ€è¦è¯·è”ç³»å¼€å‘å‘˜å¢åŠ è€ƒè™‘å…¶ä»–æ¨¡æ‹Ÿæ’ç¨‹æ¨¡å¼ã€‚',
      'æ¨¡æ‹Ÿæ’ç¨‹è¯´æ˜',
      {
        confirmButtonText: 'å¼€å§‹æ¨¡æ‹Ÿæ’ç¨‹',
        cancelButtonText: 'å–æ¶ˆ',
        type: 'info',
        dangerouslyUseHTMLString: true
      }
    )

    simulatingOrderId.value = row.id
    ElMessage.loading('æ­£åœ¨æ¨¡æ‹Ÿæ’ç¨‹ï¼Œè¯·ç¨å€™...')

    // è°ƒç”¨æ¨¡æ‹Ÿæ’ç¨‹æœåŠ¡
    const { simulateScheduling } = await import('@/services/schedulingSimulationService.js')
    const result = await simulateScheduling({
      orderId: row.id,
      orderData: row,
      excludeSimulatedOrders: true // ä¸è€ƒè™‘å…¶ä»–æ¨¡æ‹Ÿæ’ç¨‹è®¢å•
    })

    if (result.success) {
      // æ›´æ–°è®¢å•çŠ¶æ€
      row.orderStatus = 'å·²æ¨¡æ‹Ÿæ’ç¨‹å¾…ä¸‹å•'
      row.estimatedCompletionDate = result.estimatedCompletionDate
      row.simulationDate = new Date().toLocaleString('zh-CN')

      // æ·»åŠ åˆ°å·²æ¨¡æ‹Ÿåˆ—è¡¨
      if (!simulatedOrders.value.find(o => o.id === row.id)) {
        simulatedOrders.value.push({
          id: row.id,
          orderNo: row.internalOrderNo,
          simulationDate: row.simulationDate,
          estimatedCompletionDate: row.estimatedCompletionDate
        })
      }

      // ä¿å­˜åˆ°æ•°æ®åº“
      await salesOrderApi.updateSalesOrder(row.id, {
        status: 'å·²æ¨¡æ‹Ÿæ’ç¨‹å¾…ä¸‹å•',
        estimated_completion_date: result.estimatedCompletionDate,
        simulation_result: JSON.stringify(result)
      })

      ElMessage.success(
        `æ¨¡æ‹Ÿæ’ç¨‹å®Œæˆï¼é¢„è®¡å®Œæˆæ—¥æœŸï¼š${result.estimatedCompletionDate}\n` +
        `å½“å‰æœ‰ ${simulatedOrders.value.length} ä¸ªæ¨¡æ‹Ÿæ’ç¨‹è®¢å•å¾…ä¸‹å•`
      )
    } else {
      ElMessage.error(`æ¨¡æ‹Ÿæ’ç¨‹å¤±è´¥ï¼š${result.message}`)
    }
  } catch (error) {
    if (error !== 'cancel') {
      console.error('æ¨¡æ‹Ÿæ’ç¨‹é”™è¯¯:', error)
      ElMessage.error('æ¨¡æ‹Ÿæ’ç¨‹å¤±è´¥')
    }
  } finally {
    simulatingOrderId.value = null
  }
}
// ç”Ÿå‘½å‘¨æœŸ
onMounted(async () => {
  // åŠ è½½è®¢å•æ•°æ®
  await loadOrders()
  
  // åŠ è½½ä¿å­˜çš„è®¾ç½®
  const savedSettings = localStorage.getItem('salesOrderSettings')
  if (savedSettings) {
    settings.value = JSON.parse(savedSettings)
    applySettings()
  }
  
  // åŠ è½½å­—æ®µè®¾ç½®
  const savedFields = localStorage.getItem('salesOrderVisibleFields')
  if (savedFields) {
    visibleFields.value = JSON.parse(savedFields)
  } else {
    visibleFields.value = allFields.value.map(f => f.prop)
  }
  
  // è®¡ç®—è¡¨æ ¼é«˜åº¦
  const updateTableHeight = () => {
    const windowHeight = window.innerHeight
    tableHeight.value = windowHeight - 300
  }
  updateTableHeight()
  window.addEventListener('resize', updateTableHeight)
})
</script>

<style scoped>
.sales-order-list-container {
  padding: 20px;
  background-color: #f5f7fa;
  min-height: 100vh;
}

.toolbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding: 15px 20px;
  background: white;
  border-radius: 4px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.toolbar-left h2 {
  margin: 0;
  font-size: 20px;
  color: #303133;
}

.toolbar-right {
  display: flex;
  gap: 10px;
}

.search-area {
  margin-bottom: 20px;
  padding: 15px 20px;
  background: white;
  border-radius: 4px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.table-container {
  background: white;
  padding: 20px;
  border-radius: 4px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.pagination-container {
  margin-top: 20px;
  display: flex;
  justify-content: flex-end;
  padding: 15px 20px;
  background: white;
  border-radius: 4px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* æ‰“å°æ ·å¼ */
@media print {
  .toolbar,
  .search-area,
  .pagination-container {
    display: none;
  }
}
</style>
