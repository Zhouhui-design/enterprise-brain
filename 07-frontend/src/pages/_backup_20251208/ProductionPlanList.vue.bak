<template>
  <div class="production-plan-list">
    <div class="header">
      <el-page-header :title="'ç”Ÿäº§è®¡åˆ’ç®¡ç†'" :content="'ç”Ÿäº§è®¡åˆ’åˆ—è¡¨'" />
      <div class="header-actions">
        <el-button type="primary" @click="handleCreatePlan">åˆ›å»ºç”Ÿäº§è®¡åˆ’</el-button>
        <el-button @click="settingsVisible = true" circle>
          <el-icon><Setting /></el-icon>
        </el-button>
      </div>
    </div>

    <el-card class="search-card">
      <el-form :inline="true" :model="searchForm" class="search-form">
        <el-form-item label="ä¸»ç”Ÿäº§è®¡åˆ’ç¼–å·">
          <el-input v-model="searchForm.planCode" placeholder="è¯·è¾“å…¥ä¸»ç”Ÿäº§è®¡åˆ’ç¼–å·" clearable />
        </el-form-item>
        <el-form-item label="äº§å“ç¼–å·">
          <el-input v-model="searchForm.productCode" placeholder="è¯·è¾“å…¥äº§å“ç¼–å·" clearable />
        </el-form-item>
        <el-form-item label="äº§å“åç§°">
          <el-input v-model="searchForm.productName" placeholder="è¯·è¾“å…¥äº§å“åç§°" clearable />
        </el-form-item>
        <el-form-item label="è¿›åº¦çŠ¶æ€">
          <el-select v-model="searchForm.status" placeholder="è¯·é€‰æ‹©çŠ¶æ€" clearable>
            <el-option label="æœªå¼€å§‹" value="0" />
            <el-option label="è¿›è¡Œä¸­" value="1" />
            <el-option label="å·²å®Œæˆ" value="2" />
            <el-option label="å·²æš‚åœ" value="3" />
          </el-select>
        </el-form-item>
        <el-form-item>
          <el-button type="primary" @click="handleSearch">æŸ¥è¯¢</el-button>
          <el-button @click="handleReset">é‡ç½®</el-button>
        </el-form-item>
      </el-form>
    </el-card>

    <el-card class="data-card">
      <div class="table-header">
        <span>ç”Ÿäº§è®¡åˆ’åˆ—è¡¨</span>
        <div class="batch-actions">
          <el-button type="success" :disabled="selectedPlans.length !== 1" @click="handleExecuteSchedule">
            <el-icon><Operation /></el-icon>
            æ‰§è¡Œæ’ç¨‹
          </el-button>
        </div>
      </div>
      <!-- ä½¿ç”¨EnhancedTableé€šç”¨è¡¨æ ¼ç»„ä»¶ -->
      <EnhancedTable
        :data="planListData"
        :columns="tableColumns"
        :loading="loading"
        :show-selection="true"
        :show-filter="true"
        :show-pagination="true"
        :show-toolbar="true"
        :show-batch-delete="true"
        :show-export="true"
        :total="total"
        :current-page="currentPage"
        :page-size="pageSize"
        @selection-change="handleSelectionChange"
        @page-change="handlePageChange"
        @size-change="handleSizeChange"
        @batch-delete="handleBatchDelete"
        @export="handleBatchExport"
      >
        <!-- äº§å“å›¾ç‰‡åˆ— -->
        <template #productImage="{ row }">
          <el-image
            v-if="row.productImage"
            :src="row.productImage"
            :preview-src-list="[row.productImage]"
            fit="cover"
            style="width: 50px; height: 50px; border-radius: 4px;"
          />
          <span v-else style="color: #999;">æ— å›¾ç‰‡</span>
        </template>
        
        <!-- è¿›åº¦çŠ¶æ€åˆ— -->
        <template #status="{ row }">
          <el-tag :type="statusType[row.status]">
            {{ statusText[row.status] || 'æœªçŸ¥' }}
          </el-tag>
        </template>
        
        <!-- æ“ä½œåˆ— -->
        <template #operation="{ row }">
          <el-button size="small" @click="handleViewDetail(row)">æŸ¥çœ‹è¯¦æƒ…</el-button>
          <el-button size="small" type="primary" @click="handleEditPlan(row)">ç¼–è¾‘</el-button>
          <el-button size="small" type="danger" @click="handleDeletePlan(row)">åˆ é™¤</el-button>
        </template>
      </EnhancedTable>
    </el-card>

    <!-- é¡µé¢è®¾ç½®ç»„ä»¶ï¼ˆé€šç”¨ï¼‰ -->
    <PageSettings
      v-model="settingsVisible"
      settings-key="productionPlanSettings"
      :available-fields="tableColumns"
      :show-workflow="true"
      :show-menu="false"
      :show-color="false"
      :show-encoding="true"
      :show-fields="true"
      :show-print="true"
      :show-export="true"
      :show-business-vars="true"
      :default-settings="defaultSettings"
      @save="handleSettingsSave"
    />
  </div>
</template>

<script>
import EnhancedTable from '@/components/common/EnhancedTable.vue';
import PageSettings from '@/components/common/PageSettings.vue';
import { Setting, Operation } from '@element-plus/icons-vue';
import api from '@/api/masterProductionPlan';

export default {
  name: 'ProductionPlanList',
  components: {
    EnhancedTable,
    PageSettings,
    Setting,
    Operation
  },
  data() {
    return {
      loading: false,
      searchForm: {
        planCode: '',
        productCode: '',
        productName: '',
        status: '',
      },
      dateRange: [],
      planListData: [],
      selectedPlans: [],
      currentPage: 1,
      pageSize: 10,
      total: 0,
      settingsVisible: false,
      defaultSettings: {
        advanceStorageDays: 3,  // é»˜è®¤æå‰3å¤©å…¥åº“
        exportFilePrefix: 'ä¸»ç”Ÿäº§è®¡åˆ’',
        codePrefix: 'MPS'
      },
      statusText: {
        0: 'æœªå¼€å§‹',
        1: 'è¿›è¡Œä¸­',
        2: 'å·²å®Œæˆ',
        3: 'å·²æš‚åœ'
      },
      statusType: {
        0: 'info',
        1: 'primary',
        2: 'success',
        3: 'warning'
      },
      // è¡¨æ ¼åˆ—é…ç½®
      tableColumns: [
        {
          prop: 'planCode',
          label: 'ä¸»ç”Ÿäº§è®¡åˆ’ç¼–å·',
          width: 180,
          fixed: 'left',
          sortable: true,
          filterable: true
        },
        {
          prop: 'productCode',
          label: 'äº§å“ç¼–å·',
          width: 150,
          sortable: true,
          filterable: true
        },
        {
          prop: 'productName',
          label: 'äº§å“åç§°',
          width: 180,
          sortable: true,
          filterable: true
        },
        {
          prop: 'orderQuantity',
          label: 'è®¢å•æ•°é‡',
          width: 120,
          align: 'right',
          sortable: true,
          formatter: (row) => row.orderQuantity?.toLocaleString() || 0
        },
        {
          prop: 'salesperson',
          label: 'é”€å”®å‘˜',
          width: 120,
          filterable: true
        },
        {
          prop: 'salesUnit',
          label: 'é”€å”®å•ä½',
          width: 100,
          filterable: true
        },
        {
          prop: 'availableStock',
          label: 'å¯ç”¨åº“å­˜',
          width: 120,
          align: 'right',
          sortable: true,
          formatter: (row) => row.availableStock?.toLocaleString() || 0
        },
        {
          prop: 'currentStock',
          label: 'å®æ—¶åº“å­˜',
          width: 120,
          align: 'right',
          sortable: true,
          formatter: (row) => row.currentStock?.toLocaleString() || 0
        },
        {
          prop: 'planQuantity',
          label: 'è®¡åˆ’æ•°é‡',
          width: 120,
          align: 'right',
          sortable: true,
          formatter: (row) => row.planQuantity?.toLocaleString() || 0
        },
        {
          prop: 'productImage',
          label: 'äº§å“å›¾ç‰‡',
          width: 100,
          slot: 'productImage'
        },
        {
          prop: 'outputProcess',
          label: 'äº§å‡ºå·¥åº',
          width: 120,
          filterable: true,
          showOverflowTooltip: true
        },
        {
          prop: 'promisedDeliveryDate',
          label: 'è®¢å•æ‰¿è¯ºäº¤æœŸ',
          width: 120,
          sortable: true,
          formatter: (row) => formatDateYMD(row.promisedDeliveryDate)
        },
        {
          prop: 'status',
          label: 'è¿›åº¦çŠ¶æ€',
          width: 120,
          filterable: true,
          slot: 'status'
        },
        {
          prop: 'plannedStorageDate',
          label: 'è®¡åˆ’å…¥åº“æ—¥æœŸ',
          width: 120,
          sortable: true,
          formatter: (row) => formatDateYMD(row.plannedStorageDate)
        },
        {
          prop: 'productSource',
          label: 'äº§å“æ¥æº',
          width: 120,
          filterable: true
        },
        {
          prop: 'internalOrderNo',
          label: 'å†…éƒ¨é”€å”®è®¢å•ç¼–å·',
          width: 180,
          filterable: true
        },
        {
          prop: 'customerOrderNo',
          label: 'å®¢æˆ·è®¢å•ç¼–å·',
          width: 180,
          filterable: true
        },
        {
          prop: 'actions',
          label: 'æ“ä½œ',
          width: 280,
          fixed: 'right',
          slot: 'actions'
        }
      ]
    };
  },
  mounted() {
    // åŠ è½½çœŸå®æ•°æ®
    this.fetchPlanList();
  },
  methods: {
    // ä»åç«¯APIåŠ è½½ä¸»ç”Ÿäº§è®¡åˆ’åˆ—è¡¨
    async fetchPlanList() {
      this.loading = true;
      try {
        const params = {
          page: this.currentPage,
          pageSize: this.pageSize,
          ...(this.searchForm.planCode && { planCode: this.searchForm.planCode }),
          ...(this.searchForm.productCode && { productCode: this.searchForm.productCode }),
          ...(this.searchForm.productName && { productName: this.searchForm.productName }),
          ...(this.searchForm.status && { status: this.searchForm.status })
        };
        
        const result = await api.getList(params);
        
        this.planListData = result.list || [];
        this.total = result.total || 0;
        console.log('âœ… åŠ è½½ä¸»ç”Ÿäº§è®¡åˆ’:', this.planListData.length, 'æ¡');
      } catch (error) {
        console.error('âŒ åŠ è½½ä¸»ç”Ÿäº§è®¡åˆ’å¤±è´¥:', error);
        this.$message.error('åŠ è½½æ•°æ®å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
      } finally {
        this.loading = false;
      }
    },
    
    // å·²ç§»é™¤æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆå‡½æ•°
    
    formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    },
    
    // æ ¼å¼åŒ–æ—¥æœŸä¸ºå¹´-æœˆ-æ—¥
    formatDateYMD(dateStr) {
      if (!dateStr) return '-';
      try {
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return '-';
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      } catch (e) {
        return '-';
      }
    },
    
    handleSearch() {
      this.currentPage = 1;
      this.fetchPlanList();
    },
    
    handleReset() {
      this.searchForm = {
        planCode: '',
        productCode: '',
        productName: '',
        status: '',
      };
      this.dateRange = [];
      this.currentPage = 1;
      this.fetchPlanList();
    },
    
    handleSelectionChange(val) {
      this.selectedPlans = val;
    },
    
    handleSizeChange(size) {
      this.pageSize = size;
      this.currentPage = 1;
      this.fetchPlanList();
    },
    
    handlePageChange(page) {
      this.currentPage = page;
      this.fetchPlanList();
    },
    
    handleCurrentChange(current) {
      this.currentPage = current;
      this.fetchPlanList();
    },
    
    handleCreatePlan() {
      this.$router.push('/production-planning/create');
    },
    
    handleViewDetail(plan) {
      this.$router.push(`/production-planning/detail/${plan.id}`);
    },
    
    handleEditPlan(plan) {
      this.$router.push(`/production-planning/create?id=${plan.id}`);
    },
    
    async handleDeletePlan(plan) {
      this.$confirm(`ç¡®å®šè¦åˆ é™¤ç”Ÿäº§è®¡åˆ’"${plan.planCode}"å—ï¼Ÿ`, 'æç¤º', {
        confirmButtonText: 'ç¡®å®š',
        cancelButtonText: 'å–æ¶ˆ',
        type: 'warning'
      }).then(async () => {
        try {
          await api.deleteById(plan.id);
          this.$message.success('åˆ é™¤æˆåŠŸ');
          this.fetchPlanList();
        } catch (error) {
          console.error('âŒ åˆ é™¤å¤±è´¥:', error);
          this.$message.error('åˆ é™¤å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
        }
      }).catch(() => {
        // ç”¨æˆ·å–æ¶ˆæ“ä½œ
      });
    },
    
    async handleBatchDelete() {
      this.$confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„${this.selectedPlans.length}ä¸ªç”Ÿäº§è®¡åˆ’å—ï¼Ÿ`, 'æç¤º', {
        confirmButtonText: 'ç¡®å®š',
        cancelButtonText: 'å–æ¶ˆ',
        type: 'warning'
      }).then(async () => {
        try {
          const ids = this.selectedPlans.map(plan => plan.id);
          await api.batchDelete(ids);
          this.$message.success(`æˆåŠŸåˆ é™¤${this.selectedPlans.length}æ¡è®°å½•`);
          this.selectedPlans = [];
          this.fetchPlanList();
        } catch (error) {
          console.error('âŒ æ‰¹é‡åˆ é™¤å¤±è´¥:', error);
          this.$message.error('æ‰¹é‡åˆ é™¤å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
        }
      }).catch(() => {
        // ç”¨æˆ·å–æ¶ˆæ“ä½œ
      });
    },
    
    handleBatchExport() {
      // æ¨¡æ‹Ÿå¯¼å‡ºæ“ä½œ
      this.$message({
        type: 'info',
        message: 'å¯¼å‡ºæˆåŠŸ'
      });
    },
    
    // æ‰§è¡Œæ’ç¨‹
    async handleExecuteSchedule() {
      const selectedPlan = this.selectedPlans[0];
      if (!selectedPlan) {
        this.$message.warning('è¯·é€‰æ‹©ä¸€æ¡ä¸»ç”Ÿäº§è®¡åˆ’');
        return;
      }
      
      try {
        await this.$confirm(
          `ç¡®å®šè¦æ‰§è¡Œæ’ç¨‹å—ï¼Ÿ

è®¡åˆ’ç¼–å·: ${selectedPlan.planCode}
äº§å“åç§°: ${selectedPlan.productName}
è®¡åˆ’æ•°é‡: ${selectedPlan.planQuantity}

ç³»ç»Ÿå°†è‡ªåŠ¨ï¼š
1. å°†ä¸»è®¡åˆ’æ•°æ®æ¨é€åˆ°å¤‡æ–™è®¡åˆ’
2. æ ¹æ®äº§å‡ºå·¥åºè‡ªåŠ¨ç”Ÿæˆå·¥åºè®¡åˆ’`,
          'æ‰§è¡Œæ’ç¨‹ç¡®è®¤',
          {
            confirmButtonText: 'ç¡®å®šæ‰§è¡Œ',
            cancelButtonText: 'å–æ¶ˆ',
            type: 'warning',
            dangerouslyUseHTMLString: false
          }
        );
        
        this.loading = true;
        
        const result = await api.executeSchedule(selectedPlan.id);
        
        this.$message.success(
          `æ’ç¨‹æ‰§è¡ŒæˆåŠŸï¼\n` +
          `ç”Ÿæˆå¤‡æ–™è®¡åˆ’: ${result.materialPlanCount || 0} æ¡\n` +
          `ç”Ÿæˆå·¥åºè®¡åˆ’: ${result.processPlanCount || 0} æ¡`
        );
        // åˆ·æ–°åˆ—è¡¨
        this.fetchPlanList();
      } catch (error) {
        if (error !== 'cancel') {
          console.error('â— æ‰§è¡Œæ’ç¨‹å¤±è´¥:', error);
          this.$message.error(error.message || 'æ‰§è¡Œæ’ç¨‹å¤±è´¥');
        }
      } finally {
        this.loading = false;
      }
    },
    
    handleColumnsUpdate(newColumns) {
      this.tableColumns = newColumns;
    },
    
    handleSettingsSave(settings) {
      console.log('âœ… è®¾ç½®å·²ä¿å­˜:', settings);
      
      // åº”ç”¨è®¾ç½®
      if (settings.visibleFields) {
        // æ›´æ–°è¡¨æ ¼åˆ—æ˜¾ç¤º
        this.tableColumns.forEach(col => {
          col.visible = settings.visibleFields.includes(col.prop);
        });
      }
      
      // åº”ç”¨ä¸šåŠ¡å˜é‡
      if (settings.advanceStorageDays !== undefined) {
        console.log('ğŸ“… æå‰å…¥åº“æœŸè®¾ç½®ä¸º:', settings.advanceStorageDays, 'å¤©');
        // è¿™é‡Œå¯ä»¥åœ¨åˆ›å»ºä¸»ç”Ÿäº§è®¡åˆ’æ—¶ä½¿ç”¨è¿™ä¸ªå€¼
      }
      
      this.$message.success('è®¾ç½®å·²åº”ç”¨');
    }
  },
  
  mounted() {
    this.fetchPlanList();
  }
};
</script>

<style scoped>
.production-plan-list {
  padding: 20px;
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.header-actions {
  display: flex;
  gap: 10px;
  align-items: center;
}

.search-card {
  margin-bottom: 20px;
}

.search-form {
  margin-top: 10px;
}

.data-card {
  margin-bottom: 20px;
}

.table-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  font-weight: bold;
}

.batch-actions {
  display: flex;
  gap: 10px;
}
</style>