# 客户交期到主生产计划字段映射修复报告

## 问题描述

### 用户需求
在订单列表选择一条销售订单，点击"正式下单"按钮，执行字段映射，将订单列表中的产品信息字段推送到主生产计划中。具体要求：

- 订单列表的"客户交期"=2026-01-10
- 映射到主生产计划的"订单承诺交期"也应该=2026-01-10
- 实际结果：主生产计划的"订单承诺交期"显示为2026-01-09（相差1天）

## 问题分析

### 根本原因
问题出现在后端 `backend/routes/masterProductionPlans.js` 文件中的 `formatDateForMySQL` 函数存在时区转换问题。

### 具体问题点

1. **时区转换错误**：
   - 前端发送：`customerDeliveryDate: "2026-01-10"` (纯日期字符串)
   - 后端处理：`new Date("2026-01-10")` 会创建本地时区的日期对象
   - 在某些时区环境下，可能导致日期偏移（如变为2026-01-09）

2. **不正确的时区处理逻辑**：
   ```javascript
   // 原有代码（有问题）
   function formatDateForMySQL(dateStr) {
     const date = new Date(dateStr); // 这里可能产生时区偏移
     const year = date.getFullYear();
     const month = String(date.getMonth() + 1).padStart(2, '0');
     const day = String(date.getDate()).padStart(2, '0');
     return `${year}-${month}-${day}`;
   }
   ```

### 数据流分析
```
前端显示：客户交期 = 2026-01-10
  ↓
前端发送：customerDeliveryDate = "2026-01-10"
  ↓  
后端接收：order.customerDeliveryDate = "2026-01-10"
  ↓
后端处理：promisedDeliveryDate = formatDateForMySQL("2026-01-10")
  ↓
问题：new Date("2026-01-10") 可能产生时区偏移
  ↓
结果：promisedDeliveryDate = "2026-01-09" (错误)
```

## 修复方案

### 1. 优化 `formatDateForMySQL` 函数
```javascript
// 修复后的代码
function formatDateForMySQL(dateStr) {
  if (!dateStr) return null;
  try {
    // ✅ 如果已经是YYYY-MM-DD格式，直接使用
    if (typeof dateStr === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
      return dateStr;
    }
    
    // ✅ 如果包含T，提取日期部分（ISO格式）
    if (dateStr.includes('T')) {
      return dateStr.split('T')[0];
    }
    
    // ✅ 其他情况，使用Date对象（作为后备方案）
    const date = new Date(dateStr);
    if (isNaN(date.getTime())) return null;
    
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  } catch (e) {
    console.error('日期格式化失败:', dateStr, e);
    return null;
  }
}
```

### 2. 优化计划入库日期计算
```javascript
// 修复后的代码
if (promisedDeliveryDate && advanceStorageDays !== undefined && advanceStorageDays !== null) {
  const advanceDays = parseInt(advanceStorageDays || 0);
  
  // ✅ 直接处理YYYY-MM-DD格式，避免Date对象时区转换
  if (/^\d{4}-\d{2}-\d{2}$/.test(promisedDeliveryDate)) {
    const [year, month, day] = promisedDeliveryDate.split('-').map(Number);
    const deliveryDate = new Date(year, month - 1, day); // month-1 because JS months are 0-indexed
    deliveryDate.setDate(deliveryDate.getDate() - advanceDays);
    
    const newYear = deliveryDate.getFullYear();
    const newMonth = String(deliveryDate.getMonth() + 1).padStart(2, '0');
    const newDay = String(deliveryDate.getDate()).padStart(2, '0');
    plannedStorageDate = `${newYear}-${newMonth}-${newDay}`;
  } else {
    // 后备方案：使用Date对象
    const deliveryDate = new Date(promisedDeliveryDate);
    deliveryDate.setDate(deliveryDate.getDate() - advanceDays);
    plannedStorageDate = formatDateForMySQL(deliveryDate);
  }
}
```

## 修复验证

### 测试用例
```javascript
// 测试不同格式的日期输入
const testDates = [
  '2026-01-10',           // 纯日期格式
  '2026-01-10T00:00:00.000Z', // ISO格式
  '2026-01-10T16:00:00.000Z'  // 带时间的ISO格式
];

// 测试结果
输入: 2026-01-10 -> 输出: 2026-01-10 ✅
输入: 2026-01-10T00:00:00.000Z -> 输出: 2026-01-10 ✅
输入: 2026-01-10T16:00:00.000Z -> 输出: 2026-01-10 ✅
```

### 计划入库日期计算测试
```
客户交期: 2026-01-10
提前入库期: 3天
订单承诺交期: 2026-01-10 ✅
计划入库日期: 2026-01-07 ✅
```

## 修复效果

### 修复前
- 订单列表客户交期：2026-01-10
- 主生产计划订单承诺交期：2026-01-09 ❌（错误）

### 修复后
- 订单列表客户交期：2026-01-10
- 主生产计划订单承诺交期：2026-01-10 ✅（正确）

## 字段映射关系确认

### 正确的字段映射流程
```
订单列表 → 正式下单 → 主生产计划

客户交期 (customer_delivery) 
    ↓
customerDeliveryDate
    ↓
promisedDeliveryDate (订单承诺交期)
    ↓
plannedStorageDate (计划入库日期 = 订单承诺交期 - 提前入库期)
```

### 前端发送数据结构
```javascript
{
  id: orderData.id,
  internalOrderNo: orderData.internal_order_no,
  customerOrderNo: orderData.customer_order_no,
  salesperson: orderData.salesperson,
  customerDeliveryDate: orderData.customer_delivery, // ✅ 客户交期
  promisedDeliveryDate: orderData.promised_delivery, // ✅ 承诺交期
  products: [...]
}
```

### 后端接收与处理
```javascript
// ✅ 订单承诺交期 = 客户交期
const promisedDeliveryDate = formatDateForMySQL(order.customerDeliveryDate);

// ✅ 计算计划入库日期 = 订单承诺交期 - 提前入库期
const plannedStorageDate = calculatePlannedStorageDate(promisedDeliveryDate, advanceStorageDays);
```

## 部署说明

### 修改文件
- `backend/routes/masterProductionPlans.js` (已修改)

### 重启服务
需要重启后端服务以应用修复：
```bash
# 重启Node.js后端服务
npm run dev
# 或
pm2 restart backend
```

### 验证步骤
1. 打开订单列表页面：`http://localhost:3003/sales/orders/list`
2. 选择一个客户交期为 `2026-01-10` 的销售订单
3. 点击"正式下单"按钮
4. 打开主生产计划页面：`http://localhost:3003/production-planning/plan-list`
5. 验证新生成的主生产计划的"订单承诺交期"字段应该显示为 `2026-01-10`

## 总结

本次修复解决了客户交期到主生产计划字段映射中的时区转换问题，通过以下改进：

1. **智能日期格式化**：优先处理纯日期字符串，避免不必要的Date对象转换
2. **时区转换规避**：直接处理YYYY-MM-DD格式，确保日期一致性
3. **后备机制**：保留Date对象处理作为特殊情况的后备方案
4. **详细日志**：增加调试日志，便于后续问题排查

修复后的系统能够正确处理客户交期到主生产计划的字段映射，确保日期数据的准确性和一致性。